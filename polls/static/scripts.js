"use strict";function openEleveOutsideController(ideleve){var contr=angular.element(document.getElementById("MainWrap")).controller();contr["openEleve_"+ideleve]()}angular.module("edsiteApp",["ngRoute","ngSanitize","ngMessages","ngScrollTo","ngLodash","ngNumeraljs","ngStorage","ngSanitize","ckeditor","smart-table","duScroll","ui.bootstrap","ui.bootstrap.contextMenu","ui.bootstrap.tpls","ui.bootstrap.datepicker","ui.select","angularMoment","multipleDatePicker","slick","ng-mfb","ng-sortable","highcharts-ng","cgBusy","vAccordion","frapontillo.gage","unsavedChanges","angularTreeview","truncate","kcd.directives","customColorPicker","g1b.datetime-range","piwik","edsiteApp.Commun","edsiteApp.3DSecure","edsiteApp.modals","edsiteApp.cahierDeTexte","edsiteApp.cahierDeTexteSaisie","edsiteApp.cahierDeTextePrimaire","edsiteApp.vieScolaire","edsiteApp.emploiDuTemps","edsiteApp.RPP","edsiteApp.RPPEnseignant","edsiteApp.vieDeLaClasse","edsiteApp.comptesUtilisateur","edsiteApp.timeline","edsiteApp.messagerie","edsiteApp.Finance","edsiteApp.DocumentsFamille","edsiteApp.DocumentsEleves","edsiteApp.DocumentsAdultes","edsiteApp.Documents","edsiteApp.Paiement","edsiteApp.AccueilFamille","edsiteApp.Note","edsiteApp.CoordonneesFamille","edsiteApp.Activites","edsiteApp.Cloud","edsiteApp.Login","edsiteApp.DemandeModifications","edsiteApp.permissions","edsiteApp.httpAuthInterceptor","edsiteApp.recuperationLogin","edsiteApp.Villes","edsiteApp.Appel","edsiteApp.AppelPrimaire","edsiteApp.AppelEtude","edsiteApp.PersonnelConsultation","edsiteApp.Postits","edsiteApp.menu","edsiteApp.config","edsiteApp.consultationCoordonnees","edsiteApp.accueilPersonnel","edsiteApp.Agenda","edsiteApp.AccueilEnseignant","edsiteApp.EspacesTravail","edsiteApp.CarnetNotes","edsiteApp.EDNotification","edsiteApp.LSL","edsiteApp.Utilisateurs","edsiteApp.Stages","edsiteApp.CarnetCorrespondance","edsiteApp.DossierInscriptionFamille","edsiteApp.GroupesFlexibles","edsiteApp.AideEnLigne","edsiteApp.QCM"]).config(["$sceDelegateProvider",function($sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self","http://*.ecoledirecte.com/**","https://*.ecoledirecte.com/**"])}]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"modules/commun/main.html",controller:"MainCtrl",data:{authenticate:!1}}).when("/about",{templateUrl:"modules/commun/about.html",controller:"AboutCtrl",data:{authenticate:!1}}).when("/Enseignant/stages",{templateUrl:"modules/suiviStage/enseignant/stages.html",controller:"StagesCtrl",controllerAs:"CtrlStages",data:{authenticate:!0}}).when("/Eleve/stages",{templateUrl:"modules/suiviStage/eleve/stages.html",controller:"StagesEleveCtrl",controllerAs:"CtrlStages",data:{authenticate:!0}}).when("/Aides",{templateUrl:"modules/aidesenligne/aidesenligne.html",controller:"AideEnLigneCtrl",controllerAs:"AideEnLigneCtrl",data:{authenticate:!1}}).when("/:typeUser/:idUser/Messagerie",{templateUrl:"../modules/messagerie/messagerie.html",controller:"CommunMessagerieCtrl",controllerAs:"CtrlCommunMessagerie",data:{authenticate:!0}}).when("/:typeUser/:idUser/Messagerie/Compose",{templateUrl:"../modules/messagerie/messagerie.compose.html",controller:"MessagerieComposeCtrl",data:{authenticate:!0},resolve:{aLeDroit:["$q","$route","$filter","Auth",function($q,$route,$filter,Auth){var currentTypeUser=$filter("translateTypeUserUrl")(Auth.currentUser().typeCompte);return Auth.currentUser().id===parseInt($route.current.params.idUser)&&currentTypeUser===$route.current.params.typeUser?$q.when():$q.reject()}]}}).when("/Eleves/:idEleve/EmploiDuTemps",{templateUrl:"../modules/emploiDuTemps/emploidutemps.html",controller:"EmploidutempsCtrl",controllerAs:"cCtrlEDT",data:{authenticate:!0},resolve:{user:["UserService","$route",function(UserService,$route){return UserService.getUser("E",$route.current.params.idEleve)}]}}).when("/:typeEntity/:idEntity/EmploiDuTemps",{templateUrl:"../modules/emploiDuTemps/emploidutemps.html",controller:"EmploidutempsCtrl",controllerAs:"cCtrlEDT",data:{authenticate:!0},resolve:{user:function(){}}}).when("/:typeUser/:idUser/EspacesTravail",{templateUrl:"../modules/espacesTravail/espacestravail.html",controller:"EspacestravailCtrl",data:{authenticate:!0}}).when("/noEspacesTravail",{templateUrl:"../modules/espacesTravail/noEspacestravail.html",controller:"noEspacestravailCtrl",controllerAs:"noEspaceCtrl",data:{authenticate:!0}}).when("/:typeUser/:idUser/EspacesTravail/:idEspaceTravail",{templateUrl:"../modules/espacesTravail/accueil/infosespacetravail.html",controller:"EspacetravailCtrl",controllerAs:"espTravailCtrl",data:{authenticate:!0}}).when("/:typeUser/:idUser/Agenda",{templateUrl:"../modules/agenda/agenda.html",controller:"AgendaCtrl",data:{authenticate:!0}}).when("/Appel",{templateUrl:"../modules/appel/appel.html",controller:"AppelCtrl",data:{authenticate:!0}}).when("/:typeEntity/:idEntity/Appel",{templateUrl:"../modules/appel/appel.html",controller:"AppelCtrl",data:{authenticate:!0}}).when("/:typeUser/AppelPrimaire",{templateUrl:"../modules/appelPrimaire/appel-primaire.html",controller:"AppelPrimaireCtrl",controllerAs:"ctrlAppelPrimaire",data:{authenticate:!0}}).when("/:typeUser/AppelEtude",{templateUrl:"../modules/appelEtude/appel-etude.html",controller:"AppelEtudeCtrl",controllerAs:"ctrlAppelEtude",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur","isPersonnel"],permissionCheckType:PermissionsService.enums.permissionCheckType.atLeastOne}}}).when("/Utilisateurs/:idUser",{templateUrl:"../modules/comptesUtilisateur/utilisateur.html",controller:"UtilisateurCtrl",data:{authenticate:!0}}).when("/contactEtablissement",{templateUrl:"modules/accueilFamille/contactetablissement.html",controller:"ContactetablissementCtrl",data:{authenticate:!0}}).when("/partenaires",{templateUrl:"../modules/accueilFamille/partenaires.html",controller:"PartenairesCtrl"}).when("/recuplogin",{templateUrl:"../modules/recupLogin/recuplogin.html",controller:"RecuperationloginCtrl",data:{authenticate:!1}}).when("/changementMotDePasse/:typeReinit",{templateUrl:"../modules/recupLogin/changementMotDePasse.html",controller:"UpdateloginCtrl",data:{authenticate:!1}}).when("/snake",{templateUrl:"../snake",controller:"snake",data:{authenticate:!0}}).when("/PortailsEsidoc",{templateUrl:"../modules/commun/portailsesidoc.html",controller:"PortailsesidocCtrl",controllerAs:"portEsidocCtrl",data:{authenticate:!0}}).when("/:idUser/PortailsEsidoc",{templateUrl:"../modules/commun/portailsesidoc.html",controller:"PortailsesidocCtrl",controllerAs:"portEsidocCtrl",data:{authenticate:!0}}).when("/Famille",{templateUrl:"../modules/accueilFamille/accueilfamille.html",controller:"FamilleaccueilCtrl",data:{authenticate:!0}}).when("/Famille/Compte",{templateUrl:"../modules/finance/comptes.html",controller:"CompteCtrl",data:{authenticate:!0}}).when("/Famille/Paiements",{templateUrl:"../modules/paiement/paiement.html",controller:"PaiementCtrl",data:{authenticate:!0}}).when("/Famille/Documents",{templateUrl:"../modules/documentsFamille/documents.html",controller:"FamilledocumentsCtrl",data:{authenticate:!0}}).when("/Eleve/Documents",{templateUrl:"../modules/documentsEleves/documents.html",controller:"ElevesdocumentsCtrl",data:{authenticate:!0}}).when("/Adulte/Documents",{templateUrl:"../modules/documentsAdultes/documents.html",controller:"AdultesdocumentsCtrl",data:{authenticate:!0}}).when("/Famille/FamilleCoordonnees",{templateUrl:"../modules/coordonneesFamille/coordonnees.html",controller:"FamillecoordonneesCtrl",controllerAs:"famCoordCtrl",data:{authenticate:!0}}).when("/Famille/FamilleDossierInscription",{templateUrl:"../modules/dossierInscriptionFamille/dossier-inscription.html",controller:"FamilleDossierInscriptionCtrl",controllerAs:"familleInscriptionCtrl",data:{authenticate:!0}}).when("/Famille/FamilleDossierInscription/retourPaiement/:code",{templateUrl:"../modules/dossierInscriptionFamille/dossier-inscription.html",controller:"FamilleDossierInscriptionCtrl",controllerAs:"familleInscriptionCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve",{templateUrl:"../modules/accueilEleve/timeline.html",controller:"EleveaccueilCtrl",data:{authenticate:!0},resolve:{eleve:["UserService","$route",function(UserService,$route){return UserService.getUser("E",$route.current.params.ideleve)}]}}).when("/Eleves/:idEleve/CoordonneesFamille",{templateUrl:"../modules/consultationCoordonnees/consultationCoordonneesFamille.html",controller:"ConsultationCoordonneesCtrl",controllerAs:"consultCoordCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve/VieScolaire",{templateUrl:"../modules/vieScolaire/viescolaire.html",controller:"EleveviescolaireCtrl",controllerAs:"eleveVSCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve/Notes",{templateUrl:"../modules/notes/eleve/elevenotes.html",controller:"ElevenotesCtrl",data:{authenticate:!0}}).when("/:entite/:idEntite/CahierDeTexte",{templateUrl:"../modules/cahierDeTexte/eleve/cahierdetexte.html",controller:"ElevecahierdetexteCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve/Activites",{templateUrl:"../modules/activites/activites.html",controller:"ActivitesCtrl",data:{authenticate:!0}}).when("/Eleves/:iduser/MonCloud",{templateUrl:"../modules/cloud/eleve/eleve-cloud.html",controller:"EleveCloudCtrl",data:{authenticate:!0},resolve:{user:["UserService","$route",function(UserService,$route){return UserService.getUser("E",$route.current.params.iduser)}]}}).when("/Eleves/:ideleve/ReunionParentProf",{templateUrl:"modules/RPP/reunionparentprof.html",controller:"ReunionparentprofCtrl",data:{authenticate:!0},resolve:{eleve:["UserService","$route",function(UserService,$route){return UserService.getUser("E",$route.current.params.ideleve)}]}}).when("/Eleves/:ideleve/CarnetCorrespondance",{templateUrl:"../modules/carnetCorrespondance/eleve/carnet-correspondance.html",controller:"EleveCarnetCorrespondanceCtrl",controllerAs:"eleveCarnetCorrespondanceCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve/Finances",{templateUrl:"../modules/finance/eleve/eleve-portes-monnaie.html",controller:"EleveFinancesCtrl",controllerAs:"financesEleveCtrl",data:{authenticate:!0}}).when("/Eleves/:ideleve/qcms",{templateUrl:"../modules/qcm/eleve/qcms-evalues.html",controller:"QCMSEvaluesCtrl",controllerAs:"CtrlQCMSEvalues",data:{authenticate:!0}}).when("/Personnel",{templateUrl:"../modules/accueilPersonnel/personnelaccueil.html",controller:"PersonnelaccueilCtrl",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isPersonnel"],permissionCheckType:PermissionsService.enums.permissionCheckType.combinationRequired}}}).when("/Classes",{templateUrl:"../modules/consultationPersonnel/personnel-consultation-eleve.html",controller:"PersonnelconsultationeleveCtrl",controllerAs:"consultationElevesCtrl",data:{authenticate:!0}}).when("/:entityType/:entityId/editions",{templateUrl:"../modules/consultationPersonnel/personnel-consultation-editions.html",controller:"PersonnelconsultationeditionCtrl",controllerAs:"consultationeditionCtrl",data:{authenticate:!0}}).when("/:entityType/:entityId/vieScolaire",{templateUrl:"../modules/consultationPersonnel/personnel-consultation-vs.html",controller:"PersonnelconsultationVSCtrl",controllerAs:"consultationVSCtrl",data:{authenticate:!0}}).when("/Personnel/Compte",{templateUrl:"../modules/finance/comptes.html",controller:"CompteCtrl",data:{authenticate:!0}}).when("/Personnel/Paiements",{templateUrl:"../modules/paiement/paiement.html",controller:"PaiementCtrl",data:{authenticate:!0}}).when("/retourPaiement/:code",{templateUrl:"../modules/paiement/retourpaiement.html",controller:"RetourpaiementCtrl",data:{authenticate:!0},label:"Retour banque"}).when("/Personnel/Postits",{templateUrl:"../modules/postits/postits.html",controller:"PostitsCtrl",controllerAs:"postitCtrl",data:{authenticate:!0}}).when("/Personnels/:iduser/MonCloud",{templateUrl:"../modules/cloud/personnel/personnel-cloud.html",controller:"PersonnelCloudCtrl",data:{authenticate:!0}}).when("/Personnel/CarnetCorrespondance",{templateUrl:"../modules/carnetCorrespondance/enseignant/carnet-correspondance.html",controller:"ProfCarnetCorrespondanceCtrl",controllerAs:"profCarnetCorrespondanceCtrl",data:{authenticate:!0}}).when("/:typeUser/:idUser/qcms",{templateUrl:"../modules/qcm/enseignant/qcms.html",controller:"QCMSCtrl",controllerAs:"CtrlQCMS",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur"],permissionCheckType:PermissionsService.enums.permissionCheckType.combinationRequired}}}).when("/:typeUser/:idUser/qcms/:idQCM/questions",{templateUrl:"../modules/qcm/enseignant/qcm-questions.html",controller:"QCMQuestionsCtrl",controllerAs:"CtrlQCMQuestions",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur"],permissionCheckType:PermissionsService.enums.permissionCheckType.combinationRequired}}}).when("/Enseignant",{templateUrl:"../modules/accueilEnseignant/enseignantaccueil.html",controller:"EnseignantaccueilCtrl",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur"],permissionCheckType:PermissionsService.enums.permissionCheckType.combinationRequired}}}).when("/Enseignant/Appel",{templateUrl:"../modules/appel/enseignant/enseignant-appel.html",controller:"AppelCtrl",data:{authenticate:!0}}).when("/CarnetDeNotes",{templateUrl:"../modules/notes/enseignant/enseignant-notes.html",controller:"EnseignantNotesCtrl",controllerAs:"noteCtrl",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur","isPersonnel"],permissionCheckType:PermissionsService.enums.permissionCheckType.atLeastOne}}}).when("/:typeEntity/:idEntity/CarnetDeNotes",{templateUrl:"../modules/notes/enseignant/enseignant-notes.html",controller:"EnseignantNotesCtrl",controllerAs:"noteCtrl",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur","isPersonnel"],permissionCheckType:PermissionsService.enums.permissionCheckType.atLeastOne}}}).when("/Enseignants/:idUser/RPP",{templateUrl:"../modules/RPP/enseignant/rpp-enseignant.html",controller:"EnseignantRPPCtrl",controllerAs:"rppCtrl",data:{authenticate:!0}}).when("/CahierDeTexte",{templateUrl:"../modules/cahierDeTexte/enseignant/cahierdetexteSaisie.html",controller:"ProfcahierdetexteCtrl",controllerAs:"cahierdetexteCtrl",data:{authenticate:!0}}).when("/CahierDeTextePrimaire",{templateUrl:"../modules/cahierDeTextePrimaire/cahierdetextePrimaireSaisie.html",controller:"ProfCahierdetextePrimaireCtrl",controllerAs:"cdtPrimaireCtrl",data:{authenticate:!0}}).when("/:typeUser/GroupesFlexibles",{templateUrl:"../modules/groupesFlexibles/groupes-flexibles.html",controller:"GroupesFlexiblesCtrl",controllerAs:"groupesFlexiblesCtrl",data:{authenticate:!0}}).when("/Enseignant/CarnetCorrespondance",{templateUrl:"../modules/carnetCorrespondance/enseignant/carnet-correspondance.html",controller:"ProfCarnetCorrespondanceCtrl",controllerAs:"profCarnetCorrespondanceCtrl",data:{authenticate:!0},access:function(PermissionsService){return{loginRequired:!0,requiredPermissions:["isProfesseur","isPersonnel"],permissionCheckType:PermissionsService.enums.permissionCheckType.atLeastOne}}}).when("/Enseignants/:iduser/MonCloud",{templateUrl:"../modules/cloud/enseignant/enseignant-cloud.html",controller:"EnseignantCloudCtrl",data:{authenticate:!0}}).when("/:entite/:idEntite/VieDeLaClasse",{templateUrl:"../modules/vieDeLaClasse/viedelaclasse.html",controller:"ViedelaclasseCtrl",controllerAs:"vieClasseCtrl",data:{authenticate:!0}}).when("/LSL",{templateUrl:"../modules/LSL/saisie-lsl.html",controller:"LSLCtrl",controllerAs:"controlerLSL",data:{authenticate:!0}}).when("/login",{templateUrl:"modules/login/login.html",controller:"LoginCtrl",data:{authenticate:!1}}).when("/logout",{templateUrl:"modules/login/logout.html",controller:"LogoutCtrl",data:{authenticate:!1}}).when("/404",{templateUrl:"404.html"}).when("/403",{templateUrl:"403.html",controller:"AccessDeniedCtrl"}).when("/loginExterne",{templateUrl:"../modules/login/loginexterne.html",controller:"LoginexterneCtrl",data:{authenticate:!1}}).otherwise({redirectTo:"/"})}]).config(["$compileProvider",function($compileProvider){$compileProvider.debugInfoEnabled(!1)}]).config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode(!0)}]).config(["$numeraljsConfigProvider",function($numeraljsConfigProvider){var language={delimiters:{thousands:" ",decimal:","},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(number){return 1===number?"er":"ème"},currency:{symbol:"€"}};$numeraljsConfigProvider.setLanguage("fr",language)}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("ProcessResponseInterceptor"),$httpProvider.interceptors.push("ProcessRequestInterceptor")}]).config(["unsavedWarningsConfigProvider",function(unsavedWarningsConfigProvider){unsavedWarningsConfigProvider.navigateMessage="Êtes vous sûr de vouloir annuler vos actions en cours ?",unsavedWarningsConfigProvider.reloadMessage="Vous allez perdre vos modifications en cours si vous rechargez votre page.",unsavedWarningsConfigProvider.routeEvent=["$stateChangeStart","EDUnsavedWarning"]}]).config(["ScrollBarsProvider",function(ScrollBarsProvider){ScrollBarsProvider.defaults={scrollButtons:{enable:!0},axis:"x",setTop:"-15px",updateOnContentResize:!0,theme:"light",autoHideScrollbar:!1}}]).config(["$uibTooltipProvider",function($uibTooltipProvider){function isMobile(){var userAgent=navigator.userAgent.toLowerCase();return null!==userAgent.match(/iphone|ipad|android|mobile|mobi/i)}if($uibTooltipProvider.options({animation:!1}),isMobile()){var options={trigger:"dontTrigger"};$uibTooltipProvider.options(options)}}]).config(["uibTimepickerConfig",function(uibTimepickerConfig){uibTimepickerConfig.showMeridian=!1}]).run(["$rootScope","$location","$window","$routeParams","$log","$http","$sessionStorage","$uibModal","$uibModalStack","$timeout","Piwik","httpAuthService","Auth","Settings","amMoment","environnement","PermissionService","EdClusterService","CONFIG","lodash","Notification","EmploiDuTempsService",function($rootScope,$location,$window,$routeParams,$log,$http,$sessionStorage,$uibModal,$uibModalStack,$timeout,Piwik,httpAuthService,Auth,Settings,amMoment,environnement,PermissionService,EdClusterService,CONFIG,lodash,Notification,EmploiDuTempsService){moment.localeData("fr"),amMoment.changeLocale("fr"),CKEDITOR.config.mathJaxLib="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML",CKEDITOR.config.pasteFromWordRemoveFontStyles=!1,CKEDITOR.config.pasteFromWordRemoveStyles=!1,CKEDITOR.config.disableNativeSpellChecker=!1,Piwik.disableCookies(),$rootScope.Auth=Auth,Auth.challengeBySessionStorage(),$rootScope.settings=Settings.allSettings(),$rootScope.version=CONFIG.version,EdClusterService.updateServers().then(function(newSettings){$rootScope.settings=newSettings}),$rootScope.$on("update-settings",function(){$rootScope.settings=Settings.allSettings()}),$rootScope.$on("nomore-server",function(){$uibModal.open({template:'<div class="jumbotron"><h1>Désolé</h1><p>Suite à un problème technique, nous ne sommes pas en mesure de traiter votre demande. <br/>Nous vous prions de bien vouloir ré-essayer dans quelques minutes.</p></div>',backdrop:"static",keyboard:!1,size:"lg"})}),$rootScope.leModuleActif="ACCUEIL",PNotify.prototype.options.styling="fontawesome",Dropzone.autoDiscover=!1,$rootScope.isActive=function(route){return"/"!==route?-1!==$location.path().indexOf(route):-1===$location.path().indexOf("about")&&-1===$location.path().indexOf("contact")},$rootScope.getEleveConsultation=function(){var consultationEleve=angular.isDefined($sessionStorage["consultation-eleve"]);return consultationEleve===!1?$rootScope.displayMenuEleve=!1:$rootScope.displayMenuEleve=!0,consultationEleve||$rootScope.consultationEleve?$sessionStorage["consultation-eleve"]:!1},$rootScope.getClasseConsultation=function(){return $location.path().toLowerCase().indexOf("eleve")<0&&$location.path().toLowerCase().indexOf("classe")<0&&(delete $sessionStorage["consultation-classe"],delete $sessionStorage["consultation-eleve"]),$sessionStorage["consultation-classe"]},$rootScope.getGroupeConsultation=function(){return $location.path().toLowerCase().indexOf("eleve")<0&&$location.path().toLowerCase().indexOf("classe")<0&&angular.isDefined($location.search().groupe)&&(delete $sessionStorage["consultation-groupe"],delete $sessionStorage["consultation-eleve"]),$sessionStorage["consultation-groupe"]},$rootScope.isModuleActif=function(leModule){return leModule===$rootScope.leModuleActif},$rootScope.go=function(path){var regexParamGet=/(.*)\?(.*)/,urlParams={},resultRegex=regexParamGet.exec(path);if(resultRegex&&resultRegex.length>=2){path=resultRegex[1];var params=resultRegex[2];if(params.indexOf("&")){var paramsTab=params.split("&");urlParams=lodash.reduce(paramsTab,function(previous,current,key){var keyValTab=paramsTab[key].split("=");return previous[keyValTab[0]]=keyValTab[1],previous},{})}}$location.path(path).search(urlParams)},$rootScope.guid=function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}}(),$rootScope.accountSelector=function(){var modalInstance=$uibModal.open({templateUrl:"modules/commun/accountSelector.html",scope:$rootScope});modalInstance.result.then(function(data){1!==data&&"undefined"!=typeof data.id&&(EmploiDuTempsService.agendasToDisplay=[],$rootScope.mainPromise=Auth.swipeUser(data.id))})},$rootScope.switchProfil=function(){var modalInstance=$uibModal.open({templateUrl:"modules/commun/profilSelector.html",scope:$rootScope,size:"xs"});modalInstance.result.then(function(data){1!==data&&"undefined"!=typeof data.profil&&(EmploiDuTempsService.agendasToDisplay=[],$rootScope.mainPromise=Auth.swipeProfil(data.profil))})},window.onbeforeunload=function(e){var e=e||window.event;return $rootScope.navigationDisabled===!0?(e&&(e.returnValue="Voulez-vous vraiment quitter la page sans sauvegarder vos modifications ?"),"Voulez-vous vraiment quitter la page sans sauvegarder vos modifications ?"):void 0},$rootScope.$on("$locationChangeStart",function(event,newUrl){var texteNavigationDisabled="Vous n'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.",customTextButtonConfirm="Continuer et perdre la saisie en cours";if(angular.isDefined($rootScope.texteNavigationDisabled)&&""!==$rootScope.texteNavigationDisabled&&(texteNavigationDisabled=$rootScope.texteNavigationDisabled),angular.isDefined($rootScope.customTextButtonConfirm)&&""!==$rootScope.customTextButtonConfirm&&$location.path().indexOf("/logout")<0&&(customTextButtonConfirm=$rootScope.customTextButtonConfirm),$rootScope.navigationDisabled===!0){event.preventDefault();var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 2em">'+texteNavigationDisabled+"</p>",type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:customTextButtonConfirm,addClass:"btn btn-warning",click:function(){$rootScope.navigationDisabled=!1,$rootScope.texteNavigationDisabled="",$rootScope.customTextButtonConfirm="",$timeout(function(){var newPath=newUrl.substring($location.absUrl().length-$location.url().length);$location.path(newPath)},500)}},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:function(notice){notice.remove(),event.preventDefault()}}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);return void notice.get().click(function(){notice.remove(),event.preventDefault()})}}),$rootScope.$on("$routeChangeStart",function(events,next){$rootScope.consultationEleve=!1,delete $sessionStorage["consultation-eleve"];var isAuthenticated=Auth.isAuthenticated(),needAuthenticate=!0;if("undefined"!=typeof next&&"undefined"!=typeof next.data&&(needAuthenticate=next.data.authenticate),needAuthenticate&&!isAuthenticated){var camefrom=$location.path();""!==camefrom&&"/login"!==camefrom?$location.path("/login").search("camefrom",camefrom):$location.path("/login"),events.preventDefault()}var authorised;if(void 0!==next.access){var access=next.access(PermissionService);authorised=PermissionService.authorize(access.loginRequired,access.requiredPermissions,access.permissionCheckType),authorised===PermissionService.enums.authorised.loginRequired?$location.path("/login"):authorised===PermissionService.enums.authorised.notAuthorised&&$location.path("/403").replace()}try{angular.isDefined(next.$$route)?Piwik.trackPageView(next.$$route.originalPath):Piwik.trackPageView()}catch(e){}}),$rootScope.$on("token-expired",function(event,args){var modalInstance=$uibModal.open({templateUrl:"modules/login/loginApresExpiration.html",windowClass:"login-dialog",keyboard:!1,backdrop:!1,controller:"LoginCtrl",resolve:{config:function(){var args={};return args.isRelogin=!0,args}}});modalInstance.result.then(function(data){2===data&&(httpAuthService.loginCancelled(),Auth.logout(),$uibModalStack.dismissAll(),$location.path("/login"))})}),$rootScope.isMobile=function(){var userAgent=navigator.userAgent.toLowerCase();return null!==userAgent.match(/iphone | android | mobile | mobi /i)},$rootScope.isHomePage=function(){var partUrlEleve=$location.path().split("/"),idEleve=partUrlEleve[2],tabUrlsAccueil=["/Famille","/Enseignant","/Personnel","/Eleves/"+idEleve];return tabUrlsAccueil.indexOf($location.path())>-1},$rootScope.$on("$routeChangeError",function(evt,current,previous,rejection){"not_logged_in"===rejection||$location.path("/404")}),$.material.init()}]).value("duScrollOffset",215).value("environnement","dev").factory("speech",function(){function sayIt(text,config){var voices=window.speechSynthesis.getVoices();msg.voice=config&&config.voiceIndex?voices[config.voiceIndex]:voices[0],msg.volume=config&&config.volume?config.volume:1,msg.rate=config&&config.rate?config.rate:1,msg.pitch=config&&config.pitch?config.pitch:1,msg.text=text,speechSynthesis.speak(msg)}if(window.speechSynthesis){var msg=new SpeechSynthesisUtterance;window.speechSynthesis.getVoices()}return{sayText:sayIt}}).controller("AccessDeniedCtrl",["$scope","speech","$timeout","Auth",function($scope,speech,$timeout,Auth){$timeout(function(){},1e3),Auth.isModeSupervision()&&($scope.message="En mode supervision vous n'avez pas accès à toutes les fonctions de l'utilisateur.")}]).value("cgBusyDefaults",{message:"Chargement en cours",backdrop:!0,templateUrl:"modules/commun/spiner-cgbusy.html"}),angular.module("edsiteApp.Commun",["ngStorage","ngLodash","edsiteApp.EdCluster","ngScrollbars","angular-cache","angularMoment"]),angular.module("edsiteApp.Cloud",["ang-drag-drop","ngScrollTo","ngLodash","ngStorage","ui.bootstrap","edsiteApp.Commun"]).directive("cloud",function(){return{templateUrl:"modules/cloud/cloud-template.html",restrict:"E",scope:{entity:"="},controller:"CloudDirectiveCtrl",link:function(scope,element){element.on("$destroy",function(){scope.modalPadInstance&&scope.modalPadInstance.dismiss()})}}}).controller("CloudDirectiveCtrl",["$scope","CloudService","Settings","Auth","lodash","ModuleService","UserService","$uibModal","Notification","$document",function($scope,CloudService,Settings,Auth,lodash,ModuleService,UserService,$uibModal,Notification,$document){function renameNode(node){if("CASIER"===node.title||"CASIER"===node.libelle)return void Notification.notify("Erreur","Vous ne pouvez pas renommer votre casier","danger");var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Renommer "+node.libelle,config.message="Nouveau nom",config.confirm="Valider",config.value=node.libelle,config.cancel="Annuler",config}}});modalInstance.result.then(function(newName){angular.isUndefined(newName)||newName.length<=0||/[\\:\/\*\?"<>|]/.test(newName)?Notification.notify("Erreur",'Nom invalide <br> caractères interdits    /    \\    "    *   ?   <   >    :   | ',"danger"):$scope.promiseContents=CloudService.renameNode($scope.entity.id,$scope.entity.type,newName,node,$scope.currentNode,node.url?node.url:"").then(function(modifiedNode){node=modifiedNode},function(error){var message=angular.isString(error)?error:error.data.message;Notification.notify("Erreur",message,"danger")})})}function libelleLowerCase(node){return node.libelle.toLowerCase()}function getExtension(nom){return CloudService.getExtension(nom)}function isImage(fileName){return CloudService.isImage(fileName)}function isUrlFile(fileNode){return CloudService.isUrlFile(fileNode)}function isPadFile(fileNode){return CloudService.isPadFile(fileNode)}function isVisioFile(fileNode){return CloudService.isVisioFile(fileNode)}function isVisioEnable(){return"073T2019"===Auth.codeOgec()}function canAddVisio(){return isVisioEnable()&&$scope.entity.droit>$scope.CONSTANTES.DROIT_LECTURE&&$scope.entity.type===Auth.TYPE_USER.ESPACE_TRAVAIL&&(Auth.isProfesseur()||Auth.isPersonnel())}function addDossier(node){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Nom de votre dossier",config.message="Quel est le nom de votre dossier ?",config.confirm="Valider",config.cancel="Annuler",config}}});modalInstance.result.then(function(nomDuDossier){angular.isUndefined(nomDuDossier)||nomDuDossier.length<=0||/[\\:\/\*&\?"<>|]/.test(nomDuDossier)?Notification.notify("Erreur",'Nom de dossier invalide <br> caractères interdits    /    \\  &  "    *   ?   <   >    :   | ',"danger"):$scope.promiseContents=CloudService.addFolder($scope.entity.id,$scope.entity.type,nomDuDossier,node).then(function(modifiedNode){node=modifiedNode},function(error){var message=angular.isString(error)?error:error.data.message;Notification.notify("Erreur",message,"danger")})})}function addUrl(){displayUrlFileModal(null)}function displayUrlFileModal(file){var modalInstance=$uibModal.open({templateUrl:"modules/cloud/urlFileModal/url-file-modal.template.html",controller:"UrlFileModalCtrl",controllerAs:"urlFileModalCtrl",size:"md",backdrop:!1,resolve:{config:function(){var config={};return config.file=file,config.node=$scope.currentNode,config.idUser=$scope.entity.id,config.typeUser=$scope.entity.type,config.mode=$scope.mode,config}}});modalInstance.result.then(function(error){if(angular.isDefined(error)){var message=angular.isString(error)?error:error.data.message;Notification.notify("Erreur",message,"danger")}else Notification.notify("Mise à jour","L'élément a été mis à jour avec succès","success")})}function addPad(){displayPadModal(null)}function displayPadModal(padFile){$scope.modalPadInstance=$uibModal.open({templateUrl:"modules/cloud/padModal/pad-modal.template.html",controller:"PadModalCtrl",controllerAs:"padModalCtrl",size:"lg",windowClass:null!==padFile?"pad-modal":"",backdrop:!1,resolve:{config:function(){var config={};return config.padFile=padFile,config.node=$scope.currentNode,config.idUser=$scope.entity.id,config.typeUser=$scope.entity.type,config.mode=$scope.mode,config}}}),$scope.modalPadInstance.result.then(function(padFileUpdated){angular.isDefined(padFileUpdated)&&displayPadModal(padFileUpdated)})}function addVisio(){$scope.isVisioEnable()&&displayVisioModal(null)}function displayVisioModal(visioFile){$scope.isVisioEnable()&&($scope.modalVisioInstance=$uibModal.open({templateUrl:"modules/cloud/visioModal/visio-modal.template.html",controller:"VisioModalCtrl",controllerAs:"visioModalCtrl",size:"lg",windowClass:null!==visioFile?"visio-modal":"",
backdrop:!1,resolve:{config:function(){var config={};return config.visioFile=visioFile,config.node=$scope.currentNode,config.idUser=$scope.entity.id,config.typeUser=$scope.entity.type,config.mode=$scope.mode,config}}}))}function removeNode(tabNode,contentCurrentNode){if(lodash.findIndex(tabNode,function(node){return"CASIER"===node.title||"CASIER"===node.libelle})>-1)return void Notification.notify("Erreur","Vous ne pouvez pas supprimer votre casier","danger");var messageWarning='Êtes-vous sûr de vouloir <strong>supprimer</strong> les éléments suivants ?<ul class="cloud-list-delete">';tabNode.forEach(function(node){messageWarning+='<li> <i class="fa fa-file"></i> ',messageWarning+=node.libelle,angular.isDefined(node.children)&&(messageWarning+='<span class="text-warning"> - Ce dossier ainsi que l\'intégralité de son contenu seront supprimés !</span>'),messageWarning+="</li>"});var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'élément",config.message=messageWarning,config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){$scope.promiseContents=CloudService.deleteNode($scope.entity.id,tabNode,$scope.entity.type).then(function(){lodash.remove(contentCurrentNode.children,function(node){return lodash.findIndex(tabNode,function(n){return n.id===node.id})>-1}),$scope.currentSelections=[],$scope.usage=$scope.usage-tabNode.reduce(function(acc,current){return acc+current.taille},0),Notification.notify("Suppression","Les éléments ont bien été supprimés","success")})})}function showSelected(node){if(node.collapsed=!1,$scope.currentSelections=[],$scope.currentNode=node,angular.isDefined(node)&&node.type===CloudService.TYPES.FOLDER&&($scope.promiseContents=CloudService.getFolderContent(node,$scope.entity.id,$scope.entity.type).then(function(folder){$scope.promiseContents=void 0,$scope.currentNode=folder,$scope.dropzoneConfig.url=Settings.allSettings().apiUri+"televersement.awp?verbe=post&mode=CLOUD&dest="+folder.id,$scope.currentSelections=[]})),angular.isDefined(node)){$scope.currentNode=node,$scope.expandedNodes.push(node);var tableContentElement=angular.element(document.getElementById("topAnchor"));angular.isDefined(tableContentElement[0])&&$document.scrollToElement(tableContentElement,290,1e3)}updateBreadcrumbs()}function copyToClipboard(nodesSelection){CloudService.copyNodes(angular.copy(nodesSelection)),Notification.notify("Copié","Les éléments ont bien été copiés","success")}function pasteFromClipboard(inNode){var toAdd=0,hasError=!1;angular.forEach(CloudService.getClipboardContent(),function(item){angular.isDefined(lodash.find($scope.currentNode.children,{libelle:item.libelle}))&&(Notification.notify("Erreur","Action impossible. Un élément avec le même identifiant existe déjà : "+item.libelle,"danger"),hasError=!0),toAdd+=sizeOf(item)}),!hasError&&$scope.usage+toAdd>$scope.quota?Notification.notify("Erreur","Action impossible. Vous ne disposez pas assez d'espace","danger"):hasError||($scope.promiseContents=CloudService.loadNodesFully($scope.entity.id,$scope.entity.type,CloudService.getClipboardContent()).then(function(tabNodesToCopy){return CloudService.pasteNode($scope.entity.id,$scope.entity.type,tabNodesToCopy,inNode)},function(error){Notification.notify("Erreur",error.data.message,"danger")}).then(function(newParent){$scope.currentNode=newParent,$scope.showSelected(newParent),Notification.notify("Collé","Les éléments ont bien été collés","success"),$scope.usage=$scope.usage+toAdd,updateRootNodeLibelle()},function(error){Notification.notify("Erreur",error.data.message,"danger")}))}function isClipboardEmpty(){return angular.isUndefined(CloudService.getClipboardContent())}function onUpload(){angular.forEach($scope.fichiers,function(fic){if(200===fic.code){var elementAPusher=fic.data,destinationPush=$scope.currentNode;if("folder"===elementAPusher.type){var idExist=lodash.findIndex(destinationPush.children,{id:elementAPusher.id});idExist>-1?destinationPush.children[idExist]=elementAPusher:destinationPush.children.push(elementAPusher)}else destinationPush.children.push(elementAPusher);$scope.usage+=elementAPusher.taille}else{var leMessage="Une erreur est survenue";angular.isUndefined(fic.message)||(leMessage=fic.message),Notification.notify("Erreur",leMessage,"danger")}lodash.remove($scope.fichiers,{libelle:fic.libelle})})}function isNodeSelected(node){return lodash.contains($scope.currentSelections,node)}function addNodeToSelection(node){isNodeSelected(node)?lodash.remove($scope.currentSelections,node):$scope.currentSelections.push(node)}function updateBreadcrumbs(){var breads=[];if(angular.isUndefined($scope.currentNode)||angular.isUndefined($scope.currentNode.id))return void($scope.breadcrumbs=breads);var lePath=angular.copy($scope.currentNode.id),rootPath=lePath.split("\\").slice(1,4).join("\\"),items=lePath.split("\\").slice(4),parentPath="\\"+rootPath;angular.forEach(items,function(item){if(""!==item){var bread={};bread.libelle=item,bread.unc=parentPath+"\\"+item,breads.push(bread),parentPath=parentPath+"\\"+item}}),$scope.breadcrumbs=breads}function gotoNode(idNode){""===idNode?$scope.onOpenNode($scope.dossiers[0]):$scope.promiseContents=CloudService.getFolderContentById(idNode).then(function(folder){$scope.onOpenNode(folder)})}function sizeOf(node,update){var res=0;return update="undefined"!=typeof update?update:!1,"folder"!==node.type?node.taille:(angular.forEach(node.children,function(subNode){res+=sizeOf(subNode,update)}),update&&(node.taille=res),res)}function onDrop(data,target){if("CASIER"===data.libelle||angular.isDefined(lodash.find(data.children,{libelle:"CASIER"})))return void Notification.notify("Erreur","Vous ne pouvez pas déplacer votre casier","danger");if("ro"!==$scope.mode&&"file"!==target.type&&target.id!==data.id)return 0===target.id.indexOf(data.id)?void Notification.notify("Erreur","Déplacement impossible","danger"):void($scope.promiseContents=CloudService.loadNodesFully($scope.entity.id,$scope.entity.type,[data]).then(function(tabNodesToMove){return CloudService.pasteNode($scope.entity.id,$scope.entity.type,tabNodesToMove,target)},function(error){Notification.notify("Erreur",error.data.message,"danger")}).then(function(newParent){$scope.target=newParent,$scope.promiseContents=CloudService.deleteNode($scope.entity.id,[data],$scope.entity.type).then(function(){$scope.promiseContents=CloudService.getFolderContent($scope.currentNode,$scope.entity.id,$scope.entity.type).then(function(folder){$scope.currentNode=folder,lodash.remove($scope.currentNode.children,{id:data.id}),Notification.notify("Déplacement","Les éléments ont bien été déplacés dans "+target.libelle,"success")})}),updateRootNodeLibelle()},function(error){Notification.notify("Erreur",error.data.message,"danger")}))}function maxFileSize(){return $scope.quota-$scope.usage}function openAncestors(path){function isParentFolder(dossier){return lodash.startsWith(parentPath,dossier.id+"\\")}var pathElements=path.split("\\");pathElements=lodash.compact(pathElements);var parentPath="\\"+pathElements.join("\\")+"\\",pathElementsRootFolder=$scope.dossiers[0].id.split("\\");pathElementsRootFolder=lodash.compact(pathElementsRootFolder);var node=$scope.dossiers[0];node.collapsed=!1;for(var idx=0;idx<pathElements.length-pathElementsRootFolder.length;idx++)node=lodash.find(node.children,isParentFolder),node.collapsed=!1}function updateRootNodeLibelle(){$scope.dossiers[0].libelle=lodash.capitalize($scope.entity.libelle)}$scope.dossiers=[],$scope.currentNode={},$scope.expandedNodes=[],$scope.breadcrumbs=[],$scope.quota=0,$scope.usage=0,$scope.TYPES=CloudService.TYPES,$scope.CONSTANTES=CloudService.CONSTANTES,$scope.Auth=Auth,$scope.isPadsActif="1"===ModuleService.getModule(ModuleService.CODES.CLOUD).params.padsActif,$scope.modalPadInstance=null,$scope.dropzoneConfig={parallelUploads:3,maxFilesize:500,timeout:3e6,addRemoveLinks:!1,clickable:".fileinput-button",dictDefaultMessage:"Déposez vos fichiers ici...",dictResponseError:"Une erreur s'est produite",dictRemoveFile:"",dictCancelUpload:"",dictCancelUploadConfirmation:"Êtes-vous sur de vouloir supprimer ce téléversement ?",url:Settings.allSettings().apiUri+"televersement.awp?verbe=post&mode=CLOUD"},$scope.fichiers=[],$scope.configInputFile={fromCloudEnabled:!1,keepComplete:!1,dropzoneContainer:"#dropzoneContainer"},$scope.mode="ro",$scope.entity.type===Auth.TYPE_USER.ESPACE_TRAVAIL&&$scope.entity.droit>$scope.CONSTANTES.DROIT_LECTURE&&($scope.mode="rw"),Auth.isEleve()&&$scope.entity.type!==Auth.TYPE_USER.ESPACE_TRAVAIL&&($scope.mode="rw"),Auth.isProfesseur()&&$scope.entity.type===Auth.TYPE_USER.ENSEIGNANT&&($scope.mode="rw"),Auth.isPersonnel()&&$scope.entity.type===Auth.TYPE_USER.ENSEIGNANT&&($scope.mode="rw"),$scope.menuOptions=[["Renommer",function($itemScope){"rw"===$scope.mode&&$scope.entity.droit>$scope.CONSTANTES.DROIT_SUPPRESSION?renameNode($itemScope.child):Notification.notify("Erreur","Vous n'avez pas les autorisations nécessaires","danger")}],["Copier",function($itemScope){"rw"===$scope.mode?copyToClipboard(lodash.find($scope.currentSelections,{id:$itemScope.child.id})?$scope.currentSelections:[$itemScope.child]):Notification.notify("Erreur","Vous n'avez pas les autorisations nécessaires","danger")}],null,["Supprimer",function($itemScope){"rw"===$scope.mode&&$scope.entity.droit>$scope.CONSTANTES.DROIT_SUPPRESSION?removeNode($scope.currentSelections,$scope.currentNode):Notification.notify("Erreur","Vous n'avez pas les autorisations nécessaires","danger")}]],$scope.addDossier=addDossier,$scope.addUrl=addUrl,$scope.displayUrlFileModal=displayUrlFileModal,$scope.addPad=addPad,$scope.addVisio=addVisio,$scope.displayPadModal=displayPadModal,$scope.displayVisioModal=displayVisioModal,$scope.removeNode=removeNode,$scope.showSelected=showSelected,$scope.copyToClipboard=copyToClipboard,$scope.isClipboardEmpty=isClipboardEmpty,$scope.pasteFromClipboard=pasteFromClipboard,$scope.getExtension=getExtension,$scope.onUpload=onUpload,$scope.libelleLowerCase=libelleLowerCase,$scope.gotoNode=gotoNode,$scope.onDrop=onDrop,$scope.maxFileSize=maxFileSize,$scope.isUrlFile=isUrlFile,$scope.isPadFile=isPadFile,$scope.isVisioFile=isVisioFile,$scope.isVisioEnable=isVisioEnable,$scope.canAddVisio=canAddVisio,$scope.isImage=isImage,$scope.currentSelections=[],$scope.isNodeSelected=isNodeSelected,$scope.addNodeToSelection=addNodeToSelection,$scope.cloudTree={treeSelectNodeHeadCallBack:function(selectedNode){$scope.cloudTree.selectNodeLabel(selectedNode)}},$scope.onOpenNode=function(node){openAncestors(node.id),$scope.cloudTree.selectNodeLabel(node)},$scope.promiseContents=CloudService.getCloudContents($scope.entity.id,$scope.entity.type).then(function(contents){$scope.dossiers=contents,$scope.currentNode=contents[0],$scope.quota=contents[0].quota,$scope.usage=contents[0].taille,$scope.showSelected(contents[0]),updateRootNodeLibelle()}),$scope.displayedContents=[].concat($scope.currentNode.children),$scope.entity.type!==Auth.TYPE_USER.ESPACE_TRAVAIL&&$scope.entity.type!==Auth.TYPE_USER.ENSEIGNANT&&$scope.entity.type!==Auth.TYPE_USER.PERSONNEL&&UserService.getEleve($scope.entity.id).then(function(eleve){$scope.prenomEleve=eleve.prenom})}]),angular.module("edsiteApp.Login",["ngStorage","ui.bootstrap","edsiteApp.httpAuthInterceptor","edsiteApp.Commun"]).controller("LoginCtrl",["$scope","$localStorage","$routeParams","$location","$uibModal","$uibModalStack","httpAuthService","Notification","Auth","Settings",function($scope,$localStorage,$routeParams,$location,$uibModal,$uibModalStack,httpAuthService,Notification,Auth,Settings){function storeCNILCookie(){$localStorage.consentement_cnil=1}function isCNILOK(){return angular.isDefined($localStorage.consentement_cnil)}function login(isReLogin){$scope.siteClosed=!1,$scope.errorMessage="";var oldUsername=Auth.username();$scope.promiseContents=Auth.login({identifiant:$scope.username,motdepasse:$scope.password},isReLogin&&oldUsername===$scope.username).then(function(user){if(202===user.code){$scope.utilisateurInfosPassword.questionsPossibles=user.data.questionsPossibles,$scope.utilisateurInfosPassword.loginOrigine=user.data.login,$scope.utilisateurInfosPassword.motPasseOrigine=user.data.motDePasse,$scope.utilisateurInfosPassword.niveauMdp=user.data.niveauMdp,$scope.origineAction="C";var dialog=$uibModal.open({templateUrl:"modules/creationCompteUtilisateur/creationCompte.html",scope:$scope,controller:"CreationCompteUtilisateurCtrl",backdrop:!1});dialog.result.then(function(){$scope.username="",$scope.password=""},function(){$scope.username="",$scope.password=""})}else if(221===user.code)$scope.errorMessage="Echec lors de l'enregistrement : "+user.message;else if(""!==self.camefrom)$location.path(self.camefrom).search("camefrom",null);else if(""!==self.service){$scope.redirEnCours=!0;var settings=Settings.allSettings(),action=settings.apiUri+"cas/goToService"+settings.apiExtension+"?service="+self.service,formElement=angular.element("<form/>");formElement.attr({method:"POST",action:action});var tokenElement=angular.element("<input />");tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),formElement.append(tokenElement),formElement.appendTo("body").submit(),formElement.remove()}else isReLogin&&oldUsername===$scope.username?(httpAuthService.loginConfirmed(user.token),$uibModalStack.dismissAll()):(httpAuthService.loginCancelled({config:{ignoreLoadingBar:1}}),$uibModalStack.dismissAll(),$scope.loginStored?$localStorage.pseudo=$scope.username:delete $localStorage.pseudo,$location.path("/main"))},function(response){516===response.code||535===response.code?($scope.siteClosed=!0,$scope.errorMessage=""):518===response.code?$scope.errorMessage="<b>Votre fiche utilisateur n'existe pas sur EcoleDirecte</b><br/> Veuillez contacter votre établissement":221===response.code?$scope.errorMessage="<b>Identifiant déjà personnalisé</b><br/> L'identifiant et le mot de passe que vous avez saisis ont déjà été personnalisés. Veuillez vérifier et réessayer <br/> Si le problème persiste, veuillez cliquer sur le lien 'Mot de passe oublié ?' ou contacter votre établissement pour obtenir de nouveaux identifiants":517===response.code?$scope.errorMessage=response.message:$scope.errorMessage="<b>Identifiant ou Mot de passe invalide</b><br/>L'identifiant et le mot de passe que vous avez entrés ne correspondent pas à ceux présents dans nos fichiers. Veuillez vérifier et réessayer <br/> Si le problème persiste, veuillez cliquer sur le lien 'Mot de passe oublié ?' ou contacter votre établissement pour obtenir de nouveaux identifiants"})}function showPassword(){$scope.isPasswordVisible=!$scope.isPasswordVisible}function openModalMentionsLegales(){$uibModal.open({templateUrl:"modules/commun/modal-mentions-legales-template.html",controller:"modalMentionsLegales"})}function openModalAideConnexion(){$uibModal.open({templateUrl:"modules/commun/modal-aide-connexion-template.html",controller:"modalAideConnexion"})}$scope.loginCtrl=!0,$scope.username="",$scope.password="",$scope.isPasswordVisible=!1,this.camefrom="undefined"!=typeof $routeParams.camefrom?$routeParams.camefrom:"",this.service="undefined"!=typeof $routeParams.service?$routeParams.service:"","/403"===this.camefrom&&(this.camefrom="");var self=this;$scope.storeCNILCookie=storeCNILCookie,$scope.isCNILOK=isCNILOK,$scope.login=login,$scope.openModalMentionsLegales=openModalMentionsLegales,$scope.openModalAideConnexion=openModalAideConnexion,$scope.showPassword=showPassword,$scope.errorMessage="",$scope.utilisateurInfosPassword={},$scope.loginStored=!1,$scope.siteClosed=!1,$scope.redirEnCours=!1,$scope.isRelogin=!!Auth.currentUser()||!1,$scope.isRelogin?$scope.username=Auth.currentUser().identifiant:$routeParams.camefrom="",angular.isDefined($localStorage.pseudo)&&($scope.username=$localStorage.pseudo,$scope.loginStored=!0)}]),angular.module("edsiteApp.Login").controller("LogoutCtrl",["$scope","$location","Auth","EmploiDuTempsService",function($scope,$location,Auth,EmploiDuTempsService){Auth.logout(),EmploiDuTempsService.agendasToDisplay=[],$location.path("/")}]),angular.module("edsiteApp.Commun").factory("Auth",["$http","$rootScope","$filter","Settings","$sessionStorage","$q","lodash","$location","Notification","EdClusterService","CacheService",function($http,$rootScope,$filter,Settings,$sessionStorage,$q,lodash,$location,Notification,EdClusterService,CacheService){var AuthService={},currentUser={},allUsers="";return AuthService.TYPE_USER={ENSEIGNANT:"P",FAMILLE:"1",FAMILLE_RESPONSABLE:"1",FAMILLE_CONJOINT:"2",ELEVE:"E",PERSONNEL:"A",ESPACE_TRAVAIL:"W"},AuthService.CONSTANTS={POIL_DANS_LA_MAIN_BORNE:"LSU/PoilDansLaMain/borne"},AuthService.socketToken=function(){return currentUser.socketToken},AuthService.loginUser=function(user){$sessionStorage.token=user.token,currentUser=lodash.find(user.data.accounts,{current:!0}),currentUser||(currentUser=lodash.find(user.data.accounts,{main:!0}),currentUser.current=!0),allUsers=user.data.accounts,$sessionStorage.user=allUsers,AuthService.isPersonnel()?AuthService.addPermissionToCurrentUser("isPersonnel"):AuthService.isProfesseur()&&AuthService.addPermissionToCurrentUser("isProfesseur"),$sessionStorage["modeAccessibiliteVisuelleActif-"+AuthService.role()+"-"+AuthService.currentUser().id]=AuthService.listParametresIndividuels("modeAccessibiliteVisuelle")},AuthService.swipeProfil=function(profil){currentUser.typeCompte=profil;var defer=$q.defer();$sessionStorage.panier=[],$sessionStorage["user-niveaux"]=void 0,$sessionStorage["user-niveaux-all"]=void 0,CacheService.removeAll();var baseUrl="renewtoken",data={profil:profil,uid:currentUser.uid};return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){$sessionStorage.token=response.data.token,AuthService.challengeBySessionStorage(),currentUser.modules=response.data.data.modules,currentUser.profile=response.data.data.profile,defer.resolve(),$location.path("/main")},function(){defer.reject(),Notification.notify("Une erreur est survenue","Le changement de profil ne peut pas être effectué","error",!0)}),defer.promise},AuthService.swipeUser=function(id){var accounts=$sessionStorage.user,defer=$q.defer();if(id!==currentUser.idLogin){lodash.forEach(accounts,function(account){account.current=account.idLogin===id}),$sessionStorage.user=accounts,$sessionStorage.panier=[],$sessionStorage["user-niveaux"]=void 0,$sessionStorage["user-niveaux-all"]=void 0;var baseUrl="renewtoken",data={idUser:id};CacheService.removeAll(),$http({method:"POST",url:baseUrl,data:data}).then(function(response){$sessionStorage.token=response.data.token,AuthService.challengeBySessionStorage(),defer.resolve(),$location.path("/main")},function(){defer.reject(),Notification.notify("Une erreur est survenue","Le changement de compte ne peut pas être effectué","error",!0)})}else defer.resolve();return defer.promise},AuthService.currentUser=function(){return currentUser},AuthService.setAllUsers=function(userAccounts){allUsers=userAccounts},AuthService.allUsers=function(){return allUsers},AuthService.username=function(){return currentUser.identifiant},AuthService.role=function(){return currentUser.typeCompte},AuthService.idUser=function(){return currentUser.id},AuthService.idLogin=function(){return currentUser.idLogin},AuthService.codeOgec=function(){return currentUser.codeOgec},AuthService.token=function(){return $sessionStorage.token},AuthService.cToken=function(){return $filter("base64encode")(currentUser.codeOgec)},AuthService.isAuthenticated=function(){return"undefined"!=typeof currentUser&&"undefined"!=typeof currentUser.id},AuthService.isFamilleResponsable=function(){return"1"===$sessionStorage.user.profile.type},AuthService.isEleve=function(){return"E"===currentUser.typeCompte},AuthService.isFamille=function(){return"1"===currentUser.typeCompte||"2"===currentUser.typeCompte},AuthService.isPersonnel=function(){return"A"===currentUser.typeCompte},AuthService.isProfesseur=function(){return"P"===currentUser.typeCompte},AuthService.isProfEtPersonnel=function(){return currentUser.isProfEtPersonnel},AuthService.anneeScolaireCourante=function(){return currentUser.anneeScolaireCourante},AuthService.updateToken=function(newToken){$sessionStorage.token=newToken},AuthService.getClasses=function(){var classes=[];if(AuthService.isFamille()&&(classes=lodash.map(currentUser.profile.eleves,function(eleve){return eleve.classe})),AuthService.isEleve()){var eleve=AuthService.currentUser();classes.push(eleve.profile.classe)}return classes=lodash.sortBy(classes,"libelle")},AuthService.getMatieres=function(){var matieres=[];return AuthService.isProfesseur()&&(matieres=currentUser.profile.matieres),matieres=lodash.sortBy(matieres,"libelle")},AuthService.getGroupes=function(){var groupes=[];return AuthService.isProfesseur()&&(groupes=currentUser.profile.groupes),groupes=lodash.sortBy(groupes,"libelle")},AuthService.challengeBySessionStorage=function(){if($sessionStorage.user&&$sessionStorage.token){var newUser={token:$sessionStorage.token,data:{accounts:$sessionStorage.user}};AuthService.loginUser(newUser)}},AuthService.logout=function(){EdClusterService.profileDisconnect(),$sessionStorage.$reset(),CacheService.removeAll(),currentUser={},$rootScope.$broadcast("logout-user")},AuthService.login=function(user,isReLogin){var defer=$q.defer();return $http({method:"POST",url:Settings.allSettings().apiUri+"login"+Settings.allSettings().apiExtension,data:user,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(user){200===user.code&&(isReLogin||($sessionStorage.$reset(),CacheService.removeAll()),AuthService.loginUser(user)),EdClusterService.profileConnect(),defer.resolve(user)}).error(function(response){defer.reject(response)}),defer.promise},AuthService.getCurrentUserPermissions=function(){var id=currentUser.id,typeUser=currentUser.typeCompte;return $sessionStorage["permissions-"+id+"-"+typeUser]||($sessionStorage["permissions-"+id+"-"+typeUser]=[]),$sessionStorage["permissions-"+id+"-"+typeUser]},AuthService.addPermissionToCurrentUser=function(permission){var id=currentUser.id,typeUser=currentUser.typeCompte;$sessionStorage["permissions-"+id+"-"+typeUser]||($sessionStorage["permissions-"+id+"-"+typeUser]=[]);var index=$sessionStorage["permissions-"+id+"-"+typeUser].indexOf(permission);-1===index&&$sessionStorage["permissions-"+id+"-"+typeUser].push(permission)},AuthService.removePermissionToCurrentUser=function(permission){var id=currentUser.id,typeUser=currentUser.typeCompte;$sessionStorage["permissions-"+id+"-"+typeUser]||($sessionStorage["permissions-"+id+"-"+typeUser]=[]);var index=$sessionStorage["permissions-"+id+"-"+typeUser].indexOf(permission);index>-1&&$sessionStorage["permissions-"+id+"-"+typeUser].splice(index,1)},AuthService.isHimself=function(typeUser,idUser){return currentUser.id===parseInt(idUser)&&currentUser.typeCompte===typeUser},AuthService.isModeSupervision=function(){return"supervision"===AuthService.username()},AuthService.listParametresIndividuels=function(keyParam){var lParams=currentUser.parametresIndividuels;return angular.isDefined(lParams)&&keyParam?lParams[keyParam]:lParams},AuthService.setParametresIndividuel=function(keyParam,valueParam){var lParams=currentUser.parametresIndividuels;angular.isDefined(lParams)&&keyParam&&(lParams[keyParam]=valueParam)},AuthService.setActivationNotifications=function(isActif,cleCible){if(!angular.isDefined(cleCible))var cleCible="*";angular.isDefined($sessionStorage.notificationsActif)||($sessionStorage.notificationsActif=[]),$sessionStorage.notificationsActif[cleCible]=isActif},AuthService.isNotificationsActif=function(cleCible){if(!angular.isDefined(cleCible))var cleCible="*";return angular.isDefined($sessionStorage.notificationsActif)&&angular.isDefined($sessionStorage.notificationsActif[cleCible])?$sessionStorage.notificationsActif[cleCible]:!0},AuthService}]),!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n():"function"==typeof define&&define.amd?define(n):n()}(0,function(){function e(e){var n=this.constructor;return this.then(function(t){return n.resolve(e()).then(function(){return t})},function(t){return n.resolve(e()).then(function(){return n.reject(t)})})}function n(e){return!(!e||"undefined"==typeof e.length)}function t(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function r(e,n){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn(function(){var t=1===e._state?n.onFulfilled:n.onRejected;if(null!==t){var o;try{o=t(e._value)}catch(r){return void f(n.promise,r)}i(n.promise,o)}else(1===e._state?i:f)(n.promise,e._value)})):e._deferreds.push(n)}function i(e,n){try{if(n===e)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var t=n.then;if(n instanceof o)return e._state=3,e._value=n,void u(e);if("function"==typeof t)return void c(function(e,n){return function(){e.apply(n,arguments)}}(t,n),e)}e._state=1,e._value=n,u(e)}catch(r){f(e,r)}}function f(e,n){e._state=2,e._value=n,u(e)}function u(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var n=0,t=e._deferreds.length;t>n;n++)r(e,e._deferreds[n]);e._deferreds=null}function c(e,n){var t=!1;try{e(function(e){t||(t=!0,i(n,e))},function(e){t||(t=!0,f(n,e))})}catch(o){if(t)return;t=!0,f(n,o)}}var a=setTimeout;o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,n){var o=new this.constructor(t);return r(this,new function(e,n,t){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof n?n:null,this.promise=t}(e,n,o)),o},o.prototype["finally"]=e,o.all=function(e){return new o(function(t,o){function r(e,n){try{if(n&&("object"==typeof n||"function"==typeof n)){var u=n.then;if("function"==typeof u)return void u.call(n,function(n){r(e,n)},o)}i[e]=n,0==--f&&t(i)}catch(c){o(c)}}if(!n(e))return o(new TypeError("Promise.all accepts an array"));var i=Array.prototype.slice.call(e);if(0===i.length)return t([]);for(var f=i.length,u=0;i.length>u;u++)r(u,i[u])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(n){n(e)})},o.reject=function(e){return new o(function(n,t){t(e)})},o.race=function(e){return new o(function(t,r){if(!n(e))return r(new TypeError("Promise.race accepts an array"));for(var i=0,f=e.length;f>i;i++)o.resolve(e[i]).then(t,r)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){a(e,0)},o._unhandledRejectionFn=function(e){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var l=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();"Promise"in l?l.Promise.prototype["finally"]||(l.Promise.prototype["finally"]=e):l.Promise=o}),!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n;"undefined"!=typeof window?n=window:"undefined"!=typeof global?n=global:"undefined"!=typeof self&&(n=self),n.html2canvas=e()}}(function(){var e;return function n(e,f,o){function d(t,l){if(!f[t]){if(!e[t]){var s="function"==typeof require&&require;if(!l&&s)return s(t,!0);if(i)return i(t,!0);var u=new Error("Cannot find module '"+t+"'");throw u.code="MODULE_NOT_FOUND",u}var a=f[t]={exports:{}};e[t][0].call(a.exports,function(n){var f=e[t][1][n];return d(f?f:n)},a,a.exports,n,e,f,o)}return f[t].exports}for(var i="function"==typeof require&&require,t=0;t<o.length;t++)d(o[t]);return d}({1:[function(n,f,o){(function(n){!function(d){function i(e){throw RangeError(I[e])}function t(e,n){for(var f=e.length;f--;)e[f]=n(e[f]);return e}function l(e,n){return t(e.split(H),n).join(".")}function s(e){for(var n,f,o=[],d=0,i=e.length;i>d;)n=e.charCodeAt(d++),n>=55296&&56319>=n&&i>d?(f=e.charCodeAt(d++),56320==(64512&f)?o.push(((1023&n)<<10)+(1023&f)+65536):(o.push(n),d--)):o.push(n);return o}function u(e){return t(e,function(e){var n="";return e>65535&&(e-=65536,n+=L(e>>>10&1023|55296),e=56320|1023&e),n+=L(e)}).join("")}function a(e){return 10>e-48?e-22:26>e-65?e-65:26>e-97?e-97:k}function p(e,n){return e+22+75*(26>e)-((0!=n)<<5)}function c(e,n,f){var o=0;for(e=f?K(e/B):e>>1,e+=K(e/n);e>J*z>>1;o+=k)e=K(e/J);return K(o+(J+1)*e/(e+A))}function y(e){var n,f,o,d,t,l,s,p,y,m,r=[],v=e.length,w=0,b=D,g=C;for(f=e.lastIndexOf(E),0>f&&(f=0),o=0;f>o;++o)e.charCodeAt(o)>=128&&i("not-basic"),r.push(e.charCodeAt(o));for(d=f>0?f+1:0;v>d;){for(t=w,l=1,s=k;d>=v&&i("invalid-input"),p=a(e.charCodeAt(d++)),(p>=k||p>K((j-w)/l))&&i("overflow"),w+=p*l,y=g>=s?q:s>=g+z?z:s-g,!(y>p);s+=k)m=k-y,l>K(j/m)&&i("overflow"),l*=m;n=r.length+1,g=c(w-t,n,0==t),K(w/n)>j-b&&i("overflow"),b+=K(w/n),w%=n,r.splice(w++,0,b)}return u(r)}function m(e){var n,f,o,d,t,l,u,a,y,m,r,v,w,b,g,h=[];for(e=s(e),v=e.length,n=D,f=0,t=C,l=0;v>l;++l)r=e[l],128>r&&h.push(L(r));for(o=d=h.length,d&&h.push(E);v>o;){for(u=j,l=0;v>l;++l)r=e[l],r>=n&&u>r&&(u=r);for(w=o+1,u-n>K((j-f)/w)&&i("overflow"),f+=(u-n)*w,n=u,l=0;v>l;++l)if(r=e[l],n>r&&++f>j&&i("overflow"),r==n){for(a=f,y=k;m=t>=y?q:y>=t+z?z:y-t,!(m>a);y+=k)g=a-m,b=k-m,h.push(L(p(m+g%b,0))),a=K(g/b);h.push(L(p(a,0))),t=c(f,w,o==d),f=0,++o}++f,++n}return h.join("")}function r(e){return l(e,function(e){return F.test(e)?y(e.slice(4).toLowerCase()):e})}function v(e){return l(e,function(e){return G.test(e)?"xn--"+m(e):e})}var w="object"==typeof o&&o,b="object"==typeof f&&f&&f.exports==w&&f,g="object"==typeof n&&n;(g.global===g||g.window===g)&&(d=g);var h,x,j=2147483647,k=36,q=1,z=26,A=38,B=700,C=72,D=128,E="-",F=/^xn--/,G=/[^ -~]/,H=/\x2E|\u3002|\uFF0E|\uFF61/g,I={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},J=k-q,K=Math.floor,L=String.fromCharCode;if(h={version:"1.2.4",ucs2:{decode:s,encode:u},decode:y,encode:m,toASCII:v,toUnicode:r},"function"==typeof e&&"object"==typeof e.amd&&e.amd)e("punycode",function(){return h});else if(w&&!w.nodeType)if(b)b.exports=h;else for(x in h)h.hasOwnProperty(x)&&(w[x]=h[x]);else d.punycode=h}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,n){function f(e,n,f){!e.defaultView||n===e.defaultView.pageXOffset&&f===e.defaultView.pageYOffset||e.defaultView.scrollTo(n,f)}function o(e,n){try{n&&(n.width=e.width,n.height=e.height,n.getContext("2d").putImageData(e.getContext("2d").getImageData(0,0,e.width,e.height),0,0))}catch(f){t("Unable to copy canvas content from",e,f)}}function d(e,n){for(var f=3===e.nodeType?document.createTextNode(e.nodeValue):e.cloneNode(!1),i=e.firstChild;i;)(n===!0||1!==i.nodeType||"SCRIPT"!==i.nodeName)&&f.appendChild(d(i,n)),i=i.nextSibling;return 1===e.nodeType&&(f._scrollTop=e.scrollTop,f._scrollLeft=e.scrollLeft,"CANVAS"===e.nodeName?o(e,f):("TEXTAREA"===e.nodeName||"SELECT"===e.nodeName)&&(f.value=e.value)),f}function i(e){if(1===e.nodeType){e.scrollTop=e._scrollTop,e.scrollLeft=e._scrollLeft;for(var n=e.firstChild;n;)i(n),n=n.nextSibling}}var t=e("./log");n.exports=function(e,n,o,t,l,s,u){var a=d(e.documentElement,l.javascriptEnabled),p=n.createElement("iframe");return p.className="html2canvas-container",p.style.visibility="hidden",p.style.position="fixed",p.style.left="-10000px",p.style.top="0px",p.style.border="0",p.width=o,p.height=t,p.scrolling="no",n.body.appendChild(p),new Promise(function(n){var o=p.contentWindow.document;p.contentWindow.onload=p.onload=function(){var e=setInterval(function(){o.body.childNodes.length>0&&(i(o.documentElement),
clearInterval(e),"view"===l.type&&(p.contentWindow.scrollTo(s,u),!/(iPad|iPhone|iPod)/g.test(navigator.userAgent)||p.contentWindow.scrollY===u&&p.contentWindow.scrollX===s||(o.documentElement.style.top=-u+"px",o.documentElement.style.left=-s+"px",o.documentElement.style.position="absolute")),n(p))},50)},o.open(),o.write("<!DOCTYPE html><html></html>"),f(e,s,u),o.replaceChild(o.adoptNode(a),o.documentElement),o.close()})}},{"./log":13}],3:[function(e,n){function f(e){this.r=0,this.g=0,this.b=0,this.a=null,this.fromArray(e)||this.namedColor(e)||this.rgb(e)||this.rgba(e)||this.hex6(e)||this.hex3(e)}f.prototype.darken=function(e){var n=1-e;return new f([Math.round(this.r*n),Math.round(this.g*n),Math.round(this.b*n),this.a])},f.prototype.isTransparent=function(){return 0===this.a},f.prototype.isBlack=function(){return 0===this.r&&0===this.g&&0===this.b},f.prototype.fromArray=function(e){return Array.isArray(e)&&(this.r=Math.min(e[0],255),this.g=Math.min(e[1],255),this.b=Math.min(e[2],255),e.length>3&&(this.a=e[3])),Array.isArray(e)};var o=/^#([a-f0-9]{3})$/i;f.prototype.hex3=function(e){var n=null;return null!==(n=e.match(o))&&(this.r=parseInt(n[1][0]+n[1][0],16),this.g=parseInt(n[1][1]+n[1][1],16),this.b=parseInt(n[1][2]+n[1][2],16)),null!==n};var d=/^#([a-f0-9]{6})$/i;f.prototype.hex6=function(e){var n=null;return null!==(n=e.match(d))&&(this.r=parseInt(n[1].substring(0,2),16),this.g=parseInt(n[1].substring(2,4),16),this.b=parseInt(n[1].substring(4,6),16)),null!==n};var i=/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/;f.prototype.rgb=function(e){var n=null;return null!==(n=e.match(i))&&(this.r=Number(n[1]),this.g=Number(n[2]),this.b=Number(n[3])),null!==n};var t=/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d?\.?\d+)\s*\)$/;f.prototype.rgba=function(e){var n=null;return null!==(n=e.match(t))&&(this.r=Number(n[1]),this.g=Number(n[2]),this.b=Number(n[3]),this.a=Number(n[4])),null!==n},f.prototype.toString=function(){return null!==this.a&&1!==this.a?"rgba("+[this.r,this.g,this.b,this.a].join(",")+")":"rgb("+[this.r,this.g,this.b].join(",")+")"},f.prototype.namedColor=function(e){e=e.toLowerCase();var n=l[e];if(n)this.r=n[0],this.g=n[1],this.b=n[2];else if("transparent"===e)return this.r=this.g=this.b=this.a=0,!0;return!!n},f.prototype.isColor=!0;var l={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};n.exports=f},{}],4:[function(n,f){function o(e,n){var f=j++;if(n=n||{},n.logging&&(v.options.logging=!0,v.options.start=Date.now()),n.async="undefined"==typeof n.async?!0:n.async,n.allowTaint="undefined"==typeof n.allowTaint?!1:n.allowTaint,n.removeContainer="undefined"==typeof n.removeContainer?!0:n.removeContainer,n.javascriptEnabled="undefined"==typeof n.javascriptEnabled?!1:n.javascriptEnabled,n.imageTimeout="undefined"==typeof n.imageTimeout?1e4:n.imageTimeout,n.renderer="function"==typeof n.renderer?n.renderer:c,n.strict=!!n.strict,"string"==typeof e){if("string"!=typeof n.proxy)return Promise.reject("Proxy must be used when rendering url");var o=null!=n.width?n.width:window.innerWidth,t=null!=n.height?n.height:window.innerHeight;return g(a(e),n.proxy,document,o,t,n).then(function(e){return i(e.contentWindow.document.documentElement,e,n,o,t)})}var l=(void 0===e?[document.documentElement]:e.length?e:[e])[0];return l.setAttribute(x+f,f),d(l.ownerDocument,n,l.ownerDocument.defaultView.innerWidth,l.ownerDocument.defaultView.innerHeight,f).then(function(e){return"function"==typeof n.onrendered&&(v("options.onrendered is deprecated, html2canvas returns a Promise containing the canvas"),n.onrendered(e)),e})}function d(e,n,f,o,d){return b(e,e,f,o,n,e.defaultView.pageXOffset,e.defaultView.pageYOffset).then(function(t){v("Document cloned");var l=x+d,s="["+l+"='"+d+"']";e.querySelector(s).removeAttribute(l);var u=t.contentWindow,a=u.document.querySelector(s),p=Promise.resolve("function"==typeof n.onclone?n.onclone(u.document):!0);return p.then(function(){return i(a,t,n,f,o)})})}function i(e,n,f,o,d){var i=n.contentWindow,a=new p(i.document),c=new y(f,a),r=h(e),w="view"===f.type?o:s(i.document),b="view"===f.type?d:u(i.document),g=new f.renderer(w,b,c,f,document),x=new m(e,g,a,c,f);return x.ready.then(function(){v("Finished rendering");var o;return o="view"===f.type?l(g.canvas,{width:g.canvas.width,height:g.canvas.height,top:0,left:0,x:0,y:0}):e===i.document.body||e===i.document.documentElement||null!=f.canvas?g.canvas:l(g.canvas,{width:null!=f.width?f.width:r.width,height:null!=f.height?f.height:r.height,top:r.top,left:r.left,x:0,y:0}),t(n,f),o})}function t(e,n){n.removeContainer&&(e.parentNode.removeChild(e),v("Cleaned up container"))}function l(e,n){var f=document.createElement("canvas"),o=Math.min(e.width-1,Math.max(0,n.left)),d=Math.min(e.width,Math.max(1,n.left+n.width)),i=Math.min(e.height-1,Math.max(0,n.top)),t=Math.min(e.height,Math.max(1,n.top+n.height));f.width=n.width,f.height=n.height;var l=d-o,s=t-i;return v("Cropping canvas at:","left:",n.left,"top:",n.top,"width:",l,"height:",s),v("Resulting crop with width",n.width,"and height",n.height,"with x",o,"and y",i),f.getContext("2d").drawImage(e,o,i,l,s,n.x,n.y,l,s),f}function s(e){return Math.max(Math.max(e.body.scrollWidth,e.documentElement.scrollWidth),Math.max(e.body.offsetWidth,e.documentElement.offsetWidth),Math.max(e.body.clientWidth,e.documentElement.clientWidth))}function u(e){return Math.max(Math.max(e.body.scrollHeight,e.documentElement.scrollHeight),Math.max(e.body.offsetHeight,e.documentElement.offsetHeight),Math.max(e.body.clientHeight,e.documentElement.clientHeight))}function a(e){var n=document.createElement("a");return n.href=e,n.href=n.href,n}var p=n("./support"),c=n("./renderers/canvas"),y=n("./imageloader"),m=n("./nodeparser"),r=n("./nodecontainer"),v=n("./log"),w=n("./utils"),b=n("./clone"),g=n("./proxy").loadUrlDocument,h=w.getBounds,x="data-html2canvas-node",j=0;o.CanvasRenderer=c,o.NodeContainer=r,o.log=v,o.utils=w;var k="undefined"==typeof document||"function"!=typeof Object.create||"function"!=typeof document.createElement("canvas").getContext?function(){return Promise.reject("No canvas support")}:o;f.exports=k,"function"==typeof e&&e.amd&&e("html2canvas",[],function(){return k})},{"./clone":2,"./imageloader":11,"./log":13,"./nodecontainer":14,"./nodeparser":15,"./proxy":16,"./renderers/canvas":20,"./support":22,"./utils":26}],5:[function(e,n){function f(e){if(this.src=e,o("DummyImageContainer for",e),!this.promise||!this.image){o("Initiating DummyImageContainer"),f.prototype.image=new Image;var n=this.image;f.prototype.promise=new Promise(function(e,f){n.onload=e,n.onerror=f,n.src=d(),n.complete===!0&&e(n)})}}var o=e("./log"),d=e("./utils").smallImage;n.exports=f},{"./log":13,"./utils":26}],6:[function(e,n){function f(e,n){var f,d,i=document.createElement("div"),t=document.createElement("img"),l=document.createElement("span"),s="Hidden Text";i.style.visibility="hidden",i.style.fontFamily=e,i.style.fontSize=n,i.style.margin=0,i.style.padding=0,document.body.appendChild(i),t.src=o(),t.width=1,t.height=1,t.style.margin=0,t.style.padding=0,t.style.verticalAlign="baseline",l.style.fontFamily=e,l.style.fontSize=n,l.style.margin=0,l.style.padding=0,l.appendChild(document.createTextNode(s)),i.appendChild(l),i.appendChild(t),f=t.offsetTop-l.offsetTop+1,i.removeChild(l),i.appendChild(document.createTextNode(s)),i.style.lineHeight="normal",t.style.verticalAlign="super",d=t.offsetTop-i.offsetTop+1,document.body.removeChild(i),this.baseline=f,this.lineWidth=1,this.middle=d}var o=e("./utils").smallImage;n.exports=f},{"./utils":26}],7:[function(e,n){function f(){this.data={}}var o=e("./font");f.prototype.getMetrics=function(e,n){return void 0===this.data[e+"-"+n]&&(this.data[e+"-"+n]=new o(e,n)),this.data[e+"-"+n]},n.exports=f},{"./font":6}],8:[function(e,n){function f(n,f,o){this.image=null,this.src=n;var i=this,t=d(n);this.promise=(f?new Promise(function(e){"about:blank"===n.contentWindow.document.URL||null==n.contentWindow.document.documentElement?n.contentWindow.onload=n.onload=function(){e(n)}:e(n)}):this.proxyLoad(o.proxy,t,o)).then(function(n){var f=e("./core");return f(n.contentWindow.document.documentElement,{type:"view",width:n.width,height:n.height,proxy:o.proxy,javascriptEnabled:o.javascriptEnabled,removeContainer:o.removeContainer,allowTaint:o.allowTaint,imageTimeout:o.imageTimeout/2})}).then(function(e){return i.image=e})}var o=e("./utils"),d=o.getBounds,i=e("./proxy").loadUrlDocument;f.prototype.proxyLoad=function(e,n,f){var o=this.src;return i(o.src,e,o.ownerDocument,n.width,n.height,f)},n.exports=f},{"./core":4,"./proxy":16,"./utils":26}],9:[function(e,n){function f(e){this.src=e.value,this.colorStops=[],this.type=null,this.x0=.5,this.y0=.5,this.x1=.5,this.y1=.5,this.promise=Promise.resolve(!0)}f.TYPES={LINEAR:1,RADIAL:2},f.REGEXP_COLORSTOP=/^\s*(rgba?\(\s*\d{1,3},\s*\d{1,3},\s*\d{1,3}(?:,\s*[0-9\.]+)?\s*\)|[a-z]{3,20}|#[a-f0-9]{3,6})(?:\s+(\d{1,3}(?:\.\d+)?)(%|px)?)?(?:\s|$)/i,n.exports=f},{}],10:[function(e,n){function f(e,n){this.src=e,this.image=new Image;var f=this;this.tainted=null,this.promise=new Promise(function(o,d){f.image.onload=o,f.image.onerror=d,n&&(f.image.crossOrigin="anonymous"),f.image.src=e,f.image.complete===!0&&o(f.image)})}n.exports=f},{}],11:[function(e,n){function f(e,n){this.link=null,this.options=e,this.support=n,this.origin=this.getOrigin(window.location.href)}var o=e("./log"),d=e("./imagecontainer"),i=e("./dummyimagecontainer"),t=e("./proxyimagecontainer"),l=e("./framecontainer"),s=e("./svgcontainer"),u=e("./svgnodecontainer"),a=e("./lineargradientcontainer"),p=e("./webkitgradientcontainer"),c=e("./utils").bind;f.prototype.findImages=function(e){var n=[];return e.reduce(function(e,n){switch(n.node.nodeName){case"IMG":return e.concat([{args:[n.node.src],method:"url"}]);case"svg":case"IFRAME":return e.concat([{args:[n.node],method:n.node.nodeName}])}return e},[]).forEach(this.addImage(n,this.loadImage),this),n},f.prototype.findBackgroundImage=function(e,n){return n.parseBackgroundImages().filter(this.hasImageBackground).forEach(this.addImage(e,this.loadImage),this),e},f.prototype.addImage=function(e,n){return function(f){f.args.forEach(function(d){this.imageExists(e,d)||(e.splice(0,0,n.call(this,f)),o("Added image #"+e.length,"string"==typeof d?d.substring(0,100):d))},this)}},f.prototype.hasImageBackground=function(e){return"none"!==e.method},f.prototype.loadImage=function(e){if("url"===e.method){var n=e.args[0];return!this.isSVG(n)||this.support.svg||this.options.allowTaint?n.match(/data:image\/.*;base64,/i)?new d(n.replace(/url\(['"]{0,}|['"]{0,}\)$/gi,""),!1):this.isSameOrigin(n)||this.options.allowTaint===!0||this.isSVG(n)?new d(n,!1):this.support.cors&&!this.options.allowTaint&&this.options.useCORS?new d(n,!0):this.options.proxy?new t(n,this.options.proxy):new i(n):new s(n)}return"linear-gradient"===e.method?new a(e):"gradient"===e.method?new p(e):"svg"===e.method?new u(e.args[0],this.support.svg):"IFRAME"===e.method?new l(e.args[0],this.isSameOrigin(e.args[0].src),this.options):new i(e)},f.prototype.isSVG=function(e){return"svg"===e.substring(e.length-3).toLowerCase()||s.prototype.isInline(e)},f.prototype.imageExists=function(e,n){return e.some(function(e){return e.src===n})},f.prototype.isSameOrigin=function(e){return this.getOrigin(e)===this.origin},f.prototype.getOrigin=function(e){var n=this.link||(this.link=document.createElement("a"));return n.href=e,n.href=n.href,n.protocol+n.hostname+n.port},f.prototype.getPromise=function(e){return this.timeout(e,this.options.imageTimeout)["catch"](function(){var n=new i(e.src);return n.promise.then(function(n){e.image=n})})},f.prototype.get=function(e){var n=null;return this.images.some(function(f){return(n=f).src===e})?n:null},f.prototype.fetch=function(e){return this.images=e.reduce(c(this.findBackgroundImage,this),this.findImages(e)),this.images.forEach(function(e,n){e.promise.then(function(){o("Succesfully loaded image #"+(n+1),e)},function(f){o("Failed loading image #"+(n+1),e,f)})}),this.ready=Promise.all(this.images.map(this.getPromise,this)),o("Finished searching images"),this},f.prototype.timeout=function(e,n){var f,d=Promise.race([e.promise,new Promise(function(d,i){f=setTimeout(function(){o("Timed out loading image",e),i(e)},n)})]).then(function(e){return clearTimeout(f),e});return d["catch"](function(){clearTimeout(f)}),d},n.exports=f},{"./dummyimagecontainer":5,"./framecontainer":8,"./imagecontainer":10,"./lineargradientcontainer":12,"./log":13,"./proxyimagecontainer":17,"./svgcontainer":23,"./svgnodecontainer":24,"./utils":26,"./webkitgradientcontainer":27}],12:[function(e,n){function f(e){o.apply(this,arguments),this.type=o.TYPES.LINEAR;var n=f.REGEXP_DIRECTION.test(e.args[0])||!o.REGEXP_COLORSTOP.test(e.args[0]);n?e.args[0].split(/\s+/).reverse().forEach(function(e,n){switch(e){case"left":this.x0=0,this.x1=1;break;case"top":this.y0=0,this.y1=1;break;case"right":this.x0=1,this.x1=0;break;case"bottom":this.y0=1,this.y1=0;break;case"to":var f=this.y0,o=this.x0;this.y0=this.y1,this.x0=this.x1,this.x1=o,this.y1=f;break;case"center":break;default:var d=.01*parseFloat(e,10);if(isNaN(d))break;0===n?(this.y0=d,this.y1=1-this.y0):(this.x0=d,this.x1=1-this.x0)}},this):(this.y0=0,this.y1=1),this.colorStops=e.args.slice(n?1:0).map(function(e){var n=e.match(o.REGEXP_COLORSTOP),f=+n[2],i=0===f?"%":n[3];return{color:new d(n[1]),stop:"%"===i?f/100:null}}),null===this.colorStops[0].stop&&(this.colorStops[0].stop=0),null===this.colorStops[this.colorStops.length-1].stop&&(this.colorStops[this.colorStops.length-1].stop=1),this.colorStops.forEach(function(e,n){null===e.stop&&this.colorStops.slice(n).some(function(f,o){return null!==f.stop?(e.stop=(f.stop-this.colorStops[n-1].stop)/(o+1)+this.colorStops[n-1].stop,!0):!1},this)},this)}var o=e("./gradientcontainer"),d=e("./color");f.prototype=Object.create(o.prototype),f.REGEXP_DIRECTION=/^\s*(?:to|left|right|top|bottom|center|\d{1,3}(?:\.\d+)?%?)(?:\s|$)/i,n.exports=f},{"./color":3,"./gradientcontainer":9}],13:[function(e,n){var f=function(){f.options.logging&&window.console&&window.console.log&&Function.prototype.bind.call(window.console.log,window.console).apply(window.console,[Date.now()-f.options.start+"ms","html2canvas:"].concat([].slice.call(arguments,0)))};f.options={logging:!1},n.exports=f},{}],14:[function(e,n){function f(e,n){this.node=e,this.parent=n,this.stack=null,this.bounds=null,this.borders=null,this.clip=[],this.backgroundClip=[],this.offsetBounds=null,this.visible=null,this.computedStyles=null,this.colors={},this.styles={},this.backgroundImages=null,this.transformData=null,this.transformMatrix=null,this.isPseudoElement=!1,this.opacity=null}function o(e){var n=e.options[e.selectedIndex||0];return n?n.text||"":""}function d(e){if(e&&"matrix"===e[1])return e[2].split(",").map(function(e){return parseFloat(e.trim())});if(e&&"matrix3d"===e[1]){var n=e[2].split(",").map(function(e){return parseFloat(e.trim())});return[n[0],n[1],n[4],n[5],n[12],n[13]]}}function i(e){return-1!==e.toString().indexOf("%")}function t(e){return e.replace("px","")}function l(e){return parseFloat(e)}var s=e("./color"),u=e("./utils"),a=u.getBounds,p=u.parseBackgrounds,c=u.offsetBounds;f.prototype.cloneTo=function(e){e.visible=this.visible,e.borders=this.borders,e.bounds=this.bounds,e.clip=this.clip,e.backgroundClip=this.backgroundClip,e.computedStyles=this.computedStyles,e.styles=this.styles,e.backgroundImages=this.backgroundImages,e.opacity=this.opacity},f.prototype.getOpacity=function(){return null===this.opacity?this.opacity=this.cssFloat("opacity"):this.opacity},f.prototype.assignStack=function(e){this.stack=e,e.children.push(this)},f.prototype.isElementVisible=function(){return this.node.nodeType===Node.TEXT_NODE?this.parent.visible:"none"!==this.css("display")&&"hidden"!==this.css("visibility")&&!this.node.hasAttribute("data-html2canvas-ignore")&&("INPUT"!==this.node.nodeName||"hidden"!==this.node.getAttribute("type"))},f.prototype.css=function(e){return this.computedStyles||(this.computedStyles=this.isPseudoElement?this.parent.computedStyle(this.before?":before":":after"):this.computedStyle(null)),this.styles[e]||(this.styles[e]=this.computedStyles[e])},f.prototype.prefixedCss=function(e){var n=["webkit","moz","ms","o"],f=this.css(e);return void 0===f&&n.some(function(n){return f=this.css(n+e.substr(0,1).toUpperCase()+e.substr(1)),void 0!==f},this),void 0===f?null:f},f.prototype.computedStyle=function(e){return this.node.ownerDocument.defaultView.getComputedStyle(this.node,e)},f.prototype.cssInt=function(e){var n=parseInt(this.css(e),10);return isNaN(n)?0:n},f.prototype.color=function(e){return this.colors[e]||(this.colors[e]=new s(this.css(e)))},f.prototype.cssFloat=function(e){var n=parseFloat(this.css(e));return isNaN(n)?0:n},f.prototype.fontWeight=function(){var e=this.css("fontWeight");switch(parseInt(e,10)){case 401:e="bold";break;case 400:e="normal"}return e},f.prototype.parseClip=function(){var e=this.css("clip").match(this.CLIP);return e?{top:parseInt(e[1],10),right:parseInt(e[2],10),bottom:parseInt(e[3],10),left:parseInt(e[4],10)}:null},f.prototype.parseBackgroundImages=function(){return this.backgroundImages||(this.backgroundImages=p(this.css("backgroundImage")))},f.prototype.cssList=function(e,n){var f=(this.css(e)||"").split(",");return f=f[n||0]||f[0]||"auto",f=f.trim().split(" "),1===f.length&&(f=[f[0],i(f[0])?"auto":f[0]]),f},f.prototype.parseBackgroundSize=function(e,n,f){var o,d,t=this.cssList("backgroundSize",f);if(i(t[0]))o=e.width*parseFloat(t[0])/100;else{if(/contain|cover/.test(t[0])){var l=e.width/e.height,s=n.width/n.height;return s>l^"contain"===t[0]?{width:e.height*s,height:e.height}:{width:e.width,height:e.width/s}}o=parseInt(t[0],10)}return d="auto"===t[0]&&"auto"===t[1]?n.height:"auto"===t[1]?o/n.width*n.height:i(t[1])?e.height*parseFloat(t[1])/100:parseInt(t[1],10),"auto"===t[0]&&(o=d/n.height*n.width),{width:o,height:d}},f.prototype.parseBackgroundPosition=function(e,n,f,o){var d,t,l=this.cssList("backgroundPosition",f);return d=i(l[0])?(e.width-(o||n).width)*(parseFloat(l[0])/100):parseInt(l[0],10),t="auto"===l[1]?d/n.width*n.height:i(l[1])?(e.height-(o||n).height)*parseFloat(l[1])/100:parseInt(l[1],10),"auto"===l[0]&&(d=t/n.height*n.width),{left:d,top:t}},f.prototype.parseBackgroundRepeat=function(e){return this.cssList("backgroundRepeat",e)[0]},f.prototype.parseTextShadows=function(){var e=this.css("textShadow"),n=[];if(e&&"none"!==e)for(var f=e.match(this.TEXT_SHADOW_PROPERTY),o=0;f&&o<f.length;o++){var d=f[o].match(this.TEXT_SHADOW_VALUES);n.push({color:new s(d[0]),offsetX:d[1]?parseFloat(d[1].replace("px","")):0,offsetY:d[2]?parseFloat(d[2].replace("px","")):0,blur:d[3]?d[3].replace("px",""):0})}return n},f.prototype.parseTransform=function(){if(!this.transformData)if(this.hasTransform()){var e=this.parseBounds(),n=this.prefixedCss("transformOrigin").split(" ").map(t).map(l);n[0]+=e.left,n[1]+=e.top,this.transformData={origin:n,matrix:this.parseTransformMatrix()}}else this.transformData={origin:[0,0],matrix:[1,0,0,1,0,0]};return this.transformData},f.prototype.parseTransformMatrix=function(){if(!this.transformMatrix){var e=this.prefixedCss("transform"),n=e?d(e.match(this.MATRIX_PROPERTY)):null;this.transformMatrix=n?n:[1,0,0,1,0,0]}return this.transformMatrix},f.prototype.parseBounds=function(){return this.bounds||(this.bounds=this.hasTransform()?c(this.node):a(this.node))},f.prototype.hasTransform=function(){return"1,0,0,1,0,0"!==this.parseTransformMatrix().join(",")||this.parent&&this.parent.hasTransform()},f.prototype.getValue=function(){var e=this.node.value||"";return"SELECT"===this.node.tagName?e=o(this.node):"password"===this.node.type&&(e=Array(e.length+1).join("•")),0===e.length?this.node.placeholder||"":e},f.prototype.MATRIX_PROPERTY=/(matrix|matrix3d)\((.+)\)/,f.prototype.TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g,f.prototype.TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g,f.prototype.CLIP=/^rect\((\d+)px,? (\d+)px,? (\d+)px,? (\d+)px\)$/,n.exports=f},{"./color":3,"./utils":26}],15:[function(e,n){function f(e,n,f,o,d){N("Starting NodeParser"),this.renderer=n,this.options=d,this.range=null,this.support=f,this.renderQueue=[],this.stack=new U(!0,1,e.ownerDocument,null);var i=new P(e,null);if(d.background&&n.rectangle(0,0,n.width,n.height,new T(d.background)),e===e.ownerDocument.documentElement){var t=new P(i.color("backgroundColor").isTransparent()?e.ownerDocument.body:e.ownerDocument.documentElement,null);n.rectangle(0,0,n.width,n.height,t.color("backgroundColor"))}i.visibile=i.isElementVisible(),this.createPseudoHideStyles(e.ownerDocument),this.disableAnimations(e.ownerDocument),this.nodes=I([i].concat(this.getChildren(i)).filter(function(e){return e.visible=e.isElementVisible()}).map(this.getPseudoElements,this)),this.fontMetrics=new S,N("Fetched nodes, total:",this.nodes.length),N("Calculate overflow clips"),this.calculateOverflowClips(),N("Start fetching images"),this.images=o.fetch(this.nodes.filter(A)),this.ready=this.images.ready.then(W(function(){return N("Images loaded, starting parsing"),N("Creating stacking contexts"),this.createStackingContexts(),N("Sorting stacking contexts"),this.sortStackingContexts(this.stack),this.parse(this.stack),N("Render queue created with "+this.renderQueue.length+" items"),new Promise(W(function(e){d.async?"function"==typeof d.async?d.async.call(this,this.renderQueue,e):this.renderQueue.length>0?(this.renderIndex=0,this.asyncRenderer(this.renderQueue,e)):e():(this.renderQueue.forEach(this.paint,this),e())},this))},this))}function o(e){return e.parent&&e.parent.clip.length}function d(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function i(){}function t(e,n,f,o){return e.map(function(d,i){if(d.width>0){var t=n.left,l=n.top,s=n.width,u=n.height-e[2].width;switch(i){case 0:u=e[0].width,d.args=a({c1:[t,l],c2:[t+s,l],c3:[t+s-e[1].width,l+u],c4:[t+e[3].width,l+u]},o[0],o[1],f.topLeftOuter,f.topLeftInner,f.topRightOuter,f.topRightInner);break;case 1:t=n.left+n.width-e[1].width,s=e[1].width,d.args=a({c1:[t+s,l],c2:[t+s,l+u+e[2].width],c3:[t,l+u],c4:[t,l+e[0].width]},o[1],o[2],f.topRightOuter,f.topRightInner,f.bottomRightOuter,f.bottomRightInner);break;case 2:l=l+n.height-e[2].width,u=e[2].width,d.args=a({c1:[t+s,l+u],c2:[t,l+u],c3:[t+e[3].width,l],c4:[t+s-e[3].width,l]},o[2],o[3],f.bottomRightOuter,f.bottomRightInner,f.bottomLeftOuter,f.bottomLeftInner);break;case 3:s=e[3].width,d.args=a({c1:[t,l+u+e[2].width],c2:[t,l],c3:[t+s,l+e[0].width],c4:[t+s,l+u]},o[3],o[0],f.bottomLeftOuter,f.bottomLeftInner,f.topLeftOuter,f.topLeftInner)}}return d})}function l(e,n,f,o){var d=4*((Math.sqrt(2)-1)/3),i=f*d,t=o*d,l=e+f,s=n+o;return{topLeft:u({x:e,y:s},{x:e,y:s-t},{x:l-i,y:n},{x:l,y:n}),topRight:u({x:e,y:n},{x:e+i,y:n},{x:l,y:s-t},{x:l,y:s}),bottomRight:u({x:l,y:n},{x:l,y:n+t},{x:e+i,y:s},{x:e,y:s}),bottomLeft:u({x:l,y:s},{x:l-i,y:s},{x:e,y:n+t},{x:e,y:n})}}function s(e,n,f){var o=e.left,d=e.top,i=e.width,t=e.height,s=n[0][0]<i/2?n[0][0]:i/2,u=n[0][1]<t/2?n[0][1]:t/2,a=n[1][0]<i/2?n[1][0]:i/2,p=n[1][1]<t/2?n[1][1]:t/2,c=n[2][0]<i/2?n[2][0]:i/2,y=n[2][1]<t/2?n[2][1]:t/2,m=n[3][0]<i/2?n[3][0]:i/2,r=n[3][1]<t/2?n[3][1]:t/2,v=i-a,w=t-y,b=i-c,g=t-r;return{topLeftOuter:l(o,d,s,u).topLeft.subdivide(.5),topLeftInner:l(o+f[3].width,d+f[0].width,Math.max(0,s-f[3].width),Math.max(0,u-f[0].width)).topLeft.subdivide(.5),topRightOuter:l(o+v,d,a,p).topRight.subdivide(.5),topRightInner:l(o+Math.min(v,i+f[3].width),d+f[0].width,v>i+f[3].width?0:a-f[3].width,p-f[0].width).topRight.subdivide(.5),bottomRightOuter:l(o+b,d+w,c,y).bottomRight.subdivide(.5),bottomRightInner:l(o+Math.min(b,i-f[3].width),d+Math.min(w,t+f[0].width),Math.max(0,c-f[1].width),y-f[2].width).bottomRight.subdivide(.5),bottomLeftOuter:l(o,d+g,m,r).bottomLeft.subdivide(.5),bottomLeftInner:l(o+f[3].width,d+g,Math.max(0,m-f[3].width),r-f[2].width).bottomLeft.subdivide(.5)}}function u(e,n,f,o){var d=function(e,n,f){return{x:e.x+(n.x-e.x)*f,y:e.y+(n.y-e.y)*f}};return{start:e,startControl:n,endControl:f,end:o,subdivide:function(i){var t=d(e,n,i),l=d(n,f,i),s=d(f,o,i),a=d(t,l,i),p=d(l,s,i),c=d(a,p,i);return[u(e,t,a,c),u(c,p,s,o)]},curveTo:function(e){e.push(["bezierCurve",n.x,n.y,f.x,f.y,o.x,o.y])},curveToReversed:function(o){o.push(["bezierCurve",f.x,f.y,n.x,n.y,e.x,e.y])}}}function a(e,n,f,o,d,i,t){var l=[];return n[0]>0||n[1]>0?(l.push(["line",o[1].start.x,o[1].start.y]),o[1].curveTo(l)):l.push(["line",e.c1[0],e.c1[1]]),f[0]>0||f[1]>0?(l.push(["line",i[0].start.x,i[0].start.y]),i[0].curveTo(l),l.push(["line",t[0].end.x,t[0].end.y]),t[0].curveToReversed(l)):(l.push(["line",e.c2[0],e.c2[1]]),l.push(["line",e.c3[0],e.c3[1]])),n[0]>0||n[1]>0?(l.push(["line",d[1].end.x,d[1].end.y]),d[1].curveToReversed(l)):l.push(["line",e.c4[0],e.c4[1]]),l}function p(e,n,f,o,d,i,t){n[0]>0||n[1]>0?(e.push(["line",o[0].start.x,o[0].start.y]),o[0].curveTo(e),o[1].curveTo(e)):e.push(["line",i,t]),(f[0]>0||f[1]>0)&&e.push(["line",d[0].start.x,d[0].start.y])}function c(e){return e.cssInt("zIndex")<0}function y(e){return e.cssInt("zIndex")>0}function m(e){return 0===e.cssInt("zIndex")}function r(e){return-1!==["inline","inline-block","inline-table"].indexOf(e.css("display"))}function v(e){return e instanceof U}function w(e){return e.node.data.trim().length>0}function b(e){return/^(normal|none|0px)$/.test(e.parent.css("letterSpacing"))}function g(e){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(n){var f=e.css("border"+n+"Radius"),o=f.split(" ");return o.length<=1&&(o[1]=o[0]),o.map(F)})}function h(e){return e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE}function x(e){var n=e.css("position"),f=-1!==["absolute","relative","fixed"].indexOf(n)?e.css("zIndex"):"auto";return"auto"!==f}function j(e){return"static"!==e.css("position")}function k(e){return"none"!==e.css("float")}function q(e){return-1!==["inline-block","inline-table"].indexOf(e.css("display"))}function z(e){var n=this;return function(){return!e.apply(n,arguments)}}function A(e){return e.node.nodeType===Node.ELEMENT_NODE}function B(e){return e.isPseudoElement===!0}function C(e){return e.node.nodeType===Node.TEXT_NODE}function D(e){return function(n,f){return n.cssInt("zIndex")+e.indexOf(n)/e.length-(f.cssInt("zIndex")+e.indexOf(f)/e.length)}}function E(e){return e.getOpacity()<1}function F(e){return parseInt(e,10)}function G(e){return e.width}function H(e){return e.node.nodeType!==Node.ELEMENT_NODE||-1===["SCRIPT","HEAD","TITLE","OBJECT","BR","OPTION"].indexOf(e.node.nodeName)}function I(e){return[].concat.apply([],e)}function J(e){var n=e.substr(0,1);return n===e.substr(e.length-1)&&n.match(/'|"/)?e.substr(1,e.length-2):e}function K(e){for(var n,f=[],o=0,d=!1;e.length;)L(e[o])===d?(n=e.splice(0,o),n.length&&f.push(O.ucs2.encode(n)),d=!d,o=0):o++,o>=e.length&&(n=e.splice(0,o),n.length&&f.push(O.ucs2.encode(n)));return f}function L(e){return-1!==[32,13,10,9,45].indexOf(e)}function M(e){return/[^\u0000-\u00ff]/.test(e)}var N=e("./log"),O=e("punycode"),P=e("./nodecontainer"),Q=e("./textcontainer"),R=e("./pseudoelementcontainer"),S=e("./fontmetrics"),T=e("./color"),U=e("./stackingcontext"),V=e("./utils"),W=V.bind,X=V.getBounds,Y=V.parseBackgrounds,Z=V.offsetBounds;f.prototype.calculateOverflowClips=function(){this.nodes.forEach(function(e){if(A(e)){B(e)&&e.appendToDOM(),e.borders=this.parseBorders(e);var n="hidden"===e.css("overflow")?[e.borders.clip]:[],f=e.parseClip();f&&-1!==["absolute","fixed"].indexOf(e.css("position"))&&n.push([["rect",e.bounds.left+f.left,e.bounds.top+f.top,f.right-f.left,f.bottom-f.top]]),e.clip=o(e)?e.parent.clip.concat(n):n,e.backgroundClip="hidden"!==e.css("overflow")?e.clip.concat([e.borders.clip]):e.clip,B(e)&&e.cleanDOM()}else C(e)&&(e.clip=o(e)?e.parent.clip:[]);B(e)||(e.bounds=null)},this)},f.prototype.asyncRenderer=function(e,n,f){f=f||Date.now(),this.paint(e[this.renderIndex++]),e.length===this.renderIndex?n():f+20>Date.now()?this.asyncRenderer(e,n,f):setTimeout(W(function(){this.asyncRenderer(e,n)},this),0)},f.prototype.createPseudoHideStyles=function(e){this.createStyles(e,"."+R.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+':before { content: "" !important; display: none !important; }.'+R.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER+':after { content: "" !important; display: none !important; }')},f.prototype.disableAnimations=function(e){this.createStyles(e,"* { -webkit-animation: none !important; -moz-animation: none !important; -o-animation: none !important; animation: none !important; -webkit-transition: none !important; -moz-transition: none !important; -o-transition: none !important; transition: none !important;}");
},f.prototype.createStyles=function(e,n){var f=e.createElement("style");f.innerHTML=n,e.body.appendChild(f)},f.prototype.getPseudoElements=function(e){var n=[[e]];if(e.node.nodeType===Node.ELEMENT_NODE){var f=this.getPseudoElement(e,":before"),o=this.getPseudoElement(e,":after");f&&n.push(f),o&&n.push(o)}return I(n)},f.prototype.getPseudoElement=function(e,n){var f=e.computedStyle(n);if(!f||!f.content||"none"===f.content||"-moz-alt-content"===f.content||"none"===f.display)return null;for(var o=J(f.content),i="url"===o.substr(0,3),t=document.createElement(i?"img":"html2canvaspseudoelement"),l=new R(t,e,n),s=f.length-1;s>=0;s--){var u=d(f.item(s));t.style[u]=f[u]}if(t.className=R.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+" "+R.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER,i)return t.src=Y(o)[0].args[0],[l];var a=document.createTextNode(o);return t.appendChild(a),[l,new Q(a,l)]},f.prototype.getChildren=function(e){return I([].filter.call(e.node.childNodes,h).map(function(n){var f=[n.nodeType===Node.TEXT_NODE?new Q(n,e):new P(n,e)].filter(H);return n.nodeType===Node.ELEMENT_NODE&&f.length&&"TEXTAREA"!==n.tagName?f[0].isElementVisible()?f.concat(this.getChildren(f[0])):[]:f},this))},f.prototype.newStackingContext=function(e,n){var f=new U(n,e.getOpacity(),e.node,e.parent);e.cloneTo(f);var o=n?f.getParentStack(this):f.parent.stack;o.contexts.push(f),e.stack=f},f.prototype.createStackingContexts=function(){this.nodes.forEach(function(e){A(e)&&(this.isRootElement(e)||E(e)||x(e)||this.isBodyWithTransparentRoot(e)||e.hasTransform())?this.newStackingContext(e,!0):A(e)&&(j(e)&&m(e)||q(e)||k(e))?this.newStackingContext(e,!1):e.assignStack(e.parent.stack)},this)},f.prototype.isBodyWithTransparentRoot=function(e){return"BODY"===e.node.nodeName&&e.parent.color("backgroundColor").isTransparent()},f.prototype.isRootElement=function(e){return null===e.parent},f.prototype.sortStackingContexts=function(e){e.contexts.sort(D(e.contexts.slice(0))),e.contexts.forEach(this.sortStackingContexts,this)},f.prototype.parseTextBounds=function(e){return function(n,f,o){if("none"!==e.parent.css("textDecoration").substr(0,4)||0!==n.trim().length){if(this.support.rangeBounds&&!e.parent.hasTransform()){var d=o.slice(0,f).join("").length;return this.getRangeBounds(e.node,d,n.length)}if(e.node&&"string"==typeof e.node.data){var i=e.node.splitText(n.length),t=this.getWrapperBounds(e.node,e.parent.hasTransform());return e.node=i,t}}else(!this.support.rangeBounds||e.parent.hasTransform())&&(e.node=e.node.splitText(n.length));return{}}},f.prototype.getWrapperBounds=function(e,n){var f=e.ownerDocument.createElement("html2canvaswrapper"),o=e.parentNode,d=e.cloneNode(!0);f.appendChild(e.cloneNode(!0)),o.replaceChild(f,e);var i=n?Z(f):X(f);return o.replaceChild(d,f),i},f.prototype.getRangeBounds=function(e,n,f){var o=this.range||(this.range=e.ownerDocument.createRange());return o.setStart(e,n),o.setEnd(e,n+f),o.getBoundingClientRect()},f.prototype.parse=function(e){var n=e.contexts.filter(c),f=e.children.filter(A),o=f.filter(z(k)),d=o.filter(z(j)).filter(z(r)),t=f.filter(z(j)).filter(k),l=o.filter(z(j)).filter(r),s=e.contexts.concat(o.filter(j)).filter(m),u=e.children.filter(C).filter(w),a=e.contexts.filter(y);n.concat(d).concat(t).concat(l).concat(s).concat(u).concat(a).forEach(function(e){this.renderQueue.push(e),v(e)&&(this.parse(e),this.renderQueue.push(new i))},this)},f.prototype.paint=function(e){try{e instanceof i?this.renderer.ctx.restore():C(e)?(B(e.parent)&&e.parent.appendToDOM(),this.paintText(e),B(e.parent)&&e.parent.cleanDOM()):this.paintNode(e)}catch(n){if(N(n),this.options.strict)throw n}},f.prototype.paintNode=function(e){v(e)&&(this.renderer.setOpacity(e.opacity),this.renderer.ctx.save(),e.hasTransform()&&this.renderer.setTransform(e.parseTransform())),"INPUT"===e.node.nodeName&&"checkbox"===e.node.type?this.paintCheckbox(e):"INPUT"===e.node.nodeName&&"radio"===e.node.type?this.paintRadio(e):this.paintElement(e)},f.prototype.paintElement=function(e){var n=e.parseBounds();this.renderer.clip(e.backgroundClip,function(){this.renderer.renderBackground(e,n,e.borders.borders.map(G))},this),this.renderer.clip(e.clip,function(){this.renderer.renderBorders(e.borders.borders)},this),this.renderer.clip(e.backgroundClip,function(){switch(e.node.nodeName){case"svg":case"IFRAME":var f=this.images.get(e.node);f?this.renderer.renderImage(e,n,e.borders,f):N("Error loading <"+e.node.nodeName+">",e.node);break;case"IMG":var o=this.images.get(e.node.src);o?this.renderer.renderImage(e,n,e.borders,o):N("Error loading <img>",e.node.src);break;case"CANVAS":this.renderer.renderImage(e,n,e.borders,{image:e.node});break;case"SELECT":case"INPUT":case"TEXTAREA":this.paintFormValue(e)}},this)},f.prototype.paintCheckbox=function(e){var n=e.parseBounds(),f=Math.min(n.width,n.height),o={width:f-1,height:f-1,top:n.top,left:n.left},d=[3,3],i=[d,d,d,d],l=[1,1,1,1].map(function(e){return{color:new T("#A5A5A5"),width:e}}),u=s(o,i,l);this.renderer.clip(e.backgroundClip,function(){this.renderer.rectangle(o.left+1,o.top+1,o.width-2,o.height-2,new T("#DEDEDE")),this.renderer.renderBorders(t(l,o,u,i)),e.node.checked&&(this.renderer.font(new T("#424242"),"normal","normal","bold",f-3+"px","arial"),this.renderer.text("✔",o.left+f/6,o.top+f-1))},this)},f.prototype.paintRadio=function(e){var n=e.parseBounds(),f=Math.min(n.width,n.height)-2;this.renderer.clip(e.backgroundClip,function(){this.renderer.circleStroke(n.left+1,n.top+1,f,new T("#DEDEDE"),1,new T("#A5A5A5")),e.node.checked&&this.renderer.circle(Math.ceil(n.left+f/4)+1,Math.ceil(n.top+f/4)+1,Math.floor(f/2),new T("#424242"))},this)},f.prototype.paintFormValue=function(e){var n=e.getValue();if(n.length>0){var f=e.node.ownerDocument,o=f.createElement("html2canvaswrapper"),d=["lineHeight","textAlign","fontFamily","fontWeight","fontSize","color","paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","borderLeftStyle","borderTopStyle","borderLeftWidth","borderTopWidth","boxSizing","whiteSpace","wordWrap"];d.forEach(function(n){try{o.style[n]=e.css(n)}catch(f){N("html2canvas: Parse: Exception caught in renderFormValue: "+f.message)}});var i=e.parseBounds();o.style.position="fixed",o.style.left=i.left+"px",o.style.top=i.top+"px",o.textContent=n,f.body.appendChild(o),this.paintText(new Q(o.firstChild,e)),f.body.removeChild(o)}},f.prototype.paintText=function(e){e.applyTextTransform();var n=O.ucs2.decode(e.node.data),f=this.options.letterRendering&&!b(e)||M(e.node.data)?n.map(function(e){return O.ucs2.encode([e])}):K(n),o=e.parent.fontWeight(),d=e.parent.css("fontSize"),i=e.parent.css("fontFamily"),t=e.parent.parseTextShadows();this.renderer.font(e.parent.color("color"),e.parent.css("fontStyle"),e.parent.css("fontVariant"),o,d,i),t.length?this.renderer.fontShadow(t[0].color,t[0].offsetX,t[0].offsetY,t[0].blur):this.renderer.clearShadow(),this.renderer.clip(e.parent.clip,function(){f.map(this.parseTextBounds(e),this).forEach(function(n,o){n&&(this.renderer.text(f[o],n.left,n.bottom),this.renderTextDecoration(e.parent,n,this.fontMetrics.getMetrics(i,d)))},this)},this)},f.prototype.renderTextDecoration=function(e,n,f){switch(e.css("textDecoration").split(" ")[0]){case"underline":this.renderer.rectangle(n.left,Math.round(n.top+f.baseline+f.lineWidth),n.width,1,e.color("color"));break;case"overline":this.renderer.rectangle(n.left,Math.round(n.top),n.width,1,e.color("color"));break;case"line-through":this.renderer.rectangle(n.left,Math.ceil(n.top+f.middle+f.lineWidth),n.width,1,e.color("color"))}};var $={inset:[["darken",.6],["darken",.1],["darken",.1],["darken",.6]]};f.prototype.parseBorders=function(e){var n=e.parseBounds(),f=g(e),o=["Top","Right","Bottom","Left"].map(function(n,f){var o=e.css("border"+n+"Style"),d=e.color("border"+n+"Color");"inset"===o&&d.isBlack()&&(d=new T([255,255,255,d.a]));var i=$[o]?$[o][f]:null;return{width:e.cssInt("border"+n+"Width"),color:i?d[i[0]](i[1]):d,args:null}}),d=s(n,f,o);return{clip:this.parseBackgroundClip(e,d,o,f,n),borders:t(o,n,d,f)}},f.prototype.parseBackgroundClip=function(e,n,f,o,d){var i=e.css("backgroundClip"),t=[];switch(i){case"content-box":case"padding-box":p(t,o[0],o[1],n.topLeftInner,n.topRightInner,d.left+f[3].width,d.top+f[0].width),p(t,o[1],o[2],n.topRightInner,n.bottomRightInner,d.left+d.width-f[1].width,d.top+f[0].width),p(t,o[2],o[3],n.bottomRightInner,n.bottomLeftInner,d.left+d.width-f[1].width,d.top+d.height-f[2].width),p(t,o[3],o[0],n.bottomLeftInner,n.topLeftInner,d.left+f[3].width,d.top+d.height-f[2].width);break;default:p(t,o[0],o[1],n.topLeftOuter,n.topRightOuter,d.left,d.top),p(t,o[1],o[2],n.topRightOuter,n.bottomRightOuter,d.left+d.width,d.top),p(t,o[2],o[3],n.bottomRightOuter,n.bottomLeftOuter,d.left+d.width,d.top+d.height),p(t,o[3],o[0],n.bottomLeftOuter,n.topLeftOuter,d.left,d.top+d.height)}return t},n.exports=f},{"./color":3,"./fontmetrics":7,"./log":13,"./nodecontainer":14,"./pseudoelementcontainer":18,"./stackingcontext":21,"./textcontainer":25,"./utils":26,punycode:1}],16:[function(e,n,f){function o(e,n,f){var o="withCredentials"in new XMLHttpRequest;if(!n)return Promise.reject("No proxy configured");var d=t(o),s=l(n,e,d);return o?a(s):i(f,s,d).then(function(e){return m(e.content)})}function d(e,n,f){var o="crossOrigin"in new Image,d=t(o),s=l(n,e,d);return o?Promise.resolve(s):i(f,s,d).then(function(e){return"data:"+e.type+";base64,"+e.content})}function i(e,n,f){return new Promise(function(o,d){var i=e.createElement("script"),t=function(){delete window.html2canvas.proxy[f],e.body.removeChild(i)};window.html2canvas.proxy[f]=function(e){t(),o(e)},i.src=n,i.onerror=function(e){t(),d(e)},e.body.appendChild(i)})}function t(e){return e?"":"html2canvas_"+Date.now()+"_"+ ++r+"_"+Math.round(1e5*Math.random())}function l(e,n,f){return e+"?url="+encodeURIComponent(n)+(f.length?"&callback=html2canvas.proxy."+f:"")}function s(e){return function(n){var f,o=new DOMParser;try{f=o.parseFromString(n,"text/html")}catch(d){c("DOMParser not supported, falling back to createHTMLDocument"),f=document.implementation.createHTMLDocument("");try{f.open(),f.write(n),f.close()}catch(i){c("createHTMLDocument write not supported, falling back to document.body.innerHTML"),f.body.innerHTML=n}}var t=f.querySelector("base");if(!t||!t.href.host){var l=f.createElement("base");l.href=e,f.head.insertBefore(l,f.head.firstChild)}return f}}function u(e,n,f,d,i,t){return new o(e,n,window.document).then(s(e)).then(function(e){return y(e,f,d,i,t,0,0)})}var a=e("./xhr"),p=e("./utils"),c=e("./log"),y=e("./clone"),m=p.decode64,r=0;f.Proxy=o,f.ProxyURL=d,f.loadUrlDocument=u},{"./clone":2,"./log":13,"./utils":26,"./xhr":28}],17:[function(e,n){function f(e,n){var f=document.createElement("a");f.href=e,e=f.href,this.src=e,this.image=new Image;var d=this;this.promise=new Promise(function(f,i){d.image.crossOrigin="Anonymous",d.image.onload=f,d.image.onerror=i,new o(e,n,document).then(function(e){d.image.src=e})["catch"](i)})}var o=e("./proxy").ProxyURL;n.exports=f},{"./proxy":16}],18:[function(e,n){function f(e,n,f){o.call(this,e,n),this.isPseudoElement=!0,this.before=":before"===f}var o=e("./nodecontainer");f.prototype.cloneTo=function(e){f.prototype.cloneTo.call(this,e),e.isPseudoElement=!0,e.before=this.before},f.prototype=Object.create(o.prototype),f.prototype.appendToDOM=function(){this.before?this.parent.node.insertBefore(this.node,this.parent.node.firstChild):this.parent.node.appendChild(this.node),this.parent.node.className+=" "+this.getHideClass()},f.prototype.cleanDOM=function(){this.node.parentNode.removeChild(this.node),this.parent.node.className=this.parent.node.className.replace(this.getHideClass(),"")},f.prototype.getHideClass=function(){return this["PSEUDO_HIDE_ELEMENT_CLASS_"+(this.before?"BEFORE":"AFTER")]},f.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE="___html2canvas___pseudoelement_before",f.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER="___html2canvas___pseudoelement_after",n.exports=f},{"./nodecontainer":14}],19:[function(e,n){function f(e,n,f,o,d){this.width=e,this.height=n,this.images=f,this.options=o,this.document=d}var o=e("./log");f.prototype.renderImage=function(e,n,f,o){var d=e.cssInt("paddingLeft"),i=e.cssInt("paddingTop"),t=e.cssInt("paddingRight"),l=e.cssInt("paddingBottom"),s=f.borders,u=n.width-(s[1].width+s[3].width+d+t),a=n.height-(s[0].width+s[2].width+i+l);this.drawImage(o,0,0,o.image.width||u,o.image.height||a,n.left+d+s[3].width,n.top+i+s[0].width,u,a)},f.prototype.renderBackground=function(e,n,f){n.height>0&&n.width>0&&(this.renderBackgroundColor(e,n),this.renderBackgroundImage(e,n,f))},f.prototype.renderBackgroundColor=function(e,n){var f=e.color("backgroundColor");f.isTransparent()||this.rectangle(n.left,n.top,n.width,n.height,f)},f.prototype.renderBorders=function(e){e.forEach(this.renderBorder,this)},f.prototype.renderBorder=function(e){e.color.isTransparent()||null===e.args||this.drawShape(e.args,e.color)},f.prototype.renderBackgroundImage=function(e,n,f){var d=e.parseBackgroundImages();d.reverse().forEach(function(d,i,t){switch(d.method){case"url":var l=this.images.get(d.args[0]);l?this.renderBackgroundRepeating(e,n,l,t.length-(i+1),f):o("Error loading background-image",d.args[0]);break;case"linear-gradient":case"gradient":var s=this.images.get(d.value);s?this.renderBackgroundGradient(s,n,f):o("Error loading background-image",d.args[0]);break;case"none":break;default:o("Unknown background-image type",d.args[0])}},this)},f.prototype.renderBackgroundRepeating=function(e,n,f,o,d){var i=e.parseBackgroundSize(n,f.image,o),t=e.parseBackgroundPosition(n,f.image,o,i),l=e.parseBackgroundRepeat(o);switch(l){case"repeat-x":case"repeat no-repeat":this.backgroundRepeatShape(f,t,i,n,n.left+d[3],n.top+t.top+d[0],99999,i.height,d);break;case"repeat-y":case"no-repeat repeat":this.backgroundRepeatShape(f,t,i,n,n.left+t.left+d[3],n.top+d[0],i.width,99999,d);break;case"no-repeat":this.backgroundRepeatShape(f,t,i,n,n.left+t.left+d[3],n.top+t.top+d[0],i.width,i.height,d);break;default:this.renderBackgroundRepeat(f,t,i,{top:n.top,left:n.left},d[3],d[0])}},n.exports=f},{"./log":13}],20:[function(e,n){function f(e,n){d.apply(this,arguments),this.canvas=this.options.canvas||this.document.createElement("canvas"),this.options.canvas||(this.canvas.width=e,this.canvas.height=n),this.ctx=this.canvas.getContext("2d"),this.taintCtx=this.document.createElement("canvas").getContext("2d"),this.ctx.textBaseline="bottom",this.variables={},t("Initialized CanvasRenderer with size",e,"x",n)}function o(e){return e.length>0}var d=e("../renderer"),i=e("../lineargradientcontainer"),t=e("../log");f.prototype=Object.create(d.prototype),f.prototype.setFillStyle=function(e){return this.ctx.fillStyle="object"==typeof e&&e.isColor?e.toString():e,this.ctx},f.prototype.rectangle=function(e,n,f,o,d){this.setFillStyle(d).fillRect(e,n,f,o)},f.prototype.circle=function(e,n,f,o){this.setFillStyle(o),this.ctx.beginPath(),this.ctx.arc(e+f/2,n+f/2,f/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()},f.prototype.circleStroke=function(e,n,f,o,d,i){this.circle(e,n,f,o),this.ctx.strokeStyle=i.toString(),this.ctx.stroke()},f.prototype.drawShape=function(e,n){this.shape(e),this.setFillStyle(n).fill()},f.prototype.taints=function(e){if(null===e.tainted){this.taintCtx.drawImage(e.image,0,0);try{this.taintCtx.getImageData(0,0,1,1),e.tainted=!1}catch(n){this.taintCtx=document.createElement("canvas").getContext("2d"),e.tainted=!0}}return e.tainted},f.prototype.drawImage=function(e,n,f,o,d,i,t,l,s){(!this.taints(e)||this.options.allowTaint)&&this.ctx.drawImage(e.image,n,f,o,d,i,t,l,s)},f.prototype.clip=function(e,n,f){this.ctx.save(),e.filter(o).forEach(function(e){this.shape(e).clip()},this),n.call(f),this.ctx.restore()},f.prototype.shape=function(e){return this.ctx.beginPath(),e.forEach(function(e,n){"rect"===e[0]?this.ctx.rect.apply(this.ctx,e.slice(1)):this.ctx[0===n?"moveTo":e[0]+"To"].apply(this.ctx,e.slice(1))},this),this.ctx.closePath(),this.ctx},f.prototype.font=function(e,n,f,o,d,i){this.setFillStyle(e).font=[n,f,o,d,i].join(" ").split(",")[0]},f.prototype.fontShadow=function(e,n,f,o){this.setVariable("shadowColor",e.toString()).setVariable("shadowOffsetY",n).setVariable("shadowOffsetX",f).setVariable("shadowBlur",o)},f.prototype.clearShadow=function(){this.setVariable("shadowColor","rgba(0,0,0,0)")},f.prototype.setOpacity=function(e){this.ctx.globalAlpha=e},f.prototype.setTransform=function(e){this.ctx.translate(e.origin[0],e.origin[1]),this.ctx.transform.apply(this.ctx,e.matrix),this.ctx.translate(-e.origin[0],-e.origin[1])},f.prototype.setVariable=function(e,n){return this.variables[e]!==n&&(this.variables[e]=this.ctx[e]=n),this},f.prototype.text=function(e,n,f){this.ctx.fillText(e,n,f)},f.prototype.backgroundRepeatShape=function(e,n,f,o,d,i,t,l,s){var u=[["line",Math.round(d),Math.round(i)],["line",Math.round(d+t),Math.round(i)],["line",Math.round(d+t),Math.round(l+i)],["line",Math.round(d),Math.round(l+i)]];this.clip([u],function(){this.renderBackgroundRepeat(e,n,f,o,s[3],s[0])},this)},f.prototype.renderBackgroundRepeat=function(e,n,f,o,d,i){var t=Math.round(o.left+n.left+d),l=Math.round(o.top+n.top+i);this.setFillStyle(this.ctx.createPattern(this.resizeImage(e,f),"repeat")),this.ctx.translate(t,l),this.ctx.fill(),this.ctx.translate(-t,-l)},f.prototype.renderBackgroundGradient=function(e,n){if(e instanceof i){var f=this.ctx.createLinearGradient(n.left+n.width*e.x0,n.top+n.height*e.y0,n.left+n.width*e.x1,n.top+n.height*e.y1);e.colorStops.forEach(function(e){f.addColorStop(e.stop,e.color.toString())}),this.rectangle(n.left,n.top,n.width,n.height,f)}},f.prototype.resizeImage=function(e,n){var f=e.image;if(f.width===n.width&&f.height===n.height)return f;var o,d=document.createElement("canvas");return d.width=n.width,d.height=n.height,o=d.getContext("2d"),o.drawImage(f,0,0,f.width,f.height,0,0,n.width,n.height),d},n.exports=f},{"../lineargradientcontainer":12,"../log":13,"../renderer":19}],21:[function(e,n){function f(e,n,f,d){o.call(this,f,d),this.ownStacking=e,this.contexts=[],this.children=[],this.opacity=(this.parent?this.parent.stack.opacity:1)*n}var o=e("./nodecontainer");f.prototype=Object.create(o.prototype),f.prototype.getParentStack=function(e){var n=this.parent?this.parent.stack:null;return n?n.ownStacking?n:n.getParentStack(e):e.stack},n.exports=f},{"./nodecontainer":14}],22:[function(e,n){function f(e){this.rangeBounds=this.testRangeBounds(e),this.cors=this.testCORS(),this.svg=this.testSVG()}f.prototype.testRangeBounds=function(e){var n,f,o,d,i=!1;return e.createRange&&(n=e.createRange(),n.getBoundingClientRect&&(f=e.createElement("boundtest"),f.style.height="123px",f.style.display="block",e.body.appendChild(f),n.selectNode(f),o=n.getBoundingClientRect(),d=o.height,123===d&&(i=!0),e.body.removeChild(f))),i},f.prototype.testCORS=function(){return"undefined"!=typeof(new Image).crossOrigin},f.prototype.testSVG=function(){var e=new Image,n=document.createElement("canvas"),f=n.getContext("2d");e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{f.drawImage(e,0,0),n.toDataURL()}catch(o){return!1}return!0},n.exports=f},{}],23:[function(e,n){function f(e){this.src=e,this.image=null;var n=this;this.promise=this.hasFabric().then(function(){return n.isInline(e)?Promise.resolve(n.inlineFormatting(e)):o(e)}).then(function(e){return new Promise(function(f){window.html2canvas.svg.fabric.loadSVGFromString(e,n.createCanvas.call(n,f))})})}var o=e("./xhr"),d=e("./utils").decode64;f.prototype.hasFabric=function(){return window.html2canvas.svg&&window.html2canvas.svg.fabric?Promise.resolve():Promise.reject(new Error("html2canvas.svg.js is not loaded, cannot render svg"))},f.prototype.inlineFormatting=function(e){return/^data:image\/svg\+xml;base64,/.test(e)?this.decode64(this.removeContentType(e)):this.removeContentType(e)},f.prototype.removeContentType=function(e){return e.replace(/^data:image\/svg\+xml(;base64)?,/,"")},f.prototype.isInline=function(e){return/^data:image\/svg\+xml/i.test(e)},f.prototype.createCanvas=function(e){var n=this;return function(f,o){var d=new window.html2canvas.svg.fabric.StaticCanvas("c");n.image=d.lowerCanvasEl,d.setWidth(o.width).setHeight(o.height).add(window.html2canvas.svg.fabric.util.groupSVGElements(f,o)).renderAll(),e(d.lowerCanvasEl)}},f.prototype.decode64=function(e){return"function"==typeof window.atob?window.atob(e):d(e)},n.exports=f},{"./utils":26,"./xhr":28}],24:[function(e,n){function f(e,n){this.src=e,this.image=null;var f=this;this.promise=n?new Promise(function(n,o){f.image=new Image,f.image.onload=n,f.image.onerror=o,f.image.src="data:image/svg+xml,"+(new XMLSerializer).serializeToString(e),f.image.complete===!0&&n(f.image)}):this.hasFabric().then(function(){return new Promise(function(n){window.html2canvas.svg.fabric.parseSVGDocument(e,f.createCanvas.call(f,n))})})}var o=e("./svgcontainer");f.prototype=Object.create(o.prototype),n.exports=f},{"./svgcontainer":23}],25:[function(e,n){function f(e,n){d.call(this,e,n)}function o(e,n,f){return e.length>0?n+f.toUpperCase():void 0}var d=e("./nodecontainer");f.prototype=Object.create(d.prototype),f.prototype.applyTextTransform=function(){this.node.data=this.transform(this.parent.css("textTransform"))},f.prototype.transform=function(e){var n=this.node.data;switch(e){case"lowercase":return n.toLowerCase();case"capitalize":return n.replace(/(^|\s|:|-|\(|\))([a-z])/g,o);case"uppercase":return n.toUpperCase();default:return n}},n.exports=f},{"./nodecontainer":14}],26:[function(e,n,f){f.smallImage=function(){return"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"},f.bind=function(e,n){return function(){return e.apply(n,arguments)}},f.decode64=function(e){var n,f,o,d,i,t,l,s,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=e.length,p="";for(n=0;a>n;n+=4)f=u.indexOf(e[n]),o=u.indexOf(e[n+1]),d=u.indexOf(e[n+2]),i=u.indexOf(e[n+3]),t=f<<2|o>>4,l=(15&o)<<4|d>>2,s=(3&d)<<6|i,p+=64===d?String.fromCharCode(t):64===i||-1===i?String.fromCharCode(t,l):String.fromCharCode(t,l,s);return p},f.getBounds=function(e){if(e.getBoundingClientRect){var n=e.getBoundingClientRect(),f=null==e.offsetWidth?n.width:e.offsetWidth;return{top:n.top,bottom:n.bottom||n.top+n.height,right:n.left+f,left:n.left,width:f,height:null==e.offsetHeight?n.height:e.offsetHeight}}return{}},f.offsetBounds=function(e){var n=e.offsetParent?f.offsetBounds(e.offsetParent):{top:0,left:0};return{top:e.offsetTop+n.top,bottom:e.offsetTop+e.offsetHeight+n.top,right:e.offsetLeft+n.left+e.offsetWidth,left:e.offsetLeft+n.left,width:e.offsetWidth,height:e.offsetHeight}},f.parseBackgrounds=function(e){var n,f,o,d,i,t,l,s=" \r\n	",u=[],a=0,p=0,c=function(){n&&('"'===f.substr(0,1)&&(f=f.substr(1,f.length-2)),f&&l.push(f),"-"===n.substr(0,1)&&(d=n.indexOf("-",1)+1)>0&&(o=n.substr(0,d),n=n.substr(d)),u.push({prefix:o,method:n.toLowerCase(),value:i,args:l,image:null})),l=[],n=o=f=i=""};return l=[],n=o=f=i="",e.split("").forEach(function(e){if(!(0===a&&s.indexOf(e)>-1)){switch(e){case'"':t?t===e&&(t=null):t=e;break;case"(":if(t)break;if(0===a)return a=1,void(i+=e);p++;break;case")":if(t)break;if(1===a){if(0===p)return a=0,i+=e,void c();p--}break;case",":if(t)break;if(0===a)return void c();if(1===a&&0===p&&!n.match(/^url$/i))return l.push(f),f="",void(i+=e)}i+=e,0===a?n+=e:f+=e}}),c(),u}},{}],27:[function(e,n){function f(e){o.apply(this,arguments),this.type="linear"===e.args[0]?o.TYPES.LINEAR:o.TYPES.RADIAL}var o=e("./gradientcontainer");f.prototype=Object.create(o.prototype),n.exports=f},{"./gradientcontainer":9}],28:[function(e,n){function f(e){return new Promise(function(n,f){var o=new XMLHttpRequest;o.open("GET",e),o.onload=function(){200===o.status?n(o.responseText):f(new Error(o.statusText))},o.onerror=function(){f(new Error("Network Error"))},o.send()})}n.exports=f},{}]},{},[4])(4)}),angular.module("edsiteApp.Commun").factory("h2c",["$q",function($q){var h2c={};return h2c.renderElementByID=function(id){var defer=$q.defer(),container=document.getElementById(id);return html2canvas(container,{backgroundColor:"#ffffff"}).then(function(canvas){defer.resolve(canvas)}),defer.promise},h2c}]),angular.module("edsiteApp.Commun").factory("Settings",["$rootScope","EdCluster","CONFIG",function($rootScope,EdCluster,CONFIG){var settingsService={},currentModeAPI=CONFIG.name,settingsData={};return settingsService.touch=function(){$rootScope.$emit("update-settings")},settingsService.displayNoMoreServerMessage=function(){$rootScope.$emit("nomore-server")},settingsService.apiUri="",settingsService.allSettings=function(){var version="3.1.0";settingsService.apiUri="";var notVersionningApiUri="/",apiExtension="",server=EdCluster.getServer();if(server="api.ecoledirecte.com",""===server&&(window.location.hostname.indexOf("ecoledirecte.com")>=0||window.location.hostname.indexOf("0.0.0.0")>=0||window.location.hostname.indexOf("127.0.0.1")>=0||window.location.hostname.indexOf("192.168.73")>=0)&&(server="development"===currentModeAPI?"api.ecoledirecte.com":"staging"===currentModeAPI?"wstest.ecoledirecte.com":"local"===currentModeAPI?CONFIG.ipIIS:"api.ecoledirecte.com"),"api.ecoledirecte.com"===server){var isF=$rootScope.Auth.isFamille()||$rootScope.Auth.isEleve(),isAnonymous=!$rootScope.Auth.isAuthenticated(),isP=!isF&&!isAnonymous;isP&&(server="apip.ecoledirecte.com")}return""!==server&&("local"===currentModeAPI&&(apiExtension=".awp",notVersionningApiUri="http://"+CONFIG.ipIIS+"/EDV3WEBSERVICES_WEB/FR/",settingsService.apiUri=notVersionningApiUri+"v3/"),("production"===currentModeAPI||"development"===currentModeAPI||"staging"===currentModeAPI)&&(apiExtension=".awp",notVersionningApiUri="https://"+server+"/",settingsService.apiUri=notVersionningApiUri+"v3/")),settingsData={version:version,apiUri:settingsService.apiUri,notVersionningApiUri:notVersionningApiUri,apiExtension:apiExtension,mode:currentModeAPI,contactMail:"statim@statim.fr",traduction:[{key:"about",traduction:"A propos"},{key:"contact",traduction:"Contact"},{key:"main",traduction:"Accueil"},{key:"login",traduction:"Connexion"}],theme:"yeti"}},settingsService}]),angular.module("edsiteApp.Data",[]).service("Data",["$http","$log","Settings","Auth",function($http,$log,Settings,Auth){var settings=Settings.allSettings(),mapreplace=function(str,map){var newStr=str;return newStr=newStr.replace(/./g,function(x){return x in map?map[x]:x})},stringify=function(jsonobject){var resultat={};resultat=_.extend(resultat,jsonobject);var attribut,map={"\n":"\\n",'"':'\\"'},processJObject=function(jobject){for(var key in jobject)jobject.hasOwnProperty(key)&&(attribut=jobject[key],"string"==typeof attribut&&(jobject[key]=encodeURI(mapreplace(attribut,map))))};if("undefined"==typeof resultat.length)processJObject(resultat);else for(var i=0;i<resultat.length;i++){var leJsonObject=resultat[i];processJObject(leJsonObject)}return JSON.stringify(resultat)},processResponse=function(){};return{getApiUri:function(){return settings.apiUri},actualites:function(){var qs="?verbe=get",data={token:Auth.token()},baseUrl="actualites";return $http({method:"POST",url:settings.apiUri+baseUrl+settings.apiExtension+qs,data:"data="+stringify(data),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(processResponse)}}}]),angular.module("edsiteApp.Commun").factory("ScanBadgeService",["$q","$http","EDHttp",function($q,$http,EDHttp){function getBadge(scan){var defer=$q.defer(),baseUrl="scanBadge",data=scan;return new EDHttp({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}var Helper={};return Helper.getBadge=getBadge,Helper}]),angular.module("edsiteApp.displayDateFilter",[]).filter("displaydate",function(){return function(input){if(input="undefined"!=typeof input?input:"",""!==input){var ladate=input.toString();return ladate.slice(6,9)+"/"+ladate.slice(4,6)+"/"+ladate.slice(0,4)}return""}}),angular.module("edsiteApp").filter("specialCharacters",function(){function removeDiacritics(str){if("string"!=typeof str)return str;changes||(changes=defaultDiacriticsRemovalMap);for(var i=0;i<changes.length;i++)str=str.replace(changes[i].letters,changes[i].base);return str}var changes,defaultDiacriticsRemovalMap=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g
},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];return function(str){return removeDiacritics(str)}}),angular.module("edsiteApp").filter("offset",function(){return function(input,start){return start=parseInt(start,10),input.slice(start)}}),angular.module("edsiteApp").filter("groupBy",["$parse",function($parse){return function(list,groupByWhat){var filtered=[],prevItem=null,groupChanged=!1,newField="group_by_CHANGED";return angular.forEach(list,function(item){if(groupChanged=!1,null!==prevItem){groupByWhat=angular.isArray(groupByWhat)?groupByWhat:[groupByWhat];for(var i=0,len=groupByWhat.length;len>i;i++)$parse(groupByWhat[i])(prevItem)!==$parse(groupByWhat[i])(item)&&(groupChanged=!0)}else groupChanged=!0;item[newField]=groupChanged,filtered.push(item),prevItem=item}),filtered}}]),function(Handsontable){var NoteEditor=Handsontable.editors.TextEditor.prototype.extend(),onBeforeKeyDown=function(event){if(angular.element(".modal-dialog").length>0)event.stopImmediatePropagation(),event.isImmediatePropagationEnabled=!1;else{event=event||window.event;var code=event.keyCode;if([65,68,46,8].indexOf(code)<0)return;var instance=this,editor=instance.getActiveEditor();if(!editor.notationLettre&&!editor.readOnly)switch(code){case 65:editor.beginEditing("abs"),editor.setValue("abs"),event.stopImmediatePropagation(),event.isImmediatePropagationEnabled=!1,event.preventDefault();break;case 68:editor.beginEditing("disp"),editor.setValue("disp"),event.stopImmediatePropagation(),event.isImmediatePropagationEnabled=!1,event.preventDefault();break;case 46:editor.beginEditing("__DELETE__"),editor.finishEditing(!1,!0)}}};NoteEditor.prototype.open=function(){this.instance.addHook("beforeKeyDown",onBeforeKeyDown),Handsontable.editors.TextEditor.prototype.open.apply(this)},NoteEditor.prototype.close=function(){Handsontable.editors.TextEditor.prototype.close.apply(this),this.instance.removeHook("beforeKeyDown",onBeforeKeyDown)},NoteEditor.prototype.prepare=function(row,col){Handsontable.editors.TextEditor.prototype.prepare.apply(this,arguments),this.notationLettre=this.cellProperties.notationLettre,this.readOnly=this.cellProperties.readOnly,this.instance.addHook("beforeKeyDown",onBeforeKeyDown)},Handsontable.editors.NoteEditor=NoteEditor}(Handsontable),angular.module("edsiteApp.Commun").controller("MainCtrl",["$scope","Auth","$location","$routeParams",function($scope,Auth,$location,$routeParams){var accueilURL="/login";Auth.isFamille()&&(accueilURL="/Famille"),Auth.isEleve()&&(accueilURL="/Eleves/"+Auth.idUser()),Auth.isProfesseur()&&(accueilURL="/Enseignant"),Auth.isPersonnel()&&(accueilURL="/Personnel"),angular.isDefined($routeParams.idunique)&&"undefined"!==$routeParams.idunique&&(accueilURL="/loginExterne"),$location.path(accueilURL)}]),angular.module("edsiteApp.Commun").controller("AboutCtrl",["$scope",function($scope){$scope.pageName="About"}]),angular.module("edsiteApp.Commun").controller("HeaderCtrl",["$scope","$document","$location","$rootScope","$sessionStorage","$routeParams","Auth",function($scope,$document,$location,$rootScope,$sessionStorage,$routeParams,Auth){function getPanier(){return $sessionStorage.panier}$scope.Auth=Auth,$scope.getPanier=getPanier}]),angular.module("edsiteApp.Commun").controller("FooterCtrl",["$scope","$window",function($scope,$window){function goToAnchor(){$("html, body").animate({scrollTop:0},1e3)}var vm=this;vm.goToAnchor=goToAnchor,vm.userHasScroll=!1;var elemWindow=angular.element($window);elemWindow.bind("scroll",function(){vm.userHasScroll=elemWindow.scrollTop()>0,$scope.$apply()})}]),angular.module("edsiteApp.casService",["edsiteApp.Commun"]).service("CASService",["$q","$http","EDHttp","Auth","Settings",function($q,$http,EDHttp,Auth,Settings){function goToService(url){var settings=Settings.allSettings(),action=settings.apiUri+"cas/goToService"+settings.apiExtension+"?service="+url,formElement=angular.element("<form/>");formElement.attr({method:"POST",target:"_blank",action:action});var tokenElement=angular.element("<input />");tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),formElement.append(tokenElement),formElement.appendTo("body").submit(),formElement.remove()}var mCASService={};return mCASService.goToService=goToService,mCASService}]),angular.module("edsiteApp.Commun").controller("modalMentionsLegales",["$uibModalInstance",function($uibModalInstance){function close(){$uibModalInstance.close()}var vm=this;vm.close=close}]),angular.module("edsiteApp.Commun").controller("modalAideConnexion",["$uibModalInstance",function($uibModalInstance){function close(){$uibModalInstance.close()}var vm=this;vm.close=close}]),angular.module("edsiteApp.Finance",["edsiteApp.Commun","edsiteApp.DemandeModifications","edsiteApp.base64filter","ui.bootstrap"]).controller("CompteCtrl",["$scope","$filter","$sessionStorage","$uibModal","Auth","FinanceService","DemandeModificationsService","Notification","ModuleService","lodash",function($scope,$filter,$sessionStorage,$uibModal,Auth,FinanceService,DemandeModificationsService,Notification,ModuleService,lodash){function cancelDemande(demande){$scope.promiseContents=DemandeModificationsService.cancelDemande(demande,"modeReg").then(function(){Notification.notify("Mode de règlement","Votre demande de modification a été annulée","success",!0),$scope.demande={},$scope.modeDeReglement.demandeencours=!1})}function loadArchives(annee,moduleDisplayed){$scope[moduleDisplayed]=annee,$scope.anneesArchive.length>0&&!angular.isUndefined(annee)&&""!==annee&&($scope.promiseContents=FinanceService.archivesFactures(annee).then(function(documents){$scope.archives=documents,$scope.anneeSelected=annee}))}function totalEcheance(compte){return lodash.reduce(compte.echeances,function(total,echeance){return total+echeance.montant},0)}function isPorteMonnaieDisponible(){return FinanceService.isPorteMonnaieDisponible($scope.comptes)}function isThereModification(){return!angular.equals($scope.backupModeDeReglement,$scope.modeDeReglement)}function modifsToXml(){var contenuXml,noeudPrincipal,noeudModeReglement,noeudIban,noeudDomiciliation;return contenuXml=(new DOMParser).parseFromString("<demandeModifications></demandeModifications>","text/xml"),noeudPrincipal=contenuXml.getElementsByTagName("demandeModifications")[0],noeudModeReglement=contenuXml.createElement("modeReglement"),noeudModeReglement.appendChild(contenuXml.createTextNode($scope.modeDeReglement.modedereglement)),noeudPrincipal.appendChild(noeudModeReglement),"Prélèvement"===$scope.modeDeReglement.modedereglement&&(noeudIban=contenuXml.createElement("IBAN"),noeudIban.appendChild(contenuXml.createTextNode($scope.modeDeReglement.iban)),noeudPrincipal.appendChild(noeudIban),noeudDomiciliation=contenuXml.createElement("Domiciliation"),noeudDomiciliation.appendChild(contenuXml.createTextNode($scope.modeDeReglement.domiciliation)),noeudPrincipal.appendChild(noeudDomiciliation)),(new XMLSerializer).serializeToString(noeudPrincipal)}function cancelModeDeReglement(){$scope.modeDeReglement=angular.copy($scope.backupModeDeReglement),$scope.modeDeReglementForm.$setPristine(),$scope.setCoordonneesbancairesModeEdit(!1)}$scope.comptes={},$scope.factures={},$scope.nonlettree="1",$scope.aucunlettrage=!0,$scope.coordonneesbancairesModeEdit=!1,$scope.modeDeReglement={},$scope.facturesVisibles=ModuleService.isModuleEnabled(ModuleService.CODES.FACTURES),$scope.modeDeReglementVisible=ModuleService.isModuleEnabled(ModuleService.CODES.MODE_DE_REGLEMENT),$scope.paiementEnLigneActif=ModuleService.isModuleEnabled(ModuleService.CODES.PAIEMENT_EN_LIGNE),angular.isDefined(ModuleService.getModule(ModuleService.CODES.DOCUMENTS))&&($scope.parametresDoc=ModuleService.getModule(ModuleService.CODES.DOCUMENTS).params,$scope.facturesDisplayed="",$scope.anneesArchive=[],angular.isDefined($scope.parametresDoc.AnneeArchive)&&($scope.anneesArchive=$scope.parametresDoc.AnneeArchive.split(",")));var listeModif="";$scope.cancelModeDeReglement=cancelModeDeReglement,$scope.cancelDemande=cancelDemande,$scope.isPorteMonnaieDisponible=isPorteMonnaieDisponible,$scope.totalEcheance=totalEcheance,$scope.loadArchives=loadArchives,$scope.expandCallback=function(){},$scope.collapseCallback=function(){},$scope.isValidIban=function(){return angular.isDefined($scope.modeDeReglement.iban)&&IBAN.isValid($scope.modeDeReglement.iban.replace(/ /g,""))},$scope.refresh=function(){$scope.promiseContents=FinanceService.comptes("detail").then(function(comptes){if(comptes.comptes.length>0){var lIndexLettre=lodash.findIndex(comptes.comptes[0].ecritures,function(ecri){return""!==ecri.lettrage});lIndexLettre>=0&&($scope.aucunlettrage=!1)}$scope.comptes=comptes.comptes,$scope.comptesParametrage=comptes.parametrage}),Auth.isPersonnel()||Auth.isProfesseur()?$scope.selected="#portemonaie":($scope.selected="#compte",FinanceService.familleFactures().then(function(factures){$scope.factures=factures}),FinanceService.familleModeDeReglement().then(function(modeDeReglement){$scope.modeDeReglement=modeDeReglement,$scope.backupModeDeReglement=angular.copy(modeDeReglement)}),DemandeModificationsService.listeDemandeModifications(Auth.idUser(),"modeReg").then(function(laDemande){$scope.demande=laDemande}))},$scope.sendDemandeModificationCoordonneesbancaires=function(){$scope.coordonneesbancairesModeEdit=!1,isThereModification()?($scope.modeDeReglement.demandeencours=!0,listeModif=$filter("base64encode")(modifsToXml()),$scope.promiseContents=DemandeModificationsService.demandeModifications(listeModif,"modeReg").then(function(){Notification.notify("Mode de règlement","Votre demande de modification va être transmise à l'établissement","success",!0),$scope.promiseContents=DemandeModificationsService.listeDemandeModifications(Auth.idUser(),"modeReg").then(function(laDemande){$scope.demande=laDemande})})):Notification.notify("Mode de règlement","Aucune modification effectuée. Cette demande n'a donc pas été envoyée","info",!0)},$scope.setCoordonneesbancairesModeEdit=function(newValue){$scope.coordonneesbancairesModeEdit=newValue},$scope.displayModeDeReglement=function(){return"Chèque"===$scope.modeDeReglement.modedereglement?"Chèque":"Prélèvement"},$scope.payerEnLigne=function(idcompte,ideleve,montant,comptelibelle){montant=Math.round(100*montant)/100;var leCompte=lodash.findWhere($scope.comptes,{id:idcompte,libelle:comptelibelle});"portemonnaie"!==leCompte.typeCompte&&"pmactivite"!==leCompte.typeCompte&&(leCompte.montantModifiable=!0,leCompte.quantiteModifiable=!1),leCompte.montantModifiable||leCompte.quantiteModifiable||(leCompte.montantModifiable=!0),0===leCompte.idEleve&&(leCompte.montantModifiable=!0,leCompte.quantiteModifiable=!1),$scope.paiementDevise=ModuleService.getModule(ModuleService.CODES.PAIEMENT_EN_LIGNE).params.devise||"€",$scope.dataPanier={idcompte:idcompte,montant:montant,ideleve:ideleve,comptelibelle:comptelibelle,leCompte:leCompte,quantite:1},$uibModal.open({templateUrl:"modules/finance/ajouteraupaniel.html",scope:$scope})},$scope.addToPanier=function(idcompte,montant,quantite,ideleve,comptelibelle){var leCompte=lodash.findWhere($scope.comptes,{id:idcompte,libelle:comptelibelle}),code="",idServiceClasse=0,idPaiement=idcompte,quantiteModifiable=!1,montantModifiable=!0,typePaiement="service";"standard"===leCompte.typeCompte&&(code="SOLDE",comptelibelle="Règlement du Solde de votre Compte",typePaiement="solde"),("portemonnaie"===leCompte.typeCompte||"pmactivite"===leCompte.typeCompte)&&(code=leCompte.codeCompte,idServiceClasse=leCompte.idServiceClasse,idPaiement=code+"_"+idcompte,montantModifiable=leCompte.montantModifiable,quantiteModifiable=leCompte.quantiteModifiable,typePaiement="pm");var newPaiement={uid:$scope.guid(),img:"",idpaiement:idPaiement,montant:montant,code:code,montantMinimum:0,idServiceClasse:idServiceClasse,montantModifiable:montantModifiable,quantiteModifiable:quantiteModifiable,libelle:comptelibelle,quantite:quantite,typePaiement:typePaiement,idEleve:ideleve};angular.isUndefined($sessionStorage.panier)&&($sessionStorage.panier=[]),$sessionStorage.panier.push(newPaiement)},$scope.showDetail=function(ecriture){$scope.ecritureActuelle=ecriture,$uibModal.open({templateUrl:"modules/finance/comptedetailecriture.html",scope:$scope})},$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.COMPTE)}]),angular.module("edsiteApp.Finance").controller("EleveFinancesCtrl",["$scope","lodash","$uibModal","FinanceService",function($scope,lodash,$uibModal,FinanceService){function expandCallback(){}function collapseCallback(){}function isPorteMonnaieDisponible(){return FinanceService.isPorteMonnaieDisponible(vm.comptes)}function showDetail(ecriture){$scope.ecritureActuelle=ecriture,$uibModal.open({templateUrl:"modules/finance/comptedetailecriture.html",scope:$scope})}function refresh(){vm.promiseContents=FinanceService.comptes("detail").then(function(comptes){if(comptes.comptes.length>0){var lIndexLettre=lodash.findIndex(comptes.comptes[0].ecritures,function(ecri){return""!==ecri.lettrage});lIndexLettre>=0&&(vm.aucunlettrage=!1)}var nbComptesDispos=0;angular.forEach(comptes.comptes,function(unCompte){unCompte.disponible&&nbComptesDispos++,unCompte.accordeonOpen=1===nbComptesDispos&&1===comptes.comptes.length}),vm.comptes=comptes.comptes,vm.comptesParametrage=comptes.parametrage})}var vm=this;vm.refresh=refresh,vm.expandCallback=expandCallback,vm.collapseCallback=collapseCallback,vm.isPorteMonnaieDisponible=isPorteMonnaieDisponible,vm.showDetail=showDetail,vm.refresh()}]),angular.module("edsiteApp.Finance").service("FinanceService",["$q","$http","lodash",function($q,$http,lodash){var mFinanceService={};return mFinanceService.comptes=function(mode){var defer=$q.defer(),data={};mode=angular.isUndefined(mode)?"list":mode;var baseUrl="comptes/"+mode;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mFinanceService.familleModeDeReglement=function(){var defer=$q.defer(),data={},baseUrl="famillemodedereglement";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mFinanceService.familleFactures=function(){var defer=$q.defer(),data={},baseUrl="factures";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mFinanceService.archivesFactures=function(annee){var defer=$q.defer(),data={archive:!0},baseUrl="factures?archive="+annee;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mFinanceService.isPorteMonnaieDisponible=function(tabComptes){var comptesDisponibles;return comptesDisponibles=lodash.reject(tabComptes,{typeCompte:"standard"}),comptesDisponibles=lodash.where(comptesDisponibles,{disponible:!0}),comptesDisponibles.length>0},mFinanceService}]),angular.module("edsiteApp.Paiement",["edsiteApp.Commun","ui.bootstrap"]).controller("PaiementCtrl",["$scope","$document","$sessionStorage","$q","PaiementService","FinanceService","Notification","ModuleService","$uibModal","Auth","lodash","AccueilFamilleService","$filter",function($scope,$document,$sessionStorage,$q,PaiementService,FinanceService,Notification,ModuleService,$uibModal,Auth,lodash,AccueilFamilleService,$filter){function refresh(){var lesPromises=[];lesPromises.push(PaiementService.boutiquePaiementsEnLigne().then(function(paiementsenligne){$scope.paiementsenligne=paiementsenligne,FinanceService.comptes("sansdetails").then(function(data){lodash.forEach($scope.paiementsenligne,function(groupePaiement){lodash.forEach(groupePaiement.paiements,function(paiement){var lCompte;""!==paiement.detail&&(paiement.detailDecode=$filter("base64decode")(paiement.detail)),lCompte=Auth.isFamille()?lodash.find(data.comptes,{codeCompte:paiement.code,idEleve:parseInt(paiement.idEleve)}):lodash.find(data.comptes,{codeCompte:paiement.code}),angular.isDefined(lCompte)&&(paiement.soldeCompte=lCompte.solde)})}),$scope.lesSoldes=data.comptes})}),AccueilFamilleService.contactEtablissement().then(function(contactEtablissement){$scope.etablissement=contactEtablissement[0]})),$scope.promiseContents=$q.all(lesPromises)}function getPanier(){return $sessionStorage.panier}function findPaiementConfigById(idpaiement){for(var i=0;i<$scope.paiementsenligne.length;i++){var paiementGroup=$scope.paiementsenligne[i],lepaiement=lodash.findWhere(paiementGroup.paiements,{id:idpaiement});if("undefined"!=typeof lepaiement)return lepaiement}return void 0}function hasError(paiement){return paiement.montant<paiement.montantMinimum||paiement.montant<=0||paiement.quantite<=0}function hasErrorInAll(){for(var i=0;i<$sessionStorage.panier.length;i++){var paiement=$sessionStorage.panier[i];if(paiement.montant<paiement.montantMinimum||paiement.montant<=0||paiement.quantite<=0)return!0}return!1}function totalPanier(){for(var total=0,i=0;i<$sessionStorage.panier.length;i++){var lepaiement=$sessionStorage.panier[i];if(isNaN(lepaiement.montant)||isNaN(lepaiement.quantite))return 0;total+=lepaiement.montant*lepaiement.quantite}return total}function addToPanier(idpaiement){var paiementConfig=$scope.findPaiementConfigById(idpaiement);if(paiementConfig.quantiteModifiable&&!angular.isUndefined(lodash.find($sessionStorage.panier,{id:idpaiement}))){var lepaiement=lodash.find($sessionStorage.panier,{id:idpaiement});lepaiement.quantite++,Notification.notify("Attention","Ce service était déjà présent dans votre panier. Nous avons augmenté sa quantité.","info")}else if(paiementConfig.quantiteModifiable||angular.isUndefined(lodash.find($sessionStorage.panier,{id:idpaiement}))){var newPaiement=angular.copy(paiementConfig);newPaiement.quantite=1,newPaiement.uid=$scope.guid(),newPaiement.idpaiement=idpaiement,$sessionStorage.panier.push(newPaiement)}else Notification.notify("Attention","Ce service est déjà présent dans votre panier","info");var paiementButton=angular.element(document.getElementById("paiementButton")),body=angular.element("body"),top=body.css("padding-top");angular.isDefined(paiementButton[0])&&$document.scrollToElement(paiementButton,parseInt(top)+90,500)}function removePaiement(uidpaiement){for(var i=0;i<$sessionStorage.panier.length;i++){var lepaiement=$sessionStorage.panier[i];lepaiement.uid===uidpaiement&&$sessionStorage.panier.splice(i,1)}}function validerPanier(){var dialog=$uibModal.open({templateUrl:"modules/paiement/paiementvalidationpanier.html",scope:$scope});dialog.result.then(function(data){if(1!==data){var commande={};commande.mail=data,commande.montant=$scope.totalPanier(),commande.panier=$sessionStorage.panier,PaiementService.validationPanier(commande).then(function(retour){window.location.href=retour.urlSecure},function(error){Notification.notify("Paiements en ligne",angular.isDefined(error.data.message)&&""!==error.data.message?error.data.message:"Une erreur s'est produite lors de la soumission du panier","error","fa fa-calendar-o")})}})}$scope.validerPanier=validerPanier,$scope.refresh=refresh,$scope.findPaiementConfigById=findPaiementConfigById,$scope.hasError=hasError,$scope.hasErrorInAll=hasErrorInAll,$scope.totalPanier=totalPanier,$scope.getPanier=getPanier,$scope.addToPanier=addToPanier,$scope.removePaiement=removePaiement,$scope.paiementsenligne=[],angular.isUndefined($sessionStorage.panier)&&($sessionStorage.panier=[]),$scope.montantMinimum=parseInt(ModuleService.getModule(ModuleService.CODES.PAIEMENT_EN_LIGNE).params.montantMinimum),$scope.paiementDevise=ModuleService.getModule(ModuleService.CODES.PAIEMENT_EN_LIGNE).params.devise||"€",$scope.email=Auth.currentUser().profile.email?Auth.currentUser().profile.email.trim():"",$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.PAIEMENT_EN_LIGNE)}]),angular.module("edsiteApp.Paiement").service("PaiementService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mPaiementService={};return mPaiementService.boutiquePaiementsEnLigne=function(){var defer=$q.defer(),data={},baseUrl="boutique/paiementsenligne";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPaiementService.validationPanier=function(panier){var defer=$q.defer(),data=panier,baseUrl="boutique/paiementsenligne";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPaiementService}]),angular.module("edsiteApp.Paiement").controller("RetourpaiementCtrl",["$scope","$routeParams","$location","$sessionStorage","Auth",function($scope,$routeParams,$location,$sessionStorage,Auth){var lecode=$routeParams.code;if("200"===lecode)$scope.code=200,$sessionStorage.panier=[];else{$scope.code=0;var urlToRedirectTo="";Auth.isPersonnel()?urlToRedirectTo="/Personnel/Paiements":Auth.isFamille()?urlToRedirectTo="/Famille/Paiements":Auth.isProfesseur()&&(urlToRedirectTo="/Professeur/Paiements"),$location.path(urlToRedirectTo)}}]),angular.module("edsiteApp.messagerie",["ckeditor","ui.bootstrap","cgBusy","vs-repeat","edsiteApp.Commun","edsiteApp.filterTranslateTypeUser","edsiteApp.modals","edsiteApp.base64filter"]).controller("CommunMessagerieCtrl",["$scope","$route","$timeout","$location","$filter","$interval","$uibModal","Settings","Utils","Auth","lodash","Notification","$routeParams","MessagerieService","UserService","$sessionStorage","ModuleService",function($scope,$route,$timeout,$location,$filter,$interval,$uibModal,Settings,Utils,Auth,lodash,Notification,$routeParams,MessagerieService,UserService,$sessionStorage,ModuleService){function supprimerMessage(msg,state){var idx=vm.filteredMessages[state].indexOf(msg);idx>-1&&vm.filteredMessages[state].splice(idx,1)}function getCurrentIdMessage(){return angular.isDefined(vm.currentMessage)?vm.currentMessage.id:""}function isCurrentMessage(message){return angular.isDefined(vm.currentMessage)&&vm.currentMessage.id===message.id&&vm.currentMessage.idDossier===message.idDossier&&vm.currentMessage.idClasseur===message.idClasseur}function openMessage(message,options){if(!vm.isCurrentMessage(message)){options||(options={}),vm.droits.canArchive=options.canArchive,canReplyFct(message);var mode=MessagerieService.MODE_EXPEDITEUR;message.mtype===MessagerieService.MESSAGERIE_STATE.received&&(mode=MessagerieService.MODE_DESTINATAIRE),vm.promiseRequestLoading=MessagerieService.getMessage(vm.typeUser,vm.idUser,message.id,mode).then(function(_message){vm.currentBox!==inboxStates().received&&!vm.isInboxClasseur()||message.read||!_message.read||(message.read=!0,vm.badges=lodash.filter(vm.filteredMessages.received,{read:!1}).length),vm.currentMessage=_message,(Auth.isFamille()||Auth.isEleve())&&vm.droits.canReply&&(vm.droits.canReply=!vm.currentMessage.from.listeRouge)})}}function reloadSignatureMessage(){vm.promiseRequestLoading=MessagerieService.getSignatureMessage().then(function(laSignature){MessagerieService._contentSignatureMessage(laSignature.signature)},function(error){})}function getMessages(){if((!vm.currentBox||inboxStates()[vm.currentBox]||isNaN(vm.currentBox)!==!1)&&vm.currentBox!==inboxStates().settings){var options={force:!0,typeRecup:vm.currentBox,orderBy:"date",order:"desc",query:"",page:0,itemsPerPage:20};vm.isInboxClasseur()&&(options.typeRecup=MessagerieService.MESSAGERIE_STATE.classeur,options.idClasseur=vm.currentBox.substr(2)),!lodash.isEmpty(vm.search)&&!lodash.isEmpty(vm.search.nom)&&(options.query=vm.search.nom,options.query.length<3)||(vm.promiseRequestLoading=MessagerieService.getMessages(vm.typeUser,vm.idUser,options,"GETALL").then(function(data){if(vm.filteredMessages=data.messages,vm.tabClasseurs=angular.isDefined(data.classeurs)?data.classeurs:[],options.typeRecup!==MessagerieService.MESSAGERIE_STATE.classeur)vm.filteredMessages.received=angular.isDefined(data.messages.received)?data.messages.received:[],vm.filteredMessages.sent=angular.isDefined(data.messages.sent)?data.messages.sent:[];else{var tabMessagesClasseur=angular.isDefined(data.messages[vm.currentBox])?data.messages[vm.currentBox]:[];vm.filteredMessages[vm.currentBox]=$filter("orderBy")(tabMessagesClasseur,"-date")}vm.filteredMessages.archived=angular.isDefined(data.messages.archived)?data.messages.archived:[],vm.currentBox===inboxStates().received&&(vm.badges=data.pagination.messagesRecusNotReadCount),angular.isDefined(vm.currentMessage)&&0===lodash.filter(vm.filteredMessages[vm.currentBox],{id:vm.currentMessage.id}).length&&(vm.currentMessage=void 0),MessagerieService.getMessagerieParametrage(vm.typeUser,vm.idUser).then(function(params){vm.parametrages=params}),(Auth.isProfesseur()||Auth.isPersonnel())&&reloadSignatureMessage()},function(error){Notification.notify("Messagerie","Une erreur s'est produite lors de la récupération des messages","error","fa fa-envelope")}))}}function openBox(box){vm.currentBox!==box&&(vm.currentBox=box,vm.currentMessage=void 0,vm.search={},getMessages())}function getbadges(){return ModuleService.getBadges(ModuleService.CODES.MESSAGERIE,vm.idUser)}function isBoxCurrent(box){return box===vm.currentBox}function inboxStates(){return MessagerieService.MESSAGERIE_STATE}function isHimself(){return Auth.isHimself(vm.typeUser,vm.idUser)}function canReplyFct(message){var ok=isHimself();ok="send"===message.mtype?!1:ok&&canReplyToTypeDest(message.from.role),vm.droits.canReply=ok}function isInboxClasseur(){return"c_"===vm.currentBox.substr(0,2)}function getCurrentClasseur(){var classeur=vm.tabClasseurs.find(function(clas){return"c_"+clas.id===vm.currentBox});return classeur}function getTypePersonne(typePersonne){var typesPersonne={A:"Administration",P:"Professeur",1:"Famille",2:"Famille",E:"Élève"};return typesPersonne[typePersonne]}function canWriteNewMessageFct(){var ok=!1;return ok=ok||canReplyToTypeDest("A"),ok=ok||canReplyToTypeDest("E"),ok=ok||canReplyToTypeDest("P"),ok=ok||canReplyToTypeDest("1"),ok=ok||canReplyToTypeDest("2"),ok=ok||canReplyToTypeDest("W")}function canReplyToTypeDest(role){var replyToTypeOfDest={A:function(params){return params.destAdmin},E:function(params){return params.destEleve},P:function(params){return params.destProf},1:function(params){return params.destFamille},2:function(params){return params.destFamille},W:function(params){return params.destEspTravail}},params=MessagerieService.getMessagerieParametrageSync(vm.typeUser,vm.idUser);return angular.isDefined(params)?replyToTypeOfDest[role](params):!1}function createClasseur(){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Nouveau dossier",config.message="Nom du dossier à créer",config.confirm="Valider",config.cancel="Annuler",config.value="",config}}});modalInstance.result.then(function(libelleClasseur){""===libelleClasseur?Notification.notify("Erreur","Vous devez saisir un nom pour le dossier à créer","danger"):vm.promiseRequestLoading=MessagerieService.createClasseur(libelleClasseur).then(function(classeurUpdated){vm.tabClasseurs.push(classeurUpdated),vm.filteredMessages["c_"+classeurUpdated.id]=[],Notification.notify("Messagerie","Le dossier a été créé","success"),modalInstance.close()},function(err){Notification.notify("Erreur","La création du dossier a échoué","danger")})})}function updateClasseur(classeur){var classeurUpd=angular.copy(classeur),modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Renommer le dossier",config.message="Nom du dossier",config.confirm="Valider",config.cancel="Annuler",config.value=classeurUpd.libelle,config}}});modalInstance.result.then(function(libelleClasseur){""===libelleClasseur?Notification.notify("Erreur","Vous devez saisir un nom pour le dossier","danger"):(classeurUpd.libelle=libelleClasseur,vm.promiseRequestLoading=MessagerieService.updateClasseur(classeurUpd).then(function(){Notification.notify("Messagerie","Le dossier a été renommé","success"),angular.extend(classeur,classeurUpd),modalInstance.close()},function(err){Notification.notify("Erreur","La modification du dossier a échoué","danger")}))})}function deleteInboxClasseur(idInboxClasseur){var classeur=vm.tabClasseurs.find(function(clas){return"c_"+clas.id===idInboxClasseur});angular.isUndefined(classeur)&&Notification.notify("Erreur","Suppression du dossier impossible","danger");
var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Supprimer le dossier",config.message="Êtes-vous sûr de vouloir supprimer le dossier <b>"+classeur.libelle+"</b> ?",config.confirm="Supprimer",config.cancel="Annuler",config}}});modalInstance.result.then(function(){vm.promiseRequestLoading=MessagerieService.deleteClasseur(classeur).then(function(){delete vm.filteredMessages[idInboxClasseur],lodash.remove(vm.tabClasseurs,function(clas){return clas.id===classeur.id}),Notification.notify("Messagerie","Le dossier a été supprimé avec succès !","success",!0),modalInstance.close(),vm.openBox(vm.inboxStates().received)},function(err){Notification.notify("Erreur",angular.isDefined(err.data.message)?err.data.message:"La suppression du dossier a échouée","danger")})})}function deplacerMessages(listMessages,classeurDest){vm.promiseRequestLoading=MessagerieService.deplacerMessages(listMessages,vm.typeUser,vm.idUser,classeurDest.id).then(function(){angular.forEach(listMessages,function(message){var movedMessage=lodash.remove(vm.filteredMessages[vm.currentBox],{id:message.id});if(movedMessage){message.idClasseur=classeurDest.id;var inboxDest=0;inboxDest=classeurDest.id>0?"c_"+classeurDest.id:MessagerieService.MESSAGERIE_DOSSIER[message.idDossier],angular.isUndefined(vm.filteredMessages[inboxDest])&&(vm.filteredMessages[inboxDest]=[]),vm.filteredMessages[inboxDest].push(message),message.read||(vm.currentBox===inboxStates().received?vm.badges--:inboxDest===inboxStates().received&&vm.badges++)}}),Notification.notify("Déplacement","Le déplacement a été effectué avec succès","success","fa fa-envelope"),vm.currentMessage=void 0},function(){Notification.notify("Messagerie","Une erreur s'est produite lors du déplacement","error","fa fa-enveloppe")})}function initPage(){if(ModuleService.clearBadges(ModuleService.CODES.MESSAGERIE),Auth.isFamille()&&UserService.getEleve(vm.idUser).then(function(eleve){angular.isUndefined(eleve)||(vm.eleve=eleve)}),$routeParams.messageId){var idMessage=parseInt($routeParams.messageId),currentMessage=MessagerieService.getMessageFromStorage(vm.typeUser,vm.idUser,idMessage);if(angular.isDefined(currentMessage))return openBox(MessagerieService.MESSAGERIE_DOSSIER[currentMessage.idDossier]),void openMessage(currentMessage,{canArchive:!0})}openBox(MessagerieService.MESSAGERIE_STATE.received)}function isAnneeCourante(){return angular.isUndefined(vm.choosenAnneeMessages)||vm.choosenAnneeMessages===vm.anneesMessagesArchive[1]}function isDeplacerVersEnable(){var nbClasseursDispo=vm.tabClasseurs.filter(function(classeur){return"c_"+classeur.id!==vm.currentBox}).length;return!vm.isBoxCurrent(vm.inboxStates().archived)&&nbClasseursDispo>0&&vm.isAnneeCourante()}var vm=this;vm.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),vm.idUser=$routeParams.idUser,vm.eleve={},vm.parametrages={},vm.currentBox="",vm.filteredMessages={archived:[],received:[],sent:[]},vm.tabClasseurs=[],vm.currentMessage=void 0,vm.badges=getbadges(),vm.signatureMessage=MessagerieService._signatureMessage(),vm.search={},vm.droits={canReply:!1,canArchive:!1},vm.choosenAnneeMessages=MessagerieService.getChoosenAnneeMessages(),vm.anneesMessagesArchive=MessagerieService.getAnneesMessagesArchive(),vm.supprimerMessage=supprimerMessage,vm.getCurrentIdMessage=getCurrentIdMessage,vm.reloadSignatureMessage=reloadSignatureMessage,vm.openMessage=openMessage,vm.getMessages=getMessages,vm.openBox=openBox,vm.isBoxCurrent=isBoxCurrent,vm.inboxStates=inboxStates,vm.isInboxClasseur=isInboxClasseur,vm.getCurrentClasseur=getCurrentClasseur,vm.isHimself=isHimself,vm.getTypePersonne=getTypePersonne,vm.canWriteNewMessageFct=canWriteNewMessageFct,vm.canReplyToTypeDest=canReplyToTypeDest,vm.createClasseur=createClasseur,vm.deplacerMessages=deplacerMessages,vm.deleteInboxClasseur=deleteInboxClasseur,vm.isCurrentMessage=isCurrentMessage,vm.updateClasseur=updateClasseur,vm.isAnneeCourante=isAnneeCourante,vm.isDeplacerVersEnable=isDeplacerVersEnable,initPage()}]),angular.module("edsiteApp.messagerie").controller("MessagesListingCtrl",["$rootScope","$scope","MessagerieService","Utils","moment","lodash",function($rootScope,$scope,MessagerieService,Utils,moment,lodash){function getDomElementsDesc(){var arr=[],elems=document.querySelectorAll(".un-message");return elems=Array.prototype.slice.call(elems),elems.forEach(function(item){arr.push(item.innerHTML.trim())}),arr.length}function isToday(date){return moment(date).isSame(moment(),"day")}function selectAll(){angular.forEach($scope.CtrlCommunMessagerie.filteredMessages[$scope.CtrlCommunMessagerie.currentBox],function(msg){msg.isSelected=$scope.CtrlCommunMessagerie.search.selectedAll})}function combien(){return $scope.CtrlCommunMessagerie.filteredMessages[$scope.CtrlCommunMessagerie.currentBox]?$scope.CtrlCommunMessagerie.filteredMessages[$scope.CtrlCommunMessagerie.currentBox].length:0}function inboxTitles(){var title="";if("c_"===$scope.CtrlCommunMessagerie.currentBox.substr(0,2)){var classeurFound=lodash.find($scope.CtrlCommunMessagerie.tabClasseurs,function(classeur){return classeur.id===+$scope.CtrlCommunMessagerie.currentBox.substr(2)});angular.isDefined(classeurFound)&&(title=classeurFound.libelle)}else title=MessagerieService.INBOX_TITLE[$scope.CtrlCommunMessagerie.currentBox];return title}var vm=this;vm.Utils=Utils,vm.getDomElementsDesc=getDomElementsDesc,vm.selectAll=selectAll,vm.combien=combien,vm.inboxTitles=inboxTitles,vm.isToday=isToday}]),angular.module("edsiteApp.messagerie").controller("MessagesOptionsCtrl",["$rootScope","$scope","MessagerieService","Auth","lodash","Notification","$uibModal",function($rootScope,$scope,MessagerieService,Auth,lodash,Notification,$uibModal){function search(){$scope.CtrlCommunMessagerie.currentMessage=void 0,$scope.CtrlCommunMessagerie.getMessages()}function supprimerMessages(){var selectedMessages=vm.selectedMessages();if(selectedMessages.length){var title="Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> ";title+=selectedMessages.length>1?"ces messages ?":"ce message ?",self.modalInstanceSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression des messages",config.message=title,config.confirm="Oui",config.cancel="Non",config}}});var idDossier=$scope.CtrlCommunMessagerie.currentBox===MessagerieService.MESSAGERIE_STATE.sent?MessagerieService.ID_DOSSIER_ENVOYE:MessagerieService.ID_DOSSIER_ARCHIVE;self.modalInstanceSuppression.result.then(function(){$scope.CtrlCommunMessagerie.promiseRequestLoading=MessagerieService.supprimerMessages(selectedMessages,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,idDossier).then(function(){lodash.forEach(selectedMessages,function(msg){$scope.CtrlCommunMessagerie.supprimerMessage(msg,$scope.CtrlCommunMessagerie.currentBox)});var title=selectedMessages.length>1?"Messages supprimés":"Message supprimé",msg=selectedMessages.length>1?"Vos messages ont bien été supprimés":"Votre message a bien été supprimé";Notification.notify(title,msg,"success","fa fa-envelope"),$scope.CtrlCommunMessagerie.search.selectedAll=!1})})}}function unArchiveMessages(){var selectedMessages=lodash.filter($scope.CtrlCommunMessagerie.filteredMessages.archived,{isSelected:!0});selectedMessages.length&&($scope.CtrlCommunMessagerie.promiseRequestLoading=MessagerieService.archiveMessages(selectedMessages,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,!1).then(function(){lodash.forEach(selectedMessages,function(msg){msg.isSelected=!1;var idx=$scope.CtrlCommunMessagerie.filteredMessages.archived.indexOf(msg);idx>-1&&($scope.CtrlCommunMessagerie.filteredMessages.received.push(msg),$scope.CtrlCommunMessagerie.filteredMessages.archived.splice(idx,1))});var title=selectedMessages.length>1?"Messages désarchivés":"Message désarchivé",msg=selectedMessages.length>1?"Vos messages sont de retour dans votre boite de réception":"Message de retour dans votre boite de réception";Notification.notify(title,msg,"success","fa fa-envelope")}),$scope.CtrlCommunMessagerie.search.selectedAll=!1)}function archiveMessages(){var selectedMessages=lodash.filter($scope.CtrlCommunMessagerie.filteredMessages.received,{isSelected:!0});selectedMessages.length&&($scope.CtrlCommunMessagerie.promiseRequestLoading=MessagerieService.archiveMessages(selectedMessages,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,!0).then(function(){lodash.forEach(selectedMessages,function(msg){msg.isSelected=!1;var idx=$scope.CtrlCommunMessagerie.filteredMessages.received.indexOf(msg);idx>-1&&($scope.CtrlCommunMessagerie.filteredMessages.archived.push(msg),$scope.CtrlCommunMessagerie.filteredMessages.received.splice(idx,1))});var title=selectedMessages.length>1?"Messages archivés":"Message archivé",msg=selectedMessages.length>1?"Vos messages ont bien été archivés":"Votre message a bien été archivé";Notification.notify(title,msg,"success","fa fa-envelope")}),$scope.CtrlCommunMessagerie.search.selectedAll=!1)}function markMessagesAsUnread(){var selectedMessages=lodash.filter($scope.CtrlCommunMessagerie.filteredMessages.received,{isSelected:!0});$scope.CtrlCommunMessagerie.promiseRequestLoading=MessagerieService.markMessagesAsUnread(selectedMessages,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser).then(function(){lodash.forEach(selectedMessages,function(msg){msg.read=!1,msg.isSelected=!1}),$scope.CtrlCommunMessagerie.badges=lodash.filter($scope.CtrlCommunMessagerie.filteredMessages.received,{read:!1}).length;var title=selectedMessages.length>1?"Messages non lus":"Message non lu",msg=selectedMessages.length>1?"Vos messages ont bien été marqués comme non lus":"Votre message a bien été marqué comme non lu";Notification.notify(title,msg,"success","fa fa-envelope")},notifyError),$scope.CtrlCommunMessagerie.search.selectedAll=!1}function notifyError(){Notification.notify("Messagerie","Une erreur s'est produite...","error","fa icon-ed_messagerie")}function changeChoosenAnneeMessage(annee){MessagerieService.setChoosenAnneeMessages(annee),$scope.CtrlCommunMessagerie.choosenAnneeMessages=annee,$scope.CtrlCommunMessagerie.getMessages()}function nbSelectedMessages(){return angular.isUndefined($scope.CtrlCommunMessagerie.filteredMessages)?0:selectedMessages().length}function selectedMessages(){return angular.isUndefined($scope.CtrlCommunMessagerie.filteredMessages)?[]:lodash.filter($scope.CtrlCommunMessagerie.filteredMessages[$scope.CtrlCommunMessagerie.currentBox],{isSelected:!0})}var vm=this;vm.Auth=Auth,vm.search=search,vm.supprimerMessages=supprimerMessages,vm.unArchiveMessages=unArchiveMessages,vm.archiveMessages=archiveMessages,vm.markMessagesAsUnread=markMessagesAsUnread,vm.changeChoosenAnneeMessage=changeChoosenAnneeMessage,vm.nbSelectedMessages=nbSelectedMessages,vm.selectedMessages=selectedMessages}]),angular.module("edsiteApp.messagerie").controller("MessageCtrl",["$rootScope","$scope","MessagerieService","Auth","Utils","$uibModal","UserService","Notification","lodash","$location","$filter","ModuleService",function($rootScope,$scope,MessagerieService,Auth,Utils,$uibModal,UserService,Notification,lodash,$location,$filter,ModuleService){function setWantToReply(all){var message=angular.copy($scope.CtrlCommunMessagerie.currentMessage);MessagerieService.setOriginMessage(message),$location.path("/"+$filter("translateTypeUserUrl")($scope.CtrlCommunMessagerie.typeUser)+"/"+$scope.CtrlCommunMessagerie.idUser+"/Messagerie/Compose").search({messageId:message.id,responseAll:all,responseSimple:!all})}function cantResponseToAll(){if(Auth.isFamille()||Auth.isEleve()||$scope.CtrlCommunMessagerie.currentMessage.to.length<=1||$scope.CtrlCommunMessagerie.currentMessage.from.id<=0)return!0;for(var cant=!1,i=0;i<$scope.CtrlCommunMessagerie.currentMessage.to.length;i++){var toOrigin=$scope.CtrlCommunMessagerie.currentMessage.to[i];if((Auth.role()!==toOrigin.role||Auth.idUser()!==toOrigin.id)&&!$scope.CtrlCommunMessagerie.canReplyToTypeDest(toOrigin.role)){cant=!0;break}}return cant}function forwardMessage(){var message=angular.copy($scope.CtrlCommunMessagerie.currentMessage);$scope.CtrlCommunMessagerie.currentBox===$scope.CtrlCommunMessagerie.inboxStates().received?message.idDossier=MessagerieService.ID_DOSSIER_RECEPTION:$scope.CtrlCommunMessagerie.currentBox===$scope.CtrlCommunMessagerie.inboxStates().sent?message.idDossier=MessagerieService.ID_DOSSIER_ENVOYE:$scope.CtrlCommunMessagerie.currentBox===$scope.CtrlCommunMessagerie.inboxStates().archived&&(message.idDossier=MessagerieService.ID_DOSSIER_ARCHIVE),MessagerieService.setOriginMessage(message),$location.path("/"+$filter("translateTypeUserUrl")($scope.CtrlCommunMessagerie.typeUser)+"/"+$scope.CtrlCommunMessagerie.idUser+"/Messagerie/Compose").search({messageId:message.id,forward:!0})}function desArchiveMessage(){vm.promiseRequestLoading=MessagerieService.archiveMessage($scope.CtrlCommunMessagerie.currentMessage,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,!1).then(function(){var deletedMessage=lodash.remove($scope.CtrlCommunMessagerie.filteredMessages.archived,{id:$scope.CtrlCommunMessagerie.currentMessage.id});deletedMessage&&$scope.CtrlCommunMessagerie.filteredMessages.sent.push($scope.CtrlCommunMessagerie.currentMessage);var title="Message désarchivé",msg="Votre message a bien été désarchivé";Notification.notify(title,msg,"success","fa fa-envelope"),$scope.CtrlCommunMessagerie.currentMessage=void 0})}function archiveMessage(){vm.promiseRequestLoading=MessagerieService.archiveMessage($scope.CtrlCommunMessagerie.currentMessage,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,!0).then(function(){var deletedMessage=lodash.remove($scope.CtrlCommunMessagerie.filteredMessages.received,{id:$scope.CtrlCommunMessagerie.currentMessage.id});deletedMessage&&$scope.CtrlCommunMessagerie.filteredMessages.archived.push($scope.CtrlCommunMessagerie.currentMessage);var title="Message archivé",msg="Votre message a bien été archivé";Notification.notify(title,msg,"success","fa fa-envelope"),$scope.CtrlCommunMessagerie.currentMessage=void 0})}function supprimeMessage(){if(!angular.isUndefined($scope.CtrlCommunMessagerie.currentMessage)){var selectedMessages=lodash.filter($scope.CtrlCommunMessagerie.filteredMessages[$scope.CtrlCommunMessagerie.currentBox],{id:$scope.CtrlCommunMessagerie.currentMessage.id,idDossier:$scope.CtrlCommunMessagerie.currentMessage.idDossier});if(selectedMessages.length){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression du message",config.message="Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> ce message ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){vm.promiseRequestLoading=MessagerieService.supprimerMessages(selectedMessages,$scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.currentMessage.idDossier).then(function(){$scope.CtrlCommunMessagerie.supprimerMessage(selectedMessages[0],$scope.CtrlCommunMessagerie.currentBox);var title="Message supprimé",msg="Votre message a bien été supprimé";Notification.notify(title,msg,"success","fa fa-envelope"),$scope.CtrlCommunMessagerie.currentMessage=void 0})})}}}function convertToMail(){var modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Votre email",config.message="Sur quelle adresse mail doit être envoyé  le message ?",config.confirm="Valider",config.cancel="Annuler",config.value=UserService.getEmails(),config}}});modalInstance.result.then(function(mail){validateEmail(mail)?vm.promiseRequestLoading=MessagerieService.convertToMail($scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.currentMessage,mail).then(function(){Notification.notify("Messagerie","Conversion en email effectuée","success"),modalInstance.close()}):Notification.notify("Erreur","Adresse email invalide","danger")})}function validateEmail(email){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}function printMessage(){var divContents="";$(".printable-message").each(function(){divContents+=$(this).html()});var printWindow=window.open("","","height=400,width=800");printWindow.document.write("<html><head><title>"+$scope.CtrlCommunMessagerie.currentMessage.subject+"</title>"),printWindow.document.write("</head><body >"),printWindow.document.write(divContents),printWindow.document.write("</body></html>"),printWindow.document.close(),printWindow.print()}function showContact(){$uibModal.open({templateUrl:"modules/messagerie/messagerie.viewMessage.listeContacts.html",size:"lg",controller:"ListeContactCtrl",controllerAs:"CtrlListeContact",windowClass:"dialog-show-contact",resolve:{destinataires:function(){return $scope.CtrlCommunMessagerie.currentMessage.to},message:function(){return $scope.CtrlCommunMessagerie.currentMessage}}})}function exportToCloud(fileToSend,currentMessage){vm.promiseRequestLoading=MessagerieService.pieceJointeToCloud(currentMessage.id,fileToSend.id).then(function(){Notification.notify("Messagerie","Votre pièce jointe a bien été copiée dans le dossier <strong>Pièces Jointes</strong> de votre Cloud","success","fa fa-enveloppe")},function(error){""!==error.message?Notification.notify("Messagerie",error.message,"error","fa fa-enveloppe"):Notification.notify("Messagerie","Une erreur s'est produite lors du téléchargement de votre pièce-jointe vers votre Cloud","error","fa fa-enveloppe")})}var vm=this;vm.Auth=Auth,vm.Utils=Utils,vm.sanitizedHtml="",vm.isCloudEnable=ModuleService.isModuleEnabled(ModuleService.CODES.CLOUD),vm.cantResponseToAll=cantResponseToAll,vm.forwardMessage=forwardMessage,vm.desArchiveMessage=desArchiveMessage,vm.archiveMessage=archiveMessage,vm.supprimeMessage=supprimeMessage,vm.convertToMail=convertToMail,vm.printMessage=printMessage,vm.showContact=showContact,vm.setWantToReply=setWantToReply,vm.exportToCloud=exportToCloud}]).controller("ListeContactCtrl",["Utils","lodash","$filter","destinataires","message",function(Utils,lodash,$filter,destinataires,message){function initialize(lesdestinataires){if(vm.currentPage=1,vm.mesTableaux=[],vm.totalItems=lesdestinataires.length,vm.totalItems>vm.itemsPerPage){var nbItems=Math.floor(vm.totalItems/nbArrayToDisplay)+1,ldestinataires=lodash.chunk(lesdestinataires,nbItems);vm.totalItemsTableau=ldestinataires[0].length,lodash.forEach(ldestinataires,function(value){vm.mesTableaux.push(lodash.chunk(value,vm.itemsPerPage))})}else vm.totalItemsTableau=vm.totalItems,vm.mesTableaux.push(lodash.chunk(lesdestinataires,vm.itemsPerPage));vm.csscolmd=vm.mesTableaux.length,1===vm.mesTableaux.length?vm.csscolmd=12:2===vm.mesTableaux.length?vm.csscolmd=6:vm.csscolmd=4}function filtreResultats(){if(""!==vm.searchDestinataire){var resultats=lodash.filter(destinataires,function(undestinataire){return lodash.includes($filter("displayNom")(undestinataire,!1,!1).toLowerCase(),vm.searchDestinataire.toLowerCase())});initialize(resultats.length>0?resultats:destinataires)}else initialize(destinataires)}var vm=this;vm.Utils=Utils,vm.totalInitialItems=destinataires.length,vm.itemsPerPage=15;var nbArrayToDisplay=3;vm.searchDestinataire="",vm.message=message,vm.filtreResultats=filtreResultats,initialize(destinataires)}]),angular.module("edsiteApp.messagerie").controller("MessagerieParametresCtrl",["$rootScope","$scope","MessagerieService","ParametrageService","Notification","Auth","ModuleService",function($rootScope,$scope,MessagerieService,ParametrageService,Notification,Auth,ModuleService){function saveSignature(){$scope.promiseRequestLoading=MessagerieService.saveSignatureMessage($scope.CtrlCommunMessagerie.signatureMessage.content).then(function(_data){Notification.notify("Paramètrage","L'enregistrement de votre signature a bien été effectué","success","fa fa-envelope"),$scope.CtrlCommunMessagerie.reloadSignatureMessage()},function(error){})}function updateEstEnBlackList(){var cValue="0";$scope.CtrlCommunMessagerie.parametrages.estEnBlackList===!0&&(cValue="1"),ParametrageService.updateParametrageIndividuel($scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.typeUser,"estEnBlackList",cValue).then(function(_data){var message="Modification prise en compte";Notification.notify("Paramètrage",message,"success","fa fa-envelope")},function(error){})}function envoyerTestMailNotification(){$scope.CtrlCommunMessagerie.promiseRequestLoading=MessagerieService.envoyerTestMailNotification($scope.CtrlCommunMessagerie.typeUser,$scope.CtrlCommunMessagerie.idUser).then(function(_data){var message="Mail de notification envoyé avec succès à l'adresse "+getEmailPourNotification();Notification.notify("Notification",message,"success","fa fa-envelope")},function(error){})}function isButtonTestMailNotificationEnabled(){var emailAUtiliser=getEmailPourNotification();return angular.isDefined(emailAUtiliser)&&emailAUtiliser.length>0}function getEmailPourNotification(){return isChoixMailProNotification()?$scope.CtrlCommunMessagerie.parametrages.mailPro:isChoixMailPersoNotification()?$scope.CtrlCommunMessagerie.parametrages.mailPerso:isChoixMailAutreNotification()?$scope.CtrlCommunMessagerie.parametrages.autreMailNotification:void 0}function updateMailAutreNotification(event){var mailAutre=$scope.CtrlCommunMessagerie.parametrages.autreMailNotification;angular.isDefined(mailAutre)&&""!==mailAutre&&($scope.CtrlCommunMessagerie.promiseRequestLoading=ParametrageService.updateParametrageIndividuel($scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.typeUser,"NotificationEmailAutre",mailAutre).then(function(_data){var message="Adresse email autre pour notification mise à jour";Notification.notify("Notification",message,"success","fa fa-envelope")},function(error){}))}function updateChoixMailNotification(){$scope.CtrlCommunMessagerie.promiseRequestLoading=ParametrageService.updateParametrageIndividuel($scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.typeUser,"NotificationEmailDest",$scope.CtrlCommunMessagerie.parametrages.choixMailNotification).then(function(_data){var message="Type de mail de notification mis à jour";Notification.notify("Notification",message,"success","fa fa-envelope")},function(error){})}function isChoixMailAutreNotification(){return 3===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification}function isChoixMailProNotification(){return 0!==$scope.CtrlCommunMessagerie.parametrages.choixMailNotification||Auth.isEleve()||($scope.CtrlCommunMessagerie.parametrages.choixMailNotification=1),1===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification||0===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification&&!Auth.isEleve()?!0:!1}function isChoixMailPersoNotification(){return 0===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification&&(Auth.isFamille()||Auth.isEleve())&&($scope.CtrlCommunMessagerie.parametrages.choixMailNotification=2),2===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification||0===$scope.CtrlCommunMessagerie.parametrages.choixMailNotification&&(Auth.isFamille()||Auth.isEleve())?!0:!1}function updateReceiveNotif(){var cValue="0";$scope.CtrlCommunMessagerie.parametrages.disabledNotification===!0&&(cValue="1"),ParametrageService.updateParametrageIndividuel($scope.CtrlCommunMessagerie.idUser,$scope.CtrlCommunMessagerie.typeUser,"PasDeNotificationEmail",cValue).then(function(data){var message="Notification par email désactivée";"0"===data.value&&(message="Notification par email activée"),Notification.notify("Notification",message,"success","fa fa-envelope")},function(error){})}var vm=this;vm.Auth=Auth;var paramModules=ModuleService.getModule(ModuleService.CODES.MESSAGERIE),prolexisEnable="1"===paramModules.params.prolexisEnable;vm.editorOptions={height:200,toolbar:"full",extraPlugins:"colorbutton,font,base64image,DiagPlWs",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]},{name:"links",items:["Link","Unlink","base64image"]}],removePlugins:"elementspath",startupFocus:!0},prolexisEnable&&vm.editorOptions.toolbar_full.push({name:"correcteur",items:["DiagPlWs"]}),vm.saveSignature=saveSignature,vm.updateEstEnBlackList=updateEstEnBlackList,vm.envoyerTestMailNotification=envoyerTestMailNotification,vm.isButtonTestMailNotificationEnabled=isButtonTestMailNotificationEnabled,vm.updateMailAutreNotification=updateMailAutreNotification,vm.updateChoixMailNotification=updateChoixMailNotification,vm.isChoixMailAutreNotification=isChoixMailAutreNotification,vm.isChoixMailProNotification=isChoixMailProNotification,vm.isChoixMailPersoNotification=isChoixMailPersoNotification,vm.updateReceiveNotif=updateReceiveNotif}]),angular.module("edsiteApp.messagerie").factory("MessagerieService",["$q","$http","$filter","$sessionStorage","lodash","Auth","EDHttp","CacheService","ModuleService",function($q,$http,$filter,$sessionStorage,lodash,Auth,EDHttp,CacheService,ModuleService){function isMessagesTypeStoredInSession(idUser,typeUser,pTypeRecup){var messages=$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()];return angular.isUndefined(messages)?!1:angular.isUndefined(messages[pTypeRecup])||0===messages[pTypeRecup].length?!1:!0}function setMessagesTypeInSession(idUser,typeUser,typeRecup,messages){var options={all:function(idUser,typeUser,typeRecup,messages){$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()]=messages},received:function(idUser,typeUser,typeRecup,messages){$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()].received=messages.received},sent:function(idUser,typeUser,typeRecup,messages){$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()].sent=messages.sent},archived:function(idUser,typeUser,typeRecup,messages){$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()].archived=messages.archived}};angular.isUndefined($sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()])&&($sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()]={}),lodash.has(options,typeRecup)?options[typeRecup](idUser,typeUser,typeRecup,messages):"c_"===typeRecup.substr(0,2)&&($sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()][typeRecup]=messages.received.concat(messages.sent))}var Helper={};return Helper.MODE_EXPEDITEUR="expediteur",Helper.MODE_DESTINATAIRE="destinataire",Helper.ID_DOSSIER_RECEPTION=-1,Helper.ID_DOSSIER_ENVOYE=-2,Helper.ID_DOSSIER_ARCHIVE=-3,Helper.signatureMessage={content:""},Helper.MESSAGERIE_DOSSIER={"-1":"received","-2":"sent","-3":"archived"},Helper.MESSAGERIE_STATE={received:"received",sent:"sent",archived:"archived",settings:"settings",classeur:"classeur"},Helper.INBOX_TITLE={received:"Boîte de réception",sent:"Messages envoyés",archived:"Messages archivés"},Helper.getMessages=function(typeUser,idUser,options,verbe){var defer=$q.defer(),data={anneeMessages:Helper.getChoosenAnneeMessages()},defaultOptions={page:0,itemsPerPage:10,typeRecup:"received",force:!1,orderBy:"date",order:"desc",query:"",onlyRead:"",idClasseur:0},pTypeUser=$filter("translateTypeUserUrl")(typeUser),_options=angular.extend({},defaultOptions,options),typeRecupStorage=_options.typeRecup===Helper.MESSAGERIE_STATE.classeur?"c_"+_options.idClasseur:_options.typeRecup;if(isMessagesTypeStoredInSession(idUser,typeUser,typeRecupStorage)&&!_options.force){var resultFromCache={};resultFromCache.messages=$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()],defer.resolve(resultFromCache)}var methode=angular.isDefined(verbe)?verbe:"GET",pTypeRecupUrlParam="all"===_options.typeRecup?"":_options.typeRecup,baseUrl=pTypeUser+"/"+idUser+"/messages?typeRecuperation="+pTypeRecupUrlParam+"&orderBy="+_options.orderBy+"&order="+_options.order+"&page="+_options.page+"&itemsPerPage="+_options.itemsPerPage+"&onlyRead="+_options.onlyRead+"&query="+_options.query+"&idClasseur="+_options.idClasseur;return $http({method:methode,url:baseUrl,data:data}).success(function(response){setMessagesTypeInSession(idUser,typeUser,typeRecupStorage,response.data.messages),$sessionStorage["cachesMessagesParams-"+idUser+"-"+typeUser]=response.data.parametrage,angular.forEach(response.data.parametrage,function(val,key){val&&Auth.addPermissionToCurrentUser("messagerie-"+key)});var result={};result.messages=$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()],result.pagination=response.data.pagination,result.classeurs=response.data.classeurs,defer.resolve(result)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getMessage=function(typeUser,idUser,idMessage,mode){var defer=$q.defer(),data={anneeMessages:Helper.getChoosenAnneeMessages()},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages/"+idMessage+"?mode="+mode;return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getMessagerieParametrage=function(typeUser,idUser){var defer=$q.defer();return defer.resolve($sessionStorage["cachesMessagesParams-"+idUser+"-"+typeUser]),defer.promise},Helper.getMessagerieParametrageSync=function(typeUser,idUser){return $sessionStorage["cachesMessagesParams-"+idUser+"-"+typeUser]},Helper.markMessageAsRead=function(message,typeUser,idUser){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages/"+message.id,data={action:"marquerCommeLu",anneeMessages:Helper.getChoosenAnneeMessages()};return message.id?($http({method:"PUT",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise):(defer.reject(),defer.promise)},Helper.markMessageAsUnread=function(message,typeUser,idUser){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages/"+message.id,data={action:"marquerCommeNonLu",anneeMessages:Helper.getChoosenAnneeMessages()};return $http({method:"PUT",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.markMessagesAsUnread=function(messages,typeUser,idUser){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages",ids=lodash.pluck(messages,"id"),data={action:"marquerCommeNonLu",ids:ids,anneeMessages:Helper.getChoosenAnneeMessages()};return $http({method:"PUT",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.archiveMessage=function(message,typeUser,idUser,isArchive){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages/"+message.id,data={anneeMessages:Helper.getChoosenAnneeMessages()};return data.action=isArchive?"archiver":"desarchiver",$http({method:"PUT",url:baseUrl,data:data}).success(function(){
defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.archiveMessages=function(messages,typeUser,idUser,isArchive){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages",data={anneeMessages:Helper.getChoosenAnneeMessages()};return data.action=isArchive?"archiver":"desarchiver",data.ids=lodash.pluck(messages,"id"),$http({method:"PUT",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerMessages=function(messages,typeUser,idUser,idDossier){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages",data={anneeMessages:Helper.getChoosenAnneeMessages()};return data.action="supprimer",data.ids=lodash.pluck(messages,"id"),data.idDossier=idDossier,$http({method:"DELETE",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.deplacerMessages=function(messages,typeUser,idUser,idClasseur){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages",data={anneeMessages:Helper.getChoosenAnneeMessages()};return data.action="deplacer",data.ids=[],messages.forEach(function(message){data.ids.push(message.id+":"+message.idDossier)}),data.idClasseur=idClasseur,$http({method:"PUT",url:baseUrl,data:data}).success(function(){defer.resolve()}).error(function(error){defer.reject(error)}),defer.promise},Helper.sendMessage=function(typeUser,idUser,message){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages",newMessage=angular.copy(message);newMessage.content=$filter("base64encode")(newMessage.content);var data={message:newMessage,anneeMessages:""};return $http({method:"POST",url:baseUrl,data:data}).success(function(response){newMessage.id=response.data.id,defer.resolve(newMessage)}).error(function(error){defer.reject(error)}),defer.promise},Helper.setOriginMessage=function(message){$sessionStorage["message-origin"]=message},Helper.getOriginMessage=function(){return $sessionStorage["message-origin"]},Helper.convertToMail=function(typeUser,idUser,message,email){var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/messages/"+message.id,data={anneeMessages:Helper.getChoosenAnneeMessages()};return data.action="convertirMail",data.email=email,$http({method:"PUT",url:baseUrl,data:data})},Helper.getMessageFromStorage=function(typeUser,idUser,idMessage){var messages=$sessionStorage["cachesMessages-"+idUser+"-"+typeUser+"-"+Helper.getChoosenAnneeMessages()],tmpMessages=[];return tmpMessages=tmpMessages.concat(messages.received),tmpMessages=tmpMessages.concat(messages.sent),tmpMessages=tmpMessages.concat(messages.archived),lodash.find(tmpMessages,{id:idMessage})},Helper.getProfsContacts=function(selection){var idEntity=0,typeFilter="idClasse=";selection.classe&&(idEntity=selection.classe.id,"niveau"===selection.classe.optionType&&(typeFilter="idNiveau="),"etab"===selection.classe.optionType&&(typeFilter="idEtab="));var nom=selection.nom||"",baseUrl="";return baseUrl=selection.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?"espaceTravail/contacts/professeurs?"+typeFilter+idEntity+"&nom="+nom:"messagerie/contacts/professeurs?"+typeFilter+idEntity+"&nom="+nom,new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){return response.data.data.contacts})},Helper.getProfsPrincipauxContacts=function(selection){var baseUrl="";return baseUrl=selection.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?"espaceTravail/contacts/professeurs?isPP=1":"messagerie/contacts/professeurs?isPP=1",$http({method:"GET",url:baseUrl,data:{}}).then(function(response){return response.data.data.contacts})},Helper.getPersonnelsContacts=function(selection){var defer=$q.defer(),baseUrl="";return baseUrl=selection.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?"espaceTravail/contacts/personnels":"messagerie/contacts/personnels",new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(){defer.reject()}),defer.promise},Helper.getElevesContacts=function(selection,noRestriction){var defer=$q.defer(),idClasse=0,idGroupe=0,idMatiere=0,codeMatiere="",idEspaceTravail=0,isClasse=selection.classe&&"C"===selection.classe.type;selection.classe&&isClasse&&(idClasse=selection.classe.id),selection.matiere&&(idMatiere=selection.matiere.id,codeMatiere=selection.matiere.code),selection.classe&&!isClasse&&(idGroupe=selection.classe.id);var nom=selection.nom||"",baseUrl="";return angular.isDefined(selection.idEspaceTravail)?(idEspaceTravail=selection.idEspaceTravail,baseUrl="espaceTravail/contacts/eleves?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe+"&idEspace="+idEspaceTravail):angular.isDefined(noRestriction)&&noRestriction&&selection.classes.length>0?(idClasse=0,baseUrl="messagerie/contacts/eleves?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe+"&recupAll=1"):baseUrl="messagerie/contacts/eleves?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe,new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(){defer.reject()}),defer.promise},Helper.getFamillesContacts=function(selection,noRestriction){var defer=$q.defer(),idClasse=0,idGroupe=0,idMatiere=0,codeMatiere="",isClasse=selection.classe&&"C"===selection.classe.type;selection.classe&&isClasse&&(idClasse=selection.classe.id),selection.matiere&&(idMatiere=selection.matiere.id,codeMatiere=selection.matiere.code),selection.classe&&!isClasse&&(idGroupe=selection.classe.id);var nom=selection.nom||"",baseUrl="";return selection.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?baseUrl="espaceTravail/contacts/familles?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe:angular.isDefined(noRestriction)&&noRestriction&&selection.classes&&selection.classes.length>0?(idClasse=0,baseUrl="messagerie/contacts/familles?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe+"&recupAll=1"):baseUrl="messagerie/contacts/familles?idClasse="+idClasse+"&nom="+nom+"&idMatiere="+idMatiere+"&codeMatiere="+codeMatiere+"&idGroupe="+idGroupe,selection.isResponsable&&(baseUrl+="&isResponsable=1"),selection.isAutoriteParentale&&(baseUrl+="&isAutoriteParentale=1"),selection.isAutres&&(baseUrl+="&isAutres=1"),new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(){defer.reject()}),defer.promise},Helper.getEspaceTravailContacts=function(selection){var idEspace;idEspace=angular.isDefined(selection.espaceTravail)?selection.espaceTravail.id:0;var baseUrl="messagerie/contacts/espacesTravail?idEspace="+idEspace;return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){return response.data.data.contacts})},Helper.removeCacheListeContacts=function(){CacheService.remove("messagerie/contacts/listesContacts")},Helper.getListesContacts=function(forceReload){var defer=$q.defer(),baseUrl="messagerie/contacts/listesContacts";return forceReload===!0&&Helper.removeCacheListeContacts(),new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(){defer.reject()}),defer.promise},Helper.createListeContacts=function(libelleListe,tabContacts){var defer=$q.defer(),baseUrl="messagerie/contacts/listesContacts";return new EDHttp({method:"POST",url:baseUrl,data:{libelle:libelleListe,contacts:tabContacts}}).then(function(response){defer.resolve(response.data)},function(){defer.reject()}),defer.promise},Helper.deleteListeContacts=function(idListeContacts){var defer=$q.defer(),baseUrl="messagerie/contacts/listesContacts";return new EDHttp({method:"DELETE",url:baseUrl,data:{idListeContacts:idListeContacts}}).then(function(response){defer.resolve(response.data)},function(){defer.reject()}),defer.promise},Helper.displayMatiere=function(destinataire,classe){return destinataire||classe?classe&&"classe"===classe.optionType?lodash.pluck(lodash.filter(destinataire.classes,{id:classe.id}),"matiere").join(", "):lodash.uniq(lodash.pluck(destinataire.classes,"matiere")).join(", "):""},Helper.isPP=function(destinataire,classe){return destinataire?classe?"niveau"===classe.optionType?destinataire.isPP:"etab"===classe.optionType?destinataire.isPP:angular.isDefined(lodash.find(destinataire.classes,{id:classe.id,isPP:!0})):angular.isDefined(lodash.find(destinataire.classes,{isPP:!0})):!1},Helper.envoyerTestMailNotification=function(typeUser,idUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/testMailNotification";return $http({method:"POST",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.setChoosenAnneeMessages=function(annee){annee&&($sessionStorage.anneeMessagesCourant=annee)},Helper.getChoosenAnneeMessages=function(){return $sessionStorage.anneeMessagesCourant},Helper.getAnneesMessagesArchive=function(){var anneeScolaireCourante=Auth.anneeScolaireCourante(),resultat=[anneeScolaireCourante],dates=anneeScolaireCourante.split("-"),oldAnnee=parseInt(dates[0])-1+"-"+(parseInt(dates[1])-1);return resultat.unshift(oldAnnee),resultat},Helper.saveSignatureMessage=function(value){var defer=$q.defer(),baseUrl="signatureMessage",data={value:value};return CacheService.removeMatch(/signatureMessage/),$http({method:"PUT",url:baseUrl,data:data}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error)}),defer.promise},Helper.getSignatureMessage=function(){var defer=$q.defer(),baseUrl="signatureMessage",data={};return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error)}),defer.promise},Helper._signatureMessage=function(){return Helper.signatureMessage},Helper._contentSignatureMessage=function(contentSignature){return Helper.signatureMessage.content=contentSignature},Helper.convertUserToContact=function(user){var contact={};return contact.id=user.id||user.idMembre,contact.civilite=user.civilite||"",contact.nom=user.nom,contact.prenom=user.prenom,contact.particule=user.particule||"",contact.to_cc_cci="to",contact.type=user.type||user.profil||"",angular.isDefined(user.responsable)&&(contact.responsable=user.responsable),angular.isDefined(user.classe)&&(contact.classe=user.classe),angular.isDefined(user.classeId)&&(contact.classe={id:user.classeId,code:"",libelle:user.classeLibelle},""===contact.type&&(contact.type="E")),contact},Helper.canSendMessageUser=function(typeUserDest){var params=Helper.getMessagerieParametrageSync(Auth.currentUser().typeCompte,Auth.currentUser().id);if(angular.isUndefined(params)&&(params=ModuleService.getModule(ModuleService.CODES.MESSAGERIE,Auth.currentUser().id).params),angular.isUndefined(params)||"1"!==params.isActif&&params.isActif!==!0)return!1;switch(typeUserDest){case Auth.TYPE_USER.ELEVE:return"1"===params.destEleve||params.destEleve===!0;case Auth.TYPE_USER.FAMILLE_RESPONSABLE:case Auth.TYPE_USER.FAMILLE_CONJOINT:return"1"===params.destFamille||params.destFamille===!0;case Auth.TYPE_USER.ENSEIGNANT:return"1"===params.destProf||params.destProf===!0;case Auth.TYPE_USER.PERSONNEL:return"1"===params.destAdmin||params.destAdmin===!0;case Auth.TYPE_USER.ESPACE_TRAVAIL:return"1"===params.destEspTravail||params.destEspTravail===!0;default:return!1}},Helper.pieceJointeToCloud=function(idMessage,idPJ){var defer=$q.defer();if(angular.isUndefined(idMessage)||angular.isUndefined(idPJ))return defer.reject("Une erreur s'est produite"),defer.promise;var baseUrl="televersement?mode=PJ_TO_CLOUD&idMessage="+idMessage+"&idPJ="+idPJ,data={};return new EDHttp({method:"POST",url:baseUrl,data:data,cache:!0}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error.data)}),defer.promise},Helper.createClasseur=function(libelleClasseur){var defer=$q.defer();if(angular.isUndefined(libelleClasseur)||""===libelleClasseur)return defer.reject("Le libellé du classeur ne doit pas être vide"),defer.promise;var baseUrl="messagerie/classeurs",data={libelle:libelleClasseur};return new EDHttp({method:"POST",url:baseUrl,data:data,cache:!0}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error.data)}),defer.promise},Helper.updateClasseur=function(classeur){var defer=$q.defer();if(angular.isUndefined(classeur.libelle)||""===classeur.libelle.libelleeur)return defer.reject("Le libellé du classeur ne doit pas être vide"),defer.promise;var baseUrl="messagerie/classeur/"+classeur.id,data=classeur;return new EDHttp({method:"PUT",url:baseUrl,data:data,cache:!0}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error.data)}),defer.promise},Helper.deleteClasseur=function(classeur){var defer=$q.defer();if(angular.isUndefined(classeur)||0===classeur.id)return defer.reject("Suppression impossible"),defer.promise;var baseUrl="messagerie/classeur/"+classeur.id,data={};return new EDHttp({method:"DELETE",url:baseUrl,data:data,cache:!0}).then(function(data){defer.resolve(data.data)},function(error){defer.reject(error.data)}),defer.promise},Helper}]),angular.module("edsiteApp.messagerie").controller("MessagerieComposeCtrl",["$scope","$window","$uibModal","$filter","$routeParams","$location","lodash","Auth","$sessionStorage","MessagerieService","Settings","Notification","moment","ModuleService","$q",function($scope,$window,$uibModal,$filter,$routeParams,$location,lodash,Auth,$sessionStorage,MessagerieService,Settings,Notification,moment,ModuleService,$q){function aucunA(groupes){if(!groupes||0===groupes.length)return!0;for(var resultat=!0,i=0;i<groupes.length;i++){for(var lesDest=groupes[i].destinataires,j=0;j<lesDest.length;j++){var dest=lesDest[j];if("to"===dest.to_cc_cci){resultat=!1;break}}if(!resultat)break}return resultat}function aucunDestinataire(groupes){if(!groupes||0===groupes.length)return!0;for(var resultat=!0,i=0;i<groupes.length;i++){for(var lesDest=groupes[i].destinataires,j=0;j<lesDest.length;j++){resultat=!1;break}if(!resultat)break}return resultat}function showCcCci(mode){"cc"===mode&&($scope.displayCC=!0),"cci"===mode&&($scope.displayCCI=!0)}function init(){$scope.listePromises.push(MessagerieService.getMessagerieParametrage($scope.typeUser,$scope.idUser).then(function(params){$scope.parametrage=params},function(error){})),(Auth.isProfesseur()||Auth.isPersonnel())&&$scope.listePromises.push(MessagerieService.getSignatureMessage().then(function(laSignature){MessagerieService._contentSignatureMessage(laSignature.signature),$scope.signatureMessage="<br>"+MessagerieService._signatureMessage().content},function(error){})),$scope.promiseLoading=$q.all($scope.listePromises).then(function(){$scope.message.content=$scope.signatureMessage,$routeParams.forward?handleForwardMessage():$routeParams.responseSimple?handleResponseMessage(!1):$routeParams.responseAll&&handleResponseMessage(!0)})}function processingEvent(){$scope.processingFiles++}function completeEvent(){$scope.processingFiles--}function backToInbox(form){if(form.$dirty||$scope.message.groupesDestinataires.length>0){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Annuler le message",config.message="Êtes vous sûr de vouloir annuler ce message ?",config.confirm="Oui",config.cancel="Non",config.warningButton="OK",config}}});modalInstance.result.then(function(){callHistroy()})}else callHistroy()}function callHistroy(){$routeParams.messageId?$location.path("/"+$scope.typeUser+"/"+$scope.idUser+"/Messagerie").search({messageId:$routeParams.messageId}):$window.history.back()}function composeSelectionEnseignant(toCcCci,opts,destinataires){var classes=[];Auth.isPersonnel()||Auth.isProfesseur()||(classes=Auth.getClasses());var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.enseignant.template.html",controller:"MessageComposeSelectionEnseignantCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-enseignant",resolve:{options:function(){var options={};return options.classes=classes,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(self.addGroupeDestinataire)}function composeSelectionEleve(toCcCci,opts,destinataires){var classes=[];Auth.isPersonnel()||Auth.isProfesseur()||(classes=Auth.getClasses());var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.eleve.template.html",controller:"MessageComposeSelectionEleveCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-eleve",resolve:{options:function(){var options={};return options.classes=classes,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(self.addGroupeDestinataire)}function composeSelectionPersonnel(toCcCci,opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.personnel.template.html",controller:"MessageComposeSelectionPersonnelCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-personnel",resolve:{options:function(){var options={};return angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(self.addGroupeDestinataire)}function composeSelectionFamille(toCcCci,opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.famille.template.html",controller:"MessageComposeSelectionFamilleCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-famille",resolve:{options:function(){var options={};return angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(self.addGroupeDestinataire)}function composeSelectionEspaceTravail(toCcCci,opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.espaceTravail.template.html",controller:"MessageComposeSelectionEspaceTravailCtrl",controllerAs:"MessageComposeSelectionEspTravailCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-espTravail",resolve:{options:function(){var options={};return angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(self.addGroupeDestinataire)}function composeSelectionListeContacts(toCcCci,opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.listeContacts.template.html",controller:"MessageComposeSelectionListeContactsCtrl",controllerAs:"MessageComposeSelectionListeContactsCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-listeContacts",resolve:{options:function(){var options={};return angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(function(tabGroupesDestinataires){tabGroupesDestinataires.forEach(function(groupe){self.addGroupeDestinataire(groupe)})})}function addGroupeDestinataire(groupe){var groupeDestinataire={};return groupeDestinataire.destinataires=angular.copy(groupe.destinataires),groupeDestinataire.selection=angular.copy(groupe.selection),$scope.message.groupesDestinataires.push(groupeDestinataire),groupeDestinataire}function showSelection(destinataires,toCcCci){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.liste.template.html",controller:"MessageComposeShowListCtrl",size:"lg",resolve:{destinataires:function(){return angular.isUndefined(toCcCci)||""===toCcCci?destinataires:lodash.filter(destinataires,{to_cc_cci:toCcCci})}}});modalInstance.result.then(function(destinatairesToDelete){lodash.each($scope.message.groupesDestinataires,function(groupeDest){lodash.remove(groupeDest.destinataires,function(dest){var found;return found=angular.isUndefined(toCcCci)||""===toCcCci?lodash.find(destinatairesToDelete,{id:dest.id}):lodash.find(destinatairesToDelete,{id:dest.id,to_cc_cci:toCcCci}),void 0!==found})}),cleanTags()},function(){cleanTags()})}function moveSelection(groupe,oldMode,newMode){lodash.each(groupe.destinataires,function(dest){dest.to_cc_cci===oldMode&&(dest.to_cc_cci=newMode),"cc"!==newMode||$scope.displayCC||($scope.displayCC=!0),"cci"!==newMode||$scope.displayCCI||($scope.displayCCI=!0)})}function cleanTags(){lodash.remove($scope.message.groupesDestinataires,function(groupeDest){return lodash.isEmpty(groupeDest.destinataires)})}function showAllSelection(groupesDestinataires){var mergedDestinataires=lodash.chain(groupesDestinataires).pluck("destinataires").flatten().value();$scope.showSelection(mergedDestinataires,"")}function deleteSelectionGroupe(groupe,mode){var idx=$scope.message.groupesDestinataires.indexOf(groupe);if(idx>-1){for(var i=$scope.message.groupesDestinataires[idx].destinataires.length;i>0;){i--;var dest=$scope.message.groupesDestinataires[idx].destinataires[i];dest.to_cc_cci===mode&&$scope.message.groupesDestinataires[idx].destinataires.splice(i,1)}0===$scope.message.groupesDestinataires[idx].destinataires.length&&$scope.message.groupesDestinataires.splice(idx,1)}}function sendMessage(message){encours||(encours=!0,$scope.prolexisEnable&&angular.isDefined(CKEDITOR.instances.content)&&(message.content=CKEDITOR.instances.content.getData()),$sessionStorage.temp=message,message.files=$scope.fichiers,message.files=message.files.concat($scope.fichiersOrigin),$scope.promiseLoading=MessagerieService.sendMessage($scope.typeUser,$scope.idUser,message).then(function(){encours=!1,Notification.notify("Message","Votre message a bien été envoyé","success","fa icon-ed_messagerie");var typeUser=$routeParams.typeUser;"familles"===typeUser&&(typeUser=Auth.role()),$location.path("/"+typeUser+"/"+$routeParams.idUser+"/Messagerie")},function(err){if(encours=!1,err&&angular.isDefined(err)&&angular.isDefined(err.code)&&575===err.code)Notification.notify("Message",err.message,"error","fa icon-ed_messagerie");else{Notification.notify("Message","Une erreur s'est produite lors de l'envoi de votre message. Vérifiez dans vos messages envoyés que le message n'a pas été envoyé tout de même.","error","fa icon-ed_messagerie");var typeUser=$routeParams.typeUser;"familles"===typeUser&&(typeUser=Auth.role()),$location.path("/"+typeUser+"/"+$routeParams.idUser+"/Messagerie")}}))}function handleForwardMessage(){var message=MessagerieService.getOriginMessage();$scope.titrePage="Transfert de : ["+message.subject+"]";var identite=$filter("displayNom")(message.from,!1,!0);message.from.fonctionPersonnel&&(identite=identite+" ("+message.from.fonctionPersonnel+")");var from="<br/><b>De "+identite+"</b> <i>("+moment(message.date).format("[le] dddd DD MMMM YYYY à HH:mm:ss")+")</i>";$scope.message.content=from+"\n<blockquote>"+$filter("base64decode")(message.content)+"</blockquote>",$scope.message.subject="Transfert de : ["+message.subject+"]",$scope.message.forwardId=message.id,$scope.message.idDossier=message.idDossier,$scope.fichiersOrigin=message.files||[]}function handleResponseMessage(all){var message=MessagerieService.getOriginMessage();$scope.titrePage="Re: ["+message.subject+"]";var identite=$filter("displayNom")(message.from,!1,!0);message.from.fonctionPersonnel&&(identite=identite+" ("+message.from.fonctionPersonnel+")");var from="<br/><b>De "+identite+"</b> <i>("+moment(message.date).format("[le] dddd DD MMMM YYYY à HH:mm:ss")+")</i>";if($scope.message.content=$scope.signatureMessage+from+"\n<blockquote>"+$filter("base64decode")(message.content)+"</blockquote>",$scope.message.subject="Re: ["+message.subject+"]",$scope.message.responseId=message.id,message.from){var from={to_cc_cci:"to",type:message.from.role,id:message.from.id,isSelected:!0,nom:message.from.nom,prenom:message.from.prenom,particule:message.from.particule,civilite:message.from.civilite};from.fonction={id:0,libelle:""},from.type===Auth.TYPE_USER.PERSONNEL&&(from.fonction.libelle=message.from.fonctionPersonnel),from.classe={id:0,libelle:"",code:""},from.type===Auth.TYPE_USER.ELEVE&&(from.classe.libelle=message.from.fonctionPersonnel),from.classes=[],from.isPP=!1,from.responsable={id:0,typeResp:"",versQui:"",contacts:[]};var groupeDestinataireExp={destinataires:[from],selection:{type:from.type}};$scope.message.groupesDestinataires.push(groupeDestinataireExp)}if(all&&message.to&&message.to.length>0){var isCC=!1,groupeE={destinataires:[],selection:{type:Auth.TYPE_USER.ELEVE}},groupeP={destinataires:[],selection:{type:Auth.TYPE_USER.ENSEIGNANT}},groupeA={destinataires:[],selection:{type:Auth.TYPE_USER.PERSONNEL}},groupeF={destinataires:[],selection:{type:Auth.TYPE_USER.FAMILLE}};angular.forEach(message.to,function(toOrigin){if(Auth.role()!==toOrigin.role||Auth.idUser()!==toOrigin.id){"cc"===toOrigin.to_cc_cci&&(isCC=!0);var to={to_cc_cci:toOrigin.to_cc_cci,type:toOrigin.role,id:toOrigin.id,isSelected:!0,nom:toOrigin.nom,prenom:toOrigin.prenom,particule:toOrigin.particule,civilite:toOrigin.civilite};to.fonction={id:0,libelle:""},to.type===Auth.TYPE_USER.PERSONNEL&&toOrigin.fonctionPersonnel&&(to.fonction.libelle=toOrigin.fonctionPersonnel),to.classe={id:0,libelle:"",code:""},to.type===Auth.TYPE_USER.ELEVE&&toOrigin.fonctionPersonnel&&(to.classe.libelle=toOrigin.fonctionPersonnel),to.classes=[],to.isPP=!1,to.responsable={id:0,typeResp:"",versQui:"",contacts:[]},to.type===Auth.TYPE_USER.ELEVE?groupeE.destinataires.push(to):to.type===Auth.TYPE_USER.ENSEIGNANT?groupeP.destinataires.push(to):to.type===Auth.TYPE_USER.PERSONNEL?groupeA.destinataires.push(to):(to.type===Auth.TYPE_USER.FAMILLE_RESPONSABLE||to.type===Auth.TYPE_USER.FAMILLE_CONJOINT)&&groupeF.destinataires.push(to)}}),groupeP.destinataires.length>0&&$scope.message.groupesDestinataires.push(groupeP),groupeA.destinataires.length>0&&$scope.message.groupesDestinataires.push(groupeA),groupeF.destinataires.length>0&&$scope.message.groupesDestinataires.push(groupeF),groupeE.destinataires.length>0&&$scope.message.groupesDestinataires.push(groupeE),$scope.displayCC=isCC}}function showModalCreateListeContact(toCcCci){var modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Nouvelle liste de contacts",config.message="Nom de la liste de contacts à créer",config.confirm="Valider",config.cancel="Annuler",config.value="",config}}});modalInstance.result.then(function(libelleListe){if(""===libelleListe)Notification.notify("Erreur","Vous devez saisir un nom pour la liste de contacts à créer","danger");else{var dests=angular.copy($scope.message.groupesDestinataires);lodash.map(dests,function(groupe){groupe.destinataires=lodash.filter(groupe.destinataires,{to_cc_cci:toCcCci})}),$scope.promiseLoading=MessagerieService.createListeContacts(libelleListe,dests).then(function(){Notification.notify("Messagerie","La liste de contacts a été créée","success"),MessagerieService.removeCacheListeContacts(),modalInstance.close()},function(err){Notification.notify("Erreur","La création de liste de contacts a échouée","danger")})}})}$scope.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),$scope.idUser=$routeParams.idUser,$scope.message={},$scope.parametrage={},$scope.message.groupesDestinataires=[],$scope.fichiers=[],$scope.fichiersOrigin=[],$scope.displayCC=!1,$scope.displayCCI=!1,$scope.titrePage="Nouveau message",$scope.listePromises=[],$scope.signatureMessage="",this.addGroupeDestinataire=addGroupeDestinataire;var self=this,paramModules=ModuleService.getModule(ModuleService.CODES.MESSAGERIE),encours=!1;$scope.editorOptions={height:250,line_height:"1px;1;2px;1.4px;1.5px;2px;",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image,DiagPlWs",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"links",items:["Link","Unlink","base64image"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]}],removePlugins:"elementspath",startupFocus:!0},$scope.prolexisEnable="1"===paramModules.params.prolexisEnable,$scope.prolexisEnable&&$scope.editorOptions.toolbar_full.push({name:"correcteur",items:["DiagPlWs"]});var editor=CKEDITOR.instances.Description;editor&&editor.destroy(!0),CKEDITOR.on("instanceDestroyed",function(){CKEDITOR.replace("someId")}),$scope.configInputFile={keepComplete:!0,dropzoneContainer:"#container-messagerie-compose"},$scope.configInputFile.fromCloudEnabled=ModuleService.isModuleEnabled(ModuleService.CODES.CLOUD)&&Auth.role()!==Auth.TYPE_USER.FAMILLE_RESPONSABLE&&Auth.role()!==Auth.TYPE_USER.FAMILLE_CONJOINT,$scope.processingFiles=0,$scope.dropzoneConfig={url:Settings.apiUri+"televersement.awp",timeout:3e6,maxFilesize:100,processing:processingEvent,complete:completeEvent},$scope.backToInbox=backToInbox,$scope.sendMessage=sendMessage,$scope.showAllSelection=showAllSelection,$scope.deleteSelectionGroupe=deleteSelectionGroupe,$scope.showSelection=showSelection,$scope.moveSelection=moveSelection,$scope.composeSelectionEnseignant=composeSelectionEnseignant,$scope.composeSelectionEleve=composeSelectionEleve,$scope.composeSelectionPersonnel=composeSelectionPersonnel,$scope.composeSelectionFamille=composeSelectionFamille,$scope.composeSelectionEspaceTravail=composeSelectionEspaceTravail,$scope.composeSelectionListeContacts=composeSelectionListeContacts,$scope.showCcCci=showCcCci,$scope.aucunA=aucunA,$scope.aucunDestinataire=aucunDestinataire,$scope.showModalCreateListeContact=showModalCreateListeContact,init()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeShowListCtrl",["$scope","$uibModalInstance","lodash","destinataires","Auth","MessagerieService",function($scope,$uibModalInstance,lodash,destinataires,Auth,MessagerieService){function closeModal(){$uibModalInstance.close($scope.removedDestinatairesList)}function removeEnseignant(dest){var destinatairesRemoved=lodash.remove($scope.destinataires.enseignants,{id:dest.id});angular.isDefined(destinatairesRemoved[0])&&$scope.removedDestinatairesList.push(destinatairesRemoved[0])}function removeEleve(dest){var destinatairesRemoved=lodash.remove($scope.destinataires.eleves,{id:dest.id});angular.isDefined(destinatairesRemoved[0])&&$scope.removedDestinatairesList.push(destinatairesRemoved[0])}function removePersonnel(dest){var destinatairesRemoved=lodash.remove($scope.destinataires.personnels,{id:dest.id});angular.isDefined(destinatairesRemoved[0])&&$scope.removedDestinatairesList.push(destinatairesRemoved[0])}function removeFamille(dest){var destinatairesRemoved=lodash.remove($scope.destinataires.familles,{id:dest.id});angular.isDefined(destinatairesRemoved[0])&&$scope.removedDestinatairesList.push(destinatairesRemoved[0])}function reloadTypes(){$scope.destinataires.enseignants=lodash.uniq(lodash.filter(destinataires,{type:Auth.TYPE_USER.ENSEIGNANT}),"id"),$scope.destinataires.personnels=lodash.uniq(lodash.filter(destinataires,{type:Auth.TYPE_USER.PERSONNEL}),"id"),$scope.destinataires.eleves=lodash.uniq(lodash.filter(destinataires,{type:Auth.TYPE_USER.ELEVE}),"id"),$scope.destinataires.familles=lodash.uniq(lodash.filter(destinataires,{
type:Auth.TYPE_USER.FAMILLE}),function(dest){return dest.responsable.id})}$scope.removedDestinatairesList=[],$scope.close=closeModal,$scope.removeEnseignant=removeEnseignant,$scope.removeEleve=removeEleve,$scope.removePersonnel=removePersonnel,$scope.removeFamille=removeFamille,$scope.displayMatiere=MessagerieService.displayMatiere,$scope.destinataires={},reloadTypes()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionEnseignantCtrl",["$scope","$uibModalInstance","options","destinataires","toCcCci","MessagerieService","lodash","Auth","UserService",function($scope,$uibModalInstance,options,destinataires,toCcCci,MessagerieService,lodash,Auth,UserService){function close(){$uibModalInstance.dismiss()}function getAllPP(){$scope.showallPP=!0,$scope.selection.isPP=!1,$scope.promiseLoading=MessagerieService.getProfsPrincipauxContacts($scope.selection).then(function(contacts){$scope.destinatairesCache=angular.copy(contacts),$scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.ENSEIGNANT})})}function getClasses(){Auth.isPersonnel()||Auth.isProfesseur()?$scope.promiseLoading=UserService.getClassesAllByNiveauxByEtabs().then(function(etabs){etabs=lodash.uniq(etabs,function(etab){return etab.etabId+"_"+etab.niveauId+"_"+etab.classeId}),$scope.etablissements=etabs,$scope.etablissements.unshift({optionLibelle:"Tous les profs des établissements",id:0,optionType:"etab"})}):$scope.selection.classes=Auth.getClasses(),1===$scope.selection.classes.length&&($scope.selection.classe=$scope.selection.classes[0])}$scope.classes=options.classes,$scope.selection=options,$scope.destinatairesCache=[],$scope.destinataires=destinataires||[],$scope.displayedDestinataires=[].concat($scope.destinataires),$scope.oneIsSelected=!1,$scope.requestLoading=!1,$scope.showallPP=!1,this.objDestinataires={};var self=this;$scope.close=close,$scope.getAllPP=getAllPP,$scope.isPP=MessagerieService.isPP,$scope.displayMatiere=MessagerieService.displayMatiere,options.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.btnLibelleAjout="Ajouter les membres sélectionnés":$scope.btnLibelleAjout="Ajouter les destinataires sélectionnés",$scope.classe&&($scope.selection.classe=lodash.find(options.classes,{libelle:options.classe.libelle})),$scope.search=function(force){$scope.showallPP=!1,$scope.selection.isPP=!1,$scope.requestLoading=!0,$scope.promiseLoading=MessagerieService.getProfsContacts($scope.selection).then(function(contacts){$scope.destinatairesCache=angular.copy(contacts),$scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.ENSEIGNANT,dest.isSelected=!1}),$scope.requestLoading=!1},function(){$scope.requestLoading=!1}),$scope.selection.classe&&($scope.destinataires=lodash.where($scope.destinataires,{classe:{id:$scope.selection.classe.id}}))},$scope.filterPP=function(){$scope.selection.isPP&&angular.isUndefined($scope.selection.classe.optionType)?$scope.destinataires=lodash.filter($scope.destinataires,{classes:[{isPP:!0}]}):$scope.selection.isPP&&"classe"===$scope.selection.classe.optionType?$scope.destinataires=lodash.filter($scope.destinataires,{classes:[{isPP:!0}]}):!$scope.selection.isPP||"niveau"!==$scope.selection.classe.optionType&&"etab"!==$scope.selection.classe.optionType?$scope.destinataires=angular.copy($scope.destinatairesCache):$scope.destinataires=lodash.filter($scope.destinataires,{classes:[{isPP:!0}]})},$scope.addGroupeDestinataire=function(destinataires,selection){self.objDestinataires.destinataires=lodash.filter(destinataires,{isSelected:!0}),self.objDestinataires.selection=selection,self.objDestinataires.selection.type=Auth.TYPE_USER.ENSEIGNANT,$uibModalInstance.close(self.objDestinataires)},$scope.selectDestinataire=function(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter($scope.destinataires,{isSelected:!0});$scope.oneIsSelected=selectedDest&&selectedDest.length>0?!0:!1},$scope.selectAll=function(isSelectAll){angular.forEach($scope.destinataires,function(dest){dest.isSelected=isSelectAll,$scope.selectDestinataire(dest)})},$scope.selectEtab=function(etab){$scope.selection.classe=etab,$scope.search()},$scope.selectNiveau=function(niveau){$scope.selection.classe=niveau,$scope.search()},$scope.selectClasse=function(classe){$scope.selection.classe=classe,$scope.search()},getClasses(),$scope.search()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionEleveCtrl",["$rootScope","$scope","$uibModalInstance","options","destinataires","toCcCci","MessagerieService","lodash","Auth","UserService",function($rootScope,$scope,$uibModalInstance,options,destinataires,toCcCci,MessagerieService,lodash,Auth,UserService){function close(){$uibModalInstance.dismiss()}function canSearch(){return!lodash.isUndefined($scope.selection.classes)||!lodash.isUndefined($scope.selection.nom)||!lodash.isEmpty($scope.selection.matiere)}function search(force){if(force=force||!1,(!lodash.isEmpty($scope.selection.classes)||!lodash.isEmpty($scope.selection.matiere)||force!==!1)&&($scope.requestLoading=!0,$scope.promiseLoading=MessagerieService.getElevesContacts($scope.selection,$scope.selectAllClasse).then(function(contacts){if($scope.promiseLoading=void 0,$scope.selection.classes.length>0){var lesClasses=lodash.filter($scope.selection.classes,{type:"C"}),lesGroupes=lodash.filter($scope.selection.classes,{type:"G"}),lesDestinataires=[];lesDestinataires=lesDestinataires.concat(lodash.filter(contacts,function(dest){return lodash.find(lesClasses,{id:dest.classe.id})})),lesDestinataires=lesDestinataires.concat(lodash.filter(contacts,function(dest){var estDedans=!1;return lodash.forEach(dest.groupes,function(grp){angular.isDefined(lodash.find(lesGroupes,{id:grp.id}))&&(estDedans=!0)}),estDedans})),contacts=lesDestinataires}if($scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.ELEVE,dest.isSelected=!1}),$scope.requestLoading=!1,angular.isDefined($scope.selection.classes)&&null!==$scope.selection.classes){var periodes=angular.copy(lodash.chain($scope.selection.classes).pluck("periodes").flatten().valueOf());lodash.forEach(periodes,function(periode){angular.isDefined(periode)&&angular.isDefined(periode.matieres)&&(periode.matieres=lodash.map(periode.matieres,function(mat){return mat.libellePeriode=periode.libelle,mat}))}),$scope.matieres=lodash.chain(periodes).pluck("matieres").flatten().uniq("code").valueOf()}},function(){$scope.requestLoading=!1}),$scope.selection.classes.length>0)){var lesClasses=lodash.filter($scope.selection.classes,{type:"C"}),lesGroupes=lodash.filter($scope.selection.classes,{type:"G"}),lesDestinataires=[];lesDestinataires=lesDestinataires.concat(lodash.filter($scope.destinataires,function(dest){return lodash.find(lesClasses,{id:dest.classe.id})})),lesDestinataires=lesDestinataires.concat(lodash.filter($scope.destinataires,function(dest){var estDedans=!1;return lodash.forEach(dest.groupes,function(grp){angular.isDefined(lodash.find(lesGroupes,{id:grp.id}))&&(estDedans=!0)}),estDedans})),$scope.destinataires=lesDestinataires}}function addGroupeDestinataire(destinataires,selection){self.objDestinataires.destinataires=lodash.filter(destinataires,{isSelected:!0}),self.objDestinataires.selection=selection,self.objDestinataires.selection.type=Auth.TYPE_USER.ELEVE,$uibModalInstance.close(self.objDestinataires)}function selectDestinataire(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter($scope.destinataires,{isSelected:!0});$scope.oneIsSelected=selectedDest&&selectedDest.length>0?!0:!1}function selectAll(isSelectAll){angular.forEach($scope.destinataires,function(dest){dest.isSelected=isSelectAll,$scope.selectDestinataire(dest)})}function getClasses(){Auth.role()===Auth.TYPE_USER.ENSEIGNANT&&$scope.sourceModule!==Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.promiseLoading=UserService.getProfClassesGroupesTree().then(function(etabs){var etablissements=angular.copy(etabs);etablissements=lodash.uniq(etablissements,function(etab){return etab.etabId+"_"+etab.niveauId+"_"+etab.id+"_"+etab.type}),lodash.forEach(etablissements,function(entity){"G"===entity.type&&(entity.etabLibelle="Groupes",entity.classeLibelle=entity.libelle)}),$scope.etablissements=etablissements;var lesMatieres=[];lodash.forEach(etablissements,function(etab){var etabMatieres=lodash.chain(etab.periodes).pluck("matieres").flatten().uniq("code").filter("codeSSMatiere","").value();lesMatieres=lesMatieres.concat(etabMatieres),lodash.forEach(lesMatieres,function(mat){mat.id=0})}),$scope.matieres=lodash.uniq(lesMatieres,"code")}):Auth.role()===Auth.TYPE_USER.ENSEIGNANT&&$scope.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.promiseLoading=UserService.getAllClassesByEtabs().then(function(etabs){$scope.etablissements=etabs}):$scope.promiseLoading=UserService.getClassesByEtabs().then(function(etabs){$scope.etablissements=etabs})}function displayAllClasses(){$scope.selectAllClasse=!$scope.selectAllClasse,$scope.selectAllClasse?($scope.promiseLoading=UserService.getAllClassesByEtabs().then(function(etabs){$scope.etablissements=etabs}),$scope.destinataires=[],$scope.selection.nom=""):(getClasses(),search())}function refresh(){MessagerieService.getMessagerieParametrage($scope.typeUser,$scope.idUser).then(function(params){angular.isUndefined(params)?$scope.parametrage={}:$scope.parametrage=params,$scope.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL&&($scope.parametrage.afficherToutesLesClasses=!1),getClasses(),search()},function(error){})}$scope.matieres=options.matieres,$scope.classes=options.classes,$scope.sourceModule=options.sourceModule,$scope.selection=options,$scope.destinataires=destinataires||[],$scope.displayedDestinataires=[].concat($scope.destinataires),$scope.oneIsSelected=!1,$scope.requestLoading=!1,$scope.typeUser=Auth.currentUser().typeCompte,$scope.idUser=Auth.idUser(),$scope.close=close,$scope.search=search,$scope.canSearch=canSearch,$scope.addGroupeDestinataire=addGroupeDestinataire,$scope.selectDestinataire=selectDestinataire,$scope.selectAll=selectAll,$scope.displayAllClasses=displayAllClasses,this.objDestinataires={};var self=this;options.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.btnLibelleAjout="Ajouter les membres sélectionnés":$scope.btnLibelleAjout="Ajouter les destinataires sélectionnés",refresh()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionFamilleCtrl",["$scope","$uibModalInstance","options","destinataires","toCcCci","MessagerieService","lodash","Auth","UserService",function($scope,$uibModalInstance,options,destinataires,toCcCci,MessagerieService,lodash,Auth,UserService){function close(){$uibModalInstance.dismiss()}function search(force){if(force=force||!1,Auth.isProfesseur()){if(lodash.isEmpty($scope.selection.classes)&&lodash.isEmpty($scope.selection.matiere)&&force===!1)return}else if(lodash.isEmpty($scope.selection.classes)&&force===!1)return;if($scope.requestLoading=!0,$scope.promiseLoading=MessagerieService.getFamillesContacts($scope.selection,$scope.selectAllClasse).then(function(contacts){if($scope.promiseLoading=void 0,$scope.selection.classes){var lesClasses=lodash.filter($scope.selection.classes,{type:"C"}),lesGroupes=lodash.filter($scope.selection.classes,{type:"G"}),lesDestinataires=[];lesDestinataires=lesDestinataires.concat(lodash.filter(contacts,function(dest){return lodash.find(lesClasses,{id:dest.classe.id})})),lesDestinataires=lesDestinataires.concat(lodash.filter(contacts,function(dest){var estDedans=!1;return lodash.forEach(dest.groupes,function(grp){angular.isDefined(lodash.find(lesGroupes,{id:grp.id}))&&(estDedans=!0)}),estDedans})),contacts=lesDestinataires}$scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.FAMILLE,dest.isSelected=!1}),$scope.requestLoading=!1,angular.isDefined($scope.selection.classes)&&null!==$scope.selection.classes&&($scope.matieres=lodash.chain($scope.selection.classes).pluck("periodes").flatten().pluck("matieres").flatten().uniq("code").valueOf())},function(){$scope.requestLoading=!1}),$scope.selection.classes){var lesClasses=lodash.filter($scope.selection.classes,{type:"C"}),lesGroupes=lodash.filter($scope.selection.classes,{type:"G"}),lesDestinataires=[];lesDestinataires=lesDestinataires.concat(lodash.filter($scope.destinataires,function(dest){return lodash.find(lesClasses,{id:dest.classe.id})})),lesDestinataires=lesDestinataires.concat(lodash.filter($scope.destinataires,function(dest){var estDedans=!1;return lodash.forEach(dest.groupes,function(grp){angular.isDefined(lodash.find(lesGroupes,{id:grp.id}))&&(estDedans=!0)}),estDedans})),$scope.destinataires=lesDestinataires}}function addGroupeDestinataire(destinataires,selection){self.objDestinataires.destinataires=lodash.filter(destinataires,{isSelected:!0}),self.objDestinataires.selection=selection,self.objDestinataires.selection.type=Auth.TYPE_USER.FAMILLE,$uibModalInstance.close(self.objDestinataires)}function selectDestinataire(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter($scope.destinataires,{isSelected:!0});$scope.oneIsSelected=selectedDest&&selectedDest.length>0?!0:!1}function selectAll(isSelectAll){angular.forEach($scope.destinataires,function(dest){dest.isSelected=isSelectAll,$scope.selectDestinataire(dest)})}function getClasses(){Auth.role()===Auth.TYPE_USER.ENSEIGNANT?options.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.promiseLoading=UserService.getAllClassesByEtabs().then(function(etabs){var etablissements=angular.copy(etabs);etablissements=lodash.uniq(etablissements,function(etab){return etab.etabId+"_"+etab.niveauId+"_"+etab.id+"_"+etab.type}),$scope.etablissements=etablissements}):$scope.promiseLoading=UserService.getProfClassesGroupesTree().then(function(etabs){var etablissements=angular.copy(etabs);etablissements=lodash.uniq(etablissements,function(etab){return etab.etabId+"_"+etab.niveauId+"_"+etab.id+"_"+etab.type}),lodash.forEach(etablissements,function(entity){"G"===entity.type&&(entity.etabLibelle="Groupes",entity.classeLibelle=entity.libelle)}),$scope.etablissements=etablissements;var lesMatieres=[];lodash.forEach(etablissements,function(etab){var etabMatieres=lodash.chain(etab.periodes).pluck("matieres").flatten().uniq("code").filter("codeSSMatiere","").value();lesMatieres=lesMatieres.concat(etabMatieres),lodash.forEach(lesMatieres,function(mat){mat.id=0})}),$scope.matieres=lodash.uniq(lesMatieres,"code")}):$scope.promiseLoading=UserService.getClassesByEtabs().then(function(etabs){$scope.etablissements=etabs})}function displayAllClasses(){$scope.selectAllClasse=!$scope.selectAllClasse,$scope.selectAllClasse?($scope.promiseLoading=UserService.getAllClassesByEtabs().then(function(etabs){$scope.etablissements=etabs}),$scope.destinataires=[],$scope.selection.nom=""):(getClasses(),search())}function refresh(){MessagerieService.getMessagerieParametrage($scope.typeUser,$scope.idUser).then(function(params){angular.isUndefined(params)?$scope.parametrage={}:$scope.parametrage=params,$scope.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL&&($scope.parametrage.afficherToutesLesClasses=!1),getClasses(),search()},function(error){})}$scope.matieres=options.matieres,$scope.classes=options.classes,$scope.selection=options,$scope.sourceModule=options.sourceModule,$scope.destinataires=destinataires||[],$scope.displayedDestinataires=[].concat($scope.destinataires),$scope.oneIsSelected=!1,$scope.requestLoading=!1,$scope.typeUser=Auth.currentUser().typeCompte,$scope.idUser=Auth.idUser(),this.objDestinataires={};var self=this;$scope.close=close,$scope.search=search,$scope.addGroupeDestinataire=addGroupeDestinataire,$scope.selectDestinataire=selectDestinataire,$scope.selectAll=selectAll,$scope.displayAllClasses=displayAllClasses,options.classe&&($scope.selection.classe=lodash.find(options.classes,{libelle:options.classe.libelle})),options.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.btnLibelleAjout="Ajouter les membres sélectionnés":$scope.btnLibelleAjout="Ajouter les destinataires sélectionnés",refresh()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionPersonnelCtrl",["$scope","$uibModalInstance","options","destinataires","toCcCci","MessagerieService","lodash","Auth",function($scope,$uibModalInstance,options,destinataires,toCcCci,MessagerieService,lodash,Auth){function initFonction(destinataires){$scope.fonctions=[];var tabFonctions={};angular.forEach(destinataires,function(destinataire){tabFonctions[destinataire.fonction.id]=destinataire.fonction}),angular.forEach(tabFonctions,function(laFonction){""!==laFonction.libelle&&$scope.fonctions.push(laFonction)})}$scope.selection=options,$scope.destinatairesCache=[],$scope.destinataires=destinataires||[],$scope.displayedDestinataires=[].concat($scope.destinataires),$scope.close=close,$scope.oneIsSelected=!1,$scope.requestLoading=!1,this.objDestinataires={};var self=this;options.classe&&($scope.selection.classe=lodash.find(options.classes,{libelle:options.classe.libelle})),options.sourceModule===Auth.TYPE_USER.ESPACE_TRAVAIL?$scope.btnLibelleAjout="Ajouter les membres sélectionnés":$scope.btnLibelleAjout="Ajouter les destinataires sélectionnés",$scope.close=function(){$uibModalInstance.dismiss()},$scope.search=function(){lodash.isEmpty($scope.destinatairesCache)&&($scope.requestLoading=!0,$scope.promiseLoading=MessagerieService.getPersonnelsContacts($scope.selection).then(function(contacts){$scope.destinatairesCache=contacts,angular.forEach($scope.destinatairesCache,function(dest){dest.type=Auth.TYPE_USER.PERSONNEL,dest.isSelected=!1}),$scope.destinataires=angular.copy($scope.destinatairesCache),initFonction(contacts),$scope.requestLoading=!1},function(){$scope.requestLoading=!1})),$scope.destinataires=angular.copy($scope.destinatairesCache),$scope.selection.nom&&($scope.destinataires=lodash.filter($scope.destinataires,function(dest){return null!==dest.nom.match(new RegExp($scope.selection.nom,"i"))})),$scope.selection.fonction&&($scope.destinataires=lodash.filter($scope.destinataires,{fonction:{id:$scope.selection.fonction.id}}))},$scope.addGroupeDestinataire=function(destinataires,selection){self.objDestinataires.destinataires=lodash.filter(destinataires,{isSelected:!0}),self.objDestinataires.selection=selection,self.objDestinataires.selection.type=Auth.TYPE_USER.PERSONNEL,$uibModalInstance.close(self.objDestinataires)},$scope.selectDestinataire=function(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter($scope.destinataires,{isSelected:!0});$scope.oneIsSelected=selectedDest&&selectedDest.length>0?!0:!1},$scope.selectAll=function(isSelectAll){angular.forEach($scope.destinataires,function(dest){dest.isSelected=isSelectAll,$scope.selectDestinataire(dest)})},$scope.search()}]),angular.module("edsiteApp").directive("groupeDestinataireTag",["Utils","$filter","Auth","lodash",function(Utils,$filter,Auth,lodash){return{restrict:"E",scope:{groupeDestinataire:"=",showSelection:"&",remove:"&",move:"&",type:"@",toCcCci:"="},template:'<span ng-if="combien" class="ed-tags" ng-class="{\'ed-tags-eleve\': isEleve, \'ed-tags-professeur\': isProf, \'ed-tags-personnel\': isPersonnel, \'ed-tags-famille\': isFamille, \'ed-tags-espace-travail\' : isEspaceTravail }" context-menu="menuOptions" model="{groupe: groupeDestinataire, oldMode: toCcCci}"><span ng-click="showSelection({destinataires: groupeDestinataire.destinataires, mode: toCcCci})">{{libelle}}</span> <i ng-click="remove({groupe: groupeDestinataire, mode: toCcCci})" class="fa fa-close"></i></span>',link:function(scope){function setLibelle(){var typeDestinataire=$filter("translateTypeUser")(scope.type);scope.type===Auth.TYPE_USER.ESPACE_TRAVAIL&&(typeDestinataire="membre");var dests=lodash.filter(scope.groupeDestinataire.destinataires,{to_cc_cci:scope.toCcCci});scope.combien=dests.length;var libelle=dests.length+" "+typeDestinataire+"s";dests.length<=2&&(libelle=[],angular.forEach(dests,function(destinataire){if(scope.isFamille){var prenomOriginel=destinataire.prenom;destinataire.prenom="Famille",libelle.push($filter("displayNom")(destinataire)),destinataire.prenom=prenomOriginel}else libelle.push($filter("displayNom")(destinataire))}),libelle=libelle.join(", ")),scope.libelle=libelle}scope.combien=0,setLibelle(),scope.$watch("groupeDestinataire.destinataires",function(){setLibelle()},!0),scope.isEleve=Utils.isTypeEleve(scope.type),scope.isProf=Utils.isTypeProfesseur(scope.type),scope.isPersonnel=Utils.isTypePersonnel(scope.type),scope.isFamille=Utils.isTypeFamille(scope.type),scope.isEspaceTravail=Utils.isTypeEspaceTravail(scope.type),scope.menuOptions=[],"to"!==scope.toCcCci&&scope.menuOptions.push(["Déplacer dans les 'à'",function($itemScope,$event,modelValue){modelValue.newMode="to",scope.move(modelValue)}]),"cc"!==scope.toCcCci&&scope.menuOptions.push(["Déplacer dans les 'cc'",function($itemScope,$event,modelValue){modelValue.newMode="cc",scope.move(modelValue)}]),"cci"===scope.toCcCci||Auth.isFamille()||Auth.isEleve()||scope.menuOptions.push(["Déplacer dans les 'cci'",function($itemScope,$event,modelValue){modelValue.newMode="cci",scope.move(modelValue)}]),scope.menuOptions.push(["",function($itemScope){}])}}}]).directive("chooseDestinataireTag",["Auth",function(Auth){return{restrict:"E",scope:{toCcCci:"=",composeSelectionEnseignant:"&",composeSelectionPersonnel:"&",composeSelectionEleve:"&",composeSelectionFamille:"&",composeSelectionEspaceTravail:"&",composeSelectionListeContacts:"&",params:"="},templateUrl:"modules/messagerie/groupe-destinataire.template.html",link:function(scope){scope.displayListesContacts=Auth.isProfesseur()||Auth.isPersonnel()}}}]),angular.module("edsiteApp.DocumentsFamille",["edsiteApp.Commun"]).controller("FamilledocumentsCtrl",["$scope","DocumentsFamilleService","ModuleService","UserService","Auth","lodash",function($scope,DocumentsFamilleService,ModuleService,UserService,Auth,lodash){function ventileDocuments(typeDocToVentile,annee){typeDocToVentile=angular.isDefined(typeDocToVentile)?typeDocToVentile:"current";var lesDocVentiles={},source=$scope.documentsRecus;"archives"===typeDocToVentile&&(source=$scope.archivesRecus),lesDocVentiles.factures=source?source.factures:[],lesDocVentiles.inscriptions=source?source.inscriptions:[];var typesDoc=["administratifs","notes","viescolaire"],lesIdsEleves=[];angular.forEach(typesDoc,function(typeDoc){typeDoc in source&&angular.forEach(source[typeDoc],function(fic){typeDoc in lesDocVentiles||(lesDocVentiles[typeDoc]={}),fic.idEleve||(fic.idEleve=0,$scope.prenomsEleveById[0]="la famille"),fic.idEleve in lesDocVentiles[typeDoc]||(lesDocVentiles[typeDoc][fic.idEleve]=[],lesIdsEleves.push(fic.idEleve),fic.idEleve in $scope.prenomsEleveById||UserService.getUser("E",fic.idEleve).then(function(eleve){$scope.prenomsEleveById[eleve.id]=eleve.prenom})),lesDocVentiles[typeDoc][fic.idEleve].push(fic)})}),"archives"===typeDocToVentile?($scope.archives=angular.isUndefined($scope.archives)?{}:$scope.archives,$scope.archives[annee]=lesDocVentiles):$scope.documents=lesDocVentiles,$scope.allIsLoaded=!0}$scope.documentsRecus={},$scope.documents={},$scope.prenomsEleveById={},$scope.parametresDoc=ModuleService.getModule(ModuleService.CODES.DOCUMENTS).params,$scope.facturesVisibles=ModuleService.isModuleEnabled(ModuleService.CODES.FACTURES),$scope.allIsLoaded=!1,$scope.anneesArchive=[],angular.isDefined($scope.parametresDoc.AnneeArchive)&&($scope.anneesArchive=$scope.parametresDoc.AnneeArchive.split(",")),$scope.refresh=function(){$scope.allIsLoaded=!1;var anneeScolaireCourante=Auth.anneeScolaireCourante(),tabAnneeCourante=anneeScolaireCourante.split("-");$scope.anneScolairePrec=parseInt(tabAnneeCourante[0])-1+"-"+(parseInt(tabAnneeCourante[1])-1),$scope.promiseContents=DocumentsFamilleService.familleDocuments().then(function(documents){$scope.documentsRecus=documents?documents:{},angular.forEach($scope.documentsRecus,function(value,index){const tabDocsForType=value,typeDoc=index;var docAsigner=lodash.find(tabDocsForType,{signatureDemandee:!0});$scope["isSignature_"+typeDoc]=angular.isDefined(docAsigner)}),ventileDocuments()})},$scope.loadArchives=function(annee){$scope.anneesArchive.length>0&&!angular.isUndefined(annee)&&""!==annee&&($scope.promiseContents=DocumentsFamilleService.familleArchives(annee).then(function(documents){$scope.archivesRecus=documents?documents:{},ventileDocuments("archives",annee)}))},$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.DOCUMENTS)}]),angular.module("edsiteApp.DocumentsFamille").service("DocumentsFamilleService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mDocumentsFamilleService={};return mDocumentsFamilleService.familleDocuments=function(){var defer=$q.defer(),data={},baseUrl="familledocuments";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsFamilleService.familleArchives=function(annee){var defer=$q.defer(),data={archive:!0},baseUrl="familledocuments?archive="+annee;return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsFamilleService.signerDocument=function(docASigner,signature){var defer=$q.defer(),data={doc:docASigner,codeSecure:signature.codeSecure},baseUrl="familledocuments/"+docASigner.id;return new EDHttp({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsFamilleService}]),angular.module("edsiteApp.DocumentsEleves",["edsiteApp.Commun"]).controller("ElevesdocumentsCtrl",["$scope","DocumentsElevesService","ModuleService",function($scope,DocumentsElevesService,ModuleService){$scope.allIsLoaded=!1,$scope.documents=[],$scope.anneesArchive=[],$scope.parametresDoc=ModuleService.getModule(ModuleService.CODES.DOCUMENTS_ELEVE).params,angular.isDefined($scope.parametresDoc.AnneeArchive)&&($scope.anneesArchive=$scope.parametresDoc.AnneeArchive.split(",")),$scope.refresh=function(){$scope.allIsLoaded=!1,$scope.promiseContents=DocumentsElevesService.elevesDocuments().then(function(documents){$scope.documents=documents?documents:[],$scope.allIsLoaded=!0})},$scope.loadArchives=function(annee){$scope.anneesArchive.length>0&&!angular.isUndefined(annee)&&""!==annee&&($scope.promiseContents=DocumentsElevesService.elevesArchives(annee).then(function(documents){$scope.archives=angular.isUndefined($scope.archives)?{}:$scope.archives,$scope.archives[annee]=documents?documents:[]}))},$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.DOCUMENTS)}]),angular.module("edsiteApp.DocumentsEleves").service("DocumentsElevesService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mDocumentsElevesService={};return mDocumentsElevesService.elevesDocuments=function(){var defer=$q.defer(),data={},baseUrl="elevesDocuments";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsElevesService.elevesArchives=function(annee){var defer=$q.defer(),data={archive:!0},baseUrl="elevesDocuments?archive="+annee;return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsElevesService}]),angular.module("edsiteApp.DocumentsAdultes",["edsiteApp.Commun"]).controller("AdultesdocumentsCtrl",["$scope","DocumentsAdultesService","ModuleService",function($scope,DocumentsAdultesService,ModuleService){$scope.allIsLoaded=!1,$scope.documents=[],$scope.anneesArchive=[],$scope.parametresDoc=ModuleService.getModule(ModuleService.CODES.DOCUMENTS).params,angular.isDefined($scope.parametresDoc.AnneeArchive)&&($scope.anneesArchive=$scope.parametresDoc.AnneeArchive.split(",")),$scope.refresh=function(){$scope.allIsLoaded=!1,$scope.promiseContents=DocumentsAdultesService.adultesDocuments().then(function(documents){var docs={administratifs:documents};$scope.documents=documents?docs:[],$scope.allIsLoaded=!0})},$scope.loadArchives=function(annee){$scope.anneesArchive.length>0&&!angular.isUndefined(annee)&&""!==annee&&($scope.promiseContents=DocumentsAdultesService.adultesArchives(annee).then(function(documents){var docs={administratifs:documents};$scope.archives=angular.isUndefined($scope.archives)?{}:$scope.archives,$scope.archives[annee]=documents?docs:[]}))},$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.DOCUMENTS)}]),angular.module("edsiteApp.DocumentsAdultes").service("DocumentsAdultesService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mDocumentsAdultesService={};return mDocumentsAdultesService.adultesDocuments=function(){var defer=$q.defer(),data={},baseUrl="adultesDocuments";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsAdultesService.adultesArchives=function(annee){var defer=$q.defer(),data={archive:!0},baseUrl="adultesDocuments?archive="+annee;return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDocumentsAdultesService}]),angular.module("edsiteApp.Documents",["edsiteApp.Commun"]).directive("listeDocumentsUtilisateurFamille",function(){return{restrict:"EA",scope:{tabAnneesArchives:"=",functionLoadArchives:"&",tabDocuments:"=",tabPrenomsEleves:"=",tabDocumentsArchives:"=",libelleModule:"@",typeModule:"@",withEleves:"=",placeHolderAucunDoc:"@",afficherSignatures:"="},controller:"listeDocumentsUtilisateurFamilleDirective",templateUrl:"modules/commun/documentsUtilisateurs/liste-documents-template-famille.html",link:function(scope,element,attrs){}}}).controller("listeDocumentsUtilisateurFamilleDirective",["$scope","Auth","$uibModal","Notification","DocumentsFamilleService",function($scope,Auth,$uibModal,Notification,DocumentsFamilleService){function loadArchives(annee){$scope.anneeSelected=annee,$scope.functionLoadArchives({annee:annee})}function openModalSignature(documentASigner){return Auth.isModeSupervision()?void Notification.notify("Documents","En mode supervision, cette action n'est pas disponible !","warning","glyphicon glyphicon-list-alt"):($scope.docASigner=documentASigner,void($scope.d3SecureModal=$uibModal.open({templateUrl:"modules/commun/documentsUtilisateurs/document-utilisateur-signature.html",scope:$scope,backdrop:!1})))}function closeModalSignature(){$scope.d3SecureModal.close()}function signerDocument(){$scope.promise3DSecure=DocumentsFamilleService.signerDocument($scope.docASigner,$scope.configSignatureDoc).then(function(docUpdated){Notification.notify("Documents","Vos modifications ont bien été enregistrées !","success"),$scope.docASigner.signature=docUpdated.signature,$scope.d3SecureModal.close()},function(){Notification.notify("Documents","L'enregistrement de vos modifications a échoué.","error")})}$scope.loadArchives=loadArchives,
$scope.openModalSignature=openModalSignature,$scope.closeModalSignature=closeModalSignature,$scope.signerDocument=signerDocument,$scope.anneeSelected="",$scope.configSignatureDoc={codeModule:"docASigner",codeSecure:""},$scope.d3SecureModal={},$scope.tabContacts=[{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable},{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}],$scope.docASigner={}}]),angular.module("edsiteApp.Documents").directive("listeDocumentsUtilisateur",function(){return{restrict:"EA",scope:{tabAnneesArchives:"=",functionLoadArchives:"&",tabDocuments:"=",tabDocumentsArchives:"=",libelleModule:"@",typeModule:"@",placeHolderAucunDoc:"@"},controller:"listeDocumentsUtilisateurDirective",templateUrl:"modules/commun/documentsUtilisateurs/liste-documents-template.html",link:function(scope,element,attrs){}}}).controller("listeDocumentsUtilisateurDirective",["$scope",function($scope){function loadArchives(annee){$scope.anneeSelected=annee,$scope.functionLoadArchives({annee:annee})}$scope.anneeSelected="",$scope.loadArchives=loadArchives}]),angular.module("edsiteApp.AccueilFamille",["edsiteApp.Finance","edsiteApp.messagerie","edsiteApp.Commun","edsiteApp.Agenda"]).controller("FamilleaccueilCtrl",["$scope","$sessionStorage","$location","$sce","$q","$filter","Settings","AccueilFamilleService","UserService","MessagerieService","Auth","ModuleService","DossierInscriptionFamilleService","lodash","TimelineService","AgendaService",function($scope,$sessionStorage,$location,$sce,$q,$filter,Settings,AccueilFamilleService,UserService,MessagerieService,Auth,ModuleService,DossierInscriptionFamilleService,lodash,TimelineService,AgendaService){function getLibelleEtapeInscription(inscription){return DossierInscriptionFamilleService.getLibelleEtapeInscription(inscription)}function isPast(leJour){return moment().isAfter(moment(leJour),"day")}function setEleve(eleve){$scope.prenomsEleveById[eleve.id]=eleve.prenom}function refresh(){var lesPromises=[];if(lesPromises.push(AccueilFamilleService.contactEtablissement().then(function(contactEtablissement){$scope.contactEtablissement=contactEtablissement})),messagerieActive){var options={limit:10,onlyRead:"0"};MessagerieService.getMessages(Auth.role(),Auth.idUser(),options).then(function(messagerie){var messageEvents=[];messagerie.messages.received=lodash.filter(messagerie.messages.received,{read:!1}),angular.forEach(messagerie.messages.received,function(message){var newEvent={theid:"mess"+message.id,description:message.subject,date:message.date,title:message.from.name,href:"/"+Auth.currentUser().typeCompte+"/"+Auth.idUser()+"/Messagerie?messageId="+message.id,icon:"icon-ed_messagerie-light"};messageEvents.push(newEvent)}),$scope.events.push.apply($scope.events,messageEvents)})}lesPromises.push(TimelineService.communTimelineAcceuil(Auth.currentUser().typeCompte,Auth.idUser()).then(function(timeline){if($scope.tabPostits=timeline.postits,$scope.agendaEvents=timeline.evenements,AgendaService.cleanEventsFromServer($scope.agendaEvents),$scope.tabReunions=timeline.reunions,documentsActifs){for(var lesdocs=[],typesDocs=["documentsFacture","documentsNote","documentsVS","documentsAdm"],i=0;i<typesDocs.length;i++)if(timeline.hasOwnProperty(typesDocs[i])){var lesFic=timeline[typesDocs[i]],lesIdsEleves=[];angular.forEach(lesFic,function(doc){doc.idEleve?lesIdsEleves.indexOf(doc.idEleve)<0&&(lesIdsEleves.push(doc.idEleve),UserService.getUser("E",doc.idEleve).then(setEleve)):(doc.idEleve=0,$scope.prenomsEleveById[0]="la famille");var newEvent={theid:typesDocs[i]+doc.id,description:doc.libelle,date:doc.date,title:"Nouveau document disponible",href:"/Famille/Documents",icon:"icon-ed_document-light"};lesdocs.push(newEvent)})}$scope.events.push.apply($scope.events,lesdocs)}if(situationFinanciereActive){var lesComptes=[];angular.forEach(timeline.comptes.comptes,function(lCompte){"portemonnaie"===lCompte.typeCompte&&0!==lCompte.solde&&lesComptes.push(lCompte),"pmactivite"===lCompte.typeCompte&&lCompte.solde<0&&lesComptes.push(lCompte)}),$scope.lesSoldes=lesComptes}})),$scope.promiseEvents=$q.all(lesPromises).then(function(datas){angular.forEach($scope.tabReunions,function(laReunion){var rppEvents=[];if(!isPast(laReunion.dateReunion)){var newEventRpp={theid:"rpp"+laReunion.idReunion,description:laReunion.libelleReunion+'<br/> <i class="help-block">(pour '+laReunion.eleve.prenom+")</i>",date:laReunion.dateReunion,title:"Nouvelle réunion parents/prof disponible",href:"/Eleves/"+laReunion.eleve.id+"/ReunionParentProf",icon:"icon-ed_reunionparentprof-light"};rppEvents.push(newEventRpp)}$scope.events.push.apply($scope.events,rppEvents)})}),$scope.isDossierInscriptionActif&&($scope.promiseDossiersInscriptions=DossierInscriptionFamilleService.getDossierInscription(!0).then(function(resumeInscriptions){$scope.tabInscriptions=resumeInscriptions.inscriptions,$scope.commentaireDossierInsFamille=resumeInscriptions.commentaireFamille}))}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}$scope.events=[],$scope.agendaEvents=[],$scope.messages=[],$scope.tabPostits=[],$scope.tabInscriptions=[],$scope.prenomsEleveById={},$scope.contactEtablissement=[],$scope.typeUser=Auth.currentUser().typeCompte,$scope.typeUserUrl=$filter("translateTypeUserUrl")($scope.typeUser),$scope.idUser=Auth.idUser(),$scope.url=Settings.apiUri+"telechargement.awp",$scope.configTimeLine={itemsDisplayedInList:16},$scope.sanitize=sanitize,$scope.getLibelleEtapeInscription=getLibelleEtapeInscription,$scope.isPast=isPast,$scope.postitConfig={addPostit:!1,updatePostit:!1,deletePostit:!1,displayDateCreated:!0,displayDateLimit:!1,displayTargets:!1,visibilityPostitPast:!1},$scope.agendaDroits={updateAgenda:!1,createAgenda:!1,deleteAgenda:!1};var messagerieActive=ModuleService.isModuleEnabled(ModuleService.CODES.MESSAGERIE),documentsActifs=ModuleService.isModuleEnabled(ModuleService.CODES.DOCUMENTS),situationFinanciereActive=ModuleService.isModuleEnabled(ModuleService.CODES.SITUATION_FINANCIERE);$scope.isPaiementEnable=ModuleService.isModuleEnabled(ModuleService.CODES.PAIEMENT_EN_LIGNE),$scope.isDossierInscriptionActif=ModuleService.isModuleEnabled(ModuleService.CODES.DOSSIER_INSCRIPTION),$scope.addMoreItems=function(){$scope.configTimeLine.itemsDisplayedInList<$scope.events.length&&($scope.configTimeLine.itemsDisplayedInList=$scope.configTimeLine.itemsDisplayedInList+1)},refresh()}]),angular.module("edsiteApp.AccueilFamille").service("AccueilFamilleService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mAccueilFamille={};return mAccueilFamille.contactEtablissement=function(){var defer=$q.defer(),data={},baseUrl="contactetablissement";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAccueilFamille}]),angular.module("edsiteApp.AccueilFamille").controller("ContactetablissementCtrl",["$scope","AccueilFamilleService","Settings",function($scope,AccueilFamilleService,Settings){$scope.contactEtablissement=[],$scope.url=Settings.apiUri+"telechargement.awp",$scope.refresh=function(){$scope.promiseContents=AccueilFamilleService.contactEtablissement().then(function(contactEtablissement){$scope.contactEtablissement=contactEtablissement})},$scope.refresh()}]),angular.module("edsiteApp.Note",["edsiteApp.Commun","ui.bootstrap"]).directive("eleveNote",function(){return{restrict:"E",scope:{idEleve:"=",isModeConseilDeClasse:"=",currentPeriode:"=",onEditAppreciation:"&",isConsultationEnSaisie:"=",paramNoteEtab:"=?"},controller:"ElevenotesDirectiveCtrl",templateUrl:"modules/notes/eleve/eleve-notes-template.html",link:function(scope,element,attrs){}}}).controller("ElevenotesDirectiveCtrl",["$rootScope","$scope","$routeParams","$filter","$uibModal","$sce","$timeout","$q","ModuleService","NoteService","UserService","Auth","lodash","CompetencesService","ComposantesService","CarnetNotesService","Utils",function($rootScope,$scope,$routeParams,$filter,$uibModal,$sce,$timeout,$q,ModuleService,NoteService,UserService,Auth,lodash,CompetencesService,ComposantesService,CarnetNotesService,Utils){function setSelectedPeriode(periodeAnchor,periode){$scope.selected=periodeAnchor,angular.isDefined(periode)&&"notes"!==$scope.selectedView&&!$scope.shouldIDisplayMoyenne(periode)?$scope.setSelectedView("notes"):"composantes"===$scope.selectedView&&loadComposantesValues()}function setSelectedView(view){$scope.selectedView=view,"composantes"===view&&loadComposantesValues()}function shouldIDisplayMoyenne(periode){if(Auth.isPersonnel()||Auth.isProfesseur())return!0;if("Z"===periode.idPeriode[4])return $scope.parametrage.moyennePeriodeAnnuelle;if("H"===periode.idPeriode[4])return $scope.parametrage.moyennePeriodeHorsP;if($scope.parametrage.moyenneUniquementPeriodeCloture)return periode.cloture;if(-1===periode.moyNbreJoursApresConseil)return!0;if(angular.isUndefined(periode.moyNbreJoursApresConseil)||0===periode.moyNbreJoursApresConseil)return"R"===periode.idPeriode[4]?$scope.parametrage.moyennePeriodeReleve:!0;var laDateAUtilisee=periode.dateConseil;if((angular.isUndefined(laDateAUtilisee)||""===laDateAUtilisee)&&("R"===periode.idPeriode[4]||"X"===periode.idPeriode[4])&&(laDateAUtilisee=periode.dateFin),angular.isUndefined(laDateAUtilisee)||""===laDateAUtilisee)return!1;var laDateConseil=moment(laDateAUtilisee),laDateToDisplay=laDateConseil.add({day:periode.moyNbreJoursApresConseil});return moment().diff(laDateToDisplay,"days")>=0}function loadComposantesValues(){var iPeriode=$scope.selected.substr(8);if(!(iPeriode>=$scope.periodes.length)){var codePeriode=$scope.periodes[iPeriode].idPeriode;if("Z"===codePeriode[4]||"X"===codePeriode[4]||4===codePeriode.length){var classeId="";Auth.isEleve()?classeId=$scope.eleve.profile.classe.id:Auth.isFamille()?classeId=$scope.eleve.classe.id:(Auth.isProfesseur()||Auth.isPersonnel())&&(classeId=$scope.eleve.classeId),""!==classeId&&(CarnetNotesService.setEtatLoadingEleveNotesDirective(!0),$scope.promiseContents=ComposantesService.get(Auth.role(),Auth.idUser(),"C",classeId,codePeriode,$scope.idEleve).then(function(composantesEleve){$scope.composantes=composantesEleve.composantes,$scope.enseignementsDeComplements=composantesEleve.eleves[0].enseignementDeComplement,$scope.languesRegionales=composantesEleve.eleves[0].langueRegionale,$scope.LSUEleve=composantesEleve.eleves[0],CarnetNotesService.setEtatLoadingEleveNotesDirective(!1)}))}}}function getEvaluationComposanteEleve(codeComposante){if(!angular.isUndefined($scope.LSUEleve)){var libelleComp="",comp=lodash.find($scope.composantes,{code:codeComposante});angular.isDefined(comp)&&(libelleComp=comp.libelle);var evaluation=lodash.find($scope.LSUEleve.competences,{codeComposante:codeComposante});if(angular.isDefined(evaluation))return evaluation.libelle=libelleComp,evaluation;var newEval={codeComposante:codeComposante,valeur:"0",libelle:libelleComp};return $scope.LSUEleve.competences.push(newEval),newEval}}function totalPoint(){var nbPoint=0,totalPointEleve=0;return lodash.forEach($scope.LSUEleve.competences,function(evaluation){nbPoint+=nbPoints(evaluation),"0"!==evaluation.valeur&&"D"!==evaluation.valeur&&(totalPointEleve+=50)}),0===nbPoint?"":""+nbPoint+"/"+totalPointEleve}function nbPoints(evaluation){return"0"===evaluation.valeur||"D"===evaluation.valeur?0:"1"===evaluation.valeur?10:"2"===evaluation.valeur?25:"3"===evaluation.valeur?40:"4"===evaluation.valeur?50:void 0}function isEvaluationsComposantesActif(periode){return $scope.parametrage.affichageCompetence?(Auth.isProfesseur()||Auth.isPersonnel()||$scope.parametrage.affichageCompetence&&$scope.parametrage.affichageEvaluationsComposantes)&&("A999Z"===periode.idPeriode||4===periode.idPeriode.indexOf("X")||4===periode.idPeriode.length):!1}function openDetailDevoir(devoir,discipline){$uibModal.open({templateUrl:"modules/notes/detail-devoir.html",controller:"DevoirDetailCtrl as detailDevoirCtrl",backdrop:!0,size:"lg",resolve:{devoir:function(){return devoir},discipline:function(){return discipline},parametrage:function(){return $scope.parametrage},idEleve:function(){return $scope.idEleve}}})}function refresh(){if(!angular.isUndefined($scope.idEleve)){var promises=[];$scope.isModeAccessibiliteVisuelle=Utils.isModeAccessibiliteVisuelleActif(),promises.push(UserService.getEleve($scope.idEleve).then(function(eleve){$scope.eleve=eleve})),promises.push(NoteService.eleveNotes($scope.idEleve).then(function(data){var periodes,notes,competences;return $scope.parametrage=data.parametrage,$scope.parametrage.affichageNote||$scope.parametrage.affichageCompetence||(setSelectedView("moyennes"),$scope.parametrage.affichageMoyenne||(setSelectedView("competences"),$scope.parametrage.affichageCompetence))?(notes=data.notes,competences=data.LSUN,periodes=data.periodes,$scope.parametrage.notePeriodeAnnuelle||(periodes=lodash.reject(periodes,{idPeriode:"A999Z"})),$scope.parametrage.notePeriodeHorsP||(periodes=lodash.reject(periodes,function(elPeriode){return"H"===elPeriode.idPeriode.charAt(0)}),notes=lodash.reject(notes,function(elNote){return"H"===elNote.codePeriode.charAt(0)})),$scope.parametrage.notePeriodeReleve||(periodes=lodash.reject(periodes,function(elPeriode){return"A"===elPeriode.idPeriode.charAt(0)&&elPeriode.idPeriode.indexOf("R")>0})),$scope.parametrage.noteUniquementPeriodeCloture&&(periodes=lodash.reject(periodes,{cloture:!1})),lodash.forEach(periodes,function(periode){periode.libelleConseilFormate=CarnetNotesService.getLibelleConseil(periode),lodash.forEach(periode.ensembleMatieres.disciplines,function(discipline){angular.isUndefined(discipline.appreciationsDecoded)&&(discipline.appreciationsDecoded={},discipline.appreciationClasse=$filter("base64decode")(discipline.appreciationClasse)),lodash.forEach(discipline.appreciations,function(appreciationToDecode,key){angular.isUndefined(discipline.appreciationsDecoded[key])&&(discipline.appreciations[key]=$filter("base64decode")(appreciationToDecode),discipline.appreciationsDecoded[key]=!0)})})}),$scope.periodes=periodes,$scope.notes=notes,angular.isDefined(notes)&&($scope.yaNotes=lodash.findIndex(notes,function(note){return"0"!==note.noteSur})>-1,$scope.yaEvalsElementsProgramme=lodash.findIndex(notes,function(note){return note.elementsProgramme.length>0})>-1),$scope.competences=competences,$scope.updateGraph(),void(angular.isDefined($scope.currentPeriode)?selectPeriodeByCode($scope.currentPeriode.codePeriode):selectPeriodeByDate($scope.startingDate))):void setSelectedView("none")})),CarnetNotesService.setEtatLoadingEleveNotesDirective(!0),$scope.promiseContents=$q.all(promises).then(function(){$scope.isLoaded=!0,$scope.recompileAllTheThings.value=!0,CarnetNotesService.setEtatLoadingEleveNotesDirective(!1)})}}function selectPeriodeByCode(codePeriode){var idx=0,periodeToOpen="#periode0";return angular.forEach($scope.periodes,function(p){p.idPeriode===codePeriode?periodeToOpen="#periode"+idx:idx++}),$scope.setSelectedPeriode(periodeToOpen)}function selectPeriodeByDate(date){var idx=0,periodeToOpen="#periode0";return angular.forEach($scope.periodes,function(p){4===p.idPeriode.length&&"A999Z"!==p.idPeriode&&p.dateDebut<=date&&p.dateFin>=date?periodeToOpen="#periode"+idx:idx++}),$scope.setSelectedPeriode(periodeToOpen)}function updateGraph(){angular.forEach($scope.periodes,function(periode){function updateGraphDiscipline(discipline){function calculNotePoint(note){var date=moment(note.date).valueOf()+432e5,noteSurVingt=Math.round(parseFloat(note.valeur.replace(",","."))/parseFloat(note.noteSur)*moyenneSur*100)/100;return noteSurVingt=parseFloat(noteSurVingt.toFixed(2)),[date,noteSurVingt]}function updateGraphDisciplineNotSousMatiere(){if(!discipline.sousMatiere&&angular.isDefined(discipline.moyenne)&&""!==discipline.moyenne){chartRadarMoyenneConfigPeriode.options.xAxis.categories.push(discipline.discipline);var moyenneEleveForRadarFormate=parseFloat(discipline.moyenne.replace(",","."));if(isNaN(moyenneEleveForRadarFormate)&&(moyenneEleveForRadarFormate=null),chartRadarMoyenneConfigPeriode.series[0].data.push(moyenneEleveForRadarFormate),$scope.parametrage.moyenneClasse){var moyenneClasseForRadarFormate=parseFloat(discipline.moyenneClasse.replace(",","."));isNaN(moyenneClasseForRadarFormate)&&(moyenneClasseForRadarFormate=null),chartRadarMoyenneConfigPeriode.series[1].data.push(moyenneClasseForRadarFormate)}chartBarMoyenneConfigPeriode.options.xAxis.categories.push(discipline.discipline);var moyenneEleveFormate=parseFloat(discipline.moyenne.replace(",","."));if(isNaN(moyenneEleveFormate)&&(moyenneEleveFormate=null),chartBarMoyenneConfigPeriode.series[0].data.push(moyenneEleveFormate),$scope.parametrage.moyenneClasse){var moyenneClasseFormate=parseFloat(discipline.moyenneClasse.replace(",","."));isNaN(moyenneClasseFormate)&&(moyenneClasseFormate=null),chartBarMoyenneConfigPeriode.series[1].data.push(moyenneClasseFormate)}if($scope.parametrage.moyenneMin){var moyenneMinFormate=parseFloat(discipline.moyenneMin.replace(",","."));isNaN(moyenneMinFormate)&&(moyenneMinFormate=null);var moyenneMaxFormate=parseFloat(discipline.moyenneMax.replace(",","."));isNaN(moyenneMaxFormate)&&(moyenneMaxFormate=null),chartBarMoyenneConfigPeriode.series[2].data.push([moyenneMinFormate,moyenneMaxFormate])}}}if(!discipline.groupeMatiere){updateGraphDisciplineNotSousMatiere();var notesSerie={type:"line",name:discipline.discipline,lineWidth:2,threshold:10,data:[]},lesNotes=notesParPeriode(periode,discipline.codeMatiere,discipline.codeSousMatiere),yANote=!1;angular.forEach(lesNotes,function(note){if(!note.enLettre){var point=calculNotePoint(note);yANote=!0,notesSerie.data.push(point)}}),yANote&&notesSeriesList.push(notesSerie)}}var moyenneSur=$scope.parametrage.moyenneSur?$scope.parametrage.moyenneSur:"20";moyenneSur=parseInt(moyenneSur),chartRadarMoyenneConfigDefault.options.tooltip.valueSuffix=" /"+moyenneSur,chartRadarMoyenneConfigDefault.options.yAxis.max=moyenneSur;var chartRadarMoyenneConfigPeriode=angular.copy(chartRadarMoyenneConfigDefault);chartBarMoyenneConfigDefault.options.yAxis.title.text="moyennes /"+moyenneSur,chartBarMoyenneConfigDefault.options.yAxis.max=moyenneSur,chartBarMoyenneConfigDefault.series[0].tooltip.valueSuffix=" /"+moyenneSur,chartBarMoyenneConfigDefault.series[1].tooltip.valueSuffix=" /"+moyenneSur;var chartBarMoyenneConfigPeriode=angular.copy(chartBarMoyenneConfigDefault),notesSeriesList=[];angular.forEach(periode.ensembleMatieres.disciplines,function(discipline){updateGraphDiscipline(discipline)}),$scope.chartRadarMoyenneConfig[periode.idPeriode]=chartRadarMoyenneConfigPeriode,$scope.chartBarMoyenneConfig[periode.idPeriode]=chartBarMoyenneConfigPeriode})}function amFormat(date){return moment(date).format("dddd Do MMMM")}function notesParPeriode(periode,codeMatiere,codeSousMatiere,isToutesLesNotes){isToutesLesNotes=angular.isDefined(isToutesLesNotes)?isToutesLesNotes:!0;var noteSurMin=isToutesLesNotes?"-9999":"0";if(4===periode.idPeriode.indexOf("R")){var dd=periode.dateDebut,df=periode.dateFin;return lodash.filter($scope.notes,function(note){return note.date>=dd&&note.date<=df&&note.codeMatiere===codeMatiere&&note.codeSousMatiere===codeSousMatiere&&note.noteSur!==noteSurMin})}return periode.annuel?lodash.filter($scope.notes,function(note){return note.codeMatiere===codeMatiere&&note.codeSousMatiere===codeSousMatiere&&note.noteSur!==noteSurMin}):lodash.filter($scope.notes,function(note){return 0===note.codePeriode.indexOf(periode.idPeriode)&&note.codeMatiere===codeMatiere&&note.codeSousMatiere===codeSousMatiere&&note.noteSur!==noteSurMin})}function isExamenBlanc(note){return note.codePeriode.length>4&&"X"===note.codePeriode[4]}function isNewNote(note){return note.dateSaisie+" 23:59">Auth.currentUser().lastConnexion}function isSousPeriode(idPeriode){return idPeriode.length>4}function showGraph(periode,nomMatiere,codeMatiere,codeSousMatiere){var configChart={options:{chart:{type:"line",zoomType:"x",panning:!0,panKey:"shift"},title:{text:""},tooltip:{style:{padding:10,fontWeight:"bold"},xDateFormat:"%A %d %B",shared:!0,valueSuffix:" /"},exporting:{enabled:!1},xAxis:{type:"datetime",labels:{format:"{value:%d/%m/%y}",align:"right",rotation:-30}},yAxis:{title:{text:"notes /"},min:0,max:20},plotOptions:{line:{threshold:10}},legend:{enabled:!1}},series:[],loading:!1,size:{height:600}},moyenneSur=$scope.parametrage.moyenneSur?$scope.parametrage.moyenneSur:"20";moyenneSur=parseInt(moyenneSur),configChart.options.tooltip.valueSuffix+=moyenneSur,configChart.options.yAxis.title.text+=moyenneSur,configChart.options.yAxis.max=moyenneSur;for(var lesnotes=notesParPeriode(periode,codeMatiere,codeSousMatiere),notesSerie={type:"line",name:"Evolution des notes sur la période",lineWidth:2,threshold:10,data:[]},yANote=!1,k=0;k<lesnotes.length;k++){var note=lesnotes[k];if(!note.enLettre&&"0"!==note.noteSur){var date=moment(note.date).valueOf()+432e5,noteSurVingt=parseFloat(note.valeur.replace(",","."))/parseFloat(note.noteSur)*moyenneSur;noteSurVingt=parseFloat(noteSurVingt.toFixed(2));var point=[date,noteSurVingt];yANote=!0,notesSerie.data.push(point)}}yANote&&configChart.series.push(notesSerie),$scope.dialogData={discipline:nomMatiere,configChart:configChart},$uibModal.open({templateUrl:"modules/notes/eleve/showgraph.html",scope:$scope,windowClass:"graph-notes-dialog"})}function infosNote(note,dateNote){var texte="";return $scope.parametrage.typeDevoir&&""!==note.typeDevoir&&(texte+=note.typeDevoir),$scope.parametrage.libelleDevoir&&""!==note.devoir&&(texte+=" - "+note.devoir),$scope.parametrage.dateDevoir&&dateNote&&(texte+=" - du "+dateNote),"0"!==note.noteSur&&(Auth.isProfesseur()||Auth.isPersonnel())&&angular.isDefined($scope.paramNoteEtab.avecDecalage)&&"0"!==$scope.paramNoteEtab.avecDecalage&&(texte+=" (Note affichée le : "+amFormat(CarnetNotesService.getDateAffichageDevoirNote(note.dateSaisie,!1,$scope.paramNoteEtab))+")"),texte}function moyenneDisponiblePeriode(periode){var moyenneVisible=!0,isPeriodeReleve="A"===periode.idPeriode.charAt(0)&&periode.idPeriode.indexOf("R")>0,isHorsPeriode="H"===periode.idPeriode.charAt(0),uniquementPeriodeCloture=$scope.parametrage.moyenneUniquementPeriodeCloture;return uniquementPeriodeCloture&&!periode.cloture?moyenneVisible=!1:(periode.annuel&&!$scope.parametrage.moyennePeriodeAnnuelle&&(moyenneVisible=!1),isPeriodeReleve&&!$scope.parametrage.moyennePeriodeReleve&&(moyenneVisible=!1),isHorsPeriode&&!$scope.parametrage.moyennePeriodeHorsP&&(moyenneVisible=!1)),moyenneVisible}function nbColonnesMoyenne(isClasse){var nbCol=0;return angular.isUndefined(isClasse)&&$scope.parametrage.moyenneEleve&&$scope.parametrage.moyenneEleveDansMoyenne&&nbCol++,$scope.parametrage.moyenneClasse&&nbCol++,$scope.parametrage.moyenneMin&&nbCol++,$scope.parametrage.moyenneMax&&nbCol++,nbCol}function showSaisiesCdt(elemProg){var modalInstance=$uibModal.open({templateUrl:"modules/notes/liste-saisies-cdt-element-programme-template.html",controller:"ElemProgCdtSaisiesCtrl as elemProgCdtSaisie",backdrop:!1,size:"lg",resolve:{elemProg:function(){return elemProg.descriptif=elemProg.libelleElementProgramme,elemProg},idEleve:function(){return $scope.idEleve}}});modalInstance.result.then(function(){})}function parseStringToInteger(str){return parseInt(str)}function isSaisieAppreciationEnableMatiere(matiereCurrent){return $scope.currentPeriode.saisieAppreciation===!1?!1:""===matiereCurrent.codeSousMatiere?matiereCurrent.saisieAppreciationSSMat===!1:matiereCurrent.saisieAppreciationSSMat}$scope.updateGraph=updateGraph,$scope.refresh=refresh,$scope.setSelectedPeriode=setSelectedPeriode,$scope.setSelectedView=setSelectedView,$scope.shouldIDisplayMoyenne=shouldIDisplayMoyenne,$scope.notesParPeriode=notesParPeriode,$scope.isExamenBlanc=isExamenBlanc,$scope.isNewNote=isNewNote,$scope.isSousPeriode=isSousPeriode,$scope.amFormat=amFormat,$scope.showGraph=showGraph,$scope.infosNote=infosNote,$scope.moyenneDisponiblePeriode=moyenneDisponiblePeriode,$scope.nbColonnesMoyenne=nbColonnesMoyenne,$scope.openDetailDevoir=openDetailDevoir,$scope.getEvaluationComposanteEleve=getEvaluationComposanteEleve,$scope.nbPoints=nbPoints,$scope.totalPoint=totalPoint,$scope.isEvaluationsComposantesActif=isEvaluationsComposantesActif,$scope.showSaisiesCdt=showSaisiesCdt,$scope.parseStringToInteger=parseStringToInteger,$scope.isSaisieAppreciationEnableMatiere=isSaisieAppreciationEnableMatiere,$scope.periodes=[],$scope.notes=[],$scope.parametrage={},$scope.notesVisible=!0,$scope.moyennesVisible=!0,$scope.isLoaded=!1,$scope.currentPeriodeIndex=0,$scope.selected="#periode"+$scope.currentPeriodeIndex,$scope.selectedView="notes",$scope.chartRadarMoyenneConfig={},$scope.chartBarMoyenneConfig={},$scope.Auth=Auth,$scope.CompetencesService=CompetencesService,$scope.isModeConseilDeClasse=angular.isDefined($scope.isModeConseilDeClasse)?$scope.isModeConseilDeClasse:!1,$scope.startingDate=angular.isDefined($routeParams.date)?$routeParams.date:moment().format("YYYY-MM-DD"),$scope.paramNoteEtab=angular.isDefined($scope.paramNoteEtab)?$scope.paramNoteEtab:{},$scope.recompileAllTheThings={value:!1},Auth.isPersonnel()&&($scope.notesVisible=ModuleService.isModuleEnabled(ModuleService.CODES.NOTES),$scope.moyennesVisible=ModuleService.isModuleEnabled(ModuleService.CODES.MOYENNES)),Auth.isProfesseur()&&($scope.notesVisible=!0,$scope.moyennesVisible=!0),angular.isUndefined($scope.isConsultationEnSaisie)&&($scope.isConsultationEnSaisie=!1),Highcharts.setOptions({lang:{months:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],shortMonths:["Jan","Fév","Mar","Avr","Mai","Juin","Juil","Août","Sep","Oct","Nov","Déc"],thousandsSep:" ",weekdays:["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],noData:"Aucune donnée à afficher",loading:"Chargement...",decimalPoint:",",resetZoom:"Remise à zéro du zoom",resetZoomTitle:"Remise à zéro du zoom"}});var chartRadarMoyenneConfigDefault={options:{chart:{polar:!0,marginBottom:60,marginTop:100},title:{text:""},pane:{size:"100%"},exporting:{enabled:!1},xAxis:{categories:[],tickmarkPlacement:"on",lineWidth:0},yAxis:{lineWidth:0,min:0,max:20},tooltip:{shared:!0,valueSuffix:" /"},legend:{align:"center",verticalAlign:"top",layout:"vertical",borderColor:"#B8B8B8",borderRadius:5,borderWidth:1,backgroundColor:"#FFFFFF",shadow:!0}},series:[{name:"Moyennes de l'élève",data:[],pointPlacement:"on",threshold:10,color:"#FE3E3E",lineWidth:3,type:"line"},{name:"Moyennes de la classe",data:[],pointPlacement:"on",threshold:10,color:"#000000",lineWidth:1,type:"line"}],loading:!1,size:{height:600}},chartBarMoyenneConfigDefault={options:{chart:{inverted:!1,animation:{duration:1500}},title:{},exporting:{enabled:!1},xAxis:{categories:[],labels:{style:{"font-size":"10px","margin-bottom":"20px"}}},yAxis:{title:{text:"moyennes /"},min:0,max:20},tooltip:{},legend:{align:"center",verticalAlign:"top",layout:"vertical",borderColor:"#B8B8B8",borderRadius:5,borderWidth:1,backgroundColor:"#FFFFFF",shadow:!0}},series:[{type:"scatter",name:"Moyennes de l'élève",data:[],pointPlacement:"on",zIndex:3,tooltip:{enabled:!0,pointFormat:"<b>{point.y}</b><br/>",shared:!0,crosshairs:!0,valueSuffix:" /"},color:"#FE3E3E",lineWidth:3},{type:"scatter",name:"Moyennes de la classe",data:[],pointPlacement:"on",zIndex:2,tooltip:{pointFormat:"<b>{point.y}</b><br/>",shared:!0,crosshairs:!0,valueSuffix:" /"},color:"#000000",lineWidth:1},{type:"columnrange",color:"#7CB5EC",name:"Moyennes min et max de la classe",data:[],tooltip:{enabled:!1},zIndex:1,shadow:!0,threshold:10}],loading:!1,size:{height:600}};$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.NOTES,$routeParams.ideleve),$scope.$watch("idEleve",function(newValue,oldValue){angular.isDefined(newValue)&&newValue!==oldValue&&($scope.idEleve=newValue,refresh())}),$scope.testFn=function(data,idxApp,codePeriode,codeMatiere,codeSSMatiere){return $scope.onEditAppreciation({app:data,appIdx:idxApp,codePeriode:codePeriode,codeMatiere:codeMatiere,codeSSMatiere:codeSSMatiere})}}]).directive("editAppreciation",["$q","$timeout","lodash","UserService","$uibModal",function($q,$timeout,lodash,UserService,$uibModal){return{restrict:"A",scope:{onBeforeSave:"&",data:"=",edIdClasse:"=",edIdxApp:"=",edCodePeriode:"=",edCodeMatiere:"=",edCodeSsMatiere:"=",edAppreciationParam:"="},transclude:!0,templateUrl:"modules/notes/eleve/edit-appreciation-template.html",link:function(scope,element,attrs){element.on("click",function(){scope.openEditModal()}),UserService.getClassesByEtabs().then(function(classes){var periode=lodash.chain(classes).find({id:scope.edIdClasse}).pick("periodes").thru(function(val){return val.periodes}).find({codePeriode:scope.edCodePeriode}).value();scope.editable=periode.saisieAppreciation}),scope.onSave=function(data){scope.promiseLoading=$q.when(scope.onBeforeSave({app:data,appIdx:scope.edIdxApp,codePeriode:scope.edCodePeriode,codeMatiere:scope.edCodeMatiere,codeSSMatiere:scope.edCodeSsMatiere}),function(r){scope.data=scope.modifiedData,scope.isActive=!1},function(err){scope.isActive=!1})},scope.openEditModal=function(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/eleve/edit-appreciation-modal-template.html",controller:"EditAppInlineCtrl as editAppInline",backdrop:!1,size:"lg",resolve:{options:function(){var options={};return options.title="Modification de l'appréciation",options.parametrage=scope.edAppreciationParam,options.modifiedData=angular.copy(scope.data),options}}});modalInstance.result.then(function(data){scope.modifiedData=data,scope.data=data,scope.onSave(data)})}}}}]).controller("EditAppInlineCtrl",["options","$uibModalInstance",function(options,$uibModalInstance){var vm=this;vm.title=options.title,vm.parametrage=options.parametrage,vm.modifiedData=options.modifiedData,vm.save=function(data){angular.isDefined(data)&&$uibModalInstance.close(data)},vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.Note").controller("ElevenotesCtrl",["$scope","$routeParams","$location","ModuleService","Auth",function($scope,$routeParams,$location,ModuleService,Auth){if($scope.idEleve=$routeParams.ideleve,Auth.isProfesseur()){if(!ModuleService.isModuleEnabled(ModuleService.CODES.CARNET_NOTES))return $location.path("")}else if(!ModuleService.isModuleEnabled(ModuleService.CODES.NOTES,$scope.idEleve))return $location.path("")}]),angular.module("edsiteApp.Note").service("NoteService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mNoteService={};return mNoteService.eleveNotes=function(idEleve){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/notes";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mNoteService.notesProf=function(){var defer=$q.defer(),data={},baseUrl="notesProf";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mNoteService.notesProfDevoirs=function(){var defer=$q.defer(),data={},baseUrl="notesProfDevoirs";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mNoteService}]),angular.module("edsiteApp.emploiDuTemps",["ngLodash","angularMoment","edsiteApp.Commun","ui.bootstrap"]).controller("EmploidutempsCtrl",["$scope","$routeParams","$filter","$location","Auth","ModuleService","lodash","EmploiDuTempsService","UserService","$uibModal","Notification","user","GroupesFlexiblesService",function($scope,$routeParams,$filter,$location,Auth,ModuleService,lodash,EmploiDuTempsService,UserService,$uibModal,Notification,user,GroupesFlexiblesService){function getScope(){return vm}function refresh(){if(vm.events=[],
vm.scheduler=EmploiDuTempsService.scheduler,vm.isModuleEnabled=ModuleService.isModuleEnabled,$scope.$on("$destroy",function(){lodash.remove(EmploiDuTempsService.agendasToDisplay,{edtCourant:!0})}),ModuleService.clearBadges(ModuleService.CODES.EDT,vm.idEntity),Auth.isEleve()||Auth.isFamille()){var idEleve;Auth.isFamille()&&(idEleve=vm.idEntity),EmploiDuTempsService.getGroupesFlexibles(moment().format("YYYY-MM-DD"),void 0,idEleve).then(function(tabGroupes){vm.listeGroupesFlexiblesInscriptions=EmploiDuTempsService.listeGroupesFlexiblesInscriptions})}}function selectGroupOnly(){vm.contexteEnCours=vm.groupeOriginal,vm.classe=void 0,vm.groupe=vm.groupeOriginal,vm.typeEntity="G",vm.idEntity=vm.idcontexteOriginal,vm.refresh(),vm.statusDropdown.isClassesOpen=!1;var serviceAgendaCourant=lodash.find(EmploiDuTempsService.agendasToDisplay,{edtCourant:!0});angular.isDefined(serviceAgendaCourant)&&(serviceAgendaCourant.typeEntity=vm.typeEntity,serviceAgendaCourant.idEntity=vm.idEntity)}function selectClassForGroupe(classe){vm.contexteEnCours=classe,vm.classe=classe,vm.typeEntity="C",vm.idEntity=classe.id,vm.refresh(),vm.statusDropdown.isClassesOpen=!1;var serviceAgendaCourant=lodash.find(EmploiDuTempsService.agendasToDisplay,{edtCourant:!0});angular.isDefined(serviceAgendaCourant)&&(serviceAgendaCourant.typeEntity=vm.typeEntity,serviceAgendaCourant.idEntity=vm.idEntity)}function dispenserCours(id){if(id){var modalInstance=$uibModal.open({templateUrl:"modules/emploiDuTemps/dispenser-cours.template.html",controller:"DispenserCoursCtrl",size:"sm",resolve:{config:function(){return{}},event:function(){return EmploiDuTempsService.getCours(id)}}});modalInstance.result.then(function(success){success?Notification.notify("Le cours a bien été dispensé","","success"):Notification.notify("Une erreur s'est produite","","error")})}}function onSelectInscription(inscription,$event){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Nouvelle inscription",config.message="Confirmer l'inscription au groupe "+inscription.libelle+" du "+moment(inscription.dateDebut).format("dddd D MMMM")+" au "+moment(inscription.dateFin).format("dddd D MMMM")+"?",config.confirm="Oui, je m'inscris",config.cancel="Non",config}}});modalInstance.result.then(function(){var idEleve=Auth.currentUser().id;Auth.isFamille()&&(idEleve=vm.idEntity),GroupesFlexiblesService.inscrireEleve(idEleve,inscription.idPeriode,inscription.idGroupe).then(function(){inscription.isInscrit=!0,Notification.notify("Inscription groupe","Votre inscription a bien été prise en compte","success")},function(error){inscription.isInscrit=!1,$event.target.checked=!1,Notification.notify("Inscription groupe",error.data.message||"Une erreur s'est produite","error")})},function(){inscription.isInscrit=!1,$event.target.checked=!1})}var vm=this;return vm.getScope=getScope,vm.refresh=refresh,vm.selectGroupOnly=selectGroupOnly,vm.selectClassForGroupe=selectClassForGroupe,vm.dispenserCours=dispenserCours,vm.onSelectInscription=onSelectInscription,vm.isOpen=!0,angular.isDefined($routeParams.idEntity)?(vm.typeEntity=$filter("translateTypeUserToShortcut")($routeParams.typeEntity),vm.idEntity=$routeParams.idEntity,"C"===vm.typeEntity&&UserService.getClassesByEtabs().then(function(classes){var classe=lodash.find(classes,{classeId:parseInt(vm.idEntity)});angular.isDefined(classe)&&(vm.classe=classe)}),"G"===vm.typeEntity&&(vm.contexteOriginal="G",vm.idcontexteOriginal=vm.idEntity,vm.contexteEnCours=void 0,UserService.getGroupes().then(function(groupes){var groupe=lodash.find(groupes,{id:parseInt(vm.idEntity)});angular.isDefined(groupe)&&(vm.groupe=groupe,vm.groupeOriginal=groupe,vm.lesClassesOriginal=groupe.classes)}))):(vm.typeEntity="E",vm.idEntity=$routeParams.idEleve),"E"!==vm.typeEntity||(vm.user=user,ModuleService.isModuleEnabled(ModuleService.CODES.EDT,vm.idEntity))?(Auth.isEleve()||"E"!==vm.typeEntity||(vm.eleve=vm.user),void vm.refresh()):$location.path("")}]),angular.module("edsiteApp.PersonnelConsultation",["edsiteApp.Commun"]).controller("PersonnelconsultationeleveCtrl",["$scope","$document","$location","$sessionStorage","$rootScope","$q","$filter","$routeParams","$uibModal","lodash","Auth","UserService","PersonnelconsultationService","ModuleService","EmploiDuTempsService","AppelService","MenuService",function($scope,$document,$location,$sessionStorage,$rootScope,$q,$filter,$routeParams,$uibModal,lodash,Auth,UserService,PersonnelconsultationService,ModuleService,EmploiDuTempsService,AppelService,MenuService){function refresh(){angular.isDefined(vm.currentGroupe)?vm.selected="#groupe":vm.selected="#classe",vm.promiseContents=UserService.getListeEtablissements().then(function(etabs){vm.etablissements=etabs;var listeClasses=[];return angular.forEach(etabs,function(etab){listeClasses=listeClasses.concat(lodash.chain(etab.niveaux).pluck("classes").flatten().pluck("id").value())}),angular.isUndefined(PersonnelconsultationService.listClassesToDisplay)&&(vm.listClassesToDisplay=listeClasses,PersonnelconsultationService.listClassesToDisplay=angular.copy(vm.listClassesToDisplay)),UserService.getGroupes()}).then(function(lesgroupes){return vm.groupes=lesgroupes,UserService.getClassesByEtabs().then(function(lesClasses){0===lesClasses.length&&vm.groupes.length>0&&"#groupe"!==vm.selected&&vm.setSelectedEntity("#groupe")}),UserService.getSalles()}).then(function(lesSalles){var sallesByLocalisation=lodash.chain(lesSalles).sortBy("libelle").groupBy("localisation").value(),sallesWithoutLocalisation=sallesByLocalisation[""];delete sallesByLocalisation[""],vm.tabSallesWithLocalisation=sallesByLocalisation,vm.tabSallesWithoutLocalisation=sallesWithoutLocalisation})}function shouldIDisplayClasse(idClasse){return-1!==vm.listClassesToDisplay.indexOf(idClasse)}function shouldIDisplayEleve(idEleve){return-1!==PersonnelconsultationService.resultatsRechercheIdEleve.indexOf(idEleve)}function setSelectedEntity(view){vm.selected=view,vm.eleves=[],"#classe"===view&&($location.search("groupe",null),angular.isDefined(vm.currentClasse)&&""!==vm.currentClasse&&listEleves(vm.currentClasse,"classes")),"#groupe"===view&&angular.isDefined(vm.currentGroupe)&&""!==vm.currentGroupe&&listEleves(vm.currentGroupe,"groupes")}function selectSalle(laSalle){vm.currentSalle=laSalle,$scope.currentSalleId=laSalle.id,$sessionStorage["consultation-salle"]=laSalle;var agendaToUpdate=lodash.find(EmploiDuTempsService.agendasToDisplay,{edtCourant:!0});angular.isDefined(agendaToUpdate)&&(agendaToUpdate.idEntity=laSalle.id,agendaToUpdate.libelle="Emploi du temps Salle "+laSalle.libelle)}function listEleves(idEntity,entity){vm.eleves=!0,vm.promiseContentsEleve=PersonnelconsultationService.listeEleves(idEntity,entity).then(function(eleves){vm.eleves=!1,vm.entity={id:parseInt(idEntity),type:$filter("translateTypeUserToShortcut")(entity)},angular.isDefined(eleves)&&(vm.eleves=eleves.eleves,vm.entity=eleves.entity);var encartEleves=angular.element("#ancreEleves");if(encartEleves.length>0){var body=angular.element("body"),top=body.css("padding-top");$document.scrollToElement(encartEleves,parseInt(top)+90,500)}})}function go(url){$location.path(url)}function goToEleve(eleve){if(Auth.isProfesseur()){var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,(vm.seulPPVoieToutesLesNotes&&angular.isDefined($sessionStorage["consultation-classe"])&&$sessionStorage["consultation-classe"].isPP||!vm.seulPPVoieToutesLesNotes)&&($sessionStorage["consultation-eleve"]=eleve,$rootScope.consultationEleve=!0,PersonnelconsultationService.canConsultEleve()&&(vm.url="/Eleves/"+eleve.id+"/CoordonneesFamille",$location.path(vm.url))),deleteDoublonsInstanceMenuCourant("prof-eleve")}else $sessionStorage["consultation-eleve"]=eleve,$rootScope.consultationEleve=!0,PersonnelconsultationService.canConsultEleve()&&(vm.url="/Eleves/"+eleve.id+"/CoordonneesFamille",$location.path(vm.url)),deleteDoublonsInstanceMenuCourant("personnel-eleve")}function saveClasse(classe,hasToSearch,pathToGo){if(delete $sessionStorage["consultation-eleve"],delete $sessionStorage["consultation-groupe"],$sessionStorage["consultation-classe"]=classe,hasToSearch)$location.path("/Classes").search("classe",classe.id);else{var chemin="/Classes/"+classe.id+"/"+pathToGo;$location.path(chemin)}deleteDoublonsInstanceMenuCourant("classe")}function saveGroupe(groupe,hasToSearch,pathToGo){if($location.search().classe&&$location.search("classe",null),delete $sessionStorage["consultation-eleve"],delete $sessionStorage["consultation-classe"],$sessionStorage["consultation-groupe"]=groupe,hasToSearch)$location.path("/Classes").search("groupe",groupe.id);else{var chemin="/Groupes/"+groupe.id+"/"+pathToGo;$location.path(chemin)}deleteDoublonsInstanceMenuCourant("groupe")}function saveCommun(entity){"C"===entity.type?saveClasse(entity):saveGroupe(entity)}function filtrerClasseParEleve(event){13===event.keyCode&&applyRechercheEleve(),27===event.keyCode&&resetRechercheEleve()}function applyRechercheEleve(){""!==vm.queryEleve?PersonnelconsultationService.rechercheEleve(vm.queryEleve).then(function(data){vm.listClassesToDisplay=lodash.chain(data).pluck("idClasse").value(),PersonnelconsultationService.listClassesToDisplay=angular.copy(vm.listClassesToDisplay),PersonnelconsultationService.queryEleve=vm.queryEleve}):resetRechercheEleve()}function resetRechercheEleve(withoutRefresh){vm.queryEleve="",PersonnelconsultationService.queryEleve=vm.queryEleve,delete PersonnelconsultationService.listClassesToDisplay,PersonnelconsultationService.resultatsRechercheIdEleve=[],withoutRefresh||refresh()}function openCreateReservationSalleDialog(){var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,windowClass:"dialog-agenda",resolve:{options:function(){var options={};return options.title="Réservation de salle "+vm.currentSalle.libelle,options.mode="create",options.idUser=Auth.currentUser().id,options.typeUser=Auth.currentUser().typeCompte,options.selectedTargets=[AppelService.typeEntity.SALLE+vm.currentSalle.id],options.displayTargets="false",options.isReservationSalle=!0,options},event:function(){return{}}}});modalInstance.result.then(function(){$scope.$broadcast("refresh-edt-events")})}function deleteDoublonsInstanceMenuCourant(typeMenu){var tabMenus=lodash.reject(MenuService.getTabsMenus(),{type:typeMenu});MenuService.setTabsMenus(tabMenus)}var vm=this;vm.url="",vm.typeUser=Auth.role(),vm.currentClasse=$routeParams.classe,vm.currentGroupe=$routeParams.groupe,vm.CDTClasseVisible=ModuleService.isModuleEnabled(ModuleService.CODES.CAHIER_DE_TEXTES),vm.EDTClasseVisible=ModuleService.isModuleEnabled(ModuleService.CODES.EDT),vm.AppelClasseVisible=ModuleService.isModuleEnabled(ModuleService.CODES.APPEL),vm.conseilDeClasse=ModuleService.isModuleEnabled(ModuleService.CODES.CONSEIL_DE_CLASSE),vm.typeEntity="Classes",vm.modeEdition="edition"===$routeParams.etat,vm.isGroupe=!1,vm.queryEleve=PersonnelconsultationService.queryEleve,vm.listClassesToDisplay=PersonnelconsultationService.listClassesToDisplay,$scope.scheduler=EmploiDuTempsService.scheduler,vm.listEleves=listEleves,vm.go=go,vm.goToEleve=goToEleve,vm.saveClasse=saveClasse,vm.selectSalle=selectSalle,vm.saveGroupe=saveGroupe,vm.saveCommun=saveCommun,vm.setSelectedEntity=setSelectedEntity,vm.filtrerClasseParEleve=filtrerClasseParEleve,vm.shouldIDisplayClasse=shouldIDisplayClasse,vm.shouldIDisplayEleve=shouldIDisplayEleve,vm.applyRechercheEleve=applyRechercheEleve,vm.resetRechercheEleve=resetRechercheEleve,vm.openCreateReservationSalleDialog=openCreateReservationSalleDialog,vm.deleteDoublonsInstanceMenuCourant=deleteDoublonsInstanceMenuCourant,angular.isDefined(vm.currentClasse)?(listEleves(vm.currentClasse,"classes"),vm.typeEntity="Classes"):delete $sessionStorage["consultation-classe"],angular.isDefined(vm.currentGroupe)?(listEleves(vm.currentGroupe,"groupes"),vm.typeEntity="Groupes",vm.isGroupe=!0):delete $sessionStorage["consultation-groupe"],angular.isUndefined(vm.currentGroupe)&&angular.isUndefined(vm.currentClasse)&&resetRechercheEleve(!0),$scope.$on("$destroy",function(){lodash.remove(EmploiDuTempsService.agendasToDisplay,{edtCourant:!0})}),refresh()}]),angular.module("edsiteApp.PersonnelConsultation").controller("PersonnelconsultationeditionCtrl",["$routeParams","$sessionStorage","lodash","CarnetNotesService","UserService","Auth","ModuleService",function($routeParams,$sessionStorage,lodash,CarnetNotesService,UserService,Auth,ModuleService){function refresh(){vm.classeLibelle=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].libelle:$sessionStorage["consultation-groupe"].libelle,vm.idCycleEtablissement=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].idCycleEtab:$sessionStorage["consultation-groupe"].idCycleEtab,vm.entityType===CarnetNotesService.typeEntity.CLASSE?vm.periodesBulletinAndReleves=$sessionStorage["consultation-classe"].periodes:(allPeriodes=$sessionStorage["consultation-groupe"].periodes,vm.promiseContents=vm.promiseContents=UserService.getListeEtablissements().then(function(etabs){getPeriodesClassesForGroupe(etabs)}))}function getPeriodesClassesForGroupe(etabs){var etablissementGroupe=lodash.find(etabs,{id:$sessionStorage["consultation-groupe"].etabId}),classesOfGroupe=$sessionStorage["consultation-groupe"].classes;lodash.forEach(etablissementGroupe.niveaux,function(niveau){lodash.find(niveau.classes,function(classe){var indexClasse=lodash.findIndex(classesOfGroupe,{id:classe.id});indexClasse>-1&&(classesOfGroupe[indexClasse].periodes=classe.periodes)})}),Auth.isPersonnel()&&lodash.forEach(classesOfGroupe,function(classe){classe.periodes=lodash.filter(classe.periodes,function(periode){return 4===periode.codePeriode.length||"R"===periode.codePeriode[4]}),classe.periodes.push({codePeriode:CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE,libelle:"Année"})}),Auth.isProfesseur()&&(allPeriodes=lodash.chain(allPeriodes).uniq("codePeriode").reject(function(periode){return 4!==periode.codePeriode.length&&"R"!==periode.codePeriode[4]}).value(),allPeriodes.push({codePeriode:CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE,libelle:"Année"}),lodash.forEach(classesOfGroupe,function(classe){classe.periodes=allPeriodes})),vm.classesGroupe=classesOfGroupe}function setCodePeriode(codePeriodeCourant){"R"===codePeriodeCourant[4]?vm.additionalData.avecPeriodeReleve=!0:vm.additionalData.avecPeriodeReleve=!1,vm.additionalData.codePeriode=codePeriodeCourant}var allPeriodes=[],vm=this;if(vm.setCodePeriode=setCodePeriode,vm.getPeriodesClassesForGroupe=getPeriodesClassesForGroupe,vm.url="",vm.entityType=$routeParams.entityType[0],vm.entityId=$routeParams.entityId,vm.additionalData={sousMatiere:"1"},vm.moduleConseilClasseActif=!1,Auth.isPersonnel())vm.moduleConseilClasseActif=ModuleService.getModule(ModuleService.CODES.CONSEIL_DE_CLASSE).enable;else{var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES),seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes;vm.moduleConseilClasseActif=seulPPVoieToutesLesNotes&&angular.isDefined($sessionStorage["consultation-classe"])&&$sessionStorage["consultation-classe"].isPP||!seulPPVoieToutesLesNotes}refresh()}]),angular.module("edsiteApp.PersonnelConsultation").controller("PersonnelconsultationVSCtrl",["$routeParams","$sessionStorage","PersonnelconsultationService","Auth","ModuleService","lodash",function($routeParams,$sessionStorage,PersonnelconsultationService,Auth,ModuleService,lodash){function refresh(){vm.classeLibelle=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].libelle:$sessionStorage["consultation-groupe"].libelle,vm.idCycleEtablissement=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].idCycleEtab:$sessionStorage["consultation-groupe"].idCycleEtab,vm.promiseLoading=PersonnelconsultationService.listeVS(vm.entityId,vm.entityType).then(function(tabEventsVs){vm.parametrage=tabEventsVs.parametrage,vm.listeAbsencesRetards=lodash.reject(tabEventsVs.evenements,function(eventVs){return"Retard"!==eventVs.typeElement&&"Absence"!==eventVs.typeElement}),vm.listeAbsencesRetardsDisplay=[].concat(vm.listeAbsencesRetards),vm.listeSanctions=lodash.reject(tabEventsVs.evenements,function(eventVs){return"Punition"!==eventVs.typeElement}),vm.listeSanctionsDisplay=[].concat(vm.listeSanctions),vm.listeEncouragements=lodash.reject(tabEventsVs.evenements,function(eventVs){return"Felicitation"!==eventVs.typeElement}),vm.listeEncouragementsDisplay=[].concat(vm.listeEncouragements)})}var vm=this;vm.url="",vm.entityType=$routeParams.entityType[0],vm.entityId=$routeParams.entityId,vm.listeAbsencesRetards=[],vm.listeAbsencesRetardsDisplay=[],vm.listeSanctions=[],vm.listeSanctionsDisplay=[],vm.listeEncouragements=[],vm.listeEncouragementsDisplay=[],vm.parametrage=[],Auth.isPersonnel()&&(ModuleService.isModuleEnabled(ModuleService.CODES.CONSEIL_DE_CLASSE)?(vm.absenceVisible=!0,vm.retardVisible=!0,vm.sanctionVisible=!0,vm.encouragementVisible=!0):(vm.absenceVisible=ModuleService.isModuleEnabled(ModuleService.CODES.ABSENCES),vm.retardVisible=ModuleService.isModuleEnabled(ModuleService.CODES.RETARDS),vm.sanctionVisible=ModuleService.isModuleEnabled(ModuleService.CODES.SANCTIONS),vm.encouragementVisible=ModuleService.isModuleEnabled(ModuleService.CODES.ENCOURAGEMENTS))),Auth.isProfesseur()&&(vm.absenceVisible=!0,vm.retardVisible=!0,vm.sanctionVisible=!0,vm.encouragementVisible=!0),refresh()}]),angular.module("edsiteApp.PersonnelConsultation").service("PersonnelconsultationService",["$q","$http","EDHttp","ModuleService","lodash",function($q,$http,EDHttp,ModuleService,lodash){var mPersonnelConsultation={};return mPersonnelConsultation.resultatsRechercheIdEleve=[],mPersonnelConsultation.listeEleves=function(idEntity,entity){var defer=$q.defer(),data={},baseUrl=entity+"/"+idEntity+"/eleves";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelConsultation.listeVS=function(idEntity,entity){var defer=$q.defer(),data={},baseUrl=entity+"/"+idEntity+"/vieScolaire";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelConsultation.rechercheEleve=function(query){var defer=$q.defer(),data={},baseUrl="recherche/eleves?query="+query;return new EDHttp({method:"GET",url:baseUrl,data:data}).then(function(response){mPersonnelConsultation.resultatsRechercheIdEleve=lodash.chain(response.data.data).pluck("id").value(),defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelConsultation.canConsultEleve=function(){return ModuleService.isModuleEnabled(ModuleService.CODES.AFFICHAGE_ELEVE)},mPersonnelConsultation}]),angular.module("edsiteApp.accueilPersonnel",["edsiteApp.Commun","edsiteApp.Agenda"]).controller("PersonnelaccueilCtrl",["$scope","$sce","$filter","Settings","Auth","TimelineService","AgendaService",function($scope,$sce,$filter,Settings,Auth,TimelineService,AgendaService){function refresh(){$scope.promiseContents.push(TimelineService.communTimelineAcceuil(Auth.currentUser().typeCompte,Auth.idUser()).then(function(timeline){$scope.tabPostits=timeline.postits,$scope.agendaEvents=timeline.evenements,AgendaService.cleanEventsFromServer($scope.agendaEvents)}))}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}$scope.sanitize=sanitize,$scope.promiseContents=[],$scope.agendaEvents=[],$scope.idUser=Auth.idUser(),$scope.typeUser=Auth.currentUser().typeCompte,$scope.url=Settings.apiUri+"telechargement.awp",$scope.postitConfig={addPostit:!1,updatePostit:!1,deletePostit:!1,displayDateCreated:!0,displayDateLimit:!1,displayTargets:!1,visibilityPostitPast:!1},$scope.agendaDroits={updateAgenda:!1,createAgenda:!1,deleteAgenda:!1},refresh()}]),angular.module("edsiteApp.AccueilEnseignant",["edsiteApp.Commun","edsiteApp.Agenda"]).controller("EnseignantaccueilCtrl",["$scope","$sce","$localStorage","$filter","$q","Settings","Auth","MessagerieService","AgendaService","UserService","ModuleService","lodash","TimelineService",function($scope,$sce,$localStorage,$filter,$q,Settings,Auth,MessagerieService,AgendaService,UserService,ModuleService,lodash,TimelineService){function refresh(){$scope.promiseContent=TimelineService.communTimelineAcceuil(Auth.currentUser().typeCompte,Auth.idUser()).then(function(timeline){$scope.tabPostits=timeline.postits,$scope.agendaEvents=timeline.evenements,AgendaService.cleanEventsFromServer($scope.agendaEvents),$scope.tabReunions=timeline.reunions,angular.forEach($scope.tabReunions,function(laReunion){var rppEvents=[];if(!isPast(laReunion.dateReunion)){var newEventRpp={theid:"rpp"+laReunion.parametrage.id,description:laReunion.parametrage.libelle,date:laReunion.parametrage.date+" "+laReunion.parametrage.heureDebut+":00",title:"Nouvelle réunion parents/prof disponible",href:"/Enseignants/"+$scope.idUser+"/RPP",icon:"icon-ed_reunionparentprof-light"};rppEvents.push(newEventRpp)}$scope.events.push.apply($scope.events,rppEvents)})}),$scope.promiseEvents=MessagerieService.getMessages(Auth.role(),Auth.idUser(),{limit:10,onlyRead:"0"}).then(function(messagerie){var messageEvents=[];messagerie.messages.received=lodash.filter(messagerie.messages.received,{read:!1}),angular.forEach(messagerie.messages.received,function(message){var newEvent={theid:"mess"+message.id,description:message.subject,date:message.date,title:message.from.name,href:"/"+Auth.currentUser().typeCompte+"/"+Auth.idUser()+"/Messagerie?messageId="+message.id,icon:"icon-ed_messagerie-light"};message.read&&(newEvent.icon="icon-ed_messagerie-light"),messageEvents.push(newEvent)}),$scope.events.push.apply($scope.events,messageEvents)}),UserService.getListeEtablissements()}function hideMessage(state){$localStorage.messageHidden=state}function isMessageHidden(){return angular.isDefined($localStorage.messageHidden)?$localStorage.messageHidden:!1}function isPast(leJour){return moment().isAfter(moment(leJour),"day")}function addMoreItems(){$scope.configTimeLine.itemsDisplayedInList<$scope.events.length&&($scope.configTimeLine.itemsDisplayedInList=$scope.configTimeLine.itemsDisplayedInList+1)}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}$scope.sanitize=sanitize,$scope.events=[],$scope.typeUser=Auth.currentUser().typeCompte,$scope.typeUserUrl=$filter("translateTypeUserUrl")($scope.typeUser),$scope.idUser=Auth.idUser(),$scope.configTimeLine={itemsDisplayedInList:16};ModuleService.isModuleEnabled(ModuleService.CODES.MESSAGERIE);$scope.edtActif=ModuleService.isModuleEnabled(ModuleService.CODES.EDT),$scope.scheduler={mode:"day"},$scope.url=Settings.apiUri+"telechargement.awp",$scope.postitConfig={addPostit:!1,updatePostit:!1,deletePostit:!1,displayDateCreated:!0,displayDateLimit:!1,displayTargets:!1,visibilityPostitPast:!1},$scope.agendaDroits={updateAgenda:!1,createAgenda:!1,deleteAgenda:!1},$scope.isPast=isPast,$scope.hideMessage=hideMessage,$scope.isMessageHidden=isMessageHidden,$scope.addMoreItems=addMoreItems,refresh()}]),angular.module("edsiteApp").directive("edtScheduler",["$uibModal","$q","EmploiDuTempsService","AgendaService","DhxSchedulerService","Auth","moment","lodash","AppelService","$timeout",function($uibModal,$q,EmploiDuTempsService,AgendaService,DhxSchedulerService,Auth,moment,lodash,AppelService,$timeout){return{restrict:"A",scope:{dispenserCours:"&dispense",events:"=data",scheduler:"=scheduler",idUser:"=",typeUser:"=",withoutEspacesDeTravail:"=",isReservable:"=",avecTrous:"=?",dblClickEnable:"=?",onClickEvent:"&"},transclude:!0,template:'<div><div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div></div>',link:function(scope,element){function onTemplateReady(){scheduler.templates.event_text=DhxSchedulerService.renderEventText,scheduler.templates.event_bar_text=DhxSchedulerService.renderEventBarText,scheduler.templates.event_header=DhxSchedulerService.renderEventHeader}function onViewChange(){var state=scheduler.getState(),minDate=moment(state.min_date).format("YYYY-MM-DD"),maxDate=moment(state.max_date).subtract(1,"days").format("YYYY-MM-DD");lesPromises.length=0,angular.forEach(EmploiDuTempsService.agendasToDisplay,function(unAgenda){if(unAgenda.selected){var typeEntity=unAgenda.typeEntity,idEntity=unAgenda.idEntity,typeAgenda=unAgenda.typeAgenda,cacheKey=minDate+"||"+maxDate+"||"+typeEntity+"||"+idEntity+"||"+typeAgenda;cacheKey in cacheEvents?$timeout(function(){scope.events=scheduler.getEvents(moment(minDate).toDate(),moment(maxDate).toDate())}):(cacheEvents[cacheKey]=[],"EDT"===typeAgenda?(promiseEdt.promise=EmploiDuTempsService.searchEvents(typeEntity,idEntity,minDate,maxDate,scope.avecTrous),lesPromises.push(promiseEdt.promise),typeEntity===AppelService.typeEntity.SALLE?(promiseAgenda.promise=AgendaService.searchEvents(typeEntity,idEntity,minDate,maxDate),lesPromises.push(promiseAgenda.promise)):typeEntity===Auth.TYPE_USER.ENSEIGNANT&&(promiseAgenda.promise=AgendaService.searchEvents(AppelService.typeEntity.SALLE,0,minDate,maxDate),lesPromises.push(promiseAgenda.promise)),scope.requestLoading=$q.all(lesPromises).then(function(values){var events=[];values.forEach(function(listEvents){events=events.concat(listEvents)}),events.forEach(function(event){angular.extend(event,{typeEntity:typeEntity})}),cacheEvents[cacheKey]=events,scheduler.parse(events,"json"),scope.events=events})):scope.requestLoading=AgendaService.searchEvents(typeEntity,idEntity,minDate,maxDate).then(function(events){cacheEvents[cacheKey]=events,scheduler.parse(events,"json"),scope.events=events}))}})}var events={},promiseEdt=$q.defer(),promiseAgenda=$q.defer(),lesPromises=[];scope.scheduler||(scope.scheduler={}),scope.scheduler.mode=scope.scheduler.mode||"month",scope.scheduler.date=scope.scheduler.date||new Date,scope.avecTrous=scope.avecTrous||!1,scheduler.ignore_week=function(date){};var cacheEvents={};if(!scope.idUser)throw new Error("Missing attribute 'idUser' in directive dhx-scheduler");angular.forEach(EmploiDuTempsService.agendasToDisplay,function(unAgenda){unAgenda.selected=!1});var withoutEspacesDeTravail=1===scope.withoutEspacesDeTravail;EmploiDuTempsService.listeAgendasToDisplay(scope.typeUser,scope.idUser,withoutEspacesDeTravail).then(function(agendasToDisplay){var currentAgenda;currentAgenda=lodash.find(agendasToDisplay,{typeEntity:scope.typeUser,idEntity:parseInt(scope.idUser),typeAgenda:"EDT"}),angular.isDefined(currentAgenda)&&(currentAgenda.selected=!0)}),scope.$watch(function(){return EmploiDuTempsService.listeGroupesFlexiblesInscriptions},function(nv,old){lodash.filter(nv,{isInscrit:!0}).length!==lodash.filter(old,{isInscrit:!0}).length&&(cacheEvents={},scheduler.clearAll(),onViewChange())},!0),scope.$watch(function(){return scope.idUser},function(nv,old){cacheEvents={},scheduler.clearAll(),promiseAgenda.reject(),promiseEdt.reject()},!0),scope.$watch(function(){return EmploiDuTempsService.agendasToDisplay},function(nv,old){nv!==old&&(cacheEvents={},scheduler.clearAll(),onViewChange())},!0),scope.$watch(function(){return{mode:scope.scheduler.mode}},function(nv){var mode=scheduler.getState();nv.mode!==mode.mode&&scheduler.setCurrentView(scope.scheduler.date,scope.scheduler.mode)},!0),scope.$watch(function(){return element[0].offsetWidth+"."+element[0].offsetHeight},function(){scheduler.setCurrentView()}),element.addClass("dhx_cal_container"),events.onTemplateReady=scheduler.attachEvent("onTemplatesReady",onTemplateReady),events.onViewChange=scheduler.attachEvent("onViewChange",onViewChange),angular.isDefined(scope.onClickEvent)?events.onClick=scheduler.attachEvent("onClick",function(id,e){scope.onClickEvent({event:{evenement:scheduler.getEvent(id),e:e}})}):events.onClick=scheduler.attachEvent("onClick",DhxSchedulerService.attacheEvenement),scheduler.initialized=!0,scheduler.config.first_hour=7,scheduler.config.last_hour=23,scheduler.config.separate_short_events=!0,scheduler.config.xml_date="%Y-%m-%d %H:%i",scheduler.config.start_on_monday=!0,scheduler.config.show_loading=!0,scheduler.config.load_date="%Y-%m-%d",scheduler.config.readonly_form=!0,scheduler.config.readonly=!1,scheduler.config.select=!1,scheduler.config.details_on_dblclick=scope.dblClickEnable||!1,scheduler.config.dblclick_create=!1,scheduler.config.drag_create=!1,scheduler.config.drag_resize=!1,scheduler.config.drag_move=!1,scheduler.config.hour_size_px=88,scheduler.config.day_date="%D %j %M",scheduler.config.cascade_event_display=!1,scheduler.showLightbox=function(id){var event;if(angular.forEach(cacheEvents,function(events){event||(event=lodash.find(events,{id:parseInt(id)}))}),!event)return window.alert("Impossible de modifier l'événement");if(angular.isDefined(event.readonly)&&!event.readonly){var isAgendaEspaceTravail=lodash.find(event.cibles,function(cible){return-1!==cible.search("W")}),isReservationSalle=lodash.findIndex(event.cibles,function(cible){return-1!==cible.search(AppelService.typeEntity.SALLE)})>-1;(isAgendaEspaceTravail||isReservationSalle)&&(scope.displayTargets="false");var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,windowClass:"dialog-agenda",resolve:{options:function(){var options={};return options.title="Formulaire de modification "+(isReservationSalle?"d'une réservation":"d'un événement"),options.mode="edit",options.idUser=scope.idUser,options.typeUser=scope.typeUser,options.canDelete=event.estSupprimable,options.displayTargets=scope.displayTargets,options.isReservationSalle=isReservationSalle,options},event:function(){return event}}});modalInstance.result.then(function(event){cacheEvents={},event&&scheduler.deleteEvent(event.id),onViewChange()})}else event.description&&$uibModal.open({templateUrl:"../modules/agenda/event-modal-template.html",controller:"EventModalCtrl",size:"md",resolve:{config:function(){var config={};return config.event=event,config}}})},scheduler.locale.labels.icon_dispenser="Dispenser",scheduler._click.buttons.dispenser=function(id){scope.dispenserCours({id:id})},scheduler.templates.tooltip_text=DhxSchedulerService.renderTooltip,scheduler.init(element[0],scope.scheduler.date,scope.scheduler.mode),scope.$on("refresh-edt-events",function(){cacheEvents={},onViewChange()}),scope.$on("$destroy",function(){promiseAgenda.reject(),promiseEdt.reject(),scheduler.detachEvent(events.onClick),scheduler.detachEvent(events.onViewChange),scheduler.clearAll()}),onViewChange()}}}]),angular.module("edsiteApp").directive("dhxTemplate",["$filter",function($filter){return scheduler.aFilter=$filter,{restrict:"AE",terminal:!0,link:function($scope,$element,$attrs){$element[0].style.display="none";var template=$element[0].innerHTML;template=template.replace(/[\r\n]/g,"").replace(/"/g,'\\"').replace(/\{\{event\.([^\}]+)\}\}/g,function(match,prop){if(-1!==prop.indexOf("|")){var parts=prop.split("|");return"'+scheduler.aFilter('"+parts[1].trim()+"')(event."+parts[0].trim()+")+'"}return'"+event.'+prop+'+"'}),scheduler.templates[$attrs.dhxTemplate]=new Function("sd","ed","event",'return "'+template+'"')}}}]),angular.module("edsiteApp.Commun").service("Notification",["$location","$rootScope",function($location,$rootScope){return PNotify.prototype.options.delay=4e3,{notify:function(titre,message,typeDeMessage,icon,onLeft){var opts={title:titre,text:message,type:typeDeMessage,icon:icon,nonblock:{nonblock:!0,nonblock_opacity:.2
}};angular.isDefined(onLeft)&&(opts.before_open=function(PNotify){PNotify.get().css({top:"15px",left:"60px"})}),new PNotify(opts)},ouinon:function(question,typeDeMessage,siOui,siNon){new PNotify({title:"Demande de confirmation",text:question,icon:"glyphicon glyphicon-question-sign",hide:!1,confirm:{confirm:!0},buttons:{closer:!1,sticker:!1},history:{history:!1}}).get().on("pnotify.confirm",function(){siOui()}).on("pnotify.cancel",function(){siNon()})},notifyWithAction:function(titre,message,typeDeMessage,icon,action,onLeft,desactivationCallback){if($rootScope.Auth.isNotificationsActif()){var opts={title:titre,text:message,type:typeDeMessage,icon:icon,delay:1e4,confirm:{confirm:!0,buttons:[{text:"consulter",addClass:"btn-primary"},{confirm:!1,text:"fermer"}]},buttons:{closer:!0,closer_hover:!1,sticker:!1,show_on_nonblock:!0,labels:{close:"Fermeture",stick:"Stick"}},hide:!1,id:action};angular.isDefined(desactivationCallback)&&opts.confirm.buttons.push({text:"désactiver",click:function(notice){desactivationCallback(),notice.remove()}}),opts.confirm.buttons.length>2&&(opts.width="auto"),angular.isDefined(onLeft)&&(opts.before_open=function(PNotify){PNotify.get().css({top:"15px",left:"60px"})}),new PNotify(opts).get().on("pnotify.confirm",function(e,notice){if(action.split("?").length>1){var params={},lAction=action.split("?")[0],lParams=action.split("?")[1];params=lParams?JSON.parse('{"'+lParams.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(key,value){return""===key?value:decodeURIComponent(value)}):{},$location.path(lAction).search(params)}else $location.path(action);notice.remove()}).on("pnotify.cancel",function(e,notice){notice.remove()})}},notifyOpts:function(options){var opts={title:"",text:"",type:"",icon:""};opts=angular.extend(options),new PNotify(opts)}}}]),angular.module("edsiteApp.vieScolaire",["edsiteApp.Commun","ui.bootstrap","edsiteApp.3DSecure","edsiteApp.base64filter"]).service("VieScolaireService",["$q","$http","$filter","EDHttp","CacheService",function($q,$http,$filter,EDHttp,CacheService){var mVieScolaire={};return mVieScolaire.CONSTANTES={ABSENCE:"Absence",RETARD:"Retard",CANTINE:"Repas",INTERNAT:"Internat",SANCTION:"Punition",ENCOURAGEMENT:"Felicitation"},mVieScolaire.deferDirectiveEleveVS=$q.defer(),mVieScolaire.observeEtatLoadingEleveVSDirective=function(){return mVieScolaire.deferDirectiveEleveVS.promise},mVieScolaire.setEtatLoadingEleveVSDirective=function(val){mVieScolaire.deferDirectiveEleveVS.notify(val)},mVieScolaire.get=function(idEleve){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/viescolaire";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mVieScolaire.justifierAbsence=function(idAbsence,typeAbsence,idEleve,code,message,uncFichier){var defer=$q.defer(),data={signature:{code:code},message:message,fichier:$filter("base64encode")(uncFichier),idAbsence:idAbsence,action:"justificationAbsence",typeAbsence:typeAbsence},baseUrl="eleves/"+idEleve+"/viescolaire";return CacheService.remove(baseUrl),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mVieScolaire}]),angular.module("edsiteApp.vieScolaire").directive("eleveVieScolaire",function(){return{restrict:"E",scope:{idEleve:"=",isModeConseilDeClasse:"=",isConsultationEnSaisie:"="},controller:"EleveviescolaireDirectiveCtrl",templateUrl:"modules/vieScolaire/vie-scolaire-template.html",link:function(scope,element,attrs){}}}).controller("EleveviescolaireDirectiveCtrl",["$scope","$routeParams","$uibModal","$sessionStorage","$uibModalStack","ModuleService","VieScolaireService","UserService","Settings","Auth","Notification","lodash",function($scope,$routeParams,$uibModal,$sessionStorage,$uibModalStack,ModuleService,VieScolaireService,UserService,Settings,Auth,Notification,lodash){function refreshCount(){$scope.compteursAbsences=lodash.countBy($scope.donnesVieScolaire.absencesRetards,function(abs){return abs.typeElement}),$scope.compteursSanctions=lodash.countBy($scope.donnesVieScolaire.sanctionsEncouragements,function(evenement){return evenement.typeElement})}function goToAnchor(anchor){var element=document.getElementById(anchor);element.scrollIntoView()}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}function refresh(){angular.isUndefined($scope.idEleve)||(delete $sessionStorage["consultation-eleve"],UserService.getEleve($scope.idEleve).then(function(eleve){$scope.eleve=eleve}),VieScolaireService.setEtatLoadingEleveVSDirective(!0),$scope.promiseContents=VieScolaireService.get($scope.idEleve).then(function(donnesVieScolaire){angular.isUndefined(donnesVieScolaire)?($scope.aucunEncouragement=!0,$scope.aucuneSanction=!0,$scope.aucuneAbsence=!0):($scope.donnesVieScolaire=donnesVieScolaire,$scope.sanctionVisible=donnesVieScolaire.parametrage.sanctionsVisible,$scope.encouragementVisible=donnesVieScolaire.parametrage.encouragementsVisible,$scope.aucunEncouragement=angular.isUndefined(lodash.find(donnesVieScolaire.sanctionsEncouragements,{typeElement:VieScolaireService.CONSTANTES.ENCOURAGEMENT})),$scope.aucuneSanction=angular.isUndefined(lodash.find(donnesVieScolaire.sanctionsEncouragements,{typeElement:VieScolaireService.CONSTANTES.SANCTION})),$scope.aucuneAbsence=0===donnesVieScolaire.absencesRetards.length,refreshCount()),VieScolaireService.setEtatLoadingEleveVSDirective(!1)}))}function justifier(abs){$scope.evenementVs=abs;var tabContacts=[];tabContacts.push({idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable}),tabContacts.push({idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}),$scope.contacts=tabContacts,self.modaleJustif=$uibModal.open({templateUrl:"modules/vieScolaire/justificationabsence.html",scope:$scope,backdrop:!1})}function justifierAbsence(idAbsence,typeAbsence,code,message){var uncFichier;$scope.fichiers.length>0&&(uncFichier=$scope.fichiers[0].unc),$scope.promise3DSecure=VieScolaireService.justifierAbsence(idAbsence,typeAbsence,$scope.idEleve,code,message,uncFichier).then(function(){Notification.notify("Justification","Absence justifiée","success"),$uibModalStack.dismissAll(),self.abs=lodash.find($scope.donnesVieScolaire.absencesRetards,{id:idAbsence}),self.abs.justifie=!0,self.abs.justifieEd=!0,self.abs.typeJustification="En attente",$scope.fichiers=[]},function(){Notification.notify("Justification","La demande de justification a échouée","error")})}function iconeFor(abs){var icons=[];return icons[VieScolaireService.CONSTANTES.ABSENCE]="icon-ed_absence",icons[VieScolaireService.CONSTANTES.RETARD]="icon-ed_retard",icons[VieScolaireService.CONSTANTES.INTERNAT]="fa-home",icons[VieScolaireService.CONSTANTES.CANTINE]="fa-cutlery",icons[VieScolaireService.CONSTANTES.ENCOURAGEMENT]="icon-ed_encouragement",icons[VieScolaireService.CONSTANTES.SANCTION]="icon-ed_sanction",icons[abs.typeElement]}function visualisationPossible(evenement){var constantesVS=$scope.constantesVS,evenementsTypeAbsence=evenement.typeElement===constantesVS.ABSENCE||evenement.typeElement===constantesVS.INTERNAT||evenement.typeElement===constantesVS.CANTINE,evenementTypeRetad=evenement.typeElement===constantesVS.RETARD,affichageAbsence=evenementsTypeAbsence&&$scope.absenceVisible,affichageRetard=evenementTypeRetad&&$scope.retardVisible,affichageEvenement=!1;return affichageAbsence&&(affichageEvenement=!0),affichageRetard&&(affichageEvenement=!0),affichageEvenement}function close(){self.modaleJustif.close()}$scope.donnesVieScolaire={},$scope.compteursAbsences=0,$scope.compteursSanctions=0,$scope.constantesVS=VieScolaireService.CONSTANTES,$scope.fichiers=[],$scope.vsContexte="Vous avez",$scope.absenceVisible=!0,$scope.retardVisible=!0,$scope.sanctionVisible=!0,$scope.encouragementVisible=!0,$scope.goToAnchor=goToAnchor,$scope.capitalizeFirstLetter=capitalizeFirstLetter,$scope.visualisationPossible=visualisationPossible,$scope.justifier=justifier,$scope.justifierAbsence=justifierAbsence,$scope.iconeFor=iconeFor,$scope.close=close,$scope.Auth=Auth,$scope.isModeConseilDeClasse=angular.isDefined($scope.isModeConseilDeClasse)?$scope.isModeConseilDeClasse:!1,this.abs={};var self=this;$scope.configInputFile={fromCloudEnabled:!1,keepComplete:!0,dropzoneContainer:"#dropzone-container-justif"},$scope.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post",timeout:3e6,maxFilesize:2e3,maxFiles:1},$scope.codes={codeSecure:void 0,codeModule:"vieScolaire"},angular.isUndefined($scope.isConsultationEnSaisie)&&($scope.isConsultationEnSaisie=!1),Auth.isPersonnel()&&(ModuleService.isModuleEnabled(ModuleService.CODES.CONSEIL_DE_CLASSE)?($scope.absenceVisible=!0,$scope.retardVisible=!0,$scope.sanctionVisible=!0,$scope.encouragementVisible=!0):($scope.absenceVisible=ModuleService.isModuleEnabled(ModuleService.CODES.ABSENCES),$scope.retardVisible=ModuleService.isModuleEnabled(ModuleService.CODES.RETARDS),$scope.sanctionVisible=ModuleService.isModuleEnabled(ModuleService.CODES.SANCTIONS),$scope.encouragementVisible=ModuleService.isModuleEnabled(ModuleService.CODES.ENCOURAGEMENTS))),Auth.isProfesseur()&&($scope.absenceVisible=!0,$scope.retardVisible=!0,$scope.sanctionVisible=!0,$scope.encouragementVisible=!0),Auth.isFamille()&&($scope.vsContexte="Votre enfant a"),ModuleService.clearBadges(ModuleService.CODES.VIE_SCOLAIRE,$routeParams.ideleve),$scope.$watch("idEleve",function(newValue){angular.isDefined(newValue)&&($scope.idEleve=newValue,refresh())})}]),angular.module("edsiteApp.vieScolaire").controller("EleveviescolaireCtrl",["Auth","$scope","$routeParams","$location","$q","ModuleService","UserService","FamilleAutorisationSortieService",function(Auth,$scope,$routeParams,$location,$q,ModuleService,UserService,FamilleAutorisationSortieService){function selectOnglet(onglet){vm.ongletSelected=onglet}function refresh(){if(!ModuleService.isModuleEnabled(ModuleService.CODES.VIE_SCOLAIRE,vm.idEleve))return $location.path("");vm.parametragesVieScolaire=angular.copy(ModuleService.getModule(ModuleService.CODES.VIE_SCOLAIRE,vm.idEleve).params),vm.parametragesVieScolaire.autorisationsSortieActif="1"===vm.parametragesVieScolaire.autorisationsSortieActif,vm.parametragesVieScolaire.saisieDemandesFamillesActif="1"===vm.parametragesVieScolaire.saisieDemandesFamillesActif;var lesPromises=[UserService.getEleve(vm.idEleve).then(function(eleve){vm.eleve=eleve})];Auth.isFamille()&&vm.parametragesVieScolaire.autorisationsSortieActif&&lesPromises.push(FamilleAutorisationSortieService.listeAutorisationsSortie(vm.idEleve).then(function(autorisationsSortie){vm.parametragesAutorisationsSortie=autorisationsSortie.parametrage})),vm.promiseContents=$q.all(lesPromises)}var vm=this;vm.idEleve=$routeParams.ideleve,vm.eleve={},vm.parametragesVieScolaire={},vm.parametragesAutorisationsSortie={},vm.ongletSelected="#evenements-vs",vm.promiseContents=null,$scope.Auth=Auth,vm.selectOnglet=selectOnglet,vm.refresh=refresh,vm.refresh()}]),angular.module("edsiteApp.vieScolaire").service("FamilleAutorisationSortieService",["$q","$http","EDHttp","Auth","CacheService","moment",function($q,$http,EDHttp,Auth,CacheService,moment){var FamilleAutorisationSortieServiceHelper={};return FamilleAutorisationSortieServiceHelper.CONSTANTES={MATIN:"Matin",APRES_MIDI:"ApresMidi"},FamilleAutorisationSortieServiceHelper.texteDescriptif="",FamilleAutorisationSortieServiceHelper.d3SecureModal="",FamilleAutorisationSortieServiceHelper.getTexteDescriptifModale3DSecure=function(){return FamilleAutorisationSortieServiceHelper.texteDescriptif},FamilleAutorisationSortieServiceHelper.setTexteDescriptifModale3DSecure=function(descriptif){FamilleAutorisationSortieServiceHelper.texteDescriptif=descriptif},FamilleAutorisationSortieServiceHelper.getd3SecureModal=function(){return FamilleAutorisationSortieServiceHelper.d3SecureModal},FamilleAutorisationSortieServiceHelper.setd3SecureModal=function(modaleIntance3DSecure){FamilleAutorisationSortieServiceHelper.d3SecureModal=modaleIntance3DSecure},FamilleAutorisationSortieServiceHelper.closeModalSignature=function(){FamilleAutorisationSortieServiceHelper.d3SecureModal.close()},FamilleAutorisationSortieServiceHelper.formateDateHeure=function(dateHeureDebut,dateHeureFin,isInline,isNoDateFin){var momentDateDeb=moment(dateHeureDebut),momentDateFin=moment(dateHeureFin),dateFormate="";return isInline|=!1,isNoDateFin|=!1,!momentDateFin.isValid()||isNoDateFin?dateFormate="A partir du "+moment(dateHeureDebut).format("Do MMMM YYYY")+" à "+moment(dateHeureDebut).format("H:mm"):!isNoDateFin&&momentDateFin.diff(momentDateDeb,"days")>=1?(dateFormate="Du ",dateFormate+=moment(dateHeureDebut).format("Do MMMM YYYY"),dateFormate+=" à "+moment(dateHeureDebut).format("H:mm"),dateFormate+=(isInline?" ":"<br>")+"au ",dateFormate+=moment(dateHeureFin).format("Do MMMM YYYY"),dateFormate+=" à "+moment(dateHeureFin).format("H:mm")):"00:00"===moment(dateHeureDebut).format("HH:mm")&&"23:59"===moment(dateHeureFin).format("HH:mm")?dateFormate="Le "+moment(dateHeureDebut).format("Do MMMM YYYY"):(dateFormate="Le "+moment(dateHeureDebut).format("Do MMMM YYYY")+(isInline?" ":"<br>"),dateFormate+="de "+moment(dateHeureDebut).format("H:mm"),dateFormate+=" à "+moment(dateHeureFin).format("H:mm")),dateFormate},FamilleAutorisationSortieServiceHelper.listeAutorisationsSortie=function(idEleve){var idNiveau=0,defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/autorisationsSortie";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper.save=function(idEleve,autorisationSortie,idNiveau,signature){var defer=$q.defer(),data={autorisationSortie:autorisationSortie,codeSecure:signature.codeSecure},baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/autorisationsSortie";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper.updateDemandeExceptionnelle=function(idEleve,demandeExcep,idNiveau,signature){var defer=$q.defer(),data={demandeExceptionnelle:demandeExcep,codeSecure:signature.codeSecure},baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/demandesAutorisationSortie/"+demandeExcep.idDemande;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper.clearCache=function(){CacheService.removeMatch(/.*\/autorisationsSortie/)},FamilleAutorisationSortieServiceHelper.saveDemandeFamille=function(idEleve,demandeExcep,idNiveau,signature){var defer=$q.defer(),data={demandeExceptionnelle:demandeExcep,codeSecure:signature.codeSecure},baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/demandesAutorisationSortie";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper.updateDemandeFamille=function(idEleve,demandeExcep,idNiveau){var defer=$q.defer(),data={demandeExceptionnelle:demandeExcep},baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/famille/demandesAutorisationSortie/"+demandeExcep.idDemande;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper.deleteDemandeFamille=function(idEleve,demandeExcep,idNiveau){var defer=$q.defer(),baseUrl="eleves/"+idEleve+"/niveaux/"+idNiveau+"/famille/demandesAutorisationSortie/"+demandeExcep.idDemande;return $http({method:"DELETE",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},FamilleAutorisationSortieServiceHelper}]),angular.module("edsiteApp.vieScolaire").controller("SelectDateAutorSortieCtrl",["$uibModalInstance","EmploiDuTempsService","$scope","demandeAutorisationSortie","eleve","options","moment","Auth",function($uibModalInstance,EmploiDuTempsService,$scope,demandeAutorisationSortie,eleve,options,moment,Auth){function close(creneau){$uibModalInstance.close(creneau)}function selectDate(schedulerEvent){vm.close({dateDebut:schedulerEvent.evenement.start_date,dateFin:schedulerEvent.evenement.end_date})}var vm=this;vm.close=close,vm.selectDate=selectDate,vm.demandeAutorisationSortie=demandeAutorisationSortie,vm.eleve=eleve,vm.Auth=Auth,vm.scheduler=EmploiDuTempsService.scheduler,vm.title="Cliquez pour sélectionner "+("dateDebut"===options.typeDate?"le début":"la fin"),vm.events=[]}]),angular.module("edsiteApp.vieScolaire").directive("autorisationsSortie",function(){return{restrict:"E",scope:{eleve:"=",moduleInterne:"="},controller:"AutorisationsSortieDirectiveCtrl",controllerAs:"autorSortieDirectiveCtrl",templateUrl:"modules/vieScolaire/autorisations/autorisations-sortie-template.html",link:function(scope,element,attrs){}}}).controller("AutorisationsSortieDirectiveCtrl",["$scope","$rootScope","$uibModal","$filter","$q","$sessionStorage","Auth","moment","lodash","UserService","EleveCarnetCorrespondanceService","FamilleAutorisationSortieService","Notification","ModuleService","Utils","EmploiDuTempsService",function($scope,$rootScope,$uibModal,$filter,$q,$sessionStorage,Auth,moment,lodash,UserService,EleveCarnetCorrespondanceService,FamilleAutorisationSortieService,Notification,ModuleService,Utils,EmploiDuTempsService){function changeView(){vm.affinageParJour=!vm.affinageParJour}function changeEtatAutorisation(periode,numeroJour,codeTypeAutorisation){var typeSortieFound=lodash.find(vm.tabJoursAutorisationsSortieEleve,{jour:parseInt(numeroJour)});if(typeSortieFound["autorisations"+periode][codeTypeAutorisation].disponibleFamille!==!0)return!1;var etatAutorisationSortie=typeSortieFound["autorisations"+periode][codeTypeAutorisation].etat;return typeSortieFound["autorisations"+periode][codeTypeAutorisation].etat=0===etatAutorisationSortie||-1===etatAutorisationSortie?1:0,vm.isDataToSaved=!0,$rootScope.navigationDisabled=!0,!0}function changeModuleInterne(itemMenu){if(vm.isDataToSaved){var okCallback=function(){vm.itemMenuInterneSelected=itemMenu,vm.tabJoursAutorisationsSortieEleve=angular.copy(vm.tabJoursAutorisationsSortieEleveCache),vm.isDataToSaved=!1,$scope.$digest()},cancelCallback=function(notice){notice.remove()};Utils.displayWarningEditRunning(okCallback,cancelCallback)}else vm.itemMenuInterneSelected=itemMenu}function ajouterDemandeAutorisation(){Auth.isFamille()&&(vm.isModeAjoutDemandeEx=!0)}function closeDemandeAutorisation(isUpdOK){vm.isModeAjoutDemandeEx=!1,isUpdOK===!0&&(FamilleAutorisationSortieService.clearCache(),vm.refresh())}function getStatut(periode,numeroJour,codeTypeAutorisation){var typeSortieFound=lodash.find(vm.tabJoursAutorisationsSortieEleve,{jour:parseInt(numeroJour)});return{autorise:angular.isDefined(typeSortieFound)&&typeSortieFound["autorisations"+periode]?typeSortieFound["autorisations"+periode][codeTypeAutorisation].etat:null,disponible:angular.isDefined(typeSortieFound)&&typeSortieFound["autorisations"+periode]&&typeSortieFound["autorisations"+periode][codeTypeAutorisation].disponibleFamille===!0}}function getClassSelonStatut(monStatutAutorise){return 1===monStatutAutorise?"fa fa-check text-success":0===monStatutAutorise?"fa fa-ban text-danger":2===monStatutAutorise?"fa fa-question-circle":void 0}function isTypeAutorSortieOpen(periode,codeTypeAutorisation){var tabAutorDispoPeriodeTypeAutor={};return angular.forEach(vm.tabJoursAutorisationsSortieEleve,function(autorJour){var autorisationJourPeriode=autorJour["autorisations"+periode],typeAutorisationFound=lodash.find(autorisationJourPeriode,function(value,key){return key===codeTypeAutorisation});angular.isUndefined(tabAutorDispoPeriodeTypeAutor[periode+"_"+codeTypeAutorisation])&&(tabAutorDispoPeriodeTypeAutor[periode+"_"+codeTypeAutorisation]={nbAutorisationDispo:0});var elemTypeAutorByPeriode=tabAutorDispoPeriodeTypeAutor[periode+"_"+codeTypeAutorisation];angular.isDefined(typeAutorisationFound)&&typeAutorisationFound.disponibleFamille&&(elemTypeAutorByPeriode.nbAutorisationDispo+=1)}),tabAutorDispoPeriodeTypeAutor[periode+"_"+codeTypeAutorisation].nbAutorisationDispo>0}function openModalSignatureAutorisationsSortie(tabAutorisationsSortie){if(vm.autorisationsSortieASigner=tabAutorisationsSortie,vm.parametragesAutorisationsSortie.authentificationSMSActive){FamilleAutorisationSortieService.setTexteDescriptifModale3DSecure("valider vos modifications"),$scope.serviceFamAutorSortie=FamilleAutorisationSortieService,$scope.tabContacts=vm.tabContacts,$scope.signatureAutorisationsSortie=vm.signatureAutorisationsSortie,$scope.functionToRun=validerAutorSortie;var d3SecureModal=$uibModal.open({templateUrl:"modules/vieScolaire/autorisations/autorisations-sortie-signature.html",scope:$scope,backdrop:!1,keyboard:!1});FamilleAutorisationSortieService.setd3SecureModal(d3SecureModal)}else validerAutorSortie(!0)}function openModalSignatureDemandeExcepAutorSortie(demandeExcep,isDemandeAcceptee){if(vm.demandeExcepAutorSortie=demandeExcep,vm.demandeExcepAutorSortie.etatAcceptation=isDemandeAcceptee,demandeExcep.signatureSMSDemandee){var libelleValidation="";libelleValidation=isDemandeAcceptee?"accepter la demande":"décliner la demande",FamilleAutorisationSortieService.setTexteDescriptifModale3DSecure(libelleValidation),$scope.serviceFamAutorSortie=FamilleAutorisationSortieService,$scope.tabContacts=vm.tabContacts,$scope.signatureAutorisationsSortie=vm.signatureAutorisationsSortie,$scope.functionToRun=validerAutorSortie;var d3SecureModal=$uibModal.open({templateUrl:"modules/vieScolaire/autorisations/autorisations-sortie-signature.html",scope:$scope,backdrop:!1,keyboard:!1});FamilleAutorisationSortieService.setd3SecureModal(d3SecureModal)}else validerAutorSortie(!0)}function validerAutorSortie(withoutSignatureSMS){if(angular.isDefined(vm.autorisationsSortieASigner)){for(var tabAutorisationsSortieASigner=angular.copy(vm.autorisationsSortieASigner),indiceJour=0;indiceJour<tabAutorisationsSortieASigner.length;indiceJour++){var isTypeAutorisationSortieForSave=angular.isDefined(tabAutorisationsSortieASigner[indiceJour].autorisationsApresMidi)||angular.isDefined(tabAutorisationsSortieASigner[indiceJour].autorisationsMatin);isTypeAutorisationSortieForSave||(tabAutorisationsSortieASigner.splice(indiceJour,1),--indiceJour)}vm.promiseContents=FamilleAutorisationSortieService.save(vm.eleve.id,tabAutorisationsSortieASigner,vm.idNiveauEleve,vm.signatureAutorisationsSortie).then(function(){Notification.notify("Autorisations de sortie","Vos modifications ont bien été enregistrées !","success","icon-ed_carnetdecorrespondance"),withoutSignatureSMS||FamilleAutorisationSortieService.getd3SecureModal().close(),vm.isDataToSaved=!1,FamilleAutorisationSortieService.clearCache(),$rootScope.navigationDisabled=!1},function(){Notification.notify("Autorisations de sortie","L'enregistrement de vos modifications a échoué.","error","icon-ed_carnetdecorrespondance")})}else vm.promiseContents=FamilleAutorisationSortieService.updateDemandeExceptionnelle(vm.eleve.id,vm.demandeExcepAutorSortie,vm.idNiveauEleve,vm.signatureAutorisationsSortie).then(function(demandeUpdated){vm.demandeExcepAutorSortie.accepte=demandeUpdated.accepte,vm.demandeExcepAutorSortie.signature=demandeUpdated.signature,Notification.notify("Demande","Enregistrement de votre demande effectué !","success","icon-ed_carnetdecorrespondance"),withoutSignatureSMS||FamilleAutorisationSortieService.getd3SecureModal().close(),FamilleAutorisationSortieService.clearCache(),$rootScope.navigationDisabled=!1,vm.refresh()},function(){Notification.notify("Demande","L'enregistrement a échoué.","error","icon-ed_carnetdecorrespondance")})}function refresh(){Auth.isFamille()&&(vm.promiseContents=FamilleAutorisationSortieService.listeAutorisationsSortie(vm.idEleve).then(function(autorisationsSortie){angular.isDefined(autorisationsSortie.demandesEtab)&&(vm.tabDemandesAutoSortieEtab=autorisationsSortie.demandesEtab),angular.isDefined(autorisationsSortie.demandesFamille)&&(vm.tabDemandesAutoSortieFam=autorisationsSortie.demandesFamille),angular.forEach(vm.tabDemandesAutoSortieEtab,function(demandeEtab){demandeEtab.dateFormate=vm.formateDateHeure(demandeEtab.dateHeureDebut,demandeEtab.dateHeureFin)}),angular.forEach(vm.tabDemandesAutoSortieFam,function(demandesFam){demandesFam.dateFormate=vm.formateDateHeure(demandesFam.dateHeureDebut,demandesFam.dateHeureFin)}),vm.tabJoursAutorisationsSortieEleveCache=autorisationsSortie.autorisations,vm.tabJoursAutorisationsSortieEleve=angular.copy(vm.tabJoursAutorisationsSortieEleveCache),vm.tabLibellesAutorisation=autorisationsSortie.parametrage.libellesAutorisations,vm.parametragesAutorisationsSortie=autorisationsSortie.parametrage,vm.idNiveauEleve=vm.parametragesAutorisationsSortie.idNiveau,angular.forEach(vm.tabJoursAutorisationsSortieEleve,function(jourAutorSortie){jourAutorSortie.ouvertMatin&&!vm.isOpenAutorisationsSortieMatinInWeek&&(vm.isOpenAutorisationsSortieMatinInWeek=!0),jourAutorSortie.ouvertApresMidi&&!vm.isOpenAutorisationsSortieApresMidiInWeek&&(vm.isOpenAutorisationsSortieApresMidiInWeek=!0)}),vm.parametragesAutorisationsSortie.dureeRecreMatinFormate=formateDureeRecre(vm.parametragesAutorisationsSortie.dureeRecreMatin),vm.parametragesAutorisationsSortie.dureeRecreApresMidiFormate=formateDureeRecre(vm.parametragesAutorisationsSortie.dureeRecreApresMidi),vm.affinageParJour=vm.parametragesAutorisationsSortie.affinageParJour,vm.saisieDemandesFamilleActive=vm.parametragesAutorisationsSortie.saisieDemandesFamilleActive,vm.totalItemsDemandesAutorSortieFam=vm.tabDemandesAutoSortieFam.length,vm.totalItemsDemandesAutorSortieEtab=vm.tabDemandesAutoSortieEtab.length}))}function formateDateHeure(dateHeureDebut,dateHeureFin,isInline,isNoDateFin){return FamilleAutorisationSortieService.formateDateHeure(dateHeureDebut,dateHeureFin,isInline,isNoDateFin)}function formateDureeRecre(dureeRecre){var arrayDureeRecre=dureeRecre.split(":"),dureeRecreFormate=moment();return parseInt(arrayDureeRecre[0])>0&&dureeRecreFormate.hours(arrayDureeRecre[0]),parseInt(arrayDureeRecre[1])>0&&dureeRecreFormate.minutes(arrayDureeRecre[1]),dureeRecreFormate.seconds(arrayDureeRecre[2]),dureeRecreFormate=parseInt(arrayDureeRecre[0])>0?moment(dureeRecreFormate).format("H")+"h"+moment(dureeRecreFormate).format("mm"):0===parseInt(arrayDureeRecre[1])?"":moment(dureeRecreFormate).format("m")+" minutes"}function openDetailDemandeFamille(demandeFamille){var modalInstance=$uibModal.open({templateUrl:"modules/vieScolaire/autorisations/detail-demande-famille.modal.html",controller:"DetailDemandeFamilleCtrl as detailDemandeCtrl",backdrop:!0,size:"lg",resolve:{demandeFamille:function(){return demandeFamille},eleve:function(){return vm.eleve},idNiveauEleve:function(){return vm.idNiveauEleve},parametrage:function(){return vm.parametragesAutorisationsSortie}}});modalInstance.result.then(function(data){vm.closeDemandeAutorisation(data)})}var vm=this;vm.refresh=refresh,vm.changeView=changeView,vm.changeEtatAutorisation=changeEtatAutorisation,vm.changeModuleInterne=changeModuleInterne,vm.ajouterDemandeAutorisation=ajouterDemandeAutorisation,vm.closeDemandeAutorisation=closeDemandeAutorisation,vm.getStatut=getStatut,vm.isTypeAutorSortieOpen=isTypeAutorSortieOpen,vm.openModalSignatureAutorisationsSortie=openModalSignatureAutorisationsSortie,vm.openModalSignatureDemandeExcepAutorSortie=openModalSignatureDemandeExcepAutorSortie,vm.openDetailDemandeFamille=openDetailDemandeFamille,vm.validerAutorSortie=validerAutorSortie,vm.formateDateHeure=formateDateHeure,vm.getClassSelonStatut=getClassSelonStatut,vm.moduleInterne=angular.isDefined($scope.moduleInterne)?$scope.moduleInterne:"parametrage",vm.eleve=angular.isDefined($scope.eleve)?$scope.eleve:{},vm.idEleve=0|vm.eleve.id,vm.promiseContents=null,vm.itemMenuInterneSelected="parametrage",vm.affinageParJour=!1,vm.tabJours=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],vm.tabJoursAutorisationsSortieEleve=[],vm.tabLibellesAutorisation=[],vm.tabDemandesAutoSortieEtab=[],vm.tabDemandesAutoSortieFam=[],vm.parametragesAutorisationsSortie={},vm.isDataToSaved=!1,vm.signatureAutorisationsSortie={codeModule:"autorisationSortie",codeSecure:""},vm.tabContacts=[{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable},{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}],vm.currentPage=1,vm.itemParPage=7,vm.ConstantesAutorSortie=FamilleAutorisationSortieService.CONSTANTES,vm.idNiveauEleve=0,vm.isModeAjoutDemandeEx=!1,$scope.Auth=Auth,$scope.Utils=Utils,vm.refresh()}]),angular.module("edsiteApp.vieScolaire").directive("demandeAutorisationSortie",function(){return{restrict:"E",scope:{demande:"=?",parametrage:"=",eleve:"=",niveau:"=",inModal:"=?",onDemandeUpdated:"=",onCancel:"="},controller:"DemandeAutorisationSortieDirectiveCtrl",controllerAs:"demandeAutorSortieDirectiveCtrl",templateUrl:"modules/vieScolaire/autorisations/demande-autorisation-sortie-template.html",link:function(scope,element,attrs){}}}).controller("DemandeAutorisationSortieDirectiveCtrl",["$scope","$rootScope","$uibModal","$filter","$q","$sessionStorage","Auth","moment","lodash","UserService","FamilleAutorisationSortieService","Notification","ModuleService","Utils","EmploiDuTempsService",function($scope,$rootScope,$uibModal,$filter,$q,$sessionStorage,Auth,moment,lodash,UserService,FamilleAutorisationSortieService,Notification,ModuleService,Utils,EmploiDuTempsService){function isFormValid(){return vm.isEditable?vm.testDatesOK():!0}function testDatesOK(){if(!vm.isEditable)return!0;vm.isDatesInvalides="",vm.demandeAutorisationForm.$invalid=!1;try{if(angular.isUndefined(vm.demandeAutorisationSortie.dateDebut))throw new Error("Vous devez choisir une date de début valide");if(angular.isUndefined(vm.demandeAutorisationSortie.dateFin)&&!vm.demandeAutorisationSortie.isNoDateFin)throw new Error("Vous devez choisir une date de fin valide");if(vm.demandeAutorisationSortie.dateDebut<new Date)throw new Error("La date de début doit être dans le futur");if(vm.demandeAutorisationSortie.dateDebut>vm.demandeAutorisationSortie.dateFin&&!vm.demandeAutorisationSortie.isNoDateFin)throw new Error("La date de fin doit être supérieure ou égale à la date de début")}catch(error){return vm.isDatesInvalides=error.message,vm.demandeAutorisationForm.$invalid=!0,!1}return!0}function resetForm(){vm.isDatesInvalides="",vm.demandeAutorisationSortie={dateDebut:moment().add(1,"hours").minute(0).toDate(),dateFin:moment().add(2,"hours").minute(0).toDate(),isNoDateFin:!1}}function openModalSignatureDemandeExcepAutorSortieFamille(){if(vm.demandeAutorisationForm.$invalid&&(vm.demandeAutorisationForm.dateDebut.$pristine&&vm.demandeAutorisationForm.dateDebut.$viewValue||vm.demandeAutorisationForm.dateFin.$pristine&&vm.demandeAutorisationForm.dateFin.$viewValue)&&!vm.demandeAutorisationForm.motifDemandeAutorSortie.$invalid||!vm.isFormValid())return void(vm.demandeAutorisationForm.$invalid=!1);if(vm.parametragesAutorisationsSortie.authentificationSMSActive){$scope.functionToRun=saveAutorisationSortie,FamilleAutorisationSortieService.setTexteDescriptifModale3DSecure("enregistrer votre demande"),$scope.serviceFamAutorSortie=FamilleAutorisationSortieService,$scope.tabContacts=vm.tabContacts,$scope.signatureAutorisationsSortie=vm.signatureAutorisationsSortie;var d3SecureModal=$uibModal.open({templateUrl:"modules/vieScolaire/autorisations/autorisations-sortie-signature.html",
scope:$scope,backdrop:!1,keyboard:!1});FamilleAutorisationSortieService.setd3SecureModal(d3SecureModal)}else saveAutorisationSortie(!0)}function openModalSelectDateAutorSortie(typeDate){var modalInstance=$uibModal.open({templateUrl:"modules/vieScolaire/autorisations/select-date-autorisation-sortie.modal.html",controller:"SelectDateAutorSortieCtrl as selectAutorSortieDateCtrl",backdrop:!0,size:"lg",resolve:{demandeAutorisationSortie:function(){return vm.demandeAutorisationSortie},eleve:function(){return vm.eleve},options:function(){return{typeDate:typeDate}}}});modalInstance.result.then(function(creneau){angular.isUndefined(creneau)||("dateDebut"===typeDate&&(vm.demandeAutorisationSortie.dateDebut=creneau.dateDebut),vm.demandeAutorisationSortie.dateFin=creneau.dateFin,vm.testDatesOK())})}function saveAutorisationSortie(withoutSignatureSMS){var demandeAutorSortie={};demandeAutorSortie.dateDebut=moment(vm.demandeAutorisationSortie.dateDebut).second(0),demandeAutorSortie.dateFin=moment(vm.demandeAutorisationSortie.dateFin).second(0),demandeAutorSortie.dateHeureDebut=moment(demandeAutorSortie.dateDebut).format("YYYY-MM-DD")+" "+moment(demandeAutorSortie.dateDebut).format("HH:mm:ss"),vm.demandeAutorisationSortie.isNoDateFin?demandeAutorSortie.dateHeureFin="0000-00-00 00:00:00":demandeAutorSortie.dateHeureFin=moment(demandeAutorSortie.dateFin).format("YYYY-MM-DD")+" "+moment(demandeAutorSortie.dateFin).format("HH:mm:ss"),demandeAutorSortie.motif=vm.demandeAutorisationSortie.motif,vm.isModeAjout?vm.promiseContents=FamilleAutorisationSortieService.saveDemandeFamille(vm.eleve.id,demandeAutorSortie,vm.parametragesAutorisationsSortie.idNiveau,vm.signatureAutorisationsSortie).then(function(){Notification.notify("Autorisations de sortie","Votre demande a bien été enregistrée !","success","icon-ed_carnetdecorrespondance"),withoutSignatureSMS||FamilleAutorisationSortieService.getd3SecureModal().close(),vm.onDemandeUpdated(!0)},function(){Notification.notify("Demande","L'enregistrement de votre demande a échoué.","error","icon-ed_carnetdecorrespondance")}):(demandeAutorSortie.idDemande=vm.demandeAutorisationSortie.idDemande,vm.promiseContents=FamilleAutorisationSortieService.updateDemandeFamille(vm.idEleve,demandeAutorSortie,vm.idNiveauEleve).then(function(_data){Notification.notify("Autorisations de sortie","Votre demande a bien été mise à jour !","success",!0),vm.onDemandeUpdated(!0)},function(_data){Notification.notify("Autorisations de sortie","Une erreur est survenue","error",!0)}))}function confirmDemandeAutorisation(){var listCoursAbsent=[];angular.isDefined(EmploiDuTempsService.events)&&!vm.demandeAutorisationSortie.isNoDateFin&&(listCoursAbsent=EmploiDuTempsService.events.filter(function(edtEvent){return edtEvent.start_date<vm.demandeAutorisationSortie.dateFin&&edtEvent.end_date>vm.demandeAutorisationSortie.dateDebut&&""!==edtEvent.codeMatiere}));var config={confirm:"Valider",cancel:"Non",title:"Nouvelle demande d'absence / sortie exceptionnelle"};config.message="<p>Confirmez-vous cette demande d'absence / sortie exceptionnelle ",config.message+="<strong>"+FamilleAutorisationSortieService.formateDateHeure(vm.demandeAutorisationSortie.dateDebut,vm.demandeAutorisationSortie.dateFin,!0,vm.demandeAutorisationSortie.isNoDateFin)+"</strong> ?</p>",listCoursAbsent.length>0&&(config.message+="<br><h4>Liste des cours impactés : </h4><ul>",listCoursAbsent.forEach(function(cours){config.message+="<li><strong>"+cours.text+"</strong> "+FamilleAutorisationSortieService.formateDateHeure(cours.start_date,cours.end_date,!0)+"</li>"}),config.message+="</ul>");var modalConfirm=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"lg",resolve:{config:function(){return config}}});modalConfirm.result.then(function(){vm.openModalSignatureDemandeExcepAutorSortieFamille(),modalConfirm.close()})}function submitForm(){vm.demandeAutorisationForm.$invalid||(vm.isModeAjout?vm.confirmDemandeAutorisation():vm.saveAutorisationSortie(!0))}function deleteDemande(){var callbackFn=function(){vm.promiseContents=FamilleAutorisationSortieService.deleteDemandeFamille(vm.idEleve,vm.demandeAutorisationSortie,vm.idNiveauEleve).then(function(data){Notification.notify("Autorisations de sortie","Votre demande a bien été supprimée !","success",!0),vm.onDemandeUpdated(!0)},function(error){Notification.notify("Autorisations de sortie",error.data.message||"La suppression votre demande a échoué.","error",!0)})},modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'une demande d'absence / sortie exceptionnelle",config.message="Vous êtes sur le point de supprimer la demande. Continuer ?",config.confirm="Supprimer",config.cancel="Non",config}}});modalInstance.result.then(callbackFn)}var vm=this;vm.openModalSignatureDemandeExcepAutorSortieFamille=openModalSignatureDemandeExcepAutorSortieFamille,vm.openModalSelectDateAutorSortie=openModalSelectDateAutorSortie,vm.saveAutorisationSortie=saveAutorisationSortie,vm.confirmDemandeAutorisation=confirmDemandeAutorisation,vm.deleteDemande=deleteDemande,vm.isFormValid=isFormValid,vm.testDatesOK=testDatesOK,vm.resetForm=resetForm,vm.submitForm=submitForm,vm.onDemandeUpdated=$scope.onDemandeUpdated,vm.onCancel=$scope.onCancel,vm.eleve=$scope.eleve,vm.idEleve=vm.eleve.id,vm.idNiveauEleve=$scope.niveau,vm.isModeAjout=angular.isUndefined($scope.demande),vm.demandeAutorisationSortie=angular.isDefined($scope.demande)?angular.copy($scope.demande):{},vm.isEditable=vm.isModeAjout||""===vm.demandeAutorisationSortie.dateHeureTraitement,vm.isModeAjout||(vm.demandeAutorisationSortie.dateDebut=moment(vm.demandeAutorisationSortie.dateHeureDebut).toDate(),vm.demandeAutorisationSortie.isNoDateFin=""===vm.demandeAutorisationSortie.dateHeureFin,vm.demandeAutorisationSortie.isNoDateFin||(vm.demandeAutorisationSortie.dateFin=moment(vm.demandeAutorisationSortie.dateHeureFin).toDate())),vm.parametragesAutorisationsSortie=$scope.parametrage,vm.promiseContents=null,vm.signatureAutorisationsSortie={codeModule:"autorisationSortie",codeSecure:""},vm.tabContacts=[{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable},{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}],vm.isDatesInvalides="",vm.maxlengthMotifDemande=250}]),angular.module("edsiteApp.vieScolaire").controller("DetailDemandeFamilleCtrl",["$uibModalInstance","Notification","Auth","$uibModal","FamilleAutorisationSortieService","parametrage","demandeFamille","eleve","idNiveauEleve",function($uibModalInstance,Notification,Auth,$uibModal,FamilleAutorisationSortieService,parametrage,demandeFamille,eleve,idNiveauEleve){function close(demande){$uibModalInstance.close(demande)}var vm=this;vm.close=close,vm.demande=angular.copy(demandeFamille),vm.idNiveau=idNiveauEleve,vm.eleve=eleve,vm.parametrage=parametrage}]),angular.module("edsiteApp.Activites",["edsiteApp.Commun","ui.bootstrap","edsiteApp.vieScolaire","edsiteApp.3DSecure"]).controller("ActivitesCtrl",["$scope","$location","$routeParams","$q","$document","$uibModal","ActivitesService","VieScolaireService","UserService","lodash","ModuleService","Notification","Auth","D3Secure",function($scope,$location,$routeParams,$q,$document,$uibModal,ActivitesService,VieScolaireService,UserService,lodash,ModuleService,Notification,Auth,D3Secure){function isNow(laDate){return moment(laDate).isSame(moment(),"day")}function isSameWeek(laDate,dateRef){return moment(laDate).isSame(dateRef,"week")}function getDayActuel(numeroJour,semaineCourante){var firstDayWeek=angular.copy(semaineCourante);return formateDate(firstDayWeek.add(numeroJour,"days"))}function changeWeek(etat){var parametreDebutAnneeScolaire=$scope.parametrage.debutAnneeScolaire,parametreFinAnneeScolaire=$scope.parametrage.finAnneeScolaire,firstDaySchoolYear=moment(parametreDebutAnneeScolaire),lastDaySchoolYear=moment(parametreFinAnneeScolaire),firstDaysemaineSuivante=firstDayOfWeek.add(1,"week"),firstDaysemainePrecedente=firstDayOfWeek.subtract(1,"week");if("+"===etat){if(lastDaySchoolYear.isBefore(firstDaysemaineSuivante)||isSameWeek(parametreFinAnneeScolaire,$scope.semaineCourante))return!1;$scope.semaineCourante=firstDayOfWeek.add(1,"week")}if("-"===etat){if(firstDaySchoolYear.isAfter(firstDaysemainePrecedente)||isSameWeek(parametreDebutAnneeScolaire,$scope.semaineCourante))return!1;$scope.semaineCourante=firstDayOfWeek.subtract(1,"week")}}function changeView(periode){$scope.viewAnnee="semaine"!==periode}function isPast(leJour){return moment().isAfter(leJour)}function isUndefined(maVariable){return"undefined"==typeof maVariable}function refresh(){var lesPromises=[ActivitesService.infosActivitesEleve($scope.idEleve,typeUserConcerne).then(function(activitesEleve){$scope.activites=activitesEleve.activites}),ActivitesService.infosActivitesEtablissement($scope.idEleve,typeUserConcerne).then(function(activitesEtab){$scope.activitesEtablissement=activitesEtab.activites,$scope.parametrage=activitesEtab.parametrage,$scope.joursFeries=activitesEtab.joursFeries})];ModuleService.isModuleEnabled(ModuleService.CODES.VIE_SCOLAIRE,$scope.idEleve)&&lesPromises.push(VieScolaireService.get($scope.idEleve).then(function(absences){angular.isDefined(absences)&&($scope.listeAbsences=absences.absencesRetards)})),$scope.promiseContents=$q.all(lesPromises).then(function(){$scope.parametrage.historiquePassage||$scope.parametrage.statistiques?$scope.promiseContents=ActivitesService.activitePassages($scope.idEleve,typeUserConcerne).then(function(passage){$scope.listePassages=passage,$scope.stats=getStats(),$scope.anneeGlobale=genereAnnee()}):$scope.anneeGlobale=genereAnnee()})}function isActiviteOuverteEtab(idActivite){var activiteDispo=lodash.find($scope.activitesEtablissement,{id:idActivite});return angular.isDefined(activiteDispo)?activiteDispo.semaineType.length>0:!1}function getStats(){var lesPassagesStats={};return lodash.forIn($scope.listePassages,function(value,key){var month=key.split("-")[1];angular.forEach(value,function(passa){angular.forEach(passa.articles,function(art){var statArticle={};angular.isDefined(lesPassagesStats[art.libelle])&&(statArticle=lesPassagesStats[art.libelle]);var statMoisArticle=0;angular.isDefined(statArticle[month])&&(statMoisArticle=statArticle[month]),statMoisArticle+=1*art.quantite,statArticle[month]=statMoisArticle,lesPassagesStats[art.libelle]=statArticle})})}),lesPassagesStats}function formateDate(laDate){return moment(laDate).format("YYYY-MM-DD")}function setPanierActif(etatActif){if($scope.panierActif=etatActif,etatActif){var encartSemType=angular.element(document.getElementsByClassName("nav-tabs"));$document.scrollToElement(encartSemType,90,500)}}function compteMoisPlus(mois){for(var nbModifAjoutees=0,previousDay=moment(mois).date(0),firstDayOfMonth=moment(mois).date(1),lastDayOfMonth=moment(firstDayOfMonth).endOf("month"),maxDays=lastDayOfMonth.date(),sizeActivite=$scope.activites.length,j=0;maxDays>j;j++)for(var dateJourCourant=moment(previousDay.add(1,"days")),numbActivite=0;sizeActivite>numbActivite;numbActivite++){var dateFormate=formateDate(dateJourCourant),infosActivite=$scope.anneeGlobale[dateFormate][$scope.activites[numbActivite].id];(1===infosActivite.etatExceptionEleve&&"undefined"==typeof infosActivite.etatPanier||1===infosActivite.etatPanier&&infosActivite.etatPanier!==infosActivite.etatSemTypeEleve)&&nbModifAjoutees++}return nbModifAjoutees}function compteMoisMoins(mois){for(var nbModifSupprimees=0,previousDay=moment(mois).date(0),firstDayOfMonth=moment(mois).date(1),lastDayOfMonth=moment(firstDayOfMonth).endOf("month"),maxDays=lastDayOfMonth.date(),sizeActivite=$scope.activites.length,j=0;maxDays>j;j++)for(var dateJourCourant=moment(previousDay.add(1,"days")),numbActivite=0;sizeActivite>numbActivite;numbActivite++){var dateFormate=formateDate(dateJourCourant),infosActivite=$scope.anneeGlobale[dateFormate][$scope.activites[numbActivite].id];(0===infosActivite.etatExceptionEleve&&"undefined"==typeof infosActivite.etatPanier||0===infosActivite.etatPanier&&infosActivite.etatPanier!==infosActivite.etatSemTypeEleve)&&nbModifSupprimees++}return nbModifSupprimees}function menuVisible(numeroPeriode,typePeriode,moisEnCours){var numPeriode,moisActu;return"mois"===typePeriode?(numPeriode=parseInt(moment(numeroPeriode).format("M")),-1!==lodash.indexOf($scope.menusDisponibles.moisDisponibles,numPeriode)):(moisActu=moment(moisEnCours).format("YYYY-MM-DD"),numPeriode=parseInt(numeroSemaine(moisActu,numeroPeriode)),-1!==lodash.indexOf($scope.menusDisponibles.semainesDisponibles,numPeriode))}function numeroSemaine(mois,indiceSemaine){var numPeriode;return numPeriode=parseInt(moment(mois).format("w")),numPeriode+=indiceSemaine}function setModifInPanier(laDate,etat,activite){$scope.anneeGlobale[laDate][activite].etatPanier=etat;for(var boolInPanier=!0,activiteInPanier=0,numbActivite=0;numbActivite<$scope.activites.length;numbActivite++)boolInPanier="undefined"!=typeof $scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatPanier&&$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatPanier!==$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatEleve&&$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatPanier!==$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatEleve,boolInPanier&&activiteInPanier++;$scope.anneeGlobale[laDate].modifInPanier=activiteInPanier>0}function getActiviteJournee(laDate){for(var boolJourneeSansActivite=!1,activiteInJourneeActu=0,numbActivite=0;numbActivite<$scope.activites.length;numbActivite++)boolJourneeSansActivite=0===$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatSemTypeEleve||"undefined"!=typeof $scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatPanier&&0===$scope.anneeGlobale[laDate][$scope.activites[numbActivite].id].etatPanier,boolJourneeSansActivite&&activiteInJourneeActu++;$scope.anneeGlobale[laDate].activiteJournee=activiteInJourneeActu!==$scope.activites.length}function getDayAbsence(date){var absenceSoir=lodash.where($scope.listeAbsences,{typeElement:$scope.constantes.ID_ABSENCE_SOIR,date:date}),absenceMidi=lodash.where($scope.listeAbsences,{typeElement:$scope.constantes.ID_ABSENCE_MIDI,date:date}),absenceActivite=[];return absenceMidi.length>0&&absenceActivite.push({activite:$scope.constantes.ID_ACTIVITE_MIDI}),absenceSoir.length>0&&absenceActivite.push({activite:$scope.constantes.ID_ACTIVITE_SOIR}),absenceActivite}function isDayPassage(date){var passage="";return lodash.has($scope.listePassages,date)&&(passage=$scope.listePassages[date]),""!==passage}function getDayPassage(date){var passage="";return lodash.has($scope.listePassages,date)&&(passage=$scope.listePassages[date],angular.forEach($scope.listePassages[date],function(passage){var total=lodash.sum(passage.articles,function(article){return article.quantite*article.prix});passage.total=total})),passage}function isOpenReservation(date,idActivite,jour){var semaineActivite=lodash.find($scope.activitesEtablissement,{id:idActivite});if(angular.isUndefined(semaineActivite))return!1;var delai,indexJour=lodash.findIndex(semaineActivite.semaineType,jour),isOpen=!1;if(moment().isAfter(moment(date,"YYYY-MM-DD"))&&!moment().isSame(moment(date,"YYYY-MM-DD"),"day"))return!1;if(indexJour>=0){var jourActivite=semaineActivite.semaineType[indexJour];lodash.findKey(jourActivite,function(chr){var delaiEnSeconde,delaiEnMinutes,tempsRestant,delaiFormate=chr.delaiReservation.split(":");delaiEnSeconde=angular.isUndefined(delaiFormate[2])===!0?"00":delaiFormate[2],delaiEnMinutes=delaiFormate[1],delai=60*delaiFormate[0]*60+60*delaiEnMinutes+1*delaiEnSeconde,tempsRestant=moment(date,"YYYY-MM-DD").add(moment(chr.heureDebut,"HH:mm:ss")).diff(moment(),"seconds"),isOpen=tempsRestant>delai})}return isOpen}function inSemaineTypeEtab(date,idActivite){var semaineActivite=lodash.find($scope.activitesEtablissement,{id:idActivite});return"undefined"!=typeof semaineActivite?lodash.findIndex(semaineActivite.semaineType,date)>=0:void 0}function inSemaineTypeEleve(date,idActivite){var semaineActivite=lodash.find($scope.activites,{id:idActivite});return"undefined"!=typeof semaineActivite?lodash.include(semaineActivite.semaineType,date):void 0}function getEtatException(listExceptions,date){if(lodash.has(listExceptions,date)){if("-"===listExceptions[date])return 0;if("+"===listExceptions[date])return 1}}function getExceptionEleve(date,activite){var activiteException=lodash.find($scope.activites,{id:activite});return getEtatException(activiteException.exceptions,date)}function getExceptionEtab(date,activite){var activiteExceptionEtab=lodash.find($scope.activitesEtablissement,{id:activite});return lodash.has(activiteExceptionEtab,"exceptions")?getEtatException(activiteExceptionEtab.exceptions,date):void 0}function getEtatPanier(date,activite){var panier=lodash.where($scope.listeModifications,{date:moment(date).format("DD MMMM"),activite:activite});return 0!==panier.length?panier[0].etat:void 0}function getEtatEleve(etatSemType,exception,panier,etatSemTypeEtab,absence){var etatEleve=etatSemType;return"undefined"!=typeof exception&&(etatEleve=exception),1===absence&&(etatEleve=0),"undefined"!=typeof panier&&(etatEleve=panier),etatEleve!==etatSemTypeEtab&&(etatEleve=0),etatEleve}function getEtatEtablissement(etatSemType,exception){var etatEtab=etatSemType;return"undefined"!=typeof exception&&(etatEtab=exception),etatEtab}function infosActivite(jourActu){if(!angular.isUndefined($scope.anneeGlobale)){for(var activites=$scope.activites,texte="",anneeGlobale=$scope.anneeGlobale[formateDate(jourActu)],activitesEtab=$scope.activitesEtablissement,i=0;i<activites.length;i++){var activiteDispo=lodash.find(activitesEtab,{id:activites[i].id});activiteDispo=activiteDispo.semaineType.length>0,activiteDispo&&(texte+=activites[i].id+" ",texte+=1===anneeGlobale[activites[i].id].etatEleve?'<i class="glyphicon glyphicon-ok green"></i><br>':'<i class="glyphicon glyphicon-remove red"></i><br>')}return texte}}function getEtatJour(dateFormatee,activite){var jourFr=moment(dateFormatee).format("dddd"),objDate={};return objDate.absent=getDayAbsence(dateFormatee).length>0?1:0,objDate.etatPassage=isDayPassage(dateFormatee)?1:0,objDate.etatSemTypeEtab=inSemaineTypeEtab(jourFr,activite)?1:0,objDate.etatSemTypeEleve=$scope.inSemaineTypeEleve(jourFr,activite)?1:0,objDate.etatExceptionEtab=getExceptionEtab(dateFormatee,activite),objDate.etatExceptionEleve=getExceptionEleve(dateFormatee,activite),objDate.etatPanier=getEtatPanier(dateFormatee,activite),objDate.etatEleve=getEtatEleve(objDate.etatSemTypeEleve,objDate.etatExceptionEleve,objDate.etatPanier,objDate.etatSemTypeEtab,objDate.absent),objDate.etatEtablissement=getEtatEtablissement(objDate.etatSemTypeEtab,objDate.etatExceptionEtab),objDate.reservationPossible=isOpenReservation(dateFormatee,activite,jourFr),objDate.idActivite=activite,objDate}function genereAnnee(){var annee={},ladate=new Date,anneeEnCours=ladate.getFullYear();(ladate.getMonth()<6||6===ladate.getMonth()&&ladate.getDate()<14)&&(anneeEnCours-=1);for(var firstDayYear=new Date(anneeEnCours,7,1,12),lastDayYear=new Date(anneeEnCours+1,7,1,12),jourCourant=firstDayYear;lastDayYear>jourCourant;){for(var jourEtat={},jourCourantFormate=formateDate(jourCourant),indiceActivite=0;indiceActivite<$scope.activites.length;indiceActivite++){var idActivite=$scope.activites[indiceActivite].id;jourEtat[idActivite]=getEtatJour(jourCourantFormate,idActivite);var jourEtatActivite=jourEtat[idActivite];jourEtat=processJourEtatActivite(jourEtat,jourEtatActivite)}annee[jourCourantFormate]=jourEtat,jourCourant.setTime(jourCourant.getTime()+864e5)}return annee}function processJourEtatActivite(jourEtat,jourEtatActivite){return jourEtat.exceptionJour||(jourEtat.exceptionJour=angular.isDefined(jourEtatActivite.etatExceptionEleve)),jourEtat.absenceJour||(jourEtat.absenceJour=1===jourEtatActivite.absent),jourEtat.activiteJournee||(jourEtat.activiteJournee=angular.isDefined(jourEtatActivite.etatExceptionEleve)&&1===jourEtatActivite.etatExceptionEleve||1===jourEtatActivite.etatSemTypeEleve&&angular.isUndefined(jourEtatActivite.etatExceptionEleve)||1===jourEtatActivite.etatPanier),(jourEtat.jourFerme||angular.isUndefined(jourEtat.jourFerme))&&(jourEtat.jourFerme=0===jourEtatActivite.etatSemTypeEtab),jourEtat.modifInPanier||(jourEtat.modifInPanier=angular.isDefined(jourEtatActivite.etatPanier)),jourEtat.reservationPossible||(jourEtat.reservationPossible=jourEtatActivite.reservationPossible),jourEtat.etatPassage||(jourEtat.etatPassage=1===jourEtatActivite.etatPassage),jourEtat}function getWeeks(nbWeek){for(var weeks=[],semaine=0;nbWeek>semaine;semaine++){var obj={};obj.indice=semaine,weeks.push(obj)}return weeks}function genereMois(mois){for(var lemois={},previousDay=moment(mois).date(0),firstDayOfMonth=moment(mois).date(1),days=[],now=moment(),lastDayOfMonth=moment(firstDayOfMonth).endOf("month"),maxDays=lastDayOfMonth.date(),emptyFirstDays=[],i=0===firstDayOfMonth.day()?6:firstDayOfMonth.day()-1;i>0;i--)emptyFirstDays.push({});lemois.emptyFirstDays=emptyFirstDays;for(var emptyLastDays=[],k=7-(0===lastDayOfMonth.day()?7:lastDayOfMonth.day());k>0;k--)emptyLastDays.push({});lemois.emptyLastDays=emptyLastDays;var nbWeek=(lemois.emptyFirstDays.length+lemois.emptyLastDays.length+maxDays)/7;lemois.weeks=getWeeks(nbWeek);for(var j=0;maxDays>j;j++){var dateJourCourant=moment(previousDay.add(1,"days")),jourCourant={};jourCourant.today=dateJourCourant.isSame(now,"day"),jourCourant.jourEnCours=dateJourCourant,jourCourant.jourFormatDate=formateDate(dateJourCourant),days.push(jourCourant)}lemois.days=days,$scope.annee[mois]=lemois}function activerModePanier(){!$scope.panierActif&&$scope.listeModifications.length>0&&setPanierActif(!0)}function ajouterModification(cleJourModifie,action,jourModifie,idActivite,libelleActivite,classe,eleve,ogec){var isCochee,etatModification;if(!$scope.anneeGlobale[formateDate(jourModifie)][idActivite].reservationPossible||isJourFerie(jourModifie))return!1;isCochee=0===action?"undefined"==typeof $scope.anneeGlobale[formateDate(jourModifie)][idActivite].etatPanier?1===$scope.anneeGlobale[formateDate(jourModifie)][idActivite].etatEleve:1===$scope.anneeGlobale[formateDate(jourModifie)][idActivite].etatPanier:!action.target.checked;var jourDejaModifie=lodash.where($scope.listeModifications,{id:cleJourModifie});etatModification=isCochee?0:1;var panier={id:cleJourModifie,idActivite:idActivite,activite:libelleActivite,date:jourModifie,etat:etatModification,codeClasse:classe,codeEleve:eleve,codeOGEC:ogec};$scope.anneeGlobale[jourModifie][idActivite].etatPanier=etatModification,setModifInPanier(jourModifie,etatModification,idActivite),0===jourDejaModifie.length?$scope.listeModifications.push(panier):$scope.listeModifications=lodash.reject($scope.listeModifications,function(num){return num.id===cleJourModifie}),getActiviteJournee(jourModifie),0===$scope.listeModifications.length&&setPanierActif(!1),$scope.compteMoisMoins(jourModifie),$scope.compteMoisPlus(jourModifie)}function validerPanier(){if($scope.parametrage.authentificationSms){var tabContacts=[];tabContacts.push({idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable}),tabContacts.push({idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}),$scope.contacts=tabContacts,$scope.goToEtape(2),self.d3SecureModal=$uibModal.open({templateUrl:"modules/activites/activitesreservation.html",scope:$scope,backdrop:!1})}else $scope.reservation.codeSecure="0",saveReservations()}function goToEtape(numetape){$scope.etape=numetape}function saveReservations(){$scope.reservation.reservations=$scope.listeModifications,$scope.promise3DSecure=ActivitesService.reservationActivites($scope.idEleve,typeUserConcerne,$scope.reservation).then(function(){Notification.notify("Réservation","Vos modifications ont bien été enregistrées !","success"),setPanierActif(!1),$scope.listeModifications=[],$scope.parametrage.authentificationSms&&self.d3SecureModal.close(),$scope.goToEtape(1),$scope.refresh()},function(){Notification.notify("Réservation","L'enregistrement de vos modifications a échoué.","error")})}function toogleDay(jourSelected,isFerme,reservationOk){return isFerme?!1:($scope.jourSelected=jourSelected,$scope.modeAffichage=$scope.isPast(jourSelected)&&!reservationOk?"detail":"reservation",$scope.passageDuJour=getDayPassage(jourSelected),$scope.panierActif&&$scope.goToEtape(1),void((!$scope.isPast(jourSelected)||$scope.isPast(jourSelected)&&$scope.parametrage.historiquePassage)&&$uibModal.open({templateUrl:"modules/activites/activitedetails.html",scope:$scope})))}function isEmpty(obj){for(var i in obj)if(obj.hasOwnProperty(i))return!1;return!0}function isAnnule(index,semaineCourante,idActivite,etat){if(angular.isDefined($scope.anneeGlobale)&&angular.isDefined($scope.anneeGlobale[getDayActuel(index,semaineCourante)])){var activite=$scope.anneeGlobale[getDayActuel(index,semaineCourante)][idActivite],isBad=!1,eleveHasException=!1,etatEleveHasChanged=!1;return activite.etatExceptionEleve!==etat||!isUndefined(activite.etatPanier)&&activite.etatPanier!==activite.etatExceptionEleve||(eleveHasException=!0),activite.etatPanier===etat&&activite.etatPanier!==activite.etatEleve&&isUndefined(activite.etatExceptionEleve)&&(etatEleveHasChanged=!0),(eleveHasException||etatEleveHasChanged)&&1===activite.etatSemTypeEtab&&(isBad=!0),isBad}}function reservationPossible(index,semaineCourante,idActivite){if(angular.isDefined($scope.anneeGlobale)){if(angular.isUndefined($scope.anneeGlobale[getDayActuel(index,semaineCourante)]))return!1;var activite=$scope.anneeGlobale[getDayActuel(index,semaineCourante)][idActivite];return 1===activite.etatSemTypeEtab&&activite.reservationPossible&&0!==activite.etatExceptionEtab&&!isJourFerie(getDayActuel(index,semaineCourante))}}function isJourFerie(jour){return angular.isDefined($scope.joursFeries)?lodash.indexOf($scope.joursFeries,jour)>=0:void 0}function absenceExiste(date,idActivite){var tabActivitesWithAbsence=getDayAbsence(date),absence=lodash.where(tabActivitesWithAbsence,{activite:idActivite});return absence.length>0}function detailPassage(index,semaineCourante){if(angular.isDefined($scope.anneeGlobale)){var activite=$scope.anneeGlobale[getDayActuel(index,semaineCourante)];if(activite.jourFerme||!activite.etatPassage)return!1;toogleDay(getDayActuel(index,semaineCourante),activite.jourFerme)}}function close(){self.d3SecureModal.close()}$scope.panierActif=!1,$scope.etape=1,$scope.viewAnnee=!1,$scope.ongletSelected="#planningActivite",$scope.menusDisponibles=[],$scope.listeAbsences=[],$scope.listePassages=[],$scope.listeModifications=[],$scope.activitesEtablissement=[],$scope.anneeN={},$scope.annee={},$scope.stats={},$scope.constantes=ActivitesService.CONSTANTES,$scope.reservation={codeModule:"reservation"},$scope.idEleve=$routeParams.ideleve,this.d3SecureModal={},this.isOpenReservation=isOpenReservation;var self=this;UserService.getEleve($scope.idEleve).then(function(eleve){$scope.eleve=eleve});var ladate=new Date,anneeActuelle=ladate.getFullYear();(ladate.getMonth()<6||6===ladate.getMonth()&&ladate.getDate()<14)&&(anneeActuelle-=1),$scope.moisCalendrier=[new Date(anneeActuelle,7,1),new Date(anneeActuelle,8,1),new Date(anneeActuelle,9,1),new Date(anneeActuelle,10,1),new Date(anneeActuelle,11,1),new Date(anneeActuelle+1,0,1),new Date(anneeActuelle+1,1,1),new Date(anneeActuelle+1,2,1),new Date(anneeActuelle+1,3,1),new Date(anneeActuelle+1,4,1),new Date(anneeActuelle+1,5,1),new Date(anneeActuelle+1,6,1)];var DaysOfWeek=moment().localeData()._weekdays;$scope.joursSemaine=[DaysOfWeek[1],DaysOfWeek[2],DaysOfWeek[3],DaysOfWeek[4],DaysOfWeek[5],DaysOfWeek[6],DaysOfWeek[0]];var ShortDaysOfWeek=moment().localeData()._weekdaysMin;$scope.daysOfWeek=[ShortDaysOfWeek[1],ShortDaysOfWeek[2],ShortDaysOfWeek[3],ShortDaysOfWeek[4],ShortDaysOfWeek[5],ShortDaysOfWeek[6],ShortDaysOfWeek[0]];var typeUserConcerne,firstDayOfWeek=moment().day(1);$scope.semaineCourante=moment().day(1),$scope.isNow=isNow,$scope.getDayActuel=getDayActuel,$scope.changeWeek=changeWeek,$scope.changeView=changeView,$scope.isPast=isPast,$scope.isUndefined=isUndefined,$scope.refresh=refresh,$scope.compteMoisPlus=compteMoisPlus,$scope.compteMoisMoins=compteMoisMoins,$scope.menuVisible=menuVisible,$scope.inSemaineTypeEleve=inSemaineTypeEleve,$scope.inSemaineTypeEtab=inSemaineTypeEtab,$scope.isActiviteOuverteEtab=isActiviteOuverteEtab,$scope.activerModePanier=activerModePanier,$scope.ajouterModification=ajouterModification,$scope.validerPanier=validerPanier,$scope.goToEtape=goToEtape,$scope.saveReservations=saveReservations,$scope.toogleDay=toogleDay,$scope.infosActivite=infosActivite,$scope.isEmpty=isEmpty,$scope.isAnnule=isAnnule,$scope.isJourFerie=isJourFerie,$scope.reservationPossible=reservationPossible,$scope.absenceExiste=absenceExiste,$scope.detailPassage=detailPassage,$scope.close=close,typeUserConcerne="1"===Auth.role()||"2"===Auth.role()?"eleve":Auth.role(),angular.forEach($scope.moisCalendrier,function(leMois){genereMois(leMois)}),$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.RESERVATIONS,$routeParams.ideleve)}]),angular.module("edsiteApp.Activites").service("ActivitesService",["$q","$http","EDHttp","CacheService",function($q,$http,EDHttp,CacheService){var mActivites={},Constantes={ID_ABSENCE_SOIR:"Internat",ID_ABSENCE_MIDI:"Repas",ID_ACTIVITE_MIDI:"MIDI",ID_ACTIVITE_SOIR:"SOIR"};return mActivites.CONSTANTES=Constantes,mActivites.infosActivitesEleve=function(idUser,typeUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/activites";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mActivites.infosActivitesEtablissement=function(idUser,typeUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/activitesetablissement";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mActivites.activitePassages=function(idUser,typeUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/activitespassages";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mActivites.reservationActivites=function(idUser,typeUser,activites){var defer=$q.defer(),data=activites,baseUrl=typeUser+"/"+idUser+"/activites",re=new RegExp(".*\\/"+idUser+"\\/activites.*");return CacheService.removeMatch(re),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mActivites.restaurationMenusDisponibles=function(){var defer=$q.defer(),data={},baseUrl="restaurationMenusDisponibles";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mActivites}]),angular.module("edsiteApp.Cloud").service("CloudService",["$http","$q","$timeout","lodash","$sessionStorage",function($http,$q,$timeout,lodash,$sessionStorage){function extendDeep(dst){return angular.forEach(arguments,function(obj){obj!==dst&&angular.forEach(obj,function(value,key){dst[key]&&dst[key].constructor&&dst[key].constructor===Object?extendDeep(dst[key],value):dst[key]&&dst[key].constructor&&dst[key].constructor===Array?(angular.forEach(obj[key],function(sousObj){var dstSousObj=lodash.find(dst[key],{
id:sousObj.id});angular.isUndefined(dstSousObj)?dst[key].push(sousObj):extendDeep(dstSousObj,sousObj)}),dst[key].concat(value)):"taille"===key&&dst.hasOwnProperty(key)?dst[key]+=value:dst[key]=value})}),dst}function findFolder(folders,idFolder){var foundFolder;return lodash.forEach(folders,function(folder){folder.type===cloud.TYPES.FOLDER&&folder.id===idFolder&&(foundFolder=folder),lodash.isUndefined(foundFolder)&&folder.children&&(foundFolder=findFolder(folder.children,idFolder))}),foundFolder}function findFileParentFolder(folders,idFile){var foundFolder;return lodash.forEach(folders,function(node){node.type===cloud.TYPES.FOLDER&&lodash.find(node.children,{type:cloud.TYPES.FILE,id:idFile})&&(foundFolder=node),lodash.isUndefined(foundFolder)&&node.children&&(foundFolder=findFileParentFolder(node.children,idFile))}),foundFolder}var availableIcones=["aac","dat","url","pad","rtc","gif","key","otp","py","tgz","aiff","dmg","h","less","ots","qt","tiff","ai","doc","hpp","mid","ott","rar","txt","avi","dotx","html","mp3","_page","rb","wav","_blank","dwg","ics","mp4","pdf","rtf","xls","bmp","dxf","iso","mpg","php","sass","xlsx","c","eps","java","odf","png","scss","xml","cpp","exe","jpg","jpeg","ods","ppt","sql","yml","css","flv","js","odt","psd","tga","zip"],cloud={};return cloud.TYPES={FOLDER:"folder",FILE:"file"},cloud.CONSTANTES={DROIT_LECTURE:1,DROIT_MODIFICATION:2,DROIT_SUPPRESSION:3,DROIT_ADMIN:4},cloud.contents={},cloud.getCloudContents=function(idUser,typeCloud){var defer=$q.defer(),data={},baseUrl="cloud/"+typeCloud+"/"+idUser;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){var contents={};angular.forEach(response.data.data,function(rootNode){extendDeep(contents,rootNode)}),cloud.contents=[contents],defer.resolve([contents])},function(error){defer.reject(error)}),defer.promise},cloud.getFolderContent=function(node,idUser,typeCloud,profondeur){var defer=$q.defer(),folder=findFolder(cloud.contents,node.id);if(node.isLoaded===!0&&!angular.isDefined(profondeur))return defer.resolve(folder),defer.promise;var data={};angular.isDefined(profondeur)&&(data.profondeur=profondeur);var lePath=node.id.replace(cloud.contents[0].id,""),baseUrl="cloud/"+typeCloud+"/"+idUser+"?idFolder="+encodeURIComponent(lePath);return $http({method:"GET",url:baseUrl,data:data}).then(function(response){var contents={};angular.forEach(response.data.data,function(rootNode){extendDeep(contents,rootNode)}),folder.isLoaded=!0,folder.children=contents.children,defer.resolve(contents)},function(error){defer.reject(error)}),defer.promise},cloud.getFolderContentById=function(nodeId){var defer=$q.defer(),folder=findFolder(cloud.contents,nodeId);return defer.resolve(folder),defer.promise},cloud.deleteNode=function(idUser,tabNode,typeCloud){var defer=$q.defer(),data={tabNodes:tabNode.map(function(node){return node.children=[],node})},baseUrl="cloud/"+typeCloud+"/"+idUser;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(){delete $sessionStorage.clipboardNodes,defer.resolve()},function(error){defer.reject(error)}),defer.promise},cloud.addFolder=function(idUser,typeCloud,nomDossier,inNode){var defer=$q.defer();if(inNode.type!==cloud.TYPES.FOLDER&&(inNode=findFileParentFolder(cloud.contents,inNode.id)),lodash.isUndefined(inNode))return defer.reject("Une erreur s'est produite"),defer.promise;var data={},parentNode=angular.copy(inNode);if(parentNode.children=[],data.parentNode=parentNode,data.libelle=nomDossier,lodash.findIndex(inNode.children,function(elem){return elem.libelle.toLowerCase()===nomDossier.toLowerCase()})>=0)defer.reject("Un dossier du même nom existe déjà !");else{var baseUrl="cloud/"+typeCloud+"/"+idUser;$http({method:"POST",url:baseUrl,data:data}).then(function(response){inNode.children=inNode.children?inNode.children:[],inNode.children.push(response.data.data),defer.resolve(inNode)},function(error){defer.reject(error)})}return defer.promise},cloud.renameNode=function(idUser,typeCloud,newName,node,parentNode,newUrl,newDescription){var defer=$q.defer();if(lodash.isUndefined(node))return defer.reject("Une erreur s'est produite"),defer.promise;var newNode=angular.copy(node);newNode.children=[];var data={};if(data.node=newNode,data.newLibelle=newName,angular.isDefined(newUrl)&&(data.newUrl=newUrl),angular.isDefined(newDescription)&&(data.newDescription=newDescription),lodash.findIndex(parentNode.children,function(elem){return elem.libelle.toLowerCase()===newName.toLowerCase()&&elem.id!==node.id})>=0)defer.reject("Un élément du même nom existe déjà !");else{var baseUrl="cloud/"+typeCloud+"/"+idUser;$http({method:"PUT",url:baseUrl,data:data}).then(function(response){node.id=response.data.data.newId,node.libelle=response.data.data.newLibelle,angular.isDefined(response.data.data.newUrl)&&(node.url=response.data.data.newUrl),node.description=angular.isDefined(response.data.data.newDescription)?response.data.data.newDescription:"",node.isLoaded=!1,defer.resolve(node)},function(error){defer.reject(error)})}return defer.promise},cloud.copyNodes=function(nodes){$sessionStorage.clipboardNodes=nodes},cloud.getClipboardContent=function(){return $sessionStorage.clipboardNodes},cloud.pasteNode=function(idUser,typeCloud,nodes,inNode){var defer=$q.defer();if(inNode.type===cloud.TYPES.FILE)return defer.reject("Vous pouvez seulement coller dans un dossier"),defer.promise;if(inNode.type!==cloud.TYPES.FOLDER&&(inNode=findFileParentFolder(cloud.contents,inNode.id)),lodash.isUndefined(inNode))return defer.reject("Une erreur s'est produite"),defer.promise;var data={},parentNode=angular.copy(inNode),clipboard=angular.copy(nodes);parentNode.children=[],data.parentNode=parentNode,data.clipboard=clipboard;var baseUrl="cloud/"+typeCloud+"/"+idUser;return $http({method:"COPY",url:baseUrl,data:data}).then(function(response){angular.extend(inNode,response.data.data),inNode.isLoaded=!1,defer.resolve(inNode)},function(error){defer.reject(error)}),defer.promise},cloud.addPadFile=function(padFile,inNode){var defer=$q.defer();if(angular.isUndefined(inNode)||inNode.type!==cloud.TYPES.FOLDER)return defer.reject("Une erreur s'est produite"),defer.promise;var baseUrl="televersement?mode=CLOUD&dest="+inNode.id,data={file:padFile.libelle+".pad;"+padFile.url};return $http({method:"POST",url:baseUrl,data:data}).then(function(response){padFile=response.data.data,inNode.children=inNode.children?inNode.children:[],inNode.children.push(padFile),defer.resolve(padFile)},function(error){defer.reject(error)}),defer.promise},cloud.addUrlFile=function(file,inNode){var defer=$q.defer();if(angular.isUndefined(inNode)||inNode.type!==cloud.TYPES.FOLDER)return defer.reject("Une erreur s'est produite"),defer.promise;var baseUrl="televersement?mode=CLOUD&dest="+inNode.id,data={file:file.libelle+".url;"+file.url};return""!==file.description&&(data.description=file.description),$http({method:"POST",url:baseUrl,data:data}).then(function(response){file=response.data.data,inNode.children=inNode.children?inNode.children:[],inNode.children.push(file),defer.resolve(file)},function(error){defer.reject(error)}),defer.promise},cloud.addVisioFile=function(visioFile,inNode){var defer=$q.defer();if(angular.isUndefined(inNode)||inNode.type!==cloud.TYPES.FOLDER)return defer.reject("Une erreur s'est produite"),defer.promise;var baseUrl="televersement?mode=CLOUD&dest="+inNode.id,data={file:visioFile.libelle+".rtc"};return $http({method:"POST",url:baseUrl,data:data}).then(function(response){visioFile=response.data.data,inNode.children=inNode.children?inNode.children:[],inNode.children.push(visioFile),defer.resolve(visioFile)},function(error){defer.reject(error)}),defer.promise},cloud.getExtension=function(nom){var re=/(?:\.([^.]+))?$/,ext=re.exec(nom)[1];return lodash.contains(availableIcones,ext)?ext:"_page"},cloud.isImage=function(fileNode){return["gif","bmp","png","jpg","jpeg"].indexOf(cloud.getExtension(fileNode.id))>-1},cloud.isUrlFile=function(fileNode){return["url"].indexOf(cloud.getExtension(fileNode.id))>-1&&fileNode.url},cloud.isPadFile=function(fileNode){return["pad"].indexOf(cloud.getExtension(fileNode.id))>-1},cloud.isVisioFile=function(fileNode){return["rtc"].indexOf(cloud.getExtension(fileNode.id))>-1},cloud.isFullyLoaded=function(node){return Array.isArray(node.children)?node.isLoaded&&node.children.reduce(function(acc,curr){return acc&&cloud.isFullyLoaded(curr)},!0):!0},cloud.loadNodesFully=function(idUser,typeCloud,tabNodes){var defer=$q.defer(),lesPromises=[],tabNodesToCopy=angular.copy(tabNodes);return tabNodesToCopy.forEach(function(n){cloud.isFullyLoaded(n)||lesPromises.push(cloud.getFolderContent(n,idUser,typeCloud,999))}),$q.all(lesPromises).then(function(listNodesLoaded){tabNodesToCopy=tabNodesToCopy.map(function(node){var iLoaded=lodash.findIndex(listNodesLoaded,{id:node.id});return iLoaded>-1&&(node=listNodesLoaded[iLoaded]),node}),defer.resolve(tabNodesToCopy)},function(error){Notification.notify("Erreur",error.data.message,"danger"),defer.reject(error)}),defer.promise},cloud.getVisioPublicAccess=function(idVisio,idUser,typeCloud){var defer=$q.defer(),baseUrl="visio/"+typeCloud+"/"+idUser+"/publicAccess?id="+encodeURIComponent(idVisio);return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data.publicAccess|!1)},function(error){defer.reject(error)}),defer.promise},cloud.updateVisioPublicAccess=function(idVisio,publicAccess,idUser,typeCloud){var defer=$q.defer(),baseUrl="visio/"+typeCloud+"/"+idUser+"/publicAccess?id="+encodeURIComponent(idVisio);return $http({method:"PUT",url:baseUrl,data:{publicAccess:publicAccess}}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},cloud}]),angular.module("edsiteApp.Cloud").controller("EleveCloudCtrl",["$scope","user","ModuleService","CloudService","Auth",function($scope,user,ModuleService,CloudService,Auth){user.libelle=user.prenom,user.type=Auth.TYPE_USER.ELEVE,user.droit=CloudService.CONSTANTES.DROIT_ADMIN,$scope.user=user}]),angular.module("edsiteApp.Cloud").controller("EnseignantCloudCtrl",["$scope","ModuleService","CloudService","Auth",function($scope,ModuleService,CloudService,Auth){var user={libelle:Auth.currentUser().prenom,type:Auth.TYPE_USER.ENSEIGNANT,id:Auth.currentUser().id,droit:CloudService.CONSTANTES.DROIT_ADMIN};$scope.user=user}]),angular.module("edsiteApp.Cloud").controller("PersonnelCloudCtrl",["$scope","ModuleService","CloudService","Auth",function($scope,ModuleService,CloudService,Auth){var user={libelle:Auth.currentUser().prenom,type:Auth.TYPE_USER.ENSEIGNANT,id:Auth.currentUser().id,droit:CloudService.CONSTANTES.DROIT_ADMIN};$scope.user=user}]),angular.module("edsiteApp.Cloud").controller("CloudfinderCtrl",["$scope","$uibModalInstance","CloudService","Auth","lodash",function($scope,$uibModalInstance,CloudService,Auth,lodash){function filterNodes(nodes,attr,value,isEqual){return isEqual=angular.isUndefined(isEqual)?!0:isEqual,lodash.filter(nodes,function(node){if(angular.isUndefined(node.children)){if(angular.isUndefined(node[attr]))return!0;var isOk=!1;return isEqual&&node[attr]===value?isOk=!0:isEqual||node[attr]===value||(isOk=!0),isOk}return node.children=filterNodes(node.children,attr,value,isEqual),!0})}function closeFinder(){$uibModalInstance.dismiss()}function selectFile(selectedFile){$uibModalInstance.close(selectedFile)}$scope.dossiers={},$scope.treeopts={dirSelectable:!1,isLeaf:function(node){return"folder"!==node.type}},$scope.selectFile=selectFile,$scope.close=closeFinder;var userRole=Auth.role();userRole===Auth.TYPE_USER.PERSONNEL&&(userRole=Auth.TYPE_USER.ENSEIGNANT),$scope.requestLoading=CloudService.getCloudContents(Auth.currentUser().id,userRole).then(function(dossiers){$scope.dossiers=filterNodes(dossiers,"url","",!0),$scope.dossiers[0].collapsed=!1}),$scope.onSelectedNode=function(node){node.collapsed=!1,"folder"===node.type&&($scope.requestLoading=CloudService.getFolderContent(node,Auth.currentUser().id,userRole).then(function(folder){$scope.requestLoading=void 0,$scope.cloudTree.currentNode=folder,node.selected="",node.children=filterNodes(node.children,"url","",!0)}))}}]),angular.module("edsiteApp.Cloud").controller("UrlFileModalCtrl",["$scope","$uibModalInstance","$filter","CloudService","config",function($scope,$uibModalInstance,$filter,CloudService,config){function getTitle(){return vm.isModeAjout?"Ajouter un lien":vm.isModeEdit?"Modifier le lien":vm.file.libelle}function submitUrlFile(){var fileToUpdate=angular.copy(vm.fileUpdated);fileToUpdate.description=$filter("base64encode")(vm.fileUpdated.description),vm.isModeAjout?vm.promiseLoading=CloudService.addUrlFile(fileToUpdate,vm.node):vm.isModeEdit&&(vm.promiseLoading=CloudService.renameNode(vm.idUser,vm.typeUser,fileToUpdate.libelle,vm.file,vm.node,fileToUpdate.url,fileToUpdate.description)),vm.promiseLoading.then(function(fileUpdated){$uibModalInstance.close()},function(error){$uibModalInstance.close(error)})}function setModeEdit(isModeEdit){vm.isModeEdit=isModeEdit}function cancelFn(){$uibModalInstance.dismiss()}var vm=this;vm.getTitle=getTitle,vm.cancelFn=cancelFn,vm.submitUrlFile=submitUrlFile,vm.setModeEdit=setModeEdit,vm.promiseLoading=null,vm.isModeAjout=null===config.file,vm.file=vm.isModeAjout?{libelle:"",url:""}:config.file,vm.isModeEdit=vm.isModeAjout,vm.fileUpdated=angular.copy(vm.file),vm.fileUpdated.description=$filter("base64decode")(vm.fileUpdated.description),vm.isEditable=vm.isModeAjout||"rw"===config.mode,vm.node=config.node,vm.idUser=config.idUser,vm.typeUser=config.typeUser,vm.title=vm.getTitle()}]),angular.module("edsiteApp.Cloud").controller("PadModalCtrl",["$scope","$uibModalInstance","$filter","Notification","Auth","CloudService","config",function($scope,$uibModalInstance,$filter,Notification,Auth,CloudService,config){function getIframeSrc(){return""!==vm.padFile.url?vm.padFile.url+vm.displayPadParametres:vm.padFile.url}function getPadParametres(){function bitwiseEncode(str,key){for(var str=str.toString(),encodedStr="",i=0;i<str.length;i++){var char=str.charCodeAt(i),bitwise=char^key;encodedStr+=String.fromCharCode(bitwise)}return encodedStr}var userName=$filter("displayNom")(Auth.currentUser(),!1,!0),cryptKey="]GUz5Er(<7x4,29d#aQC",crypt=$filter("base64encode")(bitwiseEncode(userName,cryptKey));return"?lang=fr&userName="+userName+"&c="+crypt}function getTitle(){return vm.isModeAjout?"Ajouter un nouveau pad":vm.padFile.libelle}function createFilePad(){vm.promiseContents=CloudService.addPadFile(vm.padFile,vm.node).then(function(fileUpdated){Notification.notify("Mise à jour","Le pad a été créé avec succès","success"),$uibModalInstance.close(fileUpdated)},function(error){var message=angular.isString(error)?error:error.data.message;Notification.notify("Erreur",message,"danger")})}function cancelFn(){$uibModalInstance.dismiss()}var vm=this;vm.getTitle=getTitle,vm.cancelFn=cancelFn,vm.createFilePad=createFilePad,vm.getPadParametres=getPadParametres,vm.getIframeSrc=getIframeSrc,vm.promiseContents=null,vm.isModeAjout=null===config.padFile,vm.padFile=vm.isModeAjout?{libelle:"",url:""}:config.padFile,vm.node=config.node,vm.idUser=config.idUser,vm.typeUser=config.typeUser,vm.title=vm.getTitle(),vm.displayPadParametres=vm.getPadParametres(),vm.iframeSrc=vm.getIframeSrc()}]),angular.module("edsiteApp.Cloud").controller("VisioModalCtrl",["$scope","$uibModalInstance","$q","$interval","$filter","Notification","Auth","CloudService","config",function($scope,$uibModalInstance,$q,$interval,$filter,Notification,Auth,CloudService,config){function getTitle(){return vm.isModeAjout?"Ajouter une nouvelle visio":vm.visioFile.libelle}function createFileVisio(){vm.promiseContents=CloudService.addVisioFile(vm.visioFile,vm.node).then(function(fileUpdated){Notification.notify("Mise à jour","La visio a été créé avec succès","success"),$uibModalInstance.close(fileUpdated)},function(err){var message=angular.isString(err)?err:err.data.message;Notification.notify("Erreur",message,"danger")})}function openFileVisio(){vm.loadingVisio=$q.defer();var deferAccess=$q.defer();vm.isProprietaire||vm.visioFile.publicAccess?deferAccess.resolve():CloudService.getVisioPublicAccess(vm.visioFile.id,vm.idUser,vm.typeUser).then(function(isPublicAccess){isPublicAccess?(vm.visioFile.publicAccess=isPublicAccess,deferAccess.resolve()):(Notification.notify("Erreur","Cette visio n'est pas disponible actuellement","danger"),deferAccess.reject())},function(err){Notification.notify("Erreur","Une erreur s'est produite","danger"),deferAccess.reject()}),deferAccess.promise.then(function(){joinVisio()},function(){vm.loadingVisio.reject()})}function cancelFn(){vm.visioDisplay&&vm.visioDisplay.dispose(),$uibModalInstance.dismiss()}function joinVisio(){var domain=vm.visioFile.serveur.replace("https://",""),options={roomName:vm.visioFile.roomName,parentNode:document.querySelector("div#visio-modal .modal-body"),userInfo:{displayName:$filter("displayNom")(Auth.currentUser(),!1,!0)},interfaceConfigOverwrite:{DEFAULT_REMOTE_DISPLAY_NAME:"Participant",TOOLBAR_BUTTONS:["microphone","camera","closedcaptions","desktop","fullscreen","fodeviceselection","hangup","profile","chat","settings","videoquality","invite","feedback","stats","tileview","videobackgroundblur","download","help","mute-everyone"],SETTINGS_SECTIONS:["devices","language","profile"]},onload:function(){vm.isProprietaire?CloudService.updateVisioPublicAccess(vm.visioFile.id,!0,vm.idUser,vm.typeUser).then(function(){vm.loadingVisio&&vm.loadingVisio.resolve()},function(){vm.loadingVisio&&vm.loadingVisio.reject()}):vm.loadingVisio&&vm.loadingVisio.resolve()},readyToClose:function(){}};Auth.isProfesseur()||(options.interfaceConfigOverwrite.TOOLBAR_BUTTONS=["chat","raisehand","videoquality"],options.interfaceConfigOverwrite.SETTINGS_SECTIONS=[]),vm.visioDisplay=new JitsiMeetExternalAPI(domain,options)}function stopIntervalRefreshPublicAccess(){angular.isDefined(vm.intervalRefresh)&&$interval.cancel(vm.intervalRefresh)}function refreshPublicAccess(){CloudService.getVisioPublicAccess(vm.visioFile.id,vm.idUser,vm.typeUser).then(function(isPublicAccess){isPublicAccess&&(vm.visioFile.publicAccess=isPublicAccess,vm.openFileVisio(),stopIntervalRefreshPublicAccess())})}function init(){vm.isModeAjout||(vm.isProprietaire||vm.visioFile.publicAccess?vm.openFileVisio():(refreshPublicAccess(),vm.intervalRefresh=$interval(function(){refreshPublicAccess()},5e3)))}var vm=this;vm.getTitle=getTitle,vm.cancelFn=cancelFn,vm.createFileVisio=createFileVisio,vm.openFileVisio=openFileVisio,vm.promiseContents=null,vm.loadingVisio=null,vm.visioDisplay=null,vm.isModeAjout=null===config.visioFile,vm.visioFile=vm.isModeAjout?{libelle:"",rtcDescription:""}:config.visioFile,vm.node=config.node,vm.idUser=config.idUser,vm.typeUser=config.typeUser,vm.title=vm.getTitle(),vm.remoteVideo=null,vm.remoteStream=new MediaStream,vm.isProprietaire=angular.isDefined(vm.visioFile.proprietaire)&&vm.visioFile.proprietaire.id===Auth.currentUser().id&&vm.visioFile.proprietaire.type===Auth.currentUser().typeCompte,$uibModalInstance.rendered.then(function(){init()}),$scope.$on("$destroy",function(){stopIntervalRefreshPublicAccess(),vm.visioDisplay&&vm.visioDisplay.dispose()})}]),angular.module("edsiteApp.RPP",["edsiteApp.Commun"]).controller("ReunionparentprofCtrl",["$scope","$routeParams","ModuleService","ReunionParentProfService","UserService","eleve","Notification",function($scope,$routeParams,ModuleService,ReunionParentProfService,UserService,eleve,Notification){function isPast(leJour){return moment().isAfter(moment(leJour),"day")}function refresh(){$scope.promiseContents=ReunionParentProfService.getReunionsParentProf(eleve.id).then(function(reunions){$scope.reunions=reunions})}function reserveCreneau(reunion,creneau){(creneau.etat===$scope.ETATS.disponible||creneau.etat===$scope.ETATS.parMoi)&&($scope.promiseReserveCreneaux=ReunionParentProfService.reserveCreneau(reunion,creneau,$scope.eleve.id).then(function(message){Notification.notify("Réservation",message,"success")},function(errorMsg){Notification.notify("Erreur",errorMsg.data.message,"error"),$scope.refresh()}))}$scope.reunions=[],$scope.refresh=refresh,$scope.reserveCreneau=reserveCreneau,$scope.isPast=isPast,$scope.eleve=eleve,$scope.configInputFile={},$scope.ETATS=ReunionParentProfService.ETATS,$scope.accordionControl={onCollapse:function(){1===$scope.reunions.length&&$scope.accordionControl.toggle(0)}},$scope.expandCallback=function(){},$scope.collapseCallback=function(){},UserService.getEleve($routeParams.ideleve).then(function(eleve){$scope.eleve=eleve}),$scope.refresh(),ModuleService.clearBadges(ModuleService.CODES.REUNIONS_PP,eleve.id)}]),angular.module("edsiteApp").factory("CheckStrengthService",function(){var subscribers=[],service={colors:["#F00","#F90","#FF0","#9F0","#0F0"],measureStrength:function(p){if("undefined"==typeof p)return 0;var _force=0,_regex=/[$-\/:-?{-~!"^_`\[\]]/g,_lowerLetters=/[a-z]+/.test(p),_upperLetters=/[A-Z]+/.test(p),_numbers=/[0-9]+/.test(p),_symbols=_regex.test(p),_flags=[_lowerLetters,_upperLetters,_numbers,_symbols],_passedMatches=$.grep(_flags,function(el){return!!el}).length;return _force+=2*p.length+(p.length>=10?1:0),_force+=10*_passedMatches,_force=p.length<=4?Math.min(_force,10):_force,_force=1===_passedMatches?Math.min(_force,10):_force,_force=2===_passedMatches?Math.min(_force,20):_force,_force=3===_passedMatches?Math.min(_force,40):_force},getColor:function(s){var idx=0;return idx=10>=s?0:20>=s?1:30>=s?2:40>=s?3:4,{idx:idx+1,col:this.colors[idx]}}};return service.subscribeToChange=function(fct){subscribers.push(fct)},service.unsubscribeToChange=function(fct){delete subscribers[fct]},service.notify=function(val){angular.forEach(subscribers,function(sub){sub(val)})},service}).directive("checkStrengthInput",["CheckStrengthService",function(CheckStrengthService){return{require:"ngModel",restrict:"EACM",link:function(scope,elem,attr,ngModel){ngModel.$parsers.unshift(function(value){var valid=CheckStrengthService.getColor(CheckStrengthService.measureStrength(value)).idx>=attr.niveau;return ngModel.$setValidity("niveau",valid),CheckStrengthService.notify(value),valid?value:void 0}),ngModel.$formatters.unshift(function(value){var valid=CheckStrengthService.getColor(CheckStrengthService.measureStrength(value)).idx>=attr.niveau;return ngModel.$setValidity("niveau",valid),CheckStrengthService.notify(value),value})}}}]).directive("checkStrength",["CheckStrengthService",function(CheckStrengthService){return{replace:!1,restrict:"EACM",link:function(scope,iElement){function onChange(strength){if(""===strength)iElement.css({display:"none"});else{var c=CheckStrengthService.getColor(CheckStrengthService.measureStrength(strength));iElement.css({display:"inline"}),iElement.children("li").css({background:"#DDD"}).slice(0,c.idx).css({background:c.col})}}CheckStrengthService.subscribeToChange(onChange),scope.$on("$destroy",function(){CheckStrengthService.unsubscribeToChange(onChange)})},template:'<li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li>'}}]),angular.module("edsiteApp.CoordonneesFamille",["edsiteApp.Commun","edsiteApp.DemandeModifications","edsiteApp.Villes","edsiteApp.base64filter","edsiteApp.cspService","edsiteApp.situationsFamilaleService"]).controller("FamillecoordonneesCtrl",["$q","$filter","$timeout","Auth","CoordonneesFamilleService","DemandeModificationsService","ModuleService","VillesService","CspService","SituationsFamilaleService","Notification","lodash",function($q,$filter,$timeout,Auth,CoordonneesFamilleService,DemandeModificationsService,ModuleService,VillesService,CspService,SituationsFamilaleService,Notification,lodash){function refresh(){var listePromises=[CspService.listeCodesSocioProfessionnels().then(function(categ){vm.categsSP=categ}),SituationsFamilaleService.listeSituations().then(function(situations){vm.situationsFam=situations}),DemandeModificationsService.listeDemandeModifications(Auth.idUser(),"coordonnees").then(function(laDemande){vm.demande=laDemande,vm.demandesEleves=laDemande.eleves})];vm.promiseContents=$q.all(listePromises).then(function(){CoordonneesFamilleService.familleCoordonnees().then(function(coordonnees){vm.coordonnees=coordonnees,vm.tabEleves=coordonnees.eleves,vm.parametrages=coordonnees.parametrages,vm.activitesEtablissement=vm.parametrages.activitesRestaurationScolaire.concat(vm.parametrages.activitesScolaire),vm.cspResponsable=vm.coordonnees.responsable.csp.libelle.toLowerCase(),vm.cspResponsable=lodash.capitalize(vm.cspResponsable),vm.cspConjoint=vm.coordonnees.conjoint.csp.libelle.toLowerCase(),vm.cspConjoint=lodash.capitalize(vm.cspConjoint),vm.situationFamiliale=vm.coordonnees.situationFamiliale.libelle.toLowerCase(),vm.situationFamiliale=lodash.capitalize(vm.situationFamiliale),vm.originalCoordonnees=angular.copy(coordonnees),vm.villes.push(vm.coordonnees.ville),vm.backUpCoordonnees=angular.copy(vm.coordonnees),angular.forEach(vm.tabEleves,function(eleve){eleve.mailModified=!1,eleve.telMobileModified=!1,eleve.regimeModified=!1,angular.forEach(eleve.activites,function(activite){activite.isModified=!1}),vm["infosEleve_"+eleve.id]=eleve,vm["originalInfosEleve_"+eleve.id]=angular.copy(eleve),vm["demandeEleve_"+eleve.id]=lodash.find(vm.demandesEleves,{idEleve:eleve.id})}),vm.backUpTabEleves=angular.copy(vm.tabEleves)})})}function isThereModificationFamille(){return!angular.equals(vm.originalCoordonnees,vm.coordonnees)}function cancelDemandeModifCoordFamille(demande){vm.promiseContents=DemandeModificationsService.cancelDemande(demande,"coordonnees").then(function(){Notification.notify("Vos informations","Votre demande de modification a été annulée","success","icon-ed_information",!0),vm.demande={},vm.demandeencours=!1})}function sendDemandeModificationCoordonnees(){vm.coordonneesModeEdit=!1,isThereModificationFamille()?(vm.demandeencours=!0,listeModif=$filter("base64encode")(modifsToXml()),vm.promiseContents=DemandeModificationsService.demandeModifications(listeModif,"coordonnees").then(function(){Notification.notify("Vos informations","Votre demande de modification va être transmise à l'établissement","success","icon-ed_information",!0),vm.refresh()})):Notification.notify("Vos informations","Aucune modification effectuée. Cette demande n'a donc pas été envoyée","info","icon-ed_information",!0)}function modifsToXml(){var contenuXml,noeudAdresse1,noeudAdresse2,noeudAdresse3,noeudCP,noeudVille,noeudConjointMailPerso,noeudConjointMailTravail,noeudConjointNom,noeudConjointMobile,noeudConjointTelTravail,noeudResponsableMailPerso,noeudResponsableMailTravail,noeudResponsableNom,noeudResponsableMobile,noeudResponsableTelTravail,noeudResponsableTelDomicile,noeudSituationFamiliale,noeudResponsableCSP,noeudConjointCSP,noeudResponsableProfession,noeudConjointProfession,noeudResponsableSociete,noeudConjointSociete;contenuXml=(new DOMParser).parseFromString("<demandeModifications></demandeModifications>","text/xml");var noeudPrincipal=contenuXml.getElementsByTagName("demandeModifications")[0];return noeudAdresse1=contenuXml.createElement("adresse1"),noeudAdresse1.appendChild(contenuXml.createTextNode(vm.coordonnees.adresseLigne1)),noeudAdresse2=contenuXml.createElement("adresse2"),noeudAdresse2.appendChild(contenuXml.createTextNode(vm.coordonnees.adresseLigne2)),noeudAdresse3=contenuXml.createElement("adresse3"),noeudAdresse3.appendChild(contenuXml.createTextNode(vm.coordonnees.adresseLigne3)),noeudCP=contenuXml.createElement("codePostal"),noeudCP.appendChild(contenuXml.createTextNode(vm.coordonnees.codePostal)),noeudVille=contenuXml.createElement("ville"),noeudVille.appendChild(contenuXml.createTextNode(vm.coordonnees.ville)),noeudSituationFamiliale=contenuXml.createElement("situationFamiliale"),noeudSituationFamiliale.appendChild(contenuXml.createTextNode(vm.coordonnees.situationFamiliale.code)),noeudResponsableMailPerso=contenuXml.createElement("responsableMailPerso"),noeudResponsableMailPerso.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.mailPerso)),noeudResponsableMailTravail=contenuXml.createElement("responsableMailTravail"),noeudResponsableMailTravail.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.mailTravail)),noeudResponsableNom=contenuXml.createElement("responsableNom"),noeudResponsableNom.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.nom)),noeudResponsableMobile=contenuXml.createElement("responsableTelMobile"),noeudResponsableMobile.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.telMobile)),noeudResponsableTelTravail=contenuXml.createElement("responsableTelTravail"),noeudResponsableTelTravail.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.telTravail)),noeudResponsableTelDomicile=contenuXml.createElement("responsableTelDomicile"),noeudResponsableTelDomicile.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.telDomicile)),noeudResponsableCSP=contenuXml.createElement("responsableCSP"),noeudResponsableCSP.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.csp.code)),noeudResponsableProfession=contenuXml.createElement("responsableProfession"),noeudResponsableProfession.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.profession)),noeudResponsableSociete=contenuXml.createElement("responsableSociete"),noeudResponsableSociete.appendChild(contenuXml.createTextNode(vm.coordonnees.responsable.societe)),noeudConjointMailPerso=contenuXml.createElement("conjointMailPerso"),noeudConjointMailPerso.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.mailPerso)),noeudConjointMailTravail=contenuXml.createElement("conjointMailTravail"),noeudConjointMailTravail.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.mailTravail)),noeudConjointNom=contenuXml.createElement("conjointNom"),noeudConjointNom.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.nom)),noeudConjointMobile=contenuXml.createElement("conjointTelMobile"),noeudConjointMobile.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.telMobile)),noeudConjointTelTravail=contenuXml.createElement("conjointTelTravail"),noeudConjointTelTravail.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.telTravail)),noeudConjointCSP=contenuXml.createElement("conjointCSP"),noeudConjointCSP.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.csp.code)),noeudConjointProfession=contenuXml.createElement("conjointProfession"),noeudConjointProfession.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.profession)),noeudConjointSociete=contenuXml.createElement("conjointSociete"),noeudConjointSociete.appendChild(contenuXml.createTextNode(vm.coordonnees.conjoint.societe)),noeudPrincipal.appendChild(noeudAdresse1),noeudPrincipal.appendChild(noeudAdresse2),noeudPrincipal.appendChild(noeudAdresse3),noeudPrincipal.appendChild(noeudCP),noeudPrincipal.appendChild(noeudVille),noeudPrincipal.appendChild(noeudSituationFamiliale),noeudPrincipal.appendChild(noeudSituationFamiliale),noeudPrincipal.appendChild(noeudConjointMailPerso),noeudPrincipal.appendChild(noeudConjointMailTravail),noeudPrincipal.appendChild(noeudConjointNom),noeudPrincipal.appendChild(noeudConjointMobile),noeudPrincipal.appendChild(noeudConjointTelTravail),noeudPrincipal.appendChild(noeudConjointCSP),noeudPrincipal.appendChild(noeudConjointProfession),noeudPrincipal.appendChild(noeudConjointSociete),noeudPrincipal.appendChild(noeudResponsableMailPerso),noeudPrincipal.appendChild(noeudResponsableMailTravail),noeudPrincipal.appendChild(noeudResponsableNom),noeudPrincipal.appendChild(noeudResponsableMobile),noeudPrincipal.appendChild(noeudResponsableTelTravail),noeudPrincipal.appendChild(noeudResponsableTelDomicile),noeudPrincipal.appendChild(noeudResponsableCSP),noeudPrincipal.appendChild(noeudResponsableProfession),noeudPrincipal.appendChild(noeudResponsableSociete),(new XMLSerializer).serializeToString(noeudPrincipal)}function setCoordonneesModeEdit(isModeEdit){
vm.coordonneesModeEdit=isModeEdit,isModeEdit||(vm.coordonnees=vm.backUpCoordonnees)}function listeVilles(_formCoordonnees){"undefined"!=typeof _formCoordonnees?vm.CPActu="undefined"!=typeof _formCoordonnees.codePostal?_formCoordonnees.codePostal.$viewValue:vm.coordonnees.codePostal:vm.CPActu=vm.coordonnees.codePostal,""!==vm.CPActu&&5===vm.CPActu.length?VillesService.listeVilles(vm.CPActu).then(function(villes){vm.villes=villes}):vm.villes=[]}function setInfosEleveModeEdit(isModeEdit,eleve){if(vm["infosEleve_"+eleve.id+"_ModeEdit"]=isModeEdit,!isModeEdit){var indexEleveToReset=lodash.findIndex(vm.backUpTabEleves,{id:eleve.id});vm.tabEleves[indexEleveToReset]=angular.copy(vm.backUpTabEleves[indexEleveToReset])}}function getLibelleRegime(idRegime){var regime=lodash.find(vm.parametrages.regimesScolaire,{id:idRegime});return angular.isDefined(regime)?regime.libelle:""}function selectActiviteEleve(activiteEleve,eleve,indiceDayActivity){var tabActivitesEleve=eleve.activites,indiceActiviteEleve=lodash.findIndex(tabActivitesEleve,function(activite){return activite.code===activiteEleve.code}),nouvelleActivite={code:activiteEleve.code,jour1:!1,jour2:!1,jour3:!1,jour4:!1,jour5:!1,jour6:!1,jour7:!1};-1===indiceActiviteEleve&&(tabActivitesEleve.push(nouvelleActivite),indiceActiviteEleve=tabActivitesEleve.length-1),tabActivitesEleve[indiceActiviteEleve]["jour"+indiceDayActivity]=!tabActivitesEleve[indiceActiviteEleve]["jour"+indiceDayActivity]}function isActiviteEleve(activiteEleve,eleve,indiceDayActivity){var indexActivite=lodash.findIndex(eleve.activites,function(activite){return activite.code===activiteEleve.code});return-1>=indexActivite?!1:eleve.activites[indexActivite]["jour"+indiceDayActivity]===!0}function isOneModifActivitesDispoEleve(eleve){return isDispoEnModif(eleve,"activite")||isDispoEnModif(eleve,"","MIDI")||isDispoEnModif(eleve,"","SOIR")}function isDispoEnModif(eleve,typeModif,codeActivite){var paramEtabModifRentree=lodash.find(vm.parametrages.activationsModifDeRentree,{idEtab:eleve.idEtablissement});if(angular.isUndefined(paramEtabModifRentree))return!1;var tabActivitesOuvertesPeriscolaire=lodash.reject(paramEtabModifRentree.activitesOuvertes,{type:"Repas"});if(!isNowModifDispo())return!1;if(angular.isDefined(codeActivite)){var isActiviteEtabEleveOuverte=lodash.find(paramEtabModifRentree.activitesOuvertes,{code:codeActivite});if(!isActiviteEtabEleveOuverte)return!1}if(tabActivitesOuvertesPeriscolaire.length<=0&&"activite"===typeModif){var regime=lodash.find(vm.parametrages.regimesScolaire,{id:eleve.idRegime});if(angular.isDefined(regime)&&"Midi"!==regime.type&&"Soir-Matin"!==regime.type)return!1}return angular.isDefined(codeActivite)&&"MIDI"===codeActivite&&(typeModif="restaurationMidi",!isDispoForRegime(eleve,codeActivite))?!1:angular.isDefined(codeActivite)&&"SOIR"===codeActivite&&(typeModif="restaurationSoir",!isDispoForRegime(eleve,codeActivite))?!1:angular.isDefined(paramEtabModifRentree)?paramEtabModifRentree[typeModif]:!1}function isDispoForRegime(eleve,codeActivite){var regimeEleve=lodash.find(vm.parametrages.regimesScolaire,{id:eleve.idRegime}),isDispo=!0;return angular.isDefined(regimeEleve)&&("MIDI"===codeActivite&&(isDispo="Midi"===regimeEleve.type||"Soir-Matin"===regimeEleve.type),"SOIR"===codeActivite&&(isDispo="Soir-Matin"===regimeEleve.type)),isDispo}function getDateDebutModif(){return moment(vm.parametrages.dateModifDebut).format("DD MMMM")}function getDateFinModif(){return moment(vm.parametrages.dateModifFin).format("DD MMMM")}function isNowModifDispo(){return moment().isAfter(vm.parametrages.dateModifDebut)&&moment().isBefore(vm.parametrages.dateModifFin)||moment().isSame(vm.parametrages.dateModifFin,"day")||moment().isSame(vm.parametrages.dateModifDebut,"day")}function isActiviteRepasOuvertePourRegime(eleve){var regimeEleve=lodash.find(vm.parametrages.regimesScolaire,{id:eleve.idRegime}),paramEtabModifRentree=lodash.find(vm.parametrages.activationsModifDeRentree,{idEtab:eleve.idEtablissement}),isActivationModifRentreeRestauration=angular.isDefined(paramEtabModifRentree.restaurationMidi)&&angular.isDefined(paramEtabModifRentree.restaurationSoir)&&(paramEtabModifRentree.restaurationMidi||paramEtabModifRentree.restaurationSoir);return!isActivationModifRentreeRestauration||angular.isUndefined(regimeEleve)?!1:"Midi"!==regimeEleve.type&&"Soir-Matin"!==regimeEleve.type?!1:("Midi"!==regimeEleve.type||paramEtabModifRentree.restaurationMidi)&&("Soir-Matin"!==regimeEleve.type||paramEtabModifRentree.restaurationMidi||paramEtabModifRentree.restaurationSoir)?!0:!1}function isOneModuleRentreeInUpdate(eleve){var paramEtabModifRentree=lodash.find(vm.parametrages.activationsModifDeRentree,{idEtab:eleve.idEtablissement}),tabModulesRentree=["regime","restaurationMidi","restaurationSoir","activite"],isOneModuleToUpdate=!1;if(angular.isDefined(paramEtabModifRentree))for(var i=0;i<tabModulesRentree.length&&(isOneModuleToUpdate=paramEtabModifRentree[tabModulesRentree[i]]===!0,("restaurationMidi"===tabModulesRentree[i]||"restaurationSoir"===tabModulesRentree[i])&&(isOneModuleToUpdate=paramEtabModifRentree[tabModulesRentree[i]]===!0&&isActiviteRepasOuvertePourRegime(eleve)),!isOneModuleToUpdate);i++);return isOneModuleToUpdate}function setDataModified(eleve,attributeName,activiteSelected){if(isThereModificationEleve(eleve))if(angular.isDefined(activiteSelected)){var indexActiviteFound=lodash.findIndex(eleve.activites,{code:activiteSelected.code});eleve.activites[indexActiviteFound].isModified=!0}else eleve[attributeName]=!0}function cancelDemandeModifInfosEleve(demande,eleve){vm.promiseContents=DemandeModificationsService.cancelDemande(demande,"eleve").then(function(){Notification.notify("Vos informations","Votre demande de modification a été annulée","success","icon-ed_information",!0),vm["demandeEleve_"+eleve.id]={},vm["demandeencours_eleve_"+eleve.id]=!1})}function isThereModificationEleve(eleve){return!angular.equals(vm["originalInfosEleve_"+eleve.id],eleve)}function sendDemandeModificationInfosEleve(eleve){if(vm["infosEleve_"+eleve.id+"_ModeEdit"]=!1,isThereModificationEleve(eleve)){vm["demandeencours_eleve_"+eleve.id]=!0,listeModifsEleve=angular.copy(eleve),listeModifsEleve.mailModified!==!0&&delete listeModifsEleve.email,listeModifsEleve.telMobileModified!==!0&&delete listeModifsEleve.telMobile,listeModifsEleve.regimeModified!==!0&&delete listeModifsEleve.idRegime;for(var indiceActivite=listeModifsEleve.activites.length-1;indiceActivite>=0;indiceActivite--)listeModifsEleve.activites[indiceActivite].isModified!==!0&&listeModifsEleve.activites.splice(indiceActivite,1);vm.promiseContents=DemandeModificationsService.demandeModifications(listeModifsEleve,"eleve").then(function(){Notification.notify("Vos informations","Votre demande de modification va être transmise à l'établissement","success","icon-ed_information",!0),vm.refresh()})}else Notification.notify("Vos informations","Aucune modification effectuée. Cette demande n'a donc pas été envoyée","info","icon-ed_information",!0)}var vm=this;vm.coordonneesModeEdit=!1,vm.infosEleveModeEdit=!1,vm.coordonnees={},vm.demande={},vm.demandesEleves=[],vm.villes=[],vm.tabEleves=[],vm.ongletSelected="#coordonnees-famille",vm.listOfDays=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],vm.refresh=refresh,vm.sendDemandeModificationCoordonnees=sendDemandeModificationCoordonnees,vm.setCoordonneesModeEdit=setCoordonneesModeEdit,vm.setInfosEleveModeEdit=setInfosEleveModeEdit,vm.listeVilles=listeVilles,vm.cancelDemandeModifCoordFamille=cancelDemandeModifCoordFamille,vm.getLibelleRegime=getLibelleRegime,vm.selectActiviteEleve=selectActiviteEleve,vm.isActiviteEleve=isActiviteEleve,vm.isDispoEnModif=isDispoEnModif,vm.isOneModifActivitesDispoEleve=isOneModifActivitesDispoEleve,vm.getDateDebutModif=getDateDebutModif,vm.getDateFinModif=getDateFinModif,vm.isNowModifDispo=isNowModifDispo,vm.isOneModuleRentreeInUpdate=isOneModuleRentreeInUpdate,vm.sendDemandeModificationInfosEleve=sendDemandeModificationInfosEleve,vm.cancelDemandeModifInfosEleve=cancelDemandeModifInfosEleve,vm.setDataModified=setDataModified;var listeModif="",listeModifsEleve="";refresh(),ModuleService.clearBadges(ModuleService.CODES.COORDONNEES)}]),angular.module("edsiteApp.CoordonneesFamille").service("CoordonneesFamilleService",["$q","$http","EDHttp",function($q,$http,EDHttp){var CoordonneesFamilleServiceHelper={};return CoordonneesFamilleServiceHelper.familleCoordonnees=function(){var defer=$q.defer(),data={},baseUrl="famillecoordonnees";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},CoordonneesFamilleServiceHelper.familleCoordonneesByIdEleve=function(idEleve){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/coordonneesfamille";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},CoordonneesFamilleServiceHelper}]),angular.module("edsiteApp.DossierInscriptionFamille",["edsiteApp.Commun"]).controller("FamilleDossierInscriptionCtrl",["$uibModal","$scope","$routeParams","$location","$timeout","DossierInscriptionFamilleService","VillesService","CspService","SituationsFamilaleService","ModuleService","$q","lodash","Auth","Notification","Settings","ScrollTo","$rootScope",function($uibModal,$scope,$routeParams,$location,$timeout,DossierInscriptionFamilleService,VillesService,CspService,SituationsFamilaleService,ModuleService,$q,lodash,Auth,Notification,Settings,ScrollTo,$rootScope){function refresh(dossierFamilleUpdated,dossierEleveUpdated,isSignaturesUpdated,context){var listePromises=[DossierInscriptionFamilleService.getDossierInscription().then(function(dossierInscription){if(angular.isDefined(dossierInscription))if(angular.isUndefined(dossierFamilleUpdated)&&angular.isUndefined(dossierEleveUpdated)&&angular.isUndefined(isSignaturesUpdated))angular.isDefined(dossierInscription.parametrages.paramsJourEcheance)&&(dossierInscription.facturation.jourEcheance<=0?dossierInscription.facturation.jourEcheance=dossierInscription.parametrages.paramsJourEcheance.jourDefaut:dossierInscription.facturation.jourEcheance),vm.dossierInscription=dossierInscription,angular.isUndefined(context)?vm.setUpdateDossierComplet(vm.dossierInscription,Auth.TYPE_USER.ELEVE,!0):vm.setUpdateDossierComplet(vm.dossierInscription,context,!0);else if(angular.isDefined(dossierFamilleUpdated)&&null!==dossierFamilleUpdated)vm.dossierInscription.facturation=dossierInscription.facturation,vm.dossierInscription.idInscriptionResponsable=dossierInscription.idInscriptionResponsable,vm.dossierInscription.informationsComplementaires=dossierInscription.informationsComplementaires,vm.dossierInscription.piecesDossier=dossierInscription.piecesDossier,angular.isDefined(dossierInscription.parametrages.paramsJourEcheance)&&(dossierInscription.facturation.jourEcheance<=0?dossierInscription.facturation.jourEcheance=dossierInscription.parametrages.paramsJourEcheance.jourDefaut:dossierInscription.facturation.jourEcheance);else if(angular.isDefined(dossierEleveUpdated)&&null!==dossierEleveUpdated){var newPartieEleve=lodash.find(dossierInscription.eleves,{id:dossierEleveUpdated.id});if(angular.isDefined(newPartieEleve)){var indiceEleveDansDossier=lodash.findIndex(vm.dossierInscription.eleves,{id:dossierEleveUpdated.id});indiceEleveDansDossier>-1&&(vm.dossierInscription.eleves[indiceEleveDansDossier]=newPartieEleve)}}else angular.isDefined(isSignaturesUpdated)&&isSignaturesUpdated===!0&&(vm.dossierInscription.signaturesDocsLus=dossierInscription.signaturesDocsLus)})];return vm.promiseContents=$q.all(listePromises).then(function(){null!==vm.dossierInscription&&(vm.anneeScolaireInscription=vm.dossierInscription.parametrages.anneeScolaireInscription,vm.tabQuotientsFamille=vm.dossierInscription.parametrages.quotientsEtab,vm.tabParametrageFilieres=vm.dossierInscription.parametrages.filieres,angular.forEach(vm.tabQuotientsFamille,function(quotientFamilleParam){var quotientAucun=lodash.find(quotientFamilleParam.quotients,{code:"AUCUN"});"undefined"==typeof quotientAucun&&(quotientAucun={code:"AUCUN",libelle:" ",type:quotientFamilleParam.type},quotientFamilleParam.quotients.unshift(quotientAucun));var quotientFamilleFound=lodash.find(vm.dossierInscription.facturation.quotients,function(quotientF){return quotientF.type===quotientFamilleParam.type});angular.isUndefined(quotientFamilleFound)&&(vm.dossierInscription.facturation.quotients[quotientFamilleParam.type]=quotientAucun)}),vm.tabRegimesScolaire=vm.dossierInscription.parametrages.regimesScolaire,vm.tabDatesOuverturesEtablissements=vm.dossierInscription.parametrages.datesOuvertures,vm.tabDocumentsEtablissement=vm.dossierInscription.documentsEtablissement,vm.tabSignatures=vm.dossierInscription.signaturesDocsLus,vm.tabFilieres=angular.copy(vm.dossierInscription.parametrages.filieres),vm.tabDocumentsEtablissement=vm.tabDocumentsEtablissement.concat(lodash.chain(vm.tabFilieres).pluck("documentsEtablissement").flatten().uniq("code").value()),vm.tabDocumentsEtablissement=lodash.uniq(vm.tabDocumentsEtablissement,"code"),vm.tabFilieresEtape1=lodash.reject(vm.tabFilieres,{isEtape1Actif:!1}),vm.tabFilieresEtape1.unshift(vm.objAucuneFiliere),vm.tabFormations=angular.copy(vm.dossierInscription.parametrages.formations),vm.tabFormations.unshift(vm.objAucuneFormation),angular.forEach(vm.dossierInscription.piecesDossier,function(pieceDossier){pieceDossier.fichiers=[],pieceDossier.configInputFile=angular.extend({dropzoneContainer:"#pieces_dossier_famille_"+pieceDossier.code},vm.configInputFile),pieceDossier.dropzoneConfig=angular.extend({clickable:pieceDossier.configInputFile.dropzoneContainer+" .fileinput-button"},vm.dropzoneConfig)}),vm.tabSignataires=vm.getListeSignatairesDossier(),angular.forEach(vm.dossierInscription.eleves,function(eleve,indiceEleve){eleve.dateNaissanceFormated=new Date(eleve.dateNaissance),(""===eleve.dateNaissance||"undefined"==typeof eleve.dateNaissance)&&(eleve.dateNaissanceFormated=null),angular.isUndefined(vm["modeSaisieScolariteEleve"+eleve.id])&&(vm["modeSaisieScolariteEleve"+eleve.id]=!1);var tabQuotientsFiliereEleve=listQuotientsEleve(eleve);angular.forEach(tabQuotientsFiliereEleve,function(quotientEleveParam){var quotientAucun=lodash.find(quotientEleveParam.quotients,{code:"AUCUN"});"undefined"==typeof quotientAucun&&(quotientAucun={code:"AUCUN",libelle:" ",type:quotientEleveParam.type},quotientEleveParam.quotients.unshift(quotientAucun));var quotientEleveFound=lodash.find(eleve.quotients,function(quotientEleve){return quotientEleve.type===quotientEleveParam.type});angular.isUndefined(quotientEleveFound)&&(eleve.quotients[quotientEleveParam.type]=quotientAucun)}),angular.forEach(eleve.informationsComplementaires,function(infoComp){if("Date"===infoComp.type){var tabDate=infoComp.valeur.split("/");""!==tabDate[0]?infoComp.dateFormatedFr=vm.dateFormate(tabDate[2]+"-"+tabDate[1]+"-"+tabDate[0]):infoComp.dateFormatedFr=null}}),0===eleve.filiere.id&&(eleve.filiere=vm.objAucuneFiliere),""===eleve.formation.codeMEF&&(eleve.formation=vm.objAucuneFormation),eleve.etapeInscription===vm.CONSTANTES.INSCR_ETAPE1_VIDE&&(eleve.optionsFormation=[],eleve.optionsFormationsPossiblesParRang=[]),eleve.piecesDossierFournies=[],angular.forEach(eleve.piecesDossier,function(pieceDossier){pieceDossier.fichiers=[],pieceDossier.configInputFile=angular.extend({dropzoneContainer:"#pieces_dossier_eleve_"+eleve.id+"_"+pieceDossier.code},vm.configInputFile),pieceDossier.dropzoneConfig=angular.extend({clickable:pieceDossier.configInputFile.dropzoneContainer+" .fileinput-button"},vm.dropzoneConfig),""!==getUrlPieceDossier(pieceDossier)&&eleve.piecesDossierFournies.push(pieceDossier)}),eleve.tabDocsASigner=vm.getListeDocsASignerEleve(eleve),eleve.tabSignataires=vm.getListeSignatairesDossier(eleve),eleve.classeActuelle="";var eleveDuProfil=lodash.find(Auth.currentUser().profile.eleves,{id:eleve.id});angular.isDefined(eleveDuProfil)&&(eleve.classeActuelle=eleveDuProfil.classe.libelle)}),calculerAcompteFraisDossier())}),vm.promiseContents}function isValidIBAN(strIban){return"undefined"!=typeof strIban&&IBAN.isValid(strIban.replace(/ /g,""))}function isActiviteEleve(activiteEleve,eleve,indiceDayActivity){var indexActivite=lodash.findIndex(eleve.activites,function(activite){return activite.code===activiteEleve.code});return-1>=indexActivite?!1:eleve.activites[indexActivite]["jour"+indiceDayActivity]===!0}function selectActiviteEleve(activiteEleve,eleve,indiceDayActivity){var tabActivitesEleve=eleve.activites,indiceActiviteEleve=lodash.findIndex(tabActivitesEleve,function(activite){return activite.code===activiteEleve.code}),nouvelleActivite={libelle:activiteEleve.libelle,code:activiteEleve.code,jour1:!1,jour2:!1,jour3:!1,jour4:!1,jour5:!1,jour6:!1,jour7:!1};-1===indiceActiviteEleve&&(tabActivitesEleve.push(nouvelleActivite),indiceActiviteEleve=tabActivitesEleve.length-1),tabActivitesEleve[indiceActiviteEleve]["jour"+indiceDayActivity]=!tabActivitesEleve[indiceActiviteEleve]["jour"+indiceDayActivity],vm["formDossierInscriptionEleve_"+eleve.id].$setDirty()}function dateFormate(date,formatDate){return"undefined"==typeof formatDate&&(formatDate="D MMMM YYYY"),moment(date).format(formatDate)}function dateHeureFormate(dateHeure){return moment(dateHeure).format("dddd Do MMMM YYYY")+" à "+moment(dateHeure).format("HH:mm:ss")}function openModaleUpdateScolarite(eleve){var modalUpdateScolarite=$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/modal-modification-scolarite.html",backdrop:!1,controller:"modalModifScolariteEleve as ctrlModalModifScolariteEleve",resolve:{eleve:function(){return eleve}}});modalUpdateScolarite.result.then(function(eleve){if(angular.isDefined(eleve)){vm["formDossierInscriptionEleve_"+eleve.id].$setDirty();var indexEleve=lodash.findIndex(vm.dossierInscription.eleves,{id:eleve.id});indexEleve>-1&&(vm.dossierInscription.eleves[indexEleve].optionsFormation=eleve.optionsFormation),vm.setUpdateDossierComplet(vm.dossierInscription,Auth.TYPE_USER.ELEVE,!1,!0)}})}function confirmationLecture(eleve){if(Auth.isModeSupervision())return void Notification.notify("Dossier d'inscription","En mode supervision, cette action n'est pas disponible !","warning","glyphicon glyphicon-list-alt");var modalConfirmLecture=$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/confirmation-lecture-documents.html",backdrop:!1,controller:"modalSecureConfirmLectureDoc as secureModalLectureDoc",size:"lg",resolve:{datasDossierInscription:function(){return vm.dossierInscription},inscriptionEleve:function(){return eleve},listeDocumentsASigner:function(){return angular.isDefined(eleve)?eleve.tabDocsASigner:vm.dossierInscription.documentsEtablissement}}});modalConfirmLecture.result.then(function(isConfirmationValidee){isConfirmationValidee===!0&&vm.refresh(null,null,!0)})}function signerDossier(eleve,scroll){if(vm.isDisplayEtape2(eleve)){var formDossierEleve=vm["formDossierInscriptionEleve_"+eleve.id];if(!vm.isFormEleveValid(formDossierEleve,eleve,!1))return void vm.scrollToEleve(eleve);if(Auth.isModeSupervision())return Notification.notify("Dossier d'inscription","En mode supervision, cette action n'est pas disponible !","warning","glyphicon glyphicon-list-alt"),void vm.saveDatasEleve(eleve,!0);angular.isDefined(vm["formDossierInscriptionEleve_"+eleve.id])&&(eleve.enregistrementAlaVolee=!0,vm.saveDatasEleve(eleve,!1)),scroll===!0&&vm.scrollToEleve(eleve),vm.promiseContents.then(function(){var modalSignatureDossier=$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/modal-signature-dossier.html",backdrop:!1,controller:"SecureModalSignatureDossier as ctrlSignatureDossier",resolve:{inscriptionEleve:function(){return eleve.idInscriptionEleve},domElementId:function(){return"eleve_"+eleve.id}}});modalSignatureDossier.result.then(function(isSignatureOK){isSignatureOK===!0&&vm.refresh(null,eleve,!1)})})["catch"](function(error){Notification.notify("Dossier d'inscription","Impossible de signer le dossier tant qu'il n'est pas sauvegardé !","warning","glyphicon glyphicon-list-alt")})}}function sortirEleve(eleve){var modalConfirm=$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/confirmation-desinscription-eleve.html",backdrop:!1,controller:"modalConfirmSortieEleve as ctrlModalConfirmSortieEleve",resolve:{lesMotifs:function(){return vm.dossierInscription.parametrages.motifsSortie},eleve:function(){return eleve}}});modalConfirm.result.then(function(isSortieValidee){isSortieValidee===!0&&vm.saveDatasEleve(eleve)})}function inscrireEleve(eleve){vm["modeSaisieScolariteEleve"+eleve.id]=!0}function getLibelleEtapeInscription(inscription){return DossierInscriptionFamilleService.getLibelleEtapeInscription(inscription)}function enAttenteDeSynchro(inscription){return inscription.etapeInscription===DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE&&0===inscription.filiere.id}function updateTotalPourcentagePayeurs(eleve,form,indiceEleve,indexPayeur){var pourcentageTotal=0,pourcentageAutresPayeurs=0,pourcentagePayeurPrinc=0;form.$invalid=!0,form["pourcentage_payeur"+indexPayeur+"_eleve"+indiceEleve].$invalid=!1,angular.forEach(eleve.payeurs,function(payeur){payeur.responsablePrincipal||(pourcentageAutresPayeurs+=payeur.pourcentage)});var payeurPrincipal=lodash.find(eleve.payeurs,{responsablePrincipal:!0});return pourcentagePayeurPrinc=100-pourcentageAutresPayeurs,100>=pourcentagePayeurPrinc&&pourcentagePayeurPrinc>=0&&(payeurPrincipal.pourcentage=pourcentagePayeurPrinc),pourcentageTotal=pourcentageAutresPayeurs+payeurPrincipal.pourcentage,100!==pourcentageTotal?(form["pourcentage_payeur"+indexPayeur+"_eleve"+indiceEleve].$invalid=!0,!1):void(form.$invalid=!1)}function listQuotientsEleve(eleve){var paramFiliereEleve=lodash.find(vm.tabParametrageFilieres,function(filiere){return filiere.id===eleve.filiere.id});return angular.isDefined(paramFiliereEleve)?paramFiliereEleve.quotientsEtab:[]}function getLibelleQuotientEtab(eleve,quotient){var tabQuotientsEtab=listQuotientsEleve(eleve),quotientFound=lodash.find(tabQuotientsEtab,{type:quotient.type,typeUser:Auth.TYPE_USER.ELEVE});return angular.isDefined(quotientFound)?quotientFound.libelle:""}function isJourActifPourActivite(libelleJour,codeActivite,idFiliere){var paramFiliereEleve=lodash.find(vm.tabParametrageFilieres,function(filiere){return filiere.id===idFiliere});if(angular.isUndefined(paramFiliereEleve))return!1;var paramActivite=lodash.find(paramFiliereEleve.activites,function(activite){return activite.code===codeActivite});return angular.isUndefined(paramActivite)?!1:lodash.indexOf(paramActivite.joursActifs,libelleJour)>-1}function isRegimesFiliereActif(filiere){var paramFiliereEleve=lodash.find(vm.tabParametrageFilieres,function(filiereEleve){return filiereEleve.id===filiere.id});return angular.isDefined(paramFiliereEleve)&&paramFiliereEleve.isRegimeActif}function annulerSaisie(){refresh(),vm.editTitulaireCompte=!1}function onSelectFiliereEleve(eleve){eleve.formation=vm.objAucuneFormation,eleve.optionsFormation.length=0,eleve.optionsFormationsPossiblesParRang.length=0,calculerAcompteFraisDossier()}function onSelectRegimeScolaireEleve(eleve){calculerAcompteFraisDossier()}function listFormationsEleve(filiereEleve){return lodash.filter(vm.tabFormations,function(formation){return 0===formation.idFiliere||formation.idFiliere===filiereEleve.id})}function onSelectFormationEleve(formationEleve,eleve){eleve.optionsFormation.length=0,eleve.optionsFormationsPossiblesParRang.length=0,angular.isUndefined(formationEleve)||""===formationEleve.codeMEF||(vm.promiseContents=DossierInscriptionFamilleService.getOptionsFormation(formationEleve.codeMEF,Auth.codeOgec(),1,formationEleve.codeSpecialite).then(function(tabOptionsFormation){DossierInscriptionFamilleService.cleanTabOptionsFormationPossibles(tabOptionsFormation.optionsFormation,eleve),angular.isUndefined(eleve.optionsFormationsPossiblesParRang)?eleve.optionsFormationsPossiblesParRang=[]:eleve.optionsFormationsPossiblesParRang.length=0,eleve.optionsFormationsPossiblesParRang[0]=tabOptionsFormation.optionsFormation},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)}))}function onSelectOptionFormationEleve(rangOption,eleve){angular.isUndefined(eleve.formation)||eleve.optionsFormation.length>=12||(vm.promiseContents=DossierInscriptionFamilleService.getOptionsFormation(eleve.formation.codeMEF,Auth.codeOgec(),rangOption+1,eleve.formation.codeSpecialite).then(function(tabOptionsFormation){DossierInscriptionFamilleService.cleanTabOptionsFormationPossibles(tabOptionsFormation.optionsFormation,eleve),eleve.optionsFormationsPossiblesParRang[rangOption]=tabOptionsFormation.optionsFormation},function(data){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)}))}function removeLastOptionFormationEleve(eleve){eleve.optionsFormationsPossiblesParRang.pop(),eleve.optionsFormation.pop()}function isOptionFormationDisabled(rangFormation,eleve){return rangFormation<eleve.optionsFormation.length&&angular.isDefined(eleve.optionsFormationsPossiblesParRang[rangFormation+1])&&eleve.optionsFormationsPossiblesParRang[rangFormation+1].length>0}function calculerAcompteFraisDossier(){vm.dossierInscription.reglement={reg1:0,reg2:0,reg3:0},vm.dossierInscription.eleves.forEach(function(dossierEleve){dossierEleve.inscriptionEtabActive&&(calculerAcompteFraisDossierEleve(dossierEleve),vm.dossierInscription.reglement.reg1+=dossierEleve.reg1.aPayer,vm.dossierInscription.reglement.reg2+=dossierEleve.reg2.aPayer,vm.dossierInscription.reglement.reg3+=dossierEleve.reg3.aPayer,dossierEleve.reg1.actif&&(vm.dossierInscription.reg1Actif=!0),dossierEleve.reg2.actif&&(vm.dossierInscription.reg2Actif=!0),dossierEleve.reg3.actif&&(vm.dossierInscription.reg3Actif=!0))})}function calculerAcompteFraisDossierEleve(eleve){if(eleve.reg1={montant:0,dejaPaye:0,aPayer:0,libelle:"",actif:!1},eleve.reg2={montant:0,dejaPaye:0,aPayer:0,libelle:"",actif:!1},eleve.reg3={montant:0,dejaPaye:0,aPayer:0,libelle:"",actif:!1},!(eleve.etapeInscription<vm.CONSTANTES.INSCR_ETAPE2_VIDE||eleve.etapeInscription>=vm.CONSTANTES.INSCR_ETAPE3)){var paramsFiliere=lodash.find(vm.dossierInscription.parametrages.filieres,{id:eleve.filiere.id});angular.isUndefined(paramsFiliere)||(eleve.reinscription?(angular.isUndefined(paramsFiliere.montantsReg1ParRegime.reinscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg1.montant=paramsFiliere.montantsReg1ParDefautReinscription:eleve.reg1.montant=paramsFiliere.montantsReg1ParRegime.reinscription[eleve.regimeScolaire],eleve.reg1.libelle=paramsFiliere.reglement1Libelle,eleve.reg1.actif=paramsFiliere.isReglement1Actif,angular.isUndefined(paramsFiliere.montantsReg2ParRegime.reinscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg2.montant=paramsFiliere.montantsReg2ParDefautReinscription:eleve.reg2.montant=paramsFiliere.montantsReg2ParRegime.reinscription[eleve.regimeScolaire],eleve.reg2.libelle=paramsFiliere.reglement2Libelle,eleve.reg2.actif=paramsFiliere.isReglement2Actif,angular.isUndefined(paramsFiliere.montantsReg3ParRegime.reinscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg3.montant=paramsFiliere.montantsReg3ParDefautReinscription:eleve.reg3.montant=paramsFiliere.montantsReg3ParRegime.reinscription[eleve.regimeScolaire],eleve.reg3.libelle=paramsFiliere.reglement3Libelle,eleve.reg3.actif=paramsFiliere.isReglement3Actif):(angular.isUndefined(paramsFiliere.montantsReg1ParRegime.inscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg1.montant=paramsFiliere.montantsReg1ParDefautInscription:eleve.reg1.montant=paramsFiliere.montantsReg1ParRegime.inscription[eleve.regimeScolaire],eleve.reg1.libelle=paramsFiliere.reglement1Libelle,eleve.reg1.actif=paramsFiliere.isReglement1Actif,angular.isUndefined(paramsFiliere.montantsReg2ParRegime.inscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg2.montant=paramsFiliere.montantsReg2ParDefautInscription:eleve.reg2.montant=paramsFiliere.montantsReg2ParRegime.inscription[eleve.regimeScolaire],eleve.reg2.libelle=paramsFiliere.reglement2Libelle,eleve.reg2.actif=paramsFiliere.isReglement2Actif,angular.isUndefined(paramsFiliere.montantsReg3ParRegime.inscription[eleve.regimeScolaire])||0===eleve.regimeScolaire?eleve.reg3.montant=paramsFiliere.montantsReg3ParDefautInscription:eleve.reg3.montant=paramsFiliere.montantsReg3ParRegime.inscription[eleve.regimeScolaire],eleve.reg3.libelle=paramsFiliere.reglement3Libelle,eleve.reg3.actif=paramsFiliere.isReglement3Actif),lodash.filter(vm.dossierInscription.historiquePaiements,{idEleve:eleve.id,type:"INSREG1"}).forEach(function(paiement){eleve.reg1.dejaPaye+=paiement.montant}),lodash.filter(vm.dossierInscription.historiquePaiements,{idEleve:eleve.id,type:"INSREG2"}).forEach(function(paiement){eleve.reg2.dejaPaye+=paiement.montant}),lodash.filter(vm.dossierInscription.historiquePaiements,{idEleve:eleve.id,type:"INSREG3"}).forEach(function(paiement){eleve.reg3.dejaPaye+=paiement.montant}),eleve.reg1.aPayer=Math.round(100*(eleve.reg1.montant-eleve.reg1.dejaPaye))/100,eleve.reg2.aPayer=Math.round(100*(eleve.reg2.montant-eleve.reg2.dejaPaye))/100,eleve.reg3.aPayer=Math.round(100*(eleve.reg3.montant-eleve.reg3.dejaPaye))/100)}}function saveDatasFamille(formDossierFamille,withScroll,forceSauvegarde,validate){if(withScroll){var encartFamille=angular.element("#bloc_famille")[0],bodyEncartEleve=angular.element("#bloc_famille .form-insreins-body")[0],hauteurToScroll=encartFamille.offsetHeight-bodyEncartEleve.offsetHeight;angular.isDefined(encartFamille)&&hauteurToScroll>0&&ScrollTo.idOrName("bloc_famille",encartFamille.offsetHeight-bodyEncartEleve.offsetHeight)}if(vm.isFormResponsableValid(formDossierFamille,!1)||forceSauvegarde){var datasToPost=angular.copy(vm.dossierInscription);angular.forEach(datasToPost.eleves,function(eleve){eleve.enregistrementAlaVolee="1"}),datasToPost.parametrages=void 0,angular.forEach(datasToPost.piecesDossier,function(pieceDossier){pieceDossier.fichiers=void 0,pieceDossier.configInputFile=void 0}),vm.alreadyValidateFormFamille=!0,validate?(datasToPost.etat="valide",vm.promiseContents=DossierInscriptionFamilleService.postDossierInscription(datasToPost,"F").then(function(data){angular.isDefined(data.idInscrUpdated)&&data.idInscrUpdated>0&&0===vm.dossierInscription.idInscriptionResponsable&&(vm.dossierInscription.idInscriptionResponsable=data.idInscrUpdated,datasToPost.idInscriptionResponsable=vm.dossierInscription.idInscriptionResponsable);var modalSignatureDossier=$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/modal-signature-dossier-famille.html",backdrop:!1,controller:"SecureModalSignatureDossierFamille as ctrlSignatureDossierFamille",resolve:{inscriptionFamille:function(){return datasToPost},domElementId:function(){return"bloc_famille"}}});modalSignatureDossier.result.then(function(isSignatureOK){forceSauvegarde||isSignatureOK===!0&&validate&&(vm.dossierInscription.etat="valide",angular.forEach(datasToPost.eleves,function(eleve){var formDossierEleve=vm["formDossierInscriptionEleve_"+eleve.id];eleve.etapeInscription>=vm.CONSTANTES.INSCR_ETAPE1_REMPLIE&&vm.isFormEleveValid(formDossierEleve,eleve,!1)})),forceSauvegarde&&(vm.selectedOnglet="#eleve"),vm.alreadyValidateFormFamille=!1,vm.refresh(vm.dossierInscription,null,!1)})},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0),vm.alreadyValidateFormFamille=!1})):vm.promiseContents=DossierInscriptionFamilleService.postDossierInscription(datasToPost,"F").then(function(data){angular.isDefined(data.idInscrUpdated)&&data.idInscrUpdated>0&&0===vm.dossierInscription.idInscriptionResponsable&&(vm.dossierInscription.idInscriptionResponsable=data.idInscrUpdated),forceSauvegarde||(Notification.notify("Dossier d'inscription","Votre saisie du dossier famille a bien été prise en compte","success",!0),
validate&&(vm.dossierInscription.etat="valide")),forceSauvegarde&&(vm.selectedOnglet="#eleve"),vm.alreadyValidateFormFamille=!1,vm.refresh(vm.dossierInscription,null,!1)},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0),vm.alreadyValidateFormFamille=!1})}}function saveDatasEleve(eleve,withScroll){if(!(eleve.etapeInscription>=vm.CONSTANTES.INSCR_ETAPE3)){withScroll&&vm.scrollToEleve(eleve);var formDossierEleve=vm["formDossierInscriptionEleve_"+eleve.id];if(vm.isFormEleveValid(formDossierEleve,eleve,!1)){var datasToPost=angular.copy(eleve);datasToPost.etapeInscription===vm.CONSTANTES.INSCR_ETAPE1_VIDE&&(datasToPost.optionsFormationsPossiblesParRang=void 0),angular.forEach(datasToPost.piecesDossier,function(pieceDossier){pieceDossier.fichiers=void 0,pieceDossier.configInputFile=void 0}),datasToPost.tabDocsASigner=void 0,datasToPost.tabSignataires=void 0,datasToPost.classeActuelle=void 0,vm.alreadyValidateFormEleve=!0,vm.promiseContents=DossierInscriptionFamilleService.postDossierInscription(datasToPost,Auth.TYPE_USER.ELEVE).then(function(data){angular.isDefined(data.idInscrUpdated)&&data.idInscrUpdated>0&&0===eleve.idInscriptionEleve&&(eleve.idInscriptionEleve=data.idInscrUpdated),""!==eleve.motifSortie.code?Notification.notify("Dossier d'inscription","Nous avons bien enregistré la sortie de "+eleve.prenom,"success","glyphicon glyphicon-list-alt"):Notification.notify("Dossier d'inscription","Votre saisie du dossier élève a bien été prise en compte","success",!0),vm.refresh(null,eleve,!1),vm.alreadyValidateFormEleve=!1},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0),vm.alreadyValidateFormEleve=!1})}}}function setUpdateDossierComplet(dossierInscription,typeContexte,whenStart,notChangeOnglet){var datasToPost=angular.copy(dossierInscription);switch(delete datasToPost.parametrages,vm.datasDossierGlobal=datasToPost,typeContexte){case void 0:vm.saveAllDossier(datasToPost);break;case"paiement":vm.selectedOnglet="#paiement",whenStart||vm.saveAllDossier(datasToPost,"paiement");break;case Auth.TYPE_USER.ELEVE:if(!whenStart){for(var bIsOneFormUpdated=!1,indiceEleve=0,nbEleve=dossierInscription.eleves.length;nbEleve>indiceEleve;indiceEleve++){var eleveCurrent=dossierInscription.eleves[indiceEleve];if(angular.isDefined(vm["formDossierInscriptionEleve_"+eleveCurrent.id])&&!vm["formDossierInscriptionEleve_"+eleveCurrent.id].$pristine){vm.saveAllDossier(datasToPost,Auth.TYPE_USER.ELEVE,!1,notChangeOnglet),bIsOneFormUpdated=!0;break}}bIsOneFormUpdated||(vm.selectedOnglet="#famille")}break;case"F":angular.isDefined(vm.formDossierInscriptionFamille)&&!vm.formDossierInscriptionFamille.$pristine?(delete datasToPost.eleves,vm.saveDatasFamille(datasToPost,!1,!0),vm.formDossierInscriptionFamille.$setPristine()):vm.selectedOnglet="#eleve"}}function saveAllDossier(datasToPost,typeContext,onExit,notChangeOnglet){angular.forEach(datasToPost.piecesDossier,function(pieceDossier){pieceDossier.fichiers=void 0,pieceDossier.configInputFile=void 0});var tabDossiersEleves=lodash.reject(datasToPost.eleves,function(dossierEleve){return dossierEleve.etapeInscription!==vm.CONSTANTES.INSCR_ETAPE2_VIDE});angular.forEach(tabDossiersEleves,function(eleve){eleve.etapeInscription===vm.CONSTANTES.INSCR_ETAPE1_VIDE&&(datasToPost.optionsFormationsPossiblesParRang=void 0),angular.forEach(eleve.piecesDossier,function(pieceDossier){pieceDossier.fichiers=void 0,pieceDossier.configInputFile=void 0}),eleve.enregistrementAlaVolee="1"}),datasToPost.eleves=tabDossiersEleves,vm.promiseContents=DossierInscriptionFamilleService.postDossierInscription(datasToPost,"ALL").then(function(data){typeContext!==Auth.TYPE_USER.ELEVE||notChangeOnglet||(vm.selectedOnglet="#famille"),onExit||vm.refresh(void 0,void 0,void 0,typeContext)},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)})}function showInfosPaiementCheque(){$uibModal.open({templateUrl:"modules/dossierInscriptionFamille/modal-details-paiement-cheque.html",controller:"modalDetailsPaiementCheque as detailsPaiementChequeModal",resolve:{texteAideReglementCheque:function(){return vm.dossierInscription.parametrages.reglement.reglementParChequeAide},montant:function(){return vm.dossierInscription.reglement.acompte+vm.dossierInscription.reglement.fraisDossier},paiementDevise:function(){return vm.paiementDevise}}})}function scrollToEleve(eleve){var encartEleve=angular.element("#eleve_"+eleve.id)[0],bodyEncartEleve=angular.element("#eleve_"+eleve.id+" .form-insreins-body")[0],hauteurToScroll=encartEleve.offsetHeight-bodyEncartEleve.offsetHeight;angular.isDefined(encartEleve)&&hauteurToScroll>0&&ScrollTo.idOrName("eleve_"+eleve.id,encartEleve.offsetHeight-bodyEncartEleve.offsetHeight)}function onCompleteUpload(pieceDossier,context){pieceDossier.unc=pieceDossier.fichiers[0].data.unc,pieceDossier.fichiers.length=0,context.type===Auth.TYPE_USER.ELEVE&&vm["formDossierInscriptionEleve_"+context.id].$setDirty(),"F"===context.type&&vm.formDossierInscriptionFamille.$setDirty()}function onRemovedFileUploaded(pieceDossier){pieceDossier.unc=""}function additionalDataTelechargement(typeUser,idUser,libellePieceDossier){return{data:JSON.stringify({typeUserInscr:typeUser,idUserInscr:idUser,libelleDocument:libellePieceDossier})}}function deletePieceDossier(idInscription,typeInscription,pieceDossier){0>=idInscription&&""===typeInscription?pieceDossier.unc="":vm.promiseContents=DossierInscriptionFamilleService.deletePieceDossier(idInscription,typeInscription,pieceDossier.code).then(function(data){pieceDossier.uid="",Notification.notify("Dossier d'inscription","Le fichier a bien été supprimé","success",!0)},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue lors de la suppression du fichier","error",!0)})}function payerEnLigne(){if(0!==vm.dossierInscription.reglement.acompte||0!==vm.dossierInscription.reglement.fraisDossier){var idPaiement,typePaiement,libelle,panier=[],totalPanier=0;vm.dossierInscription.eleves.forEach(function(eleve){eleve.inscriptionEtabActive&&(eleve.reg1.aPayer>0&&(typePaiement="INSREG1",idPaiement=typePaiement+"_"+vm.idCurrentUser+"_"+eleve.id,libelle=eleve.reg1.libelle+" "+eleve.prenom+" "+eleve.nom+" "+vm.anneeScolaireInscription,panier.push({uid:$scope.guid(),id:idPaiement,idEleve:eleve.id,idFiliere:eleve.filiere.id,libelle:libelle,libellePanier:libelle,montant:eleve.reg1.aPayer,montantModifiable:!1,quantiteModifiable:!1,typePaiement:typePaiement,quantite:1}),totalPanier+=eleve.reg1.aPayer),eleve.reg2.aPayer>0&&(typePaiement="INSREG2",idPaiement=typePaiement+"_"+vm.idCurrentUser+"_"+eleve.id,libelle=eleve.reg2.libelle+" "+eleve.prenom+" "+eleve.nom+" "+vm.anneeScolaireInscription,panier.push({uid:$scope.guid(),id:idPaiement,idEleve:eleve.id,idFiliere:eleve.filiere.id,libelle:libelle,libellePanier:libelle,montant:eleve.reg2.aPayer,montantModifiable:!1,quantiteModifiable:!1,typePaiement:typePaiement,quantite:1}),totalPanier+=eleve.reg2.aPayer),eleve.reg3.aPayer>0&&(typePaiement="INSREG3",idPaiement=typePaiement+"_"+vm.idCurrentUser+"_"+eleve.id,libelle=eleve.reg3.libelle+" "+eleve.prenom+" "+eleve.nom+" "+vm.anneeScolaireInscription,panier.push({uid:$scope.guid(),id:idPaiement,idEleve:eleve.id,idFiliere:eleve.filiere.id,libelle:libelle,libellePanier:libelle,montant:eleve.reg3.aPayer,montantModifiable:!1,quantiteModifiable:!1,typePaiement:typePaiement,quantite:1}),totalPanier+=eleve.reg3.aPayer))});var commande={};commande.mail=Auth.currentUser().email,commande.montant=totalPanier,commande.panier=panier,DossierInscriptionFamilleService.payerEnLigne(commande).then(function(retour){window.location.href=retour.urlSecure},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)})}}function showAlertPaiementObligatoire(){Notification.notify("Dossier d'inscription","Vous devez vous acquitter des règlements pour pouvoir valider l'inscription","error",!0)}function showAlertSignatureObligatoire(){Notification.notify("Dossier d'inscription","Vous devez signer les documents de l'établissement pour pouvoir valider l'inscription","error",!0)}function isInscriptionDisponibleEleve(eleve){return 0===vm.tabParametrageFilieres.length?!1:eleve.etapeInscription>=vm.CONSTANTES.INSCR_ETAPE2_VIDE?eleve.inscriptionEtabActive:vm.tabFilieresEtape1.length>1}function isDisplayEtape1(eleve){return vm.isInscriptionDisponibleEleve(eleve)&&""===eleve.dateSortie&&eleve.etapeInscription===vm.CONSTANTES.INSCR_ETAPE1_VIDE}function isDisplayEtape2(eleve){return vm.isInscriptionDisponibleEleve(eleve)&&""===eleve.dateSortie&&eleve.etapeInscription===vm.CONSTANTES.INSCR_ETAPE2_VIDE}function isDisplayEtape3(eleve){return vm.isInscriptionDisponibleEleve(eleve)&&eleve.etapeInscription===vm.CONSTANTES.INSCR_ETAPE3}function isDisplayEtape3Terminee(eleve){return vm.isInscriptionDisponibleEleve(eleve)&&eleve.etapeInscription>=vm.CONSTANTES.INSCR_ETAPE3_VALIDE}function isOneEleveWithEtapeOuverte(){if(!angular.isUndefined(vm.dossierInscription)&&null!==vm.dossierInscription){var tabElevesDossierOuvert=lodash.where(vm.dossierInscription.eleves,{inscriptionEtabActive:!0});return tabElevesDossierOuvert.length>0}}function isOneEleveWithEtapeAFaire(){if(angular.isUndefined(vm.dossierInscription)||null===vm.dossierInscription)return!1;var tabElevesDossierOuvert=lodash.where(vm.dossierInscription.eleves,{inscriptionEtabActive:!0,etapeInscription:"2.0"});return tabElevesDossierOuvert.length>0}function isThereOnlyEleveIn10(){if(!angular.isUndefined(vm.dossierInscription)&&null!==vm.dossierInscription){var isTheOnly=!0;return angular.forEach(vm.dossierInscription.eleves,function(eleve){eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_VIDE&&eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_REMPLIE&&(isTheOnly=!1)}),isTheOnly}}function getNbSignaturesManquantes(){var nbEleves=vm.dossierInscription.eleves.filter(function(eleve){return eleve.etapeInscription===DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE}).length;return nbEleves+1-vm.dossierInscription.signaturesDocsLus.length}function isResponsableSignatureOK(){if(0===vm.dossierInscription.documentsEtablissement.length)return!0;for(var i=0;i<vm.dossierInscription.documentsEtablissement.length;i++)if(0===vm.dossierInscription.signaturesDocsLus.filter(function(signature){return signature.idDocument===vm.dossierInscription.documentsEtablissement[i].id&&signature.idSignataire===vm.idCurrentUser}).length)return!1;return!0}function isEleveSignatureOK(eleve){if(eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE||0===eleve.tabDocsASigner.length)return!0;for(var i=0;i<eleve.tabDocsASigner.length;i++)if(angular.isUndefined(lodash.find(vm.dossierInscription.signaturesDocsLus,{idSignataire:vm.idCurrentUser,typeSignataire:vm.typeCurrentUser,idDocument:eleve.tabDocsASigner[i].id}))||angular.isUndefined(lodash.find(vm.dossierInscription.signaturesDocsLus,{idSignataire:eleve.id,typeSignataire:Auth.TYPE_USER.ELEVE,idDocument:eleve.tabDocsASigner[i].id})))return!1;return!0}function isRegimeOK(eleve){return eleve.regimeScolaire>0||!vm.isRegimesFiliereActif(eleve.filiere)}function isClasseOK(eleve){return eleve.filiere.id>0}function isFormationOK(eleve){return eleve.formation.idFiliere>0}function isElevePiecesDossierOK(eleve){if(eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE)return!0;var tabPiecesDossier=eleve.piecesDossier;return 0===tabPiecesDossier.length?!0:0===tabPiecesDossier.filter(function(pieceDossier){return pieceDossier.isObligatoire&&(angular.isUndefined(pieceDossier.unc)||""===pieceDossier.unc)&&(angular.isUndefined(pieceDossier.uid)||""===pieceDossier.uid)}).length}function isResponsablePiecesDossierOK(){return 0===vm.dossierInscription.piecesDossier.length?!0:0===vm.dossierInscription.piecesDossier.filter(function(pieceDossier){return"Mandat"===pieceDossier.type&&(pieceDossier.isObligatoire="Prélèvement"===vm.dossierInscription.facturation.modeReglement&&vm.dossierInscription.isPayeur),pieceDossier.isObligatoire&&(angular.isUndefined(pieceDossier.unc)||""===pieceDossier.unc)&&(angular.isUndefined(pieceDossier.uid)||""===pieceDossier.uid)}).length}function getUrlPieceDossier(pieceDossier){var url="";return angular.isDefined(pieceDossier.unc)&&""!==pieceDossier.unc?url=pieceDossier.unc:angular.isDefined(pieceDossier.uid)&&""!==pieceDossier.uid&&(url=pieceDossier.uid),url}function isFormResponsableValid(formDossierFamille,isNotify){vm.formMsgError=[],isNotify=angular.isDefined(isNotify)?isNotify:!1;try{if("Prélèvement"!==vm.dossierInscription.facturation.modeReglement||vm.isValidIBAN(vm.dossierInscription.facturation.IBAN)||vm.formMsgError.push("Vous devez saisir un IBAN valide"),vm.isResponsablePiecesDossierOK()||vm.formMsgError.push("Vous devez fournir les pièces obligatoires du dossier famille"),vm.isResponsableSignatureOK()||vm.formMsgError.push("Il manque des signatures"),vm.isInfosCompObligatoiresOK(vm.dossierInscription.informationsComplementaires)||vm.formMsgError.push("Veuillez renseigner les informations complémentaires obligatoires"),vm.isQuotientObligatoireOK(vm.dossierInscription.facturation.quotients)||vm.formMsgError.push("Veuillez renseigner les quotients obligatoires"),vm.formMsgError.length>0)throw new Error(vm.formMsgError);if(formDossierFamille.$invalid)return}catch(error){return isNotify===!0&&Notification.notify("Dossier d'inscription",vm.formMsgError.join(" - "),"error",!0),!1}return!0}function isFormEleveValid(formDossierEleve,eleve,isNotify){vm.formMsgErrorEleve={},vm.formMsgErrorEleve[eleve.id]=[],isNotify=angular.isDefined(isNotify)?isNotify:!0;var isDemandeSortie=!(eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_VIDE&&eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE||""===eleve.motifSortie.code&&""===eleve.motifSortieLibre);if(isDemandeSortie)return!0;if(eleve.etapeInscription===DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_VIDE)try{if(vm.isClasseOK(eleve)?vm.isFormationOK(eleve)||vm.formMsgErrorEleve[eleve.id].push("Vous devez renseigner la formation"):vm.formMsgErrorEleve[eleve.id].push("Vous devez renseigner la classe"),vm.formMsgErrorEleve[eleve.id].length>0)throw new Error(vm.formMsgErrorEtape1);if(formDossierEleve.$invalid)return}catch(error){return isNotify&&Notification.notify("Dossier d'inscription",vm.formMsgErrorEleve[eleve.id].join(" - "),"error",!0),!1}if(eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE)return!0;try{if("valide"!==vm.dossierInscription.etat&&vm.formMsgErrorEleve[eleve.id].push("Vous devez valider le dossier famille au préalable"),vm.isRegimeOK(eleve)||vm.formMsgErrorEleve[eleve.id].push("Vous devez renseigner le régime scolaire"),vm.isResponsablePiecesDossierOK()||vm.formMsgErrorEleve[eleve.id].push("Vous devez fournir les pièces obligatoires du dossier famille"),vm.isElevePiecesDossierOK(eleve)||vm.formMsgErrorEleve[eleve.id].push("Vous devez fournir les pièces obligatoires du dossier élève"),vm.isEleveSignatureOK(eleve)||vm.formMsgErrorEleve[eleve.id].push("Il manque des signatures "),vm.isInfosCompObligatoiresOK(eleve.informationsComplementaires)||vm.formMsgErrorEleve[eleve.id].push("Veuillez renseigner les informations complémentaires obligatoires"),vm.isQuotientObligatoireOK(eleve.quotients,eleve)||vm.formMsgErrorEleve[eleve.id].push("Veuillez renseigner les quotients obligatoires"),vm.formMsgErrorEleve[eleve.id].length>0)throw new Error(vm.formMsgError)}catch(error){return isNotify&&Notification.notify("Dossier d'inscription",vm.formMsgErrorEleve[eleve.id].join(" - "),"error",!0),!1}return!0}function onModeReglementChange(){"Prélèvement"!==vm.dossierInscription.facturation.modeReglement||!angular.isUndefined(vm.dossierInscription.facturation.titulaireCompte)&&""!==vm.dossierInscription.facturation.titulaireCompte||(vm.dossierInscription.facturation.titulaireCompte=vm.nomUser)}function getListeDocsASignerEleve(eleve){var tabDocs=[];if(eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE&&eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_REMPLIE&&eleve.etapeInscription!==DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE3_VALIDE||0===eleve.filiere.id)return tabDocs;var parametrageFiliere=lodash.find(vm.dossierInscription.parametrages.filieres,{id:eleve.filiere.id});return angular.isUndefined(parametrageFiliere)?tabDocs:parametrageFiliere.documentsEtablissement}function getListeSignatairesDossier(eleve){var tabSignataires=[],tabDocsASigner=[];if(tabDocsASigner=angular.isDefined(eleve)?eleve.tabDocsASigner:vm.dossierInscription.documentsEtablissement,0===tabDocsASigner.length)return tabSignataires;if(angular.isDefined(eleve)){var listeSignaturesEleves=vm.dossierInscription.signaturesDocsLus.filter(function(signature){return signature.idSignataire===eleve.id&&signature.typeSignataire===Auth.TYPE_USER.ELEVE}),signataire={};signataire.nomSignataire=eleve.prenom+" "+eleve.nom,signataire.dateSignature="",listeSignaturesEleves.length>=tabDocsASigner.length&&(signataire.dateSignature=listeSignaturesEleves[0].date),tabSignataires.push(signataire)}return signataire={},signataire.nomSignataire=vm.nomUser,signataire.dateSignature="",DossierInscriptionFamilleService.isSignaturesSignataireOK(vm.idCurrentUser,vm.typeCurrentUser,tabDocsASigner,vm.dossierInscription.signaturesDocsLus)&&(signataire.dateSignature=lodash.find(vm.dossierInscription.signaturesDocsLus,{idSignataire:vm.idCurrentUser,typeSignataire:vm.typeCurrentUser}).date),tabSignataires.push(signataire),tabSignataires}function getParametrageFiliere(idFiliere){var parametrage=lodash.find(vm.tabParametrageFilieres,{id:idFiliere});return angular.isDefined(parametrage)?parametrage:{}}function getActivites(eleve,activiteRepas){var idFiliere=eleve.filiere.id,tabActivites=[];if(activiteRepas){var regimeEleve=lodash.find(vm.dossierInscription.parametrages.regimesScolaire,{id:eleve.regimeScolaire});tabActivites=lodash.filter(getParametrageFiliere(idFiliere).activites,function(activite){var shouldDisplay="Repas"===activite.type&&activite.joursActifs.length>0,shouldDisplayByParamRegime=!0;return angular.isDefined(regimeEleve)&&("MIDI"===activite.code&&(shouldDisplayByParamRegime="Midi"===regimeEleve.type||"Soir-Matin"===regimeEleve.type),"SOIR"===activite.code&&(shouldDisplayByParamRegime="Soir-Matin"===regimeEleve.type)),shouldDisplay&&shouldDisplayByParamRegime})}else tabActivites=lodash.reject(getParametrageFiliere(idFiliere).activites,function(activite){return"Repas"===activite.type||activite.joursActifs.length<=0});return tabActivites}function isActiviteOuverte(tabActivites,codeActivite){var activiteFound=lodash.find(tabActivites,{code:codeActivite});return angular.isDefined(activiteFound)?activiteFound.joursActifs.length>0:!1}function hasElements(elements){return Object.keys(elements).length>0}function optionsInternesSeleted(tabOptionsInterne){var tabOptionsInternesSelected=lodash.reject(tabOptionsInterne,{isSelectionnee:!1});return angular.isDefined(tabOptionsInternesSelected)?tabOptionsInternesSelected:[]}function getLibelleRegimeScolaireEtab(idRegime){var regimeFound=lodash.find(vm.tabRegimesScolaire,{id:idRegime});return angular.isDefined(regimeFound)?regimeFound.libelle:""}function getLibelleInfoCompNombre(infoComp){var optionSelected=lodash.find(infoComp.options,{valeur:infoComp.valeur}),libelleFinal=infoComp.valeur;return angular.isDefined(optionSelected)&&(libelleFinal=""===optionSelected.libelle?infoComp.valeur:optionSelected.libelle),libelleFinal}function isInfosCompObligatoiresOK(arrayElements){var isOK=!0;return angular.forEach(arrayElements,function(element){element.obligatoire&&isOK&&(isOK=element.obligatoire&&""!==element.valeur),"Date"===element.type&&!element.dateFormated&&isOK&&""!==element.valeur&&(isOK=!1),"Heure"===element.type&&!element.heureFormated&&isOK&&(isOK=!1)}),isOK}function isQuotientObligatoireOK(arrayElements,eleve){var isOK=!0;return angular.forEach(arrayElements,function(element){var parametrageQuotientEtab=void 0;parametrageQuotientEtab=eleve?lodash.find(vm.listQuotientsEleve(eleve),{type:element.type}):lodash.find(vm.tabQuotientsFamille,{type:element.type}),angular.isDefined(parametrageQuotientEtab)&&parametrageQuotientEtab.obligatoire&&isOK&&(isOK=parametrageQuotientEtab.obligatoire&&" "!==element.libelle)}),isOK}function onChangeObservationPayeur(observation,nbMaxCaract){if(angular.isDefined(observation)){var limitReached=observation.length>nbMaxCaract;limitReached?vm.formDisabled=!0:vm.formDisabled=!1}}function isJourEchanceDisponible(jourEcheance){return angular.isUndefined(vm.dossierInscription.parametrages.paramsJourEcheance)||vm.dossierInscription.parametrages.paramsJourEcheance.jours.indexOf(jourEcheance)>-1}function isOneEleveWithReglement(idReglement){var bIsOneEleve=!1;return angular.forEach(vm.dossierInscription.eleves,function(eleve){eleve["reg"+idReglement].montant>0&&(bIsOneEleve=!0)}),bIsOneEleve}var vm=this;vm.CONSTANTES=DossierInscriptionFamilleService.CONSTANTES,vm.saveDatasFamille=saveDatasFamille,vm.saveDatasEleve=saveDatasEleve,vm.saveAllDossier=saveAllDossier,vm.setUpdateDossierComplet=setUpdateDossierComplet,vm.showInfosPaiementCheque=showInfosPaiementCheque,vm.refresh=refresh,vm.isValidIBAN=isValidIBAN,vm.dateFormate=dateFormate,vm.dateHeureFormate=dateHeureFormate,vm.isActiviteEleve=isActiviteEleve,vm.selectActiviteEleve=selectActiviteEleve,vm.confirmationLecture=confirmationLecture,vm.signerDossier=signerDossier,vm.scrollToEleve=scrollToEleve,vm.sortirEleve=sortirEleve,vm.inscrireEleve=inscrireEleve,vm.annulerSaisie=annulerSaisie,vm.updateTotalPourcentagePayeurs=updateTotalPourcentagePayeurs,vm.onSelectFiliereEleve=onSelectFiliereEleve,vm.onSelectFormationEleve=onSelectFormationEleve,vm.onSelectOptionFormationEleve=onSelectOptionFormationEleve,vm.onSelectRegimeScolaireEleve=onSelectRegimeScolaireEleve,vm.listFormationsEleve=listFormationsEleve,vm.removeLastOptionFormationEleve=removeLastOptionFormationEleve,vm.isOptionFormationDisabled=isOptionFormationDisabled,vm.calculerAcompteFraisDossier=calculerAcompteFraisDossier,vm.calculerAcompteFraisDossierEleve=calculerAcompteFraisDossierEleve,vm.listQuotientsEleve=listQuotientsEleve,vm.getLibelleQuotientEtab=getLibelleQuotientEtab,vm.isJourActifPourActivite=isJourActifPourActivite,vm.isRegimesFiliereActif=isRegimesFiliereActif,vm.onCompleteUpload=onCompleteUpload,vm.onRemovedFileUploaded=onRemovedFileUploaded,vm.additionalDataTelechargement=additionalDataTelechargement,vm.deletePieceDossier=deletePieceDossier,vm.payerEnLigne=payerEnLigne,vm.showAlertPaiementObligatoire=showAlertPaiementObligatoire,vm.showAlertSignatureObligatoire=showAlertSignatureObligatoire,vm.isInscriptionDisponibleEleve=isInscriptionDisponibleEleve,vm.getLibelleEtapeInscription=getLibelleEtapeInscription,vm.enAttenteDeSynchro=enAttenteDeSynchro,vm.isDisplayEtape1=isDisplayEtape1,vm.isDisplayEtape2=isDisplayEtape2,vm.isDisplayEtape3=isDisplayEtape3,vm.isDisplayEtape3Terminee=isDisplayEtape3Terminee,vm.getNbSignaturesManquantes=getNbSignaturesManquantes,vm.isEleveSignatureOK=isEleveSignatureOK,vm.isElevePiecesDossierOK=isElevePiecesDossierOK,vm.isResponsablePiecesDossierOK=isResponsablePiecesDossierOK,vm.getUrlPieceDossier=getUrlPieceDossier,vm.isFormEleveValid=isFormEleveValid,vm.isFormResponsableValid=isFormResponsableValid,vm.isResponsableSignatureOK=isResponsableSignatureOK,vm.onModeReglementChange=onModeReglementChange,vm.getListeDocsASignerEleve=getListeDocsASignerEleve,vm.getListeSignatairesDossier=getListeSignatairesDossier,vm.getParametrageFiliere=getParametrageFiliere,vm.isRegimeOK=isRegimeOK,vm.isClasseOK=isClasseOK,vm.isFormationOK=isFormationOK,vm.getActivites=getActivites,vm.hasElements=hasElements,vm.optionsInternesSeleted=optionsInternesSeleted,vm.getLibelleRegimeScolaireEtab=getLibelleRegimeScolaireEtab,vm.getLibelleInfoCompNombre=getLibelleInfoCompNombre,vm.isInfosCompObligatoiresOK=isInfosCompObligatoiresOK,vm.isQuotientObligatoireOK=isQuotientObligatoireOK,vm.onChangeObservationPayeur=onChangeObservationPayeur,vm.isJourEchanceDisponible=isJourEchanceDisponible,vm.isActiviteOuverte=isActiviteOuverte,vm.isOneEleveWithEtapeOuverte=isOneEleveWithEtapeOuverte,vm.isOneEleveWithEtapeAFaire=isOneEleveWithEtapeAFaire,vm.isThereOnlyEleveIn10=isThereOnlyEleveIn10,vm.isOneEleveWithReglement=isOneEleveWithReglement,vm.openModaleUpdateScolarite=openModaleUpdateScolarite,vm.paiementDevise=ModuleService.getModule(ModuleService.CODES.PAIEMENT_EN_LIGNE).params.devise||"€",vm.dossierInscription=null,vm.selectedOnglet="#famille",vm.alreadyValidateFormEleve=!1,vm.alreadyValidateFormFamille=!1,vm.listOfDays=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],vm.editTitulaireCompte=!1,vm.objAucuneFiliere={id:0,libelle:" "},vm.objAucuneFormation={codeMEF:"",codeMatiereInterne:"",codeSpecialite:"",idFiliere:0,isPremierDegre:!1,libelle:" "},vm.files=[],vm.tabQuotientsFamille=[],vm.tabParametrageFilieres=[],vm.tabRegimesScolaire=[],vm.tabDatesOuverturesEtablissements=[],vm.tabDocumentsEtablissement=[],vm.tabSignatures=[],vm.tabFilieres=[],vm.tabFilieresEtape1=[],vm.tabFormations=[],vm.nomUser=Auth.currentUser().prenom+(""!==Auth.currentUser().particule?" "+Auth.currentUser().particule:"")+" "+Auth.currentUser().nom,vm.idCurrentUser=Auth.currentUser().id,vm.typeCurrentUser=Auth.currentUser().typeCompte,vm.anneeScolaireInscription="",vm.formMsgError=[],vm.formMsgErrorEleve={},vm.configInputFile={keepComplete:!0,mode:"INSCR",libelleTitre:""},vm.configInputFile.fromCloudEnabled=!1,vm.processingFiles=0,vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=INSCR",vm.formDisabled=!1,vm.acceptedFiles="application/pdf,image/jpeg,image/png",vm.dropzoneConfig={url:vm.urlTeleversement,params:{},maxFiles:1,acceptedFiles:vm.acceptedFiles,previewsContainer:!1,dictResponseError:"Une erreur s'est produite",dictInvalidFileType:"Vous ne pouvez envoyer que des fichiers ayant l'extension <strong>.png</strong>, <strong>.jpeg</strong> et <strong>.pdf</strong>"},refresh().then(function(){$location.url().indexOf("retourPaiement")>-1&&("200"===$routeParams.code?Notification.notify("Dossier d'inscription","Votre règlement a bien été prise en compte","success",!0):(vm.selectedOnglet="#paiement",Notification.notify("Dossier d'inscription","Une erreur est survenue lors de votre règlement","error",!0))),vm.isThereOnlyEleveIn10()&&(vm.selectedOnglet="#eleve");var anchor=$location.hash(),isEleve=anchor&&anchor.startsWith("eleve_");("#famille"===vm.selectedOnglet&&"valide"===vm.dossierInscription.etat||isEleve)&&(vm.selectedOnglet="#eleve",isEleve&&$timeout(function(){var encartEleve=angular.element("#"+anchor)[0],bodyEncartEleve=angular.element("#"+anchor+" .form-insreins-body")[0];if(angular.isDefined(encartEleve)&&angular.isDefined(bodyEncartEleve)){var hauteurToScroll=encartEleve.offsetHeight-bodyEncartEleve.offsetHeight;hauteurToScroll>0&&ScrollTo.idOrName(anchor,encartEleve.offsetHeight-bodyEncartEleve.offsetHeight)}},500))}),$scope.$on("$destroy",function(){$location.path().indexOf("/logout")>=0||vm.setUpdateDossierComplet(vm.dossierInscription)})}]),angular.module("edsiteApp.DossierInscriptionFamille").service("DossierInscriptionFamilleService",["$q","$http","EDHttp","lodash",function($q,$http,EDHttp,lodash){var mDossierInscriptionFamilleService={};return mDossierInscriptionFamilleService.CONSTANTES={INSCR_ETAPE1_VIDE:"1.0",INSCR_ETAPE1_REMPLIE:"1.1",INSCR_ETAPE2_VIDE:"2.0",INSCR_ETAPE2_REMPLIE:"2.1",INSCR_ETAPE3:"3.0",INSCR_ETAPE3_VALIDE:"3.1"},mDossierInscriptionFamilleService.isSignaturesSignataireOK=function(idSignataire,typeSignataire,tabDocuments,tabSignatures){for(var i=0;i<tabDocuments.length;i++)if(0===tabSignatures.filter(function(signature){return signature.idDocument===tabDocuments[i].id&&signature.idSignataire===idSignataire&&signature.typeSignataire===typeSignataire}).length)return!1;return!0},mDossierInscriptionFamilleService.getLibelleEtapeInscription=function(inscription){switch(inscription.etapeInscription){case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_VIDE:return"Vous devez effectuer le choix de la scolarité";case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE1_REMPLIE:return"En attente de traitement par l'établissement";case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE:return"Dossier d'inscription à compléter";case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_REMPLIE:return inscription.isReglementOK?"En attente de traitement par l'établissement":"Inscription en attente de votre paiement";case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE3:return inscription.prenom+" n'est pas ré-inscrit"+("F"===inscription.sexe?"e":"");case mDossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE3_VALIDE:return"Dossier terminé et validé par l'établissement";default:return""}},mDossierInscriptionFamilleService.cleanTabOptionsFormationPossibles=function(tabOptionsFormationPossible,eleve){if(0!==eleve.optionsFormation.length){var partieUnCode,partieFinCode,compteurLV1=0;eleve.optionsFormation.forEach(function(option){angular.isDefined(option.codeMatiereInterne)&&(partieUnCode=option.codeMatiereInterne.substr(0,2),partieFinCode=option.codeMatiereInterne.substr(5,1)),"03"===partieUnCode&&"1"===partieFinCode&&compteurLV1++});var partieUnCodeFormation,partieDeuxCodeFormation,partieFinCodeFormation,isOptionShouldBeRemove,i=0;for(i;i<tabOptionsFormationPossible.length;i++){angular.isDefined(tabOptionsFormationPossible[i].codeMatiereInterne)&&(partieUnCodeFormation=tabOptionsFormationPossible[i].codeMatiereInterne.substr(0,2),partieDeuxCodeFormation=tabOptionsFormationPossible[i].codeMatiereInterne.substr(0,5),partieFinCodeFormation=tabOptionsFormationPossible[i].codeMatiereInterne.substr(5,1));for(var indiceOptionAlreadySelected=0;indiceOptionAlreadySelected<eleve.optionsFormation.length;indiceOptionAlreadySelected++){if(isOptionShouldBeRemove=!1,!eleve.formation.isPremierDegre){var lbRenforce=tabOptionsFormationPossible[i].langueRenforcee,isOptionDisponible=mDossierInscriptionFamilleService.checkOptionDisponible(eleve.optionsFormation,indiceOptionAlreadySelected,partieUnCodeFormation,partieDeuxCodeFormation,partieFinCodeFormation,compteurLV1,lbRenforce),isOptionLV9Binationale=mDossierInscriptionFamilleService.checkLV9MEFBinationale(tabOptionsFormationPossible[i],eleve.formation);isOptionDisponible||isOptionLV9Binationale||(isOptionShouldBeRemove=!0)}if(tabOptionsFormationPossible[i].codeMatiereInterne===eleve.optionsFormation[indiceOptionAlreadySelected].codeMatiereInterne&&(isOptionShouldBeRemove=!0),isOptionShouldBeRemove){tabOptionsFormationPossible.splice(i,1),--i;break}}}}},mDossierInscriptionFamilleService.checkOptionDisponible=function(tabOptsAlreadySelected,indiceOptAlreadySelected,partieUnCodeFormation,partieDeuxCodeFormation,partieFinCodeFormation,compteurLV1,isLangueRenforcee){var partieUnCodeAlreadySelected=tabOptsAlreadySelected[indiceOptAlreadySelected].codeMatiereInterne.substr(0,2),partieDeuxCodeAlreadySelected=tabOptsAlreadySelected[indiceOptAlreadySelected].codeMatiereInterne.substr(0,5),partieFinCodeAlreadySelected=tabOptsAlreadySelected[indiceOptAlreadySelected].codeMatiereInterne.substr(5,1),IsDispo=!0;return partieDeuxCodeFormation===partieDeuxCodeAlreadySelected&&"4"!==partieFinCodeFormation&&"9"!==partieFinCodeFormation&&(IsDispo=!1),"03"===partieUnCodeFormation&&"1"===partieFinCodeFormation&&compteurLV1>1&&(IsDispo=!1),"03"===partieUnCodeAlreadySelected&&"03"===partieUnCodeFormation&&partieFinCodeAlreadySelected===partieFinCodeFormation&&"1"!==partieFinCodeAlreadySelected&&(IsDispo=!1),"2"===partieUnCodeFormation&&"4"===partieFinCodeFormation&&("N"===isLangueRenforcee&&"03"===partieDeuxCodeAlreadySelected&&"1"===partieFinCodeAlreadySelected&&partieDeuxCodeFormation!==partieDeuxCodeAlreadySelected&&(IsDispo=!1),
"O"===isLangueRenforcee&&partieDeuxCodeFormation===partieDeuxCodeAlreadySelected&&"1"!==partieFinCodeAlreadySelected&&"2"!==partieFinCodeAlreadySelected&&"3"!==partieFinCodeAlreadySelected&&(IsDispo=!1)),IsDispo},mDossierInscriptionFamilleService.checkLV9MEFBinationale=function(optionFormation,formation){var isValid=!1,indiceLangue=0,tabLVMEFBiNationale=["0301","0306","0309"];return"B"!==formation.codeMatiereInterne.substr(11,1)&&(isValid=!0),"03"!==optionFormation.codeMatiereInterne.substr(0,2)&&(isValid=!0),"9"!==optionFormation.codeMatiereInterne.substr(6,1)&&(isValid=!0),indiceLangue=tabLVMEFBiNationale.indexOf(optionFormation.codeMatiereInterne.substr(0,4)),indiceLangue>-1&&(isValid=!0),isValid},mDossierInscriptionFamilleService.getDossierInscription=function(isResumeEtats){var defer=$q.defer(),data={isResumeEtats:isResumeEtats?1:0},baseUrl="inscriptions/familleDossierInscription";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.getOptionsFormation=function(codeFormation,codeOgec,rangOption,codeSpecialite){var defer=$q.defer(),baseUrl=codeFormation+"/options",data={rangOption:rangOption,codeOgec:codeOgec,specialite:codeSpecialite};return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.postDossierInscription=function(dossierInscription,typeDonnes){var defer=$q.defer(),data={dossierInscription:dossierInscription,typeDonnes:typeDonnes},baseUrl="inscriptions/familleDossierInscription";return new EDHttp({method:"POST",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.deletePieceDossier=function(idInscription,typeInscription,idPieceDossier){var defer=$q.defer(),baseUrl="inscriptions/familleDossierInscription/"+typeInscription+"/"+idInscription+"/fichier/"+idPieceDossier;return new EDHttp({method:"DELETE",url:baseUrl,data:{},cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.signerDocuments=function(tabDocumentsASigner,idUser,typeUser,telephone,signature){var defer=$q.defer(),data={tabIdDocuments:lodash.pluck(tabDocumentsASigner,"id"),idUtilisateur:idUser,typeUtilisateur:typeUser,telephone:telephone,codeSecure:signature.codeSecure},baseUrl="inscriptions/familleDossierInscription";return new EDHttp({method:"PUT",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.signerDossier=function(idInscription,idUser,typeUser,telephone,config3DSecure,canvas){var defer=$q.defer(),data={idInscriptionEleve:idInscription,idUtilisateur:idUser,typeUtilisateur:typeUser,telephone:telephone,codeSecure:config3DSecure.codeSecure,canvas:canvas},baseUrl="inscriptions/familleDossierInscription";return new EDHttp({method:"PUT",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.signerDossierFamille=function(idInscription,idUser,typeUser,telephone,config3DSecure,canvas){var defer=$q.defer(),data={idInscriptionResponsable:idInscription,idUtilisateur:idUser,typeUtilisateur:typeUser,telephone:telephone,codeSecure:config3DSecure.codeSecure,canvas:canvas},baseUrl="inscriptions/familleDossierInscription";return new EDHttp({method:"PUT2",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService.payerEnLigne=function(commande){var defer=$q.defer(),data=commande,baseUrl="inscriptions/familleDossierInscription/paiement";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDossierInscriptionFamilleService}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("modalSecureConfirmLectureDoc",["$uibModalInstance","Notification","Auth","datasDossierInscription","lodash","DossierInscriptionFamilleService","listeDocumentsASigner","inscriptionEleve",function($uibModalInstance,Notification,Auth,datasDossierInscription,lodash,DossierInscriptionFamilleService,listeDocumentsASigner,inscriptionEleve){function close(isConfirmationValidee){$uibModalInstance.close(angular.isDefined(isConfirmationValidee)?isConfirmationValidee:!1)}function validerConfirmationLecture(){vm.promise3DSecure=DossierInscriptionFamilleService.signerDocuments(vm.tabDocumentsASigner,vm.signataireSelected.id,vm.signataireSelected.type,vm.signataireSelected.tel,vm.config3DSecure).then(function(){Notification.notify("Dossier d'inscription","Votre confirmation de lecture a bien été prise en compte !","success","glyphicon glyphicon-list-alt"),vm.tabSignatures.push({idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telSignataire:vm.signataireSelected.tel,date:moment().format("YYYY-MM-DD HH:mm:ss"),nomSignataire:vm.signataireSelected.nom}),vm.close(!0)},function(){Notification.notify("Dossier d'inscription","L'enregistrement a échoué.","error","glyphicon glyphicon-list-alt")})}function onSignataireChanged(){vm.config3DSecure.signataire={idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telephone:vm.signataireSelected.tel,particule:vm.signataireSelected.particule,civilite:vm.signataireSelected.civilite,nom:vm.signataireSelected.nom,ogec:"073STATI"}}function refresh(){var tabSignataires=[],utilisateurFamille=Auth.currentUser();DossierInscriptionFamilleService.isSignaturesSignataireOK(utilisateurFamille.id,utilisateurFamille.typeCompte,vm.tabDocumentsASigner,vm.dossierInscription.signaturesDocsLus)||tabSignataires.push({id:utilisateurFamille.id,nom:utilisateurFamille.prenom+" "+utilisateurFamille.nom,tel:utilisateurFamille.profile.telPortable,type:utilisateurFamille.typeCompte,particule:utilisateurFamille.particule,civilite:utilisateurFamille.civilite}),angular.isDefined(vm.inscriptionEleve)&&inscriptionEleve.etapeInscription===DossierInscriptionFamilleService.CONSTANTES.INSCR_ETAPE2_VIDE&&!DossierInscriptionFamilleService.isSignaturesSignataireOK(inscriptionEleve.id,Auth.TYPE_USER.ELEVE,vm.tabDocumentsASigner,vm.dossierInscription.signaturesDocsLus)&&tabSignataires.push({id:vm.inscriptionEleve.id,nom:vm.inscriptionEleve.prenom+" "+vm.inscriptionEleve.nom,tel:vm.inscriptionEleve.telephone,type:"E",particule:vm.inscriptionEleve.particule,civilite:""}),vm.tabSignatairesDispo=tabSignataires,vm.tabSignatairesDispo.length>0&&(vm.signataireSelected=vm.tabSignatairesDispo[0],vm.onSignataireChanged())}var vm=this;vm.refresh=refresh,vm.close=close,vm.validerConfirmationLecture=validerConfirmationLecture,vm.onSignataireChanged=onSignataireChanged,vm.dossierInscription=datasDossierInscription,vm.inscriptionEleve=inscriptionEleve,vm.tabDocumentsASigner=listeDocumentsASigner,vm.tabSignatures=[],vm.tabDestinatairesDispo=[],vm.signataireSelected=null,vm.etape=1,vm.config3DSecure={codeModule:"documentDossierInscription",codeSecure:void 0,signataire:void 0},refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("modalConfirmSortieEleve",["$uibModalInstance","lesMotifs","eleve",function($uibModalInstance,lesMotifs,eleve){function refresh(){}function close(isSortieValidee){$uibModalInstance.close(isSortieValidee)}function cancel(){vm.eleve.motifSortie=vm.motifSortieDefault,vm.eleve.motifSortieLibre="",close(!1)}function saveSortieEleve(){(""!==vm.eleve.motifSortie.code||""!==vm.eleve.motifSortieLibre)&&close(!0)}var vm=this;vm.refresh=refresh,vm.close=close,vm.cancel=cancel,vm.saveSortieEleve=saveSortieEleve,vm.tabMotifsSortie=[],vm.eleve=eleve,vm.motifSortieDefault={code:"",libelle:""},vm.eleve.motifSortie=vm.motifSortieDefault,refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("SecureModalSignatureDossier",["$uibModalInstance","Notification","h2c","Auth","lodash","DossierInscriptionFamilleService","inscriptionEleve","domElementId",function($uibModalInstance,Notification,h2c,Auth,lodash,DossierInscriptionFamilleService,inscriptionEleve,domElementId){function close(isConfirmationValidee){$uibModalInstance.close(angular.isDefined(isConfirmationValidee)?isConfirmationValidee:!1)}function validerSignatureDossier(){vm.promise3DSecure=h2c.renderElementByID(domElementId).then(function(canvas){var now=moment().format("YYYYMMDDHHmmss"),signature={image:canvas.toDataURL("image/png"),titre:"signature_dossiereleve_"+inscriptionEleve+"_"+vm.signataireSelected.id+"_"+vm.signataireSelected.type+"_"+now};vm.promise3DSecure=DossierInscriptionFamilleService.signerDossier(vm.inscriptionEleve,vm.signataireSelected.id,vm.signataireSelected.type,vm.signataireSelected.tel,vm.config3DSecure,signature).then(function(){Notification.notify("Dossier d'inscription","Votre signature a bien été prise en compte !","success","glyphicon glyphicon-list-alt"),vm.tabSignatures.push({idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telSignataire:vm.signataireSelected.tel,date:moment().format("YYYY-MM-DD HH:mm:ss"),nomSignataire:vm.signataireSelected.nom}),vm.close(!0)},function(){Notification.notify("Dossier d'inscription","L'enregistrement a échoué.","error","glyphicon glyphicon-list-alt")})})["catch"](function(_err){Notification.notify("Dossier d'inscription","Impossible de signer le dossier.","error","glyphicon glyphicon-list-alt")})}function onSignataireChanged(){vm.config3DSecure.signataire={idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telephone:vm.signataireSelected.tel,particule:vm.signataireSelected.particule,civilite:vm.signataireSelected.civilite,nom:vm.signataireSelected.nom,ogec:"073STATI"}}function refresh(){var tabSignataires=[{id:Auth.currentUser().id,nom:Auth.currentUser().prenom+" "+Auth.currentUser().nom,tel:Auth.currentUser().profile.telPortable,type:Auth.currentUser().typeCompte,particule:Auth.currentUser().particule,civilite:Auth.currentUser().civilite}];vm.tabSignatairesDispo=tabSignataires,vm.tabSignatairesDispo.length>0&&(vm.signataireSelected=vm.tabSignatairesDispo[0],vm.onSignataireChanged())}var vm=this;vm.refresh=refresh,vm.close=close,vm.validerSignatureDossier=validerSignatureDossier,vm.onSignataireChanged=onSignataireChanged,vm.inscriptionEleve=inscriptionEleve,vm.tabSignatures=[],vm.tabDestinatairesDispo=[],vm.signataireSelected=null,vm.etape=1,vm.config3DSecure={codeModule:"signatureDossierInscription",codeSecure:void 0,signataire:void 0},refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("SecureModalSignatureDossierFamille",["$uibModalInstance","Notification","h2c","Auth","lodash","DossierInscriptionFamilleService","inscriptionFamille","domElementId",function($uibModalInstance,Notification,h2c,Auth,lodash,DossierInscriptionFamilleService,inscriptionFamille,domElementId){function close(isConfirmationValidee){$uibModalInstance.close(angular.isDefined(isConfirmationValidee)?isConfirmationValidee:!1)}function validerSignatureDossier(){vm.promise3DSecure=h2c.renderElementByID(domElementId).then(function(canvas){var now=moment().format("YYYYMMDDHHmmss"),signature={image:canvas.toDataURL("image/png"),titre:"signature_dossierfamille_"+inscriptionFamille.idInscriptionResponsable+"_"+vm.signataireSelected.id+"_"+vm.signataireSelected.type+"_"+now};vm.promise3DSecure=DossierInscriptionFamilleService.signerDossierFamille(inscriptionFamille.idInscriptionResponsable,vm.signataireSelected.id,vm.signataireSelected.type,vm.signataireSelected.tel,vm.config3DSecure,signature).then(function(){Notification.notify("Dossier d'inscription","Votre signature a bien été prise en compte !","success","glyphicon glyphicon-list-alt"),vm.tabSignatures.push({idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telSignataire:vm.signataireSelected.tel,date:moment().format("YYYY-MM-DD HH:mm:ss"),nomSignataire:vm.signataireSelected.nom}),vm.close(!0)},function(){Notification.notify("Dossier d'inscription","L'enregistrement a échoué.","error","glyphicon glyphicon-list-alt")})})["catch"](function(_err){Notification.notify("Dossier d'inscription","Impossible de signer le dossier.","error","glyphicon glyphicon-list-alt")})}function onSignataireChanged(){vm.config3DSecure.signataire={idSignataire:vm.signataireSelected.id,typeSignataire:vm.signataireSelected.type,telephone:vm.signataireSelected.tel,particule:vm.signataireSelected.particule,civilite:vm.signataireSelected.civilite,nom:vm.signataireSelected.nom,ogec:"073STATI"}}function refresh(){var tabSignataires=[{id:Auth.currentUser().id,nom:Auth.currentUser().prenom+" "+Auth.currentUser().nom,tel:Auth.currentUser().profile.telPortable,type:Auth.currentUser().typeCompte,particule:Auth.currentUser().particule,civilite:Auth.currentUser().civilite}];vm.tabSignatairesDispo=tabSignataires,vm.tabSignatairesDispo.length>0&&(vm.signataireSelected=vm.tabSignatairesDispo[0],vm.onSignataireChanged())}var vm=this;vm.refresh=refresh,vm.close=close,vm.validerSignatureDossier=validerSignatureDossier,vm.onSignataireChanged=onSignataireChanged,vm.tabSignatures=[],vm.tabDestinatairesDispo=[],vm.signataireSelected=null,vm.etape=1,vm.inscriptionFamille=inscriptionFamille,vm.isValidationMandatRequired="Prélèvement"===inscriptionFamille.facturation.modeReglement,vm.config3DSecure={codeModule:"signatureDossierInscription",codeSecure:void 0,signataire:void 0},refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("modalDetailsPaiementCheque",["$uibModalInstance","AccueilFamilleService","montant","texteAideReglementCheque","paiementDevise",function($uibModalInstance,AccueilFamilleService,montant,texteAideReglementCheque,paiementDevise){function close(){$uibModalInstance.close()}function refresh(){AccueilFamilleService.contactEtablissement().then(function(contactEtablissement){vm.etablissement=contactEtablissement[0]})}var vm=this;vm.refresh=refresh,vm.close=close,vm.etablissement=null,vm.texteAideReglementCheque=texteAideReglementCheque,vm.montant=montant,vm.paiementDevise=paiementDevise,refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").controller("modalModifScolariteEleve",["$uibModalInstance","$q","eleve","DossierInscriptionFamilleService","Auth",function($uibModalInstance,$q,eleve,DossierInscriptionFamilleService,Auth){function close(data){$uibModalInstance.close(data)}function onSelectOptionFormationEleve(rangOption,eleveCurrent){var tabValeursOptions=[];eleveCurrent.optionsFormation.length>=12||(vm.promiseContents=DossierInscriptionFamilleService.getOptionsFormation(eleveCurrent.formation.codeMEF,Auth.codeOgec(),rangOption+1,eleveCurrent.formation.codeSpecialite).then(function(tabOptionsFormation){DossierInscriptionFamilleService.cleanTabOptionsFormationPossibles(tabOptionsFormation.optionsFormation,eleveCurrent),tabOptionsFormation.optionsFormation.length<=0||(angular.forEach(tabOptionsFormation.optionsFormation,function(optionFormation){optionFormation.isSelected=!1,tabValeursOptions.push(optionFormation)}),vm.tabOptionsEleve.push({tabValeurs:tabValeursOptions,ordre:rangOption}))},function(data){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)}))}function isOptionFormationDisabled(rangFormation,eleveCurrent){return angular.isUndefined(vm.tabOptionsEleve[rangFormation+1])?void 0:rangFormation+1<=eleveCurrent.optionsFormation.length&&angular.isDefined(vm.tabOptionsEleve[rangFormation+1].tabValeurs)&&vm.tabOptionsEleve[rangFormation+1].tabValeurs.length>0}function removeLastOptionFormationEleve(eleveCurrent){vm.tabOptionsEleve.pop(),eleveCurrent.optionsFormation.pop()}function callWebServiceListeOptionsAcad(indiceOptionAcad,valeurOptionEleve){var tabValeursOptions=[];return function(){return DossierInscriptionFamilleService.getOptionsFormation(vm.eleveCurrent.formation.codeMEF,Auth.codeOgec(),indiceOptionAcad+1,vm.eleveCurrent.formation.codeSpecialite).then(function(tabOptions){angular.forEach(tabOptions.optionsFormation,function(optionFormation){angular.isDefined(valeurOptionEleve)?optionFormation.isSelected=optionFormation.code===valeurOptionEleve.code&&optionFormation.codeMatiereInterne===valeurOptionEleve.codeMatiereInterne:optionFormation.isSelected=!1,tabValeursOptions.push(optionFormation)}),vm.tabOptionsEleve.push({tabValeurs:tabValeursOptions,ordre:indiceOptionAcad})})}}function runAllPromises(listPromises){var p=$q.resolve();return listPromises.reduce(function(pacc,fn){return pacc=pacc.then(fn)},p)}function refresh(){var tabPromises=[];if(!angular.isUndefined(vm.eleveCurrent.formation)){if(angular.forEach(vm.eleveCurrent.optionsFormation,function(valeurOptionEleve,indiceOptionAcad){tabPromises.push(callWebServiceListeOptionsAcad(indiceOptionAcad,valeurOptionEleve))}),0===vm.eleveCurrent.optionsFormation.length){var indiceOptionAcad=0;vm.promiseContents=vm.onSelectOptionFormationEleve(indiceOptionAcad,vm.eleveCurrent)}tabPromises.length>0&&(vm.promiseContents=runAllPromises(tabPromises).then(function(){vm.onSelectOptionFormationEleve(vm.eleveCurrent.optionsFormation.length,vm.eleveCurrent),vm.allIsLoaded=!0},function(error){Notification.notify("Dossier d'inscription",error.data.message||"Une erreur est survenue","error",!0)}))}}var vm=this;vm.onSelectOptionFormationEleve=onSelectOptionFormationEleve,vm.isOptionFormationDisabled=isOptionFormationDisabled,vm.removeLastOptionFormationEleve=removeLastOptionFormationEleve,vm.refresh=refresh,vm.close=close,vm.eleveCurrent=angular.copy(eleve),vm.tabOptionsEleve=[],vm.allIsLoaded=!1,refresh()}]),angular.module("edsiteApp.DossierInscriptionFamille").directive("infocomp",function(){return{restrict:"A",scope:{name:"@",infoComp:"=",type:"@",formDossierInscription:"="},controller:"InfoCompDirectiveCtrl",controllerAs:"infoCompDirectiveCtrl",templateUrl:"modules/dossierInscriptionFamille/infocomp-template.html",link:function(scope,element,attrs){if(!(scope.infoComp.options.length>0))if("Date"===scope.infoComp.type)if(""===scope.infoComp.valeur||"undefined"==typeof scope.infoComp.valeur)scope.infoComp.dateFormated=null;else{var extractDate=scope.infoComp.valeur.split("/"),formateDate=extractDate[2]+"-"+extractDate[1]+"-"+extractDate[0];scope.infoComp.dateFormated=new Date(formateDate)}else if("Heure"===scope.infoComp.type){var dateHeureFormated=new Date,heureInfoCompJson=scope.infoComp.valeur.split(":");dateHeureFormated.setHours(heureInfoCompJson[0]),dateHeureFormated.setMinutes([heureInfoCompJson[1]]),scope.infoComp.heureFormated=dateHeureFormated,scope.infoComp.heure=heureInfoCompJson[0],scope.infoComp.minutes=heureInfoCompJson[1]}}}}).controller("InfoCompDirectiveCtrl",["$scope","lodash",function($scope,lodash){function onChangeValeur(){if(!(vm.infoComp.options.length>0))if("Nombre"===vm.type&&RegExp("^[+-]?[\\d]+[[.,]?[\\d]+]?$").test(vm.infoComp.valeur))vm.infoComp.valeur=vm.infoComp.valeur.replace(",",".");else if("Date"===vm.type&&vm.infoComp.dateFormated instanceof Date){var month=""+(vm.infoComp.dateFormated.getMonth()+1),day=""+vm.infoComp.dateFormated.getDate(),year=vm.infoComp.dateFormated.getFullYear();month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),vm.infoComp.valeur=[day,month,year].join("/")}else if("Heure"===vm.type&&vm.infoComp.heureFormated instanceof Date){var hour=""+vm.infoComp.heureFormated.getHours(),minutes=""+vm.infoComp.heureFormated.getMinutes();hour.length<2&&(hour="0"+hour),minutes.length<2&&(minutes="0"+minutes),vm.infoComp.valeur=[hour,minutes].join(":")}}function openCalendar($event,boolCalendar){$event.preventDefault(),$event.stopPropagation(),vm[boolCalendar]=!0}function refresh(){var infoCompVide=lodash.find(vm.infoComp.options,{id:0,valeur:""});vm.infoComp.options.length>0&&angular.isUndefined(infoCompVide)&&vm.infoComp.options.unshift({id:0,libelle:"",valeur:""})}var vm=this;vm.refresh=refresh,vm.openCalendar=openCalendar,vm.onChangeValeur=onChangeValeur,vm.name=$scope.name,vm.infoComp=$scope.infoComp,vm.type=$scope.type,vm.selectId="select-"+$scope.name,vm.inputId="input-"+$scope.name,vm.selectName="select-"+$scope.name,vm.inputName="input-"+$scope.name,vm.formDossierInscription=$scope.formDossierInscription,vm.datePicker={dateOptions:{formatYear:"yy",startingDay:1},format:"dd/MM/yyyy"},vm.timePicker={heureStepInfoComp:1,minutesStepInfoComp:1,showSpinners:!1},vm["calendar_eleve_"+vm.name+"_Open"]=!1,refresh()}]),angular.module("edsiteApp.Appel",["edsiteApp.Commun","ui.bootstrap","edsiteApp.base64filter"]).controller("AppelCtrl",["$scope","$routeParams","$uibModal","$filter","lodash","Notification","Auth","UserService","AppelService","ModuleService",function($scope,$routeParams,$uibModal,$filter,lodash,Notification,Auth,UserService,AppelService,ModuleService){function sexe(eleve){return"M"===eleve.sexe?"":"e"}function selectClasseById(idClasse){$scope.entitySelectMode=AppelService.typeEntity.CLASSE;var idToSearch=parseInt(idClasse),classe=lodash.find($scope.etablissements,{classeId:idToSearch});angular.isDefined(classe)&&$scope.selectClasse(classe)}function selectClasse(classe){$scope.statusDropdown.isClasseOpen=!1,$scope.eleves=[],$scope.classe=classe,$scope.salle=null,$scope.tranche=null,$scope.plage=null,$scope.horaires=[],$scope.tranches=[],$scope.appelEffectue=!1,classe.type===AppelService.typeEntity.GROUPE?($scope.entitySelectMode=AppelService.typeEntity.GROUPE,$scope.classe.classeLibelle=classe.libelle,$scope.classe.groupeId=classe.id):$scope.entitySelectMode=AppelService.typeEntity.CLASSE,Auth.isProfesseur()?refreshHorairesByGrille():(refreshHoraires(classe.id,$scope.entitySelectMode),$scope.step="2")}function selectSalle(salle){$scope.eleves=[],$scope.entitySelectMode=AppelService.typeEntity.SALLE,$scope.salle=salle,$scope.classe=null,$scope.horaires=[],$scope.tranches=[],$scope.tranche=null,$scope.plage=null,$scope.appelEffectue=!1,refreshHoraires(salle.id,AppelService.typeEntity.SALLE),$scope.step="2"}function refreshHorairesByGrille(){if($scope.tranches=[],angular.isDefined($scope.classe)){var idEtab=$scope.classe.etabId;"undefined"!=typeof idEtab&&(angular.isDefined($scope.selectAllClasse)&&$scope.selectAllClasse?UserService.getListeEtablissementsAll().then(function(etabs){var etab=lodash.find(etabs,{id:idEtab});angular.isUndefined(etab)&&etabs.length>0&&(etab=etabs[0]),$scope.tranches=etab.parametres.grille,selectActualTranche()}):UserService.getListeEtablissements().then(function(etabs){var etab=lodash.find(etabs,{id:idEtab});angular.isUndefined(etab)&&etabs.length>0&&(etab=etabs[0]),$scope.tranches=etab.parametres.grille,selectActualTranche()}))}}function refreshHoraires(idToLoad,typeToLoad){$scope.parametrage.rechercheParEDT?$scope.promiseContents=AppelService.horairesByClassesOrGroupeOrSalle(idToLoad,typeToLoad).then(function(response){if(response&&0!==response.length){var lesPlages=angular.copy(response);angular.forEach(lesPlages,function(plage){plage.heure_debut="undefined"==typeof plage.heure_debut?plage.start_date.split(" ")[1]:plage.heure_debut,plage.heure_fin="undefined"==typeof plage.heure_fin?plage.end_date.split(" ")[1]:plage.heure_fin}),$scope.horaires=lesPlages,selectActualPlage()}else{var compl="";$scope.entitySelectMode===AppelService.typeEntity.SALLE?compl="cette salle":$scope.entitySelectMode===AppelService.typeEntity.CLASSE||"enseignant"===$scope.entitySelectMode?compl="cette classe":$scope.entitySelectMode===AppelService.typeEntity.GROUPE&&(compl="ce groupe"),$scope.horaires=[],Notification.notify("Aucun horaire","Nous n'avons trouvé aucun cours dans l'emploi du temps correspondant à "+compl,"error",!0),$scope.entitySelectMode!==AppelService.typeEntity.SALLE&&Auth.isPersonnel()&&refreshHorairesByGrille()}}):refreshHorairesByGrille()}function refreshEleves(idToLoad,typeToLoad,idCours){$scope.promiseContents=AppelService.elevesByClasseOrGroupe(idToLoad,typeToLoad,idCours).then(function(response){angular.isDefined(response)?($scope.eleves=response.eleves,$scope.appelCours=response.appelEnClasse):($scope.eleves=[],Notification.notify("Aucun élève","Nous n'avons trouvé aucun élèves pour cette classe","error",!0))})}function setStep(step){$scope.step=step}function selectPlage(horaire){$scope.statusDropdown.isCoursOpen=!1,$scope.mode="EDT",$scope.plage=horaire,$scope.tranche=null,$scope.appelEffectue=!1;var typeEntite,idEntite;angular.isDefined($scope.plage.groupeId)&&0!==$scope.plage.groupeId?(typeEntite=AppelService.typeEntity.GROUPE,$scope.displayTri=!0,idEntite=$scope.plage.groupeId):($scope.ordre="ALPHA",$scope.displayTri=!1,typeEntite=AppelService.typeEntity.CLASSE,idEntite=$scope.plage.classeId),refreshEleves(idEntite,typeEntite,$scope.plage),$scope.step="3"}function selectTranche(horaire){$scope.statusDropdown.isHoraireOpen=!1,$scope.mode="TRANCHE",$scope.tranche=horaire,$scope.plage=null,$scope.appelEffectue=!1;var typeEntite,idEntite;angular.isDefined($scope.tranche.groupeId)&&0!==$scope.tranche.groupeId||$scope.entitySelectMode===AppelService.typeEntity.GROUPE?(typeEntite=AppelService.typeEntity.GROUPE,$scope.displayTri=!0,idEntite=$scope.classe.groupeId):($scope.ordre="ALPHA",$scope.displayTri=!1,typeEntite=AppelService.typeEntity.CLASSE,idEntite=$scope.classe.classeId),refreshEleves(idEntite,typeEntite,$scope.tranche),$scope.step="3"}function displayPlageLibelle(plage){var lib="";return angular.isUndefined(plage)?lib:(lib+=plage.heure_debut,lib+=" - ",lib+=plage.heure_fin,plage.text&&(lib+=" : "+plage.text),Auth.isPersonnel()?$scope.entitySelectMode===AppelService.typeEntity.SALLE&&plage.classe?lib+=" ("+plage.classe+")":$scope.entitySelectMode===AppelService.typeEntity.CLASSE&&plage.salle&&(lib+=" (Salle "+plage.salle+")"):(lib+=angular.isDefined(plage.classe)&&""!==plage.classe?" ("+plage.classe+")":"",lib+=angular.isDefined(plage.groupe)&&""!==plage.groupe?" ("+plage.groupe+")":""),lib)}function listAbsents(){return lodash.filter($scope.eleves,function(ele){return ele.isAbsent})}function tousAbsent(){angular.forEach(getClasseGroup(),function(cl){angular.forEach(elevesByClasse(cl),function(eleve){eleve.isAbsent=!0})}),$scope.etatBoutonTous=1}function tousPresent(){angular.forEach(getClasseGroup(),function(cl){angular.forEach(elevesByClasse(cl),function(eleve){eleve.isAbsent=!1})}),$scope.etatBoutonTous=0}function submitAppel(){var modalInstance=$uibModal.open({templateUrl:"modules/appel/modal.submitappel.html",scope:$scope,keyboard:!1,backdrop:!1});modalInstance.result.then(function(data){if(1===data){var idEntity,typeEntity,objPlageOrTranche=$scope.plage?$scope.plage:$scope.tranche;"EDT"===$scope.mode?0===$scope.plage.classeId?(idEntity=$scope.plage.groupeId,typeEntity=AppelService.typeEntity.GROUPE):(idEntity=$scope.plage.classeId,typeEntity=AppelService.typeEntity.CLASSE):(idEntity=$scope.classe.id,typeEntity=$scope.entitySelectMode===AppelService.typeEntity.GROUPE?AppelService.typeEntity.GROUPE:AppelService.typeEntity.CLASSE),$scope.promiseContents=AppelService.postAppel(idEntity,typeEntity,objPlageOrTranche,$scope.eleves).then(function(){$scope.appelEffectue=!0,$scope.appelCours.effectue=!0,$scope.appelCours.dateHeure=moment().format("YYYY-MM-DD HH:mm:ss"),Notification.notify("Appel enregistré","Votre appel a bien été enregistré","success",!0)})}})}function remiseazero(){$scope.appelEffectue=!1,$scope.eleves=[],$scope.horaires=[],$scope.plage={},$scope.tranche={},$scope.classe=void 0,$scope.displayTri=!1}function setEntitySelectMode(newMode){remiseazero(),$scope.salle=null,$scope.classe=null,$scope.entitySelectMode=newMode}function selectActualPlage(){var nowStr=moment().format("HH:mm");angular.forEach($scope.horaires,function(plage){return plage.heure_debut<nowStr&&plage.heure_fin>nowStr?selectPlage(plage):void 0})}function selectActualTranche(){var now=moment().format("HH:mm");angular.forEach($scope.tranches,function(tranche){return tranche.heure_debut<now&&tranche.heure_fin>now?selectTranche(tranche):void 0})}function setOrdre(ordre){$scope.ordre=ordre}function getClasseGroup(){if("ALPHA"===$scope.ordre)return[1];var classes={};angular.forEach($scope.eleves,function(elv){classes[elv.classeId]=elv.classeLibelle});var result=lodash.values(classes);return result.sort(),result}function elevesByClasse(cl){return"ALPHA"===$scope.ordre?$scope.eleves:lodash.filter($scope.eleves,function(elv){return elv.classeLibelle===cl})}function activeRechercheParClasse(){if($scope.appelCours={},$scope.rechercheParClasse){var title="Si vous ne trouvez pas votre cours dans la liste, il n'a pas été saisi dans l'emploi du temps.";title+="<br> Référez-vous auprès de votre établissement pour corriger le problème.",title+="<br> Voulez-vous effectuer une recherche parmi vos classes ?",self.modalInstanceRechercheClasse=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Recherche par classe",config.message=title,config.confirm="Oui",config.cancel="Non",config}}}),self.modalInstanceRechercheClasse.result.then(function(){$scope.rechercheParClasse=!0,remiseazero(),setStep(1)},function(){$scope.rechercheParClasse=!1})}else disableRechercheClasse(),refreshHoraires(Auth.idUser(),"enseignant"),remiseazero()}function disableRechercheClasse(){$scope.rechercheParClasse=!1}function selectAll(){$scope.selectAllClasse=!$scope.selectAllClasse,$scope.selectAllClasse?$scope.promiseContents=UserService.getAllClassesByEtabs().then(function(etabs){$scope.etablissements=etabs,UserService.getAllGroupes().then(function(groupes){$scope.groupes=groupes})}):($scope.etablissements=$scope.defaultClasses,$scope.groupes=$scope.defaultGroupes)}function refresh(){Auth.isProfesseur()&&refreshHoraires(Auth.idUser(),"enseignant"),$scope.promiseContents=UserService.getClassesByEtabs().then(function(etabs){$scope.etablissements=etabs,$scope.defaultClasses=angular.copy($scope.etablissements),UserService.getGroupes().then(function(groupes){$scope.groupes=groupes,$scope.defaultGroupes=angular.copy($scope.groupes)}),Auth.isPersonnel()&&($scope.promiseContents=AppelService.listeSalles().then(function(response){$scope.salles=response,angular.isDefined($scope.idEntity)&&selectClasseById($scope.idEntity)}))})}function isEleveAnniversaire(eleve){var anniv=moment(eleve.dateNaissance,"YYYY-MM-DD");return anniv.format("MMDD")===moment().format("MMDD")}$scope.mode="EDT",$scope.entitySelectMode=AppelService.typeEntity.SALLE,$scope.step="1",$scope.parametresAppels=ModuleService.getModule(ModuleService.CODES.APPEL).params,$scope.parametrage={rechercheParEDT:"1"===$scope.parametresAppels.rechercheParEDT,rechercheParClasse:"1"===$scope.parametresAppels.rechercheParClasse},$scope.statusDropdown={isCoursOpen:!1,isHoraireOpen:!1,isClasseOpen:!1},$scope.rechercheParClasse=!1,this.modalInstanceRechercheClasse={};var self=this;$scope.typeUser=Auth.role(),$scope.typeEntity=$routeParams.typeEntity,$scope.idEntity=$routeParams.idEntity,$scope.salle=null,$scope.eleves=[],$scope.etablissements=[],$scope.currentEntity={},$scope.etatBoutonTous=0,$scope.refresh=refresh,$scope.selectSalle=selectSalle,$scope.sexe=sexe,$scope.selectClasse=selectClasse,$scope.refreshHoraires=refreshHoraires,$scope.refreshHorairesByGrille=refreshHorairesByGrille,$scope.setStep=setStep,$scope.selectPlage=selectPlage,$scope.selectTranche=selectTranche,$scope.refreshEleves=refreshEleves,$scope.selectAll=selectAll,$scope.displayTri=!1,$scope.ordre="ALPHA",$scope.setOrdre=setOrdre,$scope.getClasseGroup=getClasseGroup,$scope.elevesByClasse=elevesByClasse,$scope.displayPlageLibelle=displayPlageLibelle,$scope.listAbsents=listAbsents,
$scope.submitAppel=submitAppel,$scope.tousAbsent=tousAbsent,$scope.tousPresent=tousPresent,$scope.remiseazero=remiseazero,$scope.setEntitySelectMode=setEntitySelectMode,$scope.selectActualPlage=selectActualPlage,$scope.selectActualTranche=selectActualTranche,$scope.activeRechercheParClasse=activeRechercheParClasse,$scope.disableRechercheClasse=disableRechercheClasse,$scope.isEleveAnniversaire=isEleveAnniversaire,refresh()}]),angular.module("edsiteApp.Appel").service("AppelService",["$q","$http",function($q,$http){var mAppel={};return mAppel.typeEntity={CLASSE:"C",GROUPE:"G",SALLE:"S"},mAppel.postAppel=function(idEntity,typeEntity,plage,eleves){var defer=$q.defer(),data={eleves:eleves},baseUrl="";return baseUrl="C"===typeEntity?"classes/"+idEntity+"/appel/horaires/":"groupes/"+idEntity+"/appel/horaires/",baseUrl+=plage.heure_debut+"-"+plage.heure_fin,$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAppel.horairesByClassesOrGroupeOrSalle=function(idEntity,typeEntity){var defer=$q.defer(),data={},baseUrl="";return baseUrl="C"===typeEntity?"classes/"+idEntity+"/appel/horaires":"S"===typeEntity?"salles/"+idEntity+"/appel/horaires":"enseignant"===typeEntity?"enseignant/"+idEntity+"/appel/horaires":"groupes/"+idEntity+"/appel/horaires",$http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAppel.elevesByClasseOrGroupe=function(idEntity,typeEntity,trancheHoraire){var defer=$q.defer(),baseUrl="",data={heureDebut:trancheHoraire.heure_debut,heureFin:trancheHoraire.heure_fin},idCours=trancheHoraire.id;return idCours=angular.isUndefined(idCours)?"":idCours,baseUrl="C"===typeEntity?"classes/"+idEntity+"/eleves":"groupes/"+idEntity+"/eleves",""!==idCours&&(baseUrl+="?idCours="+idCours),$http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAppel.listeSalles=function(){var defer=$q.defer(),data={},baseUrl="salles";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAppel}]),angular.module("edsiteApp.AppelPrimaire",["edsiteApp.Commun","ui.bootstrap","edsiteApp.base64filter"]).controller("AppelPrimaireCtrl",["$scope","$routeParams","$uibModal","$filter","$q","$timeout","lodash","Notification","Auth","UserService","AppelPrimaireService",function($scope,$routeParams,$uibModal,$filter,$q,$timeout,lodash,Notification,Auth,UserService,AppelPrimaireService){function listAbsents(){return vm.tabEleves.filter(function(eleve){return vm.isEleveAbsent(eleve)})}function submitAppel(){var modalInstance=$uibModal.open({templateUrl:"modules/appel/modal.submitappel.html",scope:$scope,keyboard:!1,backdrop:!1});modalInstance.result.then(function(data){if(1===data){var tabElevesWS=angular.copy(vm.tabEleves).map(function(eleve){return eleve.isAbsent=vm.isEleveAbsent(eleve),eleve.reservations=eleve.activites.filter(function(activite){return activite.isUpdated===!0}).map(function(activite){return{idActivite:activite.id,activite:activite.libelle,date:$filter("date")(new Date,"yyyy-MM-dd"),etat:angular.isDefined(activite.isInscrit)&&activite.isInscrit===!0?1:0}}),delete eleve.activites,eleve}),trancheHoraire=vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM?vm.trancheHoraireAM:vm.trancheHorairePM;vm.promiseContents=AppelPrimaireService.postFeuilleAppelPrimaire(vm.entitySelected.id,vm.entitySelected.type,tabElevesWS,trancheHoraire).then(function(response){vm.isAppelEffectue=!0,vm.isAppelDemieJourneeDirty=!1,vm.infoDernierAppel[vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM?"matin":"apresMidi"]=moment().format("YYYY-MM-DD H:mm:ss"),vm.tabEleves.forEach(function(eleve){eleve.activites.map(function(activite){return activite.isUpdated=!1,activite})}),vm.tabElevesDefaut=angular.copy(vm.tabEleves),Notification.notify("Appel enregistré","Votre appel a bien été enregistré","success",!0)})}})}function initTranchesHorairesJournee(entity){var defer=$q.defer(),idEtab=entity.etabId;return angular.isDefined(idEtab)&&UserService.getListeEtablissements().then(function(etabs){var etab=lodash.find(etabs,{id:idEtab});if(angular.isDefined(etab)){var heureDebut,heureFin,grilleEtab=etab.parametres.grille;if(heureDebut="08:00",heureFin="12:00",grilleEtab.length>0){heureDebut=grilleEtab[0].heure_debut<"13:00"?grilleEtab[0].heure_debut:"08:00";var i=0;do heureFin=grilleEtab[i].heure_fin,i++;while(angular.isDefined(grilleEtab[i])&&grilleEtab[i].heure_fin<="13:00")}if(vm.trancheHoraireAM=heureDebut+"-"+heureFin,heureDebut="13:00",heureFin="17:00",grilleEtab.length>0){for(var i=0;angular.isDefined(grilleEtab[i])&&grilleEtab[i].heure_debut<"13:00";)i++;heureDebut=angular.isDefined(grilleEtab[i])?grilleEtab[i].heure_debut:"13:00",heureFin=grilleEtab[grilleEtab.length-1].heure_fin>heureDebut?grilleEtab[grilleEtab.length-1].heure_fin:"17:00"}vm.trancheHorairePM=heureDebut+"-"+heureFin,defer.resolve()}},function(error){defer.reject(error)}),defer.promise}function onSelectTypeDemieJournee(typeDemieJournee){vm.typeDemieJourneeSelected=typeDemieJournee,vm.tabActivitesDemieJournee=vm.extractListeActivitesDemieJournee(typeDemieJournee),vm.isAppelDemieJourneeDirty=!1}function isSuiviActiviteUpdated(eleve,activite){var activiteDefautEleve=vm.tabElevesDefaut.find(function(eleveDef){return eleveDef.id===eleve.id}).activites.find(function(activiteDef){return activiteDef.id===activite.id});return angular.isDefined(activiteDefautEleve)&&activiteDefautEleve.isInscrit!==activite.isInscrit}function extractListeActivitesDemieJournee(typeDemieJournee){return vm.tabActivites.filter(function(activite){return typeDemieJournee===vm.TYPE_DEMIE_JOURNEE.AM&&activite.isSuiviMatin||typeDemieJournee===vm.TYPE_DEMIE_JOURNEE.PM&&activite.isSuiviApresMidi})}function isEleveInscritActivite(eleve,idActivite){var activiteEleve=lodash.find(eleve.activites,{id:idActivite});return angular.isDefined(activiteEleve)?activiteEleve.isInscrit:!1}function toggleInscriptionEleve(eleve,idActivite){vm.isAppelDemieJourneeDirty=!0;var activiteEleve=lodash.find(eleve.activites,{id:idActivite});activiteEleve.isUpdated=!1,angular.isDefined(activiteEleve)&&(activiteEleve.isInscrit=!activiteEleve.isInscrit,activiteEleve.isUpdated=vm.isSuiviActiviteUpdated(eleve,activiteEleve))}function onSelectEntity(entity){vm.entitySelected=entity,vm.tabEleves.length=0,vm.tabActivites.length=0,vm.tabActivitesDemieJournee.length=0,vm.isAppelEffectue=!1,vm.promiseContents=vm.initTranchesHorairesJournee(entity).then(function(){vm.promiseContents=AppelPrimaireService.getFeuilleAppelPrimaire(entity.id,entity.type,vm.trancheHoraireAM,vm.trancheHorairePM).then(function(response){angular.isDefined(response.eleves)&&(vm.tabEleves=response.eleves,vm.tabElevesDefaut=angular.copy(vm.tabEleves)),angular.isDefined(response.activites)&&(vm.tabActivites=response.activites),angular.isDefined(response.dernierAppel)&&(vm.infoDernierAppel=response.dernierAppel),vm.onSelectTypeDemieJournee((new Date).getHours()<12?vm.TYPE_DEMIE_JOURNEE.AM:vm.TYPE_DEMIE_JOURNEE.PM)})})}function setEleveAbsent(eleve,isAbsent){if(vm.isAppelDemieJourneeDirty=!0,eleve.isAbsent=isAbsent,vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM?eleve.isAbsentMatin=isAbsent:eleve.isAbsentApresMidi=isAbsent,isAbsent)eleve.activites.filter(function(activite){return lodash.findIndex(vm.tabActivitesDemieJournee,{id:activite.id})>-1}).map(function(activite){activite.isInscrit=!1,activite.isUpdated=vm.isSuiviActiviteUpdated(eleve,activite)});else{var activitesDefautEleve=vm.tabElevesDefaut.find(function(eleveDef){return eleveDef.id===eleve.id}).activites;angular.isDefined(activitesDefautEleve)&&(eleve.activites=angular.copy(activitesDefautEleve))}}function displayWarningOnSelectTypeDemieJournee(event,typeDemieJournee){function changeTypeDemieJournee(typeDemieJournee){vm.tabEleves=angular.copy(vm.tabElevesDefaut),vm.onSelectTypeDemieJournee(typeDemieJournee)}if(!vm.isAppelDemieJourneeDirty)return void changeTypeDemieJournee(typeDemieJournee);if(typeDemieJournee!==vm.typeDemieJourneeSelected){event.stopPropagation();var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:"<p style=\"font-size: 1.5em\">Vous n'avez pas validé l'appel pour "+(vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM?"la matinée":"l'après-midi")+", si vous continuez toute votre saisie sera perdue.</p>",type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre l'appel en cours",addClass:"btn btn-warning",click:function(){$timeout(function(){changeTypeDemieJournee(typeDemieJournee)},500)}},{text:"Annuler et continuer l'appel",addClass:"btn btn-primary"}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}}function isEleveAbsent(eleve){return vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM&&eleve.isAbsentMatin===!0?!0:vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.PM&&eleve.isAbsentApresMidi===!0?!0:!1}function getHeureDernierAppel(){return vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.AM&&angular.isDefined(vm.infoDernierAppel)&&""!==vm.infoDernierAppel.matin?new Date(vm.infoDernierAppel.matin):vm.typeDemieJourneeSelected===vm.TYPE_DEMIE_JOURNEE.PM&&angular.isDefined(vm.infoDernierAppel)&&""!==vm.infoDernierAppel.apresMidi?new Date(vm.infoDernierAppel.apresMidi):null}function refresh(){vm.promiseContents=UserService.getClassesByEtabs().then(function(etabs){vm.etablissements=etabs.filter(function(classe){return 1===classe.degre}),1===vm.etablissements.length?vm.onSelectEntity(vm.etablissements[0]):0===vm.etablissements.length&&1===vm.groupes.length&&vm.onSelectEntity(vm.groupes[0])})}var vm=this;vm.TYPE_DEMIE_JOURNEE={AM:"matin",PM:"apresMidi"},vm.isAppelEffectue=!1,vm.typeDemieJourneeSelected="",vm.trancheHoraireAM="08:00-12:00",vm.trancheHorairePM="13:00-17:00",vm.tabEleves=[],vm.tabElevesDefaut=[],vm.tabActivites=[],vm.tabActivitesDemieJournee=[],vm.etablissements=[],vm.salles=[],vm.groupes=[],vm.entitySelected={},vm.infoDernierAppel=null,vm.isAppelDemieJourneeDirty=!1,vm.refresh=refresh,vm.submitAppel=submitAppel,vm.onSelectTypeDemieJournee=onSelectTypeDemieJournee,vm.toggleInscriptionEleve=toggleInscriptionEleve,vm.extractListeActivitesDemieJournee=extractListeActivitesDemieJournee,vm.isEleveInscritActivite=isEleveInscritActivite,vm.onSelectEntity=onSelectEntity,vm.setEleveAbsent=setEleveAbsent,vm.isSuiviActiviteUpdated=isSuiviActiviteUpdated,vm.displayWarningOnSelectTypeDemieJournee=displayWarningOnSelectTypeDemieJournee,vm.initTranchesHorairesJournee=initTranchesHorairesJournee,vm.isEleveAbsent=isEleveAbsent,vm.getHeureDernierAppel=getHeureDernierAppel,$scope.listAbsents=listAbsents,refresh()}]),angular.module("edsiteApp.AppelPrimaire").service("AppelPrimaireService",["$q","$http",function($q,$http){function getFeuilleAppelPrimaire(idEntity,typeEntity,trancheHoraireAM,trancheHorairePM){var defer=$q.defer(),data={trancheHoraireAM:trancheHoraireAM,trancheHorairePM:trancheHorairePM},baseUrl="appelPrimaire/"+("C"===typeEntity?"classes/":"groupes/")+idEntity;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function postFeuilleAppelPrimaire(idEntity,typeEntity,listeEleves,trancheHoraire){var defer=$q.defer(),data={eleves:listeEleves,trancheHoraire:trancheHoraire},baseUrl="appelPrimaire/"+("C"===typeEntity?"classes/":"groupes/")+idEntity;return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}var mAppelPrimaire={};return mAppelPrimaire.getFeuilleAppelPrimaire=getFeuilleAppelPrimaire,mAppelPrimaire.postFeuilleAppelPrimaire=postFeuilleAppelPrimaire,mAppelPrimaire}]),angular.module("edsiteApp.AppelEtude",["edsiteApp.Commun"]).controller("AppelEtudeCtrl",["$scope","$rootScope","$uibModal","$filter","$timeout","lodash","Notification","Auth","UserService","AppelEtudeService","ScanBadgeService","PersonnelconsultationService","ModuleService",function($scope,$rootScope,$uibModal,$filter,$timeout,lodash,Notification,Auth,UserService,AppelEtudeService,ScanBadgeService,PersonnelconsultationService,ModuleService){function setOrdre(ordre){vm.ordre=ordre}function onSelectParamAppelEtude(parametre){if(vm.statusDropdown.isAppelParamOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){onSelectParamAppelEtude(parametre)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.paramAppelEtude=parametre,vm.listSalle=lodash(vm.listParamAppelEtude).filter({idEtab:parametre.idEtab}).map("salles").flatten().sortBy("libelle").value(),vm.listEleves=[],vm.horaire=null,vm.salle=null,vm.appelEffectue=!1,vm.resultatScan={}}function onSelectSalle(salle){if(vm.statusDropdown.isSalleOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){onSelectSalle(salle)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.salle=salle,vm.listEleves=[],vm.horaire=null,vm.appelEffectue=!1,vm.resultatScan={},vm.promiseContents=UserService.getListeEtablissements().then(function(etabs){var etab=lodash.find(etabs,{id:vm.paramAppelEtude.idEtab});angular.isUndefined(etab)&&etabs.length>0&&(etab=etabs[0]),angular.isDefined(etab.parametres.grille)&&etab.parametres.grille.length>0?(vm.listHoraire=etab.parametres.grille,selectPlageHoraireActuel()):Notification.notify("Aucun horaire","Nous n'avons trouvé aucune grille horaire correspondante","error",!0)})}function onSelectHoraire(horaire){if(vm.statusDropdown.isHoraireOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){onSelectHoraire(horaire)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.resultatScan={},vm.horaire=horaire,vm.appelEffectue=!1,vm.promiseContents=AppelEtudeService.getAppelEtude(vm.horaire,vm.paramAppelEtude.idEtab).then(function(response){vm.listEleves=[],vm.appelEtudeEffectue=void 0,vm.appelEtudeTagEnvoye=void 0,vm.appelEtudeTagRecu=void 0,angular.isDefined(response)&&(vm.listEleves=response.eleves,angular.isDefined(response.appelEtude)&&(vm.appelEtudeEffectue=response.appelEtude.appelEffectue,vm.appelEtudeTagEnvoye=response.appelEtude.tagEnvoye,vm.appelEtudeTagRecu=response.appelEtude.tagRecu))})}function selectPlageHoraireActuel(){var nowStr=moment().format("HH:mm");angular.forEach(vm.listHoraire,function(plage){return plage.heure_debut<nowStr&&plage.heure_fin>nowStr?(onSelectHoraire(plage),!0):void 0})}function refuserEleve(eleve){eleve.isPresent=!1,Notification.notify("Appel en étude","L'élève <strong>"+$filter("displayNom")(eleve,!0)+"</strong> a bien été refusé","success",!0)}function setElevePresent(elv,isFromBadge){isFromBadge?elv.isPresent=!0:elv.isPresent=!elv.isPresent,elv.dateHeureBadgage=moment().format("YYYYMMDDHHmmss"),$rootScope.navigationDisabled=!0,vm.resultatScan={}}function listPresents(){return lodash.filter(vm.listEleves,function(ele){return ele.isPresent})}function ajouterClasse(){var modalInstance=$uibModal.open({templateUrl:"modules/appelEtude/modal.selectclasse.html",controller:"AppelEtudeChoixClasseCtrl as ctrlAppelEtudeChoixClasse",keyboard:!1,backdrop:!1});modalInstance.result.then(function(datas){datas&&angular.isDefined(datas.close)&&1===datas.close&&angular.isDefined(datas.classeToAdd)&&getEleveByClasse(datas.classeToAdd.id)})}function displayWarningEditRunning(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}function submitAppelEtude(){var modalInstance=$uibModal.open({templateUrl:"modules/appelEtude/modal.submitappel.html",scope:$scope,keyboard:!1,backdrop:!1});modalInstance.result.then(function(data){if(1===data){var tabPresents=listPresents();vm.promiseContents=AppelEtudeService.postAppelEtude(vm.paramAppelEtude.idEtab,vm.salle.id,vm.horaire,tabPresents).then(function(){vm.appelEffectue=!0,tabPresents.forEach(function(eleve){eleve.isPresent=!1}),$rootScope.navigationDisabled=!1,Notification.notify("Appel en étude enregistré","Votre appel en étude a bien été enregistré","success",!0)},function(error){Notification.notify("Erreur Appel en étude",error.data.message||"Une erreur est survenue","error",!0)})}})}function selectEleveByBadge(){if(vm.resultatScan={},""!==vm.leBadgeEleve){var res=vm.leBadgeEleve.split("||");3===res.length?"eleve"===res[0]?selectElevePresent(res[1],res[2],"QR_CODE"):Notification.notify("Erreur scan","Il ne s'agit pas d'un badge élève","error",!0):selectElevePresent(0,res[0],"CODE_39")}else Notification.notify("Erreur scan","Le scan est vide","error",!0);vm.leBadgeEleve=""}function selectElevePresent(eleveId,eleveBadgeNum,typeScan){if(isNumeric(eleveId)&&isNumeric(eleveBadgeNum)){var objIndex=-1;if(objIndex=eleveId>0?lodash.findIndex(vm.listEleves,function(elv){return elv.id.toString()===eleveId&&elv.numeroBadge.toString()===eleveBadgeNum}):lodash.findIndex(vm.listEleves,function(elv){return elv.numeroBadge.toString()===eleveBadgeNum}),objIndex>-1)setElevePresent(vm.listEleves[objIndex],!0),displayResultatScan(vm.listEleves[objIndex]);else{var objectScan={scan:{format:typeScan,text:vm.leBadgeEleve}};vm.promiseContents=ScanBadgeService.getBadge(objectScan).then(function(eleve){eleve.id>0?(setElevePresent(eleve,!0),vm.listEleves.push(eleve),displayResultatScan(eleve,!0)):Notification.notify("Erreur scan","Impossible de retrouver l'élève associé au badge","error",!0)},function(error){Notification.notify("Erreur scan",error.data.message||"Une erreur est survenue","error",!0)})}}else Notification.notify("Erreur scan","Le format du badge n'est pas valide","error",!0)}function displayResultatScan(eleve,isAnomalie){vm.resultatScan=eleve,vm.resultatScan.anomalie=isAnomalie,goToScrollElement(eleve.id),$rootScope.navigationDisabled=!0}function goToScrollElement(elemId){var divEleve=angular.element(document.getElementById("eleve_"+elemId));angular.isDefined(divEleve[0])&&divEleve[0].scrollIntoView()}function setFocus(elementID){setTimeout(function(){angular.isDefined(angular.element("#"+elementID).get(0))&&angular.element("#"+elementID).get(0).focus({preventScroll:!0})},500)}function displayTitle(){var title=vm.listEleves.length+" élèves ";return title+="("+vm.listPresents().length,title+=vm.listPresents().length<=1?" présent":" présents",title+=")"}function isEleveAnniversaire(eleve){var anniv=moment(eleve.dateNaissance,"YYYY-MM-DD");return anniv.format("MMDD")===moment().format("MMDD")}function getEleveByClasse(idClasse){vm.promiseContents=PersonnelconsultationService.listeEleves(idClasse,"classes").then(function(eleves){if(angular.isDefined(eleves)){var nbEleveClasse=lodash(vm.listEleves).filter("classeId",idClasse).value().length;nbEleveClasse!==eleves.eleves.length?(angular.forEach(eleves.eleves,function(elv){0===lodash(vm.listEleves).filter("id",elv.id).value().length&&vm.listEleves.push(elv)}),Notification.notify("Appel en étude","Classe ajoutée avec succès","success",!0)):Notification.notify("Appel en étude","La classe est déjà ajoutée","warning",!0)}else Notification.notify("Appel en étude","Aucun élève trouvé","warning",!0)})}function refresh(){var paramAppelEtude=ModuleService.getModule(ModuleService.CODES.APPEL_ETUDE);angular.isDefined(paramAppelEtude.params.parametrage)&&(vm.listParamAppelEtude=angular.fromJson(paramAppelEtude.params.parametrage).paramAppelEtude)}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}var vm=this;vm.promiseContents=null,vm.paramAppelEtude=null,vm.salle=null,vm.horaire=null,vm.leBadgeEleve="",vm.appelEtudeEffectue=void 0,vm.appelEtudeTagEnvoye=void 0,vm.appelEtudeTagRecu=void 0,vm.listSalle=[],vm.listEleves=[],vm.listHoraire=[],vm.appelEffectue=!1,vm.ordre="ALPHA",vm.statusDropdown={isAppelParamOpen:!1,isHoraireOpen:!1,isSalleOpen:!1},vm.resultatScan={},vm.listParamAppelEtude=[],$rootScope.navigationDisabled=!1,vm.refresh=refresh,vm.onSelectParamAppelEtude=onSelectParamAppelEtude,vm.onSelectSalle=onSelectSalle,vm.onSelectHoraire=onSelectHoraire,vm.submitAppelEtude=submitAppelEtude,vm.setOrdre=setOrdre,vm.isEleveAnniversaire=isEleveAnniversaire,vm.selectEleveByBadge=selectEleveByBadge,vm.setFocus=setFocus,vm.listPresents=listPresents,vm.ajouterClasse=ajouterClasse,vm.getEleveByClasse=getEleveByClasse,vm.setElevePresent=setElevePresent,vm.displayTitle=displayTitle,vm.refuserEleve=refuserEleve,refresh()}]),angular.module("edsiteApp.AppelEtude").controller("AppelEtudeChoixClasseCtrl",["$uibModalInstance","UserService",function($uibModalInstance,UserService){function onSelectClasseAjouter(classe){vm.selectedClasseToAdd=classe}function close(data){$uibModalInstance.close({classeToAdd:vm.selectedClasseToAdd,close:data})}function refresh(){vm.promiseContents=UserService.getAllClassesByEtabs().then(function(etabs){vm.listeClasses=etabs})}var vm=this;vm.promiseContents=null,vm.selectedClasseToAdd=null,vm.refresh=refresh,vm.onSelectClasseAjouter=onSelectClasseAjouter,vm.close=close,refresh()}]),angular.module("edsiteApp.AppelEtude").service("AppelEtudeService",["$q","$http",function($q,$http){function postAppelEtude(idEtab,idSalle,plage,eleves){var defer=$q.defer(),data={eleves:eleves,salle:idSalle},baseUrl="appelEtude/"+idEtab+"/horaires/"+plage.heure_debut+"-"+plage.heure_fin;return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function getAppelEtude(plage,idEtab){var defer=$q.defer(),data={},baseUrl="appelEtude/"+idEtab+"/horaires/"+plage.heure_debut+"-"+plage.heure_fin;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}var mAppelEtude={};return mAppelEtude.postAppelEtude=postAppelEtude,mAppelEtude.getAppelEtude=getAppelEtude,mAppelEtude}]),angular.module("edsiteApp.base64filter",[]).filter("base64decode",["$log",function($log){return function(input){var decoded;if("undefined"==typeof input||""===input)return input;try{decoded=Base64.decode(input)}catch(e){try{decoded=window.atob(input)}catch(err){decoded=input}}return decoded}}]).filter("base64encode",["$log",function($log){return function(input){var encoded;if("undefined"==typeof input||""===input)return input;"string"==typeof input&&(input=input.replace(String.fromCharCode(8201)," "));try{encoded=Base64.encode(input)}catch(e){try{encoded=window.btoa(input)}catch(err){encoded=input}}return encoded}}]),angular.module("edsiteApp.filterTranslateTypeUser",["edsiteApp.Commun"]).filter("translateTypeUser",function(){return function(input){var types={A:"Personnel",P:"Enseignant",1:"Famille",2:"Famille",E:"Elève",W:"Espace de travail","default":input};return types[input]||types["default"]}}).filter("translateTypeUserUrl",function(){return function(type){var types={A:"personnels",P:"enseignants",1:"familles",2:"familles",E:"eleves",W:"W","default":type};return types[type]||types["default"]}}).filter("translateTypeUserToShortcut",["Auth",function(Auth){return function(type){return type.toLowerCase().match(/.*personnel.*/g)?"A":type.toLowerCase().match(/.*(enseignant|professeur).*/g)?"P":type.toLowerCase().match(/.*(eleve).*/g)?"E":type.toLowerCase().match(/.*(classes).*/g)?"C":type.toLowerCase().match(/.*(groupes).*/g)?"G":type.toLowerCase().match(/.*(ressource).*/g)?"R":type.toLowerCase().match(/.*(famille).*/g)?Auth.role():type}}]),angular.module("edsiteApp.Commun").factory("Utils",["Auth","$sessionStorage",function(Auth,$sessionStorage){var Utils={};return Utils.isTypePersonnel=function(type){return"A"===type||"adm"===type},Utils.isTypeProfesseur=function(type){return"P"===type||"prof"===type},Utils.isTypeEleve=function(type){return"E"===type||"el"===type},Utils.isTypeFamille=function(type){return"1"===type||"2"===type||"fam"===type},Utils.isTypeEspaceTravail=function(type){return"W"===type},Utils.getMatieres=function(){return Auth.isProf()?$sessionStorage.user.profile.prof.matieres:Auth.isFamille()?$sessionStorage.user.profile.famille.matieres:void 0},Utils.getFonctions=function(){return[{label:"Admin"},{label:"Directeur"},{label:"Directeur Adjoint"}]},Utils.displayWarningEditRunning=function(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 2em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})},Utils.isMobile=function(){var userAgent=navigator.userAgent.toLowerCase();return null!==userAgent.match(/iphone|ipad|android|mobile|mobi/i)},Utils.getTextColor=function(bgColor){var textColor="#000";if(angular.isUndefined(bgColor)||"transparent"===bgColor)return textColor;var c=bgColor.substring(1),rgb=parseInt(c,16),r=rgb>>16&255,g=rgb>>8&255,b=rgb>>0&255,luma=.2126*r+.7152*g+.0722*b;return 128>luma&&(textColor="#FFF"),textColor},Utils.isModeAccessibiliteVisuelleActif=function(){var modeAccessibilite=$sessionStorage["modeAccessibiliteVisuelleActif-"+Auth.role()+"-"+Auth.currentUser().id];return angular.isUndefined(modeAccessibilite)?!1:modeAccessibilite},Utils}]).filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!==lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" …")}}),angular.module("edsiteApp.modals",["ui.bootstrap"]).controller("ConfirmModalCtrl",["$scope","$uibModalInstance","config",function($scope,$uibModalInstance,config){function okFn(){$uibModalInstance.close()}function cancelFn(){$uibModalInstance.dismiss()}$scope.cancel=config.cancel,$scope.title=config.title,$scope.message=config.message,$scope.confirm=config.confirm,$scope.warningButton=config.warningButton?config.warningButton:"CANCEL",$scope.cancelFn=cancelFn,$scope.okFn=okFn}]),angular.module("edsiteApp.modals").controller("PromptModalCtrl",["$scope","$uibModalInstance","config",function($scope,$uibModalInstance,config){function okFn(input){$uibModalInstance.close(input)}function cancelFn(){$uibModalInstance.dismiss()}$scope.cancel=config.cancel,$scope.title=config.title,$scope.message=config.message,$scope.confirm=config.confirm,$scope.input=config.value,$scope.cancelFn=cancelFn,$scope.okFn=okFn}]),angular.module("edsiteApp.modals").controller("DialogModalCtrl",["$scope","$uibModalInstance","config",function($scope,$uibModalInstance,config){function closeFn(){$uibModalInstance.close()}$scope.title=config.title,$scope.message=config.message,$scope.close=config.close?config.close:"OK",$scope.closeFn=closeFn}]),angular.module("edsiteApp.modals").controller("MaxsizePromptModalCtrl",["$uibModalInstance","config",function($uibModalInstance,config){function okFn(input){$uibModalInstance.close(input)}function cancelFn(){$uibModalInstance.dismiss()}var vm=this;vm.cancel=config.cancel,vm.title=config.title,vm.message=config.message,vm.confirm=config.confirm,vm.input=config.value,vm.maxSaisie=config.maxSaisie,vm.cancelFn=cancelFn,vm.okFn=okFn}]),angular.module("edsiteApp.Postits",["ui.bootstrap","edsiteApp.Commun","edsiteApp.base64filter","edsiteApp.Commun","ng-sortable"]).directive("postits",function(){return{templateUrl:"modules/postits/postit-template.html",restrict:"E",scope:{configPostits:"=",user:"=",tabPostits:"=",espaceTravail:"=",refreshPostits:"&"},controller:"PostitsDirectiveCtrl"}}).controller("PostitsDirectiveCtrl",["$scope","$uibModal","$filter","$sce","$uibModalStack","PostitsService","EspacestravailService","Notification","lodash","Auth",function($scope,$uibModal,$filter,$sce,$uibModalStack,PostitsService,EspacestravailService,Notification,lodash,Auth){function refresh(){$scope.refreshPostits()}function sanitize(content){var decodedContent=$filter("base64decode")(content),replacer=/<script[^>]*>(?:(?!<\/script>)[^])*<\/\s?script>/gi,stripped=decodedContent.replace(replacer,"");return replacer=/<\!--\[endif\]---->.*<\!--\!\[endif\]---->?/gi,stripped=stripped.replace(replacer,""),replacer=/<\?xml(.*)(office|microsoft)(.*)\/>/gi,stripped=stripped.replace(replacer,""),$sce.trustAsHtml(stripped)}function effacer(postit){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un post-it",config.message="Êtes-vous sûr de vouloir supprimer ce post-it ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){PostitsService.supprimer(postit.id).then(function(){Notification.notify("Post-it","Suppression de votre post-it effectuée !","success",!0),modalInstance.close(),refresh()},function(){Notification.notify("Post-it","Une erreur est survenue","error",!0)})})}function openDialog(action,postit){var modalEdit=$uibModal.open({templateUrl:"modules/postits/postit-formulaire.html",controller:"PostItEditCtrl",controllerAs:"EditPostitCtrl",backdrop:!1,resolve:{action:function(){return action},postit:function(){return postit},typesUser:function(){return $scope.typesUser},user:function(){return{type:$scope.user.type,id:$scope.user.id}},config:function(){return $scope.configPostits},espaceTravail:function(){return $scope.espaceTravail}},windowClass:"dialog-postit"});modalEdit.result.then(function(reponse){angular.isDefined(reponse)&&("modif"===reponse.action&&angular.extend(postit,reponse.postit),"ajout"===reponse.action&&refresh())},function(){})}function iconeFor(postit){var classesCss="",isCibleEleve=!1,isCibleProf=!1,isCiblePersonnel=!1,isCibleFamille=!1;return angular.forEach(postit.cible,function(code){(code.indexOf($scope.typesUser.ELEVE.code)>-1||$scope.typesUser.ELEVE.code===code)&&!isCibleEleve&&(classesCss+='<i class="fa icon-ed_eleve fa-2x text-eleve" title="Élève"></i> ',isCibleEleve=!0),(code.indexOf($scope.typesUser.FAMILLE.code)>-1||$scope.typesUser.FAMILLE.code===code)&&!isCibleFamille&&(isCibleFamille=!0,classesCss+='<i class="fa icon-ed_famille fa-2x text-famille" title="Famille"></i>'),(code.indexOf($scope.typesUser.PERSONNEL.code)>-1||$scope.typesUser.PERSONNEL.code===code)&&!isCiblePersonnel&&(isCiblePersonnel=!0,classesCss+='<i class="fa icon-ed_personnel fa-2x text-personnel" title="Personnel"></i>'),(code.indexOf($scope.typesUser.PROF.code)>-1||$scope.typesUser.PROF.code===code)&&!isCibleProf&&(isCibleProf=!0,
classesCss+='<i class="fa icon-ed_prof fa-2x text-enseignant" title="Enseignant"></i>')}),classesCss}function isPast(postit){var datePostit,perime=!1,now=moment().format("YYYY-MM-DD");return datePostit=""!==postit.dateFin?postit.dateFin:postit.dateCreation,datePostit=datePostit.replace(/\//g,"-"),datePostit=datePostit.split("-").reverse().join("-"),""!==postit.dateFin&&(perime=moment().isAfter(datePostit)&&!moment(now).isSame(datePostit)),perime}function updatePostitOrderNo(newIndex){$scope.tabPostits[newIndex].ordre=newIndex+1;var postitFormate=angular.copy($scope.tabPostits[newIndex]),dateDebutReverse=postitFormate.dateDebut,dateFinReverse=postitFormate.dateFin;null===postitFormate.dateFin&&(postitFormate.dateFin=""),null===postitFormate.dateDebut&&(postitFormate.dateDebut=""),angular.isDefined(postitFormate.dateFin)&&""!==postitFormate.dateFin&&("string"==typeof postitFormate.dateFin&&(dateFinReverse=postitFormate.dateFin.split("/").reverse().join("/")),postitFormate.dateFin=moment(dateFinReverse).format("YYYYMMDD")),angular.isDefined(postitFormate.dateDebut)&&""!==postitFormate.dateDebut&&("string"==typeof postitFormate.dateDebut&&(dateDebutReverse=postitFormate.dateDebut.split("/").reverse().join("/")),postitFormate.dateDebut=moment(dateDebutReverse).format("YYYYMMDD")),$scope.promiseContents=PostitsService.modifierOrdrePostIt(postitFormate).then(function(){$scope.postIttabCopy=[],Notification.notify("Post-it","Modification de votre post-it effectuée !","success",!0)})["catch"](function(){$scope.tabPostits=angular.copy($scope.postIttabCopy),$scope.postIttabCopy=[],Notification.notify("Post-it","Une erreur s'est produite lors de la mise à jour de l'ordre","error",!0)})}function isAuteurOrAdmin(postit){return angular.isDefined($scope.espaceTravail)&&$scope.espaceTravail.estAdmin||+postit.auteur.id===Auth.currentUser().id&&postit.auteur.type===Auth.currentUser().typeCompte||Auth.isPersonnel()}$scope.refresh=refresh,$scope.effacer=effacer,$scope.openDialog=openDialog,$scope.sanitize=sanitize,$scope.isPast=isPast,$scope.iconeFor=iconeFor,$scope.isAuteurOrAdmin=isAuteurOrAdmin,$scope.tabCouleurs=PostitsService.COLORS,$scope.Auth=Auth,$scope.typesUser=PostitsService.TYPE_USER,$scope.postIttabCopy=[],$scope.sortableConf={draggable:$scope.configPostits.addPostit?".item-postit":"",onStart:function(){$scope.postIttabCopy=angular.copy($scope.tabPostits)},onEnd:function(evt){updatePostitOrderNo(evt.newIndex)}}}]).controller("PostItEditCtrl",["$uibModalInstance","action","postit","typesUser","user","config","espaceTravail","PostitsService","$filter","$uibModalStack","Notification","UserService","lodash",function($uibModalInstance,action,postit,typesUser,user,config,espaceTravail,PostitsService,$filter,$uibModalStack,Notification,UserService,lodash){function update(postIT){var postitFormate=angular.copy(postIT),dateDebutReverse=postitFormate.dateDebut,dateFinReverse=postitFormate.dateFin;if(null===postitFormate.dateFin&&(postitFormate.dateFin=""),null===postitFormate.dateDebut&&(postitFormate.dateDebut=""),0===postIT.ciblesEtab.length&&vm.isCibleFamilleOrEleve)return void Notification.notify("Post-it","Veuillez sélectionner au minimum un établissement.","error",!0);if(postIT.contenu.length>1572864)return void Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo).","danger");if(postIT.cible.length>0){var cibleFinale=[],nbEtab=0;0===postIT.ciblesEtab.length?lodash.forEach(postIT.cible,function(cibleUser){cibleFinale.push(cibleUser)}):lodash.forEach(postIT.ciblesEtab,function(cibleEtab){lodash.forEach(postIT.cible,function(cibleUser){cibleUser===vm.typesUser.FAMILLE.code||cibleUser===vm.typesUser.ELEVE.code?cibleFinale.push(cibleUser+cibleEtab):0===nbEtab&&cibleFinale.push(cibleUser)}),nbEtab++}),postitFormate.cible=cibleFinale,postitFormate.contenu=$filter("base64encode")(postIT.contenu),angular.isDefined(postitFormate.dateFin)&&""!==postitFormate.dateFin&&("string"==typeof postitFormate.dateFin&&(dateFinReverse=postitFormate.dateFin.split("/").reverse().join("/")),postitFormate.dateFin=moment(dateFinReverse).format("YYYYMMDD")),angular.isDefined(postitFormate.dateDebut)&&""!==postitFormate.dateDebut&&("string"==typeof postitFormate.dateDebut&&(dateDebutReverse=postitFormate.dateDebut.split("/").reverse().join("/")),postitFormate.dateDebut=moment(dateDebutReverse).format("YYYYMMDD")),vm.promiseContents=PostitsService.modifier(postitFormate).then(function(){null===postIT.dateDebut&&(postIT.dateDebut=""),postitFormate.dateDebut=postIT.dateDebut,"string"!=typeof postitFormate.dateDebut&&(postitFormate.dateDebut=moment(postIT.dateDebut).format("DD/MM/YYYY")),null===postIT.dateFin&&(postIT.dateFin=""),postitFormate.dateFin=postIT.dateFin,"string"!=typeof postitFormate.dateFin&&(postitFormate.dateFin=moment(postIT.dateFin).format("DD/MM/YYYY")),Notification.notify("Post-it","Modification de votre post-it effectuée !","success",!0),postitFormate.cible=postIT.cible,$uibModalInstance.close({action:"modif",postit:postitFormate}),vm.isCibleFamilleOrEleve=checkCiblesSelected(postitFormate)},function(result){512===result.code?Notification.notify("Post-it","Veuillez saisir une date supérieure à la date du jour !","error",!0):Notification.notify("Post-it","Une erreur est survenue","error",!0)})}else Notification.notify("Post-it","Veuillez saisir au minimum une personne cible.","error",!0)}function save(postit,cibles){var postitFormate=angular.copy(postit);if(angular.isDefined(cibles)&&(postitFormate.cible=cibles),vm.configPostits.displayFormTargets&&0===postitFormate.ciblesEtab.length&&vm.isCibleFamilleOrEleve)return void Notification.notify("Post-it","Veuillez sélectionner au minimum un établissement.","error",!0);if(postitFormate.cible.length>0){if(vm.configPostits.displayFormTargets){var cibleFinale=[],nbEtab=0;0===postitFormate.ciblesEtab.length?lodash.forEach(postitFormate.cible,function(cibleUser){cibleFinale.push(cibleUser)}):lodash.forEach(postitFormate.ciblesEtab,function(cibleEtab){lodash.forEach(postitFormate.cible,function(cibleUser){cibleUser===vm.typesUser.FAMILLE.code||cibleUser===vm.typesUser.ELEVE.code?cibleFinale.push(cibleUser+cibleEtab):0===nbEtab&&cibleFinale.push(cibleUser)}),nbEtab++}),postitFormate.cible=cibleFinale}postitFormate.contenu=$filter("base64encode")(postit.contenu),angular.isDefined(postitFormate.dateFin)&&postitFormate.dateFin&&null!==postitFormate.dateFin&&(postitFormate.dateFin=moment(postitFormate.dateFin).format("YYYYMMDD")),null===postitFormate.dateFin&&(postitFormate.dateFin=""),angular.isDefined(postitFormate.dateDebut)&&postitFormate.dateDebut&&null!==postitFormate.dateDebut&&(postitFormate.dateDebut=moment(postitFormate.dateDebut).format("YYYYMMDD")),null===postitFormate.dateDebut&&(postitFormate.dateDebut=""),postitFormate.ordre=1,vm.promiseContents=PostitsService.ajouter(vm.user.type,vm.user.id,postitFormate).then(function(){Notification.notify("Post-it","Enregistrement de votre post-it effectué !","success",!0),$uibModalInstance.close({action:"ajout",postit:{}})},function(result){512===result.code?Notification.notify("Post-it","Veuillez saisir une date supérieure à la date du jour !","error",!0):Notification.notify("Post-it","Une erreur est survenue","error",!0)})}else Notification.notify("Post-it","Veuillez sélectionner au minimum une cible.","error",!0)}function updateCible(code,postit){PostitsService.updateCible(code,postit),vm.isCibleFamilleOrEleve=checkCiblesSelected(postit),vm.isCibleFamilleOrEleve||(postit.ciblesEtab=[])}function updateCibleEtab(idEtab,postit){PostitsService.updateCiblesEtab(idEtab,postit)}function resetPostits(){postit=vm.originalPostit}function setTypePostit(lePostit){var libelleCouleurFound=lodash.findKey(vm.tabCouleurs,function(couleur){return couleur===lePostit.couleur});lePostit.type=libelleCouleurFound}function checkCiblesSelected(postit){if(!angular.isUndefined(postit)){var cibleFound=lodash.find(postit.cible,function(cibleUser){return cibleUser===vm.typesUser.FAMILLE.code||cibleUser===vm.typesUser.ELEVE.code});return angular.isDefined(cibleFound)}}var vm=this;vm.tabColorsDispos=lodash.valuesIn(PostitsService.COLORS),vm.tabCouleurs=PostitsService.COLORS,vm.action="",vm.today=new Date,vm.labelToday="Aujourd'hui",vm.labelClear="Annuler",vm.labelClose="Fermer",vm.originalPostit=angular.copy(postit),vm.action=action,vm.typesUser=typesUser,vm.user=user,vm.configPostits=config,vm.editorOptions={height:150,toolbar:"full",extraPlugins:"colorbutton,font,base64image",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]},{name:"links",items:["Link","Unlink","base64image"]}],removePlugins:"elementspath"},vm.update=update,vm.save=save,vm.updateCible=updateCible,vm.updateCibleEtab=updateCibleEtab,vm.resetPostits=resetPostits,vm.checkCiblesSelected=checkCiblesSelected,vm.setTypePostit=setTypePostit,vm.isCibleFamilleOrEleve=checkCiblesSelected(postit),"ajouter"===action&&(vm.libelleForm="Ajout",vm.postit={type:"info",couleur:vm.tabCouleurs.info}),vm.configPostits.displayFormTargets&&(vm.promiseContents=UserService.getClassesAllByNiveauxByEtabs().then(function(datas){vm.etablissements=lodash.filter(datas,{optionType:"etab"}),"ajouter"===action&&(vm.postit={type:"info",couleur:vm.tabCouleurs.info,cible:[],ciblesEtab:[]},vm.configPostits.displayTargets===!0&&lodash.forEach(vm.etablissements,function(etab){vm.postit.ciblesEtab.push(etab.etabId)}))})),"modifier"===action&&(vm.libelleForm="Modification",vm.postit=angular.copy(postit),vm.postit.contenu=$filter("base64decode")(postit.contenu),vm.postit.couleur=vm.tabCouleurs[vm.postit.type]),vm.clear=function(){vm.postit.dateDebut=null,vm.postit.dateFin=null},vm.openDebut=function($event){$event.preventDefault(),$event.stopPropagation(),vm.openedDebut=!0},vm.openFin=function($event){$event.preventDefault(),$event.stopPropagation(),vm.openedFin=!0},vm.close=function(){$uibModalInstance.close()},vm.dateOptions={formatYear:"yy",startingDay:1},vm.format="dd/MM/yyyy"}]),angular.module("edsiteApp").directive("inputFiles",["$uibModal","Notification","$sessionStorage","lodash","$rootScope","$http","$timeout",function($uibModal,Notification,$sessionStorage,lodash,$rootScope,$http,$timeout){return{templateUrl:"scripts/directives/input-files/inputfiles.html",restrict:"E",scope:{dropzoneConfig:"=",files:"=",config:"=",typeFichier:"=",onSuccessUpload:"&",checkFileSize:"&",contextSource:"=",onRemovedFile:"&"},link:function(scope,element){function initDropZone(scope,element){function removeUploadingFile(){var files;files=myDropzone.getQueuedFiles(),angular.forEach(files,function(file){myDropzone.removeFile(file)}),files=myDropzone.getUploadingFiles(),angular.forEach(files,function(file){myDropzone.removeFile(file)})}function openCloudFinder(){var modalInstance=$uibModal.open({templateUrl:"modules/cloud/cloudfinder.html",controller:"CloudfinderCtrl",size:"lg"});modalInstance.result.then(function(fichier){function completeUploadFromCloud(){if(config.keepComplete){var previewsZone=angular.element(".previews",element[0]),newNode=angular.element(previewCloudTemplate).clone();newNode.find("[data-name]").text(fichier.libelle),newNode.find("[data-size]").text(fichier.size),newNode.find("[data-remove]").on("click",function(){scope.files.splice(scope.files.indexOf(fichier),1),newNode.remove()}),previewsZone.append(newNode)}scope.files.push(fichier),scope.config.onCompleteUploadFromCloud(fichier)}if(""===scope.config.mode)completeUploadFromCloud();else{var data=angular.copy(myDropzone.options.params);data.id=fichier.id,$http({method:"POST",url:"televersementFromCloud?verbe=post&mode="+scope.config.mode,data:data}).success(function(){completeUploadFromCloud()}).error(function(){Notification.notify("Erreur","Impossible de téléverser le fichier.","error")})}})}var filesDic={},config={fromCloudEnabled:!0,fromLocalEnabled:!0,onCompleteUploadFromCloud:function(){},mode:"",libelleTitre:"Déposez vos fichiers ici, ou sélectionnez un fichier à l'aide du bouton."};scope.config=angular.extend(config,scope.config);var ERROR_FILE_NAME="Nom de fichier invalide";config.fromCloudEnabled&&angular.element(".fileinput-buttonfromcloud",element[0]).on("click",openCloudFinder);var previewCloudTemplateNode=angular.element("#cloudtemplate",element[0]);previewCloudTemplateNode.id="";var previewCloudTemplate=previewCloudTemplateNode.html();previewCloudTemplateNode.remove();var previewNode=angular.element("#template",element[0]);previewNode.id="";var previewTemplate=previewNode.parent().html();previewNode.remove();var ancreElement=angular.element(config.dropzoneContainer)[0];angular.isUndefined(ancreElement.dropzone)||delete ancreElement.dropzone;var myDropzone=new Dropzone(ancreElement,angular.extend({url:scope.config.url,thumbnailWidth:80,thumbnailHeight:80,parallelUploads:3,previewTemplate:previewTemplate,timeout:3e6,maxFilesize:2e3,previewsContainer:config.dropzoneContainer+" .previews",clickable:".fileinput-button",dictMaxFilesExceeded:"Vous avez atteint le nombre maximum de fichiers",dictFileTooBig:"Le fichier est trop volumineux ({{filesize}}Mo). Taille maximum requise : {{maxFilesize}}Mo.",params:{data:JSON.stringify({token:$sessionStorage.token})},init:function(){this.dragEnteredEls=[]},dragenter:function(e){this.dragEnteredEls.push(e.target)},dragleave:function(e){lodash.remove(this.dragEnteredEls,function(elem){return angular.equals(elem,e.target)}),0===this.dragEnteredEls.length&&angular.element(".dz-drag-hover").removeClass("dz-drag-hover")},accept:function(file,done){file.name.indexOf(":")>-1&&done(ERROR_FILE_NAME),done()}},scope.dropzoneConfig));scope.$watch(function(){return scope.dropzoneConfig.url},function(newValue){myDropzone.options.url=newValue}),scope.$watch(function(){return scope.dropzoneConfig.params},function(newValue){myDropzone.options.params=newValue});var modalInstance,jsonParams=angular.copy(myDropzone.options.params);myDropzone.on("addedfile",function(file){angular.isDefined(myDropzone.options.maxFiles)&&1===myDropzone.options.maxFiles&&myDropzone.files.length>1&&myDropzone.removeFile(myDropzone.files[0]),angular.isDefined(myDropzone.options.params)&&angular.isUndefined(myDropzone.options.params.data)?myDropzone.options.params={data:JSON.stringify(angular.extend({},{token:$sessionStorage.token},angular.copy(myDropzone.options.params)))}:angular.isUndefined(myDropzone.options.params)&&(myDropzone.options.params={data:JSON.stringify(angular.extend({},{token:$sessionStorage.token},jsonParams))});var maxFileSize=scope.$apply("checkFileSize()");"undefined"!=typeof maxFileSize&&file.size>maxFileSize&&(myDropzone.removeFile(file),Notification.notify("Erreur","L'espace disponible est insufisant pour téléverser ce fichier","error"))}),myDropzone.on("sending",function(file,xhr,formData){if("undefined"!=typeof scope.contextSource&&"cloud"===scope.contextSource&&file.fullPath){var paramDataXHR=JSON.parse(formData.get("data"));paramDataXHR.fullPath=file.fullPath,formData.set("data",JSON.stringify(paramDataXHR))}}),myDropzone.on("success",function(file,response){("string"==typeof response||response instanceof String)&&(response=JSON.parse(response));var isFileUploadOk=!0;if(response.code>=300||235===response.code){var message=""!==response.message?response.message:"Une erreur s'est produite lors de l'envoi du fichier";Notification.notify("Erreur",message,"error"),isFileUploadOk=!1,(525===response.code||520===response.code)&&($rootScope.$broadcast("token-expired"),myDropzone.removeAllFiles(!0))}var pj={unc:response.message,libelle:file.name,data:response.data,code:response.code,message:response.message};filesDic[file]=pj,isFileUploadOk?(angular.isDefined(myDropzone.options.maxFiles)&&1===myDropzone.options.maxFiles&&(scope.files.length=0),scope.files.push(pj),scope.$apply(scope.onSuccessUpload),config.keepComplete||myDropzone.removeFile(file),angular.element(".dz-success .progress.progress-striped.active").html('<i class="fa fa-check fa-lg text-success"></i>'),angular.element(".dz-success .progress.progress-striped.active").removeClass("progress progress-striped active")):myDropzone.removeFile(file)}),myDropzone.on("error",function(file,serverResponse){Notification.notify("Erreur : "+file.name,serverResponse,"error")}),myDropzone.on("removedfile",function(file){if(file in filesDic){var leFileToRemove=filesDic[file];scope.files.splice(scope.files.indexOf(leFileToRemove),1),scope.$apply(scope.onRemovedFile)}}),myDropzone.on("processing",function(){modalInstance||(modalInstance=$uibModal.open({templateUrl:"../scripts/directives/input-files/uploading-dialog.template.html",controller:"UploadingDialogCtrl",size:"md",scope:scope,backdrop:!1,keyboard:!1,resolve:{config:function(){var config={};return config.title="Téléversement ",config.cancel="Annuler le téléversement",config}}}),modalInstance.result.then(function(){modalInstance=void 0},function(){removeUploadingFile(),modalInstance=void 0}))}),myDropzone.on("totaluploadprogress",function(uploadProgress){var pourcentageProgress=parseInt(uploadProgress);scope.$broadcast("updateProgress",pourcentageProgress),scope.totalProgress=pourcentageProgress}),myDropzone.on("queuecomplete",function(){modalInstance&&(modalInstance.close(),modalInstance=void 0)})}angular.isUndefined(angular.element(scope.config.dropzoneContainer)[0])?$timeout(function(){initDropZone(scope,element)},0):initDropZone(scope,element)}}}]),angular.module("edsiteApp").controller("UploadingDialogCtrl",["$scope","$uibModalInstance","config","$interval",function($scope,$uibModalInstance,config,$interval){function okFn(){$uibModalInstance.close()}function cancelFn(){$uibModalInstance.dismiss()}var progress=0;$scope.cancel=config.cancel,$scope.title=config.title,$scope.message=config.message,$scope.confirm=config.confirm,$scope.cancelFn=cancelFn,$scope.okFn=okFn,$scope.$on("updateProgress",function(event,_progress){progress=_progress}),$scope.idx=0;var intervalProgress=$interval(function(){$scope.totalProgress=progress},500);$scope.$on("$destroy",function(){$interval.cancel(intervalProgress)})}]),angular.module("edsiteApp").value("THROTTLE_MILLISECONDS",null).directive("infiniteScroll",["$rootScope","$window","$interval","THROTTLE_MILLISECONDS",function($rootScope,$window,$interval,THROTTLE_MILLISECONDS){return{scope:{infiniteScroll:"&",infiniteScrollContainer:"=",infiniteScrollDistance:"=",infiniteScrollDisabled:"=",infiniteScrollUseDocumentBottom:"=",infiniteScrollListenForEvent:"@"},link:function(scope,elem,attrs){var changeContainer,checkWhenEnabled,container,handleInfiniteScrollContainer,handleInfiniteScrollDisabled,handleInfiniteScrollDistance,handleInfiniteScrollUseDocumentBottom,handler,height,immediateCheck,offsetTop,pageYOffset,scrollDistance,scrollEnabled,throttle,unregisterEventListener,useDocumentBottom,windowElement;return windowElement=angular.element($window),scrollDistance=null,scrollEnabled=null,checkWhenEnabled=null,container=null,immediateCheck=!0,useDocumentBottom=!1,unregisterEventListener=null,height=function(elem){return elem=elem[0]||elem,isNaN(elem.offsetHeight)?elem.document.documentElement.clientHeight:elem.offsetHeight},offsetTop=function(elem){return elem[0].getBoundingClientRect&&!elem.css("none")?elem[0].getBoundingClientRect().top+pageYOffset(elem):void 0},pageYOffset=function(elem){return elem=elem[0]||elem,isNaN(window.pageYOffset)?elem.document.documentElement.scrollTop:elem.ownerDocument.defaultView.pageYOffset},handler=function(){var containerBottom,containerTopOffset,elementBottom,remaining,shouldScroll;return container===windowElement?(containerBottom=height(container)+pageYOffset(container[0].document.documentElement),elementBottom=offsetTop(elem)+height(elem)):(containerBottom=height(container),containerTopOffset=0,void 0!==offsetTop(container)&&(containerTopOffset=offsetTop(container)),elementBottom=offsetTop(elem)-containerTopOffset+height(elem)),useDocumentBottom&&(elementBottom=height((elem[0].ownerDocument||elem[0].document).documentElement)),remaining=elementBottom-containerBottom,shouldScroll=remaining<=height(container)*scrollDistance+1,shouldScroll?(checkWhenEnabled=!0,scrollEnabled?scope.$$phase||$rootScope.$$phase?scope.infiniteScroll():scope.$apply(scope.infiniteScroll):void 0):checkWhenEnabled=!1},throttle=function(func,wait){var later,previous,timeout;return timeout=null,previous=0,later=function(){var context;return previous=(new Date).getTime(),$interval.cancel(timeout),timeout=null,func.call(),context=null},function(){var now,remaining;return now=(new Date).getTime(),remaining=wait-(now-previous),0>=remaining?(clearTimeout(timeout),$interval.cancel(timeout),timeout=null,previous=now,func.call()):timeout?void 0:timeout=$interval(later,remaining,1)}},null!==THROTTLE_MILLISECONDS&&(handler=throttle(handler,THROTTLE_MILLISECONDS)),scope.$on("$destroy",function(){return container.unbind("scroll",handler),null!==unregisterEventListener?(unregisterEventListener(),unregisterEventListener=null):void 0}),handleInfiniteScrollDistance=function(v){return scrollDistance=parseFloat(v)||0},scope.$watch("infiniteScrollDistance",handleInfiniteScrollDistance),handleInfiniteScrollDistance(scope.infiniteScrollDistance),handleInfiniteScrollDisabled=function(v){return scrollEnabled=!v,scrollEnabled&&checkWhenEnabled?(checkWhenEnabled=!1,handler()):void 0},scope.$watch("infiniteScrollDisabled",handleInfiniteScrollDisabled),handleInfiniteScrollDisabled(scope.infiniteScrollDisabled),handleInfiniteScrollUseDocumentBottom=function(v){return useDocumentBottom=v},scope.$watch("infiniteScrollUseDocumentBottom",handleInfiniteScrollUseDocumentBottom),handleInfiniteScrollUseDocumentBottom(scope.infiniteScrollUseDocumentBottom),changeContainer=function(newContainer){return null!==container&&container.unbind("scroll",handler),container=newContainer,angular.isDefined(newContainer)?container.bind("scroll",handler):void 0},changeContainer(windowElement),scope.infiniteScrollListenForEvent&&(unregisterEventListener=$rootScope.$on(scope.infiniteScrollListenForEvent,handler)),handleInfiniteScrollContainer=function(newContainer){if(!angular.isUndefined(newContainer)&&0!==newContainer.length){if(newContainer instanceof HTMLElement?newContainer=angular.element(newContainer):"function"==typeof newContainer.append?newContainer=angular.element(newContainer[newContainer.length-1]):"string"==typeof newContainer&&(newContainer=angular.element(document.querySelector(newContainer))),angular.isDefined(newContainer))return changeContainer(newContainer);throw new Error("invalid infinite-scroll-container attribute.")}},scope.$watch("infiniteScrollContainer",handleInfiniteScrollContainer),handleInfiniteScrollContainer(scope.infiniteScrollContainer||[]),angular.isDefined(attrs.infiniteScrollParent)&&changeContainer(angular.element(elem.parent())),angular.isDefined(attrs.infiniteScrollImmediateCheck)&&(immediateCheck=scope.$eval(attrs.infiniteScrollImmediateCheck)),$interval(function(){return immediateCheck?handler():void 0},0,1)}}}]),angular.module("edsiteApp.RPP").factory("ReunionParentProfService",["$http","$q","$filter","lodash","EDHttp","CacheService",function($http,$q,$filter,lodash,EDHttp,CacheService){function decorateReunions(reunions){var lesReunions=[];return angular.forEach(reunions,function(reunion){var newReunion={};newReunion.parametrage=reunion.parametrage,newReunion.enseignants=reunion.enseignants,newReunion.plages=[],newReunion.isClose=!1,moment().isAfter(moment(reunion.parametrage.dateFinReservation),"day")&&(newReunion.isClose=!0);for(var idx=0;idx<reunion.parametrage.plages;idx++){var horaire={};horaire.libelle=moment(reunion.parametrage.heureDebut,"HH:mm").add(reunion.parametrage.dureeRdv*idx,"minutes").format("HH:mm"),horaire.creneaux=[];for(var y=0;y<newReunion.enseignants.length;y++){var creneau={};creneau.enseignantId=newReunion.enseignants[y].id,creneau.enseignantLibelle=$filter("displayNom")(newReunion.enseignants[y],!1,!0),creneau.horaire=horaire.libelle;var creneauFerme=lodash.find(reunion.creneauxFermes,{enseignantId:newReunion.enseignants[y].id,horaire:horaire.libelle});creneau.etat=lodash.isEmpty(creneauFerme)?ETAT.disponible:ETAT.bloque;var mesCreneaux=lodash.find(reunion.mesCreneaux,{enseignantId:newReunion.enseignants[y].id,horaire:horaire.libelle});creneau.etat=lodash.isEmpty(mesCreneaux)?creneau.etat:ETAT.parMoi,horaire.creneaux.push(creneau)}newReunion.plages.push(horaire)}lesReunions.push(newReunion),Helper.setStateForReunion(newReunion)}),lesReunions}var ETAT={impossible:"IMPOSSIBLE",disponible:"DISPONIBLE",parMoi:"PARMOI",bloque:"BLOQUE"},Helper={};return Helper.ETATS=ETAT,Helper.getEnseignantRPP=function(idProf){var defer=$q.defer(),data={},baseUrl="enseignants/"+idProf+"/reunions";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){response.data.data.reunions=lodash.sortBy(response.data.data.reunions,function(reunion){return moment(reunion.parametrage.date).valueOf()}),defer.resolve(response.data.data.reunions)}),defer.promise},Helper.getReunionsParentProfResume=function(idEleve){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/reunions?isResume=1";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){response.data.data.reunions=lodash.sortBy(response.data.data.reunions,function(reunion){return moment(reunion.parametrage.date).valueOf()});var reunions=decorateReunions(response.data.data.reunions);defer.resolve(reunions)}),defer.promise},Helper.getReunionsParentProf=function(idEleve){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/reunions";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){response.data.data.reunions=lodash.sortBy(response.data.data.reunions,function(reunion){return moment(reunion.parametrage.date).valueOf()});var reunions=decorateReunions(response.data.data.reunions);defer.resolve(reunions)}),defer.promise},Helper.setStateForReunion=function(reunion){lodash.chain(reunion.plages).pluck("creneaux").flatten().tap(function(array){lodash.remove(array,{etat:ETAT.bloque}),lodash.remove(array,{etat:ETAT.parMoi})}).forEach(function(creneau){creneau.etat=ETAT.disponible}).value(),lodash.chain(reunion.plages).pluck("creneaux").flatten().where({etat:ETAT.parMoi}).forEach(function(creneau){if(lodash.chain(reunion.plages).pluck("creneaux").flatten().where({horaire:creneau.horaire}).tap(function(array){lodash.remove(array,{etat:ETAT.parMoi}),lodash.remove(array,{etat:ETAT.bloque})}).forEach(function(creneau){creneau.etat=ETAT.impossible}).value(),lodash.chain(reunion.plages).pluck("creneaux").flatten().where({enseignantId:creneau.enseignantId}).tap(function(array){lodash.remove(array,{etat:ETAT.parMoi}),lodash.remove(array,{etat:ETAT.bloque})}).forEach(function(creneau){creneau.etat=ETAT.impossible}).value(),!reunion.parametrage.isConsecutifActive){var previousHoraireToCheck=moment(creneau.horaire,"HH:mm").subtract(reunion.parametrage.dureeRdv,"minutes").format("HH:mm"),nextHoraireToCheck=moment(creneau.horaire,"HH:mm").add(reunion.parametrage.dureeRdv,"minutes").format("HH:mm"),previousHoraireCreneaux=lodash.chain(reunion.plages).pluck("creneaux").flatten().where({horaire:previousHoraireToCheck}).where({etat:ETAT.disponible}).valueOf(),nextHoraireCreneaux=lodash.chain(reunion.plages).pluck("creneaux").flatten().where({horaire:nextHoraireToCheck}).where({etat:ETAT.disponible}).valueOf();lodash.forEach(previousHoraireCreneaux,function(creneau){creneau.etat=ETAT.impossible}),lodash.forEach(nextHoraireCreneaux,function(creneau){creneau.etat=ETAT.impossible})}}).value()},Helper.reserveCreneau=function(reunion,creneau,idEleve){var defer=$q.defer(),baseUrl="eleves/"+idEleve+"/reunions/"+reunion.parametrage.id,data={horaire:creneau.horaire,enseignantId:creneau.enseignantId};return CacheService.remove("eleves/"+idEleve+"/reunions"),$http({method:"PUT",url:baseUrl,data:data}).then(function(response){var data=response.data;if(data.code>=300)return defer.reject(data.message);creneau.etat=creneau.etat===ETAT.parMoi?ETAT.disponible:ETAT.parMoi,Helper.setStateForReunion(reunion);var message="Votre rendez-vous a bien été pris en compte.";creneau.etat===ETAT.disponible&&(message="Votre rendez-vous a bien été annulé."),defer.resolve(message)},function(error){defer.reject(error)}),defer.promise},Helper}]),angular.module("edsiteApp.emploiDuTemps").factory("EmploiDuTempsService",["$q","$http","Auth","lodash","EspacestravailService","ModuleService","$sessionStorage","GroupesFlexiblesService",function($q,$http,Auth,lodash,EspacestravailService,ModuleService,$sessionStorage,GroupesFlexiblesService){var Helper={};return Helper.scheduler={mode:"week",config:{xml_date:"%Y-%m-%d %H:%i"}},Helper.exportPdfOptions={},Helper.searchEvents=function(typeUser,idUser,minDate,maxDate,avecTrous){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={dateDebut:minDate,dateFin:maxDate,avecTrous:avecTrous||!1},baseUrl=typeUser+"/"+idUser+"/emploidutemps";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){var events=lodash.sortBy(response.data.data,function(ev){return ev.start_date});angular.forEach(events,function(event){event.description=event.classe+event.groupe+" - "+event.salle}),Helper.events=events,defer.resolve(events)},function(error){defer.reject(error)}),defer.promise},Helper.getCours=function(){},Helper.dispenserCours=function(idEvent,idEleve,code){},Helper.agendasToDisplay=[],Helper.listeAgendasToDisplay=function(typeEntity,idEntity,withoutEspacesDeTravail){withoutEspacesDeTravail=angular.isDefined(withoutEspacesDeTravail)?withoutEspacesDeTravail:!1,Auth.isFamille()&&lodash.remove(Helper.agendasToDisplay,function(agenda){return"EDT"===agenda.typeAgenda});var nbAgenda=0,defer=$q.defer();if("C"===typeEntity||"G"===typeEntity||"S"===typeEntity||"E"===typeEntity||"P"===typeEntity){var libelle="";"C"===typeEntity&&(libelle=$sessionStorage["consultation-classe"].libelle),"G"===typeEntity&&(libelle=$sessionStorage["consultation-groupe"].libelle),"S"===typeEntity&&(libelle="Salle "+$sessionStorage["consultation-salle"].libelle),angular.isUndefined(lodash.find(Helper.agendasToDisplay,{typeEntity:typeEntity,idEntity:parseInt(idEntity),typeAgenda:"EDT"}))&&(Helper.agendasToDisplay.unshift({typeEntity:typeEntity,idEntity:parseInt(idEntity),typeAgenda:"EDT",libelle:"Emploi du temps "+libelle,edtCourant:!0,couleurAgenda:""}),nbAgenda++)}return withoutEspacesDeTravail?(defer.resolve(Helper.agendasToDisplay),defer.promise):(EspacestravailService.listeEspacesTravail(Auth.idUser(),Auth.role()).then(function(espacesTravail){lodash.forEach(espacesTravail,function(espaceT){angular.isUndefined(lodash.find(Helper.agendasToDisplay,{typeEntity:"W",idEntity:espaceT.id,typeAgenda:"W"}))&&Helper.agendasToDisplay.push({typeEntity:"W",idEntity:espaceT.id,typeAgenda:"W",libelle:espaceT.titre,couleurAgenda:espaceT.couleurEvenementAgenda})});var isEDTActif=ModuleService.isModuleEnabled(ModuleService.CODES.EDT);isEDTActif&&(Auth.isProfesseur()||Auth.isEleve())&&angular.isUndefined(lodash.find(Helper.agendasToDisplay,{typeEntity:Auth.role(),idEntity:Auth.idUser(),typeAgenda:"EDT"}))&&Helper.agendasToDisplay.unshift({typeEntity:Auth.role(),idEntity:Auth.idUser(),typeAgenda:"EDT",libelle:"Mon emploi du temps",couleurAgenda:""}),angular.isUndefined(lodash.find(Helper.agendasToDisplay,{typeEntity:Auth.role(),idEntity:Auth.idUser(),typeAgenda:"GEN"}))&&Helper.agendasToDisplay.unshift({typeEntity:Auth.role(),idEntity:Auth.idUser(),typeAgenda:"GEN",libelle:"Agenda général",couleurAgenda:Auth.currentUser().couleurAgendaEtablissement}),defer.resolve(Helper.agendasToDisplay)}),defer.promise)},Helper.listeGroupesFlexiblesInscriptions=[],Helper.getGroupesFlexibles=function(dateDebut,dateFin,idEleve){
var defer=$q.defer();return Auth.isEleve()||Auth.isFamille()?(GroupesFlexiblesService.getGroupesFlexibles(dateDebut,dateFin,idEleve).then(function(listeGroupes){Helper.listeGroupesFlexiblesInscriptions.length=0,angular.forEach(listeGroupes,function(groupe){angular.forEach(groupe.periodes,function(periode){Helper.listeGroupesFlexiblesInscriptions.push({idGroupe:groupe.id,libelle:groupe.libelle,isInscrit:periode.isInscrit,dateDebut:new Date(periode.dateDebut),dateFin:new Date(periode.dateFin),dateLimiteInscription:new Date(periode.dateLimiteInscription),isInscriptionLibre:periode.isInscriptionLibre,idPeriode:periode.id})})}),defer.resolve(Helper.listeGroupesFlexiblesInscriptions)},function(error){defer.reject(error)}),defer.promise):(defer.reject(),defer.promise)},Helper}]),angular.module("edsiteApp").filter("displayNom",["lodash","Auth",function(lodash,Auth){function reverseNom(account){var nom="";return angular.isUndefined(account)?nom:(angular.isDefined(account.civilite)&&""!==account.civilite&&(nom+=account.civilite+" "),angular.isDefined(account.particule)&&""!==account.particule&&(nom+=account.particule.toUpperCase()+" "),angular.isDefined(account.nom)&&""!==account.nom&&(nom+=account.nom.toUpperCase()+" "),angular.isDefined(account.prenom)&&""!==account.prenom&&(nom+=lodash.capitalize(account.prenom)+" "),nom.replace(/\s{2,}/g," "))}function defaultNom(account){var nom="";return angular.isUndefined(account)?nom:(angular.isDefined(account.civilite)&&""!==account.civilite&&(nom+=account.civilite+" "),angular.isDefined(account.prenom)&&""!==account.prenom&&(nom+=lodash.capitalize(account.prenom)+" "),angular.isDefined(account.particule)&&""!==account.particule&&(nom+=account.particule.toUpperCase()+" "),angular.isDefined(account.nom)&&""!==account.nom&&(nom+=account.nom.toUpperCase()+" "),nom.replace(/\s{2,}/g," "))}function confidentiality(account){return(Auth.isFamille()||Auth.isEleve())&&(account.profil===Auth.TYPE_USER.ENSEIGNANT||account.type===Auth.TYPE_USER.ENSEIGNANT||account.role===Auth.TYPE_USER.ENSEIGNANT)&&(account.civilite=void 0,account.prenom=account.prenom.substring(0,1)+"."),account}return function(account,reverse,restriction){var formateAccount=account;if("undefined"!=typeof account)return restriction&&(formateAccount=confidentiality(account)),reverse?reverseNom(formateAccount):defaultNom(formateAccount)}}]),angular.module("edsiteApp").filter("displayPeriodeSansR",["lodash",function(lodash){return function(periodes){var goodPeriodes=[],regexPeriodeRelevee=/A\d{3}R\d{3}/,reg=new RegExp(regexPeriodeRelevee);return lodash.forEach(periodes,function(periode){reg.test(periode.codePeriode)||goodPeriodes.push(periode)}),goodPeriodes}}]),angular.module("edsiteApp").directive("stickyTable",["$timeout",function($timeout){return{restrict:"E",transclude:!0,scope:{overflowY:"@"},template:'<div class="sticky-wrap" ng-class="{\'overflow-y\': overflowY}" ng-transclude></div>',link:function(scope,element,attrs){var principal=function(){var offset=attrs.offset,offsetElement=angular.element(offset).first(),heightOffset=angular.isUndefined(offsetElement)?0:offsetElement.height(),tableClass=attrs.tableClass,$t=angular.element(element[0]).find("table"),$w=angular.element(window),$thead=angular.element(element[0]).find("thead").clone(),$col=angular.element(element[0]).find("thead, tbody").clone();$t.addClass("sticky-enabled").css({margin:0,width:"100%"}),$t.hasClass("overflow-y")&&$t.removeClass("overflow-y").parent().addClass("overflow-y"),$t.after('<table class="sticky-thead '+tableClass+' " />'),$t.find("tbody th").length>0&&$t.after('<table class="sticky-col '+tableClass+' " /><table class="sticky-intersect '+tableClass+' " />');var $stickyHead=$t.siblings(".sticky-thead"),$stickyCol=$t.siblings(".sticky-col"),$stickyInsct=$t.siblings(".sticky-intersect"),$stickyWrap=$t.parent(".sticky-wrap");$stickyHead.append($thead),$stickyCol.append($col).find("thead th:gt(0)").remove().end().find("tbody td").remove(),$stickyInsct.html("<thead><tr><th>"+$t.find("thead th:first-child").html()+"</th></tr></thead>");var setWidths=function(){$t.find("thead th").each(function(i){$stickyHead.find("th").eq(i).width($(this).width())}).end().find("tr").each(function(i){$stickyCol.find("tr").eq(i).height($(this).height())}),$stickyHead.width($t.width()),$stickyCol.find("th").add($stickyInsct.find("th")).width($t.find("thead th:first").width()),$stickyInsct.find("th").height($t.find("thead th").height())},calcAllowance=function(){var a=0;return $t.find("tbody tr:lt(3)").each(function(){a+=$(this).height()}),a>.25*$w.height()&&(a=.25*$w.height()),a+=$stickyHead.height()},repositionStickyHead=function(){var allowance=calcAllowance();$t.height()>$stickyWrap.height()?$stickyWrap.scrollTop()>0?$stickyHead.add($stickyInsct).css({opacity:1,top:$stickyWrap.scrollTop()+heightOffset}):$stickyHead.add($stickyInsct).css({opacity:0,top:0}):$w.scrollTop()>$t.offset().top&&$w.scrollTop()<$t.offset().top+$t.outerHeight()-allowance?$stickyHead.add($stickyInsct).css({opacity:1,top:$w.scrollTop()-$t.offset().top+heightOffset}):$stickyHead.add($stickyInsct).css({opacity:0,top:0})},repositionStickyCol=function(){$stickyWrap.scrollLeft()>0?$stickyCol.add($stickyInsct).css({opacity:1,left:$stickyWrap.scrollLeft()}):$stickyCol.css({opacity:0}).add($stickyInsct).css({left:0})};setWidths();var repositionCall=function(){repositionStickyHead(),repositionStickyCol(),setWidths()},globalCall=function(){setWidths(),repositionStickyHead(),repositionStickyCol()};$t.parent(".sticky-wrap").scroll(jQuery.throttle(250,repositionCall)),$w.load(setWidths).resize(jQuery.debounce(250,globalCall)).scroll(jQuery.throttle(250,repositionStickyHead))};$timeout(principal,1100)}}}]),angular.module("edsiteApp.emploiDuTemps").controller("DispenserCoursCtrl",["$scope","$uibModalInstance","$routeParams","EmploiDuTempsService","config","event",function($scope,$uibModalInstance,$routeParams,EmploiDuTempsService,config,event){function step1(){$scope.step=1}function step2(){$scope.step=2}function dispenserCours(event,code){EmploiDuTempsService.dispenserCours(event.id,idEleve,code).then(function(){$uibModalInstance.close(!0)},function(){$uibModalInstance.close(!1)})}$scope.event=event,$scope.step1=step1,$scope.step2=step2,$scope.dispenserCours=dispenserCours,$scope.step=1,$scope.codeSecure=0;var idEleve=$routeParams.ideleve;$scope.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.3DSecure",["cgBusy","edsiteApp.Commun"]).directive("d3Secure",function(){return{restrict:"E",transclude:!0,scope:{codes:"=",fermer:"&",etape:"=?",contacts:"=?",enable:"=?"},templateUrl:"scripts/3DSecure/3D-secure.template.html",controller:["$scope","D3Secure","Notification",function($scope,D3Secure,Notification){function onTelChange(signataireSelected){$scope.codes.signataire=signataireSelected}function demandeDeCode(){$scope.busy=D3Secure.demandeDeCode($scope.codes.codeModule,angular.isDefined($scope.codes.signataire)?$scope.codes.signataire:void 0).then(function(){$scope.etape=2},function(){Notification.notify("Authentification SMS","L'authentification à échouée. Il est possible que vous n'ayez pas communiqué votre numéro de téléphone portable auprès de votre établissement.","error")})}function cancel(){$scope.etape=1}function goToEtape(etape){$scope.etape=etape}$scope.etape=1,$scope.contactSelected="undefined"!=typeof $scope.contacts?$scope.contacts[0]:void 0,$scope.enable="undefined"!=typeof $scope.enable?$scope.enable:!0,$scope.demandeDeCode=demandeDeCode,$scope.cancel=cancel,$scope.goToEtape=goToEtape,$scope.onTelChange=onTelChange,angular.isDefined($scope.contactSelected)&&$scope.onTelChange($scope.contactSelected)}],link:function(scope,element,attrs){if(!attrs.codes)throw new Error("D3Secure directive requires codes object attr");element.on("$destroy",function(){scope.codes.codeSecure=void 0})}}}).factory("D3Secure",["$q","$timeout","$http","Notification",function($q,$timeout,$http,Notification){var D3Secure={};return D3Secure.demandeDeCode=function(codeModule,signataire){var defer=$q.defer(),data={};angular.isDefined(signataire)&&(data.signataire=signataire);var baseUrl="3DSecure";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){Notification.notify("Authentification","Un SMS vient de vous être envoyé!","success"),defer.resolve(response)}).error(function(error){defer.reject(error)}),defer.promise},D3Secure.checkCode=function(codeSms){var defer=$q.defer(),data={code:codeSms},baseUrl="3DSecure";return $http({method:"POST",url:baseUrl,data:data}).success(function(response){Notification.notify("Authentification","Code valide <br> authentification réussie !","success"),defer.resolve(response)}).error(function(error){defer.reject(error)}),defer.promise},D3Secure}]).value("cgBusyDefaults",{message:"Veuillez patienter"}),function(){angular.module("edsiteApp.httpAuthInterceptor",["edsiteApp.httpAuthInterceptorBuffer"]).factory("httpAuthService",["$rootScope","httpBuffer",function($rootScope,httpBuffer){return{loginConfirmed:function(data,configUpdater){var updater=configUpdater||function(config){return config};$rootScope.$broadcast("auth-loginConfirmed",data),httpBuffer.retryAll(updater,data)},loginCancelled:function(reason){httpBuffer.rejectAll(reason),$rootScope.$broadcast("auth-loginCancelled")}}}]),angular.module("edsiteApp.httpAuthInterceptorBuffer",[]).factory("httpBuffer",["$injector",function($injector){function retryHttpRequest(config,deferred){function successCallback(response){deferred.resolve(response)}function errorCallback(response){deferred.reject(response)}$http=$http||$injector.get("$http"),$http(config).then(successCallback,errorCallback)}var $http,buffer=[];return{append:function(config,deferred){return buffer.push({config:config,deferred:deferred}),buffer.length},rejectAll:function(reason){if(reason)for(var i=0;i<buffer.length;++i)buffer[i].deferred.reject(reason);buffer=[]},retryAll:function(updater,newToken){for(var i=0;i<buffer.length;++i){var config=buffer[i].config,data=config.data.replace(/^data=/,""),jdata=JSON.parse(data);jdata.token=newToken,config.data="data="+JSON.stringify(jdata,null,4),retryHttpRequest(updater(config),buffer[i].deferred)}buffer=[]}}}])}(),angular.module("edsiteApp.Commun").factory("ModuleService",["Auth","lodash",function(Auth,lodash){var ModuleService={};return ModuleService.CODES={VIE_SCOLAIRE:"VIE_SCOLAIRE",VIE_DE_LA_CLASSE:"VIE_DE_LA_CLASSE",NOTES:"NOTES",CLOUD:"CLOUD",MESSAGERIE:"MESSAGERIE",EDT:"EDT",CAHIER_DE_TEXTES:"CAHIER_DE_TEXTES",RESERVATIONS:"RESERVATIONS",REUNIONS_PP:"REUNIONS_PP",COORDONNEES:"COORDONNEES",ACTUALITES:"ACTUALITES",COMPTE:"COMPTE",PARTENAIRES_BAS:"PARTENAIRES_BAS",PARTENAIRES_ONGLET:"PARTENAIRES_ONGLET",SITUATION_FINANCIERE:"SITUATION_FINANCIERE",FACTURES:"FACTURES",MODE_DE_REGLEMENT:"MODE_DE_REGLEMENT",PAIEMENT_EN_LIGNE:"PAIEMENT_EN_LIGNE",DOCUMENTS:"DOCUMENTS",CONSULTATION:"CONSULTATION_ETABLISSEMENT",AFFICHAGE_ELEVE:"AFF_EL",APPEL:"APPEL",APPEL_PRIMAIRE:"APPEL_PRIMAIRE",APPEL_ETUDE:"APPEL_ETUDE",CARNET_CORRESPONDANCE:"CARNET_CORRESPONDANCE",NOTESMOYENNES:"NOTES_MOYENNES",MOYENNES:"MOYENNES",DOCUMENTS_ELEVE:"DOCUMENTS_ELEVE",ABSENCES:"ABSENCES",RETARDS:"RETARDS",SANCTIONS:"SANCTIONS",ENCOURAGEMENTS:"ENCOURAGEMENTS",POSTIT:"POSTIT",AGENDA:"AGENDA",CARNET_NOTES:"CARNET_NOTES",CATER:"CATER",ARD:"ARD",SCOLACONCEPT:"SCOLACONCEPT",SALLE_DES_PROFS:"SALLE_DES_PROFS",ESIDOC:"ESIDOC",CONSEIL_DE_CLASSE:"CONSEIL_DE_CLASSE",LSL:"LSL",EDUNAO:"EDUNAO",ALISE:"ALISE",DOSSIER_INSCRIPTION:"DOSSIER_INSCRIPTION",GROUPE_FLEX:"GROUPE_FLEX",SUIVI_STAGE:"SUIVI_STAGE",EDUMALIN:"EDUMALIN",CLICKNPLAY:"CLICKNPLAY",AVENRIA:"AVENRIA",PEARLTREES:"PEARLTREES",QCM:"QCM",ONISEPSERVICES:"ONISEPSERVICES"},ModuleService.getModule=function(codeModule,idEleve){var user=Auth.currentUser(),module={},isEnfant=!1;if(idEleve&&Auth.isFamille()&&(idEleve=parseInt(idEleve),isEnfant=!0),isEnfant){var enfant=lodash.find(user.profile.eleves,{id:idEleve});enfant&&(module=lodash.find(enfant.modules,{code:codeModule}))}else module=lodash.find(user.modules,{code:codeModule});return module},ModuleService.clearBadges=function(codeModule,idEleve){var module=ModuleService.getModule(codeModule,idEleve);return lodash.isUndefined(module)||(module.badge=0),module},ModuleService.getBadges=function(codeModule,idEleve){var module=ModuleService.getModule(codeModule,idEleve);return lodash.isUndefined(module)?0:module.badge},ModuleService.isModuleEnabled=function(codeModule,idEleve){var module=ModuleService.getModule(codeModule,idEleve);return lodash.isUndefined(module)?!1:module.enable},ModuleService}]),angular.module("edsiteApp.Commun").factory("UserService",["$http","$q","Auth","lodash","$sessionStorage","EDHttp",function($http,$q,Auth,lodash,$sessionStorage,EDHttp){function getNiveauxListeAll(){var defer=$q.defer(),baseUrl="niveauxListeAll";return angular.isDefined($sessionStorage["user-niveaux-all"])&&$sessionStorage["user-niveaux-all"].etablissements.length+$sessionStorage["user-niveaux-all"].groupes.length>0?(defer.resolve($sessionStorage["user-niveaux-all"]),defer.promise):($http({method:"GET",url:baseUrl,data:{},cache:!0}).success(function(response){$sessionStorage["user-niveaux-all"]=response.data,defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise)}function getNiveauxListe(){var defer=$q.defer(),baseUrl="niveauxListe";return angular.isDefined($sessionStorage["user-niveaux"])&&$sessionStorage["user-niveaux"].etablissements.length+$sessionStorage["user-niveaux"].groupes.length>0?(defer.resolve($sessionStorage["user-niveaux"]),defer.promise):($http({method:"GET",url:baseUrl,data:{},cache:!0}).success(function(response){$sessionStorage["user-niveaux"]=response.data,defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise)}function getProfParametrages(idProf){var baseUrl="enseignants/"+idProf+"/parametrages";return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){return response.data.data})}function cleanMatieresWithSSMatieres(groupe){lodash.forEach(groupe.periodes,function(periode){var ssMatPart=[],duplicateFreeMatieres=lodash.uniq(periode.matieres,function(n){return n.code+" - "+n.codeSSMatiere});duplicateFreeMatieres=lodash.groupBy(duplicateFreeMatieres,"code"),lodash.forEach(duplicateFreeMatieres,function(perGroup){var partition=lodash.partition(perGroup,{codeSSMatiere:""});if(!angular.isUndefined(partition[0][0])){var libelleMatierePremiere=partition[0][0].libelle,prefixedSSMat=lodash.forEach(partition[1],function(p){p.libelle=libelleMatierePremiere+" - "+p.libelle});ssMatPart=ssMatPart.concat(partition[0][0]),ssMatPart=ssMatPart.concat(prefixedSSMat)}}),periode.matieres=ssMatPart})}var User={};return User.getUser=function(typeCompte,idUser){var types={E:User.getEleve},defer=$q.defer();return $q.when(types[typeCompte](idUser)).then(function(user){angular.isUndefined(user)?defer.reject():defer.resolve(user)},function(error){defer.reject(error)}),defer.promise},User.getEleve=function(idUser){var defer=$q.defer(),currentUser=Auth.currentUser();if(idUser=parseInt(idUser),Auth.isEleve()&&idUser===currentUser.id)defer.resolve(Auth.currentUser());else if(Auth.isFamille())defer.resolve(lodash.find(currentUser.profile.eleves,{id:idUser}));else if(Auth.isPersonnel()||Auth.isProfesseur()){var baseUrl="eleves/"+idUser;if(angular.isDefined($sessionStorage["consultation-eleve"])&&$sessionStorage["consultation-eleve"].id===idUser)return defer.resolve($sessionStorage["consultation-eleve"]),defer.promise;new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){$sessionStorage["consultation-eleve"]=response.data.data,defer.resolve($sessionStorage["consultation-eleve"])},function(error){defer.reject(error)})}else defer.reject();return defer.promise},User.getListeEtablissements=function(){var defer=$q.defer();return getNiveauxListe().then(function(data){defer.resolve(data.etablissements)}),defer.promise},User.getListeEtablissementsAll=function(){var defer=$q.defer();return getNiveauxListeAll().then(function(data){defer.resolve(data.etablissements)}),defer.promise},User.getClassesByNiveauxByEtabs=function(){var defer=$q.defer();return User.getListeEtablissements().then(function(etablissements){var etabs=[];angular.forEach(etablissements,function(etab){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,optionLibelle:etab.libelle,optionType:"etab",id:etab.id}),angular.forEach(etab.niveaux,function(niveau){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,niveauLibelle:niveau.libelle,niveauId:niveau.id,optionLibelle:niveau.libelle,optionType:"niveau",id:niveau.id}),angular.forEach(niveau.classes,function(classe){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,niveauLibelle:niveau.libelle,niveauId:niveau.id,classeLibelle:classe.libelle,classeId:classe.id,optionLibelle:classe.libelle,optionType:"classe",id:classe.id,degre:classe.degre})})})}),defer.resolve(etabs)}),defer.promise},User.getClassesAllByNiveauxByEtabs=function(){var defer=$q.defer();return User.getListeEtablissementsAll().then(function(etablissements){var etabs=[];angular.forEach(etablissements,function(etab){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,optionLibelle:etab.libelle,optionType:"etab",id:etab.id}),angular.forEach(etab.niveaux,function(niveau){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,niveauLibelle:niveau.libelle,niveauId:niveau.id,optionLibelle:niveau.libelle,optionType:"niveau",id:niveau.id}),angular.forEach(niveau.classes,function(classe){etabs.push({etabLibelle:etab.libelle,etabId:etab.id,niveauLibelle:niveau.libelle,niveauId:niveau.id,classeLibelle:classe.libelle,classeId:classe.id,optionLibelle:classe.libelle,optionType:"classe",id:classe.id})})})}),defer.resolve(etabs)}),defer.promise},User.getClassesByEtabs=function(){var defer=$q.defer();return User.getListeEtablissements().then(function(etablissements){var etabs=[];angular.forEach(etablissements,function(etab){var classes=[];angular.forEach(etab.niveaux,function(niv){angular.forEach(niv.classes,function(cl){var lCl=angular.copy(cl);lCl.niveaux=[niv.code],classes.push(lCl)})}),classes=lodash.sortBy(classes,"libelle"),classes=lodash.map(classes,function(classe){return{etabLibelle:etab.libelle,etabId:etab.id,classeLibelle:classe.libelle,code:classe.code,libelle:classe.libelle,classeId:classe.id,id:classe.id,periodes:classe.periodes,type:"C",cycle:classe.cycle,niveaux:classe.niveaux,idCycleEtab:classe.idCycleEtab,estNote:classe.estNote,positionnementLSU:classe.positionnementLSU,paramsLSU:classe.paramsLSU,pcpNbPeriode:classe.pcpNbPeriode,pcpMoyAnnuelle:classe.pcpMoyAnnuelle,pcpMoyGenAnnee:classe.pcpMoyGenAnnee,pcpMoyPeriode:classe.pcpMoyPeriode,pcpMoyMatiere:classe.pcpMoyMatiere,matieres:classe.matieres,isPP:classe.isPP,degre:classe.degre}}),etabs=etabs.concat(classes)}),defer.resolve(etabs)}),defer.promise},User.getAllClassesByEtabs=function(){var defer=$q.defer();return User.getListeEtablissementsAll().then(function(etablissements){var etabs=[];angular.forEach(etablissements,function(etab){var classes=lodash(etab.niveaux).pluck("classes").flatten().sortBy("libelle").value();classes=lodash.map(classes,function(classe){return{etabLibelle:etab.libelle,etabId:etab.id,classeLibelle:classe.libelle,code:classe.code,libelle:classe.libelle,classeId:classe.id,id:classe.id,periodes:classe.periodes,type:"C",cycle:classe.cycle,pcpNbPeriode:classe.pcpNbPeriode,pcpMoyAnnuelle:classe.pcpMoyAnnuelle,pcpMoyGenAnnee:classe.pcpMoyGenAnnee,pcpMoyPeriode:classe.pcpMoyPeriode,pcpMoyMatiere:classe.pcpMoyMatiere,degre:classe.degre}}),etabs=etabs.concat(classes)}),defer.resolve(etabs)}),defer.promise},User.getClassesPP=function(){var defer=$q.defer();return User.getListeEtablissements().then(function(etablissements){var etabs=[];angular.forEach(etablissements,function(etab){var classes=lodash(etab.niveaux).pluck("classes").flatten().filter({isPP:!0}).sortBy("libelle").value();classes=lodash.map(classes,function(classe){return{etabLibelle:etab.libelle,etabId:etab.id,classeLibelle:classe.libelle,classeId:classe.id,id:classe.id,isPP:!0,periodes:classe.periodes,type:"C"}}),etabs=etabs.concat(classes)}),defer.resolve(etabs)}),defer.promise},User.getGroupes=function(){var defer=$q.defer();return getNiveauxListe().then(function(data){lodash.forEach(data.groupes,function(groupe){groupe.type="G"}),defer.resolve(data.groupes)}),defer.promise},User.getAllGroupes=function(){var defer=$q.defer();return getNiveauxListeAll().then(function(data){lodash.forEach(data.groupes,function(groupe){groupe.type="G"}),defer.resolve(data.groupes)}),defer.promise},User.getEmails=function(){var profile=Auth.currentUser().profile;return profile.email},User.getParametrages=function(){var defer=$q.defer();return Auth.isProfesseur()?getProfParametrages(Auth.currentUser().id):(defer.resolve({}),defer.promise)},User.getProfClassesGroupesTree=function(){var _classes;return User.getClassesByEtabs().then(function(classes){return _classes=angular.copy(classes),lodash.forEach(_classes,function(classe){cleanMatieresWithSSMatieres(classe)}),User.getGroupes()}).then(function(_groupes){var groupes=angular.copy(_groupes);return lodash.forEach(groupes,function(groupe){cleanMatieresWithSSMatieres(groupe)}),_classes=_classes.concat(groupes)})},User.getClasseById=function(idClasse){return User.getClassesByEtabs().then(function(classes){return lodash.find(classes,{classeId:idClasse})})},User.getSalles=function(){var defer=$q.defer(),baseUrl="salles";return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},User}]),angular.module("edsiteApp").factory("ProcessResponseInterceptor",["lodash","$sessionStorage","$location","$q","$rootScope","httpBuffer",function(lodash,$sessionStorage,$location,$q,$rootScope,httpBuffer){function handleReconnect(response){var deferred=$q.defer(),nbWaitingRequest=httpBuffer.append(response.config,deferred);return 1===nbWaitingRequest&&$rootScope.$broadcast("token-expired"),deferred.promise}function handleForbidden(response){return $location.path("/403"),$q.reject(response)}function isHttpAuthCodeError(code){return!(525!==code&&520!==code)}function isHttpCodeError(code){return code>=400}function isTokenResponseEmpty(response){return angular.isUndefined(response.data.token)||""===response.data.token}function updateToken(response){isTokenResponseEmpty(response)||($sessionStorage.token=response.data.token)}function processResponse(response){if(response.data)if(response.data.token&&angular.isUndefined(response.data.code));else{if(isHttpAuthCodeError(response.data.code))return handleReconnect(response);if(403===response.data.code)return handleForbidden(response);if(521===response.data.code)return $q.reject(response);if(isHttpCodeError(response.data.code))return $q.reject(response)}return updateToken(response),response}return{response:processResponse}}]).factory("ProcessRequestInterceptor",["$sessionStorage","Settings","CONFIG",function($sessionStorage,Settings,CONFIG){function processRequest(config){var excluded=/.*(\.html|.*(\.json)|http(s)?:\/\/).*/g;if(config.intercepted)return config;if(config.url.indexOf(".htm")>-1&&0!==config.url.indexOf("template/")&&-1===config.url.indexOf("ui-listView")&&-1===config.url.indexOf("ng-mfb")&&-1===config.url.indexOf("bootstrap")){var separator=-1===config.url.indexOf("?")?"?":"&";config.url=config.url+separator+"v="+CONFIG.version}if(config.url&&!config.url.match(excluded)){var regexParamGet=/(.*)\?(.*)/,resultRegex=regexParamGet.exec(config.url),target=config.url,apiUri=Settings.allSettings().apiUri;""===apiUri&&Settings.displayNoMoreServerMessage();var params="";resultRegex&&resultRegex.length>=2&&(target=resultRegex[1],params=resultRegex[2]),config.url=target,config.url=apiUri+config.url+Settings.allSettings().apiExtension,config.url.replace(regexParamGet,""),config.url+="?verbe="+config.method.toLowerCase(),config.url+="&"+params,config.method="POST",config.headers["Content-Type"]="application/x-www-form-urlencoded",config.intercepted=!0}if(config.data&&"object"==typeof config.data){config.data.token=$sessionStorage.token;var replacer=function(key,value){return"string"==typeof value?(value=value.replace(/%/g,"%25"),value=value.replace(/&/g,"%26"),value=value.replace(/\+/g,"%2B")):value},strVal=JSON.stringify(config.data,replacer,4);config.data="data="+strVal}return config}return{request:processRequest}}]),angular.module("edsiteApp.Villes",[]).service("VillesService",["$q","$http",function($q,$http){var mVillesService={};return mVillesService.listeVilles=function(cp){var defer=$q.defer(),data={},baseUrl="villes?codePostal="+cp;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data.villes)},function(error){defer.reject(error)}),defer.promise},mVillesService}]),angular.module("edsiteApp").directive("compile",["$sanitize","$compile","$timeout",function($sanitize,$compile,$timeout){return function(scope,element,attrs){scope.$watch(function(scope){return scope.$eval(attrs.compile)},function(value){angular.isUndefined(value)&&(value=""),element.html(value);try{var replacer=/<script[^>]*>(?:(?!<\/script>)[^])*<\/\s?script>/gi,stripped=element.html().replace(replacer,"");replacer=/<\!--\[endif\]---->.*<\!--\!\[endif\]---->?/gi,stripped=stripped.replace(replacer,""),replacer=/<\?xml(.*)(office|microsoft)(.*)\/>/gi,stripped=stripped.replace(replacer,""),$compile($sanitize(stripped))(scope)}catch(err){console.log("err",err)}$timeout(function(){MathJax.Hub.Typeset(element[0])})})}}]),angular.module("edsiteApp").directive("mathTex",["$timeout",function($timeout){return{restrict:"C",link:function(scope,element){$timeout(function(){MathJax.Hub.Typeset(element[0])})}}}]),angular.module("edsiteApp").directive("edSwitchWhen",function(){return{transclude:"element",priority:1200,require:"^ngSwitch",multiElement:!0,link:function(scope,element,attrs,ctrl,$transclude){var caseStms=scope.$eval(attrs.edSwitchWhen);caseStms=angular.isArray(caseStms)?caseStms:[caseStms],angular.forEach(caseStms,function(caseStm){caseStm="!"+caseStm,ctrl.cases[caseStm]=ctrl.cases[caseStm]||[],ctrl.cases[caseStm].push({transclude:$transclude,element:element})})}}}),angular.module("edsiteApp.cahierDeTexte",["edsiteApp.Commun","edsiteApp.filterTranslateTypeUser"]).controller("ElevecahierdetexteCtrl",["$scope","$sessionStorage","$routeParams","$document","$q","$uibModal","$timeout","$filter","lodash","Notification","ModuleService","CahierDeTexteService","UserService","Auth",function($scope,$sessionStorage,$routeParams,$document,$q,$uibModal,$timeout,$filter,lodash,Notification,ModuleService,CahierDeTexteService,UserService,Auth){$scope.idEleve=$routeParams.idEntite,$scope.contexte=$routeParams.entite,ModuleService.clearBadges(ModuleService.CODES.CAHIER_DE_TEXTES,$routeParams.ideleve)}]),angular.module("edsiteApp.cahierDeTexte").directive("cahierDeTexte",function(){return{restrict:"E",scope:{idEleve:"=",contexte:"=",libelle:"="},controller:"EleveCahierDeTexteDirectiveCtrl",templateUrl:"modules/cahierDeTexte/eleve/eleve-cahierdetexte-template.html",link:function(scope,element,attrs){}}}).controller("EleveCahierDeTexteDirectiveCtrl",["$scope","$sessionStorage","$document","$q","$uibModal","$timeout","$filter","lodash","Notification","ModuleService","CahierDeTexteService","Utils","UserService","AppelService","Auth",function($scope,$sessionStorage,$document,$q,$uibModal,$timeout,$filter,lodash,Notification,ModuleService,CahierDeTexteService,Utils,UserService,AppelService,Auth){function getScope(){return $scope}function refresh(){var listePromises=[];$scope.isCDTPrimaire?$scope.setCurrentDay($scope.dayselected):listePromises.push(CahierDeTexteService.CahierDeTextes($scope.idEleve,$scope.contexte).then(function(reponse){$scope.cahierDeTexte=reponse,lodash.isEmpty(reponse)&&($scope.noDevoir=!0)})),"Classes"!==$scope.contexte&&"Groupes"!==$scope.contexte?($scope.idContexte=$scope.idEleve,UserService.getEleve($scope.idEleve).then(function(eleve){$scope.eleve=eleve,$scope.typeUser="Eleves";var idClasse,typeEntity=$filter("translateTypeUserToShortcut")(CahierDeTexteService.TYPES_SUPPORT.RESSOURCE);Auth.isFamille()&&(idClasse=$scope.eleve.classe.id),Auth.isEleve()&&(idClasse=$scope.eleve.profile.classe.id),(Auth.isProfesseur()||Auth.isPersonnel())&&(idClasse=$scope.eleve.classeId),listePromises.push(CahierDeTexteService.listeMatieres(typeEntity,idClasse).then(function(lesMatieres){$scope.matieres=[],$scope.matieres=lodash.union($scope.matieres,lesMatieres.matieres)}))})):(angular.isDefined($sessionStorage["consultation-classe"])||angular.isDefined($sessionStorage["consultation-groupe"])?$scope.classeLibelle=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].libelle:$sessionStorage["consultation-groupe"].libelle:$scope.classeLibelle="",$scope.typeUser="Enseignants",$scope.idContexte=Auth.idUser()),(!Auth.isPersonnel()||Auth.isPersonnel()&&"Eleves"===$scope.contexte)&&CahierDeTexteService.manuelsNumeriques($scope.idContexte,$scope.typeUser).then(function(response){$scope.manuels=[],$scope.manuelsMultimedia=[],angular.forEach(response,function(manuel){"EDUCARTE"===manuel.editeur||"LESITETV"===manuel.editeur?$scope.manuelsMultimedia.push(manuel):$scope.manuels.push(manuel)})}),$scope.promiseContents=$q.all(listePromises)}function countDevoirByDay(date){return angular.isDefined($scope.cahierDeTexte)&&date in $scope.cahierDeTexte?lodash.where($scope.cahierDeTexte[date],{aFaire:!0,effectue:!1}).length:0}function cahierDeTexteAVenir(){return $scope.cahierDeTexte}function isNow(laDate){return moment(laDate).isSame(moment(),"day")}function isPast(leJour){return moment().isAfter(leJour,"day")||moment().isSame(leJour,"day")}function getDayActuel(numeroJour,semaineCourante){var firstDayWeek=angular.copy(semaineCourante);return formateDate(firstDayWeek.add(numeroJour,"days"))}function changeWeek(etat){"semaine"===$scope.dayselected?"+"===etat?$scope.semaineCourante.add(1,"week"):$scope.semaineCourante.subtract(1,"week"):("avenir"===$scope.dayselected&&($scope.dayselected=formateDate(moment())),"+"===etat&&$scope.setCurrentDay(formateDate(moment($scope.dayselected).add(1,"week"))),"-"===etat&&$scope.setCurrentDay(formateDate(moment($scope.dayselected).subtract(1,"week"))))}function setCurrentDay(date){$scope.displayTour=!1;var defer=$q.defer();return"demain"===date?$scope.dayselected=formateDate(moment().add(1,"day")):$scope.dayselected=date,"avenir"!==$scope.dayselected&&"semaine"!==$scope.dayselected&&($scope.semaineCourante=moment($scope.dayselected).day(1),CahierDeTexteService.CahierDeTextesParDate($scope.idEleve,$scope.dayselected,$scope.contexte).then(function(cahierDeTexteParJour){$scope.cahierDeTexteSelectedDay=cahierDeTexteParJour}).then(function(){$timeout(function(){defer.resolve()},1e3)})),"crseance"!==$scope.actif||$scope.isPast(date)||($scope.actif="afaire"),defer.promise}function setCurrentDayByCalendar(event,date){$scope.setCurrentDay(formateDate(date))}function setModeActif(mode){$scope.actif=mode}function formateDate(laDate){return moment(laDate).format("YYYY-MM-DD")}function refreshCurrentDay(){$scope.setCurrentDay($scope.dayselected)}function manuelsByMatiere(codeMatiere){function contains(a,obj){for(var i=a.length;i--;)if(a[i]===obj)return!0;return!1}return codeMatiere===AppelService.typeEntity.CLASSE?[]:lodash.filter($scope.manuels,function(man){return contains(man.disciplines,codeMatiere)})}function manuelsToutesMatieres(){return lodash.filter($scope.manuels,function(man){return 0===man.disciplines.length})}function manuelsMatieresSpecifiees(){return lodash.filter($scope.manuels,function(man){return man.disciplines.length>0})}function showRessource(contexte){$scope.contexteRessource=contexte,$uibModal.open({templateUrl:"modules/cahierDeTexte/eleve/cahierdetexteressources.html",scope:$scope})}function listeRessources(){
var ressourceSelected=angular.copy($scope.ressourcePreselected);$scope.ressource=lodash.findWhere($scope.matieres,{id:ressourceSelected.id})}function selectRessource(matiere){$scope.ressource=matiere}function showAllManuel(val){$scope.showAllMan=val}$scope.cahierDeTexte={},$scope.cahierDeTexteSelectedDay={},$scope.Utils=Utils,$scope.countDevoirByDay=countDevoirByDay,$scope.refresh=refresh,$scope.refreshCurrentDay=refreshCurrentDay,$scope.Auth=Auth,$scope.cahierDeTexteAVenir=cahierDeTexteAVenir,$scope.isNow=isNow,$scope.isPast=isPast,$scope.getDayActuel=getDayActuel,$scope.getScope=getScope,$scope.changeWeek=changeWeek,$scope.setCurrentDay=setCurrentDay,$scope.setCurrentDayByCalendar=setCurrentDayByCalendar,$scope.setModeActif=setModeActif,$scope.manuelsMatieresSpecifiees=manuelsMatieresSpecifiees,$scope.manuelsToutesMatieres=manuelsToutesMatieres,$scope.manuelsByMatiere=manuelsByMatiere,$scope.showAllManuel=showAllManuel,$scope.showRessource=showRessource,$scope.listeRessources=listeRessources,$scope.selectRessource=selectRessource,$scope.actif="afaire";var cdtModule=ModuleService.getModule(ModuleService.CODES.CAHIER_DE_TEXTES,$scope.idEleve);angular.isDefined(cdtModule)?($scope.isCompteRenduSeanceEnabled="1"===cdtModule.params.compteRenduSeance,$scope.isCDTPrimaire="1"===cdtModule.params.isCDTPrimaire):($scope.isCompteRenduSeanceEnabled=!1,$scope.isCDTPrimaire=!1);var DaysOfWeek=moment().localeData()._weekdays;if($scope.joursSemaine=[DaysOfWeek[1],DaysOfWeek[2],DaysOfWeek[3],DaysOfWeek[4],DaysOfWeek[5],DaysOfWeek[6]],$scope.isCDTPrimaire){switch(moment().day()){case 6:$scope.dayselected=formateDate(moment().add(2,"d").toDate());break;case 5:$scope.dayselected=formateDate(moment().toDate());break;default:$scope.dayselected=formateDate(moment().add(1,"d").toDate())}$scope.semaineCourante=moment($scope.dayselected).day(1)}else $scope.dayselected="avenir",$scope.semaineCourante=moment().day(1);"Groupes"===$scope.contexte&&($scope.contexteOriginal="Groupes",$scope.idcontexteOriginal=$scope.idEleve,$scope.contexteEnCours=void 0,UserService.getGroupes().then(function(lesGroupes){var leGroupe=lodash.find(lesGroupes,{id:parseInt($scope.idcontexteOriginal)});$scope.lesClassesOriginal=leGroupe.classes})),$scope.refresh(),$scope.fichiers=[]}]),angular.module("edsiteApp.cahierDeTexteSaisie",["edsiteApp.Commun","edsiteApp.filterTranslateTypeUser","ui-listView","edsiteApp.casService"]).controller("ProfcahierdetexteCtrl",["$scope","$timeout","$q","Auth","Utils","lodash","$sce","$filter","$uibModal","Notification","ModuleService","CahierDeTexteService","Settings","CASService",function($scope,$timeout,$q,Auth,Utils,lodash,$sce,$filter,$uibModal,Notification,ModuleService,CahierDeTexteService,Settings,CASService){function dashBoardCopiesCorrectifs(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteDashboardCopiesCorrectifs.html",controller:"CahierdetexteDashboardCopiesCorrectifsCtrl as ctrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{currentCDT:function(){return vm.currentCDT}}})}function openQCM(qcm){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"md",resolve:{qcmAssociation:function(){return qcm},isNational:function(){return!1},idEleve:function(){return void 0}}})}function openDonneLe($event){$event.preventDefault(),$event.stopPropagation(),vm.donneLeOpened=!0}function disabled(date,mode){return"day"===mode&&0===date.getDay()}function resetFilter(addNewSlotIfNecessary){vm.cdtfilter={},vm.selectedDate=void 0,vm.updateListFilteredSlots(),vm.updateFilter(addNewSlotIfNecessary),"liste"===vm.selectedView&&(vm.redrawCal=!0,$timeout(function(){vm.scrollToToday()}))}function updateFilter(addNewSlotIfNecessary){if(""!==vm.cdtfilter.entityCode&&(""===vm.cdtfilter.matiereCode||angular.isUndefined(vm.cdtfilter.matiereCode))){var matieresOfClasse=vm.listMatieresOfClasse(vm.cdtfilter.entityCode);1===matieresOfClasse.length&&(vm.cdtfilter.matiereCode=matieresOfClasse[0].code,vm.cdtfilter.matiereLibelle=matieresOfClasse[0].libelle)}CahierDeTexteService.purgeTemporairesSlots(),vm.updateListFilteredSlots(),"liste"===vm.selectedView&&(vm.redrawCal=!0),addNewSlotIfNecessary=angular.isUndefined(addNewSlotIfNecessary)?!0:addNewSlotIfNecessary,addNewSlotIfNecessary&&vm.addNewSlotIfNecessary()}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}function afterSelectedDateChange(val,oldVal){if(angular.isDefined(val)||angular.isDefined(oldVal)){if(CahierDeTexteService.purgeTemporairesSlots(),angular.isUndefined(val))return delete vm.cdtfilter.date,vm.updateListFilteredSlots(),void vm.scrollToToday();var newDate=moment(val).format("YYYY-MM-DD");newDate===vm.cdtfilter.date?vm.selectedDate=void 0:vm.cdtfilter.date=newDate,vm.updateListFilteredSlots(),vm.addNewSlotIfNecessary()}}function refreshAfterUpload(side){var date=moment(vm.currentCDT.date).format("YYYY-MM-DD");$scope.promiseLoading=CahierDeTexteService.getCDTUnitaire(side,vm.currentCDT.entityCode,vm.currentCDT.matiereCode,date).then(function(data){"ressources"===side?vm.currentCDT.ressources=data:vm.currentCDT[side]=data})}function deleteFile(fichierToDelete,listeFichiers){$scope.promiseLoading=CahierDeTexteService.deleteFile(fichierToDelete).then(function(){lodash.remove(listeFichiers,function(fichier){return fichier.id===fichierToDelete.id})})}function addNewSlotIfNecessary(){if(angular.isUndefined(vm.filteredSlots)||0===vm.filteredSlots.length){var newSlot=CahierDeTexteService.pushNewSlot(vm.cdtfilter);vm.updateListFilteredSlots(),angular.isDefined(newSlot)&&vm.setCurrentCDT(newSlot)}vm.chooseCurrentSlot()}function setSelectedView(view){vm.selectedView=view}function setSelectedSeanceView(view){vm.selectedSeanceView=view,"C"===view?(vm.isActiveC=!0,vm.isActiveT=!1):(vm.isActiveT=!0,vm.isActiveC=!1)}function nextSlotForDuplication(){var dateMin=moment(vm.currentCDT.date);dateMin=dateMin.subtract({day:5});var dateMinstr=dateMin.format("YYYY-MM-DD"),dateMaxstr=dateMin.add({day:30}).format("YYYY-MM-DD"),noNiveau=!1,filteredSlots=lodash.filter(CahierDeTexteService.slots,function(slot){return angular.isUndefined(slot.niveaux)&&(noNiveau=!0),lodash.intersection(slot.niveaux,vm.currentCDT.niveaux).length>0&&slot.matiereCode===vm.currentCDT.matiereCode&&slot.date>=dateMinstr&&slot.date<dateMaxstr});return angular.isUndefined(filteredSlots)?[]:noNiveau?lodash.filter(CahierDeTexteService.slots,function(slot){return slot.matiereCode===vm.currentCDT.matiereCode&&slot.date>=dateMinstr&&slot.date<dateMaxstr}):filteredSlots}function updateNextSlot(){var numberNeeded=5,filteredSlots=lodash.filter(vm.filteredSlots,function(slot){return slot.entityCode===vm.currentCDT.entityCode&&slot.matiereCode===vm.currentCDT.matiereCode&&slot.date>vm.currentCDT.date});angular.isUndefined(filteredSlots)&&(vm.nextSlot=[]),filteredSlots.length<=numberNeeded?vm.nextSlot=filteredSlots:vm.nextSlot=filteredSlots.slice(0,numberNeeded)}function updateListFilteredSlots(){var results=lodash.uniq(CahierDeTexteService.slots,function(slot){return slot.date+"_"+slot.entityCode+"_"+slot.matiereCode+"_"+slot.idCDT});results=lodash.filter(results,function(slot){return vm.cdtfilter.entityCode&&slot.entityCode!==vm.cdtfilter.entityCode?!1:vm.cdtfilter.matiereCode&&slot.matiereCode!==vm.cdtfilter.matiereCode?!1:vm.cdtfilter.date&&slot.date!==vm.cdtfilter.date?!1:!0}),vm.filteredSlots=results,vm.filteredSlots.indexOf(vm.currentCDT)<0&&(vm.cdtfilter.entityCode&&vm.currentCDT.entityCode!==vm.cdtfilter.entityCode||vm.cdtfilter.matiereCode&&vm.currentCDT.matiereCode!==vm.cdtfilter.matiereCode||vm.cdtfilter.date&&vm.currentCDT.date!==vm.cdtfilter.date)&&(vm.currentCDT={}),0===results.length&&angular.isDefined(vm.uiListOptions.listView)&&(vm.uiListOptions.listView.cells=[],vm.cdtfilter.entityCode&&vm.cdtfilter.matiereCode&&angular.isUndefined(vm.selectedDate)&&$timeout(function(){var lDate=new Date;vm.dateForce=!0,vm.selectedDate=lDate})),1===results.length&&vm.setCurrentCDT(results[0])}function getDayClass(date,mode){if(!vm.cdtfilter.entityCode&&angular.isUndefined(vm.currentCDT.entityCode))return"";var mDate=moment(date),mDateStr=mDate.format("YYYY-MM-DD"),dateFilter={entityCode:vm.cdtfilter.entityCode,matiereCode:vm.cdtfilter.matiereCode,date:mDateStr};vm.cdtfilter.entityCode||(dateFilter={entityCode:vm.currentCDT.entityCode,matiereCode:vm.currentCDT.matiereCode,date:mDateStr});var filteredSlots=$filter("filter")(CahierDeTexteService.slots,dateFilter);return filteredSlots=lodash.reject(filteredSlots,{temporaire:!0}),filteredSlots.length>0?"avec-slot":""}function switchEditMode(side,destinationMode,button,nextSlot){var newMode="edit"===destinationMode;if(angular.isUndefined(vm.currentCDT.aFaire)&&(vm.currentCDT.aFaire={}),angular.isUndefined(vm.currentCDT.seance)&&(vm.currentCDT.seance={}),newMode)"aFaire"===side?(vm.currentCDT.aFaire.modeEdit=!0,vm.currentCDT.aFaire.contenuDecode=$filter("base64decode")(vm.currentCDT.aFaire.contenu)):(vm.updateNextSlot(),vm.currentCDT.seance.modeEdit=!0,vm.currentCDT.seance.contenuDecode=$filter("base64decode")(vm.currentCDT.seance.contenu)),vm.currentCDTEdit=angular.copy(vm.currentCDT),"aFaire"===side&&(angular.isUndefined(vm.currentCDTEdit.aFaire.donneLe)||""===vm.currentCDTEdit.aFaire.donneLe?vm.currentCDTEdit.aFaire.donneLe=new Date:vm.currentCDTEdit.aFaire.donneLe=new Date(vm.currentCDTEdit.aFaire.donneLe));else if("save"===button){if("aFaire"===side){if(vm.currentCDTEdit.aFaire.contenuDecode.length>1572864)return void Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo). Utilisez plutôt les documents joints.","danger");vm.prolexisEnable&&angular.isDefined(CKEDITOR.instances.aFaire)&&(vm.currentCDTEdit.aFaire.contenuDecode=CKEDITOR.instances.aFaire.getData()),vm.currentCDTEdit.aFaire.contenu=$filter("base64encode")(vm.currentCDTEdit.aFaire.contenuDecode),vm.currentCDTEdit.aFaire.contenu.length>0&&(vm.currentCDTEdit.travailAFaire=!0)}else{if(vm.currentCDTEdit.seance.contenuDecode.length>1572864)return void Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo). Utilisez plutôt les documents joints.","danger");vm.prolexisEnable&&angular.isDefined(CKEDITOR.instances.contenuDeSeance)&&(vm.currentCDTEdit.seance.contenuDecode=CKEDITOR.instances.contenuDeSeance.getData()),vm.currentCDTEdit.seance.contenu=$filter("base64encode")(vm.currentCDTEdit.seance.contenuDecode),vm.currentCDTEdit.seance.contenu.length>0&&(vm.currentCDTEdit.contenuDeSeance=!0)}vm.currentCDTEdit.aFaire.contenuDecode="",vm.currentCDTEdit.seance.contenuDecode="",$scope.promiseLoading=CahierDeTexteService.save(vm.currentCDTEdit,side).then(function(result){vm.currentCDT=angular.copy(vm.currentCDTEdit),angular.isDefined(result.idCDT)&&(vm.currentCDT.idCDT=result.idCDT),vm.currentCDT.seance.modeEdit=!1,vm.currentCDT.aFaire.modeEdit=!1,vm.currentCDT.temporaire=!1,angular.extend(lodash.find(CahierDeTexteService.slots,{selected:!0}),vm.currentCDT);var equivalentSlots=lodash.filter(CahierDeTexteService.slots,function(slot){return slot.entityCode!==vm.currentCDT.entityCode?!1:slot.matiereCode!==vm.currentCDT.matiereCode?!1:slot.date!==vm.currentCDT.date?!1:!0});lodash.forEach(equivalentSlots,function(slot){if(angular.isUndefined(slot.idCDT)||slot.idCDT===vm.currentCDT.idCDT){var goodStartDate=slot.start_date,goodEndDate=slot.end_date,goodIdCours=slot.idCours,goodId=slot.id,goodIdCDT=slot.idCDT;angular.extend(slot,vm.currentCDT),slot.start_date=goodStartDate,slot.end_date=goodEndDate,slot.idCours=goodIdCours,slot.idCDT=goodIdCDT,slot.id=goodId}}),Notification.notify("Enregistrement effectué","Votre saisie a bien été prise en compte","success",!0),angular.isDefined(nextSlot)?(vm.setCurrentCDT(nextSlot),vm.switchEditMode("aFaire","edit")):$timeout(function(){vm.scrollTo()})},function(err){Notification.notify("Erreur","Une erreur est survenu lors de l'enregistrement","danger"),vm.currentCDTEdit.aFaire.contenuDecode=$filter("base64decode")(vm.currentCDTEdit.aFaire.contenu),vm.currentCDTEdit.seance.contenuDecode=$filter("base64decode")(vm.currentCDTEdit.seance.contenu)})}else vm.currentCDT.seance.modeEdit=!1,vm.currentCDT.aFaire.modeEdit=!1,$timeout(function(){vm.scrollTo()})}function getCurrentCDT(){return vm.currentCDT}function isClasseOrGroupeDefined(){var classeOrGroupe=lodash.find(CahierDeTexteService.classes,{code:vm.currentCDT.entityCode});return angular.isDefined(classeOrGroupe)}function openDuplication(side){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteDuplication.html",controller:"CahierdetexteDupliCtrl as CahierdetexteDupliCtrl",size:"lg",resolve:{side:function(){return side},ProfcahierdetexteCtrl:vm}});modalInstance.result.then(function(slot){angular.isDefined(slot)&&vm.refresh(!0)})}function openSaisieModal(slot,ev){ev.stopPropagation(),vm.setCurrentCDT(slot).then(function(){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteSaisieModal.html",controller:"CahierdetexteSaisieModalCtrl as CahierdetexteSaisieModalCtrl",size:"lg",resolve:{cahierdetexteCtrl:function(){return vm}}});modalInstance.result.then(function(slot){})})}function openCDTClasse(){var classeOrGroupe=lodash.find(CahierDeTexteService.classes,{code:vm.currentCDT.entityCode});if(!angular.isUndefined(classeOrGroupe)){var entityId=classeOrGroupe.id,entityContexte="Classes";"C"!==vm.currentCDT.entityType&&(entityContexte="Groupes");var entity={id:entityId,libelle:vm.currentCDT.entityLibelle,code:vm.currentCDT.entityCode,contexte:entityContexte};$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteClasse.html",controller:"CahierdetexteClasseCtrl as CahierdetexteClasseCtrl",size:"lg",resolve:{entity:function(){return entity},ProfcahierdetexteCtrl:vm}})}}function showInterrogationsClasse(){var classeOrGroupe=lodash.find(CahierDeTexteService.classes,{code:vm.currentCDT.entityCode});if(!angular.isUndefined(classeOrGroupe)){var entityId=classeOrGroupe.id,entityContexte="Classes";"C"!==vm.currentCDT.entityType&&(entityContexte="Groupes");var entity={id:entityId,libelle:vm.currentCDT.entityLibelle,code:vm.currentCDT.entityCode,contexte:entityContexte};$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteInterrogationsClasse.html",controller:"CahierdetexteInterrogationsClasseCtrl as CahierdetexteInterrogationsClasseCtrl",size:"md",backdrop:!0,resolve:{entity:function(){return entity}}})}}function openSuppression(side){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteSuppression.html",controller:"CahierdetexteSupprCtrl as CahierdetexteSupprCtrl",size:"lg",resolve:{side:function(){return side},ProfcahierdetexteCtrl:vm}});modalInstance.result.then(function(response){angular.isDefined(response)&&("edt"===vm.selectedView?(lodash.forEach(CahierDeTexteService.slots,function(slot){vm.currentCDT.idCDT===slot.idCDT&&("aFaire"===side?(slot.travailAFaire=!1,delete slot.aFaire):(slot.contenuDeSeance=!1,delete slot.seance))}),vm.currentCDT={}):(vm.currentCDT={},vm.refresh(!0)))})}function openEDT(){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteEDT.html",controller:"CahierdetexteEDTCtrl as CahierdetexteEDTCtrl",size:"lg",resolve:{slots:function(){return CahierDeTexteService.slots}}});modalInstance.result.then(function(slot){if(angular.isDefined(slot)){var addNewSlotIfNecessary=!1;vm.cdtfilter={},vm.updateListFilteredSlots(),vm.updateFilter(addNewSlotIfNecessary),vm.setCurrentCDT(slot)}})}function isEmpty(item){return angular.equals({},item)||angular.isUndefined(item)}function chooseCurrentSlot(){}function setCurrentCDT(slot){if(angular.isUndefined(slot.matiereCode))return void Notification.notify("Erreur","Il n'y a pas de matière associée. La saisie est impossible","danger");if(angular.isUndefined(slot.entityCode))return void Notification.notify("Erreur","Il n'y a pas de classe ou de groupe associée. La saisie est impossible","danger");var defer=$q.defer();if(angular.isUndefined(slot)?slot=lodash.find(CahierDeTexteService.slots,{selected:!0}):(lodash.forEach(CahierDeTexteService.slots,function(theSlot){theSlot.selected=!1}),slot.selected=!0),angular.isUndefined(slot))return defer.resolve(),defer.promise;if(vm.correspondanceNeeded(slot)){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteMakeCorrespondance.html",controller:"CahierdetexteMakeCorrespondanceCtrl as CahierdetexteMakeCorrespondanceCtrl",size:"lg",backdrop:!1,resolve:{ProfcahierdetexteCtrl:vm,slot:function(){return slot}}});modalInstance.result.then(function(slot){angular.isDefined(slot)&&(vm.currentCDT=slot,defer.resolve())})}else angular.isUndefined(slot.aFaire)&&(slot.aFaire={}),angular.isUndefined(slot.seance)&&(slot.seance={}),vm.currentCDT=slot,defer.resolve();return $scope.currentCDTId=vm.currentCDT.idCDT,"liste"===vm.selectedView&&(vm.scrollTo(slot),vm.redrawCal=!0),defer.promise}function openArchives(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteArchives.html",controller:"CahierdetexteArchivesCtrl as CahierdetexteArchivesCtrl",size:"sm",resolve:{ProfcahierdetexteCtrl:vm}})}function openPrint(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetextePrint.html",controller:"CahierdetextePrintCtrl as CahierdetextePrintCtrl",size:"md",resolve:{ProfcahierdetexteCtrl:vm,isPrimaire:!1}})}function openCorrespondances(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteCorrespondances.html",controller:"CahierdetexteCorrespondancesCtrl as CahierdetexteCorrespondancesCtrl",size:"lg",resolve:{ProfcahierdetexteCtrl:vm}})}function openDocuments(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteDocuments.html",controller:"CahierdetexteDocumentsCtrl as CahierdetexteDocumentsCtrl",size:"lg",resolve:{ProfcahierdetexteCtrl:vm,isPrimaire:!1}})}function openManuels(){var entity={libelle:vm.currentCDT.entityLibelle,code:vm.currentCDT.entityCode},matiere={libelle:vm.currentCDT.matiereLibelle,code:vm.currentCDT.matiereCode};$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteManuels.html",controller:"CahierdetexteManuelsCtrl as CahierdetexteManuelsCtrl",size:"lg",backdrop:!1,resolve:{ProfcahierdetexteCtrl:vm,entity:entity,matiere:matiere,isPrimaire:!1}})}function openRessources(){var entity={libelle:vm.currentCDT.entityLibelle,code:vm.currentCDT.entityCode},matiere={libelle:vm.currentCDT.matiereLibelle,code:vm.currentCDT.matiereCode};$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteRessources.html",controller:"CahierdetexteRessourcesCtrl as CahierdetexteRessourcesCtrl",backdrop:!1,resolve:{ProfcahierdetexteCtrl:vm,entity:entity,matiere:matiere}})}function openParametrage(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteParametrage.html",controller:"CahierdetexteParametrageCtrl as ctrlCahierdetexteParametrage",backdrop:!1})}function correspondanceNeeded(slot){return vm.parametrage.correspondancesActives?vm.correspondanceClasseNeeded(slot)||vm.correspondanceMatiereNeeded(slot):!1}function correspondanceClasseNeeded(slot){if(!vm.parametrage.correspondancesActives)return!1;var isNeeded=angular.isUndefined(lodash.findWhere(CahierDeTexteService.classes,{code:slot.entityCode})),isAlreadyMade=angular.isDefined(CahierDeTexteService.correspondanceClasseInNote(slot));return isNeeded&&!isAlreadyMade}function correspondanceMatiereNeeded(slot){if(!vm.parametrage.correspondancesActives)return!1;var matiereInNote=CahierDeTexteService.correspondanceMatiereInNote(slot),isAlreadyMade=angular.isDefined(matiereInNote);if(isAlreadyMade&&slot.matiereCode===matiereInNote.matiereCode)return!1;var classeNote=lodash.findWhere(CahierDeTexteService.classes,{code:slot.entityCode,typeEntity:slot.entityType});if(angular.isUndefined(classeNote)){var corres=CahierDeTexteService.correspondanceClasseInNote(slot);if(angular.isUndefined(corres))return!1;classeNote=lodash.findWhere(CahierDeTexteService.classes,{code:corres.classeCode,typeEntity:corres.typeEntity})}return angular.isUndefined(classeNote)?!1:angular.isUndefined(lodash.findWhere(classeNote.matieres,{code:slot.matiereCode}))}function isCurrentInFuture(){return vm.currentCDT.date>moment().format("YYYY-MM-AA")}function setEditCommentaire(etat,side,commentaire){vm.currentCDT[side].editCommentaire=etat,angular.isDefined(commentaire)?(commentaire.editable=etat,etat?(vm.currentCDT[side].commentaire=$filter("base64decode")(commentaire.message),vm.currentCDT[side].idCommentaireEditable=commentaire.id,lodash.forEach(vm.currentCDT[side].commentaires,function(lecommentaire,key){lecommentaire.id!==commentaire.id&&(lecommentaire.editable=!1)})):(vm.currentCDT[side].commentaire="",vm.currentCDT[side].idCommentaireEditable=0,lodash.forEach(vm.currentCDT[side].commentaires,function(lecommentaire,key){lecommentaire.editable=!1}))):(vm.currentCDT[side].commentaire="",vm.currentCDT[side].idCommentaireEditable=0)}function addComment(commentaire,side){commentaire.message=$filter("base64encode")(commentaire.message),angular.isUndefined(vm.currentCDT[side].editCommentaire)||0===vm.currentCDT[side].idCommentaireEditable?vm.promiseContents=CahierDeTexteService.cahierDeTextesAddComment(Auth.role(),Auth.idUser(),commentaire,side).then(function(){vm.refreshAfterUpload(side),commentaire="",Notification.notify("Commentaire enregistré","Votre commentaire a bien été enregistré","success",!0)}):vm.promiseContents=CahierDeTexteService.cahierDeTextesUpdateComment(Auth.role(),Auth.idUser(),commentaire,side).then(function(commentaireModifie){vm.currentCDT[side].editCommentaire=!1,commentaire.editable=!1,lodash.forEach(vm.currentCDT[side].commentaires,function(lecommentaire,key){lecommentaire.id===commentaire.id&&(lecommentaire.message=commentaireModifie.message)}),vm.currentCDT[side].idCommentaireEditable=0,Notification.notify("Commentaire modifié","Votre commentaire a bien été modifié","success",!0)})}function archiveCommentaire(commentaireToDelete,side){vm.promiseContents=CahierDeTexteService.cahierDeTextesDeleteComment(Auth.role(),Auth.idUser(),commentaireToDelete,side).then(function(){lodash.remove(vm.currentCDT[side].commentaires,function(commentaire){return commentaire.id===commentaireToDelete.id}),Notification.notify("Commentaire supprimé","Votre commentaire a bien été supprimé","success",!0)})}function listMatieresOfClasse(code){var classe=lodash.findWhere(CahierDeTexteService.classes,{code:code});return angular.isDefined(classe)?classe.matieres:[]}function scrollTo(slot){angular.isUndefined(slot)&&(slot=lodash.find(vm.filteredSlots,{selected:!0})),$timeout(function(){var currentSlotPosition=vm.filteredSlots.indexOf(slot),slotList=angular.element("#slots")[0];angular.isDefined(slotList)&&(slotList.scrollTop=0,slotList.scrollTop=currentSlotPosition*vm.uiListOptions.preferredHeight-50)})}function scrollToToday(){$timeout(function(){var slotList=angular.element("#slots")[0],today=moment(),max=vm.filteredSlots.length,nbSlot=0;if(0!==vm.filteredSlots.length){for(;max>nbSlot&&today.isAfter(moment(vm.filteredSlots[nbSlot].date),"day");)nbSlot++;angular.isDefined(slotList)&&(slotList.scrollTop=nbSlot*vm.uiListOptions.preferredHeight)}})}function associateElemProg(side,$event){$event.preventDefault(),$event.stopPropagation();var instanceModaleCatalogue=$uibModal.open({templateUrl:"../../modules/cahierDeTexte/enseignant/ajout-element-programme-cdt.html",controller:"ajoutElemProgCDTModalCtrl as ctrlAjoutElemProgCDT",size:"lg",windowClass:"elem-prog-ajout-modal",backdrop:!1,keyboard:!1,resolve:{prof:function(){var prof={};return prof.matiere=vm.currentCDT.matiereCode,prof.id=vm.idUser,prof},currentCDT:function(){return vm.currentCDT.typeSaisie=side,vm.currentCDT}}});instanceModaleCatalogue.result.then(function(elemsProg){},function(){})}function associateLienManuel(side,$event){$event.preventDefault(),$event.stopPropagation();var instanceModaleLien=$uibModal.open({templateUrl:"../../modules/cahierDeTexte/enseignant/ajout-lien-manuel-cdt.html",controller:"ajoutLienManuelCDTModalCtrl as ctrlAjoutLienManuelCDT",windowClass:"elem-prog-ajout-modal",backdrop:!1,keyboard:!1,resolve:{currentCDT:function(){return vm.currentCDT.typeSaisie=side,vm.currentCDT}}});instanceModaleLien.result.then(function(lienManuel){angular.isDefined(lienManuel)&&CahierDeTexteService.associateLienManuel(vm.currentCDT,lienManuel).then(function(data){var tabLiensManuels=[];"T"===side?(angular.isDefined(vm.currentCDT.aFaire.liensManuel)||(vm.currentCDT.aFaire.liensManuel=tabLiensManuels),tabLiensManuels=vm.currentCDT.aFaire.liensManuel):(angular.isDefined(vm.currentCDT.seance.liensManuel)||(vm.currentCDT.seance.liensManuel=tabLiensManuels),tabLiensManuels=vm.currentCDT.seance.liensManuel),tabLiensManuels.push(lienManuel),Notification.notify("Association d'un lien BiblioManuel","Votre lien a bien été associé","success",!0)},function(error){Notification.notify("Association d'un lien BiblioManuel",error.data.message||"Une erreur est survenue","error",!0)})},function(){})}function dissocierElemProg(elemProgToDissociate,typeSaisie){vm.promiseContents=CahierDeTexteService.dissociateElemProg(vm.currentCDT,elemProgToDissociate,typeSaisie).then(function(){var tabElementsProg={};tabElementsProg="T"===typeSaisie?vm.currentCDT.aFaire.elementsProg:vm.currentCDT.seance.elementsProg,lodash.remove(tabElementsProg,function(elemProg){return elemProg.id===elemProgToDissociate.id}),Notification.notify("Dissociation d'un élément de programme","Votre élément de programme a bien été dissocié","success",!0)})}function dissocierLienManuel(lienToDissociate,typeSaisie){vm.promiseContents=CahierDeTexteService.dissociateLienManuel(vm.currentCDT,lienToDissociate,typeSaisie).then(function(){var tabLiensManuel={};tabLiensManuel="T"===typeSaisie?vm.currentCDT.aFaire.liensManuel:vm.currentCDT.seance.liensManuel,lodash.remove(tabLiensManuel,function(elemProg){return elemProg.url===lienToDissociate.url}),Notification.notify("Dissociation d'un lien manuel","Votre lien a bien été dissocié","success",!0)})}function goToService(url){CASService.goToService(url)}function refresh(force){vm.selectedView="liste",$scope.promiseLoading=CahierDeTexteService.initProf(vm.parametrage).then(function(){var minDate=CahierDeTexteService.startRange.format("YYYY-MM-DD"),maxDate=CahierDeTexteService.endRange.format("YYYY-MM-DD"),lesPromises=[];lesPromises.push(CahierDeTexteService.loadSlots(minDate,maxDate)),vm.parametrage.correspondancesActives?lesPromises.push(CahierDeTexteService.loadCorrespondances()):(CahierDeTexteService.correspondancesClasses=[],CahierDeTexteService.correspondancesMatieres=[]),$scope.promiseLoading=$q.all(lesPromises).then(function(data){CahierDeTexteService.afterLoadslots(data[0]),vm.updateListFilteredSlots(),CahierDeTexteService.hasBeenInitialized=Auth.currentUser().idLogin,"edt"!==vm.selectedView&&(vm.redrawCal=!0,vm.scrollToToday())})})}var vm=this;vm.dashBoardCopiesCorrectifs=dashBoardCopiesCorrectifs,vm.openQCM=openQCM,vm.openDonneLe=openDonneLe,vm.disabled=disabled,vm.resetFilter=resetFilter,vm.updateFilter=updateFilter,vm.sanitize=sanitize,vm.refreshAfterUpload=refreshAfterUpload,vm.afterSelectedDateChange=afterSelectedDateChange,vm.deleteFile=deleteFile,vm.addNewSlotIfNecessary=addNewSlotIfNecessary,vm.setSelectedView=setSelectedView,vm.setSelectedSeanceView=setSelectedSeanceView,vm.nextSlotForDuplication=nextSlotForDuplication,vm.updateNextSlot=updateNextSlot,vm.updateListFilteredSlots=updateListFilteredSlots,vm.getDayClass=getDayClass,vm.switchEditMode=switchEditMode,vm.getCurrentCDT=getCurrentCDT,vm.openDuplication=openDuplication,vm.openSaisieModal=openSaisieModal,vm.openCDTClasse=openCDTClasse,vm.openSuppression=openSuppression,vm.openEDT=openEDT,vm.isEmpty=isEmpty,vm.chooseCurrentSlot=chooseCurrentSlot,vm.setCurrentCDT=setCurrentCDT,vm.openArchives=openArchives,vm.openPrint=openPrint,vm.openCorrespondances=openCorrespondances,vm.openDocuments=openDocuments,vm.openManuels=openManuels,vm.openRessources=openRessources,vm.openParametrage=openParametrage,vm.correspondanceNeeded=correspondanceNeeded,vm.correspondanceClasseNeeded=correspondanceClasseNeeded,vm.correspondanceMatiereNeeded=correspondanceMatiereNeeded,vm.isCurrentInFuture=isCurrentInFuture,vm.setEditCommentaire=setEditCommentaire,vm.addComment=addComment,vm.archiveCommentaire=archiveCommentaire,vm.scrollTo=scrollTo,vm.scrollToToday=scrollToToday,vm.listMatieresOfClasse=listMatieresOfClasse,vm.associateElemProg=associateElemProg,vm.associateLienManuel=associateLienManuel,vm.dissocierElemProg=dissocierElemProg,vm.dissocierLienManuel=dissocierLienManuel,vm.goToService=goToService,vm.refresh=refresh,vm.showInterrogationsClasse=showInterrogationsClasse,vm.isClasseOrGroupeDefined=isClasseOrGroupeDefined,vm.currentCDT={},vm.cdtfilter={},vm.cahierDeTexteService=CahierDeTexteService,vm.Utils=Utils,vm.statusDropdown={isClasseOpen:!1,isMatiereOpen:!1},vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.cdtService=CahierDeTexteService,vm.parametrage={archives:[],commentaires:!1,correspondancesActives:!0,quota:5e6,manuel:!1,edt:!1,cloud:!1,donneLeModifiable:!1};var moduleCDT=ModuleService.getModule(ModuleService.CODES.CAHIER_DE_TEXTES);moduleCDT&&moduleCDT.params&&(vm.parametrage={archives:""===moduleCDT.params.archives.trim()?[]:moduleCDT.params.archives.trim().split("\n"),commentaires:"1"===moduleCDT.params.commentaires,correspondancesActives:"1"===moduleCDT.params.correspondancesActives,ogecCrypte:moduleCDT.params.ogecCrypte,quota:Number(moduleCDT.params.quota),manuel:"1"===moduleCDT.params.manuel,edt:"1"===moduleCDT.params.edt,cloud:"1"===moduleCDT.params.cloud,donneLeModifiable:"1"===moduleCDT.params.donneLeModifiable}),vm.selectedView="liste",vm.selectedSeanceView="T",vm.libelleToutesLesClasses=vm.parametrage.edt?"Toutes les classes":"Classes",vm.libelleToutesLesMatieres=vm.parametrage.edt?"Toutes les matières":"Matières",vm.fichiers=[],vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",vm.configInputFileAFaire={keepComplete:!1,dropzoneContainer:"#container-afaire",mode:"CDT"},vm.configInputFileAFaire.onCompleteUploadFromCloud=function(){vm.refreshAfterUpload("aFaire")},vm.configInputFileSeance={keepComplete:!1,dropzoneContainer:"#container-seance",mode:"CDT"},vm.configInputFileSeance.onCompleteUploadFromCloud=function(){vm.refreshAfterUpload("seance")},vm.configInputFileAFaire.fromCloudEnabled=vm.parametrage.cloud,vm.configInputFileSeance.fromCloudEnabled=vm.parametrage.cloud,vm.processingFiles=0,vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",timeout:3e6,maxFilesize:2e3};var paramModules=ModuleService.getModule(ModuleService.CODES.CAHIER_DE_TEXTES);vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"others"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"},vm.prolexisEnable="1"===paramModules.params.prolexisEnable,vm.prolexisEnable&&(vm.editorOptions.toolbarGroups.push({name:"DiagPlWs"}),vm.editorOptions.extraPlugins="colorbutton,font,mathjax,base64image,DiagPlWs"),vm.biblioManuelEnable="1"===paramModules.params.lienBiblioManuel,vm.uiListOptions={preferredHeight:70
},vm.format="dd/MM/yyyy",vm.datePicker={dateOptions:{formatYear:"yy",startingDay:1}},$scope.$watch(function(scope){return vm.selectedDate},function(newVal,oldVal){if(angular.isDefined(newVal)&&angular.isDefined(oldVal)&&moment(newVal).isSame(moment(oldVal),"day")&&vm.dateForce)return void(vm.dateForce=!1);if(moment(newVal)>CahierDeTexteService.endRange){CahierDeTexteService.endRange.add({day:1});var EndRangeMinDate=CahierDeTexteService.endRange.format("YYYY-MM-DD");CahierDeTexteService.endRange=moment(newVal);var EndRangeMaxDate=CahierDeTexteService.endRange.format("YYYY-MM-DD");$scope.promiseLoading=CahierDeTexteService.loadSlots(EndRangeMinDate,EndRangeMaxDate).then(function(data){CahierDeTexteService.afterLoadslots(data),"liste"===vm.selectedView&&(vm.redrawCal=!0),vm.afterSelectedDateChange(newVal,oldVal)})}else vm.afterSelectedDateChange(newVal,oldVal)}),$scope.$watch(function(scope){return vm.uiListOptions.range},function(newRange,oldRange){if(!angular.isDefined(vm.selectedDate)){var anneeActuelle,laDate;if(oldRange&&newRange&&0===newRange.index&&oldRange.index>newRange.index){laDate=moment(),anneeActuelle=laDate.year(),laDate.month()<8&&(anneeActuelle-=1);var borneMin=moment(anneeActuelle+"-08-01");if(borneMin>=CahierDeTexteService.startRange)return;var BeginRangeMaxDate=CahierDeTexteService.startRange.subtract({day:1}).format("YYYY-MM-DD");CahierDeTexteService.startRange=CahierDeTexteService.startRange.subtract({month:1}),CahierDeTexteService.startRange<borneMin&&(CahierDeTexteService.startRange=borneMin);var BeginRangeMinDate=CahierDeTexteService.startRange.format("YYYY-MM-DD");$scope.promiseLoading=CahierDeTexteService.loadSlots(BeginRangeMinDate,BeginRangeMaxDate).then(function(data){CahierDeTexteService.afterLoadslots(data),vm.updateListFilteredSlots(),$timeout(function(){var slotList=angular.element("#slots")[0],cellHeight=Math.max(angular.element(".ui-list-view-cell-content").height(),vm.uiListOptions.preferredHeight);angular.isDefined(slotList)&&(slotList.scrollTop=data.length*cellHeight)}),"liste"===vm.selectedView&&(vm.redrawCal=!0)})}if(newRange&&0!==newRange.total&&0!==newRange.index&&newRange.index+newRange.length===newRange.total){laDate=moment(),anneeActuelle=laDate.year(),laDate.month()>7&&(anneeActuelle+=1);var borneMax=moment(anneeActuelle+"-07-30");if(borneMax<=CahierDeTexteService.endRange)return;var EndRangeMinDate=CahierDeTexteService.endRange.add({day:1}).format("YYYY-MM-DD");CahierDeTexteService.endRange=CahierDeTexteService.endRange.add({month:1});var EndRangeMaxDate=CahierDeTexteService.endRange.format("YYYY-MM-DD");$scope.promiseLoading=CahierDeTexteService.loadSlots(EndRangeMinDate,EndRangeMaxDate).then(function(data){CahierDeTexteService.afterLoadslots(data),vm.updateListFilteredSlots(),"liste"===vm.selectedView&&(vm.redrawCal=!0)})}}}),vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteSaisieModalCtrl",["$scope","$uibModalInstance","cahierdetexteCtrl",function($scope,$uibModalInstance,cahierdetexteCtrl){var vm=this;$scope.cahierdetexteCtrl=cahierdetexteCtrl,vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteDashboardCopiesCorrectifsCtrl",["$uibModalInstance","$filter","$uibModal","lodash","Utils","Settings","ModuleService","Auth","CloudService","CahierDeTexteService","MessagerieService","Notification","currentCDT","moment",function($uibModalInstance,$filter,$uibModal,lodash,Utils,Settings,ModuleService,Auth,CloudService,CahierDeTexteService,MessagerieService,Notification,currentCDT,moment){function onCompleteUpload(){Notification.notify("Fichiers enregistrés","Les fichiers ont bien été déposés dans le casier de l'élève.","success","icon-ed_cahierdetexte"),refresh()}function canSendMessageUser(type){return MessagerieService.canSendMessageUser(type)}function addCommentaire(idEleve){var commentaire=$filter("base64encode")(vm.formCommentaires[idEleve].commentaire);vm.promiseLoading=CahierDeTexteService.saveCorrectifsCommentaireEnseignant(vm.currentCDT,idEleve,commentaire).then(function(_){Notification.notify("Commentaire","Le commentaire a bien été enregistré.","success","icon-ed_cahierdetexte"),vm.formCommentaires[idEleve].editing=!1})["catch"](function(error){Notification.notify("Erreur","Une erreur s'est produite lors de l'enregistrement du commentaire. "+error.message,"error","icon-ed_cahierdetexte")})}function cancelCommentaire(idEleve){var eleve=lodash.find(vm.listeEleve,function(item){return item.eleve.id===idEleve});vm.formCommentaires[eleve.eleve.id]={editing:!1,commentaire:$filter("base64decode")(eleve.commentaire)}}function removeCorrectifs(idEleve,idPathCorrectifs){var modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression correctifs élève",config.message="Êtes-vous sûr de vouloir <strong>supprimer</strong> les fichiers et le <strong>commentaire</strong> ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=CloudService.deleteNode(idEleve,[{id:idPathCorrectifs}],Auth.TYPE_USER.ELEVE).then(function(){Notification.notify("Suppression","Les correctifs de cet élève ont bien été supprimés.","success","icon-ed_cahierdetexte"),refresh()})["catch"](function(){Notification.notify("Erreur","Une erreur s'est produite lors de la suppression des correctifs de cet élève.","error","icon-ed_cahierdetexte")})})}function rendreCorrectifs(idEleve){vm.currentIdEleveCorrectifs=idEleve,vm.fichiers=[]}function getEleves(){vm.elevesAll=[],vm.famillesAll=[],vm.elevesWithNoRendu=[],vm.famillesWithNoRendu=[],vm.promiseLoading=CahierDeTexteService.getCopiesCorrectifs(vm.currentCDT).then(function(data){vm.listeEleve=data.eleves,vm.listeEleveDisplay=[].concat(data.eleves),vm.nbCopies=data.nbCopies,vm.nbCopiesTotal=data.nbCopiesTotal,lodash.forEach(data.contactsFamilles,function(famille){famille.type=Auth.TYPE_USER.FAMILLE,vm.famillesAll.push(famille)}),vm.formCommentaires={},lodash.forEach(data.eleves,function(eleve){if(0===eleve.copies){vm.elevesWithNoRendu.push(eleve.eleve);var familles=lodash.filter(vm.famillesAll,{id:eleve.eleve.id});familles.length>0&&(vm.famillesWithNoRendu=vm.famillesWithNoRendu.concat(familles))}vm.elevesAll.push(eleve.eleve),vm.formCommentaires[eleve.eleve.id]={editing:!1,commentaire:$filter("base64decode")(eleve.commentaire)};var nbJoursMaxRenduDevoirCDT=Auth.listParametresIndividuels("nbJoursMaxRenduDevoirCDT");vm.dateButoireRendu=moment(vm.currentCDT.date).add(nbJoursMaxRenduDevoirCDT,"day").toDate()})})["catch"](function(){Notification.notify("Élèves","Une erreur s'est produite lors de la récupération des élèves","error","icon-ed_cahierdetexte")})}function close(){var combien=lodash.filter(vm.formCommentaires,{editing:!0}).length;if(combien>0){var okCallback=function(){$uibModalInstance.close()},cancelCallback=function(notice){notice.remove()};Utils.displayWarningEditRunning(okCallback,cancelCallback)}else $uibModalInstance.close()}function refresh(){getEleves()}var vm=this;vm.currentCDT=currentCDT,vm.Auth=Auth,vm.nbCopies=0,vm.nbCopiesTotal=0,vm.listeEleve=[],vm.listeEleveDisplay=[],vm.formCommentaires={},vm.fichiers=[],vm.currentIdEleveCorrectifs=0,vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT_CORRECTIFS",vm.configInputFile={keepComplete:!0,dropzoneContainer:"#form-deposer-correctif",onCompleteUploadFromCloud:onCompleteUpload,mode:"CDT"},vm.configInputFile.fromCloudEnabled=ModuleService.isModuleEnabled(ModuleService.CODES.CLOUD),vm.rendreCorrectifs=rendreCorrectifs,vm.addCommentaire=addCommentaire,vm.cancelCommentaire=cancelCommentaire,vm.removeCorrectifs=removeCorrectifs,vm.onCompleteUpload=onCompleteUpload,vm.canSendMessageUser=canSendMessageUser,vm.close=close,vm.refresh=refresh,refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteClasseCtrl",["$scope","$uibModalInstance","ProfcahierdetexteCtrl","entity",function($scope,$uibModalInstance,ProfcahierdetexteCtrl,entity){var vm=this;vm.entity=entity,$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteInterrogationsClasseCtrl",["$uibModalInstance","entity","CahierDeTexteService",function($uibModalInstance,entity,CahierDeTexteService){function refresh(){vm.promiseLoading=CahierDeTexteService.listeInterrogations(vm.entity.contexte,vm.entity.id).then(function(interrogation){vm.listInterrogation=interrogation})}var vm=this;vm.entity=entity,vm.refresh=refresh,vm.close=function(){$uibModalInstance.dismiss()},vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteEDTCtrl",["$scope","$uibModalInstance","slots",function($scope,$uibModalInstance,slots){var vm=this;vm.slots=slots,vm.scheduler={mode:"week",config:{xml_date:"%Y-%m-%d %H:%i"}},vm.selectSlot=function(slot){$uibModalInstance.close(slot)},vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").directive("edtDhxScheduler",["CahierDeTexteService","moment","lodash","Utils",function(CahierDeTexteService,moment,lodash,Utils){function getTextColor(event){var textColor="#000";return"month"===scheduler._mode?textColor:Utils.getTextColor(event.color)}function renderEventHeader(start,end,event){var textColor=getTextColor(event),contenu="";return contenu+='<span class="edt-cours-header" style="color: '+textColor+'">',event.isFlexible&&(contenu+='<i class="icon-ed_gestiondesgroupes"></i> '),contenu+=scheduler.templates.event_date(start)+" - "+scheduler.templates.event_date(end),contenu+="</span>"}function renderEventText(start,end,event){var contenu="",textColor=getTextColor(event);return event.groupe&&(event.text+=" - "+event.groupe),contenu+='<span class="edt-cours-text" style="color: '+textColor+'">'+event.text+"</span>",event.travailAFaire&&(contenu+='<div class="badge travail-a-faire" tooltip="Travail à faire saisi"><i class="fa fa-check"></i></div>'),event.contenuDeSeance&&(contenu+='<div class="badge contenu-seance" tooltip-append-to-body="true" tooltip-placement="left" tooltip="Contenu de séance saisi"><i class="fa fa-check"></i></div>'),contenu+='<div class="cahier-text-icon-bar">',contenu+="</div>"}function renderEventBarText(start,end,event){var contenu="",textColor=getTextColor(event);return contenu+='<span class="edt-cours-text" style="color: '+textColor+'">',event.travailAFaire&&(contenu+='<span class="badge travail-a-faire" style="font-size: 5px;min-width: 0;padding: 2px;"><i class="fa fa-check"></i></span>'),event.contenuDeSeance&&(contenu+='<span class="badge contenu-seance" style="font-size: 5px;min-width: 0;padding: 2px;"><i class="fa fa-check"></i></span>'),contenu+=event.text+"</span>"}function onTemplateReady(){scheduler.templates.event_text=renderEventText,scheduler.templates.event_bar_text=renderEventBarText,scheduler.templates.event_header=renderEventHeader}function renderTooltip(start,end,event){var html="";return html+="<b>Cours: </b> "+event.text,html+="<br/> <b>Code matière: </b> "+event.matiereCode,event.prof&&(html+="<br/><b>Enseignant: </b> "+event.prof),html+="<br/><b>Début: </b> "+format(start)+"<br/><b>Fin: </b> "+format(end),event.groupe&&(html+="<br/><b>Groupe: </b>"+event.groupe),event.groupeCode&&(html+="<br/><b>Code groupe: </b>"+event.groupeCode),event.isFlexible&&(html+='<br/><i class="icon-ed_gestiondesgroupes"></i> <i>Groupe flexible</i>'),html}var format=scheduler.date.date_to_str("%H:%i");return{restrict:"A",scope:{events:"=data",scheduler:"=scheduler",idUser:"=",eventClickHandler:"&",typeUser:"="},transclude:!0,template:'<div><div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div></div>',link:function(scope,element){function onViewChange(){var state=scheduler.getState(),minDate=moment(state.min_date).format("YYYY-MM-DD"),maxDate=moment(state.max_date).subtract(1,"days").format("YYYY-MM-DD");moment(state.min_date)<CahierDeTexteService.startRange?(maxDate=CahierDeTexteService.startRange.subtract(1,"days").format("YYYY-MM-DD"),CahierDeTexteService.startRange=moment(state.min_date),minDate=moment(state.min_date).format("YYYY-MM-DD"),scope.requestLoading=CahierDeTexteService.loadSlots(minDate,maxDate).then(function(data){CahierDeTexteService.afterLoadslots(data),scheduler.parse(lodash.filter(CahierDeTexteService.slots,"start_date"),"json")})):moment(state.max_date)>CahierDeTexteService.endRange?(minDate=CahierDeTexteService.endRange.add({day:1}).format("YYYY-MM-DD"),CahierDeTexteService.endRange=moment(state.max_date),maxDate=moment(state.max_date).format("YYYY-MM-DD"),scope.requestLoading=CahierDeTexteService.loadSlots(minDate,maxDate).then(function(data){CahierDeTexteService.afterLoadslots(data),scheduler.parse(lodash.filter(CahierDeTexteService.slots,"start_date"),"json")})):scheduler.parse(lodash.filter(CahierDeTexteService.slots,"start_date"),"json")}function onSelectSlot(id,e){var slot=scheduler.getEvent(id);return scope.eventClickHandler({slot:slot,event:e}),!0}var events={};scope.scheduler||(scope.scheduler={}),scope.scheduler.mode=scope.scheduler.mode||"week",scope.scheduler.date=scope.scheduler.date||new Date,scheduler.ignore_week=function(date){return 0===date.getDay()?!0:void 0};if(!scope.idUser)throw new Error("Missing attribute 'idUser' in directive dhx-scheduler");scope.$watch(function(){return scope.scheduler.mode+scope.scheduler.date.toString()},function(nv){var mode=scheduler.getState();(nv.date!==mode.date||nv.mode!==mode.mode)&&scheduler.setCurrentView(scope.scheduler.date,scope.scheduler.mode)},!0),scope.$watch(function(){return element[0].offsetWidth+"."+element[0].offsetHeight},function(){scheduler.setCurrentView()}),element.addClass("dhx_cal_container"),events.onTemplateReady=scheduler.attachEvent("onTemplatesReady",onTemplateReady),events.onViewChange=scheduler.attachEvent("onViewChange",onViewChange),events.onClick=scheduler.attachEvent("onClick",onSelectSlot),scheduler.initialized=!0,scheduler.config.first_hour=7,scheduler.config.last_hour=19,scheduler.config.separate_short_events=!0,scheduler.config.xml_date="%Y-%m-%d %H:%i",scheduler.config.start_on_monday=!0,scheduler.config.show_loading=!0,scheduler.config.load_date="%Y-%m-%d",scheduler.config.readonly_form=!0,scheduler.config.readonly=!0,scheduler.config.hour_size_px=88,scheduler.config.day_date="%D %j %M",scheduler.config.cascade_event_display=!0,scheduler.templates.tooltip_text=renderTooltip,scheduler.init(element[0],scope.scheduler.date,scope.scheduler.mode),scope.$on("$destroy",function(){scheduler.clearAll(),scheduler.detachEvent(events.onClick),scheduler.detachEvent(events.onViewChange),scheduler.detachEvent(events.onTemplateReady)}),onViewChange()}}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteMakeCorrespondanceCtrl",["$scope","lodash","$uibModalInstance","CahierDeTexteService","ProfcahierdetexteCtrl","slot",function($scope,lodash,$uibModalInstance,CahierDeTexteService,ProfcahierdetexteCtrl,slot){var vm=this;vm.slot=slot,$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,$scope.CahierDeTexteService=CahierDeTexteService;var laClasse=lodash.find(CahierDeTexteService.classes,{code:vm.slot.entityCode,typeEntity:vm.slot.entityType});$scope.allMatieres=angular.isDefined(laClasse)?laClasse.matieres:[],ProfcahierdetexteCtrl.correspondanceClasseNeeded(vm.slot)?vm.step=1:vm.step=2,vm.selectClasse=function(classe){vm.selectedClasse=classe},vm.selectMatiere=function(matiere){vm.selectedMatiere=matiere},vm.associateClasse=function(){CahierDeTexteService.associateClasse(vm.slot.entityCode,vm.slot.entityType,vm.selectedClasse).then(function(){ProfcahierdetexteCtrl.correspondanceMatiereNeeded(vm.slot)?($scope.allMatieres=lodash.find(CahierDeTexteService.classes,{code:vm.slot.entityCode,typeEntity:vm.slot.entityType}).matieres,vm.step=2):$uibModalInstance.close(vm.slot)})},vm.associateMatiere=function(){CahierDeTexteService.associateMatiere(vm.slot.matiereCode,vm.selectedMatiere).then(function(){$uibModalInstance.close(vm.slot)})},vm.closeOK=function(slot){$uibModalInstance.close(slot)},vm.close=function(){lodash.forEach(CahierDeTexteService.slots,function(theSlot){theSlot.selected=!1}),ProfcahierdetexteCtrl.currentCDT={},$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteArchivesCtrl",["$scope","$uibModalInstance","ProfcahierdetexteCtrl",function($scope,$uibModalInstance,ProfcahierdetexteCtrl){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetextePrintCtrl",["$scope","Auth","lodash","$uibModalInstance","ProfcahierdetexteCtrl","Settings","isPrimaire",function($scope,Auth,lodash,$uibModalInstance,ProfcahierdetexteCtrl,Settings,isPrimaire){var vm=this;$scope.format="dd/MM/yyyy",$scope.param={typeImpression:"1",du:new Date,au:new Date},(angular.isUndefined(ProfcahierdetexteCtrl.currentCDT.matiereLibelle)||angular.isUndefined(ProfcahierdetexteCtrl.currentCDT.entityLibelle))&&($scope.param.typeImpression="3",$scope.noCurrentCDT=!0),vm.isPrimaire=angular.isDefined(isPrimaire)?isPrimaire:!1,vm.isPrimaire&&($scope.param.typeImpression="2",$scope.noCurrentCDT=!0),vm.manuallySelectedEntity={},vm.manuallySelectedMatiere={},vm.statusDropdown={isClasseOpen:!1,isMatiereOpen:!1},vm.currentUser=Auth.currentUser(),$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.listMatieresOfCorres=[];var getListMatieresOfCorres=function(){var lesSlotsconcernes=lodash.chain(ProfcahierdetexteCtrl.filteredSlots).uniq("matiereCode").value(),lesMatieres=[];angular.forEach(lesSlotsconcernes,function(unSlot){var mat={code:unSlot.matiereCode,libelle:unSlot.matiereLibelle};lesMatieres.push(mat)}),vm.listMatieresOfCorres=lesMatieres};getListMatieresOfCorres(),vm.print=function(){var settings=Settings.allSettings(),action=settings.apiUri+"cahierdetexte/print"+settings.apiExtension+"?verbe=get",formElement=angular.element("<form/>");formElement.attr({method:"POST",target:"_blank",action:action});var typeImpressionElement=angular.element("<input />"),duElement=angular.element("<input />"),auElement=angular.element("<input />"),idProfElement=angular.element("<input />"),codeMatiereElement=angular.element("<input />"),codeClasseElement=angular.element("<input />"),sautDePageParJourElement=angular.element("<input />"),lienVersDocumentsJointsElement=angular.element("<input />"),ressourcesElement=angular.element("<input />"),afficherCommentairesElement=angular.element("<input />"),tokenElement=angular.element("<input />");typeImpressionElement.attr({type:"hidden",value:$scope.param.typeImpression,name:"typeImpression"}),formElement.append(typeImpressionElement),duElement.attr({type:"hidden",value:moment($scope.param.du).format("YYYY-MM-DD"),name:"du"}),formElement.append(duElement),auElement.attr({type:"hidden",value:moment($scope.param.au).format("YYYY-MM-DD"),name:"au"}),formElement.append(auElement),("1"===$scope.param.typeImpression||1===$scope.param.typeImpression)&&(codeMatiereElement.attr({type:"hidden",value:vm.manuallySelectedMatiere.matiereCode||ProfcahierdetexteCtrl.currentCDT.matiereCode,name:"matiereCode"}),formElement.append(codeMatiereElement)),("2"===$scope.param.typeImpression||"1"===$scope.param.typeImpression||2===$scope.param.typeImpression||1===$scope.param.typeImpression)&&(codeClasseElement.attr({type:"hidden",value:vm.manuallySelectedEntity.entityCode||ProfcahierdetexteCtrl.currentCDT.entityCode,name:"classeCode"}),formElement.append(codeClasseElement)),("3"===$scope.param.typeImpression||3===$scope.param.typeImpression)&&(idProfElement.attr({type:"hidden",value:vm.currentUser.id,name:"idProf"}),formElement.append(idProfElement)),sautDePageParJourElement.attr({type:"hidden",value:$scope.param.sautDePageParJour||!1,name:"sautDePageParJour"}),formElement.append(sautDePageParJourElement),lienVersDocumentsJointsElement.attr({type:"hidden",value:$scope.param.lienVersDocumentsJoints||!1,name:"lienVersDocumentsJoints"}),formElement.append(lienVersDocumentsJointsElement),ressourcesElement.attr({type:"hidden",value:$scope.param.ressources||!1,name:"ressources"}),formElement.append(ressourcesElement),afficherCommentairesElement.attr({type:"hidden",value:$scope.param.afficherCommentaires||!1,name:"afficherCommentaires"}),formElement.append(afficherCommentairesElement),tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),formElement.append(tokenElement),formElement.appendTo("body").submit(),formElement.remove(),$uibModalInstance.dismiss()},vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteCorrespondancesCtrl",["$scope","$uibModalInstance","ProfcahierdetexteCtrl",function($scope,$uibModalInstance,ProfcahierdetexteCtrl){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.close=function(){ProfcahierdetexteCtrl.refresh(!0),$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteDocumentsCtrl",["$scope","$uibModalInstance","ProfcahierdetexteCtrl","CahierDeTexteService","CahierDeTextePrimaireService","lodash","$http","$q",function($scope,$uibModalInstance,ProfcahierdetexteCtrl,CahierDeTexteService,CahierDeTextePrimaireService,lodash,$http,$q){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.documents=[],vm.usage=0,vm.deleteFile=function(document){$scope.promiseLoading=(vm.isPrimaire?CahierDeTextePrimaireService.deleteFile(document):CahierDeTexteService.deleteFile(document)).then(function(){lodash.remove(vm.documents,document),vm.usage=lodash.reduce(vm.documents,function(total,doc){return total+doc.taille},0)})},vm.getDocuments=function(){var defer=$q.defer(),baseUrl="cahierdetexte/fichiers";return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},vm.refresh=function(){$scope.promiseLoading=vm.getDocuments().then(function(docs){vm.usage=lodash.reduce(docs,function(total,doc){return total+doc.taille},0),vm.documents=docs})},vm.close=function(){$uibModalInstance.dismiss()},vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteManuelsCtrl",["$scope","$http","$q","$uibModalInstance","ProfcahierdetexteCtrl","Auth","CahierDeTexteService","lodash","entity","matiere","isPrimaire",function($scope,$http,$q,$uibModalInstance,ProfcahierdetexteCtrl,Auth,CahierDeTexteService,lodash,entity,matiere,isPrimaire){var vm=this;vm.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.entity=angular.isDefined(CahierDeTexteService.classes)?lodash.find(CahierDeTexteService.classes,{code:entity.code}):entity,vm.matiere=matiere,vm.listeEleves=[],vm.listeClasses=angular.isDefined(vm.ProfcahierdetexteCtrl.cahierDeTexteService)?vm.ProfcahierdetexteCtrl.cahierDeTexteService.classes:[vm.entity],vm.manuelsProfAvalaible=[],vm.manuelsEleveAvalaible=[],vm.statusDropdown={isClasseOpen:!1,isClasseBisOpen:!1,isMatiereOpen:!1},vm.statusAccordion={isAccordProfOpen:!1,isAccordElevesOpen:!1},vm.isPrimaire=angular.isDefined(isPrimaire)?isPrimaire:!1,vm.close=function(){$uibModalInstance.dismiss()},vm.getManuelsProf=function(){angular.isDefined(vm.entity)&&($scope.promiseLoading=CahierDeTexteService.manuelsNumeriques(Auth.currentUser().id,"Enseignants",vm.entity.code).then(function(manuels){vm.manuels=manuels}))},vm.tousAucunEleves=function(){lodash.forEach(vm.selectedManuel.eleves,function(ele){ele.affecte=vm.selectedManuel.currentStateTousAucun})},vm.getManuelsProfOrEleveAvalaible=function(){if(vm.selectedManuel=void 0,vm.listeEleves=[],angular.isDefined(vm.entity)&&angular.isDefined(vm.matiere)&&angular.isDefined(vm.matiere.code)){var data={},lesPromises=[];data.modeDistribution="1",data.codeClasse=vm.entity.code,data.codeMatiere=vm.matiere.code;var typeUser="Enseignants",baseUrl=typeUser+"/"+Auth.currentUser().id+"/manuelsNumeriques";lesPromises.push($http({method:"GET",url:baseUrl,data:data}).then(function(response){vm.manuelsProfAvalaible=response.data.data,vm.messageErreurProf=response.data.message},function(error){})),typeUser="Classes",baseUrl=typeUser+"/"+Auth.currentUser().id+"/manuelsNumeriques",lesPromises.push($http({method:"GET",url:baseUrl,data:data}).then(function(response){vm.manuelsEleveAvalaible=response.data.data,vm.messageErreurEleves=response.data.message},function(error){})),$scope.promiseLoading=$q.all(lesPromises)}},vm.showEleve=function(manuel){angular.isUndefined(vm.selectedManuel)||manuel.idRessource!==vm.selectedManuel.idRessource?(vm.selectedManuel=manuel,vm.listeEleves=manuel.eleves):(vm.selectedManuel=void 0,vm.listeEleves=[],vm.closeListeEleve())},vm.closeListeEleve=function(){vm.selectedManuel=void 0,vm.listeEleves=[]},vm.updateAssociationProfManuel=function(manuel){if(angular.isDefined(vm.entity)){var typeUser="Enseignants",data={};data.target="Enseignants",data.modeDistribution="1",data.codeClasse=vm.entity.code,angular.isDefined(vm.matiere)&&(data.codeMatiere=vm.matiere.code),data.manuel=manuel;var baseUrl=typeUser+"/"+Auth.currentUser().id+"/manuelsNumeriques";$scope.promiseLoading=$http({method:"PUT",url:baseUrl,data:data}).then(function(response){},function(error){})}},vm.updateAssociationElevesManuel=function(manuel){if(angular.isDefined(vm.entity)){var typeUser="Enseignants",data={};data.target="Eleves",data.modeDistribution="1",data.codeClasse=vm.entity.code,angular.isDefined(vm.matiere)&&(data.codeMatiere=vm.matiere.code),data.manuel=manuel;var baseUrl=typeUser+"/"+Auth.currentUser().id+"/manuelsNumeriques";$scope.promiseLoading=$http({method:"PUT",url:baseUrl,data:data}).then(function(response){},function(error){})}},vm.refresh=function(){vm.getManuelsProf()},vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteRessourcesCtrl",["$scope","Auth","$uibModalInstance","lodash","ModuleService","Notification","CahierDeTexteService","ProfcahierdetexteCtrl","entity","matiere","$q","$http","$filter","Settings","Utils",function($scope,Auth,$uibModalInstance,lodash,ModuleService,Notification,CahierDeTexteService,ProfcahierdetexteCtrl,entity,matiere,$q,$http,$filter,Settings,Utils){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.Utils=Utils,vm.entity=lodash.find(CahierDeTexteService.classes,{code:entity.code}),vm.matiere=matiere,vm.ressources={},vm.cloudActif=ModuleService.getModule(ModuleService.CODES.CLOUD).enable,vm.statusDropdown={isClasseOpen:!1,isMatiereOpen:!1},vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",vm.fichiers=[],vm.configInputFile={keepComplete:!1,dropzoneContainer:"#container-ressources",mode:"CDT"},vm.configInputFile.fromCloudEnabled=vm.cloudActif,vm.cloudActif&&(vm.configInputFile.fromCloudEnabled=!0,vm.configInputFile.onCompleteUploadFromCloud=function(){vm.refresh()}),vm.processingFiles=0,vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",timeout:3e6,maxFilesize:2e3},vm.close=function(){$uibModalInstance.dismiss()},vm.deleteFile=function(fichierToDelete,listeFichiers){ProfcahierdetexteCtrl.cahierDeTexteService.deleteFile(fichierToDelete).then(function(){lodash.remove(listeFichiers,function(fichier){return fichier.id===fichierToDelete.id})})},vm.getRessources=function(){var defer=$q.defer();if(angular.isUndefined(vm.entity)||angular.isUndefined(vm.entity.code)||angular.isUndefined(vm.matiere.code))return defer.reject(),defer.promise;var matiereCodeFormate=vm.matiere.code;lodash.forEach(ProfcahierdetexteCtrl.cahierDeTexteService.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/ressources/"+vm.entity.code+"/"+matiereCodeFormate;return $scope.promiseLoading=$http({method:"GET",url:baseUrl,data:{}}).then(function(response){var ressources=response.data.data;angular.isDefined(ressources)&&(ressources.contenuDecode=$filter("base64decode")(ressources.contenu)),defer.resolve(ressources)},function(error){defer.reject(error)}),defer.promise},vm.save=function(){var defer=$q.defer();if(angular.isUndefined(vm.entity.code)||angular.isUndefined(vm.ressources.contenuDecode))return defer.reject(),defer.promise;vm.ressources.contenu=$filter("base64encode")(vm.ressources.contenuDecode);var codeMatiere=vm.matiere.code;angular.isUndefined(codeMatiere)&&(codeMatiere="CLASSE");var matiereCodeFormate=codeMatiere;lodash.forEach(ProfcahierdetexteCtrl.cahierDeTexteService.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/ressources/"+vm.entity.code+"/"+matiereCodeFormate,data=vm.ressources;return $scope.promiseLoading=$http({method:"PUT",url:baseUrl,data:data}).then(function(response){Notification.notify("Ressource enregistrée","Votre modification a bien été prise en compte","success",!0),vm.ressources.idCDT=response.data.data.idCDT,defer.resolve()},function(error){defer.reject(error)}),defer.promise},vm.setEditCommentaire=function(etat,commentaire){vm.ressources.editCommentaire=etat,angular.isDefined(commentaire)?(commentaire.editable=etat,etat?(vm.ressources.commentaire=$filter("base64decode")(commentaire.message),vm.ressources.idCommentaireEditable=commentaire.id,lodash.forEach(vm.ressources.commentaires,function(lecommentaire,key){lecommentaire.id!==commentaire.id&&(lecommentaire.editable=!1)})):(vm.ressources.commentaire="",vm.ressources.idCommentaireEditable=0,lodash.forEach(vm.ressources.commentaires,function(lecommentaire,key){lecommentaire.editable=!1}))):(vm.ressources.commentaire="",vm.ressources.idCommentaireEditable=0)},vm.addComment=function(commentaire){commentaire.message=$filter("base64encode")(commentaire.message),angular.isUndefined(vm.ressources.editCommentaire)||0===vm.ressources.idCommentaireEditable?vm.promiseContents=CahierDeTexteService.cahierDeTextesAddComment(Auth.role(),Auth.idUser(),commentaire,CahierDeTexteService.TYPES_SUPPORT.RESSOURCE).then(function(){vm.refresh(),commentaire="",Notification.notify("Commentaire enregistré","Votre commentaire a bien été enregistré","success",!0)}):vm.promiseContents=CahierDeTexteService.cahierDeTextesUpdateComment(Auth.role(),Auth.idUser(),commentaire,CahierDeTexteService.TYPES_SUPPORT.RESSOURCE).then(function(commentaireModifie){vm.ressources.editCommentaire=!1,commentaire.editable=!1,lodash.forEach(vm.ressources.commentaires,function(lecommentaire,key){lecommentaire.id===commentaire.id&&(lecommentaire.message=commentaireModifie.message)}),vm.ressources.idCommentaireEditable=0,Notification.notify("Commentaire modifié","Votre commentaire a bien été modifié","success",!0)})},vm.archiveCommentaire=function(commentaireToDelete){vm.promiseContents=CahierDeTexteService.cahierDeTextesDeleteComment(Auth.role(),Auth.idUser(),commentaireToDelete,CahierDeTexteService.TYPES_SUPPORT.RESSOURCE).then(function(){commentaireToDelete.idAuteur===Auth.idUser()&&commentaireToDelete.profilAuteur===Auth.role()?lodash.remove(vm.ressources.commentaires,function(commentaire){return commentaire.id===commentaireToDelete.id}):vm.refresh(),Notification.notify("Commentaire supprimé","Votre commentaire a bien été supprimé","success",!0)})},vm.refresh=function(){vm.getRessources().then(function(ressources){vm.ressources=ressources})},vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteParametrageCtrl",["Auth","$uibModalInstance","ParametrageService","Notification","$sessionStorage",function(Auth,$uibModalInstance,ParametrageService,Notification,$sessionStorage){var vm=this;vm.backupNbJourRendu="",vm.close=function(){$uibModalInstance.dismiss()},vm.refresh=function(){vm.nbJourRenduDevoirCDT=Auth.listParametresIndividuels("nbJoursMaxRenduDevoirCDT"),
vm.backupNbJourRendu=angular.copy(vm.nbJourRenduDevoirCDT)},vm.cancel=function(){vm.nbJourRenduDevoirCDT=angular.copy(vm.backupNbJourRendu)},vm.saveParametrage=function(){vm.promiseLoading=ParametrageService.updateParametrageIndividuel(Auth.currentUser().id,Auth.role(),"nbJoursMaxRenduDevoirCDT",vm.nbJourRenduDevoirCDT).then(function(data){Auth.setParametresIndividuel("nbJoursMaxRenduDevoirCDT",vm.nbJourRenduDevoirCDT),vm.backupNbJourRendu=angular.copy(vm.nbJourRenduDevoirCDT),Notification.notify("Paramétres","Votre paramétrage a bien été pris en compte","success","fa fa-cog")},function(error){Notification.notify("Paramétres",error.data.message||"L'enregistrement de votre paramétrage a échoué.","error")})},vm.refresh()}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteDupliCtrl",["$scope","$uibModalInstance","lodash","Notification","$q","$http","ProfcahierdetexteCtrl","side",function($scope,$uibModalInstance,lodash,Notification,$q,$http,ProfcahierdetexteCtrl,side){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.side=side;var title="";title="aFaire"===vm.side?"Travail à faire":"Contenu de séance",title+=" des "+ProfcahierdetexteCtrl.currentCDT.entityLibelle+" en "+ProfcahierdetexteCtrl.currentCDT.matiereLibelle,$scope.title=title,vm.nextSlots=ProfcahierdetexteCtrl.nextSlotForDuplication(),vm.selectedSlots=function(){return lodash.filter(vm.nextSlots,function(slot){return slot.selectedForDuplication})},vm.duplicate=function(){var baseUrl="cahierdetexte/duplication",data={origine:ProfcahierdetexteCtrl.currentCDT,side:side,destinations:vm.selectedSlots()};$scope.promiseLoading=$http({method:"POST",url:baseUrl,data:data}).then(function(response){Notification.notify("Enregistrement effectué","Votre saisie a bien été prise en compte","success",!0),$uibModalInstance.close(response)},function(){Notification.notify("Erreur","Une erreur est survenu lors de la duplication","danger")})},vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("CahierdetexteSupprCtrl",["$scope","$uibModalInstance","lodash","Notification","$q","$http","ProfcahierdetexteCtrl","side",function($scope,$uibModalInstance,lodash,Notification,$q,$http,ProfcahierdetexteCtrl,side){var vm=this;$scope.ProfcahierdetexteCtrl=ProfcahierdetexteCtrl,vm.side=side;var title="";title="aFaire"===vm.side?"Suppression d'un travail à faire":"Suppression d'un contenu de séance",$scope.subTitle=ProfcahierdetexteCtrl.currentCDT.entityLibelle+(angular.isDefined(ProfcahierdetexteCtrl.currentCDT.matiereLibelle)?" en "+ProfcahierdetexteCtrl.currentCDT.matiereLibelle:"")+" pour le "+moment(ProfcahierdetexteCtrl.currentCDT.date).format("DD MMMM"),$scope.title=title,vm.deleteSlot=function(){var baseUrl="cahierdetexte/"+side+"/"+ProfcahierdetexteCtrl.currentCDT.idCDT,data={};$scope.promiseLoading=$http({method:"DELETE",url:baseUrl,data:data}).then(function(response){Notification.notify("Effacement effectué","La saisie a bien été supprimée","success",!0),$uibModalInstance.close(response)},function(){Notification.notify("Erreur","Une erreur est survenu lors de la suppression","danger")})},vm.close=function(){$uibModalInstance.dismiss()}}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("ajoutElemProgCDTModalCtrl",["$uibModalInstance","prof","currentCDT",function($uibModalInstance,prof,currentCDT){function close(){$uibModalInstance.close()}var vm=this;vm.idCycleEtab=currentCDT.idCycleEtab,vm.libelleCycle=currentCDT.libelleCycle,vm.currentCDT=currentCDT,vm.prof=prof,vm.close=close}]),angular.module("edsiteApp.cahierDeTexteSaisie").controller("ajoutLienManuelCDTModalCtrl",["$uibModalInstance","currentCDT",function($uibModalInstance,currentCDT){function close(){$uibModalInstance.close()}function save(){$uibModalInstance.close({libelle:vm.libelle,url:vm.url})}var vm=this;vm.idCycleEtab=currentCDT.idCycleEtab,vm.libelleCycle=currentCDT.libelleCycle,vm.currentCDT=currentCDT,vm.save=save,vm.close=close}]),angular.module("edsiteApp.cahierDeTexte").service("CahierDeTexteService",["$q","$http","$filter","lodash","UserService","EDHttp",function($q,$http,$filter,lodash,UserService,EDHttp){var mCahierDeTexte={};return mCahierDeTexte.SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},mCahierDeTexte.TYPES_SUPPORT={CDT:"cahierdetexte",VIE_CLASSE:"viedelaclasse",RESSOURCE:"ressource",TRAVAILAFAIRE:"aFaire",SEANCE:"seance"},mCahierDeTexte.CahierDeTextes=function(idEleve,typeContexte){var defer=$q.defer(),data={},baseUrl=typeContexte+"/"+idEleve+"/cahierdetexte";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.manuelsNumeriques=function(idUser,typeUser,codeClasse){typeUser=angular.isUndefined(typeUser)?"Eleves":typeUser;var defer=$q.defer(),data={};angular.isDefined(codeClasse)&&(data.codeClasse=codeClasse);var baseUrl=typeUser+"/"+idUser+"/manuelsNumeriques";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.listeMatieres=function(typeEntity,idEntity){var defer=$q.defer(),data={},baseUrl=typeEntity+"/"+idEntity+"/viedelaclasse";return EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.CahierDeTextesParDate=function(idEleve,ladate,typeContexte){var defer=$q.defer(),data={},baseUrl=typeContexte+"/"+idEleve+"/cahierdetexte/"+ladate;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesAddComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata,lTypeUser=$filter("translateTypeUserUrl")(typeUser);typeSupport=typeSupport.toLowerCase();var baseUrl=lTypeUser+"/"+idUser+"/"+typeSupport+"/commentaires";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesUpdateComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata;typeSupport=typeSupport.toLowerCase();var baseUrl=typeUser+"/"+idUser+"/"+typeSupport+"/commentaires/"+ldata.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesDeleteComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata;typeSupport=typeSupport.toLowerCase();var baseUrl=typeUser+"/"+idUser+"/"+typeSupport+"/commentaires/"+ldata.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.eleveCahierDeTextesSetEffectue=function(idEleve,lData){var defer=$q.defer(),data=lData,baseUrl="Eleves/"+idEleve+"/cahierdetexte";return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.afterLoadslots=function(data){if(angular.isDefined(mCahierDeTexte.correspondancesClasses)){data=lodash.uniq(data,function(slot){return angular.isDefined(slot.idCours)?slot.idCours:slot});var slots=mCahierDeTexte.slots.concat(data);mCahierDeTexte.slots=lodash.sortBy(slots,function(slot){return slot.date+slot.start_date+slot.entityCode}),mCahierDeTexte.updateClassesInSlot(),mCahierDeTexte.updateMatiereInSlot()}},mCahierDeTexte.loadSlots=function(minDate,maxDate){var defer=$q.defer();if(angular.isUndefined(minDate)||angular.isUndefined(maxDate))return defer.reject(),defer.promise;var data={},baseUrl="cahierdetexte/loadslots/"+minDate+"/"+maxDate;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.slotTemplate={date:"",niveau:"",entityCode:"",entityLibelle:"",entityType:"",matiereCode:"",matiereLibelle:"",interrogation:!1,travailAFaire:!1,contenuDeSeance:!1,aFaire:{contenu:"",rendreEnLigne:!1,documents:[],commentaires:[]},seance:{contenu:"",documents:[],commentaires:[]}},mCahierDeTexte.getCopiesCorrectifs=function(cdt){var defer=$q.defer(),matiereCodeFormate=cdt.matiereCode;lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+cdt.idCDT+"/"+cdt.entityCode+"/"+matiereCodeFormate+"/pCDTDashboardCopiesCorrectifs";return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.saveCorrectifsCommentaireEnseignant=function(cdt,idEleve,commentaire){var defer=$q.defer(),matiereCodeFormate=cdt.matiereCode;lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+cdt.idCDT+"/"+cdt.entityCode+"/"+matiereCodeFormate+"/pCDTDashboardCopiesCorrectifs";return $http({method:"POST",url:baseUrl,data:{dateCDT:cdt.date,idEleve:idEleve,commentaire:commentaire}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.save=function(slot,typeCDT){var defer=$q.defer(),data=slot,matiereCodeFormate=slot.matiereCode;typeCDT=typeCDT.toLowerCase(),lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+typeCDT+"/"+slot.entityCode+"/"+matiereCodeFormate+"/"+slot.date;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){slot.idCDT=response.data.data.idCDT,slot.temporaire=!1,defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.deleteFile=function(fichier){var defer=$q.defer();if(angular.isUndefined(fichier))return defer.reject(),defer.promise;var data=fichier,baseUrl="cahierdetexte/fichiers/"+fichier.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve()},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateClasse=function(edtEntityCode,edtEntityType,noteClasse){var edtCorres={typeEntity:edtEntityType,classeCode:edtEntityCode},noteCorres={typeEntity:noteClasse.typeEntity,classeCode:noteClasse.code,classeLibelle:noteClasse.libelle},defer=$q.defer();if(angular.isUndefined(edtEntityCode)||angular.isUndefined(edtEntityType)||angular.isUndefined(noteClasse))return defer.reject(),defer.promise;var data={edt:edtCorres,note:noteCorres},baseUrl="cahierdetexte/correspondances";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){angular.isUndefined(mCahierDeTexte.correspondancesClasses)&&(mCahierDeTexte.correspondancesClasses=[]),data.id=response.data.data.id,mCahierDeTexte.correspondancesClasses.push(data),mCahierDeTexte.updateClassesInSlot(),defer.resolve()},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateMatiere=function(edtMatiereCode,noteMatiere){var edtCorres={matiereCode:edtMatiereCode},noteCorres={matiereCode:noteMatiere.code,matiereLibelle:noteMatiere.libelle},defer=$q.defer();if(angular.isUndefined(edtMatiereCode)||angular.isUndefined(noteMatiere))return defer.reject(),defer.promise;var data={edt:edtCorres,note:noteCorres},baseUrl="cahierdetexte/correspondances";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){angular.isUndefined(mCahierDeTexte.correspondancesMatieres)&&(mCahierDeTexte.correspondancesMatieres=[]),data.id=response.data.data.id,mCahierDeTexte.correspondancesMatieres.push(data),mCahierDeTexte.updateMatiereInSlot(),defer.resolve()},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.allMatieres=function(){return lodash.chain(mCahierDeTexte.classes).pluck("matieres").flatten().uniq("code").value()},mCahierDeTexte.initProf=function(params){mCahierDeTexte.ready=!1,mCahierDeTexte.slots=[];var lToday=moment(),currentYear=lToday.year();return lToday.month()<8&&(currentYear-=1),params.edt?mCahierDeTexte.startRange=moment().subtract({month:1}):mCahierDeTexte.startRange=moment(currentYear+"-08-01"),mCahierDeTexte.endRange=moment().add({month:1}),mCahierDeTexte.correspondancesClasses=[],mCahierDeTexte.correspondancesMatieres=[],UserService.getProfClassesGroupesTree().then(function(_classes){var _goodClasses=[],_classesUniq=lodash.uniq(_classes,"code");angular.forEach(_classesUniq,function(_classe){var _goodClasse={libelle:_classe.libelle,id:_classe.id,code:_classe.code,niveaux:_classe.niveaux};_goodClasse.typeEntity=angular.isDefined(_classe.classeId)?"C":"G",_classe.periodes.length>0?_goodClasse.matieres=lodash.chain(_classe.periodes).pluck("matieres").flatten().uniq("id").filter("codeSSMatiere","").value():_goodClasse.matieres=_classe.matieres,_goodClasse.matieres=lodash.uniq(_goodClasse.matieres,"code"),_goodClasses.push(_goodClasse)}),lodash.sortBy(_goodClasses,function(cl){return cl.code}),mCahierDeTexte.classes=_goodClasses,mCahierDeTexte.ready=!0})},mCahierDeTexte.correspondanceClasseInNote=function(slot){var corres=lodash.findWhere(mCahierDeTexte.correspondancesClasses,{edt:{classeCode:slot.entityCode,typeEntity:slot.entityType}});return angular.isDefined(corres)?corres.note:corres},mCahierDeTexte.correspondanceMatiereInNote=function(slot){var corres=lodash.findWhere(mCahierDeTexte.correspondancesMatieres,{edt:{matiereCode:slot.matiereCode}});return angular.isDefined(corres)?corres.note:corres},mCahierDeTexte.setCorrespondancesClasses=function(correspondances){mCahierDeTexte.correspondancesClasses=correspondances,mCahierDeTexte.updateClassesInSlot()},mCahierDeTexte.setCorrespondancesMatieres=function(correspondances){mCahierDeTexte.correspondancesMatieres=correspondances,mCahierDeTexte.updateMatiereInSlot()},mCahierDeTexte.deleteCorrespondance=function(corres,typeCorrespondance){var defer=$q.defer(),baseUrl="cahierdetexte/correspondances/"+corres.id;return $http({method:"DELETE",url:baseUrl,data:{}}).then(function(response){"classe"===typeCorrespondance&&(lodash.remove(mCahierDeTexte.correspondancesClasses,corres),mCahierDeTexte.updateClassesInSlot()),"matiere"===typeCorrespondance&&(lodash.remove(mCahierDeTexte.correspondancesMatieres,corres),mCahierDeTexte.updateMatiereInSlot()),defer.resolve()},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.updateClassesInSlot=function(){angular.forEach(mCahierDeTexte.correspondancesClasses,function(corres){lodash.chain(mCahierDeTexte.slots).where({entityType:corres.edt.typeEntity,entityCode:corres.edt.classeCode}).forEach(function(slot){slot.entityType=corres.note.typeEntity,slot.entityCode=corres.note.classeCode,slot.entityLibelle=corres.note.classeLibelle}).commit()})},mCahierDeTexte.updateMatiereInSlot=function(){angular.forEach(mCahierDeTexte.correspondancesMatieres,function(corres){lodash.chain(mCahierDeTexte.slots).where({matiereCode:corres.edt.matiereCode}).forEach(function(slot){var classeInfo=lodash.find(mCahierDeTexte.classes,{code:slot.entityCode});angular.isDefined(classeInfo)&&angular.isDefined(lodash.find(classeInfo.matieres,{code:corres.note.matiereCode}))&&(slot.matiereCode=corres.note.matiereCode,slot.matiereLibelle=corres.note.matiereLibelle)}).commit()})},mCahierDeTexte.pushNewSlot=function(infos){if(infos.entityCode&&infos.matiereCode&&infos.date){var newSlot=angular.copy(mCahierDeTexte.slotTemplate);newSlot.date=infos.date;var classeInfo=lodash.find(mCahierDeTexte.classes,{code:infos.entityCode}),matiereInfo=lodash.find(classeInfo.matieres,{code:infos.matiereCode});return newSlot.entityCode=classeInfo.code,newSlot.entityType=classeInfo.typeEntity,newSlot.entityLibelle=classeInfo.libelle,newSlot.niveaux=classeInfo.niveaux,newSlot.matiereCode=matiereInfo.code,newSlot.matiereLibelle=matiereInfo.libelle,newSlot.temporaire=!0,mCahierDeTexte.slots.push(newSlot),newSlot}},mCahierDeTexte.purgeTemporairesSlots=function(){lodash.remove(mCahierDeTexte.slots,{temporaire:!0})},mCahierDeTexte.loadCorrespondances=function(){var defer=$q.defer(),baseUrl="cahierdetexte/correspondances";return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){mCahierDeTexte.setCorrespondancesClasses(response.data.data.classes),mCahierDeTexte.setCorrespondancesMatieres(response.data.data.matieres),defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.getCDTUnitaire=function(side,entityCode,matiereCode,date){var defer=$q.defer();if(angular.isUndefined(side)||angular.isUndefined(entityCode)||angular.isUndefined(matiereCode)||angular.isUndefined(date))return defer.reject(),defer.promise;var matiereCodeFormate=matiereCode;lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+side.toLowerCase()+"/"+entityCode+"/"+matiereCodeFormate+"/"+date;return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){var slot=response.data.data;slot.contenuDecode=$filter("base64decode")(slot.contenu),defer.resolve(slot)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateElemProg=function(slotCDT,elemProg){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/elementsprogramme",_data={typeCDT:slotCDT.typeSaisie,idOrigineCatalogue:elemProg.idOrigineCatalogue};return $http({method:"POST",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateLienManuel=function(slotCDT,lienManuel){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/liensmanuels",_data={typeCDT:slotCDT.typeSaisie,urlLien:lienManuel.url,urlLibelle:lienManuel.libelle};return $http({method:"POST",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.dissociateElemProg=function(slotCDT,elemProg,typeSaisie){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/elementsprogramme/"+elemProg.id,_data={typeCDT:typeSaisie,idOrigineCatalogue:elemProg.id};return $http({method:"DELETE",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.dissociateLienManuel=function(slotCDT,lienManuel,typeSaisie){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/liensmanuels",_data={typeCDT:typeSaisie,urlLien:lienManuel.url};return $http({method:"DELETE",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.liensCdtElemProg=function(idEleve,idElemProg){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/cahierdetexte/elementProgramme/"+idElemProg;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.listeInterrogations=function(typeEntity,idEntity){var defer=$q.defer(),data={},baseUrl="enseignant/cahierdetexte/"+typeEntity+"/"+idEntity+"/interrogations";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte}]),angular.module("edsiteApp.cahierDeTextePrimaire",["edsiteApp.Commun","edsiteApp.filterTranslateTypeUser","ui-listView","edsiteApp.casService"]).controller("ProfCahierdetextePrimaireCtrl",["$scope","$timeout","$q","$filter","Auth","Utils","lodash","$sce","$uibModal","Notification","ModuleService","CahierDeTextePrimaireService","Settings","CASService","AppelService","UserService",function($scope,$timeout,$q,$filter,Auth,Utils,lodash,$sce,$uibModal,Notification,ModuleService,CahierDeTextePrimaireService,Settings,CASService,AppelService,UserService){function openCDTClasse(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteClasse.html",controller:"CahierdetexteClasseCtrl as CahierdetexteClasseCtrl",size:"lg",resolve:{entity:function(){return angular.extend(vm.entityConcernee,{contexte:vm.entityConcernee.type!==AppelService.typeEntity.CLASSE?"Groupes":"Classes"})},ProfcahierdetexteCtrl:vm}})}function openManuels(){var entity={libelle:vm.currentCDT.entityLibelle,code:vm.currentCDT.entityCode},matiere={libelle:vm.currentCDT.matiereLibelle,code:vm.currentCDT.matiereCode};$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteManuels.html",controller:"CahierdetexteManuelsCtrl as CahierdetexteManuelsCtrl",size:"lg",backdrop:!1,resolve:{ProfcahierdetexteCtrl:vm,entity:entity,matiere:matiere,isPrimaire:!0}})}function openArchives(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteArchives.html",controller:"CahierdetexteArchivesCtrl as CahierdetexteArchivesCtrl",size:"sm",resolve:{ProfcahierdetexteCtrl:vm}})}function openDocuments(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteDocuments.html",controller:"CahierdetexteDocumentsCtrl as CahierdetexteDocumentsCtrl",size:"lg",resolve:{ProfcahierdetexteCtrl:vm,isPrimaire:!0}})}function openPrint(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetextePrint.html",controller:"CahierdetextePrintCtrl as CahierdetextePrintCtrl",size:"md",resolve:{ProfcahierdetexteCtrl:vm,isPrimaire:!0}})}function openParametrage(){$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteParametrage.html",controller:"CahierdetexteParametrageCtrl as ctrlCahierdetexteParametrage",backdrop:!1})}function initParametrageModule(){var parametrageModule=ModuleService.getModule(ModuleService.CODES.CAHIER_DE_TEXTES);parametrageModule&&parametrageModule.params&&(angular.extend(vm.parametrage,{archives:""===parametrageModule.params.archives.trim()?[]:parametrageModule.params.archives.trim().split("\n"),commentaires:"1"===parametrageModule.params.commentaires,ogecCrypte:parametrageModule.params.ogecCrypte,quota:Number(parametrageModule.params.quota),manuel:"1"===parametrageModule.params.manuel,edt:"1"===parametrageModule.params.edt,cloud:"1"===parametrageModule.params.cloud,donneLeModifiable:"1"===parametrageModule.params.donneLeModifiable,prolexisEnable:"1"===parametrageModule.params.prolexisEnable,biblioManuelEnable:"1"===parametrageModule.params.lienBiblioManuel}),vm.parametrage.prolexisEnable&&(vm.parametrage.editorOptions.toolbarGroups.push({name:"DiagPlWs"}),vm.parametrage.editorOptions.extraPlugins="colorbutton,font,mathjax,base64image,DiagPlWs"))}function initTabDaysSelectedWeek(){vm.tabDaysSelectedWeek.length=0;for(var fisrtDay=moment(vm.selectedDay).startOf("w"),i=0;7>i;i++){var dateJour=fisrtDay.clone().add(i,"d").toDate(),saisieCDT=vm.getSaisieCDTByDate(dateJour);vm.tabDaysSelectedWeek[i]={date:dateJour,travailAFaire:saisieCDT.travailAFaire,contenuDeSeance:saisieCDT.contenuDeSeance}}}function isSelectedDay(date){return CahierDeTextePrimaireService.formateDate(date)===CahierDeTextePrimaireService.formateDate(vm.selectedDay)}function selectDay(date){var isOtherWeek=moment(date).get("w")!==moment(vm.tabDaysSelectedWeek[0]).get("w");vm.selectedDay=date,isOtherWeek&&vm.initTabDaysSelectedWeek(),vm.currentCDT=vm.getSaisieCDTByDate(vm.selectedDay)}function selectPreviousWeek(){vm.selectDay(moment(vm.selectedDay).clone().subtract(1,"w").toDate())}function selectNextWeek(){vm.selectDay(moment(vm.selectedDay).clone().add(1,"w").toDate())}function getDayCssClass(date){var dateFilter=(CahierDeTextePrimaireService.formateDate(date),{entityCode:vm.entityConcernee.code,entityType:vm.entityConcernee.type,date:CahierDeTextePrimaireService.formateDate(date)});return lodash.filter(vm.tabSaisiesCDT,dateFilter).length>0?"avec-slot":""}function refreshAfterUpload(side){var date=CahierDeTextePrimaireService.formateDate(vm.currentCDT.date);vm.promiseLoading=CahierDeTextePrimaireService.getCDTUnitaire(side,vm.currentCDT.entityCode,vm.currentCDT.matiereCode,date).then(function(data){side===CahierDeTextePrimaireService.TYPES_SUPPORT.RESSOURCE?vm.currentCDT.ressources=data:vm.currentCDT[side]=data})}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}function goToService(url){CASService.goToService(url)}function isEmpty(item){return angular.equals({},item)||angular.isUndefined(item)}function setEntityConcernee(entity){vm.entityConcernee=entity;var periodeACharger=CahierDeTextePrimaireService.getPeriodeCDTACharger();if(vm.isReady){var defer=$q.defer();defer.resolve(vm.tabSaisiesCDT),vm.promiseLoading=defer.promise}else vm.promiseLoading=CahierDeTextePrimaireService.loadSlots(CahierDeTextePrimaireService.formateDate(periodeACharger.dateDebut),CahierDeTextePrimaireService.formateDate(periodeACharger.dateFin),!0);vm.promiseLoading.then(function(data){vm.tabSaisiesCDT=data,vm.currentCDT=vm.getSaisieCDTByDate(vm.selectedDay),vm.initTabDaysSelectedWeek(),vm.redrawDatePickerFilter=!0,vm.isReady=!0})}function refresh(){UserService.getProfClassesGroupesTree().then(function(classes){vm.tabEntity=classes;var entity=lodash.find(vm.tabEntity,function(classe){return classe.isPP===!0&&classe.type===AppelService.typeEntity.CLASSE});return angular.isDefined(entity)?void vm.setEntityConcernee(entity):void(vm.redrawDatePickerFilter=!0)})}function getSaisieCDTByDate(date){var saisie,indexCDT=lodash.findIndex(vm.tabSaisiesCDT,function(saisieCDT){return saisieCDT.date===CahierDeTextePrimaireService.formateDate(date)&&saisieCDT.idCDT>0&&saisieCDT.entityType===vm.entityConcernee.type&&saisieCDT.entityCode===vm.entityConcernee.code});return indexCDT>-1?saisie=vm.tabSaisiesCDT[indexCDT]:(saisie=angular.copy(CahierDeTextePrimaireService.defaultSlot),saisie.date=CahierDeTextePrimaireService.formateDate(date),saisie.entityCode=vm.entityConcernee.code,saisie.entityType=vm.entityConcernee.type,saisie.entityLibelle=vm.entityConcernee.libelle),saisie}function onSaisieUpdated(cdtUpdated){var indexCDT=lodash.findIndex(vm.tabSaisiesCDT,function(saisieCDT){return saisieCDT.date===CahierDeTextePrimaireService.formateDate(cdtUpdated.date)&&saisieCDT.entityType===cdtUpdated.entityType&&saisieCDT.entityCode===cdtUpdated.entityCode});indexCDT>-1?CahierDeTextePrimaireService.isCDTEmpty(cdtUpdated)?vm.tabSaisiesCDT.splice(indexCDT,1):vm.tabSaisiesCDT[indexCDT]=cdtUpdated:vm.tabSaisiesCDT.push(cdtUpdated),vm.initTabDaysSelectedWeek(),vm.redrawDatePickerFilter=!0}var vm=this;vm.refresh=refresh,vm.initParametrageModule=initParametrageModule,vm.initTabDaysSelectedWeek=initTabDaysSelectedWeek,vm.selectPreviousWeek=selectPreviousWeek,vm.selectNextWeek=selectNextWeek,vm.isSelectedDay=isSelectedDay,vm.selectDay=selectDay,vm.getDayCssClass=getDayCssClass,vm.refreshAfterUpload=refreshAfterUpload,vm.sanitize=sanitize,vm.goToService=goToService,vm.isEmpty=isEmpty,vm.getSaisieCDTByDate=getSaisieCDTByDate,vm.onSaisieUpdated=onSaisieUpdated,vm.openPrint=openPrint,vm.openDocuments=openDocuments,vm.openArchives=openArchives,vm.openManuels=openManuels,vm.openCDTClasse=openCDTClasse,vm.setEntityConcernee=setEntityConcernee,vm.openParametrage=openParametrage,vm.promiseLoading=null,vm.typeSaisie=CahierDeTextePrimaireService.TYPE_SAISIE,vm.redrawDatePickerFilter=!1,vm.isReady=!1,vm.utils=Utils,vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.entityConcernee={},vm.tabEntity=[],vm.parametrage={archives:[],commentaires:!1,quota:5e6,manuel:!1,cloud:!1,donneLeModifiable:!1,prolexisEnable:!1,biblioManuelEnable:!1},vm.selectedSeanceView=CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE,vm.fichiers=[],vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",vm.configInputFileAFaire={keepComplete:!1,dropzoneContainer:"#container-afaire",mode:"CDT"},vm.configInputFileAFaire.onCompleteUploadFromCloud=function(){vm.refreshAfterUpload(CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE)},vm.configInputFileSeance={keepComplete:!1,dropzoneContainer:"#container-seance",mode:"CDT"},vm.configInputFileSeance.onCompleteUploadFromCloud=function(){vm.refreshAfterUpload(CahierDeTextePrimaireService.TYPE_SAISIE.SEANCE)},vm.configInputFileAFaire.fromCloudEnabled=vm.parametrage.cloud,vm.configInputFileSeance.fromCloudEnabled=vm.parametrage.cloud,vm.processingFiles=0,vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",timeout:3e6,maxFilesize:2e3},vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"others"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"},vm.parametrage.editorOptions=vm.editorOptions,vm.prolexisEnable=!1,vm.biblioManuelEnable=!1,vm.currentCDT=angular.copy(CahierDeTextePrimaireService.defaultSlot),vm.tabSaisiesCDT=[],vm.selectedDay=new Date,vm.tabDaysSelectedWeek=[],vm.initParametrageModule(),vm.initTabDaysSelectedWeek(),vm.refresh()}]),angular.module("edsiteApp.cahierDeTextePrimaire").controller("CahierdetextePrimaireDashboardCopiesCorrectifsCtrl",["$uibModalInstance","$filter","$uibModal","lodash","Utils","Settings","ModuleService","Auth","CloudService","CahierDeTexteService","MessagerieService","Notification","currentCDT",function($uibModalInstance,$filter,$uibModal,lodash,Utils,Settings,ModuleService,Auth,CloudService,CahierDeTexteService,MessagerieService,Notification,currentCDT){function onCompleteUpload(){Notification.notify("Fichiers enregistrés","Les fichiers ont bien été déposés dans le casier de l'élève.","success","icon-ed_cahierdetexte"),refresh()}function canSendMessageUser(type){return MessagerieService.canSendMessageUser(type)}function addCommentaire(idEleve){var commentaire=$filter("base64encode")(vm.formCommentaires[idEleve].commentaire);vm.promiseLoading=CahierDeTexteService.saveCorrectifsCommentaireEnseignant(vm.currentCDT,idEleve,commentaire).then(function(_){Notification.notify("Commentaire","Le commentaire a bien été enregistré.","success","icon-ed_cahierdetexte"),vm.formCommentaires[idEleve].editing=!1})["catch"](function(error){Notification.notify("Erreur","Une erreur s'est produite lors de l'enregistrement du commentaire. "+error.message,"error","icon-ed_cahierdetexte")})}function cancelCommentaire(idEleve){var eleve=lodash.find(vm.listeEleve,function(item){return item.eleve.id===idEleve});vm.formCommentaires[eleve.eleve.id]={editing:!1,commentaire:$filter("base64decode")(eleve.commentaire)}}function removeCorrectifs(idEleve,idPathCorrectifs){var modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{
config:function(){var config={};return config.title="Suppression correctifs élève",config.message="Êtes-vous sûr de vouloir <strong>supprimer</strong> les fichiers et le <strong>commentaire</strong> ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=CloudService.deleteNode(idEleve,[{id:idPathCorrectifs}],Auth.TYPE_USER.ELEVE).then(function(){Notification.notify("Suppression","Les correctifs de cet élève ont bien été supprimés.","success","icon-ed_cahierdetexte"),refresh()})["catch"](function(){Notification.notify("Erreur","Une erreur s'est produite lors de la suppression des correctifs de cet élève.","error","icon-ed_cahierdetexte")})})}function rendreCorrectifs(idEleve){vm.currentIdEleveCorrectifs=idEleve,vm.fichiers=[]}function getEleves(){vm.elevesAll=[],vm.famillesAll=[],vm.elevesWithNoRendu=[],vm.famillesWithNoRendu=[],vm.promiseLoading=CahierDeTexteService.getCopiesCorrectifs(vm.currentCDT).then(function(data){vm.listeEleve=data.eleves,vm.listeEleveDisplay=[].concat(data.eleves),vm.nbCopies=data.nbCopies,vm.nbCopiesTotal=data.nbCopiesTotal,lodash.forEach(data.contactsFamilles,function(famille){famille.type=Auth.TYPE_USER.FAMILLE,vm.famillesAll.push(famille)}),vm.formCommentaires={},lodash.forEach(data.eleves,function(eleve){if(0===eleve.copies){vm.elevesWithNoRendu.push(eleve.eleve);var familles=lodash.filter(vm.famillesAll,{id:eleve.eleve.id});familles.length>0&&(vm.famillesWithNoRendu=vm.famillesWithNoRendu.concat(familles))}vm.elevesAll.push(eleve.eleve),vm.formCommentaires[eleve.eleve.id]={editing:!1,commentaire:$filter("base64decode")(eleve.commentaire)};var nbJoursMaxRenduDevoirCDT=Auth.listParametresIndividuels("nbJoursMaxRenduDevoirCDT");vm.dateButoireRendu=moment(vm.currentCDT.date).add(nbJoursMaxRenduDevoirCDT,"day").toDate()})})["catch"](function(){Notification.notify("Élèves","Une erreur s'est produite lors de la récupération des élèves","error","icon-ed_cahierdetexte")})}function close(){var combien=lodash.filter(vm.formCommentaires,{editing:!0}).length;if(combien>0){var okCallback=function(){$uibModalInstance.close()},cancelCallback=function(notice){notice.remove()};Utils.displayWarningEditRunning(okCallback,cancelCallback)}else $uibModalInstance.close()}function refresh(){getEleves()}var vm=this;vm.currentCDT=currentCDT,vm.Auth=Auth,vm.nbCopies=0,vm.nbCopiesTotal=0,vm.listeEleve=[],vm.listeEleveDisplay=[],vm.formCommentaires={},vm.fichiers=[],vm.currentIdEleveCorrectifs=0,vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT_CORRECTIFS",vm.configInputFile={keepComplete:!0,dropzoneContainer:"#form-deposer-correctif",onCompleteUploadFromCloud:onCompleteUpload,mode:"CDT"},vm.configInputFile.fromCloudEnabled=ModuleService.isModuleEnabled(ModuleService.CODES.CLOUD),vm.rendreCorrectifs=rendreCorrectifs,vm.addCommentaire=addCommentaire,vm.cancelCommentaire=cancelCommentaire,vm.removeCorrectifs=removeCorrectifs,vm.onCompleteUpload=onCompleteUpload,vm.canSendMessageUser=canSendMessageUser,vm.close=close,vm.refresh=refresh,refresh()}]),angular.module("edsiteApp.cahierDeTextePrimaire").service("CahierDeTextePrimaireService",["$q","$http","$filter","lodash","UserService","EDHttp","moment","AppelService",function($q,$http,$filter,lodash,UserService,EDHttp,moment,AppelService){var mCahierDeTexte={};return mCahierDeTexte.SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},mCahierDeTexte.TYPES_SUPPORT={CDT:"cahierdetexte",VIE_CLASSE:"viedelaclasse",RESSOURCE:"ressource",TRAVAILAFAIRE:"aFaire",SEANCE:"seance"},mCahierDeTexte.TYPE_SAISIE={TRAVAILAFAIRE:mCahierDeTexte.TYPES_SUPPORT.TRAVAILAFAIRE,SEANCE:mCahierDeTexte.TYPES_SUPPORT.SEANCE},mCahierDeTexte.defaultSlot={date:"",niveau:"",entityCode:"",entityLibelle:"",entityType:"",matiereCode:AppelService.typeEntity.CLASSE,matiereLibelle:"",interrogation:!1,travailAFaire:!1,contenuDeSeance:!1,aFaire:{contenu:"",rendreEnLigne:!1,documents:[],commentaires:[],donneLe:""},seance:{contenu:"",documents:[],commentaires:[]}},mCahierDeTexte.isCDTEmpty=function(cdt,side){if(!cdt.idCDT||!cdt.travailAFaire&&!cdt.contenuDeSeance)return!0;if(angular.isDefined(side))switch(side){case mCahierDeTexte.TYPE_SAISIE.TRAVAILAFAIRE:return!cdt.travailAFaire;case mCahierDeTexte.TYPE_SAISIE.SEANCE:return!cdt.contenuDeSeance;default:return!0}},mCahierDeTexte.formateDate=function(date){return moment(date).format("YYYY-MM-DD")},mCahierDeTexte.getPeriodeCDTACharger=function(){var lToday=moment(),currentYear=lToday.year();lToday.month()<8&&(currentYear-=1);var dateDebut=moment(currentYear+"-08-01").toDate(),dateFin=moment().add({month:1});return{dateDebut:dateDebut,dateFin:dateFin}},mCahierDeTexte.getCahierDeTextes=function(idContexte,typeContexte){var defer=$q.defer(),data={},baseUrl=typeContexte+"/"+idContexte+"/cahierdetexte";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.manuelsNumeriques=function(idUser,typeUser,codeClasse){typeUser=angular.isUndefined(typeUser)?"Eleves":typeUser;var defer=$q.defer(),data={};angular.isDefined(codeClasse)&&(data.codeClasse=codeClasse);var baseUrl=typeUser+"/"+idUser+"/manuelsNumeriques";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.getCahierDeTextesParDate=function(idContexte,typeContexte,date){var defer=$q.defer(),data={},baseUrl=typeContexte+"/"+idContexte+"/cahierdetexte/"+date;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesAddComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata,lTypeUser=$filter("translateTypeUserUrl")(typeUser);typeSupport=typeSupport.toLowerCase();var baseUrl=lTypeUser+"/"+idUser+"/"+typeSupport+"/commentaires";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesUpdateComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata;typeSupport=typeSupport.toLowerCase();var baseUrl=typeUser+"/"+idUser+"/"+typeSupport+"/commentaires/"+ldata.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.cahierDeTextesDeleteComment=function(typeUser,idUser,ldata,typeSupport){var defer=$q.defer(),data=ldata;typeSupport=typeSupport.toLowerCase();var baseUrl=typeUser+"/"+idUser+"/"+typeSupport+"/commentaires/"+ldata.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.loadSlots=function(minDate,maxDate,useCache){var defer=$q.defer();if(angular.isUndefined(minDate)||angular.isUndefined(maxDate))return defer.reject(),defer.promise;angular.isUndefined(useCache)&&(useCache=!1);var data={},baseUrl="cahierdetexte/loadslots/"+minDate+"/"+maxDate;return EDHttp({method:"GET",url:baseUrl,data:data,cache:useCache}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.save=function(slot,typeCDT){var defer=$q.defer(),data=slot,matiereCodeFormate=slot.matiereCode;typeCDT=typeCDT.toLowerCase(),lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+typeCDT+"/"+slot.entityCode+"/"+matiereCodeFormate+"/"+slot.date;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){slot.idCDT=response.data.data.idCDT,slot.temporaire=!1,defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.deleteFile=function(fichier){var defer=$q.defer();if(angular.isUndefined(fichier))return defer.reject(),defer.promise;var data=fichier,baseUrl="cahierdetexte/fichiers/"+fichier.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve()},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateElemProg=function(slotCDT,elemProg){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/elementsprogramme",_data={typeCDT:slotCDT.typeSaisie,idOrigineCatalogue:elemProg.idOrigineCatalogue};return $http({method:"POST",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.dissociateLienManuel=function(slotCDT,lienManuel,typeSaisie){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/liensmanuels",_data={typeCDT:typeSaisie,urlLien:lienManuel.url};return $http({method:"DELETE",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.associateLienManuel=function(slotCDT,lienManuel){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/liensmanuels",_data={typeCDT:slotCDT.typeSaisie,urlLien:lienManuel.url,urlLibelle:lienManuel.libelle};return $http({method:"POST",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.dissociateElemProg=function(slotCDT,elemProg,typeSaisie){var defer=$q.defer();if(angular.isUndefined(slotCDT.idCDT))return defer.reject(),defer.promise;var baseUrl="cahierdetexte/"+slotCDT.idCDT+"/elementsprogramme/"+elemProg.id,_data={typeCDT:typeSaisie,idOrigineCatalogue:elemProg.id};return $http({method:"DELETE",url:baseUrl,data:_data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.liensCdtElemProg=function(idEleve,idElemProg){var defer=$q.defer(),data={},baseUrl="eleves/"+idEleve+"/cahierdetexte/elementProgramme/"+idElemProg;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte.getCDTUnitaire=function(side,entityCode,matiereCode,date){var defer=$q.defer();if(angular.isUndefined(side)||angular.isUndefined(entityCode)||angular.isUndefined(matiereCode)||angular.isUndefined(date))return defer.reject(),defer.promise;var matiereCodeFormate=matiereCode;lodash.forEach(mCahierDeTexte.SEPARATEURS,function(newCaract,caractToReplace){matiereCodeFormate=matiereCodeFormate.replace(caractToReplace,newCaract)});var baseUrl="cahierdetexte/"+side.toLowerCase()+"/"+entityCode+"/"+matiereCodeFormate+"/"+date;return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){var slot=response.data.data;slot.contenuDecode=$filter("base64decode")(slot.contenu),defer.resolve(slot)},function(error){defer.reject(error)}),defer.promise},mCahierDeTexte}]),angular.module("edsiteApp.cahierDeTextePrimaire").directive("cdtPrimaireTafSeance",function(){return{restrict:"E",scope:{currentCDT:"=",side:"=",parametrage:"=",promiseLoading:"=",onSaisieUpdated:"&"},controller:"CahierdetextePrimaireTafSeanceDirectiveCtrl",controllerAs:"cdtTafSeanceDirectiveCtrl",templateUrl:"modules/cahierDeTextePrimaire/cahierdetextePrimaireTAFSeance-template.html",link:function(scope,element,attrs){}}}).controller("CahierdetextePrimaireTafSeanceDirectiveCtrl",["$scope","$uibModal","$filter","$q","$sessionStorage","$timeout","CahierDeTextePrimaireService","Settings","Utils","Auth","lodash","UserService","Notification",function($scope,$uibModal,$filter,$q,$sessionStorage,$timeout,CahierDeTextePrimaireService,Settings,Utils,Auth,lodash,UserService,Notification){function openSuppression(){var modalInstance=$uibModal.open({templateUrl:"modules/cahierDeTexte/enseignant/cahierdetexteSuppression.html",controller:"CahierdetexteSupprCtrl as CahierdetexteSupprCtrl",size:"lg",resolve:{side:function(){return vm.side},ProfcahierdetexteCtrl:vm}});modalInstance.result.then(function(response){angular.isDefined(response)&&(angular.extend(vm.currentCDT[vm.side],CahierDeTextePrimaireService.defaultSlot[vm.side]),vm.isTAF?vm.currentCDT.travailAFaire=!1:vm.currentCDT.contenuDeSeance=!1,vm.isEmpty()&&(vm.currentCDT.idCDT=0),$scope.onSaisieUpdated({cdtUpdated:vm.currentCDT}))})}function archiverCommentaire(commentaireToDelete){$scope.promiseLoading=CahierDeTextePrimaireService.cahierDeTextesDeleteComment(Auth.role(),Auth.idUser(),commentaireToDelete,vm.side).then(function(){lodash.remove(vm.currentCDT[vm.side].commentaires,function(commentaire){return commentaire.id===commentaireToDelete.id}),Notification.notify("Commentaire supprimé","Votre commentaire a bien été supprimé","success",!0)})}function isCommentaireArchivable(commentaire){return commentaire.idAuteur===Auth.idUser()&&commentaire.profilAuteur===Auth.role()||Auth.isProfesseur()}function isCommentaireEditable(commentaire){return(!commentaire.editable||0===vm.getIdCommentaireEditable())&&commentaire.idAuteur===Auth.idUser()&&commentaire.profilAuteur===Auth.role()&&Auth.isProfesseur()}function setEditCommentaire(etat,commentaire){vm.isEditionCommentairesDisplayed=etat,angular.isDefined(commentaire)?(commentaire.editable=etat,etat?(vm.currentCDT[vm.side].commentaire=$filter("base64decode")(commentaire.message),vm.currentCDT[vm.side].idCommentaireEditable=commentaire.id,lodash.forEach(vm.currentCDT[vm.side].commentaires,function(lecommentaire,key){lecommentaire.id!==commentaire.id&&(lecommentaire.editable=!1)})):(vm.currentCDT[vm.side].commentaire="",vm.currentCDT[vm.side].idCommentaireEditable=0,lodash.forEach(vm.currentCDT[vm.side].commentaires,function(lecommentaire,key){lecommentaire.editable=!1}))):(vm.currentCDT[vm.side].commentaire="",vm.currentCDT[vm.side].idCommentaireEditable=0)}function addComment(){var commentaire={idContenu:vm.currentCDT.idCDT,message:$filter("base64encode")(vm.currentCDT[vm.side].commentaire),id:vm.currentCDT[vm.side].idCommentaireEditable};0===vm.currentCDT[vm.side].idCommentaireEditable?$scope.promiseLoading=CahierDeTextePrimaireService.cahierDeTextesAddComment(Auth.role(),Auth.idUser(),commentaire,vm.side).then(function(){vm.toggleEditionCommentairesDisplayed(),vm.refreshSide(),commentaire="",Notification.notify("Commentaire enregistré","Votre commentaire a bien été enregistré","success",!0)}):$scope.promiseLoading=CahierDeTextePrimaireService.cahierDeTextesUpdateComment(Auth.role(),Auth.idUser(),commentaire,vm.side).then(function(commentaireModifie){lodash.forEach(vm.currentCDT[vm.side].commentaires,function(lecommentaire){lecommentaire.id===commentaire.id&&(lecommentaire.message=commentaireModifie.message)}),vm.toggleEditionCommentairesDisplayed(),Notification.notify("Commentaire modifié","Votre commentaire a bien été modifié","success",!0)})}function dissocierElemProg(elemProgToDissociate){var typeSaisie=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE?"T":"C";$scope.promiseLoading=CahierDeTextePrimaireService.dissociateElemProg(vm.currentCDT,elemProgToDissociate,typeSaisie).then(function(){var tabElementsProg={};tabElementsProg="T"===typeSaisie?vm.currentCDT.aFaire.elementsProg:vm.currentCDT.seance.elementsProg,lodash.remove(tabElementsProg,function(elemProg){return elemProg.id===elemProgToDissociate.id}),Notification.notify("Dissociation d'un élément de programme","Votre élément de programme a bien été dissocié","success",!0)})}function associateElemProg($event){$event.preventDefault(),$event.stopPropagation();var instanceModaleCatalogue=$uibModal.open({templateUrl:"../../modules/cahierDeTexte/enseignant/ajout-element-programme-cdt.html",controller:"ajoutElemProgCDTModalCtrl as ctrlAjoutElemProgCDT",size:"lg",windowClass:"elem-prog-ajout-modal",backdrop:!1,keyboard:!1,resolve:{prof:function(){var prof={};return prof.matiere=vm.currentCDT.matiereCode,prof.id=vm.idUser,prof},currentCDT:function(){return vm.currentCDT.typeSaisie=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE?"T":"C",vm.currentCDT}}});instanceModaleCatalogue.result.then(function(elemsProg){},function(){})}function refreshSide(){var date=moment(vm.currentCDT.date).format("YYYY-MM-DD");return $scope.promiseLoading=CahierDeTextePrimaireService.getCDTUnitaire(vm.side,vm.currentCDT.entityCode,vm.currentCDT.matiereCode,date).then(function(data){vm.currentCDT[vm.side]=data}),$scope.promiseLoading}function deleteFile(fichierToDelete){$scope.promiseLoading=CahierDeTextePrimaireService.deleteFile(fichierToDelete).then(function(){lodash.remove(vm.currentCDT[vm.side].documents,function(fichier){return fichier.id===fichierToDelete.id})})}function openDonneLeDatePicker($event){$event.preventDefault(),$event.stopPropagation(),vm.isDonneLeOpened=!0}function isModeEdit(){return angular.isDefined(vm.currentCDT[vm.side])&&vm.currentCDT[vm.side].modeEdit===!0}function isEmpty(side){return CahierDeTextePrimaireService.isCDTEmpty(vm.currentCDT,side)}function getDateDonnele(){return vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE&&vm.currentCDT.travailAFaire&&vm.currentCDT.aFaire.donneLe?vm.currentCDT.aFaire.donneLe:""}function getContenu(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].contenu:""}function isRendreEnLigne(){return vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE&&angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].rendreEnLigne:!1}function toggleDropZoneDocumentsDisplayed(){vm.isDropZoneDocumentsDisplayed=!vm.isDropZoneDocumentsDisplayed}function getDocumentsAssocies(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].documents:[]}function getElementsProgrammeAssocies(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].elementsProg:[]}function toggleEditionCommentairesDisplayed(){vm.isEditionCommentairesDisplayed=!vm.isEditionCommentairesDisplayed,vm.currentCDT[vm.side].idCommentaireEditable=0}function getListeCommentairesAssocies(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].commentaires:[]}function getIdCommentaireEditable(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].idCommentaireEditable:0}function getCommentaire(){return angular.isDefined(vm.currentCDT[vm.side])?vm.currentCDT[vm.side].commentaire:null}function getCSSCommentaire(commentaire){return{"fa icon-ed_personnel text-personnel":Utils.isTypePersonnel(commentaire.profilAuteur),"fa icon-ed_prof text-enseignant":Utils.isTypeProfesseur(commentaire.profilAuteur),"fa icon-ed_famille text-famille":Utils.isTypeFamille(commentaire.profilAuteur),"fa icon-ed_eleve text-eleve":Utils.isTypeEleve(commentaire.profilAuteur)}}function switchEditMode(destinationMode,button){var isModeEditDemande="edit"===destinationMode;if(angular.isUndefined(vm.currentCDT.aFaire)&&(vm.currentCDT.aFaire={}),angular.isUndefined(vm.currentCDT.seance)&&(vm.currentCDT.seance={}),isModeEditDemande)vm.currentCDT[vm.side].modeEdit=!0,vm.currentCDT[vm.side].contenuDecode=$filter("base64decode")(vm.currentCDT[vm.side].contenu),vm.currentCDTEdit=angular.copy(vm.currentCDT),vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE&&(angular.isUndefined(vm.currentCDTEdit[vm.side].donneLe)||""===vm.currentCDTEdit[vm.side].donneLe?vm.currentCDTEdit[vm.side].donneLe=new Date:vm.currentCDTEdit[vm.side].donneLe=new Date(vm.currentCDTEdit[vm.side].donneLe));else if("save"===button){if(vm.currentCDTEdit[vm.side].contenuDecode.length>1572864)return void Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo). Utilisez plutôt les documents joints.","danger");vm.parametrage.prolexisEnable&&angular.isDefined(CKEDITOR.instances[vm.side])&&(vm.currentCDTEdit[vm.side].contenuDecode=CKEDITOR.instances[vm.side].getData()),vm.currentCDTEdit[vm.side].contenu=$filter("base64encode")(vm.currentCDTEdit[vm.side].contenuDecode),vm.currentCDTEdit[vm.side].contenu.length>0&&(vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE?vm.currentCDTEdit.travailAFaire=!0:vm.currentCDTEdit.contenuDeSeance=!0),vm.currentCDTEdit[vm.side].contenuDecode="",$scope.promiseLoading=CahierDeTextePrimaireService.save(vm.currentCDTEdit,vm.side).then(function(result){angular.extend(vm.currentCDT,vm.currentCDTEdit),angular.isDefined(result.idCDT)&&vm.setIdCDT(result.idCDT),vm.currentCDT[vm.side].modeEdit=!1,vm.currentCDT.temporaire=!1,$scope.onSaisieUpdated({cdtUpdated:vm.currentCDT}),Notification.notify("Enregistrement effectué","Votre saisie a bien été prise en compte","success",!0)},function(err){Notification.notify("Erreur","Une erreur est survenu lors de l'enregistrement","danger"),vm.currentCDTEdit[vm.side].contenuDecode=$filter("base64decode")(vm.currentCDTEdit[vm.side].contenu)})}else vm.currentCDT[vm.side].modeEdit=!1}function setIdCDT(idCDT){vm.currentCDT.idCDT=idCDT,vm.dropZoneDocumentsConfig.params.idContexte=vm.currentCDT.idCDT}function openQCM(qcm){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"md",resolve:{qcmAssociation:function(){return qcm},isNational:function(){return!1},idEleve:function(){return void 0}}})}function dashBoardCopiesCorrectifs(){$uibModal.open({templateUrl:"modules/cahierDeTextePrimaire/cahierdetextePrimaireDashboardCopiesCorrectifs.html",controller:"CahierdetextePrimaireDashboardCopiesCorrectifsCtrl as ctrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{currentCDT:function(){return vm.currentCDT}}})}var vm=this;vm.openSuppression=openSuppression,vm.openDonneLeDatePicker=openDonneLeDatePicker,vm.associateElemProg=associateElemProg,vm.dissocierElemProg=dissocierElemProg,vm.isModeEdit=isModeEdit,vm.isEmpty=isEmpty,vm.getDateDonnele=getDateDonnele,vm.getContenu=getContenu,vm.isRendreEnLigne=isRendreEnLigne,vm.toggleDropZoneDocumentsDisplayed=toggleDropZoneDocumentsDisplayed,vm.getDocumentsAssocies=getDocumentsAssocies,vm.getElementsProgrammeAssocies=getElementsProgrammeAssocies,vm.toggleEditionCommentairesDisplayed=toggleEditionCommentairesDisplayed,vm.getListeCommentairesAssocies=getListeCommentairesAssocies,vm.getIdCommentaireEditable=getIdCommentaireEditable,vm.getCommentaire=getCommentaire,vm.getCSSCommentaire=getCSSCommentaire,vm.switchEditMode=switchEditMode,vm.deleteFile=deleteFile,vm.refreshSide=refreshSide,vm.addComment=addComment,vm.archiverCommentaire=archiverCommentaire,vm.setEditCommentaire=setEditCommentaire,vm.isCommentaireArchivable=isCommentaireArchivable,vm.isCommentaireEditable=isCommentaireEditable,vm.setIdCDT=setIdCDT,vm.openQCM=openQCM,vm.dashBoardCopiesCorrectifs=dashBoardCopiesCorrectifs,vm.currentCDT=angular.isDefined($scope.currentCDT)?$scope.currentCDT:angular.copy(CahierDeTextePrimaireService.defaultSlot),vm.currentCDTEdit=null,vm.side=angular.isDefined($scope.side)&&""!==$scope.side?$scope.side:CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE,vm.isTAF=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE,vm.isSeance=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.SEANCE,vm.typeSaisie=CahierDeTextePrimaireService.TYPE_SAISIE,vm.title=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE?"Travail à faire":"Contenu de séance",vm.isDonneLeOpened=!1,vm.parametrage=angular.isDefined($scope.parametrage)&&""!==$scope.parametrage?$scope.parametrage:{archives:[],commentaires:!1,quota:5e6,manuel:!1,cloud:!1,donneLeModifiable:!1,prolexisEnable:!1,biblioManuelEnable:!1,editorOptions:{allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"others"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"}},vm.isDropZoneDocumentsDisplayed=!1,vm.fichiers=[],vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",vm.dropZoneDocumentsConfig={url:vm.urlTeleversement,params:{idContexte:vm.currentCDT.idCDT,side:vm.side}},vm.dropZoneDocumentsInputFileConfig={keepComplete:!1,dropzoneContainer:"#container-"+vm.side,mode:"CDT",onCompleteUploadFromCloud:function(){}},vm.isEditionCommentairesDisplayed=!1,vm.dateFormat="dd/MM/yyyy",vm.datePicker={dateOptions:{formatYear:"yy",startingDay:1}},$scope.$watch("currentCDT",function(newValue,oldValue){newValue!==oldValue&&(vm.currentCDT=newValue,vm.setIdCDT(vm.currentCDT.idCDT))}),$scope.$watch("side",function(newValue,oldValue){newValue!==oldValue&&(vm.side=newValue,vm.isTAF=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.TRAVAILAFAIRE,vm.isSeance=vm.side===CahierDeTextePrimaireService.TYPE_SAISIE.SEANCE)})}]),angular.module("edsiteApp.vieDeLaClasse",["ui.bootstrap","edsiteApp.Commun","edsiteApp.filterTranslateTypeUser"]).controller("ViedelaclasseCtrl",["$scope","$routeParams","$timeout","$filter","$sce","$sessionStorage","$uibModal","$location","ModuleService","vieDeLaClasseService","Notification","UserService","Auth","lodash","Settings","CahierDeTexteService","Utils",function($scope,$routeParams,$timeout,$filter,$sce,$sessionStorage,$uibModal,$location,ModuleService,vieDeLaClasseService,Notification,UserService,Auth,lodash,Settings,CahierDeTexteService,Utils){function onCompleteUpload(file){Notification.notify("Fichiers enregistrés","Le fichier a bien été déposé.","success",!0),refresh()}function refresh(){$scope.promiseContents=vieDeLaClasseService.listeVieClasse(vm.contexte,vm.entity.id).then(function(viedelaclasse){vm.viedelaclasse=angular.copy(viedelaclasse),vm.viedelaclasse.contenu=$sce.trustAsHtml($filter("base64decode")(vm.viedelaclasse.contenu)),vm.viedelaclasse.contenuOriginal=angular.copy(vm.viedelaclasse.contenu),vm.blogActif=angular.isDefined(viedelaclasse.commentaires),angular.isDefined($sessionStorage["consultation-classe"])||angular.isDefined($sessionStorage["consultation-groupe"])?vm.classeLibelle=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"].libelle:$sessionStorage["consultation-groupe"].libelle:vm.classeLibelle=vm.entity.libelle,"Groupes"===vm.contexte&&(vm.viedelaclasse.isGroupe=!0,vm.titre="Espace groupe"),vm.viedelaclasse.matieres=lodash.map(vm.viedelaclasse.matieres,function(matiere){return matiere.estEnseignee=lodash.findIndex(vm.matieresProf,{code:matiere.id})>-1,matiere.contenu=$sce.trustAsHtml($filter("base64decode")(matiere.contenu)),matiere.contenuOriginal=angular.copy(matiere.contenu),matiere})})}function setModeEdit(etat,matiere){matiere.editable=etat}function cancel(vieClasse){vieClasse.contenu=vieClasse.contenuOriginal}function saveContenuClasse(vieClasse){var codeMatiere=vieClasse.id;if(vieClasse.contenu.length>1572864)return vieClasse.contenu=vieClasse.contenuOriginal,void Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo). Utilisez plutôt les documents joints.","danger");var vieDeClasse=angular.copy(vieClasse);vieDeClasse.contenu=$filter("base64encode")(vieDeClasse.contenu),vieClasse.contenuOriginal=$sce.trustAsHtml($filter("base64decode")(vieDeClasse.contenu)),$scope.promiseContents=vieDeLaClasseService.save(vm.entity,vieDeClasse,codeMatiere).then(function(){Notification.notify("Vie de la classe","Le contenu a bien été enregistré","success","fa fa-comments"),0===vieClasse.idCDT?refresh():$timeout(function(){MathJax.Hub.Typeset()})})}function deleteFile(fichierToDelete,listeFichiers){CahierDeTexteService.deleteFile(fichierToDelete).then(function(){lodash.remove(listeFichiers,function(fichier){return fichier.id===fichierToDelete.id})})}function setEditCommentaire(etat,matiere,commentaire){matiere.editCommentaire=etat,angular.isDefined(commentaire)?(commentaire.editable=etat,etat?(matiere.commentaire=$filter("base64decode")(commentaire.message),matiere.idCommentaireEditable=commentaire.id,lodash.forEach(matiere.commentaires,function(lecommentaire,key){lecommentaire.id!==commentaire.id&&(lecommentaire.editable=!1)})):(matiere.commentaire="",matiere.idCommentaireEditable=0,lodash.forEach(matiere.commentaires,function(lecommentaire,key){lecommentaire.editable=!1}))):(matiere.commentaire="",matiere.idCommentaireEditable=0)}function addComment(commentaire,entity){commentaire.message=$filter("base64encode")(commentaire.message),angular.isUndefined(entity.editCommentaire)||0===entity.idCommentaireEditable?$scope.promiseContents=CahierDeTexteService.cahierDeTextesAddComment(Auth.role(),Auth.idUser(),commentaire,CahierDeTexteService.TYPES_SUPPORT.VIE_CLASSE).then(function(){refresh(),commentaire="",Notification.notify("Commentaire enregistré","Votre commentaire a bien été enregistré","success",!0)}):$scope.promiseContents=CahierDeTexteService.cahierDeTextesUpdateComment(Auth.role(),Auth.idUser(),commentaire,CahierDeTexteService.TYPES_SUPPORT.VIE_CLASSE).then(function(commentaireModifie){entity.editCommentaire=!1,commentaire.editable=!1,lodash.forEach(entity.commentaires,function(lecommentaire,key){lecommentaire.id===commentaire.id&&(lecommentaire.message=commentaireModifie.message)}),entity.idCommentaireEditable=0,Notification.notify("Commentaire modifié","Votre commentaire a bien été modifié","success",!0)})}function archiveCommentaire(commentaireToDelete,vieClasse){$scope.promiseContents=CahierDeTexteService.cahierDeTextesDeleteComment(Auth.role(),Auth.idUser(),commentaireToDelete,CahierDeTexteService.TYPES_SUPPORT.VIE_CLASSE).then(function(){commentaireToDelete.idAuteur===vm.idUser&&commentaireToDelete.profilAuteur===vm.typeUser?lodash.remove(vieClasse.commentaires,function(commentaire){return commentaire.id===commentaireToDelete.id}):refresh(),Notification.notify("Commentaire supprimé","Votre commentaire a bien été supprimé","success",!0)})}var vm=this;if(vm.viedelaclasse={},vm.idEleve=$routeParams.idEntite,vm.contexte=$routeParams.entite,vm.editable=!1,vm.matieresProf=Auth.currentUser().profile.matieres,vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",vm.titre="Vie de la classe",vm.Utils=Utils,vm.setModeEdit=setModeEdit,vm.addComment=addComment,vm.saveContenuClasse=saveContenuClasse,vm.cancel=cancel,vm.refresh=refresh,vm.deleteFile=deleteFile,vm.archiveCommentaire=archiveCommentaire,vm.setEditCommentaire=setEditCommentaire,Auth.isProfesseur()||Auth.isPersonnel()){if(!ModuleService.isModuleEnabled(ModuleService.CODES.CAHIER_DE_TEXTES))return $location.path("")}else if(!ModuleService.isModuleEnabled(ModuleService.CODES.VIE_DE_LA_CLASSE,vm.idEleve))return $location.path("");angular.isDefined(ModuleService.getModule(ModuleService.CODES.CLOUD))&&(vm.cloudActif=ModuleService.getModule(ModuleService.CODES.CLOUD).enable),"Groupes"===vm.contexte&&(vm.contexteOriginal="Groupes",vm.idcontexteOriginal=vm.idEleve,vm.contexteEnCours=void 0,UserService.getGroupes().then(function(lesGroupes){var leGroupe=lodash.find(lesGroupes,{id:parseInt(vm.idEleve)});vm.lesClassesOriginal=leGroupe.classes})),vm.fichiers=[],vm.configInputFileVieClasse={keepComplete:!0,dropzoneContainer:"#container-classe",mode:"CDT"},vm.configInputFileVieClasseMatiere={keepComplete:!0,
dropzoneContainer:"#container-matiere",mode:"CDT"},vm.configInputFileVieClasse.onCompleteUploadFromCloud=onCompleteUpload,vm.configInputFileVieClasseMatiere.onCompleteUploadFromCloud=onCompleteUpload,vm.configInputFileVieClasse.fromCloudEnabled=!0,vm.configInputFileVieClasseMatiere.fromCloudEnabled=!0,vm.processingFiles=0,vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",timeout:3e6,maxFilesize:2e3},vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"others"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"},$scope.trustAsHtml=function(string){return $sce.trustAsHtml(string)},"Classes"!==vm.contexte&&"Groupes"!==vm.contexte?UserService.getUser("E",vm.idEleve).then(function(user){vm.eleve=user,user.profile?vm.entity=user.profile.classe:vm.entity=user.classe,vm.contexte="Classes",refresh(),ModuleService.clearBadges(ModuleService.CODES.VIE_DE_LA_CLASSE,vm.idEleve)}):(vm.entity=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"]:$sessionStorage["consultation-groupe"],vm.entityOriginal=angular.isDefined($sessionStorage["consultation-classe"])?$sessionStorage["consultation-classe"]:$sessionStorage["consultation-groupe"],refresh())}]),angular.module("edsiteApp.vieDeLaClasse").service("vieDeLaClasseService",["$q","$http","$filter","EDHttp",function($q,$http,$filter,EDHttp){var mVieClasse={};return mVieClasse.listeVieClasse=function(typeEntity,idEntity){var defer=$q.defer(),data={},baseUrl=typeEntity+"/"+idEntity+"/viedelaclasse";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mVieClasse.save=function(entity,vieClasse,codeMatiere){var defer=$q.defer(),data=vieClasse;if(angular.isUndefined(entity.code)||angular.isUndefined(vieClasse.contenu))return defer.reject(),defer.promise;angular.isUndefined(codeMatiere)&&(codeMatiere="CLASSE"),delete vieClasse.matieres;var baseUrl="cahierdetexte/viedelaclasse/"+entity.code+"/"+codeMatiere;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mVieClasse}]),angular.module("edsiteApp.comptesUtilisateur",["edsiteApp.Commun","ui.bootstrap"]).controller("UtilisateurCtrl",["$scope","$routeParams","$uibModal","$sessionStorage","lodash","Auth","ComptesUtilisateurService","Notification","ParametrageService",function($scope,$routeParams,$uibModal,$sessionStorage,lodash,Auth,ComptesUtilisateurService,Notification,ParametrageService){function refresh(){$scope.promiseContents=ComptesUtilisateurService.infosPassword(idUtilisateur).then(function(utilisateurInfosPassword){$scope.promiseContents=ComptesUtilisateurService.comptesAssocies(idUtilisateur).then(function(utilisateurComptes){$scope.utilisateurComptes=utilisateurComptes}),$scope.utilisateurInfosPassword=utilisateurInfosPassword,$scope.backUpInfosPassword=angular.copy($scope.utilisateurInfosPassword)}),ParametrageService.getParametrageIndividuel(Auth.currentUser().id,Auth.role(),"accessibiliteVisuelle").then(function(data){$scope.utilisateurParametres.modeAccessibiliteVisuelle=""!==data.value&&"0"!==data.value}),Auth.isProfesseur()&&ParametrageService.getParametrageIndividuel(Auth.currentUser().id,Auth.role(),"typeSaisieNotesDefaut").then(function(data){$scope.utilisateurParametres.typeSaisieNotesDefaut=""!==data.value?data.value:"multi"})}function addCompteInStorage(){self.lesAccounts=$sessionStorage.user;var search=lodash.where(self.lesAccounts,{idLogin:$scope.newCompteAssocie.idLogin});search.length<=0&&(self.lesAccounts.push($scope.newCompteAssocie),$sessionStorage.user=self.lesAccounts),Auth.setAllUsers(self.lesAccounts)}function mdpIdentiques(formInfosConnexion){if(angular.isUndefined($scope.pw1)||angular.isUndefined($scope.pw2))return!1;if(""===$scope.pw1)return!1;var MdpIdentiques=formInfosConnexion.passConfirm.$modelValue===$scope.pw1;return MdpIdentiques||(formInfosConnexion.$invalid=!0),MdpIdentiques}function associationCompte(infosCompte){angular.isDefined(infosCompte)&&($scope.promiseContents=ComptesUtilisateurService.associer(idUtilisateur,infosCompte).then(function(compteAssocie){if($scope.newCompteAssocie=compteAssocie.data.accounts[0],202===compteAssocie.code){$scope.comptePremiereConnexion={},$scope.origineAction="A",$scope.utilisateurInfosPassword.loginOrigine=infosCompte.newIdentifiant,$scope.utilisateurInfosPassword.motPasseOrigine=infosCompte.newPassword,self.dialogAssoc.close();var dialog=$uibModal.open({templateUrl:"modules/creationCompteUtilisateur/creationCompte.html",scope:$scope,controller:"CreationCompteUtilisateurCtrl"});dialog.result.then(function(data){"okCreation"===data.etat&&($scope.newCompteAssocie=data.newCompteAssocie.data.accounts[0],addCompteInStorage(),Notification.notify("Association d'un compte","Ce compte a bien été associé à votre compte principal","success",!0,!0),$scope.refresh())})}else 200!==compteAssocie.code?Notification.notify("Erreur","Authentification incorrecte","error",!0):(Notification.notify("Association d'un compte","Ce compte a bien été associé à votre compte principal","success",!0,!0),$scope.refresh(),self.dialogAssoc.close("normal"))},function(err){501===err.data.code?Notification.notify("Erreur","L'asociation n'est pas disponible pour ce compte !","error",!0):Notification.notify("Erreur",err.data.message,"error",!0)}))}function openAssociationCompte(){self.dialogAssoc=$uibModal.open({templateUrl:"modules/comptesUtilisateur/associationcompte.html",scope:$scope}),self.dialogAssoc.result.then(function(data){"normal"===data&&(addCompteInStorage(),$scope.refresh())})}function dissociationDeCompte(idCompte){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Dissocier ce compte",config.message="Êtes-vous sûr de vouloir dissocier ce compte ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){ComptesUtilisateurService.dissocier(idUtilisateur,idCompte).then(function(compteDissocie){200!==compteDissocie.data.code?Notification.notify("Erreur","Impossible de dissocier ce compte !","error",!0):($sessionStorage.user=lodash.reject($sessionStorage.user,{idLogin:parseInt(idCompte)}),Auth.setAllUsers($sessionStorage.user),$scope.refresh(),Notification.notify("Dissociation d'un compte","Ce compte a bien été dissocié de votre compte principal","success",!0))})})}function save(){"Autre"!==$scope.utilisateurInfosPassword.questionSecrete&&($scope.utilisateurInfosPassword.autreQuestionSecrete=""),$scope.utilisateurInfosPassword.nouveauMotDePasse=$scope.pw1,$scope.utilisateurInfosPassword.confirmationMotDePasse=$scope.pw2,ComptesUtilisateurService.updateInfosPassword(idUtilisateur,$scope.utilisateurInfosPassword).then(function(infosUtilisateur){200!==infosUtilisateur.data.code?Notification.notify("Erreur",infosUtilisateur.data.message,"error",!0):($scope.utilisateurInfosPassword=infosUtilisateur.data.data,$scope.backUpInfosPassword=angular.copy($scope.utilisateurInfosPassword),Notification.notify("Modification des informations personnelles","Vos informations personnelles ont bien été enregistrées","success",!0))},function(nouveauCompte){509===nouveauCompte.code||508===nouveauCompte.code?Notification.notify("Une erreur est survenue",nouveauCompte.message,"error",!0):Notification.notify("Une erreur est survenue","Echec lors de l'enregistrement","error",!0)})}function saveModeAccessibiliteVisuelle(){$scope.promiseContents=ParametrageService.updateParametrageIndividuel(Auth.currentUser().id,Auth.role(),"accessibiliteVisuelle",$scope.utilisateurParametres.modeAccessibiliteVisuelle).then(function(data){var texteNotif="Activation du mode d'accessibilité visuelle.";$scope.utilisateurParametres.modeAccessibiliteVisuelle||(texteNotif="Désactivation du mode d'accessibilité visuelle."),$sessionStorage["modeAccessibiliteVisuelleActif-"+Auth.role()+"-"+Auth.currentUser().id]=$scope.utilisateurParametres.modeAccessibiliteVisuelle,Auth.setParametresIndividuel("modeAccessibiliteVisuelle",$scope.utilisateurParametres.modeAccessibiliteVisuelle),Notification.notify("Paramétres",texteNotif,"success","fa fa-cog")},function(error){Notification.notify("Paramétres",error.data.message||"L'enregistrement de vos modifications a échoué.","error")})}function saveTypeSaisieNotesDefaut(){$scope.promiseContents=ParametrageService.updateParametrageIndividuel(Auth.currentUser().id,Auth.role(),"typeSaisieNotesDefaut",$scope.utilisateurParametres.typeSaisieNotesDefaut).then(function(data){var texteNotif="Interface de saisie d'évaluation par défaut : "+$scope.utilisateurParametres.typeSaisieNotesDefaut+"-devoir.";$sessionStorage["typeSaisieNotesDefaut-"+Auth.role()+"-"+Auth.currentUser().id]=$scope.utilisateurParametres.typeSaisieNotesDefaut,Auth.setParametresIndividuel("typeSaisieNotesDefaut",$scope.utilisateurParametres.typeSaisieNotesDefaut),Notification.notify("Paramétres",texteNotif,"success","fa fa-cog")},function(error){Notification.notify("Paramétres",error.data.message||"L'enregistrement de vos modifications a échoué.","error")})}function annule(form){$scope.utilisateurInfosPassword=angular.copy($scope.backUpInfosPassword),form.$setPristine(),$scope.pw1="",$scope.pw2=""}$scope.utilisateurInfosPassword={},$scope.utilisateurComptes={},$scope.utilisateurParametres={},$scope.comptePremiereConnexion={},$scope.selected="#motdepasse",$scope.pw1="",$scope.pw2="",$scope.Auth=Auth;var idUtilisateur=$routeParams.idUser,self=this;this.dialogAssoc={},this.lesAccounts={},this.addCompteInStorage=addCompteInStorage,$scope.mdpIdentiques=mdpIdentiques,$scope.associationCompte=associationCompte,$scope.openAssociationCompte=openAssociationCompte,$scope.dissociationDeCompte=dissociationDeCompte,$scope.save=save,$scope.saveModeAccessibiliteVisuelle=saveModeAccessibiliteVisuelle,$scope.saveTypeSaisieNotesDefaut=saveTypeSaisieNotesDefaut,$scope.annule=annule,$scope.refresh=refresh,refresh()}]),angular.module("edsiteApp.comptesUtilisateur").service("ComptesUtilisateurService",["$q","$http",function($q,$http){var mComptesUtilisateur={};return mComptesUtilisateur.infosPassword=function(idLogin){var defer=$q.defer(),data={},baseUrl="logins/"+idLogin;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mComptesUtilisateur.updateInfosPassword=function(idLogin,infosConnexion){var defer=$q.defer(),data=infosConnexion,baseUrl="logins/"+idLogin;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response)},function(error){defer.reject(error.data)}),defer.promise},mComptesUtilisateur.comptesAssocies=function(idLogin){var defer=$q.defer(),data={},baseUrl="logins/"+idLogin+"/comptes";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mComptesUtilisateur.dissocier=function(idLogin,idCompte){var defer=$q.defer(),data={},baseUrl="logins/"+idLogin+"/comptes/"+idCompte;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response)},function(error){defer.reject(error)}),defer.promise},mComptesUtilisateur.associer=function(idLogin,infosCompte){var defer=$q.defer(),data={identifiantCompteAssocie:infosCompte.newIdentifiant,motDePasseComteAssocie:infosCompte.newPassword},baseUrl="logins/"+idLogin+"/comptes";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},mComptesUtilisateur.creerCompte=function(infosCompte,loginOrigine,passOrigine){""!==loginOrigine&&""!==passOrigine&&(infosCompte.login=loginOrigine,infosCompte.motDePasse=passOrigine);var defer=$q.defer(),data=infosCompte,baseUrl="logins";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error.data)}),defer.promise},mComptesUtilisateur}]),angular.module("edsiteApp.comptesUtilisateur").controller("CreationCompteUtilisateurCtrl",["$scope","$routeParams","$location","ComptesUtilisateurService","Notification","$uibModalInstance","Auth",function($scope,$routeParams,$location,ComptesUtilisateurService,Notification,$uibModalInstance,Auth){var infosCompte={},idUtilisateur=$routeParams.idUser;$scope.creationCompte=function(){"C"===$scope.origineAction&&ComptesUtilisateurService.creerCompte($scope.comptePremiereConnexion,$scope.utilisateurInfosPassword.loginOrigine,$scope.utilisateurInfosPassword.motPasseOrigine).then(function(nouveauCompte){202!==nouveauCompte.code?($scope.codeError=nouveauCompte.code,Notification.notify("Echec lors de l'enregistrement",nouveauCompte.message,"error",!0)):($location.path("/login"),Notification.notify("Modifications effectuées","Vous pouvez maintenant vous connecter avec vos nouveaux identifiants !","success",!0),$uibModalInstance.close())},function(nouveauCompte){509===nouveauCompte.code||508===nouveauCompte.code?Notification.notify("Une erreur est survenue",nouveauCompte.message,"error",!0):Notification.notify("Une erreur est survenue","Echec lors de l'enregistrement","error",!0)}),"A"===$scope.origineAction&&Auth.login({identifiant:$scope.utilisateurInfosPassword.loginOrigine,motdepasse:$scope.utilisateurInfosPassword.motPasseOrigine}).then(function(user){202===user.code&&($scope.utilisateurInfosPassword.loginOrigine=user.data.login,$scope.utilisateurInfosPassword.motPasseOrigine=user.data.motDePasse,ComptesUtilisateurService.creerCompte($scope.comptePremiereConnexion,$scope.utilisateurInfosPassword.loginOrigine,$scope.utilisateurInfosPassword.motPasseOrigine).then(function(nouveauCompte){202===nouveauCompte.code?(infosCompte.newIdentifiant=$scope.comptePremiereConnexion.identifiant,infosCompte.newPassword=$scope.comptePremiereConnexion.nouveauMotDePasse,ComptesUtilisateurService.associer(idUtilisateur,infosCompte).then(function(compteAssocie){$uibModalInstance.close({etat:"okCreation",newCompteAssocie:compteAssocie})})):Notification.notify("Echec lors de l'enregistrement",nouveauCompte.message,"error",!0)},function(){Notification.notify("Une erreur est survenue","Echec lors de l'enregistrement","error",!0)}))},function(){Notification.notify("Une erreur est survenue","Echec lors de l'enregistrement","error",!0)})}}]),angular.module("edsiteApp.timeline",["edsiteApp.emploiDuTemps","edsiteApp.Agenda","edsiteApp.Commun"]).controller("EleveaccueilCtrl",["$scope","$routeParams","$sce","$filter","$q","$document","$uibModal","lodash","Settings","Auth","EmploiDuTempsService","TimelineService","eleve","AgendaService","ModuleService",function($scope,$routeParams,$sce,$filter,$q,$document,$uibModal,lodash,Settings,Auth,EmploiDuTempsService,TimelineService,eleve,AgendaService,ModuleService){function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}function bgFor(event,prefix){prefix=angular.isUndefined(prefix)?"bg-":"text-",prefix=angular.isUndefined(prefix)?"bg-":"text-";var eventTypesPrefix={Note:prefix+"success",VieScolaire:prefix+"danger",Document:prefix+"info",ReunionPP:prefix+"warning",Actualite:prefix+"primary",Messagerie:prefix+"primary"};return eventTypesPrefix.hasOwnProperty(event.typeElement)?eventTypesPrefix[event.typeElement]:prefix+"success"}function getIcon(event){var eventTypes={Note:"icon-ed_note",VieScolaire:"icon-ed_viescolaire-light",ReunionPP:"icon-ed_gestiondesgroupes-light",Actualite:"",Messagerie:"icon-ed_messagerie-light"};return eventTypes.hasOwnProperty(event.typeElement)?eventTypes[event.typeElement]:""}function actionFor(event){var eventTypes={Note:"/Eleves/"+$scope.eleve.id+"/Notes?date="+event.date,VieScolaire:"/Eleves/"+$scope.eleve.id+"/VieScolaire",ReunionPP:"/Eleves/"+$scope.eleve.id+"/ReunionParentProf",Actualite:"/Eleves/"+$scope.eleve.id+"/ReunionParentProf",Messagerie:"/eleves/"+$scope.eleve.id+"/Messagerie"};return eventTypes.hasOwnProperty(event.typeElement)?eventTypes[event.typeElement]:""}function isEmpty(obj){for(var i in obj)if(obj.hasOwnProperty(i))return!1;return!0}function displayContenu(event){if(event.contenu&&event.contenu.length>0){var res="";return res=event.contenu.split(" / ").join("<br/>")}return""}function addMoreItems(){$scope.configTimeLine.itemsDisplayedInList<$scope.timeline.length&&($scope.configTimeLine.itemsDisplayedInList=$scope.configTimeLine.itemsDisplayedInList+1)}function isPast(leJour){return moment().isAfter(moment(leJour),"day")}function refresh(){Auth.isFamille?$scope.idUser=$scope.eleve.id:$scope.idUser=Auth.idUser();var lesPromises=[TimelineService.eleveTimeline($scope.eleve.id).then(function(data){var isNoteEnabled=$scope.isModuleEnabled($scope.MODULES_CODES.NOTES,$scope.eleve.id),isVSEnabled=$scope.isModuleEnabled($scope.MODULES_CODES.VIE_SCOLAIRE,$scope.eleve.id),timeline=lodash.filter(data,function(event){return(isVSEnabled||"VieScolaire"!==event.typeElement)&&(isNoteEnabled||"Note"!==event.typeElement)?isPast(event.date)&&"ReunionPP"===event.typeElement?!1:!0:!1});$scope.timeline=timeline}),TimelineService.communTimelineAcceuil(Auth.currentUser().typeCompte,Auth.idUser()).then(function(timeline){$scope.tabPostits=timeline.postits,$scope.agendaEvents=timeline.evenements,AgendaService.cleanEventsFromServer($scope.agendaEvents)})];$scope.promiseContents=$q.all(lesPromises)}$scope.timeline=null,$scope.eleve=eleve,$scope.typeUser="E",$scope.events=[],$scope.configTimeLine={},$scope.configTimeLine.itemsDisplayedInList=16,$scope.agendaEvents=[],$scope.tabPostits=[],$scope.url=Settings.apiUri+"telechargement.awp",$scope.sanitize=sanitize,$scope.isEmpty=isEmpty,$scope.displayContenu=displayContenu,$scope.bgFor=bgFor,$scope.getIcon=getIcon,$scope.actionFor=actionFor,$scope.addMoreItems=addMoreItems,$scope.isPast=isPast,$scope.MODULES_CODES=ModuleService.CODES,$scope.isModuleEnabled=ModuleService.isModuleEnabled,$scope.scheduler={mode:"day"},$scope.postitConfig={addPostit:!1,updatePostit:!1,deletePostit:!1,displayDateCreated:!0,displayDateLimit:!1,displayTargets:!1,visibilityPostitPast:!1},$scope.agendaDroits={updateAgenda:!1,createAgenda:!1,deleteAgenda:!1},refresh()}]),angular.module("edsiteApp.timeline").service("TimelineService",["$q","$http","EDHttp",function($q,$http,EDHttp){var timeline={};return timeline.eleveTimeline=function(idEleve){var defer=$q.defer(),data={};return new EDHttp({method:"GET",url:"eleves/"+idEleve+"/timeline",data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},timeline.communTimelineAcceuil=function(typeUser,idUser){var defer=$q.defer(),data={};return new EDHttp({method:"GET",url:typeUser+"/"+idUser+"/timelineAccueilCommun",data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},timeline}]),angular.module("edsiteApp").filter("schmurtz",function(){return function(input,replacement){return replacement="undefined"==typeof replacement?" ":replacement,"string"==typeof input?input.replace("¤",replacement):input}}),angular.module("edsiteApp").filter("nl2br",function(){return function(msg,isXhtml){var isXhtmlNew=isXhtml||!0,breakTag=isXhtmlNew?"<br />":"<br>";return msg=angular.isDefined(msg)?msg:"",(msg+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n|&#10;)/g,"$1"+breakTag+"$2")}}),angular.module("edsiteApp.DemandeModifications",["edsiteApp.Commun"]).service("DemandeModificationsService",["$q","$http","CacheService","EDHttp",function($q,$http,CacheService,EDHttp){var mDemandeModificationsService={};return mDemandeModificationsService.demandeModifications=function(lesModifs,type){var defer=$q.defer(),data={modifications:lesModifs},baseUrl="demandemodifications/"+type;return CacheService.removeStartWith("famillecoordonnees"),CacheService.removeStartWith("demandemodifications"),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},mDemandeModificationsService.cancelDemande=function(demande,type){var defer=$q.defer(),data={},baseUrl="demandemodifications/"+type+"/"+demande.id;return CacheService.removeStartWith("famillecoordonnees"),CacheService.removeStartWith("demandemodifications"),$http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},mDemandeModificationsService.listeDemandeModifications=function(idUser,type){var defer=$q.defer(),data={},baseUrl="demandemodifications/"+type+"/"+idUser;return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mDemandeModificationsService}]),angular.module("edsiteApp.permissions",[]).factory("PermissionService",["Auth",function(Auth){function requiredPermissionsCheck(loweredPermissions,requiredPermissions,permissionCheckType,hasPermission){loweredPermissions=[],angular.forEach(Auth.getCurrentUserPermissions(),function(permission){loweredPermissions.push(permission.toLowerCase())});for(var permission={},i=0;i<requiredPermissions.length;i+=1)if(permission=requiredPermissions[i].toLowerCase(),permissionCheckType===PermissionsService.enums.permissionCheckType.combinationRequired){if(hasPermission=hasPermission&&loweredPermissions.indexOf(permission)>-1,!hasPermission)break}else if(permissionCheckType===PermissionsService.enums.permissionCheckType.atLeastOne&&(hasPermission=loweredPermissions.indexOf(permission)>-1))break;return hasPermission?PermissionsService.enums.authorised.authorised:PermissionsService.enums.authorised.notAuthorised}var PermissionsService={};return PermissionsService.enums={authorised:{authorised:0,loginRequired:1,notAuthorised:2},permissionCheckType:{atLeastOne:"atLeastOne",combinationRequired:"combinationRequired"}},PermissionsService.authorize=function(loginRequired,requiredPermissions,permissionCheckType){var result=PermissionsService.enums.authorised.authorised,user=Auth.currentUser(),loweredPermissions=[],hasPermission=!0;return permissionCheckType=permissionCheckType||PermissionsService.enums.permissionCheckType.atLeastOne,loginRequired&&void 0===user?result=PermissionsService.enums.authorised.loginRequired:!loginRequired||void 0===user||void 0!==requiredPermissions&&0!==requiredPermissions.length?requiredPermissions&&(result=requiredPermissionsCheck(loweredPermissions,requiredPermissions,permissionCheckType,hasPermission)):result=PermissionsService.enums.authorised.authorised,result},PermissionsService}]),angular.module("edsiteApp").filter("displaySize",function(){return function(input,precision){if(0===input)return"0";if(isNaN(parseFloat(input))||!isFinite(input))return"-";"undefined"==typeof precision&&(precision=1);var units=["o","Ko","Mo","Go","To","Po"],number=Math.floor(Math.log(input)/Math.log(1024));return(input/Math.pow(1024,Math.floor(number))).toFixed(precision)+" "+units[number]}}),angular.module("edsiteApp").filter("htmlToPlaintext",function(){return function(text){return String(text).replace(/<[^>]+>/gm,"")}}),angular.module("edsiteApp").filter("stEdMessagerieFilter",["$filter",function($filter){return function(array,expression){var base64FilterDecode=$filter("base64decode"),htmlFilter=$filter("htmlToPlaintext");if(0===Object.getOwnPropertyNames(expression).length)return array;expression.$=expression.$.toLowerCase(),expression.$=$filter("specialCharacters")(expression.$);var tokens=expression.$.split(/\s+/).filter(Boolean);return array.filter(function(val){var found=!1;if(tokens.some(function(v){var srcStr=$filter("specialCharacters")(val.from.name.toLowerCase());return srcStr.indexOf(v)>=0})&&(found=!0),tokens.some(function(v){var srcStr=$filter("specialCharacters")(val.subject.toLowerCase());return srcStr.indexOf(v)>=0})&&(found=!0),!angular.isUndefined(val.content)){var contentDecoded=base64FilterDecode(val.content);contentDecoded=htmlFilter(contentDecoded),contentDecoded=$filter("specialCharacters")(contentDecoded),tokens.some(function(v){return contentDecoded.toLowerCase().indexOf(v)>=0})&&(found=!0)}return found})}}]),angular.module("edsiteApp.recuperationLogin",["edsiteApp.Commun","angular-md5"]).controller("RecuperationloginCtrl",["$scope","$location","RecuperationloginService","Notification","lodash",function($scope,$location,RecuperationloginService,Notification,lodash){$scope.recupLogin={},$scope.etape=1,$scope.questionsSecretes="",$scope.go=function(path){$location.path(path)},$scope.goToEtape=function(etape){$scope.etape=etape,1===etape&&($scope.recupLogin={})},$scope.giveInfo=function(question,reponse){var ogec="";angular.isDefined(question)&&question.indexOf("¤")>0?(ogec=question.split("¤")[0],$scope.recupLogin.ogec=question.split("¤")[0],$scope.recupLogin.question=question.split("¤")[2],$scope.recupLogin.email=question.split("¤")[3]):$scope.recupLogin.question=question,$scope.recupLogin.reponse=reponse,$scope.promiseRecup=RecuperationloginService.getInfos($scope.recupLogin).then(function(infos){$scope.recupLogin.smsActif=infos.data.smsActif,""===$scope.recupLogin.email&&($scope.recupLogin.email=infos.data.email),220!==infos.code?$scope.recupLogin.smsActif?$scope.goToEtape(2):($scope.go("/login"),Notification.notify("Récupération de mot de passe","Un mail de confirmation va vous être envoyé dans quelques minutes !","success",!0)):Notification.notify("Récupération de mot de passe","Votre réponse est incorrecte !","error",!0)},function(){Notification.notify("Récupération de mot de passe","Nous n'avons pas réussi à vous identifier !","error",!0)})},$scope.displayQuestion=function(question){return question.indexOf("¤")>0?question.split("¤")[1]+"<BR />"+question.split("¤")[2]:question},$scope.listeQuestions=function(){angular.isUndefined($scope.recupLogin.telephone)&&angular.isUndefined($scope.recupLogin.email)?Notification.notify("Récupération de mot de passe","Veuillez renseigner un numéro de téléphone ou une adresse email !","error",!0):$scope.promiseRecup=RecuperationloginService.getInfos($scope.recupLogin).then(function(infos){$scope.questionsSecretes=infos.data.questionsSecretes,$scope.recupLogin.email=infos.data.mail,lodash.uniq($scope.questionsSecretes).length!==$scope.questionsSecretes.length?Notification.notify("Récupération de mot de passe impossible","De multiples questions secrètes sont disponibles pour ce compte. <br> Merci de contacter votre établissement.","error",!0):$scope.goToEtape(3)},function(){Notification.notify("Récupération de mot de passe","Nous n'avons pas réussi à vous identifier !","error",!0)})},$scope.sendMessageConfirm=function(){$scope.promiseRecup=RecuperationloginService.getInfos($scope.recupLogin).then(function(){Notification.notify("Récupération de mot de passe","Un "+$scope.recupLogin.modeReception+" de confirmation vient de vous être envoyé !","success",!0),"sms"===$scope.recupLogin.modeReception?($scope.recupLogin.modeSMS=!0,$scope.go("/changementMotDePasse/global")):$scope.go("/login")},function(){Notification.notify("Récupération de mot de passe","Nous n'avons pas réussi à vous envoyer le message !","error",!0)})}}]),angular.module("edsiteApp.recuperationLogin").service("RecuperationloginService",["$q","$http","md5","base64encodeFilter",function($q,$http,md5,base64encodeFilter){var niveauMDPSecurite=2,mRecuperationLogin={};return mRecuperationLogin.infosRecup={},mRecuperationLogin.getInfos=function(infosRecup){var defer=$q.defer();if(angular.isDefined(infosRecup.hidden)&&""!==infosRecup.hidden.trim())return defer.reject(),defer.promise;var data=infosRecup;this.infosRecup=infosRecup,angular.isDefined(infosRecup.login)&&(data.cle=base64encodeFilter(md5.createHash(infosRecup.login).toUpperCase().split("").reverse().join("")));var baseUrl="recuperationmotdepasse";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){response.data.data.niveauMDPSecurite&&(niveauMDPSecurite=response.data.data.niveauMDPSecurite),defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},mRecuperationLogin.update=function(donneesConnexion){var defer=$q.defer(),data=donneesConnexion,baseUrl="reinitialisationmotdepasse/"+donneesConnexion.typeReinit;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error.data)}),defer.promise},mRecuperationLogin.getNiveauMDPSecurite=function(){return niveauMDPSecurite},mRecuperationLogin}]),angular.module("edsiteApp.recuperationLogin").controller("UpdateloginCtrl",["$scope","$routeParams","$location","RecuperationloginService","Notification",function($scope,$routeParams,$location,RecuperationloginService,Notification){function go(path){$location.path(path).search("key",null)}function mdpIdentiques(formRecupGlobal){if(angular.isUndefined($scope.recupLogin.motDePasse)||angular.isUndefined($scope.recupLogin.motDePasseConfirm))return!1;if(""===$scope.recupLogin.motDePasse)return!1;var MdpIdentiques=formRecupGlobal.passwordConfirmUser.$modelValue===$scope.recupLogin.motDePasse;return MdpIdentiques||(formRecupGlobal.$invalid=!0),MdpIdentiques}$scope.recupLogin=RecuperationloginService.infosRecup,$scope.recupLogin.typeReinit=$routeParams.typeReinit,$scope.recupLogin.key=$routeParams.key,$scope.niveauMDPSecurite=RecuperationloginService.getNiveauMDPSecurite(),$scope.go=go,$scope.mdpIdentiques=mdpIdentiques,$scope.save=function(){angular.isUndefined($scope.recupLogin.modeReception)&&angular.isUndefined($scope.recupLogin.key)?Notification.notify("Modification de vos identifiants de connexion","Impossible de mettre à jour vos identifants !","error",!0):RecuperationloginService.update($scope.recupLogin).then(function(infos){221===infos.code?Notification.notify("Modification de vos identifiants de connexion","Vos identifiants de connexion ont été mis à jour il y a moins de 24h !","error",!0):235===infos.code?Notification.notify("Modification de vos identifiants de connexion","Ce nom d'utilisateur existe déjà, veuillez en choisir un autre !","error",!0):(go("/"),Notification.notify("Modification de vos identifiants de connexion","Vos identifiants de connexion ont bien été mis à jour !","success",!0))},function(infos){505===infos.code?Notification.notify("Modification de vos identifiants de connexion","Veuillez vérifier votre mot de passe de confirmation !","error",!0):580===infos.code?Notification.notify("Modification de vos identifiants de connexion","Une erreur est survenue lors de l'envoi du message !","error",!0):506===infos.code?Notification.notify("Modification de vos identifiants de connexion","Code SMS invalide !","error",!0):521===infos.code?$scope.invalideKey=!0:Notification.notify("Modification de vos identifiants de connexion","Impossible de mettre à jour vos identifants !","error",!0)})}}]),angular.module("edsiteApp").filter("truncate",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");
-1!==lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" …")}}),angular.module("edsiteApp").directive("edTelechargement",["Settings","Auth","lodash",function(Settings,Auth,lodash){return{restrict:"A",scope:{fileId:"=",additionalData:"&",fileType:"@",url:"@",anneeMessages:"="},link:function(scope,element){element.on("click",function(){var settings=Settings.allSettings(),action=scope.url||settings.apiUri+"telechargement"+settings.apiExtension+"?verbe=get",formElement=angular.element("<form/>");formElement.attr({method:"POST",target:"_blank",action:action});var typeFichierElement=angular.element("<input />"),idFichierElement=angular.element("<input />"),tokenElement=angular.element("<input />"),anneeMessagesElement=angular.element("<input />");typeFichierElement.attr({type:"hidden",value:scope.fileType,name:"leTypeDeFichier"}),idFichierElement.attr({type:"hidden",value:scope.fileId,name:"fichierId"}),tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),anneeMessagesElement.attr({type:"hidden",value:scope.anneeMessages,name:"anneeMessages"}),formElement.append(typeFichierElement),formElement.append(idFichierElement),formElement.append(tokenElement),formElement.append(anneeMessagesElement);var additionalData=scope.additionalData();lodash.forEach(additionalData,function(value,key){var newElement=angular.element("<input />");newElement.attr({type:"hidden",value:value,name:key}),formElement.append(newElement)}),formElement.appendTo("body").submit(),formElement.remove()})}}}]),angular.module("edsiteApp.Login").controller("LoginexterneCtrl",["$scope","$location","$sessionStorage","Notification","$routeParams","Auth","$http",function($scope,$location,$sessionStorage,Notification,$routeParams,Auth,$http){function associationCompte(user){angular.extend(data,user),$http({method:"POST",url:baseUrl,data:data}).then(function(response){var user=response.data;200===user.code?($sessionStorage.$reset(),Auth.loginUser(user),$location.path(camefrom).search("camefrom",null).search("token",null).search("atoken",null)):203===user.code?$scope.step="association":Notification.notify("Une erreur est survenue","L'authentification ne peut pas être assurée","error",!0)},function(err){516===err.data.code?Notification.notify("Identifiant/mot de passe invalide","Veuillez vérifier votre saisie","error",!0):Notification.notify("Association impossible","Vous devez relancer la procédure depuis le site d'origine","error",!0)})}$scope.associationCompte=associationCompte;var camefrom="undefined"!=typeof $routeParams.camefrom?$routeParams.camefrom:"/main",token="undefined"!=typeof $routeParams.token?$routeParams.token:"",atoken="undefined"!=typeof $routeParams.atoken?$routeParams.atoken:"",ssotoken="undefined"!=typeof $routeParams.key?$routeParams.key:"",idssotoken="undefined"!=typeof $routeParams.idunique?$routeParams.idunique:"",baseUrl="loginexterne",data={};if(""!==token)data={cToken:token};else if(""!==atoken)data={aToken:atoken};else{if(""===ssotoken)return void($scope.erreur=!0);data={ssoToken:ssotoken,idSSOToken:idssotoken}}$http({method:"POST",url:baseUrl,data:data}).then(function(response){var user=response.data;if(200===user.code)$sessionStorage.$reset(),Auth.loginUser(user),$location.path(camefrom).search("camefrom",null).search("token",null).search("atoken",null);else if(203===user.code){if($scope.step="association",$scope.dataAssociation={identifiant:"",password:""},""!==idssotoken&&idssotoken.split(";").length>3){var idFromURL=idssotoken.split(";")[2],passwordFromURL=idssotoken.split(";")[3];$scope.dataAssociation={identifiant:idFromURL,password:passwordFromURL},associationCompte($scope.dataAssociation)}}else $scope.erreur=!0},function(erreur){$scope.erreur=!0,angular.isDefined(erreur.data)&&angular.isDefined(erreur.data.message)&&($scope.erreurMessage=erreur.data.message)})}]),angular.module("edsiteApp").directive("stSelectAll",function(){return{require:"^stTable",scope:{safeSrc:"=",isAllSelected:"=",stOnChange:"&",stInboxState:"@"},template:'<div class="checkbox"><label><input type="checkbox" ng-model="isAllSelected"\n                                    ng-change="stOnChange({state: stInboxState, cBox: isAllSelected});triggerUpdateSafeCopy()"/></label>\n</div>',link:function(scope,element,attrs,ctrl){scope.triggerUpdateSafeCopy=function(){ctrl.triggerUpdateSafeCopy()}}}}),angular.module("edsiteApp.Commun").factory("MenuService",["$location","Auth","ModuleService","ParametrageService","$sessionStorage","lodash","Settings",function($location,Auth,ModuleService,ParametrageService,$sessionStorage,lodash,Settings){var Menu={},TYPE_USER={1:"parents",2:"parents",E:"élève",A:"personnel",P:"enseignant"},isFamille=Auth.isFamille,isProfesseur=Auth.isProfesseur,isPersonnel=Auth.isPersonnel,isEleve=Auth.isEleve,MODULES_CODES=ModuleService.CODES,getBadges=ModuleService.getBadges,getModule=ModuleService.getModule,isModuleEnabled=ModuleService.isModuleEnabled;return Menu.tabsMenus={},Menu.getEspaceLibelle=function(typeUser){return TYPE_USER[typeUser]},Menu.setMenuOrientation=function(orientation){var idUser=Auth.currentUser().id,typeUser=Auth.role();$sessionStorage["isMenuVertical-"+typeUser+"-"+idUser]=orientation,ParametrageService.updateParametrageIndividuel(idUser,typeUser,Auth.CONSTANTS.PARAMETRE_BDD_MENU_UTILISATEUR,orientation)},Menu.getAllBadgesEleve=function(eleveId){var countBadge=0;return isModuleEnabled(MODULES_CODES.VIE_SCOLAIRE,eleveId)&&(countBadge+=getBadges(MODULES_CODES.VIE_SCOLAIRE,eleveId)),isModuleEnabled(MODULES_CODES.VIE_DE_LA_CLASSE,eleveId)&&(countBadge+=getBadges(MODULES_CODES.VIE_DE_LA_CLASSE,eleveId)),isModuleEnabled(MODULES_CODES.NOTES,eleveId)&&(countBadge+=getBadges(MODULES_CODES.NOTES,eleveId)),isModuleEnabled(MODULES_CODES.MESSAGERIE,eleveId)&&(countBadge+=getBadges(MODULES_CODES.MESSAGERIE,eleveId)),isModuleEnabled(MODULES_CODES.EDT,eleveId)&&(countBadge+=getBadges(MODULES_CODES.EDT,eleveId)),isModuleEnabled(MODULES_CODES.CAHIER_DE_TEXTES,eleveId)&&(countBadge+=getBadges(MODULES_CODES.CAHIER_DE_TEXTES,eleveId)),isModuleEnabled(MODULES_CODES.RESERVATIONS,eleveId)&&(countBadge+=getBadges(MODULES_CODES.RESERVATIONS,eleveId)),isModuleEnabled(MODULES_CODES.REUNIONS_PP,eleveId)&&(countBadge+=getBadges(MODULES_CODES.REUNIONS_PP,eleveId)),isModuleEnabled(MODULES_CODES.CLOUD,eleveId)&&(countBadge+=getBadges(MODULES_CODES.CLOUD,eleveId)),isModuleEnabled(MODULES_CODES.QCM,eleveId)&&(countBadge+=getBadges(MODULES_CODES.QCM,eleveId)),countBadge},Menu.goToService=function(url){if(url.indexOf("PortailsEsidoc")>0)$location.path(url);else{var settings=Settings.allSettings(),action=settings.apiUri+"cas/goToService"+settings.apiExtension+"?service="+url;url.indexOf("esidoc")>0&&url.indexOf("-cas")<0&&(action=url);var formElement=angular.element("<form/>");formElement.attr({method:"POST",target:"_blank",action:action});var tokenElement=angular.element("<input />");tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),formElement.append(tokenElement),formElement.appendTo("body").submit(),formElement.remove()}},Menu.getEsidoc=function(eleveId){var ESIDOC={};if(ESIDOC.esidocModuleEnabled=!1,eleveId){if(ESIDOC.esidocModuleEnabled=isModuleEnabled(MODULES_CODES.ESIDOC,eleveId),ESIDOC.esidocModuleEnabled){var paramsEsidocEleve=getModule(MODULES_CODES.ESIDOC,eleveId).params;if(angular.isDefined(paramsEsidocEleve.tabParams)){var nbrePortailsEsidocEleve=lodash.size(paramsEsidocEleve.tabParams);0===nbrePortailsEsidocEleve?ESIDOC.esidocModuleEnabled=!1:1===nbrePortailsEsidocEleve?(ESIDOC.targetEsidoc="_blank",ESIDOC.urlEsidoc=paramsEsidocEleve.tabParams[0].url,ESIDOC.labelEsidoc=paramsEsidocEleve.tabParams[0].libelle||"Portail CDI"):(ESIDOC.targetEsidoc="",ESIDOC.urlEsidoc="/"+eleveId+"/PortailsEsidoc/",ESIDOC.labelEsidoc="Portails E-sidoc")}}}else if(ESIDOC.esidocModuleEnabled=isModuleEnabled(MODULES_CODES.ESIDOC),ESIDOC.esidocModuleEnabled){var paramsEsidoc=getModule(MODULES_CODES.ESIDOC).params;if(angular.isDefined(paramsEsidoc.tabParams)){var nbrePortailsEsidoc=lodash.size(paramsEsidoc.tabParams);0===nbrePortailsEsidoc?ESIDOC.esidocModuleEnabled=!1:1===nbrePortailsEsidoc?(ESIDOC.targetEsidoc="_blank",ESIDOC.urlEsidoc=paramsEsidoc.tabParams[0].url,ESIDOC.labelEsidoc=paramsEsidoc.tabParams[0].libelle||"Portail CDI"):(ESIDOC.targetEsidoc="",ESIDOC.urlEsidoc="/PortailsEsidoc/",ESIDOC.labelEsidoc="Portails E-sidoc")}}return ESIDOC},Menu.getCantines=function(){var cantines={},caterUrl=getModule(MODULES_CODES.CATER);angular.isDefined(caterUrl)&&(cantines.urlCater=caterUrl.params.urlCATER);var scolaConceptUrl=getModule(MODULES_CODES.SCOLACONCEPT);angular.isDefined(scolaConceptUrl)&&(cantines.urlScolaConcept=scolaConceptUrl.params.urlSCOLACONCEPT);var aliseUrl=getModule(MODULES_CODES.ALISE);angular.isDefined(aliseUrl)&&(cantines.urlAlise=aliseUrl.params.urlAlise);var ardUrl=getModule(MODULES_CODES.ARD);return angular.isDefined(ardUrl)&&(cantines.urlARD=ardUrl.params.urlARD),cantines},Menu.getEdunao=function(){var edunao={};if(isProfesseur()||isEleve()){var eduurl=getModule(MODULES_CODES.EDUNAO);angular.isDefined(eduurl)&&(edunao.urlEdunao=eduurl.params.urlEdunao)}return edunao},Menu.getPearlTrees=function(){var pearlTrees={};if(isPersonnel()||isProfesseur()||isEleve()){var eduurl=getModule(MODULES_CODES.PEARLTREES);angular.isDefined(eduurl)&&(pearlTrees.urlPearlTrees=eduurl.params.urlPearlTrees)}return pearlTrees},Menu.getEduMalin=function(){var eduMalin={};if(isProfesseur()||isEleve()){var eduurl=getModule(MODULES_CODES.EDUMALIN);angular.isDefined(eduurl)&&(eduMalin.urlEduMalin=eduurl.params.urlEduMalin)}return eduMalin},Menu.getClickNPlay=function(){var clickNPlay={};if(isProfesseur()||isEleve()||isFamille()){var eduurl=getModule(MODULES_CODES.CLICKNPLAY);angular.isDefined(eduurl)&&(clickNPlay.urlClickNPlay=eduurl.params.urlClickNPlay)}return clickNPlay},Menu.getAvenria=function(){var avenria={};if(isProfesseur()||isEleve()){var eduurl=getModule(MODULES_CODES.AVENRIA);angular.isDefined(eduurl)&&(avenria.urlAvenria=eduurl.params.urlAvenria)}return avenria},Menu.getONISEPServices=function(){var ONISEPServices={},url=getModule(MODULES_CODES.ONISEPSERVICES);return angular.isDefined(url)&&(ONISEPServices.urlONISEPServices="https://api.ecoledirecte.com/v3/cas/goToService.awp?ogec="+url.params.rneONISEPServices+"&service=https://authentification.onisep.fr/clientredirect?client_name=ECOLE_DIRECTE%26service=https%3A%2F%2Fwww.onisep-services.fr"),ONISEPServices},Menu.getMenuClasseVisible=function(){return isModuleEnabled(MODULES_CODES.CAHIER_DE_TEXTES)||isModuleEnabled(MODULES_CODES.EDT)||isModuleEnabled(MODULES_CODES.APPEL)||isModuleEnabled(MODULES_CODES.CONSULTATION)},Menu.getEntityCourante=function(){var entityCourante={};return(isPersonnel()||isProfesseur())&&(angular.isDefined($sessionStorage["consultation-classe"])&&(entityCourante.entityCourante=$sessionStorage["consultation-classe"],entityCourante.entityCourante.libelleEntity="classe"),angular.isDefined($sessionStorage["consultation-groupe"])&&(entityCourante.entityCourante=$sessionStorage["consultation-groupe"],entityCourante.entityCourante.libelleEntity="groupe")),entityCourante},Menu.isIE=function(){var userAgent=navigator.userAgent.toLowerCase(),appVersion=navigator.appVersion.toLowerCase();return null!==userAgent.match(/MSIE /i)||appVersion.indexOf("trident/")>0},Menu.getTabsMenus=function(){return Menu.tabsMenus},Menu.setTabsMenus=function(tableauxMenus){Menu.tabsMenus=tableauxMenus},Menu}]),angular.module("edsiteApp.menu",[]).directive("edMenuContainer",function(){return{restrict:"AE",controller:"EdMenuContainerCtrl as edMenuContainer"}}).controller("EdMenuContainerCtrl",["MenuService",function(MenuService){var edMenuContainer=this,menusED={};edMenuContainer.registerMenu=function(idMenu,menu){menusED[idMenu]=menu,MenuService.setTabsMenus(menusED)},edMenuContainer.unregisterMenu=function(idMenu){delete menusED[idMenu],MenuService.setTabsMenus(menusED)},edMenuContainer.notifyOpenMenu=function(idMenu){angular.forEach(MenuService.tabsMenus,function(val,key){key!==idMenu&&val.closeMenu()})}}]).directive("edMenu",["lodash","MenuService",function(lodash,MenuService){return{restrict:"E",scope:{message:"@",type:"@",eleve:"=",classe:"=",groupe:"=",isOpen:"="},require:"^edMenuContainer",bindToController:!0,controller:"EdMenuCtrl",controllerAs:"edMenu",templateUrl:"modules/menu/menu-template.html",link:function(scope,element,attrs,container){if(angular.isUndefined(scope.edMenu.type))throw new Error("The menu directive is missing a type attribute (eleve, prof, personnel...)");scope.container=container,scope.idMenu=lodash.uniqueId("edmenu_");var occurenceMenuCourant=lodash.find(MenuService.getTabsMenus(),function(occurenceMenuExistante){if("famille-eleve"!==scope.edMenu.type)return occurenceMenuExistante.type===scope.edMenu.type;if("famille-eleve"===occurenceMenuExistante.type)return occurenceMenuExistante.eleve.id===scope.edMenu.eleve.id&&occurenceMenuExistante.type===scope.edMenu.type});angular.isDefined(occurenceMenuCourant)||(scope.container.registerMenu(scope.idMenu,scope.edMenu),scope.open=!0,("prof-eleve"===scope.edMenu.type||"personnel-eleve"===scope.edMenu.type||"1"===scope.edMenu.type||"2"===scope.edMenu.type)&&scope.edMenu.handleClickMenu(scope.idMenu,!0),scope.$on("$destroy",function(){MenuService.setTabsMenus(lodash.reject(MenuService.getTabsMenus(),{type:scope.edMenu.type}))}))}}}]).controller("EdMenuCtrl",["Auth","$filter","lodash","$scope","$location","ModuleService","MenuService",function(Auth,$filter,lodash,$scope,$location,ModuleService,MenuService){var edMenu=this;this.Auth=Auth,this.initMenu=function(){this.isActive=!1,this.isPinned=!1,this.user=Auth.currentUser(),this.getModule=ModuleService.getModule,this.MODULES_CODES=ModuleService.CODES,this.isModuleEnabled=ModuleService.isModuleEnabled,this.getBadges=ModuleService.getBadges,this.getAllBadgesEleve=MenuService.getAllBadgesEleve,this.isIE=MenuService.isIE,this.menuClasseVisible=MenuService.getMenuClasseVisible,this.TYPE_USER=Auth.TYPE_USER,$scope.allBadgesEleve=0;var entityCrte=MenuService.getEntityCourante();angular.isDefined(entityCrte.entityCourante)&&(this.entityCourante=entityCrte.entityCourante,this.entityCourante.libelleEntity=entityCrte.entityCourante.libelleEntity),$(document).on("click",".navbar-collapse.in",function(e){($(e.target).is("i")||$(e.target).is("a"))&&"dropdown-toggle"!==$(e.target).attr("class")&&$(".navbar-collapse").collapse("hide")}),edMenu.isOpen?this.isPinned=this.isActive=!0:this.isPinned=this.isActive=!1,this.goToService=function(url){MenuService.goToService(url)},this.handleClickMenu=function(idMenuRecu,shouldStayOpen){angular.isDefined(idMenuRecu)&&($scope.idMenu=idMenuRecu),$scope.container.notifyOpenMenu($scope.idMenu),shouldStayOpen?(this.isPinned=!1,this.isActive=!0):(this.isPinned=!this.isPinned,this.isActive=this.isPinned)},this.closeMenu=function(){this.isPinned=!1,this.isActive=!1};var eSidoc={};eSidoc="famille-eleve"===this.type?MenuService.getEsidoc(this.eleve.id):MenuService.getEsidoc(),this.esidocModuleEnabled=eSidoc.esidocModuleEnabled,this.esidocModuleEnabled&&(this.targetEsidoc=eSidoc.targetEsidoc,this.urlEsidoc=eSidoc.urlEsidoc,this.labelEsidoc=eSidoc.labelEsidoc);var cantine=MenuService.getCantines();this.urlCater=cantine.urlCater,this.urlScolaConcept=cantine.urlScolaConcept,this.urlAlise=cantine.urlAlise,this.urlARD=cantine.urlARD;var edunao=MenuService.getEdunao();this.urlEdunao=edunao.urlEdunao,this.urlCDT=this.isModuleEnabled(edMenu.MODULES_CODES.CAHIER_DE_TEXTES)&&"1"===this.getModule(this.MODULES_CODES.CAHIER_DE_TEXTES).params.isCDTPrimaire?"/CahierDeTextePrimaire":"/CahierDeTexte",this.urlPearlTrees=MenuService.getPearlTrees().urlPearlTrees,this.urlEduMalin=MenuService.getEduMalin().urlEduMalin,this.urlClickNPlay=MenuService.getClickNPlay().urlClickNPlay,this.urlONISEPServices=MenuService.getONISEPServices().urlONISEPServices,this.urlAvenria=MenuService.getAvenria().urlAvenria},this.getClassItemMenu=function(path){var isActive=!1;return isActive="/"===path?$location.path()===path:$location.path().substr(0,path.length)===path&&path===$location.path()},this.getUserNameName=function(){function getElevePrenom(){return this.eleve.prenom}function getElevePrenomFormate(){return lodash.capitalize(this.eleve.nom)+" "+lodash.capitalize(this.eleve.prenom)+" ("+this.eleve.classeLibelle+")"}function getCurrentUsername(){return $filter("displayNom")(this.user)}function getClasseName(){return this.classe.libelle}function getGroupeName(){return this.groupe.libelle}var username="",usernameFormate="",usernameByType={};return usernameByType["famille-eleve"]=getElevePrenom,usernameByType["personnel-eleve"]=getElevePrenomFormate,usernameByType["prof-eleve"]=getElevePrenomFormate,usernameByType[this.TYPE_USER.FAMILLE_RESPONSABLE]=getCurrentUsername,usernameByType[this.TYPE_USER.FAMILLE_CONJOINT]=getCurrentUsername,usernameByType[this.TYPE_USER.PERSONNEL]=getCurrentUsername,usernameByType[this.TYPE_USER.ELEVE]=getCurrentUsername,usernameByType[this.TYPE_USER.ENSEIGNANT]=getCurrentUsername,usernameByType.classe=getClasseName,usernameByType.groupe=getGroupeName,username=usernameByType[this.type].apply(this),usernameFormate=Auth.isPersonnel()?username:lodash.capitalize(username)},this.initMenu(),$scope.$watch("edMenu.isOpen",function(newValue,oldValue){newValue!==oldValue&&(edMenu.isOpen?edMenu.isPinned=edMenu.isActive=!0:edMenu.isPinned=edMenu.isActive=!1)},!0)}]),angular.module("edsiteApp.Postits").controller("PostitsCtrl",["Auth","PostitsService",function(Auth,PostitsService){function refresh(){vm.promiseContents=PostitsService.listePostitsAdministrable(vm.user.type,vm.user.id).then(function(postits){vm.tabPostits=postits})}var vm=this;vm.refresh=refresh,vm.postitConfig={addPostit:!0,updatePostit:!0,deletePostit:!0,displayDateCreated:!0,displayDateLimit:!0,displayTargets:!0,displayFormTargets:!0,visibilityPostitPast:!0,displayLibelleAuteur:!0},vm.user={type:Auth.currentUser().typeCompte,id:Auth.idUser()},refresh()}]),angular.module("edsiteApp.Postits").service("PostitsService",["$q","$http","EDHttp","CacheService","lodash",function($q,$http,EDHttp,CacheService,lodash){var mPersonnelPostits={};return mPersonnelPostits.COLORS={alerte:"#FFF956",info:"#d9edf7",couleur1:"#ff8000",couleur2:"#ff0000",couleur3:"#80cc33",couleur4:"#1796b0",couleur5:"#0080ff",couleur6:"#9999ff",couleur7:"#ca619f",couleur8:"#bf00ff"},mPersonnelPostits.TYPE_USER={FAMILLE:{code:"F",libelle:"Famille"},ELEVE:{code:"E",libelle:"Elève"},PERSONNEL:{code:"A",libelle:"Personnel"},PROF:{code:"P",libelle:"Prof"}},mPersonnelPostits.listePostits=function(typeUser,idUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/postits";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelPostits.listePostitsAdministrable=function(typeUser,idUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/postits?administrable=o";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelPostits.ajouter=function(typeUser,idUser,postit){var defer=$q.defer(),data={postit:postit},baseUrl=typeUser+"/"+idUser+"/postits";return CacheService.removeMatch(/.*\/postits/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise},mPersonnelPostits.modifier=function(postit){var defer=$q.defer(),data={postit:postit},baseUrl="postits/"+postit.id;return CacheService.removeMatch(/.*\/postits/),$http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise},mPersonnelPostits.modifierOrdrePostIt=function(postit){var defer=$q.defer(),data={action:"updateordre",postit:postit},baseUrl="postits/"+postit.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise},mPersonnelPostits.supprimer=function(idPostit){var defer=$q.defer(),data={},baseUrl="postits/"+idPostit;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mPersonnelPostits.updateCible=function(code,postit){postit.cible||(postit.cible=[]);var idCible=lodash.findIndex(postit.cible,function(cibleUser){return cibleUser===code});idCible>-1?postit.cible.splice(idCible,1):postit.cible.push(code)},mPersonnelPostits.updateCiblesEtab=function(idEtab,postit){postit.ciblesEtab||(postit.ciblesEtab=[]);var idx=postit.ciblesEtab.indexOf(idEtab);idx>-1?postit.ciblesEtab.splice(idx,1):postit.ciblesEtab.push(idEtab)},mPersonnelPostits}]),angular.module("edsiteApp.cahierDeTexte").directive("viewDay",["$sce","$filter","$uibModal","lodash","Auth","CahierDeTexteService","ModuleService","Settings","Notification","Utils","CASService","moment",function($sce,$filter,$uibModal,lodash,Auth,CahierDeTexteService,ModuleService,Settings,Notification,Utils,CASService,moment){return{templateUrl:"modules/cahierDeTexte/eleve/viewday.html",restrict:"E",scope:{day:"=",actif:"=",cdt:"=",idEleve:"=",contexte:"=",loadData:"=",cahierDeTexte:"=",viewMode:"=",setModeActif:"&",isPast:"&",manuelsByMatiere:"&",refreshCurrentDay:"&",isCompteRenduSeanceEnabled:"="},link:function(scope){function onCompleteUpload(){Notification.notify("Fichiers enregistrés","Les fichiers ont bien été déposés dans le casier de l'enseignant.","success",!0),scope.devoirARendre={}}scope.cloudActif=!1,angular.isDefined(ModuleService.getModule(ModuleService.CODES.CLOUD))&&(scope.cloudActif=ModuleService.getModule(ModuleService.CODES.CLOUD).enable),scope.fichiers=[],scope.configInputFile={keepComplete:!1,dropzoneContainer:"#form-rendre-devoir",mode:"CDT"},scope.configInputFile.onCompleteUploadFromCloud=onCompleteUpload,scope.configInputFile.fromCloudEnabled=scope.cloudActif,scope.processingFiles=0,scope.urlTeleversement=Settings.apiUri+"televersement.awp?verbe=post&mode=CDT",Auth.isFamille()&&angular.isDefined(scope.idEleve)&&(scope.urlTeleversement+="&idEleve="+scope.idEleve),scope.Auth=Auth,scope.Utils=Utils,scope.localCDT=scope.cdt,scope.$watch("cdt",function(newValue,oldValue){(angular.isDefined(oldValue)||angular.isDefined(newValue)&&newValue.date!==oldValue.date)&&(scope.localCDT=newValue)},!0),scope.$watch("day",function(newValue,oldValue){newValue!==oldValue&&scope.loadCDTByDay()},!0),scope.manuelsByMatiere=scope.manuelsByMatiere(),scope.refreshCurrentDay=scope.refreshCurrentDay(),scope.isPast=scope.isPast(),scope.setModeActif=scope.setModeActif(),scope.isEnRetard=function(matiere){var dateButoire=moment(scope.day).add(matiere.nbJourMaxRenduDevoir,"day").toDate();return moment().isAfter(dateButoire,"day")},scope.completeUpload=onCompleteUpload,scope.setEffectue=function(matiere){var lData;lData=matiere.aFaire.effectue?{idDevoirsEffectues:[matiere.aFaire.idDevoir]}:{idDevoirsNonEffectues:[matiere.aFaire.idDevoir]},lodash.find(scope.cahierDeTexte[scope.localCDT.date],{idDevoir:matiere.aFaire.idDevoir}).effectue=matiere.aFaire.effectue,CahierDeTexteService.eleveCahierDeTextesSetEffectue(scope.idEleve,lData)},scope.displayRendreDevoir=function(devoir){scope.fichiers=[],scope.devoirARendre=devoir},scope.addCommentForm=function(devoir,side){scope.devoir=devoir;var dialog=$uibModal.open({templateUrl:"modules/cahierDeTexte/eleve/cahierdetexteaddcomment.html",scope:scope});dialog.result.then(function(data){1!==data&&(data.message=$filter("base64encode")(data.message),CahierDeTexteService.cahierDeTextesAddComment("E",scope.idEleve,data,side).then(function(){scope.loadCDTByDay(),Notification.notify("Commentaire enregistré","Votre commentaire a bien été enregistré","success",!0)}))})},scope.showRessource=function(ressource){scope.ressource=ressource,$uibModal.open({templateUrl:"modules/cahierDeTexte/eleve/showressource.html",scope:scope})},scope.sanitize=function(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)},scope.showContenuSeance=function(aFaire){scope.aFaire=aFaire,$uibModal.open({templateUrl:"modules/cahierDeTexte/eleve/cahierdetextecontenuDeSeance.html",scope:scope})},scope.goToService=function(url){CASService.goToService(url)},scope.cancelRendreDevoir=function(){scope.fichiers=[],scope.devoirARendre={}},scope.postRendreDevoir=function(){Notification.notify("Devoir envoyé","Vos fichiers ont bien été envoyés à l'enseignant","success",!0),scope.cancelRendreDevoir()},scope.loadCDTByDay=function(){scope.promiseSemaineContents=CahierDeTexteService.CahierDeTextesParDate(scope.idEleve,scope.day,scope.contexte).then(function(cahierDeTexteParJour){scope.localCDT=cahierDeTexteParJour})},scope.openQCM=function(qcm){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"md",resolve:{qcmAssociation:function(){return qcm},isNational:function(){return!1},idEleve:function(){return Auth.isFamille()?scope.idEleve:void 0}}})},scope.loadData&&scope.loadCDTByDay()}}}]),angular.module("edsiteApp.EdCluster",["edsiteApp.Commun","btford.socket-io","edsiteApp.config"]).service("EdCluster",["$rootScope",function($rootScope){var mEdCluster={},servers=[];return mEdCluster.setServers=function(staticservers){servers=staticservers},mEdCluster.servers=function(){return servers},mEdCluster.getServer=function(){var allServers=[],apiServers=[],isAnonymous=!$rootScope.Auth.isAuthenticated(),isF=$rootScope.Auth.isFamille()||$rootScope.Auth.isEleve(),isP=!isF&&!isAnonymous;if(angular.forEach(servers,function(serv){"API"===serv.profile&&1===serv.status&&apiServers.push(serv);var goodServer=!1;if(1===serv.status&&(isAnonymous&&("P"===serv.profile||"F"===serv.profile||"ALL"===serv.profile)&&(goodServer=!0),!isF||"F"!==serv.profile&&"ALL"!==serv.profile||(goodServer=!0),!isP||"P"!==serv.profile&&"ALL"!==serv.profile||(goodServer=!0),goodServer))for(var i=0;i<serv.weigth;i++)allServers.push(serv)}),0===allServers.length&&0===apiServers.length)return"";var newServer;return newServer=apiServers.length>0?apiServers[Math.floor(Math.random()*apiServers.length)]:allServers[Math.floor(Math.random()*allServers.length)],newServer.name},mEdCluster}]).factory("EdClusterService",["$rootScope","$q","$http","EdCluster","Settings","edSocket","CONFIG","notificationService",function($rootScope,$q,$http,EdCluster,Settings,edSocket,CONFIG,notificationService){var mEdClusterService={};return mEdClusterService.socketConnect=function(){angular.isDefined(edSocket.socket)&&(edSocket.socket.on("server-update",function(message){try{var lesServers=JSON.parse(message);EdCluster.setServers(lesServers),Settings.touch()}catch(err){}}),edSocket.socket.on("message",function(message){try{notificationService.onMessage(message)}catch(err){console.log("err on notification message",err)}}))},mEdClusterService.profileConnect=function(){var profile="";if($rootScope.Auth.isFamille()&&(profile="1"),$rootScope.Auth.isPersonnel()&&(profile="A"),$rootScope.Auth.isEleve()&&(profile="E"),$rootScope.Auth.isProfesseur()&&(profile="P"),""===profile)return"";if(angular.isDefined(edSocket.socket)){var profileMessage="join-"+profile;edSocket.socket.emit(profileMessage,{token:$rootScope.Auth.socketToken()})}},mEdClusterService.profileDisconnect=function(){var profile="";if($rootScope.Auth.isFamille()&&(profile="1"),$rootScope.Auth.isPersonnel()&&(profile="A"),$rootScope.Auth.isEleve()&&(profile="E"),$rootScope.Auth.isProfesseur()&&(profile="P"),""===profile)return"";if(angular.isDefined(edSocket.socket)){var profileMessage="leave-"+profile;edSocket.socket.emit(profileMessage)}},mEdClusterService.updateServers=function(){var defer=$q.defer(),baseUrl="";return baseUrl="development"===CONFIG.name||"local"===CONFIG.name?"/EDCluster/servers-test.json?c="+Date.now():"staging"===CONFIG.name?"/EDCluster/servers-staging.json?c="+Date.now():"/EDCluster/servers.json?c="+Date.now(),$http({method:"GET",url:baseUrl}).then(function(response){angular.isDefined(response.data.servers)&&response.data.servers.length>0&&(edSocket.setClusterController(response.data.controller),mEdClusterService.socketConnect(),EdCluster.setServers(response.data.servers),Settings.touch(),mEdClusterService.profileConnect(),defer.resolve(Settings.allSettings()))},function(error){defer.reject(error)}),defer.promise},mEdClusterService}]).factory("edSocket",["socketFactory",function(socketFactory){var CONTROLLER_SERVER="",mEdSocket={};return mEdSocket.setClusterController=function(add){CONTROLLER_SERVER=add,CONTROLLER_SERVER.indexOf("autre")>0||mEdSocket.connect()},mEdSocket.connect=function(){mEdSocket.socket=socketFactory({ioSocket:io.connect(CONTROLLER_SERVER)})},mEdSocket}]),angular.module("edsiteApp.EDNotification",["btford.socket-io"]).service("notificationService",["$rootScope","$location","lodash","Notification",function($rootScope,$location,lodash,Notification){var mEdNotifService={};mEdNotifService.observers=[];var replaceParam=function(action){var dicoParams={idUser:$rootScope.Auth.idUser(),profile:$rootScope.Auth.role()};return lodash.forEach(dicoParams,function(value,param){var pattern="{"+param+"}";action=action.replace(pattern,value)}),action};return mEdNotifService.onMessage=function(message){if(message.notification.action=replaceParam(message.notification.action),mEdNotifService.notifyObservers(message.notification.action,message),message.author.profil!==$rootScope.Auth.role()||message.author.idUser!==$rootScope.Auth.idUser()||message.author.ogec!==$rootScope.Auth.currentUser().codeOgec){var sameNotice=lodash.find(PNotify.notices,function(notice){return notice.options.id===message.notification.action});if(message.notification.action.indexOf($location.path())<0&&angular.isUndefined(sameNotice)){var desactivationCallback=null;$rootScope.Auth.isNotificationsActif()&&(desactivationCallback=function(){$rootScope.Auth.setActivationNotifications(!1)}),Notification.notifyWithAction(message.notification.title,message.notification.body,message.notification.type,message.notification.icon,message.notification.action,!1,desactivationCallback)}}},mEdNotifService.addObserver=function(observer,action,cb){mEdNotifService.observers.push({action:action,observer:observer,cb:cb})},mEdNotifService.deleteObserver=function(observer){lodash.remove(mEdNotifService.observers,{observer:observer})},mEdNotifService.deleteObservers=function(){mEdNotifService.observers=[]},mEdNotifService.notifyObservers=function(action,message){var actionToMatch=action.split("?")[0];lodash.chain(mEdNotifService.observers).where({action:actionToMatch}).forEach(function(observer){(message.author.profil!==$rootScope.Auth.role()||message.author.idUser!==$rootScope.Auth.idUser()||message.author.ogec!==$rootScope.Auth.currentUser().codeOgec)&&observer.cb(message)}).commit()},mEdNotifService}]).service("notificationSendService",["edSocket","Auth",function(edSocket,Auth){var mEdNotifSendService={};return mEdNotifSendService.sendMessage=function(message){if(message.token=Auth.currentUser().socketToken,message.author={profil:Auth.role(),idUser:Auth.idUser(),ogec:Auth.currentUser().codeOgec},angular.isDefined(edSocket.socket)){var eventTitle="notification-message";edSocket.socket.emit(eventTitle,message)}},mEdNotifSendService}]),angular.module("edsiteApp").directive("sanitizeWithoutJs",function(){return{scope:{source:"=",dest:"="},restrict:"A",controller:["$scope",function($scope){$scope.sanitizeIt=function(){var replacer=/<script[^>]*>(?:(?!<\/script>)[^])*<\/\s?script>/gi,stripped=$scope.source.replace(replacer,"");replacer=/<\!--\[endif\]---->.*<\!--\!\[endif\]---->?/gi,stripped=stripped.replace(replacer,""),replacer=/<\?xml(.*)(office|microsoft)(.*)\/>/gi,stripped=stripped.replace(replacer,""),
$scope.dest=stripped},$scope.$watch("source",$scope.sanitizeIt)}]}}),angular.module("edsiteApp").filter("unique",["lodash",function(lodash){return function(arr,field){return lodash.uniq(arr,function(a){return a[field]})}}]),angular.module("edsiteApp.situationsFamilaleService",["edsiteApp.Commun"]).service("SituationsFamilaleService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mSituationFamService={};return mSituationFamService.listeSituations=function(){var defer=$q.defer(),data={},baseUrl="situationsFamiliale";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mSituationFamService}]),angular.module("edsiteApp.cspService",["edsiteApp.Commun"]).service("CspService",["$q","$http","EDHttp",function($q,$http,EDHttp){var mCspService={};return mCspService.listeCodesSocioProfessionnels=function(){var defer=$q.defer(),data={},baseUrl="codesSocioP";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mCspService}]),angular.module("edsiteApp.Commun").factory("ParametrageService",["$http","$q",function($http,$q){function getTypesForParameters(type){var types={A:"Personnels",P:"Professeurs",1:"Familles_1",2:"Familles_2",E:"Elèves"};return types[type]}var service={},START_PARAM="Préférences/",END_PARAM="/id_";return service.updateParametrageIndividuel=function(idUser,typeUser,param,value){var defer=$q.defer(),typeUserParam=getTypesForParameters(typeUser),pathParamElements=[];pathParamElements.push(START_PARAM),pathParamElements.push(typeUserParam),pathParamElements.push(param),pathParamElements.push(END_PARAM+idUser);var pathParam=pathParamElements.join("/").replace(/\/\//g,"/"),baseUrl="parametreIndividuel",data={path:pathParam,value:value};return $http({method:"PUT",url:baseUrl,data:data}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error)}),defer.promise},service.getParametrageIndividuel=function(idUser,typeUser,param){var defer=$q.defer(),typeUserParam=getTypesForParameters(typeUser),pathParamElements=[];pathParamElements.push(START_PARAM),pathParamElements.push(typeUserParam),pathParamElements.push(param),pathParamElements.push(END_PARAM+idUser);var pathParam=pathParamElements.join("/").replace(/\/\//g,"/"),baseUrl="parametreIndividuel",data={path:pathParam};return $http({method:"GET",url:baseUrl,data:data}).then(function(data){defer.resolve(data.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.consultationCoordonnees",[]).controller("ConsultationCoordonneesCtrl",["CoordonneesFamilleService","$routeParams","lodash","UserService",function(CoordonneesFamilleService,$routeParams,lodash,UserService){function displayTypeContact(typeLien){var type;return 1===typeLien&&(type="Responsable légal"),2===typeLien&&(type="Autorité parentale"),3===typeLien&&(type="Autres"),type}var idEleve=$routeParams.idEleve,vm=this;vm.displayTypeContact=displayTypeContact,vm.promiseEleve=UserService.getEleve(idEleve).then(function(eleve){vm.eleve=eleve}),vm.print=function(){print()},vm.promiseCoord=CoordonneesFamilleService.familleCoordonneesByIdEleve(idEleve).then(function(coord){vm.contacts=coord,lodash.forEach(vm.contacts,function(contact){angular.isDefined(contact.responsable.csp.libelle)&&(contact.responsable.csp.libelle=lodash.capitalize(contact.responsable.csp.libelle.toLowerCase())),angular.isDefined(contact.conjoint.csp.libelle)&&(contact.conjoint.csp.libelle=lodash.capitalize(contact.conjoint.csp.libelle.toLowerCase())),angular.isDefined(contact.situationFamiliale.libelle)&&(contact.situationFamiliale=lodash.capitalize(contact.situationFamiliale.libelle.toLowerCase()))})})}]),angular.module("edsiteApp.Agenda",["ui.bootstrap","edsiteApp.Commun","edsiteApp.base64filter","ngLodash","edsiteApp.filterTranslateTypeUser"]).controller("AgendaCtrl",["$scope","AgendaService","Auth","$uibModal","$filter","$routeParams","ModuleService",function($scope,AgendaService,Auth,$uibModal,$filter,$routeParams,ModuleService){function openCreateDialog(){var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,windowClass:"dialog-agenda",resolve:{options:function(){var options={};return options.title="Création d'un événement",options.mode="create",options.idUser=$scope.idUser,options.typeUser=$scope.typeUser,options.prolexisEnable="1"===ModuleService.getModule(ModuleService.CODES.AGENDA).params.prolexisEnable,options},event:function(){return{}}}});modalInstance.result.then(function(){$scope.$broadcast("refresh-agenda-events")})}$scope.evenements=[],$scope.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),$scope.idUser=$routeParams.idUser,$scope.scheduler=AgendaService.scheduler,$scope.isAdmin=!1,$scope.openCreateDialog=openCreateDialog;var moduleAgenda=ModuleService.getModule(ModuleService.CODES.AGENDA);moduleAgenda&&moduleAgenda.params&&"1"===moduleAgenda.params.admin&&($scope.isAdmin=!0)}]),angular.module("edsiteApp.Agenda").directive("agendaScheduler",["Auth","AgendaService","EmploiDuTempsService","DhxSchedulerService","moment","$uibModal","lodash","ModuleService",function(Auth,AgendaService,EmploiDuTempsService,DhxSchedulerService,moment,$uibModal,lodash,ModuleService){return{restrict:"A",scope:{dispenserCours:"&dispense",events:"=data",scheduler:"=scheduler",idUser:"=",typeUser:"=",displayTargets:"@",espaceTravail:"="},transclude:!0,template:'<div><div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div></div>',link:function(scope,element){function onTemplateReady(){scheduler.templates.event_text=DhxSchedulerService.renderEventText,scheduler.templates.event_bar_text=DhxSchedulerService.renderEventBarText,scheduler.templates.event_bar_date=DhxSchedulerService.renderEventBarDate,scheduler.templates.event_header=DhxSchedulerService.renderEventHeader,scheduler.templates.year_tooltip=DhxSchedulerService.renderEventYearTooltip}function onViewChange(){var state=scheduler.getState(),minDate=moment(state.min_date).format("YYYY-MM-DD"),maxDate=moment(state.max_date).subtract(1,"days").format("YYYY-MM-DD");angular.forEach(EmploiDuTempsService.agendasToDisplay,function(unAgenda){if(unAgenda.selected){var typeEntity=unAgenda.typeEntity,idEntity=unAgenda.idEntity,typeAgenda=unAgenda.typeAgenda,cacheKey=minDate+"||"+maxDate+"||"+typeEntity+"||"+idEntity+"||"+typeAgenda;cacheKey in cacheEvents||(cacheEvents[cacheKey]=[],"EDT"===typeAgenda?scope.requestLoading=EmploiDuTempsService.searchEvents(typeEntity,idEntity,minDate,maxDate).then(function(events){cacheEvents[cacheKey]=events,scheduler.parse(events,"json")}):scope.requestLoading=AgendaService.searchEvents(typeEntity,idEntity,minDate,maxDate).then(function(events){cacheEvents[cacheKey]=events,scheduler.parse(events,"json")}))}})}var events={};scope.scheduler||(scope.scheduler={}),scope.scheduler.mode=scope.scheduler.mode||"month",scope.scheduler.date=scope.scheduler.date||new Date;var cacheEvents={};if(!scope.idUser)throw new Error("Missing attribute 'idUser' in directive dhx-scheduler");angular.forEach(EmploiDuTempsService.agendasToDisplay,function(unAgenda){unAgenda.selected=!1}),EmploiDuTempsService.listeAgendasToDisplay().then(function(agendasToDisplay){var currentAgenda;"W"===scope.typeUser?currentAgenda=lodash.find(agendasToDisplay,{typeEntity:scope.typeUser,idEntity:parseInt(scope.idUser),typeAgenda:"W"}):(currentAgenda=lodash.find(EmploiDuTempsService.agendasToDisplay,{typeEntity:scope.typeUser,idEntity:parseInt(scope.idUser),typeAgenda:"GEN"}),Auth.isFamille()&&angular.isUndefined(currentAgenda)&&(currentAgenda=lodash.find(EmploiDuTempsService.agendasToDisplay,{typeAgenda:"GEN"}),currentAgenda.typeEntity=scope.typeUser,currentAgenda.idEntity=parseInt(scope.idUser))),angular.isDefined(currentAgenda)&&(currentAgenda.selected=!0)}),scope.$watch(function(){return EmploiDuTempsService.agendasToDisplay},function(nv,old){nv!==old&&(cacheEvents={},scheduler.clearAll(),onViewChange())},!0),scope.$watch(function(){return scope.scheduler.mode+scope.scheduler.date.toString()},function(nv){var mode=scheduler.getState();(nv.date!==mode.date||nv.mode!==mode.mode)&&scheduler.setCurrentView(scope.scheduler.date,scope.scheduler.mode)},!0),scope.$watch(function(){return element[0].offsetWidth+"."+element[0].offsetHeight},function(){scheduler.setCurrentView()}),element.addClass("dhx_cal_container"),scheduler.initialized=!0,scheduler.config.first_hour=7,scheduler.config.last_hour=23,scheduler.config.separate_short_events=!0,scheduler.config.xml_date="%Y-%m-%d %H:%i",scheduler.config.start_on_monday=!0,scheduler.config.show_loading=!0,scheduler.config.load_date="%Y-%m-%d",scheduler.config.readonly_form=!0,scheduler.config.readonly=!1,scheduler.config.select=!1,scheduler.config.details_on_dblclick=!0,scheduler.config.dblclick_create=!1,scheduler.config.drag_create=!1,scheduler.config.drag_resize=!1,scheduler.config.drag_move=!1,scheduler.config.hour_size_px=88,scheduler.config.day_date="%D %j %M",scheduler.config.cascade_event_display=!0,scheduler.showLightbox=function(id){var event;if(angular.forEach(cacheEvents,function(events){event||(event=lodash.find(events,{id:parseInt(id)}))}),!event)return window.alert("Impossible de modifier l'événement");if(angular.isDefined(event.readonly)&&!event.readonly&&(Auth.isPersonnel()||angular.isDefined(scope.espaceTravail)&&scope.espaceTravail.estAdmin||event.idAuteur===Auth.currentUser().id&&event.typeAuteur===Auth.currentUser().typeCompte)){var isAgendaEspaceTravail=lodash.find(event.cibles,function(cible){return-1!==cible.search("W")});isAgendaEspaceTravail&&(scope.displayTargets="false");var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,windowClass:"dialog-agenda",resolve:{options:function(){var options={};return options.title="Formulaire d'édition d'un événement",options.mode="edit",options.idUser=scope.idUser,options.typeUser=scope.typeUser,options.canDelete=event.estSupprimable,options.displayTargets=scope.displayTargets,options.prolexisEnable=angular.isDefined(ModuleService.getModule(ModuleService.CODES.AGENDA))&&"1"===ModuleService.getModule(ModuleService.CODES.AGENDA).params.prolexisEnable,options},event:function(){return event}}});modalInstance.result.then(function(event){cacheEvents={},event&&scheduler.deleteEvent(event.id),onViewChange()})}else event.description&&$uibModal.open({templateUrl:"../modules/agenda/event-modal-template.html",controller:"EventModalCtrl",size:"md",resolve:{config:function(){var config={};return config.event=event,config}}})},scheduler.locale.labels.icon_dispenser="Dispenser",scheduler._click.buttons.dispenser=function(id){scope.dispenserCours({id:id})},scheduler.templates.tooltip_text=DhxSchedulerService.renderTooltip,scheduler.init(element[0],scope.scheduler.date,scope.scheduler.mode),events.onTemplateReady=scheduler.attachEvent("onTemplatesReady",onTemplateReady),events.onViewChange=scheduler.attachEvent("onViewChange",onViewChange),events.onClick=scheduler.attachEvent("onClick",DhxSchedulerService.attacheEvenement),scope.$on("refresh-agenda-events",function(){cacheEvents={},onViewChange()}),scope.$on("$destroy",function(){scheduler.detachEvent(events.onClick),scheduler.detachEvent(events.onViewChange),scheduler.clearAll()})}}}]).controller("AgendaEvenementEditCtrl",["$scope","$uibModalInstance","event","options","AgendaService","moment","Notification","$uibModal","lodash","UserService","Auth",function($scope,$uibModalInstance,event,options,AgendaService,moment,Notification,$uibModal,lodash,UserService,Auth){angular.copy(event);$scope.options=options,$scope.event=angular.copy(event),$scope.typesUser=AgendaService.TYPE_USER,$scope.hasBeenSubmitted=!1,$scope.editorOptions={height:150,extraPlugins:"DiagPlWs",toolbar:"full",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]},{name:"links",items:["Link","Unlink"]}],removePlugins:"elementspath"},$scope.options.prolexisEnable&&$scope.editorOptions.toolbar_full.push({name:"correcteur",items:["DiagPlWs"]}),$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.format="dd/MM/yyyy",angular.isDefined(options.selectedTargets)&&($scope.event.cibles=options.selectedTargets),Auth.isPersonnel()?$scope.requestLoading=UserService.getClassesAllByNiveauxByEtabs().then(function(datas){$scope.etablissements=lodash.filter(datas,{optionType:"etab"}),"create"===$scope.options.mode&&($scope.event.ciblesEtab=[],lodash.forEach($scope.etablissements,function(etab){$scope.event.ciblesEtab.push(etab.etabId)}))}):"create"===$scope.options.mode&&($scope.event.ciblesEtab=[]),$scope.checkCiblesSelected=function(agendaEvent){if(!angular.isUndefined(agendaEvent)){var cibleFound=lodash.find(agendaEvent.cibles,function(cibleUser){return cibleUser===$scope.typesUser.FAMILLE.code||cibleUser===$scope.typesUser.ELEVE.code});return angular.isDefined(cibleFound)}},$scope.isCibleFamilleEleve=$scope.checkCiblesSelected($scope.event),$scope.clear=function(){$scope.event.dateFin=null},$scope.openDateDebut=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.dateDebutOpened=!0},$scope.openDateFin=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.dateFinOpened=!0},$scope.close=function(){$uibModalInstance.close()},$scope.toggleType=function(code){$scope.event.cibles||($scope.event.cibles=[]);var idCible=lodash.findIndex($scope.event.cibles,function(cibleUser){return cibleUser===code});idCible>-1?$scope.event.cibles.splice(idCible,1):$scope.event.cibles.push(code),$scope.isCibleFamilleEleve=$scope.checkCiblesSelected($scope.event),$scope.isCibleFamilleEleve||($scope.event.ciblesEtab=[])},$scope.toggleTypeEtab=function(idEtab){$scope.event.ciblesEtab||($scope.event.ciblesEtab=[]);var idx=$scope.event.ciblesEtab.indexOf(idEtab);idx>-1?$scope.event.ciblesEtab.splice(idx,1):$scope.event.ciblesEtab.push(idEtab)},$scope.update=function(event,form){if($scope.hasBeenSubmitted=!0,form.$invalid&&(form.dateDebut.$pristine&&form.dateDebut.$viewValue||form.dateFin.$pristine&&form.dateFin.$viewValue)&&!form.description.$invalid&&!form.libelle.$invalid&&(form.$invalid=!1),form.$invalid||!event.cibles.length||!event.ciblesEtab.length&&$scope.isCibleFamilleEleve)return void Notification.notify("Agenda","Veuillez vérifier la saisie de votre formulaire ! ","error","fa fa-calendar-o");event.heureDebut=moment(event.start_date).format("HH:mm"),event.heureFin=moment(event.end_date).format("HH:mm"),event.dateDebut=moment(event.dateDebut).format("YYYY-MM-DD"),event.dateFin=moment(event.dateFin).format("YYYY-MM-DD");var ciblesFinale=[],nbEtab=0;0===event.ciblesEtab.length?lodash.forEach(event.cibles,function(cibleUser){ciblesFinale.push(cibleUser)}):lodash.forEach(event.ciblesEtab,function(cibleEtab){lodash.forEach(event.cibles,function(cibleUser){cibleUser===$scope.typesUser.FAMILLE.code||cibleUser===$scope.typesUser.ELEVE.code?ciblesFinale.push(cibleUser+cibleEtab):0===nbEtab&&ciblesFinale.push(cibleUser)}),nbEtab++}),event.cibles=ciblesFinale,$scope.options.prolexisEnable&&angular.isDefined(CKEDITOR.instances.description)&&(event.description=CKEDITOR.instances.description.getData()),$scope.requestLoading=AgendaService.update(options.typeUser,options.idUser,event).then(function(){Notification.notify("Agenda","Votre événement a bien été modifié","success","fa fa-calendar-o"),$uibModalInstance.close(event)},function(error){Notification.notify("Agenda",angular.isDefined(error.data.message)&&""!==error.data.message?error.data.message:"Une erreur s'est produite lors de la sauvegarde de vos modifications","error","fa fa-calendar-o")})},$scope.save=function(event,form){if($scope.hasBeenSubmitted=!0,form.$invalid&&(form.dateDebut.$pristine&&form.dateDebut.$viewValue||form.dateFin.$pristine&&form.dateFin.$viewValue)&&!form.description.$invalid&&!form.libelle.$invalid&&(form.$invalid=!1),angular.isUndefined(event.cibles)&&(event.cibles=[]),form.$invalid||!event.cibles.length||!event.ciblesEtab.length&&$scope.isCibleFamilleEleve)return void Notification.notify("Agenda","Veuillez vérifier la saisie de votre formulaire ! ","error","fa fa-calendar-o");var ciblesFinale=[],nbEtab=0;0===event.ciblesEtab.length?lodash.forEach(event.cibles,function(cibleUser){ciblesFinale.push(cibleUser)}):lodash.forEach(event.ciblesEtab,function(cibleEtab){lodash.forEach(event.cibles,function(cibleUser){cibleUser===$scope.typesUser.FAMILLE.code||cibleUser===$scope.typesUser.ELEVE.code?ciblesFinale.push(cibleUser+cibleEtab):0===nbEtab&&ciblesFinale.push(cibleUser)}),nbEtab++}),event.cibles=ciblesFinale,event.heureDebut=moment(event.start_date).format("HH:mm"),event.heureFin=moment(event.end_date).format("HH:mm"),event.dateDebut=moment(event.dateDebut).format("YYYY-MM-DD"),event.dateFin=moment(event.dateFin).format("YYYY-MM-DD"),$scope.options.prolexisEnable&&angular.isDefined(CKEDITOR.instances.description)&&(event.description=CKEDITOR.instances.description.getData()),$scope.requestLoading=AgendaService.create(options.typeUser,options.idUser,event).then(function(){Notification.notify("Agenda","Votre événement a bien été enregistré","success","fa fa-calendar-o"),$uibModalInstance.close(event)},function(error){Notification.notify("Agenda",angular.isDefined(error.data.message)&&""!==error.data.message?error.data.message:"Une erreur s'est produite lors de la sauvegarde de votre événement","error","fa fa-calendar-o")})},$scope["delete"]=function(event,form){$scope.hasBeenSubmitted=!0,form.$invalid&&(form.dateDebut.$pristine&&form.dateDebut.$viewValue||!form.dateFin.$pristine&&form.dateFin.$viewValue)&&(form.$invalid=!1);var modalInstanceSuppression=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'un événement",config.message="Confirmer la suppression de l'événement ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){$scope.requestLoading=AgendaService["delete"](options.typeUser,options.idUser,event).then(function(){Notification.notify("Agenda","Votre événement a bien été supprimé","success","fa fa-calendar-o"),angular.isDefined($scope.options.events)&&lodash.remove($scope.options.events,{id:event.id}),$uibModalInstance.close(event)},function(error){Notification.notify("Agenda","Une erreur s'est produite lors de la suppression de votre événement","error","fa fa-calendar-o")})})},$scope.toggleIsAllDay=function(isAllDay,event){isAllDay&&(event.start_date=moment().startOf("day"),event.end_date=moment().endOf("day"))},$scope.updateChangeDateDebut=function(event){event.dateFin=event.dateDebut};var maintenant=moment();event.heureDebut===maintenant.startOf("day").format("HH:mm")&&event.heureFin===maintenant.endOf("day").format("HH:mm")&&($scope.isAllDay=!0)}]),angular.module("edsiteApp.Agenda").factory("AgendaService",["$q","$http","$filter","lodash","EDHttp","CacheService",function($q,$http,$filter,lodash,EDHttp,CacheService){var service={};return service.TYPE_USER={FAMILLE:{code:"F",libelle:"Famille"},ELEVE:{code:"E",libelle:"Elève"},PERSONNEL:{code:"A",libelle:"Personnel"},PROF:{code:"P",libelle:"Prof"}},service.scheduler={mode:"week",config:{xml_date:"%Y-%m-%d %H:%i"}},service.cleanEventsFromServer=function(events){angular.forEach(events,function(event){event.start_date=event.dateDebut+" "+event.heureDebut,event.end_date=event.dateFin+" "+event.heureFin,event.text=event.libelle,event.decoded||(event.description=$filter("base64decode")(event.description),event.decoded=!0)})},service.searchEvents=function(typeUser,idUser,minDate,maxDate){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={dateDebut:minDate,dateFin:maxDate},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/agendaEvenements";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){var events=[];angular.isDefined(response.data.data)&&(events=lodash.sortBy(response.data.data.evenements,function(ev){return ev.start_date})),service.cleanEventsFromServer(events),defer.resolve(events)},function(error){defer.reject(error)}),defer.promise},service.getLastEvents=function(typeUser,idUser,nbToFetch){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={};0!==nbToFetch&&(data={nbProchainsEvents:nbToFetch});var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/agendaEvenements";return EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){var events=lodash.sortBy(response.data.data.evenements,function(ev){return ev.start_date});service.cleanEventsFromServer(events),defer.resolve(events)},function(error){defer.reject(error)}),defer.promise},service.update=function(typeUser,idUser,event){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={},_event=angular.copy(event);_event.description=$filter("base64encode")(_event.description),data.event=_event;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/agendaEvenements/"+event.id;return CacheService.removeMatch(/.*\/agenda/),$http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.create=function(typeUser,idUser,event){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={},_event=angular.copy(event);_event.description=$filter("base64encode")(_event.description),data.event=_event;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/agendaEvenements";return CacheService.removeMatch(/.*\/agenda/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service["delete"]=function(typeUser,idUser,event){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={};data.event=angular.copy(event),data.event.description="";var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/agendaEvenements/"+event.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.isReservationSalle=function(event){return"undefined"!=typeof lodash.find(event.cibles,function(cible){return-1!==cible.search("S")})},service.getIcalLink=function(typeEntity,idEntity){var defer=$q.defer();if(angular.isUndefined(typeEntity)||angular.isUndefined(idEntity))return defer.reject(),defer.promise;var data={},baseUrl="ical/"+typeEntity+"/"+idEntity+"/url";return EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.Agenda").directive("agenda",function(){return{restrict:"E",scope:{events:"=",droitsAgenda:"=",idEntity:"=",typeEntity:"=",selectedTargets:"=",displayTargets:"@",filterPast:"=",espaceTravail:"="},templateUrl:"modules/agenda/agenda-evenement-template.html",controller:["$scope","$uibModal","lodash","AgendaService","CacheService","Notification","ModuleService","Auth",function($scope,$uibModal,lodash,AgendaService,CacheService,Notification,ModuleService,Auth){function openDialogAgenda(event){var modalEdit=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,resolve:{options:function(){var options={};return options.title="Formulaire d'édition d'un événement",options.mode="edit",options.idUser=$scope.idEntity,options.typeUser=$scope.typeEntity,options.displayTargets=$scope.displayTargets,options.selectedTargets=$scope.selectedTargets,options.events=$scope.events,options.droits=$scope.droitsAgenda,options.prolexisEnable="1"===ModuleService.getModule(ModuleService.CODES.AGENDA).params.prolexisEnable,options},event:function(){return event}}});modalEdit.result.then(function(updatedEvent){angular.extend(event,updatedEvent),event.start_date=event.dateDebut+" "+event.heureDebut,event.end_date=event.dateFin+" "+event.heureFin},function(){})}function deleteEventAgenda(event,form){$scope.hasBeenSubmitted=!0;var modalInstanceSuppression=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'un événement",config.message="Confirmer la suppression de l'événement ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){$scope.requestLoading=AgendaService["delete"]($scope.typeEntity,$scope.idEntity,event).then(function(){Notification.notify("Agenda",'Votre événement a bien été supprimé"',"success","fa fa-calendar-o"),lodash.remove($scope.events,{id:event.id})},function(error){Notification.notify("Agenda","Une erreur s'est produite lors de la suppression de votre événement","error","fa fa-calendar-o")})})}function createEventAgenda(){var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,resolve:{options:function(){var options={};return options.title="Création d'un événement",options.mode="create",options.idUser=$scope.idEntity,options.typeUser=$scope.typeEntity,options.displayTargets=$scope.displayTargets,options.selectedTargets=$scope.selectedTargets,options},event:function(){return{}}}});modalInstance.result.then(function(){CacheService.removeMatch(/.*\/agendaEvenements/);var nbEvents="W"===$scope.typeEntity?0:3;$scope.promiseContents=AgendaService.getLastEvents($scope.typeEntity,$scope.idEntity,nbEvents).then(function(events){$scope.filterPast?$scope.events=lodash.filter(events,function(ev){return moment().diff(moment(ev.dateFin))<=0}):$scope.events=events})})}function isAuteurOrAdmin(evenementAgenda){return angular.isDefined($scope.espaceTravail)&&$scope.espaceTravail.estAdmin||evenementAgenda.idAuteur===Auth.currentUser().id&&evenementAgenda.typeAuteur===Auth.currentUser().typeCompte||Auth.isPersonnel()}$scope.openDialogAgenda=openDialogAgenda,$scope.deleteEventAgenda=deleteEventAgenda,$scope.createEventAgenda=createEventAgenda,$scope.isAuteurOrAdmin=isAuteurOrAdmin,$scope.openEvent=function(event){$uibModal.open({templateUrl:"../modules/agenda/event-modal-template.html",controller:"EventModalCtrl",size:"md",resolve:{config:function(){var config={};return config.event=event,config}}})}}]}}).controller("EventModalCtrl",["$scope","$uibModalInstance","config",function($scope,$uibModalInstance,config){function okFn(){$uibModalInstance.close()}$scope.event=config.event,$scope.okFn=okFn}]),angular.module("edsiteApp.Agenda").controller("IcalLinkModalCtrl",["$scope","$uibModalInstance","Notification","AgendaService","Settings","agenda",function($scope,$uibModalInstance,Notification,AgendaService,Settings,agenda){function close(){$uibModalInstance.dismiss()}function refresh(){var typeEntity="GEN"===vm.agenda.typeAgenda?vm.agenda.typeAgenda:vm.agenda.typeEntity,idEntity="GEN"===vm.agenda.typeAgenda?0:vm.agenda.idEntity;vm.promiseLoading=AgendaService.getIcalLink(typeEntity,idEntity),vm.promiseLoading.then(function(data){vm.url="https://api.ecoledirecte.com/v3/"+data.url},function(error){Notification.notify("Erreur","Une erreur est survenue lors de la récupération de l'url de l'agenda","danger")})}var vm=this;vm.refresh=refresh,vm.close=close,vm.promiseLoading=null,vm.url="",vm.agenda=agenda,vm.refresh()}]),angular.module("edsiteApp.config",[]).constant("CONFIG",{name:"production",version:"3.6.1-66"}),angular.module("edsiteApp.Commun").factory("CacheService",["CacheFactory","lodash",function(CacheFactory,lodash){var cacheId="ed-cache",service={},cache=new CacheFactory(cacheId,{});return service.info=function(){return cache.info()},service.get=function(key){return cache.get(key)},service.put=function(key,value){return cache.put(key,value)},service.removeStartWith=function(str){angular.forEach(cache.keys(),function(key){lodash.startsWith(key,str)&&cache.remove(key)})},service.removeMatch=function(str){angular.forEach(cache.keys(),function(key){key.match(str)&&cache.remove(key)})},service.remove=function(str){cache.get(str)&&cache.remove(str)},service.destroy=function(){return cache.destroy()},service.removeAll=function(){return cache.removeAll()},service}]),angular.module("edsiteApp.Commun").factory("EDHttp",["$http","$q","CacheService",function($http,$q,CacheService){var service=function(config){var defer=$q.defer(),_config={method:"GET",cache:!1};_config=angular.extend(config);var cached=_config.cache&&"GET"===_config.method,cacheKey=_config.url;if(cached){var cacheValue=CacheService.get(cacheKey);if(cacheValue)return defer.resolve(cacheValue),defer.promise}return delete _config.cache,$http(_config).then(function(response){cached&&CacheService.put(cacheKey,response),defer.resolve(response)},function(error){defer.reject(error)}),defer.promise};return service.get=function(){},service}]),angular.module("edsiteApp").directive("focusMe",["$timeout",function($timeout){return{link:function(scope,element,attrs){scope.$watch(attrs.focusMe,function(value){value===!0&&$timeout(function(){element[0].focus(),scope[attrs.focusMe]=!1},1e3)})}}}]),angular.module("edsiteApp.AccueilEnseignant").service("AccueilEnseignantService",function(){}),angular.module("edsiteApp").directive("bookmarkPage",["$window","$location","$document",function($window,$location,$document){return{restrict:"AEC",link:function(scope,element){element.bind("click",function(){var bookmarkURL=$location.absUrl(),bookmarkTitle=$document[0].title,triggerDefault=!1;return $window.sidebar&&$window.sidebar.addPanel?$window.sidebar.addPanel(bookmarkTitle,bookmarkURL,""):$window.sidebar&&navigator.userAgent.toLowerCase().indexOf("firefox")>-1||$window.opera&&$window.print?$window.alert("Utilisez la combinaison de touches "+(-1!==navigator.userAgent.toLowerCase().indexOf("mac")?"Cmd":"Ctrl")+"+D pour ajouter cette page dans vos favoris."):$window.external&&"AddFavorite"in $window.external?$window.external.AddFavorite(bookmarkURL,bookmarkTitle):$window.alert("Utilisez la combinaison de touches "+(-1!==navigator.userAgent.toLowerCase().indexOf("mac")?"Cmd":"Ctrl")+"+D pour ajouter cette page dans vos favoris."),triggerDefault})}}}]),angular.module("edsiteApp.EspacesTravail",["ui.bootstrap","edsiteApp.Commun","edsiteApp.Agenda"]).controller("EspacetravailCtrl",["$uibModal","$filter","$sce","$routeParams","$q","$location","$timeout","lodash","Auth","EspacestravailService","Notification","AgendaService","CacheService","PostitsService","ModuleService",function($uibModal,$filter,$sce,$routeParams,$q,$location,$timeout,lodash,Auth,EspacestravailService,Notification,AgendaService,CacheService,PostitsService,ModuleService){function setSelectedView(view){vm.selectedView=view}function setSelectedTypeUser(type){vm.selectedType=type}function setModeEdit(mode){vm.modeEdit=mode}function goTo(url){$location.path(url)}function sanitize(content,displayHtml){var decodedContent=$filter("base64decode")(content);
return displayHtml?$sce.trustAsHtml(decodedContent):decodedContent}function save(){return vm.espaceTravail.description=$filter("base64encode")(vm.espaceTravail.description),vm.espaceTravail.resume=$filter("base64encode")(vm.espaceTravail.resume),vm.espaceTravail.description.length>1048576?(Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1 Mo).","danger"),vm.espaceTravail.description=$filter("base64decode")(vm.espaceTravail.description),void(vm.espaceTravail.resume=$filter("base64decode")(vm.espaceTravail.resume))):void(vm.promiseContents=EspacestravailService.modifierEspaceTravail(vm.idUser,vm.typeUser,vm.espaceTravail).then(function(espaceTravailAjour){vm.espaceTravail.salleDesProfs?Notification.notify("Salle des professeurs","Modification de la description effectuée ! ","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail","Modification de votre espace de travail effectuée ! ","success","fa icon-ed_espacedetravail"),setModeEdit(!1),espaceTravailAjour.description=sanitize(espaceTravailAjour.description,!0),espaceTravailAjour.resume=sanitize(espaceTravailAjour.resume,!1),espaceTravailAjour.droitUtilisateur=vm.espaceTravail.droitUtilisateur,vm.espaceTravail=espaceTravailAjour,vm.originalEspace=angular.copy(vm.espaceTravail),$timeout(function(){MathJax.Hub.Typeset()})}))}function resetParametrageEspace(){vm.espaceTravail=angular.copy(vm.originalEspace)}function inscriptionMembre(etat){vm.etatInscription=etat;var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={},messageConfirmation="Confirmer votre inscription au groupe";return etat||(messageConfirmation="Confirmer votre désinscription au groupe"),config.title="Confirmation de votre demande",config.message=messageConfirmation,config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){vm.etatInscription?vm.promiseContents=EspacestravailService.rejoindreEspaceTravail(vm.idUser,vm.typeUser,vm.espaceTravail).then(function(){refresh(),Notification.notify("Espace de travail","Votre demande à bien été prise en compte.","success","fa icon-ed_espacedetravail")},function(error){Notification.notify("Espace de travail","Une erreur s'est produite.","error","fa icon-ed_espacedetravail")}):vm.promiseContents=EspacestravailService.quitterEspaceTravail(vm.idUser,vm.typeUser,vm.idEspaceT).then(function(){Notification.notify("Espace de travail","Votre demande à bien été prise en compte.","success","fa icon-ed_espacedetravail"),vm.goTo("/EspacesTravail")},function(error){Notification.notify("Espace de travail","Une erreur s'est produite.","error","fa icon-ed_espacedetravail")})})}function listePostits(){CacheService.removeMatch(/.*\/postits/),vm.promiseContents=PostitsService.listePostits(Auth.TYPE_USER.ESPACE_TRAVAIL,vm.espaceTravail.id).then(function(postits){vm.tabPostits=postits})}function getBadgeEspaceTravail(){return EspacestravailService.getBadgeEspaceTravail(vm.idEspaceT)}function getBadgeSalleDesProfs(){return EspacestravailService.getBadgeSDP()}function clearBadgeActiviteSDP(){vm.espaceTravail.salleDesProfs&&ModuleService.clearBadges(ModuleService.CODES.SALLE_DES_PROFS,vm.idUser)}function refresh(){CacheService.removeMatch(/.*\/espacestravail/),vm.promiseContents=EspacestravailService.infosEspaceTravail(vm.idUser,vm.typeUser,vm.idEspaceT).then(function(infosEspace){infosEspace.description=sanitize(infosEspace.description,!0),infosEspace.resume=sanitize(infosEspace.resume,!1),vm.espaceTravail=infosEspace,vm.originalEspace=angular.copy(infosEspace),vm.espaceTravail.salleDesProfs&&(vm.selectedType="P");var cibleEspace=Auth.TYPE_USER.ESPACE_TRAVAIL+vm.espaceTravail.id;vm.postitConfig={addPostit:vm.espaceTravail.droitUtilisateur>=vm.constantes.DROIT_MODIFICATION||vm.espaceTravail.estAdmin,updatePostit:vm.espaceTravail.droitUtilisateur>=vm.constantes.DROIT_MODIFICATION||vm.espaceTravail.estAdmin,deletePostit:vm.espaceTravail.droitUtilisateur===vm.constantes.DROIT_SUPPRESSION||vm.espaceTravail.estAdmin,displayDateCreated:!0,displayDateLimit:!1,displayTargets:!1,displayFormTargets:!1,selectTargets:[cibleEspace],visibilityPostitPast:!1},vm.user={type:Auth.currentUser().typeCompte,id:Auth.idUser()},vm.agendaDroits={updateAgenda:vm.espaceTravail.droitUtilisateur>=vm.constantes.DROIT_MODIFICATION||vm.espaceTravail.estAdmin,createAgenda:!1,deleteAgenda:vm.espaceTravail.droitUtilisateur===vm.constantes.DROIT_SUPPRESSION||vm.espaceTravail.estAdmin},vm.targetsAgenda=[cibleEspace],PostitsService.listePostits(Auth.TYPE_USER.ESPACE_TRAVAIL,vm.espaceTravail.id).then(function(postits){vm.tabPostits=postits}),AgendaService.getLastEvents(Auth.TYPE_USER.ESPACE_TRAVAIL,vm.espaceTravail.id,0).then(function(events){vm.agendaEvents=lodash.filter(events,function(ev){return moment().isBefore(moment(ev.dateFin),"day")||moment().isSame(moment(ev.dateFin),"day")})})})}var vm=this;vm.selectedView="accueil",vm.selectedType="E",vm.constantes=EspacestravailService.CONSTANTES,vm.modeEdit=!1,vm.idEspaceT=$routeParams.idEspaceTravail,vm.typeEspaceTravail=Auth.TYPE_USER.ESPACE_TRAVAIL,vm.schedulerAgenda=AgendaService.scheduler,vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"others"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"}],removePlugins:"stylescombo,elementspath,smiley,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle,image"},Auth.isFamille()?(vm.typeUser=$routeParams.typeUser,vm.idUser=$routeParams.idUser):(vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id),vm.isHimSelf=Auth.isHimself(vm.typeUser,vm.idUser),vm.setSelectedView=setSelectedView,vm.setSelectedTypeUser=setSelectedTypeUser,vm.resetParametrageEspace=resetParametrageEspace,vm.setModeEdit=setModeEdit,vm.save=save,vm.goTo=goTo,vm.inscriptionMembre=inscriptionMembre,vm.sanitize=sanitize,vm.listePostits=listePostits,vm.getBadgeEspaceTravail=getBadgeEspaceTravail,vm.getBadgeSalleDesProfs=getBadgeSalleDesProfs,vm.clearBadgeActiviteSDP=clearBadgeActiviteSDP,$routeParams.topic&&vm.setSelectedView("discussion"),refresh()}]),angular.module("edsiteApp.EspacesTravail").controller("EspacestravailCtrl",["$scope","$location","$uibModal","$filter","$sce","$routeParams","Auth","EspacestravailService","lodash","CacheService","Notification","ModuleService",function($scope,$location,$uibModal,$filter,$sce,$routeParams,Auth,EspacestravailService,lodash,CacheService,Notification,ModuleService){function goTo(url){$location.path(url)}function sanitize(content){var decodedContent=$filter("base64decode")(content);return $sce.trustAsHtml(decodedContent)}function ajoutEspaceTravail(){var modalInstance=$uibModal.open({templateUrl:"modules/espacesTravail/accueil/ajoutespace.template.html",controller:"EspaceTravailAjoutCtrl",controllerAs:"EspTravailAjoutCtrl",size:"lg",backdrop:!1});modalInstance.result.then(function(data){1!==data&&(CacheService.removeMatch(/.*\/espacestravail/),refresh())})}function inscriptionMembre(espaceTravail){$scope.promiseContents=EspacestravailService.rejoindreEspaceTravail($scope.idUser,$scope.typeUser,espaceTravail).then(function(){Notification.notify("Espace de travail","Votre demande à bien été prise en compte.","success","fa icon-ed_espacedetravail"),CacheService.removeMatch(/.*\/espacestravail/),refresh()},function(error){Notification.notify("Espace de travail","Une erreur s'est produite.","error","fa icon-ed_espacedetravail")})}function getBadgeEspaceTravail(idEspaceTravail){return EspacestravailService.getBadgeEspaceTravail(idEspaceTravail)}function refresh(){$scope.promiseContents=EspacestravailService.listeEspacesTravail($scope.idUser,$scope.typeUser).then(function(espacesTravail){espacesTravail=lodash.reject(espacesTravail,{titre:"Salle des professeurs"}),$scope.tabEspacesTravailUser=lodash.where(espacesTravail,{estMembre:!0}),$scope.tabAutresEspacesTravail=lodash.where(espacesTravail,{estMembre:!1})})}$scope.Auth=Auth,$scope.goTo=goTo,$scope.ajoutEspaceTravail=ajoutEspaceTravail,$scope.sanitize=sanitize,$scope.inscriptionMembre=inscriptionMembre,$scope.getBadgeEspaceTravail=getBadgeEspaceTravail,Auth.isFamille()?($scope.typeUser=$routeParams.typeUser,$scope.idUser=$routeParams.idUser):($scope.typeUser=Auth.currentUser().typeCompte,$scope.idUser=Auth.currentUser().id),$scope.isHimSelf=Auth.isHimself($scope.typeUser,$scope.idUser),ModuleService.clearBadges(ModuleService.CODES.CLOUD,$scope.idUser),refresh()}]).controller("EspaceTravailAjoutCtrl",["$uibModalInstance","$filter","Notification","Auth","EspacestravailService","EmploiDuTempsService","$q",function($uibModalInstance,$filter,Notification,Auth,EspacestravailService,EmploiDuTempsService,$q){function ajoutEspaceTravail(espace){var espaceT=angular.copy(espace);espaceT.resume=$filter("base64encode")(espaceT.resume);var lesPromises=[EspacestravailService.ajoutEspaceTravail(Auth.currentUser().id,Auth.currentUser().typeCompte,espaceT).then(function(espaceTsaved){espaceT.id=espaceTsaved.id}),EmploiDuTempsService.listeAgendasToDisplay().then(function(){})];vm.promiseContents=$q.all(lesPromises).then(function(){EmploiDuTempsService.agendasToDisplay.push({typeEntity:"W",idEntity:espaceT.id,typeAgenda:"W",libelle:espaceT.titre,couleurAgenda:espaceT.couleurEvenementAgenda}),Notification.notify("Espace de travail","Création de votre espace de travail effectué !","success",!0),$uibModalInstance.close(espaceT)},function(error){})}var vm=this;vm.tabColorsDispos=["#ffff99","#ffff00","#ffd966","#ffbf00","#ff8000","#ff6666","#ff0000","#bfff00","#80cc33","#33cc33","#1796b0","#00bfff","#3399ff","#0080ff","#0040ff","#9999ff","#bf00ff","#ff00ff","#8000ff","#993300","#800000"],vm.espaceTravail={"public":!1,ouvert:!1,cloud:!0,discussion:!0,couleurEvenementAgenda:"#1796b0"},vm.editorOptions={height:150,toolbar:"full",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]},{name:"links",items:["Link","Unlink"]}],removePlugins:"elementspath"},vm.ajoutEspaceTravail=ajoutEspaceTravail}]),angular.module("edsiteApp.EspacesTravail").controller("noEspacestravailCtrl",["Auth",function(Auth){var vm=this;vm.Auth=Auth}]),angular.module("edsiteApp.EspacesTravail").service("EspacestravailService",["$q","$http","EDHttp","ModuleService",function($q,$http,EDHttp,ModuleService){var EspacestravailService={};return EspacestravailService.CONSTANTES={PROFIL_ELEVE:"E",PROFIL_PROF:"P",PROFIL_RESPONSABLE:"1",PROFIL_CONJOINT:"2",PROFIL_PERSONNEL:"A",DROIT_LECTURE:1,DROIT_MODIFICATION:2,DROIT_SUPPRESSION:3,DROIT_ADMIN:4,CIBLE_ACCUEIL:"ACCUEIL",CIBLE_POSTIT:"POSTIT",CIBLE_AGENDA:"AGENDA",CIBLE_TOPIC:"TOPIC",CIBLE_TOPIC_MESSAGE:"TOPIC_MESSAGE",CIBLE_CLOUD:"CLOUD",CIBLE_MEMBRE:"MEMBRE"},EspacestravailService.listeEspacesTravail=function(idUser,typeUser){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.ajoutEspaceTravail=function(idUser,typeUser,espaceTravail){var defer=$q.defer(),data=espaceTravail,baseUrl=typeUser+"/"+idUser+"/espacestravail";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.modifierEspaceTravail=function(idUser,typeUser,espaceTravail){var defer=$q.defer(),data=espaceTravail,idEspace=espaceTravail.id,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspace;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise},EspacestravailService.infosEspaceTravail=function(idUser,typeUser,idEspaceTravail){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail;return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.deleteEspaceTravail=function(idUser,typeUser,idEspaceTravail){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.rejoindreEspaceTravail=function(idUser,typeUser,espaceTravail){var defer=$q.defer(),data=angular.copy(espaceTravail);data.description=data.description.toString();var idEspace=espaceTravail.id,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspace+"/acces";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.quitterEspaceTravail=function(idUser,typeUser,idEspaceTravail){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/acces";return new EDHttp({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.listMembres=function(idUser,typeUser,idEspaceTravail){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/membres";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.ajoutMembres=function(idUser,typeUser,idEspaceTravail,tabMembres){var defer=$q.defer(),data={membres:tabMembres},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/membres";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.supprimeMembre=function(idUser,typeUser,idEspaceTravail,membre){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/membres/"+membre.profil+"/"+membre.idMembre;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.listTopics=function(typeUser,idUser,idEspaceTravail){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.ajoutTopic=function(typeUser,idUser,idEspaceTravail,topic){var defer=$q.defer(),data=topic,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.archiveTopic=function(typeUser,idUser,idEspaceTravail,topic){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+topic.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.modifierTopic=function(typeUser,idUser,idEspaceTravail,topic){var defer=$q.defer(),data=topic,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+topic.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.ajoutMessageTopic=function(typeUser,idUser,idEspaceTravail,message){var defer=$q.defer(),data=message,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+message.idTopic+"/messages";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(message)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.listDiscussion=function(typeUser,idUser,idEspaceTravail,topic){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+topic.idTopic+"/messages";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.effacerMessageTopic=function(typeUser,idUser,idEspaceTravail,topic,message){var defer=$q.defer(),data={},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+topic.idTopic+"/messages/"+message.id;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.modifierMessageTopic=function(typeUser,idUser,idEspaceTravail,topic,message){var defer=$q.defer(),data=message,baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/topics/"+topic.idTopic+"/messages/"+message.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.getFilActivite=function(idUser,typeUser,idEspaceTravail){var defer=$q.defer(),data={nb:30},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/activites";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.deleteFilActivite=function(idUser,typeUser,idEspaceTravail,isDeleteAll){isDeleteAll=angular.isDefined(isDeleteAll)&&isDeleteAll===!0?1:0;var defer=$q.defer(),data={all:isDeleteAll},baseUrl=typeUser+"/"+idUser+"/espacestravail/"+idEspaceTravail+"/activites";return new EDHttp({method:"DELETE",url:baseUrl,data:data,cache:!1}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},EspacestravailService.getBadgeEspaceTravail=function(idEspaceTravail){var paramsModule=ModuleService.getModule(ModuleService.CODES.CLOUD).params;return angular.isDefined(paramsModule["nbBadge_"+idEspaceTravail])?+paramsModule["nbBadge_"+idEspaceTravail]:0},EspacestravailService.getBadgeSDP=function(){return ModuleService.getBadges(ModuleService.CODES.SALLE_DES_PROFS)},EspacestravailService.resetBadgeEspaceTravail=function(idEspaceTravail){var paramsModule=ModuleService.getModule(ModuleService.CODES.CLOUD).params;angular.isDefined(paramsModule["nbBadge_"+idEspaceTravail])&&(paramsModule["nbBadge_"+idEspaceTravail]=0)},EspacestravailService}]),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailDiscussionCtrl",["EspacestravailService","CacheService","$uibModal","$filter","$timeout","Auth","$routeParams","Notification","notificationService","notificationSendService","$interval","$scope",function(EspacestravailService,CacheService,$uibModal,$filter,$timeout,Auth,$routeParams,Notification,notificationService,notificationSendService,$interval,$scope){function listerDiscussionTopics(){vm.requestLoading=EspacestravailService.listTopics(vm.typeUser,vm.idUser,vm.idEspaceT).then(function(data){vm.topics=data.topics,vm.droitUtilisateur=data.parametrage.droitUtilisateur,vm.nomEspaceTravail=data.nomEspaceTravail,$routeParams.topic&&vm.chargeDiscussion({id:$routeParams.topic},!0,!0)})}function ajoutSujetDiscussion(){var modalInstance=$uibModal.open({templateUrl:"modules/espacesTravail/discussion/ajoutsujet.template.html",size:"sm",backdrop:!1});modalInstance.result.then(function(data){if(1!==data){var nouveauTopic={idEspace:vm.idEspaceT,titre:data};vm.requestLoading=EspacestravailService.ajoutTopic(vm.typeUser,vm.idUser,vm.idEspaceT,nouveauTopic).then(function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Enregistrement de votre sujet effectué !","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Enregistrement de votre sujet effectué !","success","fa icon-ed_espacedetravail"),CacheService.removeMatch(/.*\/topics/),listerDiscussionTopics()})}})}function archiverTopic(topic){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un sujet",config.message="Êtes-vous sûr de vouloir supprimer ce sujet ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){if(vm.droitUtilisateur===vm.constantes.DROIT_ADMIN)if(topic.nbMessages>0){var modalConfirmBis=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un sujet et de tout ses messages",config.message="Ce sujet contient <strong>"+topic.nbMessages+" messages. </strong> Êtes-vous sûr de vouloir vraiment supprimer ce sujet ? ",config.confirm="Valider",config.cancel="Non",config}}});modalConfirmBis.result.then(function(){callWebserviceArchiveTopic(topic),modalConfirmBis.close()})}else callWebserviceArchiveTopic(topic),modalInstance.close();else callWebserviceArchiveTopic(topic),modalInstance.close()})}function callWebserviceArchiveTopic(topic){stopIntervalRefreshMessages(),vm.requestLoading=EspacestravailService.archiveTopic(vm.typeUser,vm.idUser,vm.idEspaceT,topic).then(function(data){215===data.code?vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Suppression impossible. <br/> Il reste des messages associés à ce sujet !","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Suppression impossible. <br/> Il reste des messages associés à ce sujet !","error","fa icon-ed_espacedetravail"):(CacheService.removeMatch(/.*\/topics/),vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Suppression de votre sujet effectuée !","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Suppression de votre sujet effectuée !","success","fa icon-ed_espacedetravail"),listerDiscussionTopics(),vm.discussion=void 0)},function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+"- discussion","Une erreur est survenue","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Une erreur est survenue","error","fa icon-ed_espacedetravail")})}function modifierTopic(topic){stopIntervalRefreshMessages();var modalEdit=$uibModal.open({templateUrl:"modules/espacesTravail/discussion/modifiesujet.template.html",controller:"TopicEditCtrl",controllerAs:"EditTopicCtrl",size:"sm",backdrop:!1,resolve:{topic:function(){return topic},options:function(){var options={};return options.libelleSDP=vm.libelleSalleDesProfs,options.nomEspaceTravail=vm.nomEspaceTravail,options}}});modalEdit.result.then(function(reponse){angular.extend(topic,reponse.topic)})}function chargeDiscussion(topic,isTopicSelected,displayLoader){angular.isUndefined(isTopicSelected)&&(isTopicSelected=!1),angular.isUndefined(displayLoader)&&(displayLoader=!0),vm.messageTopic={idTopic:topic.id,contenu:""},isTopicSelected&&(stopIntervalRefreshMessages(),startIntervalRefreshMessages()),displayLoader?vm.requestLoading=EspacestravailService.listDiscussion(vm.typeUser,vm.idUser,vm.idEspaceT,vm.messageTopic).then(function(infosDiscussion){vm.discussion=infosDiscussion,vm.scrollToBottom()}):EspacestravailService.listDiscussion(vm.typeUser,vm.idUser,vm.idEspaceT,vm.messageTopic).then(function(infosDiscussion){vm.discussion=infosDiscussion,vm.scrollToBottom()})}function envoyerMessage(){var messageTopicToSend={idTopic:vm.discussion.idTopic,contenu:$filter("base64encode")(vm.contenuMessageSaisi)};vm.requestLoading=EspacestravailService.ajoutMessageTopic(vm.typeUser,vm.idUser,vm.idEspaceT,messageTopicToSend).then(function(data){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Envoi de votre message réussi !!","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Envoi de votre message réussi !!","success","fa icon-ed_espacedetravail");var topic={id:vm.messageTopic.idTopic},lData=angular.copy(data);lData.isModere=!1,lData.dateCreation=moment().format("YYYY-MM-DD HH:mm:ss"),lData.auteur={idAuteur:Auth.idUser(),nom:Auth.currentUser().nom,prenom:Auth.currentUser().prenom,profil:Auth.role()},delete lData.token;var leMessage={target:{espacesW:[{id:Number(vm.idEspaceT)}]},data:lData,notification:{type:"info",title:"Nouvelle discussion",body:$filter("displayNom")(Auth.currentUser())+"a ajouté un message dans l'espace de travail \"<strong>"+vm.nomEspaceTravail+'</strong>"',icon:"fa icon-ed_espacedetravail",action:"/{profile}/{idUser}/EspacesTravail/"+vm.idEspaceT+"?item=discussion&topic="+vm.messageTopic.idTopic}};notificationSendService.sendMessage(leMessage),vm.contenuMessageSaisi="",chargeDiscussion(topic),CacheService.removeMatch(/.*\/topics/),listerDiscussionTopics()})}function effacerMessage(message,topic){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un message",config.message="Êtes-vous sûr de vouloir supprimer ce message ?",config.confirm="Valider",config.cancel="Non",config}}});stopIntervalRefreshMessages(),modalInstance.result.then(function(){vm.requestLoading=EspacestravailService.effacerMessageTopic(vm.typeUser,vm.idUser,vm.idEspaceT,topic,message).then(function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Suppression de votre message effectuée !","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Suppression de votre message effectuée !","success","fa icon-ed_espacedetravail");var topicFormate={id:topic.idTopic};chargeDiscussion(topicFormate,!0),modalInstance.close()},function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Une erreur est survenue","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Une erreur est survenue","error","fa icon-ed_espacedetravail")})},function(){startIntervalRefreshMessages()})}function setEditMessage(message,etat){etat===!0?(message.contenuEdit=$filter("base64decode")(message.contenu),stopIntervalRefreshMessages()):startIntervalRefreshMessages(),message.editable=etat}function modifierMessage(message){message.contenu=$filter("base64encode")(message.contenuEdit),delete message.contenuEdit,delete message.editable,message.idTopic=vm.messageTopic.idTopic,vm.requestLoading=EspacestravailService.modifierMessageTopic(vm.typeUser,vm.idUser,vm.idEspaceT,vm.messageTopic,message).then(function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Votre message a bien été modifié !","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Votre message a bien été modifié !","success","fa icon-ed_espacedetravail"),startIntervalRefreshMessages()},function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs+" - discussion","Une erreur est survenue","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Une erreur est survenue","error","fa icon-ed_espacedetravail")})}function refresh(){listerDiscussionTopics()}function startIntervalRefreshMessages(){vm.intervalRefresh=$interval(function(){if(angular.isDefined(vm.discussion)){var topic={id:vm.discussion.idTopic};vm.chargeDiscussion(topic,!1,!1)}},5e3)}function stopIntervalRefreshMessages(){angular.isDefined(vm.intervalRefresh)&&$interval.cancel(vm.intervalRefresh)}var vm=this;vm.idEspaceT=$routeParams.idEspaceTravail,vm.constantes=EspacestravailService.CONSTANTES,vm.isHimSelf=Auth.isHimself(vm.typeUser,vm.idUser),vm.contenuMessageSaisi="",vm.libelleSalleDesProfs="Salle des professeurs",vm.chargeDiscussion=chargeDiscussion,vm.ajoutSujetDiscussion=ajoutSujetDiscussion,vm.archiverTopic=archiverTopic,vm.callWebserviceArchiveTopic=callWebserviceArchiveTopic,vm.modifierTopic=modifierTopic,vm.envoyerMessage=envoyerMessage,vm.effacerMessage=effacerMessage,vm.modifierMessage=modifierMessage,vm.setEditMessage=setEditMessage,vm.refresh=refresh,Auth.isFamille()?(vm.typeUser=$routeParams.typeUser,vm.idUser=parseInt($routeParams.idUser)):(vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id),notificationService.addObserver(vm,"/"+vm.typeUser+"/"+vm.idUser+"/EspacesTravail/"+vm.idEspaceT,function(message){vm.discussion.messages.push(message.data),vm.scrollToBottom()}),vm.scrollToBottom=function(){$timeout(function(){var msgList=angular.element("#msg-wrap")[0];angular.isDefined(msgList)&&(msgList.scrollTop=msgList.scrollHeight)})},refresh(),$scope.$on("$destroy",function(){stopIntervalRefreshMessages()})}]).controller("TopicEditCtrl",["$uibModalInstance","topic","options","EspacestravailService","Auth","$routeParams","Notification",function($uibModalInstance,topic,options,EspacestravailService,Auth,$routeParams,Notification){function update(topic){EspacestravailService.modifierTopic(vmTopic.typeUser,vmTopic.idUser,vmTopic.idEspaceT,topic).then(function(){options.nomEspaceTravail===options.libelleSDP?Notification.notify(options.libelleSDP+" - discussion","Modification de votre sujet effectué !","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail - discussion","Modification de votre sujet effectué !","success","fa icon-ed_espacedetravail"),$uibModalInstance.close({topic:topic})})}function cancel(){$uibModalInstance.dismiss()}var vmTopic=this;vmTopic.typeUser=Auth.currentUser().typeCompte,vmTopic.idUser=Auth.currentUser().id,vmTopic.idEspaceT=$routeParams.idEspaceTravail,vmTopic.topic=angular.copy(topic),vmTopic.update=update,vmTopic.cancel=cancel}]),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailCloudCtrl",function(){}),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailMembresCtrl",["EspacestravailService","Auth","$routeParams","lodash","MessagerieService",function(EspacestravailService,Auth,$routeParams,lodash,MessagerieService){function listerMembres(){vm.loadingMembres=EspacestravailService.listMembres(vm.idUser,vm.typeUser,vm.idEspaceT).then(function(membreEspaceTravail){vm.droitUtilisateur=membreEspaceTravail.droitUtilisateur,vm.tabMembres=membreEspaceTravail.membres,vm.membres=lodash.chunk(vm.tabMembres,vm.itemParPage)})}function canSendMessageUser(){return MessagerieService.canSendMessageUser(Auth.TYPE_USER.ESPACE_TRAVAIL)}var vm=this;vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,
vm.idEspaceT=$routeParams.idEspaceTravail,vm.currentPage=1,vm.itemParPage=20,vm.canSendMessageUser=canSendMessageUser,listerMembres()}]),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailActiviteCtrl",["EspacestravailService","Auth","$routeParams","$uibModal","Notification",function(EspacestravailService,Auth,$routeParams,$uibModal,Notification){function refresh(){vm.loadingActivite=EspacestravailService.getFilActivite(vm.idUser,vm.typeUser,vm.idEspaceT).then(function(filActivite){vm.tabActivites=filActivite,EspacestravailService.resetBadgeEspaceTravail(vm.idEspaceT)})}function deleteFilActivite(isDeleteAll){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Purge du fil d'activité",config.message=isDeleteAll?"Êtes-vous sûr de vouloir supprimer l'intégralité des traces d'activités de l'espace de travail ?":"Êtes-vous sûr de vouloir supprimer les traces de vos activités ?",config.confirm="Supprimer",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.loadingActivite=EspacestravailService.deleteFilActivite(vm.idUser,vm.typeUser,vm.idEspaceT,isDeleteAll).then(function(){Notification.notify("Activité","Suppression des traces d'activité de l'espace de travail effectuée !","success",!0),modalInstance.close(),refresh()},function(){Notification.notify("Activité","Une erreur est survenue","error",!0)})})}var vm=this;vm.loadingActivite=null,vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.idEspaceT=$routeParams.idEspaceTravail,vm.tabActivites=[],vm.constantes=EspacestravailService.CONSTANTES,vm.nbBadge=EspacestravailService.getBadgeEspaceTravail(vm.idEspaceT),vm.refresh=refresh,vm.deleteFilActivite=deleteFilActivite,refresh()}]),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailAdministrationCtrl",["$uibModal","$routeParams","$location","EspacestravailService","CacheService","lodash","Auth","Notification","$filter","EmploiDuTempsService","$q",function($uibModal,$routeParams,$location,EspacestravailService,CacheService,lodash,Auth,Notification,$filter,EmploiDuTempsService,$q){function ajoutMembre(membres){membres.destinataires=lodash.map(membres.destinataires,function(dest){var destinataire={};return destinataire=dest.responsable.id>0?{idMembre:dest.responsable.id,profil:"1"}:{idMembre:dest.id,profil:dest.type}}),vm.requestLoading=EspacestravailService.ajoutMembres(vm.idUser,vm.typeUser,vm.idEspaceT,membres.destinataires).then(function(){CacheService.removeMatch(/.*\/membres/),listerMembresTries()},function(error){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs,"Une erreur s'est produite lors de l'ajout des membres","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail","Une erreur s'est produite lors de l'ajout des membres","error","fa icon-ed_espacedetravail")})}function majMembres(){vm.membresEleves=lodash.chunk(vm.elevesFiltered,vm.itemParPage),vm.membresProfs=lodash.chunk(vm.profsFiltered,vm.itemParPage),vm.membresFamilles=lodash.chunk(vm.famillesFiltered,vm.itemParPage),vm.membresPersonnel=lodash.chunk(vm.personnelsFiltered,vm.itemParPage),vm.originalMembresEleves=angular.copy(vm.membresEleves),vm.originalMembresProfs=angular.copy(vm.membresProfs),vm.originalMembresFamilles=angular.copy(vm.membresFamilles),vm.originalMembresPersonnels=angular.copy(vm.membresPersonnel)}function listerMembresTries(){vm.requestLoading=EspacestravailService.listMembres(vm.idUser,vm.typeUser,vm.idEspaceT).then(function(membreEspaceTravail){vm.nomEspaceTravail=membreEspaceTravail.titreEspaceTravail,vm.idEspaceT=membreEspaceTravail.idEspaceTravail,vm.membres=membreEspaceTravail.membres,vm.eleves=lodash.where(vm.membres,{profil:"E"}),vm.profs=lodash.where(vm.membres,{profil:"P"}),vm.responsableFamille=lodash.where(vm.membres,{profil:"1"}),vm.conjointFamille=lodash.where(vm.membres,{profil:"2"}),vm.familles=lodash.union(vm.conjointFamille,vm.responsableFamille),vm.familles=lodash.chain(vm.familles).sortBy(function(famille){return famille.prenom.toUpperCase()}).sortBy(function(famille){return famille.nom.toUpperCase()}).value(),vm.personnels=lodash.where(vm.membres,{profil:"A"}),vm.famillesFiltered=angular.copy(vm.familles),vm.membresFamillesFiltered=lodash.chunk(vm.famillesFiltered,vm.itemParPage),vm.personnelsFiltered=angular.copy(vm.personnels),vm.membresPersonnelFiltered=lodash.chunk(vm.personnelsFiltered,vm.itemParPage),vm.profsFiltered=angular.copy(vm.profs),vm.membresProfsFiltered=lodash.chunk(vm.profsFiltered,vm.itemParPage),vm.elevesFiltered=angular.copy(vm.eleves),vm.membresElevesFiltered=lodash.chunk(vm.elevesFiltered,vm.itemParPage),majMembres()})}function selectionEleve(opts,destinataires){var classes=[];Auth.isPersonnel()||Auth.isProfesseur()||(classes=Auth.getClasses());var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.eleve.template.html",controller:"MessageComposeSelectionEleveCtrl",size:"lg",backdrop:!1,resolve:{options:function(){var options={};return options.classes=classes,options.idEspaceTravail=vm.idEspaceT,options.sourceModule=Auth.TYPE_USER.ESPACE_TRAVAIL,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return""}}});modalInstance.result.then(function(eleves){vm.ajoutMembre(eleves)})}function selectionEnseignant(opts,destinataires){var classes=[];Auth.isPersonnel()||Auth.isProfesseur()||(classes=Auth.getClasses());var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.enseignant.template.html",controller:"MessageComposeSelectionEnseignantCtrl",size:"lg",backdrop:!1,resolve:{options:function(){var options={};return options.classes=classes,options.sourceModule=Auth.TYPE_USER.ESPACE_TRAVAIL,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return""}}});modalInstance.result.then(function(enseignants){vm.ajoutMembre(enseignants)})}function selectionPersonnel(opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.personnel.template.html",controller:"MessageComposeSelectionPersonnelCtrl",size:"lg",backdrop:!1,resolve:{options:function(){var options={};return options.sourceModule=Auth.TYPE_USER.ESPACE_TRAVAIL,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return""}}});modalInstance.result.then(function(personnels){vm.ajoutMembre(personnels)})}function selectionFamille(opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/messagerie/messagerie.compose.selection.famille.template.html",controller:"MessageComposeSelectionFamilleCtrl",size:"lg",backdrop:!1,resolve:{options:function(){var options={};return options.sourceModule=Auth.TYPE_USER.ESPACE_TRAVAIL,angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return""}}});modalInstance.result.then(function(familles){vm.ajoutMembre(familles)})}function save(espaceTravail){vm.espaceTravail=angular.copy(espaceTravail),vm.espaceTravail.description=$filter("base64encode")(vm.espaceTravail.description),vm.espaceTravail.resume=$filter("base64encode")(vm.espaceTravail.resume);var tabMembresEleves=lodash.flatten(vm.membresElevesFiltered),tabMembresProfs=lodash.flatten(vm.membresProfsFiltered),tabMembresFamilles=lodash.flatten(vm.membresFamillesFiltered),tabMembresPersonnels=lodash.flatten(vm.membresPersonnelFiltered);vm.espaceTravail.membres=lodash.union(tabMembresEleves,tabMembresProfs,tabMembresFamilles,tabMembresPersonnels),vm.requestLoading=EspacestravailService.modifierEspaceTravail(vm.idUser,vm.typeUser,vm.espaceTravail).then(function(espaceTravailAjour){vm.espaceTravail=espaceTravailAjour,espaceTravailAjour.estAdmin||(espaceTravail.estAdmin=!1,$location.path(vm.typeUser+"/"+vm.idUser+"/EspacesTravail")),vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs,"Modification de la "+vm.libelleSalleDesProfs+" effectuée ! ","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail","Modification de votre espace de travail effectuée ! ","success","fa icon-ed_espacedetravail"),majMembres(),refresh()},function(response){512===response.code&&(vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs,response.message,"error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail",response.message,"error","fa icon-ed_espacedetravail"),resetParametrageDroits())})}function supprimeMembre(membre){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'un membre",config.message="Confirmer la suppression du membre <strong>"+membre.prenom+' <span class="nom">'+membre.nom+"</span></strong> ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){vm.requestLoading=EspacestravailService.supprimeMembre(vm.idUser,vm.typeUser,vm.idEspaceT,membre).then(function(){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs,"Le membre <strong>"+membre.prenom+' <span class="nom">'+membre.nom+"</span></strong> a bien été supprimé","success","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail","Le membre <strong>"+membre.prenom+' <span class="nom">'+membre.nom+"</span></strong> a bien été supprimé","success","fa icon-ed_espacedetravail"),CacheService.removeMatch(/.*\/membres/),listerMembresTries()},function(error){vm.nomEspaceTravail===vm.libelleSalleDesProfs?Notification.notify(vm.libelleSalleDesProfs,"Une erreur s'est produite lors de la suppression du membre","error","fa icon-ed_salledesprofs"):Notification.notify("Espace de travail","Une erreur s'est produite lors de la suppression du membre","error","fa icon-ed_espacedetravail")})})}function resetParametrageDroits(){vm.eleves=angular.copy(lodash.flatten(vm.originalMembresEleves)),vm.profs=angular.copy(lodash.flatten(vm.originalMembresProfs)),vm.familles=angular.copy(lodash.flatten(vm.originalMembresFamilles)),vm.personnels=angular.copy(lodash.flatten(vm.originalMembresPersonnels)),vm.membresEleves=lodash.chunk(vm.eleves,vm.itemParPage),vm.membresProfs=lodash.chunk(vm.profs,vm.itemParPage),vm.membresFamilles=lodash.chunk(vm.familles,vm.itemParPage),vm.membresPersonnel=lodash.chunk(vm.personnels,vm.itemParPage),vm.elevesFiltered=[],vm.famillesFiltered=[],vm.profsFiltered=[],vm.personnelsFiltered=[],filterMembers(vm.eleveSearchFilter,"eleve"),filterMembers(vm.profsSearchFilter,"enseignant"),filterMembers(vm.personnelsSearchFilter,"personnel"),filterMembers(vm.famillesSearchFilter,"famille")}function selectAll(droit,tabMembres){for(var nbPartArray=tabMembres.length,indice=0;nbPartArray>indice;)lodash.forEach(tabMembres[indice],function(membre){membre.droit=droit}),indice++}function filterMembers(_input,typeMember){function filterMemberByNomPrenom(member){return!!lodash.contains($filter("specialCharacters")(member.nom.toLowerCase()),input)||lodash.contains($filter("specialCharacters")(member.prenom.toLowerCase()),input)}var input=angular.isDefined(_input)?_input.toLowerCase():"";"famille"===typeMember&&(lodash.forEach(vm.familles,function(fam){var filterElement=lodash.find(vm.famillesFiltered,{idMembre:fam.idMembre});filterElement&&(fam.droit=filterElement.droit)}),vm.famillesFiltered=angular.copy(lodash.chain(vm.familles).flatten().filter(filterMemberByNomPrenom).valueOf()),vm.membresFamillesFiltered=lodash.chunk(vm.famillesFiltered,vm.itemParPage)),"personnel"===typeMember&&(lodash.forEach(vm.personnels,function(perso){var filterElement=lodash.find(vm.periodeSelected,{idMembre:perso.idMembre});filterElement&&(perso.droit=filterElement.droit)}),vm.personnelsFiltered=angular.copy(lodash.chain(vm.personnels).flatten().filter(filterMemberByNomPrenom).valueOf()),vm.membresPersonnelFiltered=lodash.chunk(vm.personnelsFiltered,vm.itemParPage)),"enseignant"===typeMember&&(lodash.forEach(vm.personnels,function(perso){var filterElement=lodash.find(vm.personnelsFiltered,{idMembre:perso.idMembre});filterElement&&(perso.droit=filterElement.droit)}),vm.profsFiltered=angular.copy(lodash.chain(vm.profs).flatten().filter(filterMemberByNomPrenom).valueOf()),vm.membresProfsFiltered=lodash.chunk(vm.profsFiltered,vm.itemParPage)),"eleve"===typeMember&&(lodash.forEach(vm.eleves,function(elv){var filterElement=lodash.find(vm.elevesFiltered,{idMembre:elv.idMembre});filterElement&&(elv.droit=filterElement.droit)}),vm.elevesFiltered=angular.copy(lodash.chain(vm.eleves).flatten().filter(filterMemberByNomPrenom).valueOf()),vm.membresElevesFiltered=lodash.chunk(vm.elevesFiltered,vm.itemParPage)),vm.currentPage=1}function supprimeEspaceTravail(){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un espace de travail",config.message='Êtes-vous sûr de vouloir <strong class="text-danger">supprimer</strong> l\'espace de travail <strong>'+vm.nomEspaceTravail+"</strong> ?",config.confirm="Valider",config.cancel="Non",config}}});modalInstance.result.then(function(){var modalConfirmBis=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un espace de travail",config.message='<p>Êtes vous vraiment sûr de vouloir <strong class="text-danger">supprimer</strong> l\'espace de travail <strong>'+vm.nomEspaceTravail+'</strong> ?</p><p class="text-danger">Attention <strong>cette action est définitive</strong> et supprimera également toutes les données associées à cet espace de travail (documents du cloud, discussions, membres, évènements de l\'agenda et les post-its) !</p>',config.confirm="Valider",config.cancel="Non",config}}});modalConfirmBis.result.then(function(){callWebserviceSupprimerEspace(),modalConfirmBis.close()})})}function callWebserviceSupprimerEspace(){var lesAgendaToDisplay=[],lesPromises=[EspacestravailService.deleteEspaceTravail(vm.idUser,vm.typeUser,vm.idEspaceT),EmploiDuTempsService.listeAgendasToDisplay().then(function(agendasToDisplay){lesAgendaToDisplay=agendasToDisplay})];vm.requestLoading=$q.all(lesPromises).then(function(){EmploiDuTempsService.agendasToDisplay=lodash.reject(lesAgendaToDisplay,function(agenda){return"W"===agenda.typeEntity&&agenda.idEntity===vm.idEspaceT&&"W"===agenda.typeAgenda}),Notification.notify("Espace de travail","Suppression de votre espace de travail effectuée ! ","success","fa icon-ed_espacedetravail"),$location.path(vm.typeUser+"/"+vm.idUser+"/EspacesTravail")},function(error){Notification.notify("Espace de travail","Une erreur s'est produite lors de la suppression de l'espace de travail","error","fa icon-ed_espacedetravail")})}function refresh(){listerMembresTries()}var vm=this;vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.idEspaceT=$routeParams.idEspaceTravail,vm.libelleSalleDesProfs="Salle des professeurs",vm.currentPage=1,vm.itemParPage=8,vm.tabColorsDispos=["#ffff99","#ffff00","#ffd966","#ffbf00","#ff8000","#ff6666","#ff0000","#bfff00","#80cc33","#33cc33","#1796b0","#00bfff","#3399ff","#0080ff","#0040ff","#9999ff","#bf00ff","#ff00ff","#8000ff","#993300","#800000"],vm.resetParametrageDroits=resetParametrageDroits,vm.selectionEleve=selectionEleve,vm.selectionEnseignant=selectionEnseignant,vm.selectionPersonnel=selectionPersonnel,vm.selectionFamille=selectionFamille,vm.save=save,vm.supprimeMembre=supprimeMembre,vm.listerMembresTries=listerMembresTries,vm.selectAll=selectAll,vm.refresh=refresh,vm.ajoutMembre=ajoutMembre,vm.isHimSelf=Auth.isHimself,vm.filterMembers=filterMembers,vm.supprimeEspaceTravail=supprimeEspaceTravail,refresh()}]),angular.module("edsiteApp.CarnetNotes",["edsiteApp.Commun","ngHandsontable","ngLodash","ui.bootstrap","edsiteApp.Note","edsiteApp.PersonnelConsultation"]).factory("CarnetNotesService",["$http","$q","EDHttp","$filter","lodash","CacheService","ModuleService",function($http,$q,EDHttp,$filter,lodash,CacheService,ModuleService){var service={},SEPARATEUR="¤";service.CODE_MATIERE_SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},service.CONSTANTES={PERIODES:{ETATS:{CLOTUREE:"cloture",PARTIELLE:"partiel",ATTENTE:"",OUVERTE:"ouvert"},CODES:{ANNEE:"A999Z"}},LETTRES_NOTES:{ABS:"abs",DISP:"disp"}},service.typeEntity={CLASSE:"C",GROUPE:"G"};for(var defaultDiacriticsRemovalMap=[{base:"",letters:"'"},{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],diacriticsMap={},i=0;i<defaultDiacriticsRemovalMap.length;i++)for(var letters=defaultDiacriticsRemovalMap[i].letters,j=0;j<letters.length;j++)diacriticsMap[letters[j]]=defaultDiacriticsRemovalMap[i].base;return service.removeDiacritics=function(str){return str=str.replace("'",""),str=str.replace("-",""),str.replace(/[^\u0000-\u007E]/g,function(a){return diacriticsMap[a]||a})},service.getPuissancePeriodeEtat=function(etat){var puissances={cloture:4,partiel:3,"":2,ouvert:1};return lodash.has(puissances,etat)?puissances[etat]:0},service.deferDirectiveEleveNotes=$q.defer(),service.observeEtatLoadingEleveNotesDirective=function(){return service.deferDirectiveEleveNotes.promise},service.setEtatLoadingEleveNotesDirective=function(val){service.deferDirectiveEleveNotes.notify(val)},service.getDevoirsProf=function(idEnseignant,typeEntity,idEntity,idPeriode,codeMatiere,codeSSmatiere){var defer=$q.defer();if(6!==arguments.length)return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var baseUrl="enseignants/"+idEnseignant+"/"+typeEntity+"/"+idEntity+"/periodes/"+idPeriode+"/matieres/"+codeMatiereSSMatiere+"/notes";return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){return response.data.data},function(error){return error})},service.createDevoir=function(idUser,typeEntity,idEntity,codePeriode,codeMatiere,codeSSmatiere,devoir){var defer=$q.defer();if(7!==arguments.length)return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data.devoir=devoir;var baseUrl="enseignants/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/devoirs";return CacheService.removeMatch(/.*\/devoirs/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.updateDevoir=function(idUser,typeEntity,idEntity,codePeriode,codeMatiere,codeSSmatiere,devoir){var defer=$q.defer();if(7!==arguments.length)return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data.devoir=devoir;var baseUrl="enseignants/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/devoirs/"+devoir.id;return CacheService.removeMatch(/.*\/devoirs/),$http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.deleteDevoir=function(idUser,typeEntity,idEntity,codePeriode,codeMatiere,codeSSmatiere,devoir){var defer=$q.defer();if(7!==arguments.length)return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={},baseUrl="enseignants/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/devoirs/"+devoir.id;return CacheService.removeMatch(/.*\/devoirs/),$http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.getPeriodesClasse=function(idUser,typeUser,idClasse){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/classes/"+idClasse+"/periodes";return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.periodes)},function(error){defer.reject(error)}),defer.promise},service.getPeriodesGroupe=function(idUser,typeUser,idGroupe){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/groupes/"+idGroupe+"/periodes";return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.periodes)},function(error){defer.reject(error)}),defer.promise},service.saveNotes=function(idEnseignant,typeEntity,idEntity,idPeriode,codeMatiere,codeSSmatiere,devoirs,eleves){var defer=$q.defer();if(angular.isUndefined(idEnseignant))return defer.reject(),defer.promise;var modifiedDevoirsOrigin=lodash.chain(devoirs).filter({readOnly:!1}).valueOf(),modifiedDevoirs=angular.copy(modifiedDevoirsOrigin),eleveOrig=angular.copy(eleves),codeMatiereSSMatiere=(lodash.map(modifiedDevoirs,function(devoir){return devoir.eleves=lodash.chain(eleveOrig).filter(function(eleveObj){return lodash.has(eleveObj,"eleve")}).map(function(eleveObj){var lesDevoirs=[],dev=lodash.get(eleveObj.devoirs,devoir.id);return angular.isDefined(dev)&&(dev.idDevoir=devoir.id,lodash.defaults(dev,devoir),lesDevoirs.push(dev)),{nom:eleveObj.eleve.nom,prenom:eleveObj.eleve.prenom,particule:eleveObj.eleve.particule,id:eleveObj.eleve.id,devoirs:lesDevoirs}}).valueOf(),devoir}),codeMatiere);angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data.devoirs=modifiedDevoirs;var url="enseignants/"+idEnseignant+"/"+typeEntity+"/"+idEntity+"/periodes/"+idPeriode+"/matieres/"+codeMatiereSSMatiere+"/notes";return $http({method:"POST",url:url,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.duplicateDevoirAndNotes=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSSmatiere,devoir,codePeriodeDestination){var defer=$q.defer(),codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data=devoir,data.periodeDestination={codePeriode:codePeriodeDestination};var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/devoirs/duplication";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.duplicateInfosDevoir=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSSmatiere,devoir,periodesClassesToDuplicate){var defer=$q.defer(),codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data=devoir,data.classes=periodesClassesToDuplicate;var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/devoirs/duplicationAutresClasses";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.getDateAffichageDevoirNote=function(dateSaisie,isLSUN,paramNotes){var nbJoursDecalage=0;return nbJoursDecalage=isLSUN===!0?"1"!==paramNotes.avecDecalageLSUN?0:parseInt(paramNotes.nbreJoursDecalageLSUN):"1"!==paramNotes.avecDecalage?0:parseInt(paramNotes.nbreJoursDecalage),moment(dateSaisie).add(nbJoursDecalage,"d").toDate()},service.getLibelleConseil=function(periode){var libelleConseil="";if(!angular.isUndefined(periode))return""!==periode.heureConseil&&angular.isDefined(periode.heureConseil)&&(libelleConseil="à "+periode.heureConseil),""!==periode.heureConseil&&""!==periode.heureFinConseil&&angular.isDefined(periode.heureConseil)&&angular.isDefined(periode.heureFinConseil)&&(libelleConseil="de "+periode.heureConseil+" à "+periode.heureFinConseil),""!==periode.salleConseil&&angular.isDefined(periode.salleConseil)&&(libelleConseil+=" en salle "+periode.salleConseil),libelleConseil},service}]),angular.module("edsiteApp.CarnetNotes").controller("EnseignantNotesCtrl",["$scope","$rootScope","$sce","$timeout","$routeParams","$location","Auth","UserService","Notification","CarnetNotesService","lodash","$filter","ModuleService","$sessionStorage","Utils",function($scope,$rootScope,$sce,$timeout,$routeParams,$location,Auth,UserService,Notification,CarnetNotesService,lodash,$filter,ModuleService,$sessionStorage,Utils){function mergePeriodes(periodes){var periodesByCode=lodash.groupBy(periodes,"codePeriode"),finalPeriodes=[];return lodash.forEach(periodesByCode,function(pCodes){var periode=lodash.reduce(pCodes,function(result,current){return result.etat=CarnetNotesService.getPuissancePeriodeEtat(result.etat)>CarnetNotesService.getPuissancePeriodeEtat(current.etat)?result.etat:current.etat,result});finalPeriodes.push(periode)}),finalPeriodes}function selectClasse(classe){if(vm.statusDropdown.isClasseOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectClasse(classe)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.classe=classe,vm.matiere=void 0,vm.periode=void 0,vm.matieres=void 0,vm.periodes=void 0,vm.periodes=classe.periodes,"G"===classe.type&&(vm.periodes=mergePeriodes(classe.periodes)),vm.allPeriodes=angular.copy(vm.periodes),vm.periodesForAppreciations=lodash.reject(vm.allPeriodes,{saisieAppreciation:!1}),refreshPeriodes(),vm.classePP=lodash.find(vm.classesPP,{id:classe.id}),angular.isDefined(vm.classePP)===!0?vm.periodesPP=vm.classePP.periodes:vm.periodesPP=void 0;var today=moment().format("YYYY-MM-DD");vm.actuelPeriode=lodash.find(vm.periodes,function(per){return per.codePeriode!==CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE&&per.dateDebut<today&&per.etat===CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE&&0===per.sousPeriode}),angular.isDefined(vm.actuelPeriode)&&selectPeriode(vm.actuelPeriode),"pratiquesEnseignement"===vm.selected&&(vm.isMonoDevoir()?vm.selectView("competencesLSU"):vm.selectView("notes")),angular.isDefined(vm.classe.paramsLSU.numeroCycle)?(vm.pratiquesEnseignement=[{code:"AP",libelle:"AP",title:"Accompagnements Personnalisés",isPratiqueEnseignement:!0},{code:"EPI",libelle:"EPI",title:"Enseignements Pratiques Interdisciplinaires",isPratiqueEnseignement:!0},{code:"PARCOURS",libelle:"Parcours",title:"Parcours",isPratiqueEnseignement:!0}],3!==vm.classe.paramsLSU.numeroCycle&&4!==vm.classe.paramsLSU.numeroCycle&&(vm.pratiquesEnseignement=lodash.reject(vm.pratiquesEnseignement,{code:"EPI"})),2!==vm.classe.degre&&4!==vm.classe.degre&&(vm.pratiquesEnseignement=lodash.reject(vm.pratiquesEnseignement,{code:"AP"}))):vm.pratiquesEnseignement=[]}function selectPeriode(periode){if(vm.statusDropdown.isPeriodeOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectPeriode(periode)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}return vm.periode=periode,vm.matieres=lodash.chain(periode.matieres).uniq("id").value(),vm.matiere&&(vm.matiere=lodash.find(vm.matieres,function(mat){return mat.code===vm.matiere.code})),1===vm.matieres.length&&(vm.matiere=vm.matieres[0]),vm.periodePP=lodash.find(vm.periodesPP,{
id:periode.id}),(angular.isDefined(vm.periodePP)||vm.matieres.length>0&&angular.isDefined(vm.periode))&&(vm.displayPratiquesEnseignementForPP=!0),"notes"!==vm.selected&&"competencesLSU"!==vm.selected&&"composantes"!==vm.selected||(vm.periodeNotAvailable=vm.periodeAvailable(vm.periodesForNotes,periode),!vm.periodeNotAvailable)?"appreciations"===vm.selected&&(vm.periodeNotAvailable=vm.periodeAvailable(vm.periodesForAppreciations,periode),vm.periodeNotAvailable)?!1:void 0:!1}function selectMatiere(matiere){if(vm.statusDropdown.isMatiereOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectMatiere(matiere)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.matiere=matiere,"pratiquesEnseignement"===vm.selected&&(vm.isMonoDevoir()?vm.selectView("competencesLSU"):vm.selectView("notes")),vm.classe.estNote&&"competencesLSU"===vm.selected&&vm.classe.idCycleEtab<=0&&(vm.isMonoDevoir()?vm.selectView("competencesLSU"):vm.selectView("notes")),vm.classe.estNote||"notes"!==vm.selected||vm.selectView("competencesLSU")}function selectPratiqueEnseignement(pratiqueEnseignement){if(vm.statusDropdown.isMatiereOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectPratiqueEnseignement()},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.matiere=pratiqueEnseignement,vm.selectView("pratiquesEnseignement")}function isMonoDevoir(){return vm.Utils.isMobile()||vm.isModeMonoDevoirDefaut}function selectClassePP(classe){if(vm.statusDropdown.isClasseOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectClassePP(classe)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.classePP=classe,vm.periodePP=void 0,vm.periode=void 0,vm.periodesPP=$filter("displayPeriodeSansR")(classe.periodes),vm.classe=lodash.find(vm.classes,{id:classe.classeId}),vm.periodes=classe.periodes,"G"===classe.type&&(vm.periodes=mergePeriodes(classe.periodes)),vm.allPeriodes=angular.copy(vm.periodes),vm.periodesForAppreciations=lodash.reject(vm.allPeriodes,{saisieAppreciation:!1})}function selectPeriodePP(periode){if(vm.statusDropdown.isPeriodeOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectPeriodePP(periode)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.periodePP=periode,vm.periode=periode,vm.matieres=lodash.chain(periode.matieres).uniq("id").value(),vm.matiere&&(vm.matiere=lodash.find(vm.matieres,function(mat){return mat.code===vm.matiere.code})),1===vm.matieres.length&&(vm.matiere=vm.matieres[0])}function displayMsgNavigationDisabled(){Notification.notify("Note",'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',"error","icon-ed_note")}function periodeAvailable(tabPeriodes,periodeToCheck){if(angular.isUndefined(periodeToCheck))return!1;var periodeTrouve=lodash.find(tabPeriodes,function(periodeActu){return periodeActu.codePeriode===periodeToCheck.codePeriode});return angular.isUndefined(periodeTrouve)}function refreshPeriodes(){Auth.role()===Auth.TYPE_USER.PERSONNEL||vm.isChefEtablissement||Auth.role()===Auth.TYPE_USER.ENSEIGNANT||$location.path("/403"),vm.periodesForNotes=$filter("displayPeriodeSansR")(vm.periodes),vm.periodesForAppreciations=lodash.reject(vm.allPeriodes,{saisieAppreciation:!1}),vm.periodeOnlyReleves=lodash.filter(vm.allPeriodes,function(periode){return"R"===periode.codePeriode[4]&&"H"!==periode.codePeriode[0]}),vm.periodes=vm.periodesForNotes,vm.periodesPP=angular.copy(vm.periodesForNotes)}function _changeView(idView){return vm.selected=idView,"notes"!==vm.selected&&"competencesLSU"!==vm.selected&&"composantes"!==vm.selected||(vm.periodeNotAvailable=vm.periodeAvailable(vm.periodesForNotes,vm.periode),!vm.periodeNotAvailable)?"appreciations"===vm.selected&&(vm.periodeNotAvailable=vm.periodeAvailable(vm.periodesForAppreciations,vm.periode),vm.periodeNotAvailable)?!1:void refreshPeriodes():!1}function displayWarningEditRunning(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}function selectView(idView){if($rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){_changeView(idView)},500)},cancelCallback=function(notice){notice.remove()};return void displayWarningEditRunning(okCallback,cancelCallback)}_changeView(idView)}function getEtatPeriode(etat){var periode={};return periode[vm.CONSTANTES.PERIODES.ETATS.ATTENTE]="En attente",periode[vm.CONSTANTES.PERIODES.ETATS.CLOTUREE]="Clôturée",periode[vm.CONSTANTES.PERIODES.ETATS.PARTIELLE]="Partielle",periode[vm.CONSTANTES.PERIODES.ETATS.OUVERTE]="Ouverte",periode[etat]}function displayLibellePeriode(etatPeriode){return getEtatPeriode(etatPeriode)}function getLibellePeriodePrincipaleForReleve(codeReleve){var pPrincipale=lodash.find(vm.periodes,{codePeriode:codeReleve.substr(0,4)});return angular.isDefined(pPrincipale)?pPrincipale.libelle:"principale"}function refresh(){vm.promiseLoading=UserService.getProfClassesGroupesTree().then(function(classes){vm.classes=angular.copy(classes),vm.isMonoDevoir()?vm.selectView("competencesLSU"):vm.selectView("notes"),Auth.role()===Auth.TYPE_USER.PERSONNEL&&ModuleService.isModuleEnabled(ModuleService.CODES.CONSEIL_DE_CLASSE)&&vm.selectView("appreciationsPP"),UserService.getClassesPP().then(function(classes){vm.classesPP=angular.copy(classes)})})}var vm=this;vm.selectClasse=selectClasse,vm.selectMatiere=selectMatiere,vm.selectPeriode=selectPeriode,vm.selectClassePP=selectClassePP,vm.selectPeriodePP=selectPeriodePP,vm.selectPratiqueEnseignement=selectPratiqueEnseignement,vm.refreshPeriodes=refreshPeriodes,vm.displayMsgNavigationDisabled=displayMsgNavigationDisabled,vm.periodeAvailable=periodeAvailable,vm.selectView=selectView,vm.isMonoDevoir=isMonoDevoir,vm.displayLibellePeriode=displayLibellePeriode,vm.getLibellePeriodePrincipaleForReleve=getLibellePeriodePrincipaleForReleve,vm.classes=void 0,vm.classe=void 0,vm.matiere=void 0,vm.periode=void 0,vm.matieres=void 0,vm.periodes=void 0,vm.actuelPeriode=void 0,vm.classesPP=void 0,vm.classePP=void 0,vm.periodeNotAvailable=!1,vm.idUser=Auth.currentUser().id,vm.CONSTANTES=CarnetNotesService.CONSTANTES,vm.Utils=Utils,vm.isProf=Auth.role()===Auth.TYPE_USER.ENSEIGNANT,vm.isPersonnel=Auth.role()===Auth.TYPE_USER.PERSONNEL,vm.isChefEtablissement=ModuleService.isModuleEnabled(ModuleService.CODES.CONSEIL_DE_CLASSE),vm.saisieLSUN=!1,vm.isModeMonoDevoirDefaut=!1,vm.seulPPVoieToutesLesNotes=!1,vm.seulPPVoieVieScolaire=!1,$rootScope.navigationDisabled=!1;var paramNotes={};vm.statusDropdown={isClasseOpen:!1,isPeriodeOpen:!1,isMatiereOpen:!1},vm.tabPratiquesEnseignement=[],vm.displayPratiquesEnseignementForPP=!1,vm.isPersonnel?($scope.showNewSaisie=!0,vm.saisieLSUN=!0,vm.seulPPVoieToutesLesNotes=!1,vm.seulPPVoieVieScolaire=!1):(paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES),vm.saisieLSUN="1"===paramNotes.params.saisieLSUN,vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,vm.seulPPVoieVieScolaire="1"===paramNotes.params.seulPPVoieVieScolaire),vm.isModeMonoDevoirDefaut="mono"===Auth.listParametresIndividuels("typeSaisieNotesDefaut"),refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("SaisieNotesCtrl",["CarnetNotesService","lodash","hotRegisterer","$uibModal","SaisieNotesService","$rootScope","$scope","$filter","$compile","Auth","Notification","UserService","ModuleService","CompetencesService","$q","$sessionStorage",function(CarnetNotesService,lodash,hotRegisterer,$uibModal,SaisieNotesService,$rootScope,$scope,$filter,$compile,Auth,Notification,UserService,ModuleService,CompetencesService,$q,$sessionStorage){function getLibelleConseil(periode){return CarnetNotesService.getLibelleConseil(periode)}function getPeriodesRelevees(periode){return angular.isUndefined(periode)?[]:lodash.filter($scope.noteCtrl.periodeOnlyReleves,function(p){return lodash.startsWith(p.codePeriode,periode.codePeriode+"R")})}function setTriByClasse(){$rootScope.navigationDisabled||vm.isProcessingSaving||(vm.sortByClasse=!0,refresh())}function setTriAlpha(){$rootScope.navigationDisabled||vm.isProcessingSaving||(vm.sortByClasse=!1,refresh())}function _cancel(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/cancel-edit.html",backdrop:!1});modalInstance.result.then(function(result){"1"===result&&(vm.coordNotesModifEnCours=[],vm.isModifEnCoursNoteGlobal=!1,refresh())})}function _setTriByClasse(){vm.sortByClasse=!0;var rowsInfo=vm.data.slice(0,2),eleves=vm.data.slice(2),elevesGroupedByClasse=lodash.groupBy(eleves,"eleve.codeClasse"),keys=lodash.keys(elevesGroupedByClasse);keys.sort();var elevesSorted={};lodash.forEach(keys,function(val){elevesSorted[val]=elevesGroupedByClasse[val]}),elevesSorted=lodash.reduce(elevesSorted,function(result,value,key){return result.concat(value)},[]),vm.data=rowsInfo.concat(elevesSorted)}function _setTriAlpha(){vm.sortByClasse=!1;var rowsInfo=vm.data.slice(0,2),eleves=vm.data.slice(2),elevesSorted=lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).value();vm.data=rowsInfo.concat(elevesSorted)}function refresh(){if(angular.isDefined(vm.data)&&vm.data.splice(0,vm.data.length),angular.isDefined(vm.column)&&vm.columns.splice(0,vm.columns.length),!(angular.isUndefined($scope.noteCtrl.classe)||angular.isUndefined($scope.noteCtrl.periode)||angular.isUndefined($scope.noteCtrl.matiere)||vm.refreshEnCours)){vm.refreshEnCours=!0;var lesPromises=[CarnetNotesService.getDevoirsProf(vm.idUser,$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere).then(function(data){if(vm.refreshEnCours=!1,$rootScope.navigationDisabled=!1,angular.isUndefined(data.eleves)||0===data.eleves.length)return void(vm.aucunEleves=!0);vm.aucunEleves=!1,lodash.forEach(data.eleves,function(eleve){lodash.forEach(data.devoirs,function(devoir){lodash.has(eleve.devoirs,devoir.id)||(eleve.devoirs[devoir.id]=angular.copy(devoir))})});var columns=[{type:"numeric",readOnly:!0,data:"moyenne",renderer:SaisieNotesService.colMoyenne}];columns=columns.concat(data.devoirs),lodash.forEach(columns,function(col,idx){col.readOnly=!0,0!==idx&&(col.data="devoirs."+col.id+".note",col.notationLettre&&(col.data="devoirs."+col.id+".lettre"))});var rows=[];rows.push({}),rows.push({}),vm.data=rows.concat(data.eleves),vm.devoirs=data.devoirs,vm.columns=columns,SaisieNotesService.setColumns(vm.columns),SaisieNotesService.setPeriodes($scope.noteCtrl.periodes.concat($scope.noteCtrl.periodeOnlyReleves)),SaisieNotesService.setCurrentPeriode($scope.noteCtrl.periode),SaisieNotesService.setCurrentMatiere($scope.noteCtrl.matiere),SaisieNotesService.setCurrentClasse($scope.noteCtrl.classe),SaisieNotesService.setData(vm.data),vm.sortByClasse?_setTriByClasse():_setTriAlpha()},function(){Notification.notify("Récupération des notes","Une erreur s'est produite lors de la récupération des évaluations","error","icon-ed_note")})];vm.promiseLoading=$q.all(lesPromises),buildContextMenu()}}function ajouterDevoir(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/edit-devoir.html",controller:"DevoirEditCtrl as editDevoirCtrl",backdrop:!1,size:"lg",resolve:{options:function(){var options={};return options.title="Création d'une évaluation",options.mode="create",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.isReadOnly=!0,options.yatilDesNotes=!1,options},datasLSU:function(){var data={};return data.devoir={},data.periode=$scope.noteCtrl.periode,data.periodesRelevees=getPeriodesRelevees($scope.noteCtrl.periode),data.constantesNotes=CarnetNotesService.CONSTANTES,data.notesDevoir={},data.devoirsProf=vm.devoirs,data}}});modalInstance.result.then(function(devoir){lodash.has(devoir,"libelle")&&(devoir.avecNote?devoir.readOnly=!1:devoir.readOnly=!0,vm.columns.push(devoir),lodash.forEach(vm.data,function(eleve){lodash.has(eleve,"devoirs")&&(eleve.devoirs[devoir.id]={idDevoir:devoir.id,codeMatiere:$scope.noteCtrl.matiere.code,codeSSMatiere:$scope.noteCtrl.matiere.codeSSMatiere,noteSur:devoir.noteSur,coef:devoir.coef,devoirLibelle:devoir.libelle,notationLettre:devoir.notationLettre})}),devoir.avecNote&&($rootScope.navigationDisabled=!0,devoir.data=devoir.notationLettre?"devoirs."+devoir.id+".lettre":"devoirs."+devoir.id+".note"),vm.handsTableInstance.render())})}function openPrintModal(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/editions-notes.html",controller:"NotesEditionCtrl as notesEditionCtrl",backdrop:!0,resolve:{options:function(){var options={};return options.title="Editions des notes",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.triEleve=vm.sortByClasse?"classe":"eleve",options},periode:function(){return $scope.noteCtrl.periode},periodesReleve:function(){var codePeriodeCourante=$scope.noteCtrl.periode.codePeriode;return lodash.filter($scope.noteCtrl.periodeOnlyReleves,function(periode){return periode.codePeriode.substr(0,codePeriodeCourante.length)===codePeriodeCourante})},constantesNotes:function(){return CarnetNotesService.CONSTANTES}}});modalInstance.result.then(function(data){})}function openDevoir(devoir){var devoirInfo=lodash.find(vm.columns,{id:devoir.id}),devoirWithNotes={},tabEleves=[],yatilDesNotes=!1;lodash.forEach(vm.data,function(eleve){if(lodash.has(eleve,"devoirs")){var eleveActu=eleve.eleve;lodash.has(eleve.devoirs,devoir.id)&&(eleveActu.note=eleve.devoirs[devoir.id],angular.isDefined(eleveActu.note)&&angular.isDefined(eleveActu.note.note)&&""!==eleveActu.note.note&&(yatilDesNotes=!0),angular.isDefined(eleveActu.note)&&angular.isDefined(eleveActu.note.lettre)&&""!==eleveActu.note.lettre&&(yatilDesNotes=!0))}angular.isDefined(eleveActu)&&tabEleves.push(eleveActu)}),devoirWithNotes={devoir:devoir,eleves:tabEleves};var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/edit-devoir.html",controller:"DevoirEditCtrl as editDevoirCtrl",backdrop:!1,size:"lg",resolve:{options:function(){var options={};return options.title="Paramètres de l'évaluation",options.mode="edit",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.onlyPeriodesNotes=$scope.noteCtrl.periodesForNotes,options.isReadOnly=devoirInfo.readOnly,options.yatilDesNotes=yatilDesNotes,options},datasLSU:function(){var data={};return data.devoir=devoir,data.periode=$scope.noteCtrl.periode,data.periodesRelevees=getPeriodesRelevees($scope.noteCtrl.periode),data.constantesNotes=CarnetNotesService.CONSTANTES,data.notesDevoir=devoirWithNotes,data.devoirsProf=vm.devoirs,data}}});modalInstance.result.then(function(_devoir){if(null===_devoir){lodash.remove(vm.columns,{id:devoir.id}),lodash.forEach(vm.data,function(eleve){lodash.has(eleve,"devoirs")&&delete eleve.devoirs[devoir.id]});var modifiedDevoirs=lodash.filter(vm.columns,{readOnly:!1});0===modifiedDevoirs.length&&($rootScope.navigationDisabled=!1,vm.isProcessingSaving=!1);var keyDevoirInStorage=$scope.noteCtrl.classe.id+"_"+$scope.noteCtrl.periode.codePeriode+"_"+$scope.noteCtrl.matiere.code+"_"+$scope.noteCtrl.matiere.codeSSMatiere;angular.isDefined($sessionStorage[keyDevoirInStorage])&&$sessionStorage[keyDevoirInStorage].id===devoir.id&&delete $sessionStorage[keyDevoirInStorage]}else{if(_devoir.coef!==devoir.coef||_devoir.noteSur!==devoir.noteSur||_devoir.nonSignificatif!==devoir.nonSignificatif)return void refresh();devoir.notationLettre!==_devoir.notationLettre&&(lodash.forEach(vm.data,function(eleve){lodash.has(eleve.devoirs,_devoir.id)&&delete eleve.devoirs[_devoir.id]}),_devoir.data=_devoir.notationLettre?"devoirs."+_devoir.id+".lettre":"devoirs."+_devoir.id+".note"),angular.extend(devoir,_devoir)}})}function openNote(eleve,devoir){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/edit-note.html",controller:"EditNoteCtrl as editNoteCtrl",backdrop:!1,resolve:{periode:function(){return $scope.noteCtrl.periode},periodes:function(){return $scope.noteCtrl.periodes},options:function(){var options={};return options.title="Détail d'une note",options},eleve:function(){return eleve},devoir:function(){return devoir},periodesRelevees:function(){return getPeriodesRelevees($scope.noteCtrl.periode)}}}),note=eleve.devoirs[devoir.id];angular.isUndefined(note)&&(note={},angular.extend(note,devoir),eleve.devoirs[devoir.id]=note),modalInstance.result.then(function(_note){angular.extend(note,_note),eleve.devoirs[devoir.id]=note,vm.handsTableInstance.render()})}function openEleve(eleve){if(!vm.seulPPVoieToutesLesNotes||$scope.noteCtrl.classe.isPP){var paramEtab=lodash.find(SaisieNotesService.etabsParams,{id:$scope.noteCtrl.classe.etabId});$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!1,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0,paramNoteEtab:paramEtab}}}})}}function saveAll(){var isAllNotesGood=!0,modifiedDevoirs=lodash.filter(vm.columns,{readOnly:!1});if(0!==modifiedDevoirs.length){if(lodash.forEach(modifiedDevoirs,function(devoir){lodash.forEach(vm.data,function(eleve){lodash.has(eleve,"devoirs")&&lodash.has(eleve.devoirs,devoir.id)&&eleve.devoirs[devoir.id].isGoodNote===!1&&(isAllNotesGood=!1)})}),!isAllNotesGood){var opts={hide:!0,cornerclass:"clickable",width:"40%",min_height:"100px",title:"Notes",text:'<p style="font-size: 1.5em;">Certaines notes sont incorrectes...</p>',type:"error",icon:"icon-ed_note",delay:3e3,buttons:{closer:!0,sticker:!1,show_on_nonblock:!0,labels:{close:"Fermer"}},nonblock:{nonblock:!0,nonblock_opacity:.2}},notice=new PNotify(opts);return void notice.get().click(function(){notice.remove()})}vm.isProcessingSaving=!0,vm.promiseLoading=CarnetNotesService.saveNotes(vm.idUser,$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere,vm.columns,vm.data).then(function(data){vm.isProcessingSaving=!1,Notification.notify("Notification","Vos notes ont été sauvegardées","success","icon-ed_note"),$rootScope.navigationDisabled=!1,vm.coordNotesModifEnCours=[],vm.isModifEnCoursNoteGlobal=!1,refresh()},function(error){vm.isProcessingSaving=!1,Notification.notify("Notes",error.data.message||"Une erreur s'est produite...","error","icon-ed_note")})}}function setAllDevoirsToEditable(){lodash.forEach(vm.columns,function(col,idx){idx>0&&col.statutPeriode===CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE&&angular.isDefined(col.idProf)&&col.idProf===Auth.idUser()&&col.avecNote&&(col.readOnly=!1,$rootScope.navigationDisabled=!0,vm.isModifEnCoursNoteGlobal=!0)})}function isInEditMode(){return lodash.filter(vm.columns,{readOnly:!1}).length>0}function renderEditDevoirBtn(col,row){var classDisabled="",indexCoordNotesInEdit=vm.coordNotesModifEnCours.indexOf(col+"-"+row);(indexCoordNotesInEdit>=0||vm.isModifEnCoursNoteGlobal===!0)&&(classDisabled="disabled");var htmlEditDevoir='<a id="edit-devoir-'+col+"-"+row+'" ng-click="sNotesCtrl.openDevoir_'+col+"_"+row+'()" class="'+classDisabled+'"><i class="fa fa-book " title="Modifier l\'évaluation"></i></a>';angular.element(document.getElementById("edit-devoir-"+col+"-"+row)).remove(),angular.element(".hot-devoir-"+col+"-"+row).append($compile(htmlEditDevoir)($scope)),vm["openDevoir_"+col+"_"+row]=function(){0>indexCoordNotesInEdit&&vm.isModifEnCoursNoteGlobal===!1&&vm.openDevoir(vm.columns[col])}}function renderEditNotesBtn(col,row){var htmlEditNotes='<a id="edit-notes'+col+"-"+row+'" ng-click="sNotesCtrl.editNotes'+col+"_"+row+'()">&nbsp;<i class="fa fa-pencil " title="Modifier les notes"></i></a>';angular.element(document.getElementById("edit-notes"+col+"-"+row)).remove(),angular.element(".hot-devoir-"+col+"-"+row).append($compile(htmlEditNotes)($scope)),vm["editNotes"+col+"_"+row]=function(){vm.coordNotesModifEnCours.push(col+"-"+row),vm.columns[col].readOnly=!1,$rootScope.navigationDisabled=!0;var activeEditor=vm.handsTableInstance.getActiveEditor();vm.handsTableInstance.selectCell(2,col),activeEditor.beginEditing()}}function renderModifierTousLesDevoirs(){if($scope.noteCtrl.periode.etat===CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE){var htmlEditDevoir='<a ng-click="sNotesCtrl.setAllDevoirsToEditable()" class="open-all-devoirs"><i class="fa fa-pencil all-eval" title="Modifier toutes les évaluations">&nbsp;</i></a>\n';angular.element(".open-all-devoirs").remove(),angular.element(".open-all-devoirs-container").append($compile(htmlEditDevoir)($scope))}}function renderActionCells(instance,td,row,col,prop,value,cellProperties){var data=instance.getData();if(!angular.isUndefined(data)&&!angular.isUndefined(vm.columns)){if(0===col)return td.innerHTML='<div class="open-all-devoirs-container"></div>',void renderModifierTousLesDevoirs();var devoir=vm.columns[col];td.innerHTML='<div class="hot-devoir-'+col+"-"+row+' devoir-sauvegarde"></div>',cellProperties.readOnly=!0,angular.isUndefined($scope.noteCtrl.periode)||(!angular.isUndefined(devoir.idProf)&&devoir.idProf!==Auth.idUser()||devoir.statutPeriode!==CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE?angular.isDefined(devoir.idProf)&&devoir.idProf!==Auth.idUser()&&(td.innerHTML='<div class="hot-devoir-'+col+"-"+row+' devoir-sauvegarde"><a style="cursor:pointer" title="Ce devoir a été saisi par : '+devoir.nomProf+'"><i class=" glyphicon glyphicon-info-sign"></i></a></div>'):(renderEditDevoirBtn(col,row),devoir.avecNote&&renderEditNotesBtn(col,row)))}}function renderNote(instance,td,row,col,prop,value,cellProperties){Handsontable.renderers.TextRenderer.apply(this,arguments);var data=instance.getData();if(!angular.isUndefined(data)&&!angular.isUndefined(vm.columns)){if(0===col)return"";var dataAtRow=data[row];if(angular.isUndefined(dataAtRow)||angular.isUndefined(dataAtRow.devoirs))return"";var devoir=vm.columns[col],eleveNote=dataAtRow.devoirs[devoir.id],isGoodNote=!1;value=value?value:"",value.match(/\(.*\)/)&&(eleveNote.nonSignificatif=!0,angular.isDefined(eleveNote.note)&&(eleveNote.note=eleveNote.note.replace("(",""),eleveNote.note=eleveNote.note.replace(")","")),angular.isDefined(eleveNote.lettre)&&(eleveNote.lettre=eleveNote.lettre.replace("(",""),eleveNote.lettre=eleveNote.lettre.replace(")","")),value=value.replace("(",""),value=value.replace(")","")),devoir.notationLettre?(angular.isDefined(value)&&1===value.length&&(value=value.toUpperCase(),angular.isDefined(eleveNote.lettre)&&(eleveNote.lettre=eleveNote.lettre.toUpperCase())),isGoodNote=SaisieNotesService.noteLettreValidatorSync(value,vm.notesLettres)):(value=value.replace(",","."),isGoodNote=SaisieNotesService.noteNumericValidatorSync(value,devoir),isGoodNote&&value.length>0&&!lodash.contains(["abs","disp"],value)&&(value=Number(value).toFixed(2)));var className=isGoodNote?"":"ed-note-incorrecte";eleveNote&&("__DELETE__"===value&&(eleveNote.lettre="",eleveNote.note=""),(""!==eleveNote.note&&!devoir.notationLettre||""!==eleveNote.lettre&&devoir.notationLettre)&&(0===eleveNote.noteSur&&(eleveNote.noteSur=devoir.noteSur,eleveNote.nonSignificatif=devoir.nonSignificatif),0===eleveNote.coef&&(eleveNote.coef=devoir.coef)),angular.isDefined(eleveNote.note)&&(eleveNote.note=eleveNote.note.replace(",","."),value=value.replace(",",".")),eleveNote.isGoodNote=isGoodNote,eleveNote.nonSignificatif&&(value="("+value+")",className+=" ed-note-non-significatif"),angular.isDefined(eleveNote)&&angular.isDefined(eleveNote.lettre)&&(eleveNote.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&""===eleveNote.note||(eleveNote.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)?(value=CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS,className="ed-note-abs"):angular.isDefined(eleveNote)&&angular.isDefined(eleveNote.lettre)&&(eleveNote.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP&&""===eleveNote.note||(eleveNote.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)?(value=CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP,className="ed-note-disp"):angular.isDefined(eleveNote)&&!eleveNote.notationLettre&&""!==eleveNote.lettre&&(eleveNote.lettre=""));var isPersonnalise=!1;angular.isDefined(eleveNote)&&devoir.coef!==eleveNote.coef&&eleveNote.idNote>0&&(isPersonnalise=!0);var tdClassName="td-"+className;devoir.readOnly?td.className=tdClassName:td.className=tdClassName+" writable",isPersonnalise&&(td.className+=" personnalisee"),td.innerHTML='<span class="'+className+'">'+value+"</span>"}}function buildContextMenu(){if(!angular.isUndefined($scope.noteCtrl.periode)){var items={};$scope.noteCtrl.periode.etat!==CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE||(items.editNote={name:'<i class="fa fa-magic">&nbsp;Modifier la note</i>',disabled:function(){var selected=vm.handsTableInstance.getSelected(),isDisabled=0===selected[1]||selected[0]<=1,devoir=vm.columns[selected[1]];return(devoir.readOnly||devoir.statutPeriode!==CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE)&&(isDisabled=!0),isDisabled}});var callback=function(key,options){var devoir=vm.columns[options.start.col],callbacks={editNote:function(){var eleve=vm.data[options.start.row];vm.openNote(eleve,devoir)}};key in callbacks&&callbacks[key]()};lodash.isEmpty(items)?vm.settings.contextMenu=!1:vm.settings.contextMenu={callback:callback,items:items},angular.isDefined(vm.handsTableInstance)&&vm.handsTableInstance.updateSettings(vm.settings)}}var vm=this;vm.saveAll=saveAll,vm.ajouterDevoir=ajouterDevoir,vm.openDevoir=openDevoir,vm.openNote=openNote,vm.openEleve=openEleve,vm.setAllDevoirsToEditable=setAllDevoirsToEditable,vm.isInEditMode=isInEditMode,vm.openPrintModal=openPrintModal,vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.cancel=_cancel,vm.getLibelleConseil=getLibelleConseil,vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.coordNotesModifEnCours=[],vm.isModifEnCoursNoteGlobal=!1;var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,vm.seulPPVoieVieScolaire="1"===paramNotes.params.seulPPVoieVieScolaire,vm.settings={},vm.settings.stretchH="none",vm.settings.width=function(){var maincontainer=angular.element(".ed-container.saisie-notes")[0],width=parseFloat(maincontainer.offsetWidth),widthBtn=120;return width-widthBtn},vm.settings.height=function(){return angular.isDefined(vm.data)?120+22*vm.data.length:void 0},vm.settings.autoRowSize=!1,vm.settings.autoColumnSize=!1,vm.settings.autoWrapRow=!0,vm.settings.autoWrapCol=!0,vm.settings.currentColClassName="ed-current-col",vm.settings.currentRowClassName="ed-current-row",vm.settings.colWidths=70,vm.settings.tableClassName=["table-notes"],vm.settings.editor=Handsontable.editors.NoteEditor,vm.settings.allowInsertRow=!1,vm.settings.fillHandle=!1,vm.settings.allowInvalid=!1,vm.settings.fixedColumnsLeft=1,vm.settings.colHeaders=function(col){var html='<div class="ed-hot-header |classEtatPeriode| |ERREUR|" title="|contentComplet|">\n  <span>|content|</span>\n  <br/><span>|date|</span>\n<br/><span>|info|</span>\n</div>',resultat="&nbsp;";if(0===col)return"&nbsp;Moyenne <br/>des élèves <br/>&nbsp;";if(angular.isDefined(vm.columns)&&col<vm.columns.length){var devoir=vm.columns[col],ilYAErreur=!1;if(angular.isDefined($scope.noteCtrl.classe)){var paramEtab=lodash.find(SaisieNotesService.etabsParams,{id:$scope.noteCtrl.classe.etabId});angular.isDefined(devoir.typeDevoir)&&paramEtab.isTypeDevoirObligatoire&&angular.isUndefined(lodash.find(paramEtab.typesDevoirs,{id:devoir.typeDevoir.id}))&&(ilYAErreur=!0)}var contentComplet=devoir.libelle;ilYAErreur&&(contentComplet+=". Erreur, type de devoir invalide. Merci de modifier"),resultat=html.replace("|contentComplet|",contentComplet),resultat=resultat.replace("|content|",$filter("truncate")(devoir.libelle,!1,8));var lDate=moment(devoir.date).format("DD/MM/YY");resultat=resultat.replace("|date|",lDate),resultat=devoir.avecNote===!0?devoir.notationLettre?resultat.replace("|info|","coef "+devoir.coef+" - /A"):resultat.replace("|info|","coef "+devoir.coef+" - /"+devoir.noteSur):resultat.replace("|info|","non noté"),resultat=ilYAErreur?resultat.replace("|ERREUR|","ed-hot-header-periode-erreur"):resultat.replace("|ERREUR|",""),resultat=resultat.replace("|classEtatPeriode|","ed-hot-header-periode-"+devoir.statutPeriode)}return resultat},vm.settings.rowHeaders=function(row){if(0===row)return angular.isDefined(vm.data)?""+(vm.data.length-2)+" élèves":"";if(1===row)return"C"===$scope.noteCtrl.classe.type?"Moyenne de la classe":"Moyenne du groupe";if(angular.isUndefined(vm.data)||angular.isUndefined(vm.data[row])||angular.isUndefined(vm.data[row].eleve))return"&nbsp;";var eleve=vm.data[row].eleve,htmlOpenEleve="",eleveLibelle="",titleLinkEleve="",eleveLibelleTruncate="",loupeHTML='<i class="fa fa-search hidden-print"></i>&nbsp;';return vm.seulPPVoieToutesLesNotes&&!$scope.noteCtrl.classe.isPP&&(loupeHTML=""),"C"===$scope.noteCtrl.classe.type?(eleveLibelle=eleve.particule+" "+eleve.nom+" "+eleve.prenom,eleveLibelleTruncate=$filter("truncate")(eleveLibelle,!1,24),titleLinkEleve=eleveLibelle+" "+eleve.codeClasse,htmlOpenEleve='<a class="open-eleve cliquable" id="open-eleve-'+eleve.id+'" title="'+titleLinkEleve+'" onClick="openEleveOutsideController('+eleve.id+')">'+loupeHTML+eleveLibelleTruncate+"</a>"):(eleveLibelle=eleve.particule+" "+eleve.nom+" "+eleve.prenom,eleveLibelleTruncate=$filter("truncate")(eleveLibelle,!1,15),eleveLibelleTruncate+=" ("+$filter("truncate")(eleve.codeClasse,!1,4,".")+") ",titleLinkEleve=eleveLibelle+" "+eleve.codeClasse,htmlOpenEleve='<a class="open-eleve cliquable" id="open-eleve-'+eleve.id+'" title="'+titleLinkEleve+'" onClick="openEleveOutsideController('+eleve.id+')">'+loupeHTML+eleveLibelleTruncate+"</a>"),vm["openEleve_"+eleve.id]=function(){vm.openEleve(eleve)},htmlOpenEleve},vm.settings.cells=function(row,col,prop){var cellProperties={};return vm.handsTableInstance?(row>1&&col>0&&(cellProperties.renderer=renderNote),angular.isUndefined(vm.data)||angular.isUndefined(vm.columns)?void 0:(1===row&&(cellProperties.readOnly=!0,0===col&&(cellProperties.renderer=SaisieNotesService.calculMoyenneClasse),col>0&&(cellProperties.renderer=SaisieNotesService.calculMoyenneDevoir)),0===col&&(cellProperties.readOnly=!0),col>0&&row>1&&vm.columns.length>col&&(cellProperties.notationLettre=vm.columns[col].notationLettre),
0===row&&(cellProperties.renderer=renderActionCells),cellProperties)):cellProperties},vm.settings.afterInit=function(){vm.handsTableInstance=this,vm.handsTableInstance.render()},vm.settings.afterCreateRow=function(index,amount){},vm.settings.afterUpdateSettings=function(){},refresh(),UserService.getParametrages().then(function(data){vm.notesLettres=data.note.notesLettres,SaisieNotesService.setEtabsParam(data.note.etabsParams)}),$scope.$watch("noteCtrl.classe",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.code===oldVal.code||$scope.noteCtrl.periodeNotAvailable||refresh()},!1),$scope.$watch("noteCtrl.periode",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.codePeriode===oldVal.codePeriode||$scope.noteCtrl.periodeNotAvailable||refresh()},!1),$scope.$watch("noteCtrl.matiere",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.id===oldVal.id||refresh()},!1)}]),angular.module("edsiteApp.CarnetNotes").controller("ComposantesCtrl",["CarnetNotesService","ComposantesService","$localStorage","lodash","$uibModal","SaisieNotesService","$rootScope","$scope","Auth","Notification","CacheService","UserService",function(CarnetNotesService,ComposantesService,$localStorage,lodash,$uibModal,SaisieNotesService,$rootScope,$scope,Auth,Notification,CacheService,UserService){function onChangeMethodeCalculAideSaisie(){$localStorage.methodeCalculAideSaisie=vm.methodeCalculAideSaisie}function onChange(){$rootScope.navigationDisabled=!0,vm.allIsSaved=!1}function onChangeEnseignementsComp(){$rootScope.navigationDisabled=!0,vm.allEnseignementsCompIsSaved=!1}function onChangeLangueRegionale(){$rootScope.navigationDisabled=!0,vm.allLanguesRegionalesIsSaved=!1}function evalAll(valeur){$scope.$broadcast("evalAllComposantes",{newValeurEval:valeur});var somethingUpdated=!1;vm.modeConsultation||(lodash.forEach(vm.eleves,function(eleve){lodash.forEach(eleve.competences,function(evaluation){if(angular.isUndefined(vm.selectedComposante)||evaluation.codeComposante===vm.selectedComposante.code)if("D"===valeur){if("1.b"===evaluation.codeComposante){var composanteAssociate=lodash.find(vm.composantes,{code:evaluation.codeComposante});composanteAssociate.evaluable&&(somethingUpdated=!0,evaluation.valeur=valeur)}}else{var composanteAssociate=lodash.find(vm.composantes,{code:evaluation.codeComposante});composanteAssociate.evaluable&&(somethingUpdated=!0,evaluation.valeur=valeur)}})}),somethingUpdated&&($rootScope.navigationDisabled=!0,vm.allIsSaved=!1))}function evalAllLanguesRegionales(valeur,choixLangue){var somethingUpdated=!1;($scope.noteCtrl.classe.isPP||$scope.noteCtrl.isChefEtablissement)&&(angular.isUndefined(choixLangue)&&lodash.forEach(vm.eleves,function(eleve){"AUC"!==eleve.langueRegionale.code&&(somethingUpdated=!0,eleve.langueRegionale.positionnement=valeur)}),somethingUpdated&&onChangeLangueRegionale())}function openPrintModal(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/editions-Composantes.html",controller:"ComposanteEditionCtrl as composanteEditionCtrl",backdrop:!0,resolve:{options:function(){var options={};return options.title="Editions",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe.id,options.periode=$scope.noteCtrl.periode.codePeriode,options.entityType=$scope.noteCtrl.classe.type,options.isMobile=$scope.noteCtrl.Utils.isMobile(),options}}});modalInstance.result.then(function(data){})}function isPourcentageMatiere(){return"matiere"===vm.methodeCalculAideSaisie}function getEvaluationEleve(eleve,codeComposante){if(!angular.isUndefined(eleve)){var libelleComp="";if(angular.isDefined(vm.selectedComposante))libelleComp=vm.selectedComposante.libelle,codeComposante=vm.selectedComposante.code;else{var comp=lodash.find(vm.composantes,{code:codeComposante});angular.isDefined(comp)&&(libelleComp=comp.libelle)}var newEval,evaluation=lodash.find(eleve.competences,{codeComposante:codeComposante});return angular.isDefined(evaluation)?(newEval=angular.copy(evaluation),newEval.libelle=libelleComp,newEval.pourcentageEval1=vm.isPourcentageMatiere()?evaluation.pourcentagesParMatiere.pourcentageEval1:evaluation.pourcentageEval1,newEval.pourcentageEval2=vm.isPourcentageMatiere()?evaluation.pourcentagesParMatiere.pourcentageEval2:evaluation.pourcentageEval2,newEval.pourcentageEval3=vm.isPourcentageMatiere()?evaluation.pourcentagesParMatiere.pourcentageEval3:evaluation.pourcentageEval3,newEval.pourcentageEval4=vm.isPourcentageMatiere()?evaluation.pourcentagesParMatiere.pourcentageEval4:evaluation.pourcentageEval4):(newEval={codeComposante:codeComposante,valeur:"0",libelle:libelleComp},eleve.competences.push(newEval)),newEval}}function totalPoint(eleve){var nbPoint=0,totalPointEleve=0;if(angular.isUndefined(vm.selectedComposante)){if(lodash.forEach(eleve.competences,function(evaluation){nbPoint+=nbPoints(evaluation),"0"!==evaluation.valeur&&"D"!==evaluation.valeur&&(totalPointEleve+=50)}),0===nbPoint)return""}else{var evaluation=lodash.find(eleve.competences,{codeComposante:vm.selectedComposante.code});nbPoint=nbPoints(evaluation),totalPointEleve=50}return""+nbPoint+"/"+totalPointEleve}function nbPoints(evaluation){return"0"===evaluation.valeur||"D"===evaluation.valeur?0:"1"===evaluation.valeur?10:"2"===evaluation.valeur?25:"3"===evaluation.valeur?40:"4"===evaluation.valeur?50:void 0}function openDetailsEleve(eleve){$uibModal.open({templateUrl:"../details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0}}})}function setTriByClasse(){vm.sortByClasse=!0,vm.eleves=sortEleves(vm.eleves)}function setTriAlpha(){vm.sortByClasse=!1,vm.eleves=sortEleves(vm.eleves)}function sortEleves(eleves){return vm.sortByClasse?lodash.chain(eleves).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.prenom).toUpperCase()}).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.nom).toUpperCase()}).sortBy(function(eleve){return eleve.ordreArrivee}).sortBy(function(eleve){return eleve.codeClasse}).value():lodash.chain(eleves).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.prenom).toUpperCase()}).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.nom).toUpperCase()}).sortBy(function(eleve){return eleve.ordreArrivee}).value()}function clearComposanteFilter(){vm.statusDropdown.isComposanteOpen=!1,vm.selectedComposante=void 0,vm.updateNumberOfComposanteToDisplay(),$scope.$broadcast("selectFilterComposante",{composante:vm.selectedComposante,numberOfCompToDisplay:vm.numberOfCompToDisplay})}function setComposanteFilter(comp){vm.statusDropdown.isComposanteOpen=!1,vm.selectedComposante=comp,vm.updateNumberOfComposanteToDisplay(),$scope.$broadcast("selectFilterComposante",{composante:comp,numberOfCompToDisplay:vm.numberOfCompToDisplay})}function setLangueRegionaleFilter(langueReg){vm.statusDropdown.isLangueRegionaleOpen=!1,vm.filterLangueRegionale=langueReg,($scope.noteCtrl.classe.isPP||$scope.noteCtrl.isChefEtablissement)&&(angular.forEach(vm.eleves,function(eleve){eleve.langueRegionale=angular.extend({},eleve.langueRegionale,langueReg),"AUC"!==langueReg.code?eleve.langueRegionale.positionnement=1:eleve.langueRegionale.positionnement=0}),vm.langueRegForAllSelected=langueReg,onChangeLangueRegionale())}function setEnseignementFacultFilter(enseignementFacult){vm.statusDropdown.isEnseignementFacultOpen=!1,vm.filterEnseignementFacult=enseignementFacult,($scope.noteCtrl.classe.isPP||$scope.noteCtrl.isChefEtablissement)&&(angular.forEach(vm.eleves,function(eleve){eleve.enseignementDeComplement=angular.extend({},eleve.enseignementDeComplement,enseignementFacult),"AUC"!==enseignementFacult.code?eleve.enseignementDeComplement.positionnement=1:eleve.enseignementDeComplement.positionnement=0}),vm.enseignementFacultForAllSelected=enseignementFacult,onChangeEnseignementsComp())}function updateNumberOfComposanteToDisplay(){angular.isDefined(vm.selectedComposante)?vm.numberOfCompToDisplay=1:vm.numberOfCompToDisplay=vm.composantes.length}function saveAll(){vm.promiseLoading=ComposantesService.save(Auth.role(),Auth.idUser(),$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,vm.eleves).then(function(){Notification.notify("Enregistrement des compétences","Les compétences ont bien été enregistrées !","success","icon-ed_note"),vm.aideSaisie=!1},function(error){Notification.notify("Enregistrement des compétences","Une erreur est survenue lors de l'enregistrement","error","icon-ed_note")}),$rootScope.navigationDisabled=!1,vm.allIsSaved=!0,vm.allEnseignementsCompIsSaved=!0,vm.allLanguesRegionalesIsSaved=!0}function cancelSaisie(){vm.allIsSaved=!0,CacheService.removeMatch(/.*\/composantes/),refresh(),$rootScope.navigationDisabled=!1}function cancelSaisieEnseignementsComp(){vm.allEnseignementsCompIsSaved=!0,CacheService.removeMatch(/.*\/composantes/),refresh(),$rootScope.navigationDisabled=!1,vm.filterEnseignementFacult=void 0}function cancelSaisieLanguesRegionales(){vm.allLanguesRegionalesIsSaved=!0,CacheService.removeMatch(/.*\/composantes/),refresh(),$rootScope.navigationDisabled=!1,vm.filterLangueRegionale=void 0}function isPourcentageMax(eleve,composanteActu,indexEvaluation,codeMatiere){var currentComposante="";if(angular.isDefined(vm.selectedComposante))currentComposante=vm.selectedComposante;else{var compFound=lodash.find(vm.composantes,{code:composanteActu.code});angular.isDefined(compFound)&&(currentComposante=compFound)}var evaluationComposante=lodash.find(eleve.competences,{codeComposante:currentComposante.code}),isMax=ComposantesService.isPourcentageMax(evaluationComposante,indexEvaluation,codeMatiere,vm.isPourcentageMatiere());return isMax&&(evaluationComposante.valeurConseillee=indexEvaluation),isMax}function getPourcentageMoyen(eleve,composanteActu,codeMatiere,offset){offset=angular.isUndefined(offset)?0:offset;var currentComposante="";if(angular.isDefined(vm.selectedComposante))currentComposante=vm.selectedComposante;else{var compFound=lodash.find(vm.composantes,{code:composanteActu.code});angular.isDefined(compFound)&&(currentComposante=compFound)}var evaluationComposante=lodash.find(eleve.competences,{codeComposante:currentComposante.code}),moy=ComposantesService.calculMoyenneComposante(evaluationComposante,codeMatiere,vm.isPourcentageMatiere());return"calc("+moy+"% - "+offset+"px)"}function valideAideSaisie(){angular.forEach(vm.eleves,function(eleve){angular.forEach(eleve.competences,function(competence){if(!angular.isDefined(vm.selectedComposante)||vm.selectedComposante.code===competence.codeComposante){var composanteAssociate=lodash.find(vm.composantes,{code:competence.codeComposante});composanteAssociate.evaluable&&(angular.isUndefined(competence.valeurConseillee)?competence.valeur="0":competence.valeur=competence.valeurConseillee,$scope.$broadcast("aideSaisieComposante",{newValeurEval:competence.valeur}))}})}),vm.onChange()}function recupValeursComposantesAnneePrecedente(){lodash.chain(vm.eleves).pluck("competences").flatten().where({valeur:"0"}).forEach(function(competence){competence.valeur=competence.historiqueValeurs[0].valeur}).value()}function refresh(){angular.isUndefined($scope.noteCtrl.periode)||angular.isUndefined($scope.noteCtrl.classe)||(vm.promiseLoading=ComposantesService.get(Auth.role(),Auth.idUser(),$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode).then(function(data){if(vm.anneesScolairesPrecedentes=data.anneesScolairesPrecedentes,vm.anneesScolairesPrecedentes.length>0){var tabSplit=vm.anneesScolairesPrecedentes[0].split("-");vm.anneeScolaireEnCours=+tabSplit[0]+1+"-"+(+tabSplit[1]+1)}vm.eleves=data.eleves,setTriAlpha(vm.eleves),vm.composantes=data.composantes,vm.cycle=data.cycle,vm.tabEnseignementsComplements=data.enseignementsDeComplements,vm.tabLanguesRegionales=data.languesRegionales,vm.isCycleQuatre=vm.cycle.search("4")>-1,vm.isAccordeonComposanteOpen=!(vm.isCycleQuatre&&(vm.tabEnseignementsComplements.length>0||vm.tabLanguesRegionales.length>0))||4===$scope.noteCtrl.periode.codePeriode.length;var isSomeComposanteEvaluable=lodash.find(vm.composantes,{evaluable:!0});vm.modeConsultation=angular.isUndefined(isSomeComposanteEvaluable),clearComposanteFilter();var periodes=lodash.filter($scope.noteCtrl.classe.periodes,function(p){return 4===p.codePeriode.length});lodash.remove(periodes,function(periode){return periode.codePeriode.substring(0,4)>=$scope.noteCtrl.periode.codePeriode.substring(0,4)}),vm.trimestresPrecedents=periodes}),vm.aideSaisie=!1)}var vm=this;vm.Math=window.Math,vm.idUser=Auth.currentUser().id,vm.CONSTANTES=CarnetNotesService.CONSTANTES,vm.anneesScolairesPrecedentes=[],vm.trimestresPrecedents=[],vm.anneeScolaireEnCours="",vm.composantes=[],vm.eleves=[],vm.cycle="",vm.allIsSaved=!0,vm.allEnseignementsCompIsSaved=!0,vm.allLanguesRegionalesIsSaved=!0,vm.libelleDefault="Toutes les composantes",vm.isAccordeonComposanteOpen=!1,vm.aideSaisie=!1,vm.methodeCalculAideSaisie=angular.isDefined($localStorage.methodeCalculAideSaisie)?$localStorage.methodeCalculAideSaisie:"eval",vm.filterLangueRegionale=void 0,vm.filterEnseignementFacult=void 0,vm.libelleLangueRegionaleFilterDefault="Aucun",vm.EnseignementFacultFilterDefault="Aucun",vm.statusDropdown={isComposanteOpen:!1},angular.isUndefined($scope.noteCtrl.classe)&&angular.isDefined($scope.noteCtrl.classePP)&&($scope.noteCtrl.classe=$scope.noteCtrl.classePP),angular.isUndefined($scope.noteCtrl.periode)&&angular.isDefined($scope.noteCtrl.periodePP)&&($scope.noteCtrl.periode=$scope.noteCtrl.periodePP),vm.openDetailsEleve=openDetailsEleve,vm.evalAll=evalAll,vm.evalAllLanguesRegionales=evalAllLanguesRegionales,vm.clearComposanteFilter=clearComposanteFilter,vm.setComposanteFilter=setComposanteFilter,vm.setLangueRegionaleFilter=setLangueRegionaleFilter,vm.setEnseignementFacultFilter=setEnseignementFacultFilter,vm.updateNumberOfComposanteToDisplay=updateNumberOfComposanteToDisplay,vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.nbPoints=nbPoints,vm.getEvaluationEleve=getEvaluationEleve,vm.totalPoint=totalPoint,vm.onChange=onChange,vm.onChangeEnseignementsComp=onChangeEnseignementsComp,vm.onChangeLangueRegionale=onChangeLangueRegionale,vm.saveAll=saveAll,vm.cancelSaisie=cancelSaisie,vm.cancelSaisieEnseignementsComp=cancelSaisieEnseignementsComp,vm.cancelSaisieLanguesRegionales=cancelSaisieLanguesRegionales,vm.isPourcentageMax=isPourcentageMax,vm.getPourcentageMoyen=getPourcentageMoyen,vm.valideAideSaisie=valideAideSaisie,vm.openPrintModal=openPrintModal,vm.recupValeursComposantesAnneePrecedente=recupValeursComposantesAnneePrecedente,vm.isPourcentageMatiere=isPourcentageMatiere,vm.onChangeMethodeCalculAideSaisie=onChangeMethodeCalculAideSaisie,vm.lodash=lodash,refresh(),$scope.$watch("noteCtrl.classe",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.code===oldVal.code||$scope.noteCtrl.periodeNotAvailable||refresh()},!1),$scope.$watch("noteCtrl.periode",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.codePeriode===oldVal.codePeriode||refresh()})}]),angular.module("edsiteApp.CarnetNotes").directive("ligneEvalComposante",function(){return{restrict:"A",scope:{index:"=",isLast:"=",selectedComposante:"=",noteCtrl:"=",composanteCtrl:"="},controller:"ligneComposanteDirective",controllerAs:"cCtrl",templateUrl:"modules/notes/enseignant/LSUN/composante-ligne-template.html",link:function(scope,element,attrs){}}}).controller("ligneComposanteDirective",["$rootScope","$scope","$uibModal","lodash",function($rootScope,$scope,$uibModal,lodash){function openDetailsEleve(eleve){$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function openModaleDetailsComposante(currentComposante,eleve,periode,anneeScolaire){var tabPeriodes=lodash.filter($scope.noteCtrl.periodes,function(p){return"A999Z"===p.codePeriode||4===p.codePeriode.length||4===p.codePeriode.indexOf("X")});"string"==typeof periode&&""!==periode&&(periode=lodash.find(tabPeriodes,function(p){return p.codePeriode===periode}));$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/details-composante-eleve.html",controller:"DetailsComposanteEleveCtrl as ctrlDetailsComposanteEleve",size:"lg",resolve:{composante:function(){return currentComposante},eleve:function(){return eleve},classe:function(){return $scope.noteCtrl.classe},periode:function(){return periode},tabPeriodes:function(){return tabPeriodes},anneeScolaire:function(){return angular.isDefined(anneeScolaire)?anneeScolaire:""}}})}function getValeurAnnneScolairePrecedente(anneeScolaire){var historique=lodash.find(vm.evaluationEleve.historiqueValeurs,function(historique){return historique.anneeScolaire===anneeScolaire});return angular.isDefined(historique)?historique.valeur:0}function getValeurTrimestrePrecedent(trimestre){var historique=lodash.find(vm.evaluationEleve.historiqueTrimestresValeurs,function(historique){return historique.trimestre===trimestre.codePeriode});return angular.isDefined(historique)?historique.valeur:0}function setEvalEleve(eleve,valeurEval){if(!angular.isUndefined(eleve)){var evaluation=lodash.find(eleve.competences,{codeComposante:$scope.currentComposante.code});evaluation.valeur=valeurEval,vm.evaluationEleve=$scope.composanteCtrl.getEvaluationEleve($scope.eleve,$scope.currentComposante.code),$scope.composanteCtrl.onChange()}}var vm=this;vm.Math=window.Math,vm.openDetailsEleve=openDetailsEleve,vm.openModaleDetailsComposante=openModaleDetailsComposante,vm.getValeurAnnneScolairePrecedente=getValeurAnnneScolairePrecedente,vm.getValeurTrimestrePrecedent=getValeurTrimestrePrecedent,vm.setEvalEleve=setEvalEleve,$scope.currentComposante=$scope.composanteCtrl.composantes[$scope.index%$scope.composanteCtrl.numberOfCompToDisplay],$scope.eleve=$scope.composanteCtrl.eleves[vm.Math.floor($scope.index/$scope.composanteCtrl.numberOfCompToDisplay)],$scope.nbOfCompToDisplay=$scope.composanteCtrl.numberOfCompToDisplay,vm.evaluationEleve=$scope.composanteCtrl.getEvaluationEleve($scope.eleve,$scope.currentComposante.code),$scope.$on("evalAllComposantes",function(event,args){vm.setEvalEleve($scope.eleve,args.newValeurEval)}),$scope.$on("selectFilterComposante",function(event,args){$scope.currentComposante=$scope.composanteCtrl.composantes[$scope.index%args.numberOfCompToDisplay],1===args.numberOfCompToDisplay&&($scope.currentComposante=args.composante),$scope.eleve=$scope.composanteCtrl.eleves[vm.Math.floor($scope.index/args.numberOfCompToDisplay)],$scope.nbOfCompToDisplay=args.numberOfCompToDisplay,vm.evaluationEleve=$scope.composanteCtrl.getEvaluationEleve($scope.eleve,$scope.currentComposante.code)}),$scope.$on("aideSaisieComposante",function(event,args){vm.evaluationEleve=$scope.composanteCtrl.getEvaluationEleve($scope.eleve,$scope.currentComposante.code)})}]),angular.module("edsiteApp.CarnetNotes").controller("LSUNEditionCtrl",["$scope","$uibModalInstance","$filter","lodash","moment","base64encodeFilter","CarnetNotesService","periode","options","constantesNotes","devoirs","eleves",function($scope,$uibModalInstance,$filter,lodash,moment,base64encodeFilter,CarnetNotesService,periode,options,constantesNotes,devoirs,eleves){function calculerPourcentagesEvaluation(elemProg,idDevoir){var nbEval0=0,nbEval1=0,nbEval2=0,nbEval3=0,nbEval4=0,nbEleves=vm.eleves.length;angular.forEach(vm.eleves,function(eleve){var eleveDevoir=eleve.devoirs[idDevoir];if(angular.isUndefined(eleveDevoir))return void nbEval0++;var elemProgActu=lodash.find(eleveDevoir.elementsProgramme,{id:elemProg.id});return angular.isUndefined(elemProgActu)?void nbEval0++:angular.isUndefined(elemProgActu.evaluation)?void nbEval0++:("0"===elemProgActu.evaluation&&nbEval0++,"1"===elemProgActu.evaluation&&nbEval1++,"2"===elemProgActu.evaluation&&nbEval2++,"3"===elemProgActu.evaluation&&nbEval3++,void("4"===elemProgActu.evaluation&&nbEval4++))});var elemProgDevoirActu={};return nbEleves!==nbEval0?(elemProgDevoirActu.pourcentageEvaluation0=0,elemProgDevoirActu.pourcentageEvaluation1=(nbEval1/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation2=(nbEval2/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation3=(nbEval3/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation4=(nbEval4/(nbEleves-nbEval0)*100).toFixed(1)):(elemProgDevoirActu.pourcentageEvaluation0=0,elemProgDevoirActu.pourcentageEvaluation1=0,elemProgDevoirActu.pourcentageEvaluation2=0,elemProgDevoirActu.pourcentageEvaluation3=0,elemProgDevoirActu.pourcentageEvaluation4=0),elemProgDevoirActu}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function renderNoteEleve(devoirEleve){var noteEleve="";return angular.isUndefined(devoirEleve)?"":(devoirEleve.notationLettre||angular.isDefined(devoirEleve.note)&&(noteEleve=devoirEleve.note.replace(",","."),isNumeric(noteEleve)&&(noteEleve=Number(noteEleve).toFixed(2))),devoirEleve.notationLettre&&angular.isDefined(devoirEleve.lettre)&&(noteEleve=devoirEleve.lettre.toUpperCase()),devoirEleve.nonSignificatif&&(noteEleve="("+noteEleve+")"),angular.isDefined(devoirEleve.lettre)&&(devoirEleve.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&""===devoirEleve.note||(devoirEleve.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)?noteEleve=CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS:angular.isDefined(devoirEleve.lettre)&&(devoirEleve.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP&&""===devoirEleve.note||(devoirEleve.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)&&(noteEleve=CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP),noteEleve)}function printCompetences(){var params={};params.nbreEleves=eleves.length,params.entityLibelle=angular.isDefined(vm.classe.classeLibelle)?vm.classe.classeLibelle:vm.classe.libelle,params.periodeLibelle=vm.periode.libelle,params.matiereLibelle=vm.options.matiere.libelle,params.couleurs=vm.options.couleurs,params.editionNoirEtBlanc=vm.additionalData.editionNoirEtBlanc;var tabDevoirs=lodash.map(vm.devoirs,function(devoir){var leDevoir={};return leDevoir.libelle=devoir.libelle,leDevoir.edite="Edité le "+moment().format("DD/MM/YYYY à HH:mm"),leDevoir.date="",devoir.date&&(leDevoir.date=moment(devoir.date).format("DD/MM/YYYY")),leDevoir.avecNote=devoir.avecNote?1:0,leDevoir.elementsProgramme=[],leDevoir.eleves=[],angular.forEach(devoir.elementsProgramme,function(elem){var unElement={};unElement.libelle=elem.libelle;var pourcentages=calculerPourcentagesEvaluation(elem,devoir.id);unElement.pourcentageEvaluation0=pourcentages.pourcentageEvaluation0+"%",unElement.pourcentageEvaluation1=pourcentages.pourcentageEvaluation1+"%",unElement.pourcentageEvaluation2=pourcentages.pourcentageEvaluation2+"%",unElement.pourcentageEvaluation3=pourcentages.pourcentageEvaluation3+"%",unElement.pourcentageEvaluation4=pourcentages.pourcentageEvaluation4+"%",leDevoir.elementsProgramme.push(unElement)}),angular.forEach(vm.eleves,function(elev){var unEleve={};"C"===vm.options.entityType?unEleve.libelle=$filter("displayNom")(elev.eleve,!0,!1):unEleve.libelle=$filter("displayNom")(elev.eleve,!0,!1)+"("+elev.eleve.codeClasse+")",unEleve.libelle=unEleve.libelle.trim();var eleveDevoir=elev.devoirs[devoir.id];devoir.avecNote&&(unEleve.note=renderNoteEleve(eleveDevoir));var elemProg=[];angular.forEach(devoir.elementsProgramme,function(elem){var evaluation,unElement={};angular.isDefined(eleveDevoir)&&(evaluation=lodash.find(eleveDevoir.elementsProgramme,{id:elem.id})),angular.isUndefined(evaluation)&&(evaluation={id:elem.id,evaluation:"0"}),unElement.evaluation=evaluation.evaluation,elemProg.push(unElement)}),unEleve.elementsProgramme=elemProg,leDevoir.eleves.push(unEleve)}),leDevoir}),data={parametres:params,devoirs:tabDevoirs};return{data:base64encodeFilter(JSON.stringify(data))}}function setCodePeriode(codePeriodeCourant){vm.additionalData.codePeriode=codePeriodeCourant}function setCodeMatieresousMatiere(initialise){initialise?(vm.additionalData.codeMatiere=vm.options.matiere.code,vm.additionalData.codeSousMatiere=vm.options.matiere.codeSSMatiere,delete vm.additionalData.codePeriode):(delete vm.additionalData.codeMatiere,delete vm.additionalData.codeSousMatiere)}function close(){$uibModalInstance.dismiss()}var vm=this;vm.classe=options.classe,vm.typeEntity=vm.classe.type,vm.idEntity=vm.classe.id,vm.options=options,vm.periode=periode,vm.devoirs=devoirs,vm.eleves=eleves,vm.constantesNotes=constantesNotes,vm.additionalData={codePeriode:vm.periode.codePeriode},vm.calculerPourcentagesEvaluation=calculerPourcentagesEvaluation,vm.isNumeric=isNumeric,vm.renderNoteEleve=renderNoteEleve,vm.printCompetences=printCompetences,vm.setCodePeriode=setCodePeriode,vm.setCodeMatieresousMatiere=setCodeMatieresousMatiere,vm.close=close}]),angular.module("edsiteApp.CarnetNotes").controller("ComposanteEditionCtrl",["$scope","$uibModalInstance","$filter","lodash","moment","base64encodeFilter","CarnetNotesService","options",function($scope,$uibModalInstance,$filter,lodash,moment,base64encodeFilter,CarnetNotesService,options){function close(){$uibModalInstance.dismiss()}var vm=this;vm.classe=options.classe,vm.periode=options.periode,vm.entityType=options.entityType,vm.options=options,vm.close=close}]),angular.module("edsiteApp.CarnetNotes").factory("keyboardManagerCompetencesService",["$window","$timeout",function($window,$timeout){var keyboardManagerService={},defaultOpt={type:"keydown",propagate:!1,inputDisabled:!1,target:$window.document,keyCode:!1};return keyboardManagerService.keyboardEvent={},keyboardManagerService.bind=function(label,callback,opt){var fct,elt,code,k;opt=angular.extend({},defaultOpt,opt),label=label.toLowerCase(),elt=opt.target,"string"==typeof opt.target&&(elt=document.getElementById(opt.target)),fct=function(e){if(e=e||$window.event,opt.inputDisabled){var elt;if(e.target?elt=e.target:e.srcElement&&(elt=e.srcElement),3==elt.nodeType&&(elt=elt.parentNode),"INPUT"==elt.tagName||"TEXTAREA"==elt.tagName)return}e.keyCode?code=e.keyCode:e.which&&(code=e.which);var character=String.fromCharCode(code).toLowerCase();code>=96&&105>=code&&(96===code&&(character="0"),97===code&&(character="1"),98===code&&(character="2"),99===code&&(character="3"),100===code&&(character="4"),101===code&&(character="5"),102===code&&(character="6"),103===code&&(character="7"),104===code&&(character="8"),105===code&&(character="9")),188==code&&(character=","),190==code&&(character=".");for(var keys=label.split("+"),kp=0,shift_nums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},special_keys={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,0:96,1:97,2:98,3:99,4:100,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},modifiers={shift:{wanted:!1,pressed:e.shiftKey?!0:!1},ctrl:{wanted:!1,pressed:e.ctrlKey?!0:!1},alt:{wanted:!1,pressed:e.altKey?!0:!1},meta:{wanted:!1,pressed:e.metaKey?!0:!1}},i=0,l=keys.length;k=keys[i],l>i;i++){switch(k){case"ctrl":case"control":kp++,modifiers.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":kp++,modifiers[k].wanted=!0}k.length>1?special_keys[k]==code&&kp++:opt.keyCode?opt.keyCode==code&&kp++:character==k?kp++:shift_nums[character]&&e.shiftKey&&(character=shift_nums[character],character==k&&kp++)}return kp!=keys.length||modifiers.ctrl.pressed!=modifiers.ctrl.wanted||modifiers.shift.pressed!=modifiers.shift.wanted||modifiers.alt.pressed!=modifiers.alt.wanted||modifiers.meta.pressed!=modifiers.meta.wanted||($timeout(function(){callback(e)},1),opt.propagate)?void 0:(e.cancelBubble=!0,e.returnValue=!1,e.stopPropagation&&(e.stopPropagation(),e.preventDefault()),!1)},keyboardManagerService.keyboardEvent[label]={callback:fct,target:elt,event:opt.type},elt.addEventListener?elt.addEventListener(opt.type,fct,!1):elt.attachEvent?elt.attachEvent("on"+opt.type,fct):elt["on"+opt.type]=fct},keyboardManagerService.unbind=function(label){label=label.toLowerCase();var binding=keyboardManagerService.keyboardEvent[label];if(delete keyboardManagerService.keyboardEvent[label],binding){var type=binding.event,elt=binding.target,callback=binding.callback;elt.detachEvent?elt.detachEvent("on"+type,callback):elt.removeEventListener?elt.removeEventListener(type,callback,!1):elt["on"+type]=!1}},keyboardManagerService}]),angular.module("edsiteApp.CarnetNotes").controller("CompetencesCtrl",["CarnetNotesService","CompetencesService","lodash","$uibModal","$timeout","SaisieNotesService","$rootScope","$scope","Auth","$sessionStorage","UserService","ModuleService","Notification","$q","keyboardManagerCompetencesService",function(CarnetNotesService,CompetencesService,lodash,$uibModal,$timeout,SaisieNotesService,$rootScope,$scope,Auth,$sessionStorage,UserService,ModuleService,Notification,$q,keyboardManagerCompetencesService){function setTriByClasse(){vm.sortByClasse=!0,vm.tabEleves=sortEleves(vm.tabEleves)}function setTriAlpha(){vm.sortByClasse=!1,vm.tabEleves=sortEleves(vm.tabEleves)}function sortEleves(eleves){return vm.sortByClasse?lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).sortBy(function(eleveNote){return eleveNote.eleve.codeClasse}).value():lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).value()}function getLibelleConseil(periode){return CarnetNotesService.getLibelleConseil(periode)}function getPeriodesRelevees(periode){return angular.isUndefined(periode)?[]:lodash.filter($scope.noteCtrl.periodeOnlyReleves,function(p){return lodash.startsWith(p.codePeriode,periode.codePeriode+"R")})}function openPrintModal(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/editions-LSUN.html",controller:"LSUNEditionCtrl as lsunEditionCtrl",backdrop:!0,resolve:{options:function(){var options={};return options.title="Editions",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.entityType=vm.entity.type,options.isMobile=$scope.noteCtrl.Utils.isMobile(),options.couleurs={couleurEval1:vm.parametrages.couleurEval1,couleurEval2:vm.parametrages.couleurEval2,couleurEval3:vm.parametrages.couleurEval3,couleurEval4:vm.parametrages.couleurEval4,libelleEval1:vm.parametrages.libelleEval1,libelleEval2:vm.parametrages.libelleEval2,libelleEval3:vm.parametrages.libelleEval3,libelleEval4:vm.parametrages.libelleEval4},options},periode:function(){return $scope.noteCtrl.periode},constantesNotes:function(){return CarnetNotesService.CONSTANTES},devoirs:function(){return vm.tabDevoirs},eleves:function(){return vm.tabEleves}}});modalInstance.result.then(function(data){})}function ajouterDevoir(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/edit-devoir.html",
controller:"DevoirEditCtrl as editDevoirCtrl",backdrop:!1,resolve:{options:function(){var options={};return options.title="Création d'une évaluation",options.mode="create",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.isReadOnly=!0,options.yatilDesNotes=!1,options},datasLSU:function(){var data={};return data.devoir={},data.periode=$scope.noteCtrl.periode,data.periodesRelevees=getPeriodesRelevees($scope.noteCtrl.periode),data.constantesNotes=CarnetNotesService.CONSTANTES,data.notesDevoir={},data.devoirsProf=vm.tabDevoirs,data}}});modalInstance.result.then(function(devoir){if(lodash.has(devoir,"libelle")){devoir.codeMatiere=$scope.noteCtrl.matiere.code,devoir.codeSSMatiere=$scope.noteCtrl.matiere.codeSSMatiere;var tabElemsProg=[];lodash.forEach(devoir.elementsProgramme,function(elemProg){tabElemsProg.push({id:elemProg.id,evaluation:"0"})}),lodash.forEach(vm.tabEleves,function(eleve){eleve.devoirs[devoir.id]={idDevoir:devoir.id,codeMatiere:$scope.noteCtrl.matiere.code,codeSSMatiere:$scope.noteCtrl.matiere.codeSSMatiere,noteSur:devoir.noteSur,coef:devoir.coef,devoirLibelle:devoir.libelle,notationLettre:devoir.notationLettre,elementsProgramme:angular.copy(tabElemsProg)}}),vm.tabDevoirs.push(devoir),vm.setCurrentDevoir(devoir)}})}function createDevoirEleve(evaluation,elemProg){var newDevoir=lodash.cloneDeep(vm.selectedDevoir);return newDevoir.devoirLibelle=vm.selectedDevoir.libelle,newDevoir.idDevoir=vm.selectedDevoir.id,newDevoir.lettre="",newDevoir.note="",newDevoir.elementsProgramme=[],delete newDevoir.id,delete newDevoir.idLong,delete newDevoir.idProf,delete newDevoir.libelle,delete newDevoir.nomProf,delete newDevoir.noteNegative,delete newDevoir.statutPeriode,delete newDevoir.typeDevoir,angular.isDefined(evaluation)&&newDevoir.elementsProgramme.push({id:elemProg.id,evaluation:evaluation}),newDevoir}function setEvalEleve(eleveSelected,elemProg,evaluation){if($scope.noteCtrl.periode.etat!==$scope.noteCtrl.CONSTANTES.PERIODES.ETATS.OUVERTE||vm.selectedDevoir.idProf!==vm.idUser)return vm.saisieClavierCurrentEleve=void 0,void(vm.saisieClavierCurrentElemProg=void 0);if(vm.saisieClavierCurrentEleve=eleveSelected,vm.saisieClavierCurrentElemProg=elemProg,lodash.has(eleveSelected.devoirs,vm.selectedDevoir.id.toString())){var elemProgrammeFound=lodash.find(eleveSelected.devoirs[vm.selectedDevoir.id].elementsProgramme,{id:elemProg.id});elemProgrammeFound.evaluation=evaluation}else eleveSelected.devoirs[vm.selectedDevoir.id]=createDevoirEleve(evaluation,elemProg);calculerPourcentagesEvaluation(elemProg),$rootScope.navigationDisabled=!0,vm.allIsSaved=!1}function evalAll(valeur,elemProg){$scope.noteCtrl.periode.etat===$scope.noteCtrl.CONSTANTES.PERIODES.ETATS.OUVERTE&&($rootScope.navigationDisabled=!0,vm.allIsSaved=!1,lodash.forEach(vm.tabEleves,function(eleve){var devoirEleve=lodash.find(eleve.devoirs,{idDevoir:vm.selectedDevoir.id});if(angular.isDefined(devoirEleve)){var elemProgEleve=lodash.find(devoirEleve.elementsProgramme,{id:elemProg.id});angular.isDefined(elemProgEleve)&&(elemProgEleve.evaluation=valeur)}else eleve.devoirs[vm.selectedDevoir.id]=createDevoirEleve(valeur,elemProg);calculerPourcentagesEvaluation(elemProg)}))}function getEvaluationEleve(eleve,codeElemProg){if(!angular.isUndefined(eleve)){if(angular.isDefined(eleve.devoirs[vm.selectedDevoir.id]))var evaluation=lodash.find(eleve.devoirs[vm.selectedDevoir.id].elementsProgramme,{id:codeElemProg});if(angular.isDefined(evaluation))return evaluation;var newEval={id:codeElemProg,evaluation:"0"};return angular.isDefined(eleve.devoirs[vm.selectedDevoir.id])&&eleve.devoirs[vm.selectedDevoir.id].elementsProgramme.push(newEval),newEval}}function isEvaluationEleveNonEvaluee(eleve,codeElemProg){var evalEleveElemProg=getEvaluationEleve(eleve,codeElemProg);return vm.tabEvalEleveNonEvalue.indexOf(evalEleveElemProg.evaluation)>-1}function noteKeyPress(rang,event){vm.saisieClavierCurrentEleve=void 0,vm.saisieClavierCurrentElemProg=void 0;var newRang;38===event.keyCode&&(newRang=rang-1),(40===event.keyCode||13===event.keyCode)&&(newRang=rang+1);var newInput=angular.element("#eleve-note-rang-"+newRang);angular.isUndefined(newInput)||newInput.trigger("focus")}function checkInfosNote(eleveDevoir){((""!==eleveDevoir.note||""!==eleveDevoir.lettre)&&!vm.selectedDevoir.notationLettre||""!==eleveDevoir.lettre&&vm.selectedDevoir.notationLettre)&&(0===eleveDevoir.noteSur&&(eleveDevoir.noteSur=vm.selectedDevoir.noteSur,eleveDevoir.nonSignificatif=vm.selectedDevoir.nonSignificatif),0===eleveDevoir.coef&&(eleveDevoir.coef=vm.selectedDevoir.coef))}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function isNotePersonalisee(eleve){var devoirEleve=eleve.devoirs[vm.selectedDevoir.id];return angular.isUndefined(devoirEleve)||vm.selectedDevoir.coef!==devoirEleve.coef}function renderNoteEleve(eleve){var devoirEleve=eleve.devoirs[vm.selectedDevoir.id],noteEleve="";return angular.isUndefined(devoirEleve)?"":(devoirEleve.notationLettre||angular.isDefined(devoirEleve.note)&&(noteEleve=devoirEleve.note.replace(",","."),isNumeric(noteEleve)&&(noteEleve=Number(noteEleve).toFixed(2))),devoirEleve.notationLettre&&angular.isDefined(devoirEleve.lettre)&&(noteEleve=devoirEleve.lettre.toUpperCase()),devoirEleve.nonSignificatif&&(noteEleve="("+noteEleve+")"),angular.isDefined(devoirEleve.lettre)&&(devoirEleve.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&""===devoirEleve.note||(devoirEleve.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)?noteEleve=CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS:angular.isDefined(devoirEleve.lettre)&&(devoirEleve.lettre.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP&&""===devoirEleve.note||(devoirEleve.note+"").toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)&&(noteEleve=CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP),noteEleve)}function isNoteCorrecte(eleve){var eleveNote=eleve.devoirs[vm.selectedDevoir.id];return angular.isUndefined(eleveNote)||angular.isUndefined(eleveNote.isGoodNote)||eleveNote.isGoodNote}function noteChange(eleve){var eleveNote=vm.saisiesNote[eleve.eleve.id],eleveDevoir=eleve.devoirs[vm.selectedDevoir.id];if(""!==eleveNote||!angular.isUndefined(eleveDevoir)){if(""!==eleveNote&&angular.isUndefined(eleveDevoir)&&(eleve.devoirs[vm.selectedDevoir.id]=createDevoirEleve(),eleveDevoir=eleve.devoirs[vm.selectedDevoir.id]),vm.allIsSaved=!1,$rootScope.navigationDisabled=!0,angular.isUndefined(eleveNote)||""===eleveNote)return eleveDevoir.isGoodNote=!0,eleveDevoir.lettre="",void(eleveDevoir.note="");vm.selectedDevoir.nonSignificatif&&(eleveDevoir.nonSignificatif=!0,eleveNote.match(/\(.*\)/)||(eleveNote="("+eleveNote+")")),eleveNote.match(/\(.*\)/)||(eleveDevoir.nonSignificatif=!1);var weShouldResetEP=!1;if(vm.selectedDevoir.notationLettre||"a"!==eleveNote.toLowerCase()||(eleveNote=CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS,weShouldResetEP=!0),vm.selectedDevoir.notationLettre||"d"!==eleveNote.toLowerCase()||(eleveNote=CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP,weShouldResetEP=!0),weShouldResetEP&&angular.forEach(eleveDevoir.elementsProgramme,function(ep){eleveNote===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&(ep.evaluation="-1"),eleveNote===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP&&(ep.evaluation="-2")}),eleveNote.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)return eleveDevoir.lettre=CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS,eleveDevoir.note="",eleveDevoir.isGoodNote=!0,vm.saisiesNote[eleve.eleve.id]=eleveNote,vm.checkInfosNote(eleveDevoir),!0;if(eleveNote.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)return eleveDevoir.lettre=CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP,eleveDevoir.note="",eleveDevoir.isGoodNote=!0,vm.saisiesNote[eleve.eleve.id]=eleveNote,vm.checkInfosNote(eleveDevoir),!0;if(eleveNote.match(/\(.*\)/)){eleveDevoir.nonSignificatif=!0;var noteWithoutParenthese=eleveNote;noteWithoutParenthese=noteWithoutParenthese.replace("(",""),noteWithoutParenthese=noteWithoutParenthese.replace(")",""),eleveNote=noteWithoutParenthese,eleveDevoir.notationLettre?eleveDevoir.lettre=noteWithoutParenthese:eleveDevoir.note=noteWithoutParenthese}return vm.selectedDevoir.notationLettre?(eleveNote=eleveNote.toUpperCase(),eleveDevoir.lettre=eleveNote,eleveDevoir.note="",eleveDevoir.isGoodNote=SaisieNotesService.noteLettreValidatorSync(eleveNote,vm.notesLettres)):(eleveNote=eleveNote.replace(",","."),eleveDevoir.isGoodNote=SaisieNotesService.noteNumericValidatorSync(eleveNote,vm.selectedDevoir),eleveDevoir.isGoodNote&&eleveNote.length>0&&!lodash.contains(["abs","disp"],eleveNote)&&(eleveNote=Number(eleveNote).toFixed(2)),eleveDevoir.note=eleveNote,eleveDevoir.lettre=""),eleveDevoir.nonSignificatif&&!eleveNote.match(/\(.*\)/)&&(eleveNote="("+eleveNote+")"),vm.checkInfosNote(eleveDevoir),vm.saisiesNote[eleve.eleve.id]=eleveNote,!0}}function openDetailsEleve(eleve){vm.seulPPVoieToutesLesNotes||$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!1,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function updateInfosDevoirSelected(devoir){vm.selectedDevoir=devoir,vm.backupTabElemsProgCurrentDevoir=[],angular.forEach(vm.tabEleves,function(eleve){var devoirEleve=lodash.find(eleve.devoirs,{idDevoir:vm.selectedDevoir.id});angular.isUndefined(devoirEleve)?vm.backupTabElemsProgCurrentDevoir.push({idEleve:eleve.eleve.id,elementsProgramme:[]}):vm.backupTabElemsProgCurrentDevoir.push({idEleve:eleve.eleve.id,elementsProgramme:angular.copy(devoirEleve.elementsProgramme)})}),updateSaisiesNote(),angular.forEach(vm.selectedDevoir.elementsProgramme,function(EP){calculerPourcentagesEvaluation(EP)}),$sessionStorage[$scope.noteCtrl.classe.id+"_"+$scope.noteCtrl.periode.codePeriode+"_"+$scope.noteCtrl.matiere.code+"_"+$scope.noteCtrl.matiere.codeSSMatiere]=vm.selectedDevoir}function setCurrentDevoir(devoir){if(vm.saisieClavierCurrentEleve=void 0,vm.saisieClavierCurrentElemProg=void 0,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){angular.forEach(vm.tabEleves,function(eleve){var devoirEleve=lodash.find(eleve.devoirs,{idDevoir:vm.selectedDevoir.id}),elementsProgrammeBackuped=lodash.find(vm.backupTabElemsProgCurrentDevoir,{idEleve:eleve.eleve.id});devoirEleve.elementsProgramme=elementsProgrammeBackuped.elementsProgramme}),updateInfosDevoirSelected(devoir),vm.allIsSaved=!0},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}updateInfosDevoirSelected(devoir)}function updateSaisiesNote(){vm.saisiesNote=[],angular.forEach(vm.tabEleves,function(eleve){vm.saisiesNote[eleve.eleve.id]=vm.renderNoteEleve(eleve)})}function cancelSaisie(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/cancel-edit.html",backdrop:!1});modalInstance.result.then(function(result){"1"===result&&(vm.allIsSaved=!0,refresh(),$rootScope.navigationDisabled=!1)})}function poilDansLaMainEPVersNotes(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/evaluations-vers-notes.html",controller:"EvaluationsVersNotesCtrl as ctrlEvaluationsVersNotes",size:"lg",resolve:{elementsProgramme:function(){return vm.selectedDevoir.elementsProgramme},devoir:function(){return vm.selectedDevoir},paramsLSU:function(){return vm.parametrages},user:function(){return{id:vm.idUser,type:vm.typeUser}}}});modalInstance.result.then(function(data){var shouldReplaceNotes=data;vm.selectedDevoir.notationLettre||(angular.forEach(vm.tabEleves,function(eleve){var eleveDevoir=eleve.devoirs[vm.selectedDevoir.id];if(!angular.isUndefined(eleveDevoir)&&("undefined"==typeof eleveDevoir.note&&(eleveDevoir.note=""),(""===eleveDevoir.note||shouldReplaceNotes)&&eleveDevoir.lettre!==CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&eleveDevoir.lettre!==CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)){var noteEP=0,totalBareme=0;if(shouldReplaceNotes&&(eleveDevoir.note=""),angular.forEach(eleveDevoir.elementsProgramme,function(EP){if(!(parseInt(EP.evaluation)<=0)){var epDef=lodash.find(vm.selectedDevoir.elementsProgramme,{id:EP.id}),bareme=0;angular.isDefined(epDef)&&angular.isDefined(epDef.bareme)&&(bareme=Number(epDef.bareme.replace(",","."))),isNumeric(bareme)&&(totalBareme+=bareme,parseInt(EP.evaluation)>0&&(noteEP+=Number(EP.evaluation)/4*bareme))}}),!(0>=totalBareme)){var newNote=noteEP*vm.selectedDevoir.noteSur/totalBareme;eleveDevoir.lettre="",newNote=Math.round(2*newNote)/2,eleveDevoir.note=newNote.toFixed(1),0===eleveDevoir.note&&(eleveDevoir.note=""),((""!==eleveDevoir.note||""!==eleveDevoir.lettre)&&!vm.selectedDevoir.notationLettre||""!==eleveDevoir.lettre&&vm.selectedDevoir.notationLettre)&&(0===eleveDevoir.noteSur&&(eleveDevoir.noteSur=vm.selectedDevoir.noteSur),0===eleveDevoir.coef&&(eleveDevoir.coef=vm.selectedDevoir.coef))}}}),updateSaisiesNote(),$rootScope.navigationDisabled=!0,vm.allIsSaved=!1)})}function poilDansLaMainNotesVersEP(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/notes-vers-evaluations.html",controller:"NotesVersEvaluationsCtrl as ctrlNotesVersEvaluations",size:"lg",resolve:{devoir:function(){return vm.selectedDevoir},paramsLSU:function(){return vm.parametrages},user:function(){var user={id:vm.idUser,type:vm.typeUser};return user}}});modalInstance.result.then(function(data){var shouldReplaceEvals=data;vm.selectedDevoir.notationLettre||(angular.forEach(vm.tabEleves,function(eleve){if(isNoteCorrecte(eleve)){var eleveDevoir=eleve.devoirs[vm.selectedDevoir.id];if(!angular.isUndefined(eleveDevoir)){if(!shouldReplaceEvals){var isThereAnEval=!1;if(angular.forEach(eleveDevoir.elementsProgramme,function(EP){return lodash.findIndex(vm.selectedDevoir.elementsProgramme,{id:EP.id})<0?void 0:"0"!==EP.evaluation?void(isThereAnEval=!0):void 0}),isThereAnEval)return}if(""===eleveDevoir.note&&eleveDevoir.lettre!==CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS&&eleveDevoir.lettre!==CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)return void angular.forEach(eleveDevoir.elementsProgramme,function(EP){EP.evaluation="0"});if(eleveDevoir.lettre===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)return void angular.forEach(eleveDevoir.elementsProgramme,function(EP){EP.evaluation="-1"});if(eleveDevoir.lettre===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)return void angular.forEach(eleveDevoir.elementsProgramme,function(EP){EP.evaluation="-2"});if(!angular.isUndefined(eleveDevoir.note)){var laNote=Number(eleveDevoir.note),lEval="0",borne1=ratioBorneFromBdd(eleveDevoir,Auth.listParametresIndividuels("lsuPoilDansLaMainBorne1")),borne2=ratioBorneFromBdd(eleveDevoir,Auth.listParametresIndividuels("lsuPoilDansLaMainBorne2")),borne3=ratioBorneFromBdd(eleveDevoir,Auth.listParametresIndividuels("lsuPoilDansLaMainBorne3"));lEval=borne1>=laNote?"1":borne2>=laNote?"2":borne3>=laNote?"3":"4",angular.forEach(eleveDevoir.elementsProgramme,function(EP){EP.evaluation=lEval})}}}}),angular.forEach(vm.selectedDevoir.elementsProgramme,function(EPDevoir){calculerPourcentagesEvaluation(EPDevoir)}),$rootScope.navigationDisabled=!0,vm.allIsSaved=!1)})}function ratioBorneFromBdd(devoirEleve,fromBDD){var resultat=fromBDD;try{devoirEleve.noteSur>0&&angular.isDefined(fromBDD)&&(resultat=Number(fromBDD)*devoirEleve.noteSur/20,resultat+="")}catch(e){console.log("error ratioBorneFromBdd : ",e)}return resultat}function saveAll(){var isAllGood=!0;if(angular.forEach(vm.tabEleves,function(eleve){var eleveDevoir=eleve.devoirs[vm.selectedDevoir.id];angular.isDefined(eleveDevoir)&&angular.isDefined(eleveDevoir.isGoodNote)&&!eleveDevoir.isGoodNote&&(isAllGood=!1)}),!isAllGood){var opts={hide:!0,cornerclass:"clickable",width:"40%",min_height:"100px",title:"Notes",text:'<p style="font-size: 1.5em;">Certaines notes sont incorrectes...</p>',type:"error",icon:"icon-ed_note",delay:3e3,buttons:{closer:!0,sticker:!1,show_on_nonblock:!0,labels:{close:"Fermer"}},nonblock:{nonblock:!0,nonblock_opacity:.2}},notice=new PNotify(opts);return void notice.get().click(function(){notice.remove()})}vm.selectedDevoir.readOnly=!1;var tabDevoir=[vm.selectedDevoir];vm.isProcessingSaving=!0,vm.promiseLoading=CarnetNotesService.saveNotes(vm.idUser,$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere,tabDevoir,vm.tabEleves).then(function(data){vm.isProcessingSaving=!1,Notification.notify("Notes","Vos évaluations ont été sauvegardées","success","icon-ed_note"),$rootScope.navigationDisabled=!1,vm.allIsSaved=!0,refresh()},function(error){vm.isProcessingSaving=!1,Notification.notify("Notes",error.data.message||"Une erreur s'est produite...","error","icon-ed_note")})}function calculerPourcentagesEvaluation(elemProg){var nbEval0=0,nbEval1=0,nbEval2=0,nbEval3=0,nbEval4=0,nbEleves=vm.tabEleves.length;angular.forEach(vm.tabEleves,function(eleve){var eleveDevoir=eleve.devoirs[vm.selectedDevoir.id];if(angular.isUndefined(eleveDevoir))return void nbEval0++;var elemProgActu=lodash.find(eleveDevoir.elementsProgramme,{id:elemProg.id});return angular.isUndefined(elemProgActu)?void nbEval0++:angular.isUndefined(elemProgActu.evaluation)?void nbEval0++:(parseInt(elemProgActu.evaluation)<=0&&nbEval0++,"1"===elemProgActu.evaluation&&nbEval1++,"2"===elemProgActu.evaluation&&nbEval2++,"3"===elemProgActu.evaluation&&nbEval3++,void("4"===elemProgActu.evaluation&&nbEval4++))});var elemProgDevoirActu=lodash.find(vm.selectedDevoir.elementsProgramme,{id:elemProg.id});nbEval0!==nbEleves?(elemProgDevoirActu.pourcentageEvaluation0=0,elemProgDevoirActu.pourcentageEvaluation1=(nbEval1/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation2=(nbEval2/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation3=(nbEval3/(nbEleves-nbEval0)*100).toFixed(1),elemProgDevoirActu.pourcentageEvaluation4=(nbEval4/(nbEleves-nbEval0)*100).toFixed(1)):(elemProgDevoirActu.pourcentageEvaluation0=0,elemProgDevoirActu.pourcentageEvaluation1=0,elemProgDevoirActu.pourcentageEvaluation2=0,elemProgDevoirActu.pourcentageEvaluation3=0,elemProgDevoirActu.pourcentageEvaluation4=0)}function updateDevoir(){var devoirWithNotes={},tabEleves=[],yatilDesNotes=!1;lodash.forEach(vm.tabEleves,function(eleve){if(lodash.has(eleve,"devoirs")){var eleveActu=eleve.eleve;lodash.has(eleve.devoirs,vm.selectedDevoir.id)&&(eleveActu.note=eleve.devoirs[vm.selectedDevoir.id],angular.isDefined(eleveActu.note)&&angular.isDefined(eleveActu.note.note)&&""!==eleveActu.note.note&&(yatilDesNotes=!0),angular.isDefined(eleveActu.note)&&angular.isDefined(eleveActu.note.lettre)&&""!==eleveActu.note.lettre&&(yatilDesNotes=!0))}angular.isDefined(eleveActu)&&tabEleves.push(eleveActu)}),devoirWithNotes={devoir:vm.selectedDevoir,eleves:tabEleves};var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/edit-devoir.html",controller:"DevoirEditCtrl as editDevoirCtrl",backdrop:!1,resolve:{options:function(){var options={};return options.title="Paramètres de l'évaluation",options.mode="edit",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.onlyPeriodesNotes=$scope.noteCtrl.periodesForNotes,options.isReadOnly=vm.allIsSaved,options.yatilDesNotes=yatilDesNotes,options},datasLSU:function(){var data={};return data.devoir=vm.selectedDevoir,data.periode=$scope.noteCtrl.periode,data.periodesRelevees=getPeriodesRelevees($scope.noteCtrl.periode),data.constantesNotes=CarnetNotesService.CONSTANTES,data.notesDevoir=devoirWithNotes,data.devoirsProf=vm.tabDevoirs,data}}});modalInstance.result.then(function(devoirUpdated){if(null===devoirUpdated)vm.tabDevoirs=lodash.reject(vm.tabDevoirs,{id:vm.selectedDevoir.id}),lodash.forEach(vm.tabEleves,function(eleve){lodash.has(eleve,"devoirs")&&delete eleve.devoirs[vm.selectedDevoir.id]}),$rootScope.navigationDisabled=!1,vm.allIsSaved=!0,vm.tabDevoirs.length>0&&setCurrentDevoir(vm.tabDevoirs[0]);else{if(devoirUpdated.coef!==vm.selectedDevoir.coef||devoirUpdated.noteSur!==vm.selectedDevoir.noteSur||devoirUpdated.nonSignificatif!==vm.selectedDevoir.nonSignificatif||devoirUpdated.notationLettre!==vm.selectedDevoir.notationLettre||devoirUpdated.noteNegative!==vm.selectedDevoir.noteNegative)return refresh(),void setCurrentDevoir(devoirUpdated);angular.extend(vm.selectedDevoir,devoirUpdated),setCurrentDevoir(devoirUpdated);var indexDevoirToUpdate=lodash.findIndex(vm.tabDevoirs,{id:devoirUpdated.id});indexDevoirToUpdate>-1&&(vm.tabDevoirs[indexDevoirToUpdate]=devoirUpdated)}})}function displayWarningEditRunning(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}function openGestionCatalogueLSU(){$uibModal.open({templateUrl:"modules/notes/enseignant/LSUN/gestion-catalogue-LSU.html",controller:"GestionCatalogueLSUCtrl as gestionCatalogueLSUCtrl",size:"lg",backdrop:!1,resolve:{options:function(){var options={};return options.entity=vm.entity,options.prof={matiere:$scope.noteCtrl.matiere,id:vm.idUser,devoirsClasse:vm.tabDevoirs},options.listeClasses=$scope.noteCtrl.classes,options.listeMatieres=$scope.noteCtrl.matieres,options.actuelPeriode=$scope.noteCtrl.actuelPeriode,options}}})}function refresh(){if(!(angular.isUndefined($scope.noteCtrl.periode)||angular.isUndefined($scope.noteCtrl.matiere)||angular.isUndefined($scope.noteCtrl.classe))){vm.parametrages=$scope.noteCtrl.classe.paramsLSU,vm.entity=$scope.noteCtrl.classe;var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes;var lesPromises=[CarnetNotesService.getDevoirsProf(vm.idUser,$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere).then(function(data){if(vm.tabEleves=data.eleves,vm.tabEleves=sortEleves(vm.tabEleves),vm.tabDevoirs=data.devoirs,angular.isUndefined(data.eleves)||0===data.eleves.length)return void(vm.aucunEleves=!0);vm.aucunEleves=!1;var tabDevoirsOrdonned=lodash.sortBy(vm.tabDevoirs,function(devoir){return devoir.date}),devoirToSelect=tabDevoirsOrdonned[0],idDevoirToSelectFromCache=0;if("undefined"!=typeof devoirToSelect){angular.isDefined($sessionStorage[$scope.noteCtrl.classe.id+"_"+$scope.noteCtrl.periode.codePeriode+"_"+$scope.noteCtrl.matiere.code+"_"+$scope.noteCtrl.matiere.codeSSMatiere])&&(idDevoirToSelectFromCache=$sessionStorage[$scope.noteCtrl.classe.id+"_"+$scope.noteCtrl.periode.codePeriode+"_"+$scope.noteCtrl.matiere.code+"_"+$scope.noteCtrl.matiere.codeSSMatiere].id);var devoirToSelectFromCache;idDevoirToSelectFromCache>0&&(devoirToSelectFromCache=lodash.find(vm.tabDevoirs,{id:idDevoirToSelectFromCache}),angular.isDefined(devoirToSelectFromCache)&&(devoirToSelect=devoirToSelectFromCache)),setCurrentDevoir(devoirToSelect)}}),UserService.getParametrages().then(function(data){vm.notesLettres=data.note.notesLettres,vm.conversionEvalNotes=data.conversionEvalNotes})];vm.promiseLoading=$q.all(lesPromises)}}function strToInteger(str){return parseInt(str)}function navigateToRight(){var contenuPage=angular.element("#MainWrap .table-responsive");contenuPage.scrollLeft(contenuPage.scrollLeft()+220),vm.scrollLeft=contenuPage.scrollLeft()}function navigateToLeft(){var contenuPage=angular.element("#MainWrap .table-responsive");contenuPage.scrollLeft(contenuPage.scrollLeft()-220),vm.scrollLeft=contenuPage.scrollLeft()}var vm=this;vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.tabEleves=[],vm.tabDevoirs=[],vm.selectedDevoir="undefined",vm.CONSTANTES=CarnetNotesService.CONSTANTES,angular.isDefined($scope.noteCtrl.classe)&&(vm.parametrages=$scope.noteCtrl.classe.paramsLSU),vm.allIsSaved=!0,vm.isProcessingSaving=!1,vm.lodash=lodash,vm.saisiesNote=[],vm.showArrowNavigation=!1,vm.tabEvalEleveNonEvalue=["0","-1","-2"],vm.ratioBorneFromBdd=ratioBorneFromBdd,vm.ajouterDevoir=ajouterDevoir,vm.setCurrentDevoir=setCurrentDevoir,vm.openDetailsEleve=openDetailsEleve,vm.getEvaluationEleve=getEvaluationEleve,vm.evalAll=evalAll,vm.cancelSaisie=cancelSaisie,vm.noteChange=noteChange,vm.saveAll=saveAll,vm.setEvalEleve=setEvalEleve,vm.renderNoteEleve=renderNoteEleve,vm.isNotePersonalisee=isNotePersonalisee,vm.isNoteCorrecte=isNoteCorrecte,vm.noteKeyPress=noteKeyPress,vm.poilDansLaMainNotesVersEP=poilDansLaMainNotesVersEP,vm.poilDansLaMainEPVersNotes=poilDansLaMainEPVersNotes,vm.updateDevoir=updateDevoir,vm.checkInfosNote=checkInfosNote,vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.openPrintModal=openPrintModal,vm.openGestionCatalogueLSU=openGestionCatalogueLSU,vm.navigateToRight=navigateToRight,vm.navigateToLeft=navigateToLeft,vm.isEvaluationEleveNonEvaluee=isEvaluationEleveNonEvaluee,vm.strToInteger=strToInteger,vm.getLibelleConseil=getLibelleConseil,$scope.$on("$destroy",function(){keyboardManagerCompetencesService.unbind("left"),keyboardManagerCompetencesService.unbind("right"),keyboardManagerCompetencesService.unbind("up"),keyboardManagerCompetencesService.unbind("down"),keyboardManagerCompetencesService.unbind("esc"),keyboardManagerCompetencesService.unbind("0"),keyboardManagerCompetencesService.unbind("1"),keyboardManagerCompetencesService.unbind("2"),keyboardManagerCompetencesService.unbind("3"),keyboardManagerCompetencesService.unbind("4"),keyboardManagerCompetencesService.unbind("A"),keyboardManagerCompetencesService.unbind("D")}),keyboardManagerCompetencesService.bind("left",function(){if(!angular.isUndefined(vm.saisieClavierCurrentElemProg)){var indexEPFound=lodash.findIndex(vm.selectedDevoir.elementsProgramme,{id:vm.saisieClavierCurrentElemProg.id});indexEPFound>0?vm.saisieClavierCurrentElemProg=vm.selectedDevoir.elementsProgramme[indexEPFound-1]:(lodash.forEach(vm.tabEleves,function(eleve,indiceEleve){return eleve.eleve.id===vm.saisieClavierCurrentEleve.eleve.id&&indiceEleve>0?(vm.saisieClavierCurrentEleve=vm.tabEleves[indiceEleve-1],!1):void 0}),vm.saisieClavierCurrentElemProg=vm.selectedDevoir.elementsProgramme[vm.selectedDevoir.elementsProgramme.length-1])}},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("right",function(){if(!angular.isUndefined(vm.saisieClavierCurrentElemProg)){var indexEPFound=lodash.findIndex(vm.selectedDevoir.elementsProgramme,{id:vm.saisieClavierCurrentElemProg.id});indexEPFound<vm.selectedDevoir.elementsProgramme.length-1?vm.saisieClavierCurrentElemProg=vm.selectedDevoir.elementsProgramme[indexEPFound+1]:(lodash.forEach(vm.tabEleves,function(eleve,indiceEleve){return eleve.eleve.id===vm.saisieClavierCurrentEleve.eleve.id&&indiceEleve!==vm.tabEleves.length-1?(vm.saisieClavierCurrentEleve=vm.tabEleves[indiceEleve+1],!1):void 0}),vm.saisieClavierCurrentElemProg=vm.selectedDevoir.elementsProgramme[0])}},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("up",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||lodash.forEach(vm.tabEleves,function(eleve,indiceEleve){return eleve.eleve.id===vm.saisieClavierCurrentEleve.eleve.id&&indiceEleve>0?(vm.saisieClavierCurrentEleve=vm.tabEleves[indiceEleve-1],!1):void 0})},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("down",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||lodash.forEach(vm.tabEleves,function(eleve,indiceEleve){return eleve.eleve.id===vm.saisieClavierCurrentEleve.eleve.id&&indiceEleve!==vm.tabEleves.length-1?(vm.saisieClavierCurrentEleve=vm.tabEleves[indiceEleve+1],!1):void 0})},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("esc",function(){vm.saisieClavierCurrentEleve=void 0,vm.saisieClavierCurrentElemProg=void 0},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("0",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"0")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("A",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"-1")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("D",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"-2")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("1",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"1")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("2",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"2")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("3",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"3")},{inputDisabled:!0}),keyboardManagerCompetencesService.bind("4",function(){angular.isUndefined(vm.saisieClavierCurrentEleve)||angular.isUndefined(vm.saisieClavierCurrentElemProg)||vm.setEvalEleve(vm.saisieClavierCurrentEleve,vm.saisieClavierCurrentElemProg,"4")},{inputDisabled:!0}),refresh(),$scope.$watch("noteCtrl.classe",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.code===oldVal.code||$scope.noteCtrl.periodeNotAvailable||(vm.selectedDevoir="undefined",refresh())},!1),$scope.$watch("noteCtrl.periode",function(newVal,oldVal){angular.isUndefined(newVal)||(vm.selectedDevoir="undefined",angular.isDefined(oldVal)&&newVal.codePeriode===oldVal.codePeriode||$scope.noteCtrl.periodeNotAvailable||refresh())},!1),$scope.$watch("noteCtrl.matiere",function(newVal,oldVal){angular.isUndefined(newVal)||(vm.selectedDevoir="undefined",angular.isDefined(oldVal)&&newVal.id===oldVal.id||refresh())},!1),$scope.$watch("cCtrl.selectedDevoir",function(newValue,oldValue){newValue!==oldValue&&$timeout(function(){var contenuPage=angular.element("#MainWrap .table-responsive");contenuPage.prop("offsetWidth")<contenuPage.prop("scrollWidth")?vm.showArrowNavigation=!0:vm.showArrowNavigation=!1},10)})}]),angular.module("edsiteApp.CarnetNotes").controller("SaisieAppreciationsCtrl",["$rootScope","$timeout","$scope","$filter","$uibModal","SaisieNotesService","ModuleService","CarnetNotesService","lodash","SaisieAppreciationsService","Auth","Notification","AppreciationsPredefiniesService","base64decodeFilter","base64encodeFilter","$q","CacheService","Utils",function($rootScope,$timeout,$scope,$filter,$uibModal,SaisieNotesService,ModuleService,CarnetNotesService,lodash,SaisieAppreciationsService,Auth,Notification,AppreciationsPredefiniesService,base64decodeFilter,base64encodeFilter,$q,CacheService,Utils){function prolexis(){var listAppToCheck=[];
if(angular.forEach(vm.eleves,function(eleve){var idxApp=0;(""===eleve.eleve.dateSortie||eleve.eleve.dateSortie>vm.classe.currentPeriode.dateDebut)&&angular.forEach(vm.parametrage.appreciations,function(appr){listAppToCheck.push({src:document.getElementById("eleve"+eleve.eleve.id+"-"+idxApp),type:"txt",label:eleve.eleve.nom+" "+eleve.eleve.prenom+" - "+appr.libelle}),idxApp++})}),vm.parametrage.saisieAppreciationClasse){var textApp=$scope.noteCtrl.classe.type===vm.TYPES_ENTITIES.CLASSE?"Appréciation classe":"Appréciation groupe";listAppToCheck.push({src:document.getElementById("appreciationGenerale"),type:"txt",label:textApp})}DiagPlWs.analyze(listAppToCheck),vm.formGlobalIsUpdated=!0,$rootScope.navigationDisabled=!0}function getLibelleConseil(periode){return CarnetNotesService.getLibelleConseil(periode)}function evalAll(valeur){(vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.OUVERTE||vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.PARTIELLE)&&($rootScope.navigationDisabled=!0,vm.formGlobalIsUpdated=!0,1!==$scope.noteCtrl.classe.degre||$scope.noteCtrl.matiere.saisieAppreciationSSMat||1!==$scope.noteCtrl.matiere.avecSousMatiere?lodash.forEach(vm.eleves,function(eleve){eleve.currentPeriode.position=valeur}):lodash.forEach(vm.eleves,function(eleve){lodash.forEach(eleve.currentPeriode.positionSSMat,function(pos){pos.position=valeur})}))}function setEvalEleveSSMat(positionSSMat,evaluation){(vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.OUVERTE||vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.PARTIELLE)&&(positionSSMat.position=evaluation,$rootScope.navigationDisabled=!0,vm.formGlobalIsUpdated=!0)}function setEvalEleve(eleveSelected,evaluation){(vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.OUVERTE||vm.periodeSelected.etat===vm.CONSTANTES_PERIODES.ETATS.PARTIELLE)&&(eleveSelected.currentPeriode.position=evaluation,$rootScope.navigationDisabled=!0,vm.formGlobalIsUpdated=!0)}function setTriByClasse(){vm.sortByClasse=!0,vm.eleves=sortEleves(vm.eleves)}function setTriAlpha(){vm.sortByClasse=!1,vm.eleves=sortEleves(vm.eleves)}function countEleve(){return lodash.filter(vm.eleves,function(eleve){return""===eleve.eleve.dateSortie||eleve.eleve.dateSortie>vm.classe.currentPeriode.dateDebut}).length}function appreciationsPredefiniesCallBack(params){var defer=$q.defer(),resultat=lodash.filter(vm.appreciationsPredefinies,function(app){var trouve=!1;return(-1!==app.libelle.toLowerCase().indexOf(params.query.toLowerCase())||-1!==app.code.toLowerCase().indexOf(params.query.toLowerCase()))&&(trouve=!0),trouve});return defer.resolve(resultat),defer.promise}function togglePeriodeFullMode(periode){vm.periodeInFullMode[periode.code]=!vm.periodeInFullMode[periode.code]}function isPeriodeInFullMode(periode){return vm.periodeInFullMode[periode.code]}function sortEleves(eleves){return vm.sortByClasse?lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).sortBy(function(eleveNote){return eleveNote.eleve.codeClasse}).value():lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).value()}function calcMoyenneEleve(pEleve){var idEleve=pEleve.eleve.id,eleve=void 0,eleveInScope=void 0,result="";if(angular.isUndefined(SaisieNotesService.data))return angular.isDefined(pEleve.currentPeriode)&&(result=pEleve.currentPeriode.moyenne),result;if(angular.forEach(SaisieNotesService.data.eleves,function(el){el.eleve.id===idEleve&&(eleve=angular.copy(el))}),angular.forEach(vm.eleves,function(el){el.eleve.id===idEleve&&(eleveInScope=el)}),angular.isUndefined(eleve)&&angular.isDefined(pEleve.currentPeriode))return result=pEleve.currentPeriode.moyenne;if(angular.isDefined(eleve)&&"R"===vm.periodeSelected.codePeriode[4]&&"H"!==vm.periodeSelected.codePeriode[0]&&(eleve.devoirs=lodash.filter(eleve.devoirs,function(devoir){return devoir.date<=vm.periodeSelected.dateFin&&devoir.date>=vm.periodeSelected.dateDebut})),angular.isDefined(pEleve.currentPeriode)&&pEleve.currentPeriode.positionSSMat&&pEleve.currentPeriode.positionSSMat.length>0){var lesSSMat=lodash.filter(vm.periodeSelected.matieres,{code:$scope.noteCtrl.matiere.code});if(angular.isDefined(lesSSMat)&&lesSSMat.length<pEleve.currentPeriode.positionSSMat.length)return result=pEleve.currentPeriode.moyenne}var moy=SaisieNotesService.calcMoyenneEleve(eleve);return moy=lodash.isFinite(moy)?moy.toFixed(2):"",""===moy&&angular.isDefined(pEleve.currentPeriode)?result=pEleve.currentPeriode.moyenne:(result=moy,angular.isDefined(eleveInScope)&&(eleveInScope.currentMoyenne=result)),(angular.isUndefined(result)||""===result||result.length<=0)&&(result="(Aucune moyenne)"),result}function enregistreAppreciations(lesEleves,formAppreciation){vm.prolexisEnable&&angular.forEach(vm.eleves,function(eleve){var idxApp=0;(""===eleve.eleve.dateSortie||eleve.eleve.dateSortie>vm.classe.currentPeriode.dateDebut)&&angular.forEach(vm.parametrage.appreciations,function(appr){var lapp=document.getElementById("eleve"+eleve.eleve.id+"-"+idxApp);angular.isDefined(lapp)&&""!==lapp.value&&(eleve.currentPeriode.appreciations[idxApp].contenuDecode=lapp.value),idxApp++})});var tabEleves=[];if(lodash.forEach(lesEleves,function(eleve){var tabAppreciations=[];lodash.forEach(eleve.currentPeriode.appreciations,function(appreciation){var appreciationFormate=angular.copy(appreciation);appreciationFormate.contenu=$filter("base64encode")(appreciationFormate.contenuDecode),tabAppreciations.push(appreciationFormate)});var appreciationsEleve={idEleve:eleve.eleve.id,appreciations:tabAppreciations,position:eleve.currentPeriode.position,positionSSMat:eleve.currentPeriode.positionSSMat};tabEleves.push(appreciationsEleve)}),vm.parametrage.saisieAppreciationClasse){var appreciationClasseFormate=angular.copy(vm.appreciationGenerale);appreciationClasseFormate.contenu=$filter("base64encode")(appreciationClasseFormate.contenuDecode)}vm.promiseContent=SaisieAppreciationsService.save(vm.typeUser,vm.idUser,$scope.noteCtrl.classe,vm.periodeSelected.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere,tabEleves,appreciationClasseFormate).then(function(reponse){Notification.notify("Saisie des appréciations","Sauvegarde de vos appréciations effectuée !","success","icon-ed_note")},function(error){Notification.notify("Saisie des appréciations","Une erreur s'est produite lors de la sauvegarde de vos appréciations","error","icon-ed_note")}),vm.formGlobalIsUpdated=!1,formAppreciation.$setPristine(),$rootScope.navigationDisabled=!1}function dupliquerSaisie(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/duplication-appreciations/liste-periodes-duplication.html",controller:"DuplicationAppreciationsCtrl as duplicationAppCtrl",size:"lg",resolve:{periodeCurrent:function(){var periode={codePeriode:vm.periodeSelected.codePeriode,libelle:vm.periodeSelected.libelle,codeMatiere:$scope.noteCtrl.matiere.code,codeSSMatiere:$scope.noteCtrl.matiere.codeSSMatiere};return periode},user:function(){var user={type:vm.typeUser,id:vm.idUser,entity:$scope.noteCtrl.classe};return user},periodesDuplication:function(){return vm.periodesToDuplicate}}});modalInstance.result.then(function(){CacheService.removeMatch(/.*\/appreciations/),refresh()})}function gestionAppreciationsType(){vm.displayAppreciationsPredefinies(AppreciationsPredefiniesService.MODES.GESTION)}function saisieAppreciationType(appreciation,nbMaxCaract,eleve,idxApp){vm.appreciationCurrent={code:"0",contenu:"",contenuDecode:"",libelle:""},angular.isDefined(appreciation)&&(vm.appreciationCurrent=appreciation),vm.displayAppreciationsPredefinies(AppreciationsPredefiniesService.MODES.SAISIE,nbMaxCaract,eleve,idxApp)}function displayAppreciationsPredefinies(mode,nbMaxCaract,eleve,idxApp){var modalInstance,appreciationsPredefinies=[];appreciationsPredefinies=angular.copy(vm.appreciationsPredefinies),modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/appreciations-predefinies/liste-appreciations-predefinies.html",controller:"AppreciationsPredefiniesCtrl as appPredefiniesCtrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{user:function(){var user={type:vm.typeUser,id:vm.idUser,entity:$scope.noteCtrl.classe};return user},appreciationsPredef:function(){return{appreciations:appreciationsPredefinies,parametrage:vm.parametrageAppreciationsPredefinies,type:AppreciationsPredefiniesService.TYPE_APP.ENSEIGNANT}},entity:function(){return $scope.noteCtrl.classe},mode:function(){return mode}}}),modalInstance.result.then(function(result){mode===AppreciationsPredefiniesService.MODES.GESTION?vm.appreciationsPredefinies=result:angular.isDefined(result)&&(vm.appreciationCurrent.contenuDecode=result.libelle,vm.onChangeAppreciation(result.libelle,nbMaxCaract,eleve,idxApp))})}function openDetailsEleve(eleve){vm.seulPPVoieToutesLesNotes||$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function onChangeAppreciation(libelleAppreciation,nbMaxCaract,eleve,idxApp){eleve.currentPeriode.appreciations[idxApp].isUpdate=!0,vm.nbLimitReached[eleve.eleve.id+"_"+idxApp]=libelleAppreciation.length>nbMaxCaract,vm.hasError=lodash.filter(vm.nbLimitReached,function(entry){return entry}).length>0,vm.formGlobalIsUpdated=!0,$rootScope.navigationDisabled=!0}function onChangeAppreciationGenerale(){vm.formGlobalIsUpdated=!0,$rootScope.navigationDisabled=!0}function selectPeriode(periode){if(vm.statusDropdown.isPeriodeOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectPeriode(periode)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.periodeSelected=periode,("R"!==vm.periodeSelected.codePeriode[4]||"H"===vm.periodeSelected.codePeriode[0])&&$scope.noteCtrl.selectPeriode(vm.periodeSelected),refresh()}function displayWarningEditRunning(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}function openModaleChoixEPI(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/saisie-appreciations/choix-elements-programme-imprimes.html",controller:"ChoixElemProgImprimesCtrl as ctrlChoixElemProgImprimes",keyboard:!1,backdrop:!1,size:"lg",resolve:{user:function(){var user={};return user.typeUser=vm.typeUser,user.idUser=vm.idUser,user},nbElemProgMaxAImprimer:function(){var nbElemMaxAImprimer=0;return nbElemMaxAImprimer=""!==$scope.noteCtrl.matiere.codeSSMatiere?$scope.noteCtrl.classe.paramsLSU.nbElementsProgrammeImprimesSousMatiere:$scope.noteCtrl.classe.paramsLSU.nbElementsProgrammeImprimes},currentEntity:function(){return $scope.noteCtrl.classe},periode:function(){return $scope.noteCtrl.periode},matiere:function(){return $scope.noteCtrl.matiere},saisieAppCtrl:function(){return vm},paramsLSU:function(){return $scope.noteCtrl.classe.paramsLSU}}});modalInstance.result.then(function(result){"refresh"===result&&refresh()})}function openModaleDetailElemProgEleve(eleveSelected,elemProg){$uibModal.open({templateUrl:"modules/notes/enseignant/saisie-appreciations/details-element-programme.html",controller:"DetailElementProgrammeCtrl as ctrlDetailElementProgramme",size:"lg",keyboard:!1,backdrop:!1,resolve:{elemProg:function(){return elemProg},user:function(){var user={};return user.typeUser=vm.typeUser,user.idUser=vm.idUser,user},currentClasse:function(){return $scope.noteCtrl.classe},currentEleve:function(){return eleveSelected},periode:function(){return $scope.noteCtrl.periode},matiere:function(){return $scope.noteCtrl.matiere}}})}function updateEP(elemProg){lodash.forEach(vm.eleves,function(eleve){angular.isDefined(eleve.currentPeriode)&&(lodash.forEach(eleve.currentPeriode.elementsProgramme,function(ep){ep.id===elemProg.idOrigineCatalogue&&(ep.imprime=elemProg.imprime,ep.ordre=elemProg.ordre,ep.libelle=elemProg.libelle)}),eleve.currentPeriode.elementsProgrammeImprimes=angular.copy(eleve.currentPeriode.elementsProgramme),lodash.remove(eleve.currentPeriode.elementsProgrammeImprimes,function(elProg){return!elProg.imprime}))})}function openPrintModal(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/saisie-appreciations/edition-appreciations.html",controller:"AppreciationsEditionCtrl as appreciationsEditionCtrl",backdrop:!0,resolve:{options:function(){var options={};return options.title="Paramétrage de l'édition des appréciations",options.idUser=vm.idUser,options.typeUser=vm.typeUser,options.classe=$scope.noteCtrl.classe,options.matiere=$scope.noteCtrl.matiere,options.triEleve=vm.sortByClasse?"classe":"eleve",options.parametresAppreciations=vm.parametrage,options.controleurNote=$scope.noteCtrl,options.eleves=vm.eleves,options.Constantes=vm.CONSTANTES_PERIODES,options.currentPeriode=vm.classe.currentPeriode,options}}});modalInstance.result.then(function(data){})}function updateElevesInfo(){lodash.forEach(vm.eleves,function(eleve){if(!angular.isUndefined(vm.periodeSelected)){var periodesTuple=lodash.partition(eleve.periodes,{code:vm.periodeSelected.codePeriode});lodash.remove(periodesTuple[1],function(periode){return periode.code.substring(0,4)>vm.periodeSelected.codePeriode.substring(0,4)}),eleve.previousPeriodes=periodesTuple[1],eleve.currentPeriode=periodesTuple[0][0],lodash.forEach(eleve.currentPeriode.appreciations,function(appreciation){angular.isUndefined(appreciation.contenuDecode)&&(appreciation.contenuDecode=$filter("base64decode")(appreciation.contenu))}),eleve.currentPeriode.appreciations=lodash.sortBy(eleve.currentPeriode.appreciations,"code"),eleve.currentPeriode.elementsProgrammeImprimes=angular.copy(eleve.currentPeriode.elementsProgramme),lodash.remove(eleve.currentPeriode.elementsProgrammeImprimes,function(elemProg){return!elemProg.imprime})}})}function refresh(){if(angular.isUndefined($scope.noteCtrl.periode))return void(vm.periodeSelected=void 0);if(vm.isModeAccessibiliteVisuelle=Utils.isModeAccessibiliteVisuelleActif(),angular.isUndefined(vm.periodeSelected)&&(vm.periodeSelected=angular.copy($scope.noteCtrl.periode)),$scope.noteCtrl.periode.codePeriode.substring(0,4)!==vm.periodeSelected.codePeriode.substring(0,4)&&(vm.periodeSelected=angular.copy($scope.noteCtrl.periode)),angular.isUndefined(lodash.find($scope.noteCtrl.periodesForAppreciations,{codePeriode:vm.periodeSelected.codePeriode}))&&(vm.periodeSelected=angular.copy($scope.noteCtrl.periode)),vm.relevesPeriodeActuelle=lodash.filter($scope.noteCtrl.periodesForAppreciations,function(periodeApp){return periodeApp.codePeriode.substring(0,4)===vm.periodeSelected.codePeriode.substring(0,4)}),!angular.isUndefined($scope.noteCtrl.matiere)&&!$scope.noteCtrl.periodeNotAvailable){vm.parametragesLSU=$scope.noteCtrl.classe.paramsLSU;var lesPromises=[SaisieAppreciationsService.get(vm.typeUser,vm.idUser,$scope.noteCtrl.classe,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere).then(function(appreciation){vm.eleves=sortEleves(appreciation.eleves),vm.parametrage=appreciation.parametrage,vm.parametrage.appreciations=lodash.sortBy(vm.parametrage.appreciations,"code"),updateElevesInfo(),vm.classe=appreciation.classe;var periodesTubleCurrentPreviousPeriode=lodash.partition(vm.classe.periodes,{code:vm.periodeSelected.codePeriode});lodash.remove(periodesTubleCurrentPreviousPeriode[1],function(periode){return periode.code.substring(0,4)>vm.periodeSelected.codePeriode.substring(0,4)}),vm.classe.previousPeriodes=periodesTubleCurrentPreviousPeriode[1],vm.classe.currentPeriode=periodesTubleCurrentPreviousPeriode[0][0],vm.appreciationGenerale.contenuDecode=$filter("base64decode")(vm.classe.currentPeriode.appreciationGenerale),vm.periodesToDuplicate=lodash.chain(vm.classe.periodes).reject({code:vm.periodeSelected.codePeriode}).reject({ouverte:!1}).value()},function(error){Notification.notify("Saisie des appréciations","Une erreur s'est produite lors de la récupération des appréciations ","error","icon-ed_note")}),AppreciationsPredefiniesService.get(vm.idUser,$scope.noteCtrl.classe).then(function(lesAppreciations){vm.appreciationsPredefinies=lesAppreciations.appreciations,vm.parametrageAppreciationsPredefinies=lesAppreciations.parametrage;var appPredef=angular.copy(vm.appreciationsPredefinies);lodash.forEach(appPredef,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefinies=appPredef})];vm.promiseDevoirs=CarnetNotesService.getDevoirsProf(vm.idUser,$scope.noteCtrl.classe.type,$scope.noteCtrl.classe.id,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,$scope.noteCtrl.matiere.codeSSMatiere).then(function(data){vm.devoirs=data.devoirs,lodash.forEach(data.eleves,function(eleve){lodash.forEach(data.devoirs,function(devoir){lodash.has(eleve.devoirs,devoir.id)||(eleve.devoirs[devoir.id]=angular.copy(devoir))})}),SaisieNotesService.setPeriodes($scope.noteCtrl.periodes),SaisieNotesService.setCurrentPeriode($scope.noteCtrl.periode),SaisieNotesService.setCurrentMatiere($scope.noteCtrl.matiere),SaisieNotesService.setCurrentClasse($scope.noteCtrl.classe),SaisieNotesService.setData(data)},function(){}),vm.promiseContent=$q.all(lesPromises)}}var vm=this;vm.evalAll=evalAll,vm.setEvalEleveSSMat=setEvalEleveSSMat,vm.setEvalEleve=setEvalEleve,vm.togglePeriodeFullMode=togglePeriodeFullMode,vm.isPeriodeInFullMode=isPeriodeInFullMode,vm.enregistreAppreciations=enregistreAppreciations,vm.gestionAppreciationsType=gestionAppreciationsType,vm.dupliquerSaisie=dupliquerSaisie,vm.displayAppreciationsPredefinies=displayAppreciationsPredefinies,vm.saisieAppreciationType=saisieAppreciationType,vm.appreciationsPredefiniesCallBack=appreciationsPredefiniesCallBack,vm.openDetailsEleve=openDetailsEleve,vm.onChangeAppreciation=onChangeAppreciation,vm.onChangeAppreciationGenerale=onChangeAppreciationGenerale,vm.countEleve=countEleve,vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.selectPeriode=selectPeriode,vm.calcMoyenneEleve=calcMoyenneEleve,vm.openModaleChoixEPI=openModaleChoixEPI,vm.openModaleDetailElemProgEleve=openModaleDetailElemProgEleve,vm.updateElevesInfo=updateElevesInfo,vm.updateEP=updateEP,vm.prolexis=prolexis,vm.openPrintModal=openPrintModal,vm.getLibelleConseil=getLibelleConseil,vm.periodeInFullMode=[],vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.TYPES_ENTITIES=CarnetNotesService.typeEntity,vm.CONSTANTES_PERIODES=CarnetNotesService.CONSTANTES.PERIODES,vm.appreciationCurrent={},vm.appreciationGenerale={contenu:"",contenuDecode:""},vm.searchAppPredefinie="",vm.appreciationsPredefinies=[],vm.formGlobalIsUpdated=!1,vm.nbLimitReached={},vm.limitReachedAppClasse=!1;var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,vm.statusDropdown={isPeriodeOpen:!1},vm.prolexisEnable="1"===paramNotes.params.prolexisEnable,vm.prolexisEnable&&DiagPlWs.init({sUrlProxy:"https://pprolexis.ecoledirecte.com/prolexis",sCorePath:"scripts/ext/prolexis/DiagPlWs",left:10,top:10,width:850,height:400,excludedElement:".ignore, .hidden"}),$scope.$watch("noteCtrl.classe",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.code===oldVal.code||$scope.noteCtrl.periodeNotAvailable||refresh()},!1),$scope.$watch("noteCtrl.periode",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.id===oldVal.id||vm.selectPeriode($scope.noteCtrl.periode)}),$scope.$watch("noteCtrl.matiere",function(newVal,oldVal){vm.formGlobalIsUpdated||refresh()})}]),angular.module("edsiteApp.CarnetNotes").controller("DevoirEditCtrl",["$scope","$uibModalInstance","datasLSU","options","CarnetNotesService","ComposantesService","CompetencesService","moment","Notification","$uibModal","lodash","UserService","$q",function($scope,$uibModalInstance,datasLSU,options,CarnetNotesService,ComposantesService,CompetencesService,moment,Notification,$uibModal,lodash,UserService,$q){function getEtatPeriode(etat){var periode={};return periode[vm.ETATS.ATTENTE]="En attente",periode[vm.ETATS.CLOTUREE]="Clôturée",periode[vm.ETATS.PARTIELLE]="Partielle",periode[vm.ETATS.OUVERTE]="Ouverte",periode[etat]}function openDate($devoir){$devoir.preventDefault(),$devoir.stopPropagation(),vm.dateOpened=!0}function openDateAffichage($devoir){$devoir.preventDefault(),$devoir.stopPropagation(),vm.dateAffichageOpened=!0}function close(){vm.devoir=angular.extend({},vm.backupDevoir),$uibModalInstance.close(vm.devoir)}function setValidationDate(date,dateForm){return moment(date).isBefore(vm.minDate)||moment(date).isAfter(moment(vm.maxDate).add(1,"days"))?(dateForm.$setValidity("outOfRange",!1),!1):(dateForm.$setValidity("outOfRange",!0),!0)}function elementsProgrammeValid(form,devoir){var invalid=!1;lodash.forEach(devoir.elementsProgramme,function(elemProg){elemProg.libelle.length>vm.paramsLSU.nombreCaracteresMax&&(invalid=!0)}),form.$invalid=invalid}function submitForm(form,devoir){vm.setValidationDate(devoir.date,form.date)&&((!devoir.avecNote||devoir.avecNote&&devoir.notationLettre)&&(devoir.coef=0,devoir.noteSur=0),devoir.elementsProgramme.length>0&&vm.elementsProgrammeValid(form,devoir),form.$invalid||("edit"===options.mode?vm.update(devoir):vm.save(devoir)))}function setDevoirNote(){vm.devoir.avecNote?(vm.devoir.noteSur=vm.paramEtab.borneMax,angular.isDefined(vm.devoir.typeDevoir)&&angular.isDefined(vm.devoir.typeDevoir.coef)&&vm.devoir.typeDevoir.coef>0?vm.devoir.coef=vm.devoir.typeDevoir.coef:vm.devoir.coef=1):vm.devoir.notationLettre=!1,datasLSU.devoir.avecNote=vm.devoir.avecNote}function update(devoir){devoir.date=moment(devoir.date).format("YYYY-MM-DD"),devoir.dateAffichage=moment(devoir.dateAffichage).format("YYYY-MM-DD"),"string"==typeof devoir.coef&&(devoir.coef=devoir.coef.replace(/,/g,".")),vm.requestLoading=CarnetNotesService.updateDevoir(options.idUser,vm.classe.type,vm.classe.id,vm.periode.codePeriode,options.matiere.code,options.matiere.codeSSMatiere,devoir).then(function(data){Notification.notify("Devoir","Votre devoir a bien été modifié","success","icon-ed_note"),lodash.forEach(devoir.elementsProgramme,function(elemProg){var elemProgAdd=lodash.find(data.elementsProgramme,{idOrigineCatalogue:elemProg.idOrigineCatalogue});angular.isDefined(elemProgAdd)&&(elemProg.id=elemProgAdd.id),CompetencesService.updateElemProgInAllDevoirs(elemProg,vm.devoirs)}),$uibModalInstance.close(devoir)},function(error){Notification.notify("Devoir",error.data.message||"Une erreur s'est produite lors de la sauvegarde de vos modifications","error","icon-ed_note"),$uibModalInstance.dismiss()})}function save(devoir){var devoirToSave=angular.copy(devoir);devoirToSave.date=moment(devoir.date).format("YYYY-MM-DD"),"2"===vm.paramEtab.avecDecalage?devoirToSave.dateAffichage=moment(devoir.dateAffichage).format("YYYY-MM-DD"):devoirToSave.dateAffichage="","string"==typeof devoir.coef&&(devoirToSave.coef=devoir.coef.replace(/,/g,".")),vm.requestLoading=CarnetNotesService.createDevoir(options.idUser,vm.classe.type,vm.classe.id,vm.periode.codePeriode,options.matiere.code,options.matiere.codeSSMatiere,devoirToSave).then(function(data){Notification.notify("Devoir","Votre devoir a bien été enregistré","success","icon-ed_note"),devoir.statutPeriode=vm.periode.etat,devoir.id=data.id,devoir.idProf=options.idUser,lodash.forEach(devoir.elementsProgramme,function(elemProg){var elemProgAdd=lodash.find(data.elementsProgramme,{idOrigineCatalogue:elemProg.idOrigineCatalogue});angular.isDefined(elemProgAdd)&&(elemProg.id=elemProgAdd.id),CompetencesService.updateElemProgInAllDevoirs(elemProg,vm.devoirs)}),devoir.data="devoirs."+devoir.id+".note",$uibModalInstance.close(devoir)},function(error){Notification.notify("Devoir",error.data.message||"Une erreur s'est produite lors de la sauvegarde de votre devoir","error","icon-ed_note")})}function deleteDevoir(devoir,form){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'une évaluation",config.message="Confirmer la suppression de l'évaluation ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){vm.requestLoading=CarnetNotesService.deleteDevoir(options.idUser,vm.classe.type,vm.classe.id,vm.periode.codePeriode,options.matiere.code,options.matiere.codeSSMatiere,devoir).then(function(resultDelete){Notification.notify("Evaluation","Votre évaluation a bien été supprimée","success","icon-ed_note"),$uibModalInstance.close(null)},function(error){Notification.notify("Evaluation",error.data.message||"Une erreur s'est produite lors de la suppression de votre évaluation","error","icon-ed_note")})})}function notationLettreChanged(notationLettre){notationLettre&&(vm.devoir.noteNegative=!1)}function onDateDevoirChanged(){vm.setValidationDate(vm.devoir.date,vm.devoirForm.date)}function changeTypeDevoir(typeDevoir){vm.devoir.coef=typeDevoir.coef}function duplicateDevoir(){$uibModal.open({templateUrl:"modules/notes/enseignant/liste-periodes-duplication-devoir.html",controller:"DuplicationDevoirCtrl as duplicationDevoirCtrl",size:"lg",resolve:{periodeCurrent:function(){var periode={codePeriode:vm.periode.codePeriode,libelle:vm.periode.libelle,codeMatiere:options.matiere.code,codeSSMatiere:options.matiere.codeSSMatiere};return periode},user:function(){var user={type:options.typeUser,id:options.idUser,entity:vm.classe};return user},onlyPeriodesForNotes:function(){return options.onlyPeriodesNotes},devoir:function(){return datasLSU.notesDevoir}}})}function isElemProgInComposante(elemProg,composante){return angular.isDefined(lodash.find(elemProg.composantes,{id:composante.id}))}function printElemProgOnBulletin(EP){vm.paramsLSU.nbElemMaxAImprimer!==vm.paramsLSU.nbElemsImprimes&&(EP.imprime=!EP.imprime,vm.paramsLSU.nbElemsImprimes++)}function notPrintElemProgOnBulletin(EP){EP.imprime=!EP.imprime,vm.paramsLSU.nbElemsImprimes--}function addElemProgInComposante(elemProg,composanteLSU){var indexComposanteFound=lodash.findIndex(elemProg.composantes,{id:composanteLSU.id});-1===indexComposanteFound?elemProg.composantes.push({id:composanteLSU.id,libelle:composanteLSU.libelle}):elemProg.composantes.splice(indexComposanteFound,1)}function addElemProg(){vm.ariaHidden=!0;var instanceModaleCatalogue=$uibModal.open({templateUrl:"../../modules/notes/enseignant/LSUN/ajout-element-programme-modal.html",controller:"ajoutElemProgModalCtrl as ctrlAjoutElemProg",size:"lg",windowClass:"elem-prog-ajout-modal",backdrop:!1,keyboard:!0,resolve:{prof:function(){var prof={};return prof.matiere=options.matiere,prof.id=options.idUser,prof.devoirsClasse=vm.devoirs,prof},periode:function(){return vm.periode},devoir:function(){return vm.devoir},paramsLSU:function(){return vm.paramsLSU},idCycleEtab:function(){return vm.classe.idCycleEtab},entity:function(){return vm.classe}}});instanceModaleCatalogue.result.then(function(){vm.ariaHidden=!1},function(){vm.ariaHidden=!1})}function removeElemProg(elemProg){var indexElemProgFound=lodash.findIndex(vm.devoir.elementsProgramme,{idOrigineCatalogue:elemProg.idOrigineCatalogue});indexElemProgFound>-1&&(vm.devoir.elementsProgramme.splice(indexElemProgFound,1),elemProg.imprime&&(elemProg.imprime=!1,vm.paramsLSU.nbElemsImprimes--))}function getDateAffichageAvecDecalage(isLSUN){return CarnetNotesService.getDateAffichageDevoirNote(vm.devoir.dateAffichage,isLSUN,vm.paramEtab)}function refresh(){var lesPromises=[UserService.getParametrages().then(function(params){vm.notesLettres=params.note.notesLettres,vm.paramEtab=lodash.find(params.note.etabsParams,{id:vm.classe.etabId}),vm.types=vm.paramEtab.typesDevoirs,vm.isCoefModifiable=vm.paramEtab.isCoefModifiable,vm.isBorneModifiable=vm.paramEtab.isBorneModifiable,vm.format="dd/MM/yyyy",vm.devoir={libelle:"",coef:1,noteSur:vm.paramEtab.borneMax,nonSignificatif:!1,ccf:!1,notationLettre:!1,noteNegative:!1,avecNote:!1,elementsProgramme:[]},angular.extend(vm.devoir,datasLSU.devoir),vm.devoir.dateAffichage="edit"===options.mode?new Date(vm.devoir.dateAffichage):new Date,vm.devoir.date="edit"===options.mode?new Date(datasLSU.devoir.date):new Date,vm.classe.idCycleEtab<=0&&(vm.devoir.avecNote=!0),"edit"===options.mode&&angular.isDefined(vm.devoir.typeDevoir)&&(vm.devoir.typeDevoir=lodash.find(vm.types,{id:vm.devoir.typeDevoir.id})),vm.backupDevoir={},vm.backupDevoir=angular.copy(datasLSU.devoir)})];vm.requestLoading=$q.all(lesPromises)}var vm=this;vm.refesh=refresh,vm.duplicateDevoir=duplicateDevoir,vm.openDate=openDate,vm.openDateAffichage=openDateAffichage,vm.close=close,vm.setValidationDate=setValidationDate,vm.submitForm=submitForm,vm.update=update,vm.save=save,vm.deleteDevoir=deleteDevoir,vm.notationLettreChanged=notationLettreChanged,vm.changeTypeDevoir=changeTypeDevoir,vm.isElemProgInComposante=isElemProgInComposante,vm.printElemProgOnBulletin=printElemProgOnBulletin,vm.notPrintElemProgOnBulletin=notPrintElemProgOnBulletin,vm.addElemProgInComposante=addElemProgInComposante,vm.addElemProg=addElemProg,vm.removeElemProg=removeElemProg,vm.setDevoirNote=setDevoirNote,vm.elementsProgrammeValid=elementsProgrammeValid,vm.getEtatPeriode=getEtatPeriode,vm.getDateAffichageAvecDecalage=getDateAffichageAvecDecalage,vm.onDateDevoirChanged=onDateDevoirChanged,vm.options=options,vm.dateOptions={formatYear:"yy",startingDay:1},vm.ETATS={CLOTUREE:"cloture",PARTIELLE:"partiel",ATTENTE:"",OUVERTE:"ouvert"},vm.isCoefModifiable=!1,vm.minDate=moment(datasLSU.periode.dateDebut),vm.maxDate=moment(datasLSU.periode.dateFin),vm.periode=datasLSU.periode,vm.periodesRelevees=datasLSU.periodesRelevees,vm.devoirs=datasLSU.devoirsProf,vm.classe=options.classe,vm.ariaHidden=!1,angular.isDefined(datasLSU.devoir.idPeriode)?vm.isExamenBlanc=datasLSU.devoir.idPeriode.indexOf("X")>0:vm.isExamenBlanc=vm.periode.codePeriode.indexOf("X")>0,angular.isDefined(vm.classe.paramsLSU)?(vm.paramsLSU=vm.classe.paramsLSU,""!==options.matiere.codeSSMatiere?vm.paramsLSU.nbElemMaxAImprimer=vm.classe.paramsLSU.nbElementsProgrammeImprimesSousMatiere:vm.paramsLSU.nbElemMaxAImprimer=vm.classe.paramsLSU.nbElementsProgrammeImprimes,vm.paramsLSU.nbElemsImprimes=CompetencesService.countNbElemProgImprimes(vm.devoirs)):vm.paramsLSU={nbElemMaxAImprimer:0,nbElemsImprimes:0},UserService.getParametrages().then(function(params){vm.composantesSocle=params.composantes,vm.composantesSoclePart1=vm.composantesSocle.slice(0,4),vm.composantesSoclePart2=vm.composantesSocle.slice(4,8)}),refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("DevoirDetailCtrl",["$uibModalInstance","devoir","discipline","parametrage","idEleve","Auth","$uibModal","Utils",function($uibModalInstance,devoir,discipline,parametrage,idEleve,Auth,$uibModal,Utils){
function refresh(){vm.isModeAccessibiliteVisuelle=Utils.isModeAccessibiliteVisuelleActif()}function close(){$uibModalInstance.close()}function isExamenBlanc(){return vm.devoir.codePeriode.length>4&&"X"===vm.devoir.codePeriode[4]}function isDispense(){return"Disp"===vm.devoir.valeur.trim()}function isAbsent(){return"Abs"===vm.devoir.valeur.trim()}function parseStringToInteger(str){return parseInt(str)}function openQCM(){$uibModal.open({templateUrl:"modules/qcm/eleve/qcm-resultat-viewer.html",controller:"QCMResultatViewerCtrl as ctrl",backdrop:"static",size:"lg",resolve:{qcmAssociation:function(){return vm.devoir.qcm},idEleve:function(){return idEleve}}})}function showSaisiesCdt(elemProg){var modalInstance=$uibModal.open({templateUrl:"modules/notes/liste-saisies-cdt-element-programme-template.html",controller:"ElemProgCdtSaisiesCtrl as elemProgCdtSaisie",backdrop:!1,size:"lg",resolve:{elemProg:function(){return elemProg},idEleve:function(){return idEleve}}});modalInstance.result.then(function(){})}var vm=this;vm.refesh=refresh,vm.close=close,vm.isExamenBlanc=isExamenBlanc,vm.isDispense=isDispense,vm.isAbsent=isAbsent,vm.showSaisiesCdt=showSaisiesCdt,vm.parseStringToInteger=parseStringToInteger,vm.openQCM=openQCM,vm.devoir=devoir,vm.discipline=discipline,vm.parametrage=parametrage,vm.Auth=Auth,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("ElemProgCdtSaisiesCtrl",["$uibModalInstance","elemProg","idEleve","CahierDeTexteService","Notification",function($uibModalInstance,elemProg,idEleve,CahierDeTexteService,Notification){function refresh(){vm.promiseLoading=CahierDeTexteService.liensCdtElemProg(idEleve,elemProg.idElemProg).then(function(datas){vm.tabSaisiesCdt=datas.saisiesCahierDeTextes},function(error){Notification.notify("Élément de programme","Une erreur s'est produite lors de la récupération de la liste des saisies de cahier de textes associées ","error","icon-ed_note")})}function close(){$uibModalInstance.close()}var vm=this;vm.refesh=refresh,vm.close=close,vm.elemProg=elemProg,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("NotesEditionCtrl",["$scope","$uibModalInstance","periode","periodesReleve","options","constantesNotes","SaisieNotesService","ModuleService",function($scope,$uibModalInstance,periode,periodesReleve,options,constantesNotes,SaisieNotesService,ModuleService){function calcMoyenneEleve(){var lesEleves=[];return angular.forEach(SaisieNotesService.data,function(el){if(angular.isDefined(el.eleve)){var pEl={id:el.eleve.id,moyenne:el.moyenne};lesEleves.push(pEl)}}),lesEleves}function setCodePeriode(codePeriodeCourant,isPeriodeReleve){angular.isDefined(isPeriodeReleve)&&"R"===isPeriodeReleve?vm.additionalData.avecPeriodeReleve=!0:vm.additionalData.avecPeriodeReleve=!1,vm.additionalData.codePeriode=codePeriodeCourant}function close(){$uibModalInstance.dismiss()}var vm=this;vm.classe=options.classe,vm.typeEntity=vm.classe.type,vm.idEntity=vm.classe.id,vm.options=options,vm.periode=periode,vm.periodesReleve=periodesReleve,vm.constantesNotes=constantesNotes;var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,vm.additionalData={sousMatiere:"1",codePeriode:vm.periode.codePeriode,codeMatiere:vm.options.matiere.code,codeSousMatiere:vm.options.matiere.codeSSMatiere,triEleve:vm.options.triEleve,lesEleves:JSON.stringify(calcMoyenneEleve())},vm.setCodePeriode=setCodePeriode,vm.close=close}]),angular.module("edsiteApp.CarnetNotes").controller("EditNoteCtrl",["$scope","$uibModalInstance","$timeout","eleve","devoir","periode","periodes","options","SaisieNotesService","moment","Notification","$uibModal","lodash","CarnetNotesService","UserService","periodesRelevees",function($scope,$uibModalInstance,$timeout,eleve,devoir,periode,periodes,options,SaisieNotesService,moment,Notification,$uibModal,lodash,CarnetNotesService,UserService,periodesRelevees){function openDate($event){$event.preventDefault(),$event.stopPropagation(),vm.dateOpened=!0}function close(){$uibModalInstance.close()}function checkDateValid(dateNote){vm.dateInvalid=!1,moment(dateNote).isBetween(vm.periode.dateDebut,vm.periode.dateFin)||moment(dateNote).isSame(vm.periode.dateDebut)||moment(dateNote).isSame(vm.periode.dateFin)||(vm.dateInvalid=!0)}function submitForm(isValid,devoir){vm.dateInvalid||isValid&&vm.save(devoir)}function save(note){note.date=moment(note.date).format("YYYY-MM-DD"),$uibModalInstance.close(note)}function deleteNote(){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'une note",config.message="Confirmer la suppression de la note ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){var idNote=eleve.devoirs[devoir.id].idNote;eleve.devoirs[devoir.id]={},eleve.devoirs[devoir.id].idNote=idNote,Notification.notify("Note","Votre note a bien été supprimée","success","icon-ed_note"),$uibModalInstance.close()})}function setNote(noteValeur){vm.note.notationLettre?vm.note.lettre=noteValeur:vm.note.note=noteValeur}function setAbsence(){setNote(CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS)}function setDispense(){setNote(CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP)}function setNoteLettre(noteLettre){setNote(noteLettre)}var vm=this,defaultNote={note:"",date:new Date(devoir.date),coef:devoir.coef,noteSur:devoir.noteSur,notationLettre:devoir.notationLettre,nonSignificatif:devoir.nonSignificatif,ccf:devoir.ccf};vm.note=eleve.devoirs[devoir.id]?eleve.devoirs[devoir.id]:{},vm.note=angular.copy(vm.note),vm.note=lodash.defaults(vm.note,defaultNote),vm.deleteNote=deleteNote,vm.save=save,vm.openDate=openDate,vm.close=close,vm.submitForm=submitForm,vm.setAbsence=setAbsence,vm.setDispense=setDispense,vm.setNoteLettre=setNoteLettre,vm.checkDateValid=checkDateValid,vm.periodesRelevees=periodesRelevees,vm.periode=periode,vm.options=options,vm.dateOptions={formatYear:"yy",startingDay:1},vm.format="dd/MM/yyyy",$scope.minDate=new Date(vm.periode.dateDebut),$scope.maxDate=new Date(vm.periode.dateFin),vm.note.date=new Date(vm.note.date),UserService.getParametrages().then(function(data){vm.notesLettres=data.note.notesLettres,$timeout(function(){angular.element("#inputNote").focus()})})}]),angular.module("edsiteApp.CarnetNotes").factory("SaisieNotesService",["lodash","UserService","CarnetNotesService",function(lodash,UserService,CarnetNotesService){function calculMoyenneToutesLesNotes(matiere,toutesLesNotes,codePeriode){if(!(angular.isUndefined(toutesLesNotes)||toutesLesNotes.length<=0)){var isExBlanc=angular.isDefined(codePeriode)&&codePeriode.length>4&&"X"===codePeriode[4],notes=[];notes=""!==matiere.codeSSMatiere?lodash.where(toutesLesNotes,{codeMatiere:matiere.code,codeSSMatiere:matiere.codeSSMatiere}):lodash.where(toutesLesNotes,{codeMatiere:matiere.code});var totalNote=0,totalCoef=0;lodash.forEach(notes,function(eleveNote){if(""!==eleveNote.note&&!eleveNote.notationLettre){var note=Number(eleveNote.note);lodash.isNumber(note)&&lodash.isFinite(note)&&(!eleveNote.nonSignificatif||isExBlanc)&&lodash.isEmpty(eleveNote.lettre)&&(totalCoef+=Number(eleveNote.coef),totalNote+=Number(note)/Number(eleveNote.noteSur)*Number(eleveNote.coef))}});var moyenne=totalNote/totalCoef,paramEtab=lodash.find(service.etabsParams,{id:service.currentClasse.etabId});return moyenne*=angular.isDefined(paramEtab)&&angular.isDefined(paramEtab.moyenneSur)?parseInt(paramEtab.moyenneSur):20,moyenne=moyenne.toFixed(2)}}function calculMoyennePeriodeXR(periode,matiere,eleve){var devoirs=eleve.devoirs;if("R"===periode.codePeriode[4]&&"H"!==periode.codePeriode[0]&&(devoirs=lodash.filter(eleve.devoirs,function(devoir){return devoir.date<=periode.dateFin&&devoir.date>=periode.dateDebut})),0===matiere.avecSousMatiere)return calculMoyenneToutesLesNotes(matiere,devoirs,periode.codePeriode);if(CONSTANTES.MOYENNE_MATIERE.TOUTES_LES_NOTES===matiere.calculSousMatiere)return calculMoyenneToutesLesNotes(matiere,devoirs,periode.codePeriode);var sousMatieres=lodash.where(periode.matieres,{code:matiere.code,avecSousMatiere:0}),totalCoef=0,totalSousMoyenne=0;lodash.forEach(sousMatieres,function(ssMat){totalSousMoyenne+=calculMoyennePeriodeXR(periode,ssMat,eleve)*ssMat.coef,totalCoef+=ssMat.coef});var moyenne=totalSousMoyenne/totalCoef;return moyenne=moyenne.toFixed(2)}function calculMoyenneDeMoyennePeriodeXR(periode,matiere,eleve){var periodesReleves=lodash.filter(service.periodes,function(releve){return lodash.startsWith(releve.codePeriode,periode.codePeriode+"R")}),totalCoefReleve=0,totalMoyenneReleves=0;lodash.forEach(periodesReleves,function(periodeReleve){var moyReleve=calculMoyennePeriodeXR(periodeReleve,matiere,eleve)*periodeReleve.coef;lodash.isNumber(moyReleve)&&lodash.isFinite(moyReleve)&&(totalMoyenneReleves+=moyReleve,totalCoefReleve+=periodeReleve.coef)});var moyenneBulletin=totalMoyenneReleves/totalCoefReleve;return moyenneBulletin=moyenneBulletin.toFixed(2)}function calculMoyenneDesSSMatReleve(periode,matiere,eleve){var sousMatieres=lodash.where(periode.matieres,{code:matiere.code,avecSousMatiere:0}),totalCoef=0,totalSousMoyenne=0;lodash.forEach(sousMatieres,function(ssMat){var moySSMat=calculMoyennePeriodeBulletin(service.currentClasse,periode,ssMat,eleve)*ssMat.coef;lodash.isNumber(moySSMat)&&lodash.isFinite(moySSMat)&&(totalSousMoyenne+=moySSMat,totalCoef+=ssMat.coef)});var moyenneBulletin2=totalSousMoyenne/totalCoef;return moyenneBulletin2=moyenneBulletin2.toFixed(2)}function calculMoyennePeriodeBulletin(classe,periode,matiere,eleve){return 0===matiere.avecSousMatiere?angular.isUndefined(classe.pcpMoyPeriode)||CONSTANTES.MOYENNE_PERIODE.TOUTES_LES_NOTES===classe.pcpMoyPeriode?calculMoyenneToutesLesNotes(matiere,lodash.filter(eleve.devoirs,function(devoir){return angular.isDefined(devoir.idPeriode)&&devoir.idPeriode.indexOf(periode.codePeriode)>=0})):calculMoyenneDeMoyennePeriodeXR(periode,matiere,eleve):CONSTANTES.MOYENNE_PERIODE.TOUTES_LES_NOTES===classe.pcpMoyPeriode?CONSTANTES.MOYENNE_MATIERE.TOUTES_LES_NOTES===matiere.calculSousMatiere?calculMoyenneToutesLesNotes(matiere,lodash.filter(eleve.devoirs,function(devoir){return angular.isDefined(devoir.idPeriode)&&devoir.idPeriode.indexOf(periode.codePeriode)>=0})):calculMoyenneDesSSMatReleve(periode,matiere,eleve):CONSTANTES.MOYENNE_MATIERE.SOUS_MATIERE===classe.pcpMoyMatiere?calculMoyenneDesSSMatReleve(periode,matiere,eleve):calculMoyenneDeMoyennePeriodeXR(periode,matiere,eleve)}function calculMoyenneDesMoyennesPeriodes(matiere,eleve){var periodes=lodash.filter(service.periodes,{sousPeriode:0});lodash.remove(periodes,{codePeriode:CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE});var totalCoef=0,totalMoyenne=0;lodash.forEach(periodes,function(per){var moyennePeriode=calculMoyennePeriodeBulletin(service.currentClasse,per,matiere,eleve)*per.coef;isNaN(moyennePeriode)||(totalMoyenne+=moyennePeriode,totalCoef+=per.coef)});var moyenneDesPeriodes=totalMoyenne/totalCoef;return moyenneDesPeriodes=moyenneDesPeriodes.toFixed(2)}function calculMoyenneAnnee(classe,periode,matiere,eleve){return 0===matiere.avecSousMatiere?CONSTANTES.MOYENNE_PERIODE.TOUTES_LES_NOTES===classe.pcpMoyAnnuelle?calculMoyenneToutesLesNotes(matiere,eleve.devoirs):calculMoyenneDesMoyennesPeriodes(matiere,eleve):CONSTANTES.MOYENNE_PERIODE.TOUTES_LES_NOTES===classe.pcpMoyAnnuelle?CONSTANTES.MOYENNE_MATIERE.SOUS_MATIERE===classe.pcpMoyMatiere?calculMoyenneDesSSMatReleve(periode,matiere,eleve):calculMoyenneToutesLesNotes(matiere,eleve.devoirs):CONSTANTES.MOYENNE_MATIERE.SOUS_MATIERE===classe.pcpMoyMatiere?calculMoyenneDesSSMatReleve(periode,matiere,eleve):calculMoyenneDesMoyennesPeriodes(periode,eleve)}var service={},CONSTANTES={MOYENNE_MATIERE:{SOUS_MATIERE:1,TOUTES_LES_NOTES:2},MOYENNE_PERIODE:{RELEVE:1,TOUTES_LES_NOTES:2}};return service.setColumns=function(columns){service.columns=columns},service.setData=function(data){service.data=data},service.setPeriodes=function(periodes){service.periodes=periodes},service.setCurrentPeriode=function(periode){service.currentPeriode=periode},service.setEtabsParam=function(etabsParams){service.etabsParams=etabsParams},service.setCurrentMatiere=function(matiere){service.currentMatiere=matiere},service.setCurrentClasse=function(classe){service.currentClasse=classe},service.colMoyenne=function(instance,td,row,col,prop,value,cellProperties){var data=instance.getData();if(!(angular.isUndefined(data)||data.length<=0||angular.isUndefined(service.columns))&&0===col&&0!==row){var eleve=data[row],moyenne=service.calcMoyenneEleve(eleve);moyenne=lodash.isFinite(moyenne)?moyenne:"",td.innerHTML=lodash.isFinite(moyenne)?moyenne.toFixed(2):"";var paramEtab=lodash.find(service.etabsParams,{id:service.currentClasse.etabId}),laMoy=10;angular.isDefined(paramEtab)&&angular.isDefined(paramEtab.moyenneSur)&&(laMoy=parseInt(paramEtab.moyenneSur)/2),td.className=laMoy>moyenne?"moyenne-value warning":"moyenne-value success",eleve.moyenne=moyenne}},service.calcMoyenneEleve=function(eleve){var moyenne=0;return moyenne=service.currentPeriode.codePeriode===CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE?calculMoyenneAnnee(service.currentClasse,service.currentPeriode,service.currentMatiere,eleve):"X"===service.currentPeriode.codePeriode[4]||"R"===service.currentPeriode.codePeriode[4]&&"H"!==service.currentPeriode.codePeriode[0]?calculMoyennePeriodeXR(service.currentPeriode,service.currentMatiere,eleve):calculMoyennePeriodeBulletin(service.currentClasse,service.currentPeriode,service.currentMatiere,eleve),Number(moyenne)},service.calculMoyenneDevoir=function(instance,td,row,col,prop,value,cellProperties){var data=instance.getData();if(!angular.isUndefined(data)&&!angular.isUndefined(service.columns)&&!service.columns[col].notationLettre){var devoirId=service.columns[col].id,noteSur=Number(service.columns[col].noteSur),total=lodash.reduce(data,function(total,n,key){if(lodash.isEmpty(n))return total;try{if(""===n.devoirs[devoirId].note)return total;var note=Number(n.devoirs[devoirId].note);lodash.isNumber(note)&&lodash.isFinite(note)&&!n.devoirs[devoirId].nonSignificatif&&lodash.isEmpty(n.devoirs[devoirId].lettre)&&(total.note+=note,total.nbTotal++)}catch(e){}return total},{note:0,nbTotal:0});value=total.note/total.nbTotal,td.innerHTML=lodash.isFinite(value)?value.toFixed(2):"",td.className=td.innerHTML<noteSur/2?"moyenne-value warning":"moyenne-value success"}},service.calculMoyenneClasse=function(instance,td,row,col,prop,value,cellProperties){var data=instance.getDataAtCol(col),infos=lodash.reduce(data,function(result,current,idx){if(0!==current&&!current)return result;var moyenne=Number(current);return lodash.isNumber(moyenne)&&lodash.isFinite(moyenne)&&(result.total+=Number(moyenne),result.nbTotal++),result},{total:0,nbTotal:0});value=infos.total/infos.nbTotal,td.innerHTML=lodash.isFinite(value)?value.toFixed(2):"",td["class"]="info"},service.noteNumericValidatorSync=function(value,devoir){var note=value.trim();if(lodash.startsWith(note,"(")&&lodash.endsWith(note,")")&&(note=note.replace("(",""),note=note.replace(")","")),note=Number(note),lodash.isNumber(note)&&lodash.isFinite(note)){if(0>note&&!devoir.noteNegative)return!1;if(note>devoir.noteSur)return!1}else if(!lodash.contains(["abs","disp"],value))return!1;return!0},service.noteLettreValidatorSync=function(value,tabNotesLettres){var note=value.trim();return""===note?!0:note.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.ABS||note.toLowerCase()===CarnetNotesService.CONSTANTES.LETTRES_NOTES.DISP?!0:-1!==lodash.indexOf(tabNotesLettres,note)},service}]),angular.module("edsiteApp.CarnetNotes").factory("SaisieAppreciationsService",["EDHttp","$q","lodash",function(EDHttp,$q,lodash){var service={},SEPARATEUR="¤";return service.CODE_MATIERE_SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},service.get=function(typeUser,idUser,entity,codeMatiere,codeSousmatiere){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere,codePeriode="ALL";angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/appreciations";return new EDHttp({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.save=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSousmatiere,eleves,appClasse){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={eleves:eleves,appreciationClasse:appClasse},baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/appreciations";return new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.duplication=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSousmatiere,codePeriodeDestination){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var data={};data.periodeDestination={codePeriode:codePeriodeDestination};var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/appreciations/duplication";return new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.generateEtatAppreciation=function(typeUser,idUser,entity,eleves,params){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={};data.eleves=eleves,data.parametres=params;var baseUrl="enseignants/"+entity.type+"/"+entity.id+"/appreciations/editionNotes";return new EDHttp({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.Note").directive("displayNote",["$log",function($log){return{restrict:"AE",scope:{note:"=",devoir:"=",periode:"="},templateUrl:"modules/notes/display-note-template.html",controller:"DisplayNoteCtrl",link:function(scope,element,attrs){}}}]).controller("DisplayNoteCtrl",["$scope",function($scope){function infosNote(devoir,note){var texte="";return texte+=devoir.typeDevoir.libelle,texte+="<br/>"+devoir.libelle,texte+="<br/>du "+note.date}function isExamenBlanc(periode){return periode.codePeriode?periode.codePeriode.length>4&&"X"===periode.codePeriode[4]:void 0}$scope.isExamenBlanc=isExamenBlanc,$scope.infosNote=infosNote}]),angular.module("edsiteApp.CarnetNotes").controller("ajoutElemProgModalCtrl",["$uibModalInstance","prof","devoir","paramsLSU","idCycleEtab","entity","periode",function($uibModalInstance,prof,devoir,paramsLSU,idCycleEtab,entity,periode){function close(){$uibModalInstance.close()}var vm=this;vm.paramsLSU=paramsLSU,vm.idCycleEtab=idCycleEtab,vm.selectedDevoir=devoir,vm.prof=prof,vm.libelleCycle=vm.paramsLSU.libelleCycle,vm.entity=entity,vm.periode=periode,vm.close=close}]),angular.module("edsiteApp.CarnetNotes").controller("SaisieAppreciationsPPCtrl",["$timeout","$rootScope","$scope","$q","$routeParams","$sessionStorage","Utils","CarnetNotesService","lodash","SaisieAppreciationsPPService","ModuleService","Auth","Notification","UserService","$filter","AppreciationsPredefiniesService","base64encodeFilter","base64decodeFilter","$uibModal","VieScolaireService",function($timeout,$rootScope,$scope,$q,$routeParams,$sessionStorage,Utils,CarnetNotesService,lodash,SaisieAppreciationsPPService,ModuleService,Auth,Notification,UserService,$filter,AppreciationsPredefiniesService,base64encodeFilter,base64decodeFilter,$uibModal,VieScolaireService){function prolexis(form){var listAppToCheck=[];listAppToCheck.push({src:document.getElementById("appCtrl.searchAppPredefiniePP"),type:"txt",label:"Professeur principal"}),listAppToCheck.push({src:document.getElementById("appCtrl.searchAppPredefinieVS"),type:"txt",label:"Vie scolaire"}),listAppToCheck.push({src:document.getElementById("appCtrl.searchAppPredefinieCE"),type:"txt",label:"Chef d'établissement"}),listAppToCheck.push({src:document.getElementById("appCtrl.searchAppPredefinieCN"),type:"txt",label:"Compétences numériques"}),listAppToCheck.push({src:document.getElementById("appCtrl.searchAppClasse"),type:"txt",label:"Appréciation générale de la classe"}),DiagPlWs.analyze(listAppToCheck),vm.formGlobalIsUpdated=!0,form.$setDirty(),vm.setChange()}function init(){if(CarnetNotesService.observeEtatLoadingEleveNotesDirective().then(null,null,function(inLoading){vm.inLoadingDirectiveEleveNotes=inLoading}),VieScolaireService.observeEtatLoadingEleveVSDirective().then(null,null,function(inLoading){vm.inLoadingDirectiveEleveVS=inLoading}),vm.moduleCarnetCorrespondanceActif=ModuleService.isModuleEnabled(ModuleService.CODES.CARNET_CORRESPONDANCE),Auth.role()===Auth.TYPE_USER.ENSEIGNANT)vm.canEditAppCE=!1,vm.canEditAppPP=!0,vm.canEditAppVS=!0,angular.isDefined($scope.noteCtrl.classe)&&angular.isDefined($scope.noteCtrl.classe.cycle)&&$scope.noteCtrl.classe.cycle.search("3")>-1&&(vm.canEditAppCN=!0),vm.canEditMentionDuConseil=!0,vm.canEditAppClasse=!0,refresh();else if(Auth.role()===Auth.TYPE_USER.PERSONNEL){vm.moduleNotesActif=ModuleService.isModuleEnabled(ModuleService.CODES.NOTES),vm.moduleVSActif=ModuleService.isModuleEnabled(ModuleService.CODES.VIE_SCOLAIRE),vm.canEditAppCE=!0,vm.canEditAppPP=!0,vm.canEditAppVS=!0,vm.canEditMentionDuConseil=!0,vm.canEditAppClasse=!0;var idEntity=Number($routeParams.idEntity);if(idEntity){var typeEntity=$filter("translateTypeUserToShortcut")($routeParams.typeEntity);typeEntity===vm.TYPES_ENTITIES.CLASSE&&UserService.getClasseById(idEntity).then(function(classe){$scope.noteCtrl.classePP=classe,$scope.noteCtrl.periodesPP=classe.periodes,angular.isDefined($scope.noteCtrl.classePP)&&angular.isDefined($scope.noteCtrl.classePP.cycle)&&$scope.noteCtrl.classePP.cycle.search("3")>-1&&(vm.canEditAppCN=!0),angular.isUndefined($scope.noteCtrl.allPeriodes)&&($scope.noteCtrl.allPeriodes=$scope.noteCtrl.periodesPP),initPeriode(moment().format("YYYY-MM-DD"),$scope.noteCtrl.periodesPP),refresh()})}}}function getLibelleConseil(periode){return CarnetNotesService.getLibelleConseil(periode)}function appreciationsPredefiniesPPCallBack(params){var defer=$q.defer(),resultat=lodash.filter(vm.appreciationsPredefiniesPP,function(app){var trouve=!1;return(-1!==app.libelle.toLowerCase().indexOf(params.query.toLowerCase())||-1!==app.code.toLowerCase().indexOf(params.query.toLowerCase()))&&(trouve=!0),trouve});return defer.resolve(resultat),defer.promise}function appreciationsPredefiniesCECallBack(params){var defer=$q.defer(),resultat=lodash.filter(vm.appreciationsPredefiniesCE,function(app){var trouve=!1;return(-1!==app.libelle.toLowerCase().indexOf(params.query.toLowerCase())||-1!==app.code.toLowerCase().indexOf(params.query.toLowerCase()))&&(trouve=!0),trouve});return defer.resolve(resultat),defer.promise}function displayAppreciationsPredefinies(typeApp){var modalInstance,appreciationsPredefinies=[],parametragesAppPredef={},typeAppreciation="";typeApp===AppreciationsPredefiniesService.TYPE_APP.PP&&(appreciationsPredefinies=angular.copy(vm.appreciationsPredefiniesPP),parametragesAppPredef=parametragesAppPP,typeAppreciation=AppreciationsPredefiniesService.TYPE_APP.PP),typeApp===AppreciationsPredefiniesService.TYPE_APP.CE&&(appreciationsPredefinies=angular.copy(vm.appreciationsPredefiniesCE),parametragesAppPredef=parametragesAppCE,typeAppreciation=AppreciationsPredefiniesService.TYPE_APP.CE),typeApp===AppreciationsPredefiniesService.TYPE_APP.VS&&(appreciationsPredefinies=angular.copy(vm.appreciationsPredefiniesVS),parametragesAppPredef=parametragesAppVS,typeAppreciation=AppreciationsPredefiniesService.TYPE_APP.VS),typeApp===AppreciationsPredefiniesService.TYPE_APP.CN&&(appreciationsPredefinies=angular.copy(vm.appreciationsPredefiniesCN),parametragesAppPredef=parametragesAppCN,typeAppreciation=AppreciationsPredefiniesService.TYPE_APP.CN),modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/appreciations-predefinies/liste-appreciations-predefinies.html",controller:"AppreciationsPredefiniesCtrl as appPredefiniesCtrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{user:function(){var user={type:vm.typeUser,id:vm.idUser,entity:$scope.noteCtrl.classePP};return user},appreciationsPredef:function(){return{appreciations:appreciationsPredefinies,parametrage:parametragesAppPredef,type:typeAppreciation}},entity:function(){return $scope.noteCtrl.classePP},mode:function(){return AppreciationsPredefiniesService.MODES.GESTION}}}),modalInstance.result.then(function(result){vm.appreciationsPredefinies=result})}function initPeriode(date,periodes){angular.forEach(periodes,function(p){moment(date).isBetween(p.dateDebut,p.dateFin)&&angular.isUndefined($scope.noteCtrl.periodePP)&&($scope.noteCtrl.periodePP=p)})}function loadElevesPP(){vm.promiseLoading=SaisieAppreciationsPPService.getEleves(Auth.role(),Auth.idUser(),$scope.noteCtrl.classePP.type,$scope.noteCtrl.classePP.id,vm.periodeSelected.codePeriode).then(function(data){vm.parametrage.appreciations=data.parametrage.appreciations[0],vm.parametrage.PPModifTout=data.parametrage.PPModifTout,vm.parametrage.longueurMaxAppPP=data.parametrage.longueurMaxAppPP,data.appreciationGenerale.text=base64decodeFilter(data.appreciationGenerale.text),vm.appGeneraleClasse=data.appreciationGenerale,vm.backupAppGeneraleClasse=angular.copy(data.appreciationGenerale),Auth.role()===Auth.TYPE_USER.ENSEIGNANT&&(vm.canEditAppVS=data.parametrage.PPModifVS,vm.canEditAppClasse=data.parametrage.saisieAppClasse),vm.parametrage.mentions=lodash.sortBy(data.parametrage.mentions,"numLigne"),vm.eleves=data.eleves,vm.eleves=lodash.chain(vm.eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.ordreArrivee}).value(),vm.eleves[0].isFirst=!0,vm.eleves[vm.eleves.length-1].isLast=!0,selectEleve(vm.eleves[0])})}function refresh(){var lesPromises=[AppreciationsPredefiniesService.get(Auth.idUser(),$scope.noteCtrl.classePP,AppreciationsPredefiniesService.TYPE_APP.PP).then(function(lesAppreciations){vm.appreciationsPredefiniesPP=lesAppreciations.appreciations;var appPredefPP=angular.copy(vm.appreciationsPredefiniesPP);lodash.forEach(appPredefPP,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefiniesPP=appPredefPP,parametragesAppPP=lesAppreciations.parametrage})];vm.canEditAppCE&&lesPromises.push(AppreciationsPredefiniesService.get(Auth.idUser(),$scope.noteCtrl.classePP,AppreciationsPredefiniesService.TYPE_APP.CE).then(function(lesAppreciations){vm.appreciationsPredefiniesCE=lesAppreciations.appreciations;var appPredefCE=angular.copy(vm.appreciationsPredefiniesCE);lodash.forEach(appPredefCE,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefiniesCE=appPredefCE,parametragesAppCE=lesAppreciations.parametrage})),vm.canEditAppVS&&lesPromises.push(AppreciationsPredefiniesService.get(Auth.idUser(),$scope.noteCtrl.classePP,AppreciationsPredefiniesService.TYPE_APP.VS).then(function(lesAppreciations){vm.appreciationsPredefiniesVS=lesAppreciations.appreciations;var appPredefVS=angular.copy(vm.appreciationsPredefiniesVS);lodash.forEach(appPredefVS,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefiniesVS=appPredefVS,parametragesAppVS=lesAppreciations.parametrage})),vm.canEditAppCN&&lesPromises.push(AppreciationsPredefiniesService.get(Auth.idUser(),$scope.noteCtrl.classePP,AppreciationsPredefiniesService.TYPE_APP.CN).then(function(lesAppreciations){vm.appreciationsPredefiniesCN=lesAppreciations.appreciations;var appPredefCN=angular.copy(vm.appreciationsPredefiniesCN);lodash.forEach(appPredefCN,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefiniesCN=appPredefCN,parametragesAppCN=lesAppreciations.parametrage})),vm.promiseContent=$q.all(lesPromises),angular.isDefined($scope.noteCtrl.classePP)&&angular.isDefined($scope.noteCtrl.periodePP)&&(vm.periodeSelected=angular.copy($scope.noteCtrl.periodePP),vm.relevesPeriodeActuelle=lodash.filter($scope.noteCtrl.allPeriodes,function(periodeApp){return periodeApp.codePeriode.substring(0,4)===vm.periodeSelected.codePeriode.substring(0,4)}),loadElevesPP())}function cancel(form){$rootScope.navigationDisabled=!1,vm.currentAppCE={},vm.currentAppPP={},vm.currentAppVS={},vm.currentAppCN={},vm.appGeneraleClasse={},$timeout(function(){vm.currentAppPP=angular.copy(vm.currentEleve.appreciationPP),vm.currentAppCE=angular.copy(vm.currentEleve.appreciationCE),vm.currentAppVS=angular.copy(vm.currentEleve.appreciationVS),vm.currentAppCN=angular.copy(vm.currentEleve.appreciationCN),vm.appGeneraleClasse=angular.copy(vm.backupAppGeneraleClasse),angular.isDefined(vm.currentEleve.mentionDuConseil)&&(vm.currentMention=lodash.find(vm.parametrage.mentions,{id:Number(vm.currentEleve.mentionDuConseil.id)})),vm.limitReached=!1,vm.limitReachedCE=!1,vm.limitReachedVS=!1,vm.limitReachedCN=!1,vm.limitReachedAppClasse=!1},0),form.$setPristine()}function selectEleve(eleve,formConseil){if(vm.displayListEleve=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,vm.appGeneraleClasse=angular.copy(vm.backupAppGeneraleClasse),angular.isDefined(formConseil)&&formConseil.$setPristine(),$timeout(function(){selectEleve(eleve)},500)},cancelCallback=function(notice){notice.remove()};return void Utils.displayWarningEditRunning(okCallback,cancelCallback)}lodash.forEach(vm.eleves,function(elv){elv.selected=!1}),eleve.selected=!0,vm.currentEleve=eleve,vm.currentAppCE=angular.copy(eleve.appreciationCE),vm.currentAppPP=angular.copy(eleve.appreciationPP),vm.currentAppVS=angular.copy(eleve.appreciationVS),vm.currentAppCN=angular.copy(eleve.appreciationCN),angular.isDefined(eleve.mentionDuConseil)?vm.currentMention=lodash.find(vm.parametrage.mentions,{id:Number(eleve.mentionDuConseil.id)}):vm.currentMention=void 0}function goToNextEleve(eleve,formConseil){var idx=lodash.findIndex(vm.eleves,{id:eleve.id});(-1===idx||idx===vm.eleves.length-1)&&(idx=vm.eleves.length-2),selectEleve(vm.eleves[idx+1],formConseil)}function goToPrevEleve(eleve,formConseil){var idx=lodash.findIndex(vm.eleves,{id:eleve.id});(-1===idx||0===idx)&&(idx=1),selectEleve(vm.eleves[idx-1],formConseil)}function saveAndNext(form,_eleve,appPP,appVS,appCE,appCN,avisConseil,appGenClasse){vm.prolexisEnable&&(document.getElementById("appCtrl.searchAppPredefiniePP")&&document.getElementById("appCtrl.searchAppPredefiniePP").value&&(appPP.text=document.getElementById("appCtrl.searchAppPredefiniePP").value),
document.getElementById("appCtrl.searchAppPredefinieVS")&&document.getElementById("appCtrl.searchAppPredefinieVS").value&&(appVS.text=document.getElementById("appCtrl.searchAppPredefinieVS").value),document.getElementById("appCtrl.searchAppPredefinieCE")&&document.getElementById("appCtrl.searchAppPredefinieCE").value&&(appCE.text=document.getElementById("appCtrl.searchAppPredefinieCE").value),document.getElementById("appCtrl.searchAppPredefinieCN")&&document.getElementById("appCtrl.searchAppPredefinieCN").value&&(appCN.text=document.getElementById("appCtrl.searchAppPredefinieCN").value),document.getElementById("appCtrl.searchAppClasse")&&document.getElementById("appCtrl.searchAppClasse").value&&(appGenClasse.text=document.getElementById("appCtrl.searchAppClasse").value));var eleve=angular.copy(_eleve);eleve.appreciationPP=appPP,eleve.appreciationCE=appCE,eleve.appreciationVS=appVS,eleve.appreciationCN=appCN,angular.isUndefined(avisConseil)||null===avisConseil?eleve.mentionDuConseil=void 0:eleve.mentionDuConseil=avisConseil,form.$dirty?vm.promiseLoading=SaisieAppreciationsPPService.saveEleve(Auth.role(),Auth.idUser(),$scope.noteCtrl.classePP.type,$scope.noteCtrl.classePP.id,vm.periodeSelected.codePeriode,eleve,appGenClasse).then(function(eleve){vm.backupAppGeneraleClasse=angular.copy(appGenClasse),$rootScope.navigationDisabled=!1,_eleve.appreciationPP=eleve.appreciationPP,_eleve.appreciationCE=eleve.appreciationCE,_eleve.appreciationVS=eleve.appreciationVS,_eleve.appreciationCN=eleve.appreciationCN,_eleve.mentionDuConseil=eleve.mentionDuConseil,vm.goToNextEleve(eleve),form.$setPristine()},function(error){Notification.notify("Sauvegarde d'une appréciation","Une erreur s'est produite lors de la sauvegarde de votre appréciation","error","icon-ed_note")}):vm.goToNextEleve(eleve)}function onEditAppreciation(data,idxApp,codePeriode,codeMatiere,codeSSMatiere){var eleve=lodash.find(vm.eleves,{selected:!0});if(!angular.isUndefined(eleve)){var codeApp="APP"+idxApp;return SaisieAppreciationsPPService.editAppreciation(Auth.role(),Auth.idUser(),$scope.noteCtrl.classePP.type,$scope.noteCtrl.classePP.id,codePeriode,codeMatiere,codeSSMatiere,eleve.id,codeApp,data).then(function(data){Notification.notify("Notification","L'appreciation a été sauvegardée","success","icon-ed_note")},function(error){Notification.notify("Attention","Une erreur s'est produite lors de la sauvegarde de votre appréciation","error","icon-ed_note")})}}function setChange(){$rootScope.navigationDisabled=!0}function print(){window.print()}function printAppreciations(){if(!angular.isUndefined(vm.parametrage)){var tabEleves=lodash.map(vm.eleves,function(eleveApp){var elv={};return elv.eleve=eleveApp,elv.appreciations={PP:elv.eleve.appreciationPP.text,CE:elv.eleve.appreciationCE.text,VS:elv.eleve.appreciationVS.text,CN:elv.eleve.appreciationCN.text,"mention du conseil":""},angular.isDefined(elv.eleve.mentionDuConseil)&&(elv.appreciations["mention du conseil"]=elv.eleve.mentionDuConseil.libelle),elv}),params={};params.appreciations=vm.parametrage.appreciations,params.entityLibelle=$scope.noteCtrl.classePP.libelle,angular.isUndefined(params.entityLibelle)&&(params.entityLibelle=$scope.noteCtrl.classePP.classeLibelle),params.periodeLibelle=vm.periodeSelected.libelle,params.periodeLibelleCourt=vm.periodeSelected.libelleCourt;var data={parametres:params,eleves:tabEleves};return{data:base64encodeFilter(JSON.stringify(data))}}}function printAppreciationsClasse(){var params={};params.effectif=vm.eleves.length,params.periodeLibelle=vm.periodeSelected.libelle,params.periodeLibelleCourt=vm.periodeSelected.libelleCourt;var dataEncoded={parametres:params};return{data:base64encodeFilter(JSON.stringify(dataEncoded)),codePeriode:vm.periodeSelected.codePeriode}}function selectPeriode(periode){if(vm.statusDropdown.isPeriodeOpen=!1,$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectPeriode(periode)},500)},cancelCallback=function(notice){notice.remove()};return displayWarningEditRunning(okCallback,cancelCallback),!1}vm.periodeSelected=periode,"R"!==vm.periodeSelected.codePeriode[4]||"H"===vm.periodeSelected.codePeriode[0]?($scope.noteCtrl.periodePP=vm.periodeSelected,refresh()):loadElevesPP()}function displayWarningEditRunning(okCb,cancelCb){var opts={hide:!1,cornerclass:"clickable",width:"66%",min_height:"50px",title:"Attention",text:'<p style="font-size: 1.5em">Vous n\'avez pas enregistré vos dernières saisies, si vous continuez toutes vos données non sauvegardées seront perdues.</p>',type:"info",icon:"fa fa-2x fa-exclamation-triangle",confirm:{confirm:!0,buttons:[{text:"Continuer et perdre la saisie en cours",addClass:"btn btn-warning",click:okCb},{text:"Annuler et continuer ma saisie",addClass:"btn btn-primary",click:cancelCb}]},history:{history:!1},buttons:{closer:!1,sticker:!1,labels:{close:"Fermer"}}},notice=new PNotify(opts);notice.get().click(function(){notice.remove()})}function dupliquerSaisie(){var modalInstance=$uibModal.open({templateUrl:"modules/notes/enseignant/duplication-appreciations/liste-modules-pp-duplication-appreciations.html",controller:"DuplicationAppreciationsPPCtrl as duplicationAppPPCtrl",size:"lg",resolve:{periodeCurrent:function(){var periode={codePeriode:vm.periodeSelected.codePeriode,libelle:vm.periodeSelected.libelle};return periode},user:function(){var user={type:vm.typeUser,id:vm.idUser,entity:$scope.noteCtrl.classePP};return user},droitsModule:function(){return{canEditAppPP:vm.canEditAppPP,canEditAppVS:vm.canEditAppVS,canEditAppCE:vm.canEditAppCE,canEditAppCN:vm.canEditAppCN,canEditAppClasse:vm.canEditAppClasse,canEditMentionDuConseil:vm.canEditMentionDuConseil}}}});modalInstance.result.then(function(){refresh()})}var vm=this;vm.selectEleve=selectEleve,vm.saveAndNext=saveAndNext,vm.onEditAppreciation=onEditAppreciation,vm.cancel=cancel,vm.setChange=setChange,vm.appreciationsPredefiniesPPCallBack=appreciationsPredefiniesPPCallBack,vm.appreciationsPredefiniesCECallBack=appreciationsPredefiniesCECallBack,vm.printAppreciations=printAppreciations,vm.printAppreciationsClasse=printAppreciationsClasse,vm.print=print,vm.selectPeriode=selectPeriode,vm.goToNextEleve=goToNextEleve,vm.goToPrevEleve=goToPrevEleve,vm.prolexis=prolexis,vm.displayAppreciationsPredefinies=displayAppreciationsPredefinies,vm.dupliquerSaisie=dupliquerSaisie,vm.getLibelleConseil=getLibelleConseil,vm.searchAppPredefiniePP="",vm.searchAppPredefinieCE="",vm.searchAppPredefinieVS="",vm.searchAppPredefinieCN="",vm.displayListEleve=!1,vm.typeUser=Auth.currentUser().typeCompte,vm.idUser=Auth.currentUser().id,vm.statusDropdown={isPeriodeOpen:!1},vm.viewState="notes",vm.canEditAppPP=!1,vm.canEditAppVS=!1,vm.canEditAppCE=!1,vm.canEditAppCN=!1,vm.canEditAppClasse=!1,vm.canEditMentionDuConseil=!1,vm.currentAppPP={},vm.currentAppVS={},vm.currentAppCE={},vm.currentAppCN={},vm.currentAvisConseil={},vm.currentMention={},vm.appGeneraleClasse={},vm.parametrage={},vm.TYPES_ENTITIES=CarnetNotesService.typeEntity,vm.CONSTANTES_PERIODES=CarnetNotesService.CONSTANTES.PERIODES,vm.TYPES_APP=AppreciationsPredefiniesService.TYPE_APP,vm.inLoadingDirectiveEleveNotes=!1,vm.inLoadingDirectiveEleveVS=!1;var parametragesAppPP={},parametragesAppVS={},parametragesAppCE={},parametragesAppCN={},paramNotes={};paramNotes="P"===vm.typeUser?ModuleService.getModule(ModuleService.CODES.CARNET_NOTES):ModuleService.getModule(ModuleService.CODES.CONSEIL_DE_CLASSE),vm.prolexisEnable=paramNotes.params?"1"===paramNotes.params.prolexisEnable:!1,vm.prolexisEnable&&DiagPlWs.init({sUrlProxy:"https://pprolexis.ecoledirecte.com/prolexis",sCorePath:"scripts/ext/prolexis/DiagPlWs",left:10,top:10,width:850,height:400,excludedElement:".ignore, .hidden"}),init(),$scope.$watch("noteCtrl.periodePP",function(newVal,oldVal){angular.isUndefined(newVal)||angular.isDefined(oldVal)&&newVal.codePeriode===oldVal.codePeriode||refresh()})}]),angular.module("edsiteApp.CarnetNotes").factory("SaisieAppreciationsPPService",["$http","$q","lodash","$filter","base64decodeFilter","EDHttp",function($http,$q,lodash,$filter,base64decodeFilter,EDHttp){var service={},SEPARATEUR="¤";return service.CODE_MATIERE_SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},service.getEleves=function(typeUser,idUser,typeEntity,idEntity,codePeriode){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/conseilDeClasse";return new EDHttp({method:"GET",url:baseUrl,data:{}}).then(function(response){return response.data.data.eleves&&lodash.forEach(response.data.data.eleves,function(eleve){eleve.appreciationPP.text=base64decodeFilter(eleve.appreciationPP.text),eleve.appreciationCE.text=base64decodeFilter(eleve.appreciationCE.text),eleve.appreciationVS.text=base64decodeFilter(eleve.appreciationVS.text),eleve.appreciationCN.text=base64decodeFilter(eleve.appreciationCN.text)}),response.data.data},function(error){return error})},service.editAppreciation=function(typeUser,idUser,typeEntity,idEntity,codePeriode,codeMatiere,codeSSMatiere,idEleve,codeApp,text){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSSMatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSSMatiere),service.CODE_MATIERE_SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"};var baseUrl=pTypeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/appreciations",data={},eleve={};eleve.idEleve=idEleve,eleve.appreciations=[];var appreciation={};return appreciation.code=codeApp,appreciation.contenu=$filter("base64encode")(text),eleve.appreciations.push(appreciation),data.eleves=[],data.eleves.push(eleve),new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){return response.data.data},function(error){return error})},service.saveEleve=function(typeUser,idUser,typeEntity,idEntity,codePeriode,eleve,appGenClasse){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/conseilDeClasse/eleves/"+eleve.id,appGenClasseFormate=angular.copy(appGenClasse);appGenClasseFormate.text=$filter("base64encode")(appGenClasseFormate.text);var data={};return data.appreciationGeneraleClasse=appGenClasseFormate,data.eleve=angular.copy(eleve),data.eleve.appreciationPP.text=$filter("base64encode")(data.eleve.appreciationPP.text),data.eleve.appreciationVS.text=$filter("base64encode")(data.eleve.appreciationVS.text),data.eleve.appreciationCE.text=$filter("base64encode")(data.eleve.appreciationCE.text),data.eleve.appreciationCN.text=$filter("base64encode")(data.eleve.appreciationCN.text),new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(dataServer){angular.isDefined(dataServer.data.data.appreciationPP)&&(data.eleve.appreciationPP.id=dataServer.data.data.appreciationPP.id),angular.isDefined(dataServer.data.data.appreciationVS)&&(data.eleve.appreciationVS.id=dataServer.data.data.appreciationVS.id),angular.isDefined(dataServer.data.data.appreciationCE)&&(data.eleve.appreciationCE.id=dataServer.data.data.appreciationCE.id),angular.isDefined(dataServer.data.data.appreciationCN)&&(data.eleve.appreciationCN.id=dataServer.data.data.appreciationCN.id),angular.isDefined(dataServer.data.data.mentionDuConseil)&&angular.isDefined(data.eleve.mentionDuConseil)&&(data.eleve.mentionDuConseil.id=dataServer.data.data.mentionDuConseil.id),data.eleve.appreciationPP.text=$filter("base64decode")(data.eleve.appreciationPP.text),data.eleve.appreciationCE.text=$filter("base64decode")(data.eleve.appreciationCE.text),data.eleve.appreciationVS.text=$filter("base64decode")(data.eleve.appreciationVS.text),data.eleve.appreciationCN.text=$filter("base64decode")(data.eleve.appreciationCN.text),defer.resolve(data.eleve)},function(error){defer.reject(error)}),defer.promise},service.duplicationAppreciations=function(typeUser,idUser,entity,codePeriode,codePeriodeDestination,typeAppreciation){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var data={codePeriodeDestination:codePeriodeDestination},baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/appreciations/"+typeAppreciation+"/duplication";return new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.CarnetNotes").controller("AppreciationsPredefiniesCtrl",["$uibModalInstance","$uibModal","appreciationsPredef","user","entity","mode","lodash","base64decodeFilter","base64encodeFilter","$scope","AppreciationsPredefiniesService","Notification","CacheService",function($uibModalInstance,$uibModal,appreciationsPredef,user,entity,mode,lodash,base64decodeFilter,base64encodeFilter,$scope,AppreciationsPredefiniesService,Notification,CacheService){function close(){vm.mode===AppreciationsPredefiniesService.MODES.GESTION?$uibModalInstance.close(vm.appreciationsPredefiniesBackUp):$uibModalInstance.close()}function displayAppreciationPerso(){vm.displayAppPersoActif?vm.appreciationsPredefinies=lodash.reject(vm.appreciationsPredefinies,{idAuteur:0}):vm.appreciationsPredefinies=vm.appreciationsPredefiniesBackUp,vm.totalItems=vm.appreciationsPredefinies.length}function setModeEdit(appreciation){appreciation.editable=!appreciation.editable,appreciation.editable&&(vm.appreciationCurrentBackup=angular.copy(appreciation),vm.appreciationCurrentBackup.editable=!1),appreciation.editable||(appreciation=angular.extend(appreciation,vm.appreciationCurrentBackup)),appreciation.editable||0!==appreciation.id||vm.appreciationsPredefinies.shift()}function deleteAppreciation(appreciationToDelete){var modalInstanceDuplication=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'une appréciation",config.message="Souhaitez vous vraiment supprimer cette appréciation ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceDuplication.result.then(function(){delete appreciationToDelete.libelle,vm.promiseContent=AppreciationsPredefiniesService.supprimer(vm.user.id,appreciationToDelete,entity).then(function(){lodash.remove(vm.appreciationsPredefinies,function(appreciation){return appreciation.id===appreciationToDelete.id}),lodash.remove(vm.appreciationsPredefiniesBackUp,function(appreciation){return appreciation.id===appreciationToDelete.id})},function(error){Notification.notify("Saisie des appréciations","Une erreur s'est produite lors de la suppression de votre appréciation","error","icon-ed_note")})})}function saveAppreciation(appreciationToSave){appreciationToSave.libelle=base64encodeFilter(appreciationToSave.libelle),appreciationToSave.editable=!1,0!==appreciationToSave.id?vm.promiseContent=AppreciationsPredefiniesService.update(vm.user.id,appreciationToSave,entity).then(function(reponse){235===reponse.code?(Notification.notify("Saisie des appréciations","Ce code appréciation existe déjà, veuillez en choisir un autre !","error","icon-ed_note"),angular.extend(appreciationToSave,vm.appreciationCurrentBackup)):(appreciationToSave.libelle=base64decodeFilter(reponse.data.libelle),appreciationToSave.code=reponse.data.code,vm.appreciationsPredefinies=lodash.sortBy(vm.appreciationsPredefinies,function(app){return app.code}),lodash.forEach(vm.appreciationsPredefiniesBackUp,function(app){app.id===appreciationToSave.id&&(app.libelle=appreciationToSave.libelle,app.code=appreciationToSave.code)}))},function(error){angular.extend(appreciationToSave,vm.appreciationCurrentBackup),Notification.notify("Saisie des appréciations","Une erreur s'est produite lors de la modification de votre appréciation","error","icon-ed_note")}):vm.addAppreciation(appreciationToSave)}function initNewAppreciation(){vm.appreciationsPredefinies=lodash.reject(vm.appreciationsPredefinies,{id:0}),vm.currentPage=1,vm.searchFilter="",vm.appreciationsPredefinies.unshift({libelle:"",code:"",id:0,type:vm.typeAppreciation,idAuteur:user.id,editable:!0})}function addAppreciation(newAppreciation){vm.promiseContent=AppreciationsPredefiniesService.save(vm.user.id,newAppreciation,entity).then(function(data){235===data.code?(vm.appreciationsPredefinies.shift(),Notification.notify("Saisie des appréciations","Ce code appréciation existe déjà, veuillez en choisir un autre !","error","icon-ed_note")):(CacheService.removeMatch(/.*\/appreciationsPredefinies/),AppreciationsPredefiniesService.get(vm.user.id,entity,vm.typeAppreciation).then(function(lesAppreciations){vm.appreciationsPredefinies=lesAppreciations.appreciations,lodash.forEach(vm.appreciationsPredefinies,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefiniesBackUp=angular.copy(vm.appreciationsPredefinies),vm.displayAppPersoActif=!1,vm.totalItems=vm.appreciationsPredefinies.length}))},function(error){vm.appreciationsPredefinies.shift(),Notification.notify("Saisie des appréciations","Une erreur s'est produite lors de l'ajout de votre appréciation","error","icon-ed_note")})}function selectAppreciation(appreciation){$uibModalInstance.close(appreciation)}function onChangeAppreciation(libelleAppreciation,nbMaxCaract){if(angular.isDefined(libelleAppreciation)){var limitReached=libelleAppreciation.length>nbMaxCaract;limitReached?vm.formDisabled=!0:vm.formDisabled=!1}}function search(app,idx,tab){return""===vm.searchFilter?!0:app.libelle.toLowerCase().indexOf(vm.searchFilter.toLowerCase())>-1||app.code.toLowerCase().indexOf(vm.searchFilter.toLowerCase())>-1}var vm=this;vm.searchFilter="",vm.close=close,vm.deleteAppreciation=deleteAppreciation,vm.setModeEdit=setModeEdit,vm.saveAppreciation=saveAppreciation,vm.addAppreciation=addAppreciation,vm.initNewAppreciation=initNewAppreciation,vm.displayAppreciationPerso=displayAppreciationPerso,vm.selectAppreciation=selectAppreciation,vm.onChangeAppreciation=onChangeAppreciation,vm.search=search,vm.currentPage=1,vm.itemParPage=15,vm.appreciationsPredefinies=appreciationsPredef.appreciations,vm.parametrage=appreciationsPredef.parametrage,vm.typeAppreciation=appreciationsPredef.type,vm.appreciationCurrentBackup={},vm.formDisabled=!1,"Prof Principal"===vm.typeAppreciation&&(vm.parametrage.nbCaractMax=400),vm.user=user,vm.mode=mode,vm.MODES=AppreciationsPredefiniesService.MODES,vm.appreciationsPredefiniesBackUp=angular.copy(vm.appreciationsPredefinies),$scope.$watch("appPredefiniesCtrl.searchFilter",function(){var tabTotal=lodash.filter(vm.appreciationsPredefinies,function(appSearch){return""===vm.searchFilter?!0:appSearch.libelle.toLowerCase().indexOf(vm.searchFilter.toLowerCase())>-1});vm.totalItems=tabTotal.length})}]),angular.module("edsiteApp.CarnetNotes").controller("ChoixElemProgImprimesCtrl",["$uibModalInstance","CompetencesService","Auth","user","currentEntity","nbElemProgMaxAImprimer","periode","matiere","saisieAppCtrl","paramsLSU","$q","lodash","Notification","$timeout",function($uibModalInstance,CompetencesService,Auth,user,currentEntity,nbElemProgMaxAImprimer,periode,matiere,saisieAppCtrl,paramsLSU,$q,lodash,Notification,$timeout){function editElemProgLibelle(elemProg,indexInput){vm.elemProgTemp=angular.copy(elemProg),vm.editableActivated=!0,elemProg.editable=!0,$timeout(function(){angular.element("#textarea-elemProg-"+indexInput).trigger("focus")},5)}function cancelUpdateElemProgLibelle(elemProg){elemProg.editable=!1,vm.editableActivated=!1,vm.elemProgTemp=null}function saveElemProgLibelle(elemProg,elemProgToSave){""!==elemProgToSave.libelle&&elemProgToSave.libelle&&(vm.promiseLoading=CompetencesService.updateElementProgramme(user.typeUser,user.idUser,vm.entity,vm.periode.codePeriode,vm.matiere.code,elemProgToSave.codeSousMatiere,elemProgToSave).then(function(){Notification.notify("Éléments de programme","Modification de l'élément de programme effectuée","success","icon-ed_note"),elemProg.editable=!1,elemProg.libelle=elemProgToSave.libelle,vm.editableActivated=!1,saisieAppCtrl.updateEP(elemProgToSave),vm.elemProgTemp=null},function(error){Notification.notify("Éléments de programme","Une erreur s'est produite lors de la modification de l'élément de programme","error","icon-ed_note")}))}function textareaElemProgLibelleKeyPress(event,elemProg,elemProgToSave){13===event.keyCode&&vm.saveElemProgLibelle(elemProg,elemProgToSave),27===event.keyCode&&vm.cancelUpdateElemProgLibelle(elemProg)}function close(data){$uibModalInstance.close(data)}function printElemProgOnBulletin(EP,collectionElementsProgramme){var elemProgToUpdate=angular.copy(EP);elemProgToUpdate.imprime=!EP.imprime,elemProgToUpdate.changeImprime=!0,vm.nbElemMaxAImprimer===collectionElementsProgramme.nbElemsImprimes&&elemProgToUpdate.imprime||(vm.promiseLoading=CompetencesService.updateElementProgramme(user.typeUser,user.idUser,vm.entity,vm.periode.codePeriode,vm.matiere.code,elemProgToUpdate.codeSousMatiere,elemProgToUpdate).then(function(dataElemProgUpdated){EP.imprime=!EP.imprime,collectionElementsProgramme.nbElemsImprimes=dataElemProgUpdated.nbElemProgImprimes,saisieAppCtrl.updateEP(EP)},function(error){Notification.notify("Éléments de programme","Une erreur s'est produite lors de la mise à jour de l'élément de programme","error","icon-ed_note")}))}function setOrdreTri(elemProgActu,ordre,tabElementsProgramme){var indexElemProg=lodash.findIndex(tabElementsProgramme,{idOrigineCatalogue:elemProgActu.idOrigineCatalogue}),ordreElemProg=parseInt(tabElementsProgramme[indexElemProg].ordre),elemProgToUpdate=angular.copy(elemProgActu);if("+"===ordre){if(indexElemProg===tabElementsProgramme.length-1)return;var elemProgNext=angular.copy(tabElementsProgramme[indexElemProg+1]);ordreElemProg++,elemProgActu.ordre=ordreElemProg,elemProgNext.ordre=ordreElemProg-1,elemProgToUpdate.ordre=elemProgActu.ordre,elemProgToUpdate.idSecondElem=elemProgNext.id,elemProgToUpdate.positionSecondElem=elemProgNext.ordre,vm.promiseLoading=CompetencesService.updateElementProgramme(user.typeUser,user.idUser,vm.entity,vm.periode.codePeriode,vm.matiere.code,elemProgToUpdate.codeSousMatiere,elemProgToUpdate).then(function(){tabElementsProgramme[indexElemProg+1]=elemProgActu,tabElementsProgramme[indexElemProg]=elemProgNext,saisieAppCtrl.updateEP(elemProgActu),saisieAppCtrl.updateEP(elemProgNext)},function(error){Notification.notify("Éléments de programme","Une erreur s'est produite lors de la mise à jour de l'élément de programme","error","icon-ed_note")})}if("-"===ordre){if(0>=indexElemProg)return;var elemProgPrev=angular.copy(tabElementsProgramme[indexElemProg-1]);ordreElemProg--,elemProgActu.ordre=ordreElemProg,elemProgPrev.ordre=ordreElemProg+1,elemProgToUpdate.ordre=elemProgActu.ordre,elemProgToUpdate.idSecondElem=elemProgPrev.id,elemProgToUpdate.positionSecondElem=elemProgPrev.ordre,vm.promiseLoading=CompetencesService.updateElementProgramme(user.typeUser,user.idUser,vm.entity,vm.periode.codePeriode,vm.matiere.code,elemProgToUpdate.codeSousMatiere,elemProgToUpdate).then(function(){tabElementsProgramme[indexElemProg-1]=elemProgActu,tabElementsProgramme[indexElemProg]=elemProgPrev,saisieAppCtrl.updateEP(elemProgActu),saisieAppCtrl.updateEP(elemProgPrev)},function(error){Notification.notify("Éléments de programme","Une erreur s'est produite lors de la mise à jour de l'élément de programme","error","icon-ed_note")})}}function save(){vm.promiseLoading=CompetencesService.updateModeCalculProf(vm.modeCalcul).then(function(){Notification.notify("Choix du mode de calcul","La modfication a bien été prise en compte.","success","icon-ed_note"),Auth.setParametresIndividuel("modeCalculLSU",vm.modeCalcul),vm.close("refresh")},function(error){Notification.notify("Choix du mode de calcul","Une erreur s'est produite lors de la modification.","error","icon-ed_note")})}function refresh(){var lesPromises=[CompetencesService.getElementsProgramme(user.typeUser,user.idUser,vm.entity,vm.periode.codePeriode,vm.matiere.code,vm.matiere.codeSSMatiere).then(function(datasElemProg){if(vm.elemProg=datasElemProg,vm.totalElementsProgramme=datasElemProg.elementsProgramme.length,""===vm.matiere.codeSSMatiere&&1===vm.matiere.avecSousMatiere){vm.nbElemMaxAImprimer=vm.entity.paramsLSU.nbElementsProgrammeImprimesSousMatiere;var tabElementsProgBySousMatiere=lodash.groupBy(datasElemProg.elementsProgramme,"codeSousMatiere");angular.forEach(tabElementsProgBySousMatiere,function(elemTab){var compteursElemProgImprimesOuNon=lodash.countBy(elemTab,function(elemProg){return elemProg.imprime});vm.tabElementsProgrammeMultiple.push({tabElementsProgramme:elemTab,nbElemsImprimes:angular.isDefined(compteursElemProgImprimesOuNon["true"])?compteursElemProgImprimesOuNon["true"]:0,codeSousMatiere:elemTab[0].codeSousMatiere,libelleMatiere:elemTab[0].libelleMatiere})})}else vm.nbElemMaxAImprimer=nbElemProgMaxAImprimer,vm.tabElementsProgrammeMultiple.push({tabElementsProgramme:datasElemProg.elementsProgramme,nbElemsImprimes:datasElemProg.nbElemProgImprimes})},function(error){Notification.notify("Éléments de programme","Une erreur s'est produite lors de la récupération des éléments de programme","error","icon-ed_note")})];vm.promiseLoading=$q.all(lesPromises)}var vm=this;vm.entity=currentEntity,vm.periode=periode,vm.matiere=matiere,vm.modeCalcul=Auth.listParametresIndividuels("modeCalculLSU"),vm.tabSelected="#gestionElemProg",vm.datasUpdated=!1,vm.tabElementsProgrammeMultiple=[],vm.paramsLSU=paramsLSU,vm.elemProgTemp=null,vm.editableActivated=!1,vm.editElemProgLibelle=editElemProgLibelle,vm.cancelUpdateElemProgLibelle=cancelUpdateElemProgLibelle,vm.saveElemProgLibelle=saveElemProgLibelle,vm.textareaElemProgLibelleKeyPress=textareaElemProgLibelleKeyPress,vm.close=close,vm.refresh=refresh,vm.printElemProgOnBulletin=printElemProgOnBulletin,vm.setOrdreTri=setOrdreTri,vm.save=save,vm.translateModeCalcul=CompetencesService.translateModeDeCalcul,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("DetailElementProgrammeCtrl",["$uibModalInstance","CompetencesService","CarnetNotesService","Notification","user","currentClasse","elemProg","currentEleve","periode","matiere","lodash","Utils",function($uibModalInstance,CompetencesService,CarnetNotesService,Notification,user,currentClasse,elemProg,currentEleve,periode,matiere,lodash,Utils){function close(withCancel){withCancel&&angular.extend(vm.elemProg,vm.elemProgBackup),$uibModalInstance.dismiss()}function isSelected(evaluation){return vm.elemProg.position===evaluation}function translateModeDeCalcul(modeDeCalcul){return CompetencesService.translateModeDeCalcul(modeDeCalcul)}function changePosition(newPosition){vm.isDisabled=!1,vm.elemProg.position=newPosition,vm.elemProg.modeCalcul={id:0,libelle:"Saisie manuelle"}}function update(){lodash.forEach(currentEleve.currentPeriode.elementsProgrammeImprimes,function(elemProgImprime){elemProgImprime.id===vm.elemProg.id&&(elemProgImprime.position=vm.elemProg.position)}),lodash.forEach(currentEleve.currentPeriode.elementsProgramme,function(elemProg){elemProg.id===vm.elemProg.id&&(elemProg.position=vm.elemProg.position)}),CompetencesService.updatePositionPeriodiqueEleve(currentEleve.eleve.id,vm.periode.codePeriode,vm.elemProg).then(function(){vm.elemProgBackup=angular.copy(vm.elemProg),Notification.notify("Détail d'un élément de programme","La modfication a bien été prise en compte.","success","icon-ed_note")},function(error){Notification.notify("Détail d'un élément de programme","Une erreur s'est produite lors de la modification.","error","icon-ed_note")}),vm.close()}function refresh(){vm.elemProg=elemProg,vm.elemProgBackup=angular.copy(elemProg),vm.tabDevoirs=elemProg.devoirs,vm.isModeAccessibiliteVisuelle=Utils.isModeAccessibiliteVisuelleActif()}var vm=this;vm.CONSTANTES_PERIODES=CarnetNotesService.CONSTANTES.PERIODES,vm.parametragesLSU=currentClasse.paramsLSU,vm.periode=periode,vm.matiere=matiere,vm.close=close,vm.refresh=refresh,vm.isSelected=isSelected,vm.translateModeDeCalcul=translateModeDeCalcul,vm.changePosition=changePosition,vm.update=update,vm.isDisabled=!0,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("AppreciationsEditionCtrl",["$scope","$uibModalInstance","$filter","lodash","options","base64encodeFilter","CarnetNotesService",function($scope,$uibModalInstance,$filter,lodash,options,base64encodeFilter,CarnetNotesService){function close(){$uibModalInstance.dismiss()}function printAppreciations(){if(!angular.isUndefined(vm.options.parametresAppreciations)){var params={};params.paramLSU=vm.options.controleurNote.classe.paramsLSU,params.eps=[];var tabEleves=lodash.map(vm.eleves,function(eleveApp){var elv={};elv.eleve=eleveApp.eleve,elv.appreciations={},elv.appreciations.current=eleveApp.currentPeriode.appreciations,lodash.forEach(elv.appreciations.current,function(app){var appTemplate=lodash.find(vm.options.parametresAppreciations.appreciations,{code:app.code});app.libelle=appTemplate.libelle,app.contenu=$filter("base64encode")(app.contenuDecode)}),elv.periodeCurrent=eleveApp.currentPeriode,elv.moyennes={},angular.isDefined(eleveApp.currentMoyenne)&&""!==eleveApp.currentMoyenne?elv.moyennes.current=eleveApp.currentMoyenne:elv.moyennes.current=eleveApp.currentPeriode.moyenne;var yearPeriode=lodash.find(eleveApp.periodes,{code:vm.options.Constantes.CODES.ANNEE});return angular.isDefined(yearPeriode)&&(elv.moyennes.year=yearPeriode.moyenne),angular.isDefined(elv.periodeCurrent.elementsProgramme)&&(elv.positionsTemp=[],elv.periodeCurrent.elementsProgramme=lodash.chain(elv.periodeCurrent.elementsProgramme).sortBy(function(elemProg){return CarnetNotesService.removeDiacritics(elemProg.codeSousMatiere).toUpperCase()+elemProg.ordre}).value(),angular.forEach(elv.periodeCurrent.elementsProgramme,function(ep){if(angular.isUndefined(lodash.find(params.eps,{id:ep.id,codeSousMatiere:ep.codeSousMatiere}))){var prefix="";""!==ep.codeSousMatiere&&(prefix=ep.codeSousMatiere+" - "),params.eps.push({ep:prefix+ep.libelle,codeSousMatiere:ep.codeSousMatiere,imprime:ep.imprime,id:ep.id})}elv.positionsTemp.push({position:ep.position,ep:ep.libelle,codeSousMatiere:ep.codeSousMatiere,imprime:ep.imprime,id:ep.id})})),elv});lodash.remove(tabEleves,function(eleve){return""!==eleve.eleve.dateSortie&&eleve.eleve.dateSortie<eleve.periodeCurrent.dateDebut}),params.eps.length>0&&angular.forEach(tabEleves,function(elv){elv.positions=[],angular.forEach(params.eps,function(ep){var epEleve=lodash.find(elv.positionsTemp,{id:ep.id,codeSousMatiere:ep.codeSousMatiere});angular.isUndefined(epEleve)?elv.positions.push({id:ep.id,codeSousMatiere:ep.codeSousMatiere,position:0}):elv.positions.push({id:ep.id,codeSousMatiere:ep.codeSousMatiere,position:epEleve.position})}),delete elv.positionsTemp}),params.appreciations=vm.options.parametresAppreciations.appreciations,params.entityLibelle=vm.options.controleurNote.classe.libelle,params.periodeLibelle=vm.options.currentPeriode.libelle,params.periodeLibelleCourt=vm.options.currentPeriode.libelleCourt,params.moyenneClasse=vm.options.currentPeriode.moyenne,params.matiereLibelle=vm.options.controleurNote.matiere.libelle,params.editionNoirEtBlanc=vm.editionNoirEtBlanc;var data={parametres:params,eleves:tabEleves};return{data:base64encodeFilter(JSON.stringify(data))}}}var vm=this;vm.classe=options.classe,vm.typeEntity=vm.classe.type,vm.idEntity=vm.classe.id,vm.eleves=options.eleves,vm.options=options,vm.editionNoirEtBlanc=!1,vm.close=close,vm.printAppreciations=printAppreciations}]),angular.module("edsiteApp.CarnetNotes").factory("AppreciationsPredefiniesService",["EDHttp","$q","$http",function(EDHttp,$q,$http){
var appPredefinieService={};return appPredefinieService.MODES={GESTION:"gestion",SAISIE:"saisie"},appPredefinieService.TYPE_APP={ENSEIGNANT:"Enseignant",PP:"Prof Principal",CE:"Directeur"},appPredefinieService.get=function(idUser,entity,typeApp){var defer=$q.defer();if(angular.isUndefined(typeApp)&&(typeApp=appPredefinieService.TYPE_APP.ENSEIGNANT),angular.isUndefined(idUser))return defer.reject(),defer.promise;var baseUrl=typeApp+"/"+idUser+"/"+entity.type+"/"+entity.id+"/appreciationsPredefinies";return new EDHttp({method:"GET",url:baseUrl,cache:!0,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},appPredefinieService.save=function(idUser,appreciationPredefinie,entity){var defer=$q.defer();if(angular.isUndefined(idUser))return defer.reject(),defer.promise;var baseUrl=appreciationPredefinie.type+"/"+idUser+"/"+entity.type+"/"+entity.id+"/appreciationsPredefinies";return $http({method:"POST",url:baseUrl,data:{code:appreciationPredefinie.code,libelle:appreciationPredefinie.libelle}}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},appPredefinieService.update=function(idUser,appreciationPredefinie,entity){var defer=$q.defer();if(angular.isUndefined(idUser))return defer.reject(),defer.promise;var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/appreciationsPredefinies/"+appreciationPredefinie.id;return $http({method:"PUT",url:baseUrl,data:{code:appreciationPredefinie.code,typeAppreciation:appreciationPredefinie.type,libelle:appreciationPredefinie.libelle}}).then(function(response){defer.resolve(response.data)},function(error){defer.reject(error)}),defer.promise},appPredefinieService.supprimer=function(idUser,appreciationPredefinie,entity){var defer=$q.defer();if(angular.isUndefined(idUser))return defer.reject(),defer.promise;var baseUrl="enseignants/"+idUser+"/"+entity.type+"/"+entity.id+"/appreciationsPredefinies/"+appreciationPredefinie.id;return $http({method:"DELETE",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},appPredefinieService}]),angular.module("edsiteApp.CarnetNotes").factory("ComposantesService",["$http","$q","lodash","$filter","EDHttp","UserService",function($http,$q,lodash,$filter,EDHttp,UserService){var service={};return service.CODE_MATIERE_SEPARATEURS={"/":"_______________","+":"PPPPPPPPPPPPPPP"},service.tableauComposantesOfficielles=[],UserService.getParametrages().then(function(params){service.tableauComposantesOfficielles=params.composantes}),service.isPourcentageMax=function(evaluationComposante,indexEvaluation,codeMatiere,isPourcentageMatiere){if(angular.isUndefined(evaluationComposante))return!1;angular.isUndefined(codeMatiere)&&(codeMatiere=""),angular.isUndefined(isPourcentageMatiere)&&(isPourcentageMatiere=!1);var evalPourCalcul=angular.copy(evaluationComposante);""!==codeMatiere?(evalPourCalcul.pourcentageEval1=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval1,evalPourCalcul.pourcentageEval2=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval2,evalPourCalcul.pourcentageEval3=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval3,evalPourCalcul.pourcentageEval4=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval4):isPourcentageMatiere&&(evalPourCalcul.pourcentageEval1=evalPourCalcul.pourcentagesParMatiere.pourcentageEval1,evalPourCalcul.pourcentageEval2=evalPourCalcul.pourcentagesParMatiere.pourcentageEval2,evalPourCalcul.pourcentageEval3=evalPourCalcul.pourcentagesParMatiere.pourcentageEval3,evalPourCalcul.pourcentageEval4=evalPourCalcul.pourcentagesParMatiere.pourcentageEval4);var tabPourcentages=[evalPourCalcul.pourcentageEval1,evalPourCalcul.pourcentageEval2,evalPourCalcul.pourcentageEval3,evalPourCalcul.pourcentageEval4],isMax=!0;if(angular.isUndefined(evalPourCalcul["pourcentageEval"+indexEvaluation]))return isMax=!1;var moy=0;return angular.forEach(tabPourcentages,function(pourcentageEval,key){moy+=pourcentageEval*(key+1)}),moy=Math.round(moy/100),indexEvaluation===""+moy},service.calculMoyenneComposante=function(evaluationComposante,codeMatiere,isPourcentageMatiere){if(angular.isUndefined(evaluationComposante))return!1;angular.isUndefined(codeMatiere)&&(codeMatiere=""),angular.isUndefined(isPourcentageMatiere)&&(isPourcentageMatiere=!1);var evalPourCalcul=angular.copy(evaluationComposante);""!==codeMatiere?(evalPourCalcul.pourcentageEval1=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval1,evalPourCalcul.pourcentageEval2=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval2,evalPourCalcul.pourcentageEval3=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval3,evalPourCalcul.pourcentageEval4=evalPourCalcul.pourcentagesParMatiere.detailMatieres[codeMatiere].pourcentageEval4):isPourcentageMatiere&&(evalPourCalcul.pourcentageEval1=evalPourCalcul.pourcentagesParMatiere.pourcentageEval1,evalPourCalcul.pourcentageEval2=evalPourCalcul.pourcentagesParMatiere.pourcentageEval2,evalPourCalcul.pourcentageEval3=evalPourCalcul.pourcentagesParMatiere.pourcentageEval3,evalPourCalcul.pourcentageEval4=evalPourCalcul.pourcentagesParMatiere.pourcentageEval4);var tabPourcentages=[evalPourCalcul.pourcentageEval1,evalPourCalcul.pourcentageEval2,evalPourCalcul.pourcentageEval3,evalPourCalcul.pourcentageEval4],moy=0;return angular.forEach(tabPourcentages,function(pourcentageEval,key){moy+=pourcentageEval*key}),moy/=3},service.get=function(typeUser,idUser,typeEntity,idEntity,codePeriode,idEleve){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/composantes";return new EDHttp({method:"GET",cache:!1,url:baseUrl,data:angular.isDefined(idEleve)?{idEleve:idEleve}:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.save=function(typeUser,idUser,typeEntity,idEntity,codePeriode,eleves){var defer=$q.defer(),data={},pTypeUser=$filter("translateTypeUserUrl")(typeUser);data.eleves=eleves;var baseUrl=pTypeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/periodes/"+codePeriode+"/composantes";return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.getDetail=function(typeEntity,idEntity,idEleve,codeComposante,codePeriode,anneeScolaire){var defer=$q.defer(),baseUrl=typeEntity+"/"+idEntity+"/eleves/"+idEleve+"/periodes/"+codePeriode+"/composantes/"+codeComposante,params={};return angular.isDefined(anneeScolaire)&&(params.anneeScolaire=anneeScolaire),new EDHttp({method:"GET",cache:!0,url:baseUrl,data:params}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.CarnetNotes").factory("CompetencesService",["$http","$q","lodash","EDHttp",function($http,$q,lodash,EDHttp){var service={},SEPARATEUR="¤";return service.CODE_MATIERE_SEPARATEUR={"/":"_______________","+":"PPPPPPPPPPPPPPP"},service.countNbElemProgImprimes=function(devoirs){var tabIdsOrigine={};return angular.forEach(devoirs,function(devoir){angular.forEach(devoir.elementsProgramme,function(elemProg){elemProg.imprime&&(tabIdsOrigine[elemProg.idOrigineCatalogue]=1)})}),Object.keys(tabIdsOrigine).length},service.updateElemProgInAllDevoirs=function(elemProgUpdated,devoirs){angular.forEach(devoirs,function(devoir){var elemProgFound=lodash.find(devoir.elementsProgramme,{idOrigineCatalogue:elemProgUpdated.idOrigineCatalogue});angular.isDefined(elemProgFound)&&(elemProgFound.imprime=elemProgUpdated.imprime)})},service.get=function(idCycleEtab){var defer=$q.defer();if(angular.isUndefined(idCycleEtab))return defer.reject(),defer.promise;var baseUrl=idCycleEtab+"/competences/catalogue";return new EDHttp({method:"GET",cache:!0,url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise},service.getExceptionsElementsProgrammePeriodes=function(typeUser,idUser,typeEntity,idEntity,codeMatiere,codeSousmatiere){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere);var baseUrl=typeUser+"/"+idUser+"/"+typeEntity+"/"+idEntity+"/matieres/"+codeMatiereSSMatiere+"/exceptionsElementsProgrammePeriodes";return new EDHttp({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.addExceptionElemProgPeriode=function(typeUser,idUser,entity,codeMatiere,codeSousmatiere,listeElemsProg,periode){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere);var data={listeIdsElement:lodash.pluck(listeElemsProg,"idOrigineCatalogue"),codePeriode:periode.codePeriode},baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/matieres/"+codeMatiereSSMatiere+"/exceptionsElementsProgrammePeriodes";return new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.deleteExceptionElemProgPeriode=function(typeUser,idUser,entity,codeMatiere,codeSousmatiere,listeElemsProg,periode){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere);var data={listeIdsElement:lodash.pluck(listeElemsProg,"idOrigineCatalogue"),codePeriode:periode.codePeriode},baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/matieres/"+codeMatiereSSMatiere+"/exceptionsElementsProgrammePeriodes";return new EDHttp({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.getElementsProgramme=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSousmatiere){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/elementsProgramme";return new EDHttp({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.updatePositionPeriodiqueEleve=function(idEleve,codePeriode,elementProgramme){var defer=$q.defer();if(angular.isUndefined(idEleve)||angular.isUndefined(codePeriode)||angular.isUndefined(elementProgramme))return defer.reject(),defer.promise;var baseUrl="positionPeriodique/periodes/"+codePeriode+"/matieres/"+elementProgramme.codeMatiere+SEPARATEUR+elementProgramme.codeSousMatiere+"/elementsProgramme/"+elementProgramme.id+"/eleves/"+idEleve;return new EDHttp({method:"PUT",url:baseUrl,data:elementProgramme}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.translateModeDeCalcul=function(modeDeCalcul){return 1===modeDeCalcul?"Toutes les évaluations ont la même valeur. L'arrondi supérieur est conservé.":2===modeDeCalcul?"Seule la dernière évaluation compte.":3===modeDeCalcul?"La meilleure évaluation.":4===modeDeCalcul?"L'évaluation la plus fréquente. La meilleure si les fréquences sont égales.":"Saisie manuelle"},service.updatePositionPeriodiqueMatiereEleve=function(idEleve,codePeriode,codeMatiere,codeSousmatiere,position){var defer=$q.defer();if(angular.isUndefined(idEleve)||angular.isUndefined(codePeriode)||angular.isUndefined(codeMatiere)||angular.isUndefined(position))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var baseUrl="positionPeriodique/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/eleves/"+idEleve;return new EDHttp({method:"PUT",url:baseUrl,data:{position:position}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.updateModeCalculProf=function(modeCalcul){var defer=$q.defer();if(angular.isUndefined(modeCalcul))return defer.reject(),defer.promise;var baseUrl="LSU/modeCalcul";return new EDHttp({method:"PUT",url:baseUrl,data:{modeCalcul:modeCalcul}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.updateElementProgramme=function(typeUser,idUser,entity,codePeriode,codeMatiere,codeSousmatiere,elementProgramme){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var codeMatiereSSMatiere=codeMatiere;angular.isDefined(codeSousmatiere)&&(codeMatiereSSMatiere+=SEPARATEUR+codeSousmatiere),lodash.forEach(service.CODE_MATIERE_SEPARATEURS,function(newCaract,caractToReplace){codeMatiereSSMatiere=codeMatiereSSMatiere.replace(caractToReplace,newCaract)});var baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/matieres/"+codeMatiereSSMatiere+"/elementsProgramme/"+elementProgramme.id;return new EDHttp({method:"PUT",url:baseUrl,data:elementProgramme}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.enregistreCompetence=function(idCycleEtab,matiere,competence){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/competences";return new EDHttp({method:"POST",url:baseUrl,data:{libelle:competence.libelle}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.modifieCompetence=function(idCycleEtab,matiere,competence){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/competences/"+competence.id;return new EDHttp({method:"PUT",url:baseUrl,data:{libelle:competence.libelle}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.supprimeCompetence=function(idCycleEtab,matiere,competence){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/competences/"+competence.id;return new EDHttp({method:"DELETE",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.enregistreElementProgramme=function(idCycleEtab,matiere,competence,elemProg){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/competences/"+competence.id+"/elements";return new EDHttp({method:"POST",url:baseUrl,data:elemProg}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.modifieElementProgramme=function(idCycleEtab,matiere,elemProg){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/elements/"+elemProg.idOrigineCatalogue;return new EDHttp({method:"PUT",url:baseUrl,data:elemProg}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.supprimeElementProgramme=function(idCycleEtab,matiere,elemProg){var defer=$q.defer(),baseUrl=idCycleEtab+"/catalogue/"+matiere.id+"/elements/"+elemProg.idOrigineCatalogue;return new EDHttp({method:"DELETE",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.modifieBaremesElementsProgramme=function(typeUser,idUser,tabElementsProgramme){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var baseUrl=typeUser+"/"+idUser+"/elementsProgramme/baremes",data={elementsProgramme:tabElementsProgramme};return new EDHttp({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.CarnetNotes").controller("DetailsComposanteEleveCtrl",["$uibModalInstance","$filter","$scope","$rootScope","$localStorage","ComposantesService","CacheService","lodash","composante","eleve","classe","anneeScolaire","periode","tabPeriodes","Utils",function($uibModalInstance,$filter,$scope,$rootScope,$localStorage,ComposantesService,CacheService,lodash,composante,eleve,classe,anneeScolaire,periode,tabPeriodes,Utils){function setConfigChart(){vm.configChart.options.title.text="#eval"===vm.onglet?"Répartition des évaluations de la composante":"Moyenne des pourcentages des évaluations par matière","#eval"===vm.onglet?vm.configChart.series=[{name:"Répartition",data:[{name:$filter("base64decode")(vm.parametrages.libelleEval1),y:vm.competenceEleve.pourcentageEval1||0},{name:$filter("base64decode")(vm.parametrages.libelleEval2),y:vm.competenceEleve.pourcentageEval2||0},{name:$filter("base64decode")(vm.parametrages.libelleEval3),y:vm.competenceEleve.pourcentageEval3||0},{name:$filter("base64decode")(vm.parametrages.libelleEval4),y:vm.competenceEleve.pourcentageEval4||0}]}]:vm.configChart.series=[{name:"Pourcentage moyen",data:[{name:$filter("base64decode")(vm.parametrages.libelleEval1),y:vm.competenceEleve.pourcentagesParMatiere.pourcentageEval1||0},{name:$filter("base64decode")(vm.parametrages.libelleEval2),y:vm.competenceEleve.pourcentagesParMatiere.pourcentageEval2||0},{name:$filter("base64decode")(vm.parametrages.libelleEval3),y:vm.competenceEleve.pourcentagesParMatiere.pourcentageEval3||0},{name:$filter("base64decode")(vm.parametrages.libelleEval4),y:vm.competenceEleve.pourcentagesParMatiere.pourcentageEval4||0}]}]}function isPourcentageMax(indexEvaluation,codeMatiere,isPourcentageMatiere){return ComposantesService.isPourcentageMax(vm.competenceEleve,indexEvaluation,codeMatiere,isPourcentageMatiere)}function close(){$uibModalInstance.dismiss()}function onPeriodeChanged(periode){vm.periode=periode,vm.refresh()}function refresh(force){var urlCache=vm.classe.type+"/"+vm.classe.id+"/eleves/"+vm.eleve.id+"/periodes/A\\d{3}Z?X?\\d{0,3}/composantes/"+vm.composante.code,regex=new RegExp(urlCache,"g");vm.isModeAccessibiliteVisuelle=Utils.isModeAccessibiliteVisuelleActif(),force&&CacheService.removeMatch(regex),vm.promiseLoading=ComposantesService.getDetail(vm.classe.type,vm.classe.id,vm.eleve.id,vm.composante.code,vm.periode.codePeriode,vm.anneeScolaire).then(function(data){vm.elementsProgramme=data.evaluations,vm.competenceEleve=data.competenceEleve,vm.nbTotalEvalEvaluations=0;for(var valeurEval=1;4>=valeurEval;)vm.nbTotalEvalEvaluations+=vm.elementsProgramme.filter(function(elt){return+elt.evaluation===valeurEval}).length,valeurEval++;vm.setConfigChart()})}var vm=this;vm.refresh=refresh,vm.close=close,vm.onPeriodeChanged=onPeriodeChanged,vm.setConfigChart=setConfigChart,vm.isPourcentageMax=isPourcentageMax,vm.onglet=angular.isDefined($localStorage.methodeCalculAideSaisie)?"#"+$localStorage.methodeCalculAideSaisie:"#eval",vm.elementsProgramme=[],vm.composante=composante,vm.eleve=eleve,vm.classe=classe,vm.anneeScolaire=anneeScolaire,vm.competenceEleve=lodash.find(eleve.competences,{codeComposante:vm.composante.code}),vm.parametrages=vm.classe.paramsLSU,vm.periode=periode||{},vm.tabPeriodes=tabPeriodes||[],vm.nbTotalEvalEvaluations=0,vm.configChart={options:{chart:{type:"pie",plotShadow:!0},title:{text:"",align:"left"},tooltip:{style:{padding:10,fontWeight:"bold"},pointFormat:"{series.name}: <b>{point.percentage:.0f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.0f} %",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"},connectorColor:"silver"},colors:[vm.parametrages.couleurEval1,vm.parametrages.couleurEval2,vm.parametrages.couleurEval3,vm.parametrages.couleurEval4]}},exporting:{enabled:!1}},series:[],loading:!1,size:{height:400},credits:{enabled:!1}},refresh(!0)}]),angular.module("edsiteApp.CarnetNotes").directive("catalogueCompetences",["Notification","$uibModal","$timeout","$q","CompetencesService","UserService","CahierDeTexteService","CacheService","lodash","Auth",function(Notification,$uibModal,$timeout,$q,CompetencesService,UserService,CahierDeTexteService,CacheService,lodash,Auth){return{restrict:"E",scope:{closeModal:"&",paramsLsu:"=",idCycleEtab:"=",libelleCycle:"=",prof:"=",selectedItem:"=",catalogueReadOnly:"=",moduleSource:"@",listeClasses:"=",entitySelected:"=",periodeSelected:"="},templateUrl:"modules/notes/enseignant/LSUN/catalogue-lsu-template.html",controller:["$scope","$rootScope",function($scope,$rootScope){function setSelectedMatiere(matiere){angular.isDefined($scope.selectedMatiere)&&lodash.remove($scope.selectedMatiere.competences,function(competence){return competence.temporaire}),angular.isDefined($scope.selectedCompetence)&&lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.temporaire}),setUneditableCompetence(!0),setUneditableElemProg(!0),$scope.selectedMatiere=matiere,$scope.selectedCompetence=void 0,$scope.elemProgSelected=void 0}function setSelectedCompetence(competence){angular.isDefined($scope.selectedCompetence)&&competence.id!==$scope.selectedCompetence.id&&(lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.temporaire}),setUneditableElemProg(!0)),$scope.selectedCompetence=competence,$scope.elemProgSelected=void 0,$scope.listePeriodes.forEach(function(periode){$scope.toggleStateExceptionPeriode[periode.codePeriode]="add"}),$timeout(function(){angular.element("a.elem-prog-selectable")[0].focus()},5)}function checkLibelleCompetenceEmpty(competence){0===competence.libelle.length&&(competence=angular.extend(competence,$scope.backupCompetencesEditables[competence.id]),0===competence.id&&$scope.selectedMatiere.competences.pop())}function setUneditableCompetence(all){angular.isUndefined($scope.selectedMatiere)||angular.forEach($scope.selectedMatiere.competences,function(competence){(!angular.isUndefined($scope.selectedCompetence)&&competence.id!==$scope.selectedCompetence.id||all)&&(angular.isDefined($scope.backupCompetencesEditables[competence.id])&&(competence=angular.extend(competence,$scope.backupCompetencesEditables[competence.id]),delete $scope.backupCompetencesEditables[competence.id]),competence.editable=!1)})}function initNewCompetence(){angular.isDefined($scope.selectedMatiere)&&lodash.remove($scope.selectedMatiere.competences,function(competence){return competence.temporaire}),$scope.selectedMatiere.competences.push({id:0,libelle:"",elementsProgramme:[],editable:!0,temporaire:!0}),$timeout(function(){angular.element("#input-competence-"+($scope.selectedMatiere.competences.length-1)).trigger("focus")},5)}function editCompetence(competenceToUpdate,indexInput){setUneditableCompetence(),$scope.backupCompetencesEditables[competenceToUpdate.id]=angular.copy(competenceToUpdate),competenceToUpdate.editable=!0,$timeout(function(){angular.element("#input-competence-"+indexInput).trigger("focus")},5)}function cancelUpdateCompetence(competenceToUpdate){competenceToUpdate=angular.extend(competenceToUpdate,$scope.backupCompetencesEditables[competenceToUpdate.id]),competenceToUpdate.editable=!1,competenceToUpdate.editable||0!==competenceToUpdate.id||$scope.selectedMatiere.competences.pop()}function saveCompetence(competenceToSave){""!==competenceToSave.libelle&&competenceToSave.libelle&&(0!==competenceToSave.id?$scope.promiseContent=CompetencesService.modifieCompetence($scope.idCycleEtab,$scope.selectedMatiere,competenceToSave).then(function(){competenceToSave.editable=!1,delete $scope.backupCompetencesEditables[competenceToSave.id],Notification.notify("Catalogue","Modification de la compétence effectuée","success","icon-ed_note"),clearCacheCatalogueLSU()},function(error){Notification.notify("Catalogue","Une erreur s'est produite lors de la modification de la compétence","error","icon-ed_note")}):$scope.promiseContent=CompetencesService.enregistreCompetence($scope.idCycleEtab,$scope.selectedMatiere,competenceToSave).then(function(reponse){var newCompetence=angular.copy(competenceToSave);newCompetence.editable=!1,delete $scope.backupCompetencesEditables[newCompetence.id],angular.isDefined($scope.selectedMatiere)&&lodash.remove($scope.selectedMatiere.competences,function(competence){return competence.temporaire}),newCompetence.id=reponse.id,newCompetence.temporaire=!1,$scope.selectedMatiere.competences.push(newCompetence),$scope.setSelectedCompetence(newCompetence),Notification.notify("Catalogue","La compétence <strong>"+competenceToSave.libelle+"</strong> a bien été sauvegardée !","success","icon-ed_note"),clearCacheCatalogueLSU()},function(error){competenceToSave.editable=!0,Notification.notify("Catalogue","Une erreur s'est produite lors de l'ajout de la compétence","error","icon-ed_note")}))}function deleteCompetence(competenceToDelete){if(competenceToDelete.elementsProgramme.length>0)return void Notification.notify("Catalogue","Cette compétence contient encore des éléments de programme, vous ne pouvez pas la supprimer.","error","icon-ed_note");var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'une compétence",config.message="Souhaitez vous vraiment supprimer cette compétence ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){$scope.promiseContent=CompetencesService.supprimeCompetence($scope.idCycleEtab,$scope.selectedMatiere,competenceToDelete).then(function(){angular.isDefined($scope.backupCompetencesEditables[competenceToDelete.id])&&delete $scope.backupCompetencesEditables[competenceToDelete.id],lodash.remove($scope.selectedMatiere.competences,function(competence){return competence.id===competenceToDelete.id}),Notification.notify("Catalogue","Suppression de la compétence effectuée","success","icon-ed_note"),clearCacheCatalogueLSU()},function(error){Notification.notify("Catalogue","Une erreur s'est produite lors de la suppression de votre compétence","error","icon-ed_note")})})}function inputCompetenceKeyPress(event,competenceToSave){13===event.keyCode&&$scope.saveCompetence(competenceToSave),27===event.keyCode&&$scope.cancelUpdateCompetence(competenceToSave)}function editElemProg(elemProgToUpdate,indexInput){$scope.elemProgSelected=elemProgToUpdate,setUneditableElemProg(),$scope.backupElemProgEditables[elemProgToUpdate.idOrigineCatalogue]=angular.copy(elemProgToUpdate),elemProgToUpdate.editable=!0,$timeout(function(){angular.element("#textarea-elemProg-"+indexInput).trigger("focus")},5)}function setUneditableElemProg(all){angular.isUndefined($scope.selectedMatiere)||angular.isUndefined($scope.selectedCompetence)||angular.forEach($scope.selectedCompetence.elementsProgramme,function(elemProg){(!angular.isUndefined($scope.elemProgSelected)&&elemProg.idOrigineCatalogue!==$scope.elemProgSelected.idOrigineCatalogue||all)&&(angular.isDefined($scope.backupElemProgEditables[elemProg.idOrigineCatalogue])&&(elemProg=angular.extend(elemProg,$scope.backupElemProgEditables[elemProg.idOrigineCatalogue]),delete $scope.backupElemProgEditables[elemProg.idOrigineCatalogue]),elemProg.editable=!1)})}function saveElemProg(elemProgToSave){""!==elemProgToSave.libelle&&elemProgToSave.libelle&&(0!==elemProgToSave.idOrigineCatalogue?$scope.listePromises.push(CompetencesService.modifieElementProgramme($scope.idCycleEtab,$scope.selectedMatiere,elemProgToSave).then(function(){Notification.notify("Catalogue","Modification de l'élément de programme effectuée","success","icon-ed_note"),elemProgToSave.editable=!1,delete $scope.backupElemProgEditables[elemProgToSave.idOrigineCatalogue],clearCacheCatalogueLSU()},function(error){Notification.notify("Catalogue","Une erreur s'est produite lors de la modification de l'élément de programme","error","icon-ed_note")})):$scope.listePromises.push(CompetencesService.enregistreElementProgramme($scope.idCycleEtab,$scope.selectedMatiere,$scope.selectedCompetence,elemProgToSave).then(function(elemProgSaved){angular.isDefined($scope.selectedCompetence)&&lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.temporaire}),$scope.selectedCompetence.elementsProgramme.push(elemProgSaved),elemProgToSave.editable=!1,delete $scope.backupElemProgEditables[elemProgToSave.idOrigineCatalogue],Notification.notify("Catalogue","L'élément de programme <strong>"+elemProgToSave.libelle+"</strong> a bien été sauvegardé !","success","icon-ed_note"),clearCacheCatalogueLSU()},function(error){elemProgToSave.editable=!0,Notification.notify("Catalogue","Une erreur s'est produite lors de l'ajout de l'élément de programme","error","icon-ed_note")})),updatePromiseLoading())}function cancelUpdateElemProg(elemProgToUpdate){elemProgToUpdate=angular.extend(elemProgToUpdate,$scope.backupElemProgEditables[elemProgToUpdate.idOrigineCatalogue]),elemProgToUpdate.editable=!1,elemProgToUpdate.editable||0!==elemProgToUpdate.idOrigineCatalogue||$scope.selectedCompetence.elementsProgramme.pop()}function deleteElemProg(elemProgToDelete){var modalInstanceElemProgSuppression=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression d'un élément de programme",config.message="Souhaitez vous vraiment supprimer cet élément de programme ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceElemProgSuppression.result.then(function(){$scope.listePromises.push(CompetencesService.supprimeElementProgramme($scope.idCycleEtab,$scope.selectedMatiere,elemProgToDelete).then(function(){lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.idOrigineCatalogue===elemProgToDelete.idOrigineCatalogue}),angular.isDefined($scope.backupElemProgEditables[elemProgToDelete.idOrigineCatalogue])&&delete $scope.backupElemProgEditables[elemProgToDelete.idOrigineCatalogue],Notification.notify("Catalogue","Suppression de l'élément de programme effectué","success","icon-ed_note"),clearCacheCatalogueLSU()},function(error){Notification.notify("Catalogue","Une erreur s'est produite lors de la suppression de votre compétence","error","icon-ed_note")})),updatePromiseLoading()})}function initNewElemProg(){angular.isDefined($scope.selectedCompetence)&&lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.temporaire});var newElemProg={id:0,idOrigineCatalogue:0,libelle:"",imprime:!1,idProf:$scope.prof.id,idCompetence:$scope.selectedCompetence.id,libelleCompetence:$scope.selectedCompetence.libelle,composantes:[],editable:!0,temporaire:!0};$scope.selectedCompetence.elementsProgramme.push(newElemProg),
$scope.elemProgSelected=newElemProg}function isElemProgInComposante(elemProg,composante){return angular.isDefined(lodash.find(elemProg.composantes,{id:composante.id}))}function addElemProgInComposante(elemProg,composanteLSU){var indexComposanteFound=lodash.findIndex(elemProg.composantes,{id:composanteLSU.id});-1===indexComposanteFound?elemProg.composantes.push({id:composanteLSU.id,libelle:composanteLSU.libelle}):elemProg.composantes.splice(indexComposanteFound,1)}function textareaElemProgKeyPress(event,elemProgToSave){13===event.keyCode&&$scope.saveElemProg(elemProgToSave),27===event.keyCode&&$scope.cancelUpdateElemProg(elemProgToSave)}function elemProgIsAlreadyAssociate(elemProg){if("N"===$scope.moduleSource){var elemProgFound=lodash.find($scope.selectedItem.elementsProgramme,{idOrigineCatalogue:elemProg.idOrigineCatalogue});return angular.isDefined(elemProgFound)}if("CDT"===$scope.moduleSource){var tabElementsProg={};tabElementsProg="T"===$scope.selectedItem.typeSaisie?$scope.selectedItem.aFaire.elementsProg:$scope.selectedItem.seance.elementsProg;var elemProgCdtFound=lodash.find(tabElementsProg,{id:elemProg.idOrigineCatalogue});return angular.isDefined(elemProgCdtFound)}}function associateElemProg(elemProg){if("N"===$scope.moduleSource){var elemProgToAdd=angular.copy(elemProg);angular.isUndefined($scope.selectedItem.elementsProgramme)&&($scope.selectedItem.elementsProgramme=[]),elemProgToAdd.id=0,elemProgToAdd.idMatiere=$scope.selectedMatiere.id,elemProgToAdd.libelleMatiere=$scope.selectedMatiere.libelle,$scope.selectedItem.elementsProgramme.push(elemProgToAdd),$scope.paramsLsu.nbElemsImprimes<$scope.paramsLsu.nbElemMaxAImprimer&&(elemProgToAdd.imprime=!0,$scope.paramsLsu.nbElemsImprimes++),Notification.notify("Evaluation","Elément de programme ajouté","success","icon-ed_note")}"CDT"===$scope.moduleSource&&(elemProgIsAlreadyAssociate(elemProg)||CahierDeTexteService.associateElemProg($scope.selectedItem,elemProg).then(function(){"T"===$scope.selectedItem.typeSaisie?$scope.refreshSlotCDTAfterUpload("aFaire"):$scope.refreshSlotCDTAfterUpload("seance"),Notification.notify("Cahier de textes","Elément de programme ajouté","success","icon-ed_cahierdetexte")},function(error){Notification.notify("Cahier de textes","Une erreur est survenue lors de l'ajout de l'élément de programme","error","icon-ed_cahierdetexte")}))}function close(data){angular.isDefined($scope.selectedMatiere)&&lodash.remove($scope.selectedMatiere.competences,function(competence){return competence.temporaire}),angular.isDefined($scope.selectedCompetence)&&lodash.remove($scope.selectedCompetence.elementsProgramme,function(elemProg){return elemProg.temporaire}),setUneditableCompetence(!0),setUneditableElemProg(!0),$scope.closeModal(data)}function updatePromiseLoading(){$scope.promiseLoading=$q.all($scope.listePromises),$scope.listePromises.length=0}function refreshSlotCDTAfterUpload(side){var date=moment($scope.selectedItem.date).format("YYYY-MM-DD");$scope.listePromises.push(CahierDeTexteService.getCDTUnitaire(side,$scope.selectedItem.entityCode,$scope.selectedItem.matiereCode,date).then(function(data){$scope.selectedItem[side]=data})),updatePromiseLoading()}function onSelectClasseGESTCATLSU(classe){classe.idCycleEtab!==$scope.idCycleEtab&&(clearCacheCatalogueLSU(),$scope.idCycleEtab=classe.idCycleEtab,loadCatalogueLSUCycle(classe.idCycleEtab)),$scope.entitySelected=classe,$scope.listePeriodes=classe.periodes.filter(function(periode){return 4===periode.codePeriode.length}),$scope.listePeriodes.forEach(function(periode){$scope.toggleStateExceptionPeriode[periode.codePeriode]="add"}),$scope.listePeriodes.length>0?$scope.listeMatieres=$scope.listePeriodes[0].matieres:$scope.listeMatieres=[],$scope.listeMatieres.length>0&&onSelectMatiereGESTCATLSU($scope.listeMatieres[0]),$scope.selectedMatiere=void 0,$scope.selectedCompetence=void 0,$scope.elemProgSelected=void 0,updatePromiseLoading()}function onSelectMatiereGESTCATLSU(matiere,event){$scope.matiereSelected=matiere,1!==matiere.avecSousMatiere&&($scope.listePromises.push(CompetencesService.getExceptionsElementsProgrammePeriodes(Auth.currentUser().typeCompte,Auth.currentUser().id,$scope.entitySelected.type,$scope.entitySelected.id,matiere.code,matiere.codeSSMatiere).then(function(data){$scope.listeExceptionsPeriodes=data.elementsProgramme,$scope.selectedMatiere=void 0,$scope.selectedCompetence=void 0,$scope.elemProgSelected=void 0},function(error){Notification.notify("Catalogue",error.data.message,"error","icon-ed_note")})),angular.isDefined(event)&&updatePromiseLoading())}function isExceptionElemProgPeriode(elemProg,periode){var elemProgEx=lodash.find($scope.listeExceptionsPeriodes,function(ep){return ep.idOrigineCatalogue===elemProg.idOrigineCatalogue});return angular.isUndefined(elemProgEx)?!1:angular.isDefined(lodash.find(elemProgEx.periodes,function(per){return per.codePeriode===periode.codePeriode}))}function isAllElemProgExcludedOnPeriode(currentPeriode,competenceSelected){var nbElemProgExclude=0;return angular.isUndefined(competenceSelected)||"N"!==$scope.moduleSource?!1:(angular.forEach(competenceSelected.elementsProgramme,function(elemProg){isExceptionElemProgPeriode(elemProg,currentPeriode)&&nbElemProgExclude++}),nbElemProgExclude===competenceSelected.elementsProgramme.length)}function getNbElemProgCompetencePeriode(competence,periode,actifSeulement){var nb=0;return actifSeulement?competence.elementsProgramme.forEach(function(elemProg){isExceptionElemProgPeriode(elemProg,periode,actifSeulement)||nb++}):nb=competence.elementsProgramme.length,nb}function getNbElemProgEnseignementPeriode(enseignement,periode,actifSeulement){var nb=0;return enseignement.competences.forEach(function(competence){nb+=getNbElemProgCompetencePeriode(competence,periode,actifSeulement)}),nb}function toggleActivationPeriode(listeElemsProg,periode,selectAll){var isAjoutNouvelleException=!1;if(selectAll)for(var indiceElemProg=0;indiceElemProg<listeElemsProg.length;indiceElemProg++)if(isExceptionElemProgPeriode(listeElemsProg[indiceElemProg],periode)){$scope.toggleStateExceptionPeriode[periode.codePeriode]="delete";break}isAjoutNouvelleException=listeElemsProg.length>1?"add"===$scope.toggleStateExceptionPeriode[periode.codePeriode]:!isExceptionElemProgPeriode(listeElemsProg[0],periode);var promiseToggle;promiseToggle=isAjoutNouvelleException?CompetencesService.addExceptionElemProgPeriode(Auth.currentUser().typeCompte,Auth.currentUser().id,$scope.entitySelected,$scope.matiereSelected.code,$scope.matiereSelected.codeSSMatiere,listeElemsProg,periode):CompetencesService.deleteExceptionElemProgPeriode(Auth.currentUser().typeCompte,Auth.currentUser().id,$scope.entitySelected,$scope.matiereSelected.code,$scope.matiereSelected.codeSSMatiere,listeElemsProg,periode),$scope.listePromises.push(promiseToggle.then(function(data){listeElemsProg.forEach(function(elemProg){var periodeEx,elemProgEx=lodash.find($scope.listeExceptionsPeriodes,function(ep){return ep.idOrigineCatalogue===elemProg.idOrigineCatalogue});angular.isDefined(elemProgEx)&&(periodeEx=lodash.find(elemProgEx.periodes,function(per){return per.codePeriode===periode.codePeriode})),!isAjoutNouvelleException&&angular.isDefined(elemProgEx)&&angular.isDefined(periodeEx)?(lodash.remove(elemProgEx.periodes,function(per){return per.codePeriode===periodeEx.codePeriode}),0===elemProgEx.periodes.length&&lodash.remove($scope.listeExceptionsPeriodes,function(ep){return ep.idOrigineCatalogue===elemProgEx.idOrigineCatalogue})):isAjoutNouvelleException&&(angular.isUndefined(elemProgEx)&&(elemProg.periodes=[],elemProgEx=elemProg,$scope.listeExceptionsPeriodes.push(elemProgEx)),angular.isUndefined(periodeEx)&&(periodeEx=periode),elemProgEx.periodes.push(periodeEx))}),listeElemsProg.length>1&&($scope.toggleStateExceptionPeriode[periode.codePeriode]=isAjoutNouvelleException?"delete":"add"),clearCacheCatalogueLSU()},function(error){Notification.notify("Catalogue",error.data.message,"error","icon-ed_note")})),listeElemsProg.length>1&&updatePromiseLoading()}function clearCacheCatalogueLSU(){CacheService.remove($scope.idCycleEtab+"/competences/catalogue")}function loadCatalogueLSUCycle(idCycle){$scope.listePromises.push(CompetencesService.get(idCycle).then(function(data){$scope.catalogue=data.catalogue;var matiereCurrentProf=lodash.find($scope.catalogue.matieres,{id:$scope.prof.matiere.id});angular.isDefined(matiereCurrentProf)&&setSelectedMatiere(matiereCurrentProf),$scope.catalogueReadonly||($scope.paramsLsu.nbElemsImprimes=CompetencesService.countNbElemProgImprimes($scope.tabDevoirsProf)),"N"===$scope.moduleSource&&CompetencesService.getExceptionsElementsProgrammePeriodes(Auth.currentUser().typeCompte,Auth.currentUser().id,$scope.entitySelected.type,$scope.entitySelected.id,$scope.prof.matiere.code,$scope.prof.matiere.codeSSMatiere).then(function(data){$scope.listeExceptionsPeriodes=data.elementsProgramme},function(error){Notification.notify("Catalogue",error.data.message,"error","icon-ed_note")}),$timeout(function(){angular.element("ul.nav-list a.matiere").first().trigger("focus")},5)},function(error){512===error.code&&Notification.notify("Catalogue",error.message,"error","icon-ed_note")}))}function refresh(){$scope.catalogueReadonly||($scope.tabDevoirsProf=angular.copy($scope.prof.devoirsClasse),angular.isDefined($scope.selectedItem)&&null!==$scope.selectedItem&&!lodash.has($scope.selectedItem,"id")&&$scope.tabDevoirsProf.push($scope.selectedItem)),loadCatalogueLSUCycle($scope.idCycleEtab),updatePromiseLoading()}$scope.close=close,$scope.setSelectedMatiere=setSelectedMatiere,$scope.setSelectedCompetence=setSelectedCompetence,$scope.elemProgIsAlreadyAssociate=elemProgIsAlreadyAssociate,$scope.associateElemProg=associateElemProg,$scope.refreshSlotCDTAfterUpload=refreshSlotCDTAfterUpload,$scope.editCompetence=editCompetence,$scope.cancelUpdateCompetence=cancelUpdateCompetence,$scope.saveCompetence=saveCompetence,$scope.deleteCompetence=deleteCompetence,$scope.initNewCompetence=initNewCompetence,$scope.checkLibelleCompetenceEmpty=checkLibelleCompetenceEmpty,$scope.inputCompetenceKeyPress=inputCompetenceKeyPress,$scope.editElemProg=editElemProg,$scope.cancelUpdateElemProg=cancelUpdateElemProg,$scope.saveElemProg=saveElemProg,$scope.deleteElemProg=deleteElemProg,$scope.initNewElemProg=initNewElemProg,$scope.isElemProgInComposante=isElemProgInComposante,$scope.addElemProgInComposante=addElemProgInComposante,$scope.textareaElemProgKeyPress=textareaElemProgKeyPress,$scope.onSelectClasseGESTCATLSU=onSelectClasseGESTCATLSU,$scope.onSelectMatiereGESTCATLSU=onSelectMatiereGESTCATLSU,$scope.isExceptionElemProgPeriode=isExceptionElemProgPeriode,$scope.toggleActivationPeriode=toggleActivationPeriode,$scope.isAllElemProgExcludedOnPeriode=isAllElemProgExcludedOnPeriode,$scope.getNbElemProgCompetencePeriode=getNbElemProgCompetencePeriode,$scope.getNbElemProgEnseignementPeriode=getNbElemProgEnseignementPeriode,$scope.clearCacheCatalogueLSU=clearCacheCatalogueLSU,$scope.loadCatalogueLSUCycle=loadCatalogueLSUCycle,$scope.refresh=refresh,$scope.catalogueReadonly=$scope.catalogueReadOnly,$scope.config={title:"GESTCATLSU"===$scope.moduleSource?"Gestion des éléments de programme du catalogue":"Ajouter un élément de programme depuis le catalogue",confirm:"Ajouter",cancel:"Annuler"},$scope.tabDevoirsProf=[],$scope.backupCompetencesEditables=[],$scope.backupElemProgEditables=[],$scope.listePromises=[],UserService.getParametrages().then(function(params){$scope.composantesSocle=params.composantes,$scope.composantesSoclePart1=$scope.composantesSocle.slice(0,4),$scope.composantesSoclePart2=$scope.composantesSocle.slice(4,8)}),$scope.matiereSelected=null,$scope.listeMatieres=[],$scope.listePeriodes=[],$scope.listeExceptionsPeriodes=[],$scope.toggleStateExceptionPeriode={},$scope.statusDropdown={isClasseOpen:!1,isMatiereOpen:!1},"GESTCATLSU"===$scope.moduleSource&&angular.isDefined($scope.entitySelected)&&null!==$scope.entitySelected&&onSelectClasseGESTCATLSU($scope.entitySelected),$scope.settings=$rootScope.settings,$scope.ariaHidden=!1,refresh()}]}}]),angular.module("kcd.directives",[]).directive("kcdRecompile",["$parse",function($parse){return{transclude:!0,link:function(scope,$el,attrs,ctrls,transclude){function compile(){transclude(scope,function(clone,clonedScope){previousElements=clone,$el.append(clone)})}function recompile(){previousElements&&(previousElements.remove(),previousElements=null,$el.empty()),compile()}var previousElements;compile(),scope.$watch(attrs.kcdRecompile,function(_new,_old){var useBoolean=attrs.hasOwnProperty("useBoolean");(!useBoolean||_new&&"false"!==_new)&&(useBoolean||_new&&_new!==_old)&&(useBoolean&&$parse(attrs.kcdRecompile).assign(scope,!1),recompile())},!0)}}}]),angular.module("edsiteApp.RPPEnseignant",[]).controller("EnseignantRPPCtrl",["$scope","$routeParams","ReunionParentProfService","Notification",function($scope,$routeParams,ReunionParentProfService,Notification){function refresh(){$scope.promiseContent=ReunionParentProfService.getEnseignantRPP(vm.idProf).then(function(reunions){vm.reunions=reunions},function(error){Notification.notify("Réunion parents professeurs","Une erreur s'est produite lors de la recuperation de vos réunion","error")})}var vm=this;vm.idProf=$routeParams.idUser,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("DetailsNotesEleveCtrl",["$uibModalInstance","eleve","periode","params","tabActive","Auth","ModuleService",function($uibModalInstance,eleve,periode,params,tabActive,Auth,ModuleService){function okFn(){$uibModalInstance.close()}function printDetail(){var data=$("#eleve-note").html(),mywindow=window.open("","","height=400,width=600");return mywindow.document.write("<html><head><title></title>"),mywindow.document.write("<style>body {font-size:10px;} table {    font-size: inherit;}  @media print {.cg-busy, .hidden-print, .hidden-print *  {  display: none !important;  } }</style>"),mywindow.document.write('<style>i.fa.fa-check:before{content: "x" !important} td.comp-eval{text-align: center} i.fa.fa-check{color:blue}</style>'),mywindow.document.write("<style>.ng-hide:not(.ng-hide-animate){display: none !important}</style>"),mywindow.document.write("<style>li:not(.active) {display: none;}</style>"),mywindow.document.write("<style>div#evenementsVS {display: none;}</style>"),mywindow.document.write("<style>table, tr, td, th {border-spacing:0;border: 1px solid black;}</style>"),mywindow.document.write('<style>td.competence-eval {text-align: center;}td.competence-eval > span.fa.fa-d:before {content: "D";}td.competence-eval > span.fa.fa-close:before {content: "X";}td.competence-eval > span.fa:not(.selected) {visibility: hidden;}span.note{margin-right: 10px;} span.fa {display: inline-block} span.fa.fa-circle:before {content: ".";font-weight: bold; font-size: 40px;} span.fa.fa-circle-thin:before {content: "x";} span.fa.fa-circle-thin {width: 8px;}</style>'),mywindow.document.write("</head><body >"),mywindow.document.write(data),mywindow.document.write("</body></html>"),mywindow.document.close(),mywindow.focus(),mywindow.print(),mywindow.close(),!0}var vm=this;vm.eleve=eleve,vm.periode=periode,vm.Auth=Auth,vm.moduleVSVisible=angular.isDefined(params.moduleVSVisible)?params.moduleVSVisible:!0,vm.moduleNoteVisible=angular.isDefined(params.moduleNoteVisible)?params.moduleNoteVisible:!0,vm.paramNoteEtab=angular.isDefined(params.paramNoteEtab)?params.paramNoteEtab:{},vm.activeTabs=[!1,!1,!1],tabActive<vm.activeTabs.length?vm.activeTabs[tabActive]=!0:vm.activeTabs[0]=!0,vm.okFn=okFn,vm.printDetail=printDetail,Auth.isPersonnel()&&(vm.moduleNotesActif=ModuleService.isModuleEnabled(ModuleService.CODES.NOTES),vm.moduleVSActif=ModuleService.isModuleEnabled(ModuleService.CODES.VIE_SCOLAIRE)),vm.moduleCarnetCorrespondanceActif=ModuleService.isModuleEnabled(ModuleService.CODES.CARNET_CORRESPONDANCE)}]),angular.module("edsiteApp.CarnetNotes").controller("DuplicationAppreciationsCtrl",["$uibModalInstance","periodeCurrent","periodesDuplication","user","$uibModal","SaisieAppreciationsService","Notification",function($uibModalInstance,periodeCurrent,periodesDuplication,user,$uibModal,SaisieAppreciationsService,Notification){function close(){$uibModalInstance.close()}function dupliquer(periodeToDuplicate){var modalInstanceDuplication=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Duplication des appréciations",config.message="Souhaitez vous vraiment remplacer toutes les appréciations de la période <strong>"+periodeToDuplicate.libelle+"</strong> par celles de la période <strong>"+periodeCurrent.libelle+"</strong> ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceDuplication.result.then(function(){SaisieAppreciationsService.duplication(user.type,user.id,user.entity,periodeCurrent.codePeriode,periodeCurrent.codeMatiere,periodeCurrent.codeSSMatiere,periodeToDuplicate.code).then(function(){Notification.notify("Saisie des appréciations","Duplication de vos appréciations sur la période <strong>"+periodeToDuplicate.libelle+"</strong> effectuée !","success","icon-ed_note"),vm.close()},function(error){Notification.notify("Duplication des appréciations","Une erreur s'est produite lors de duplication des appréciations ","error","icon-ed_note")})})}var vm=this;vm.dupliquer=dupliquer,vm.close=close,vm.periodes=periodesDuplication,vm.currentPeriode=periodeCurrent}]),angular.module("edsiteApp.CarnetNotes").controller("DuplicationAppreciationsPPCtrl",["$uibModalInstance","periodeCurrent","user","droitsModule","$uibModal","SaisieAppreciationsPPService","Notification","CarnetNotesService",function($uibModalInstance,periodeCurrent,user,droitsModule,$uibModal,SaisieAppreciationsPPService,Notification,CarnetNotesService){function close(){$uibModalInstance.close()}function dupliquer(typeAppreciation){var modalInstanceDuplication=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Duplication des appréciations",config.message='Souhaitez vous vraiment remplacer toutes les "'+typeAppreciation.libelle+'" de la période <strong>Année</strong> par celles de la période <strong>'+periodeCurrent.libelle+"</strong> ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceDuplication.result.then(function(){SaisieAppreciationsPPService.duplicationAppreciations(user.type,user.id,user.entity,periodeCurrent.codePeriode,vm.codePeriodeToDuplicate,typeAppreciation.code).then(function(){Notification.notify("Saisie des appréciations","Duplication de vos appréciations sur la période <strong> Année </strong> effectuée !","success","icon-ed_note"),vm.close()},function(error){Notification.notify("Duplication des appréciations","Une erreur s'est produite lors de duplication des appréciations ","error","icon-ed_note")})})}var vm=this;vm.dupliquer=dupliquer,vm.close=close,vm.currentPeriode=periodeCurrent,vm.tabTypesAppreciation=[{code:"PP",libelle:"Appréciations <strong>professeur principal</strong>",canDuplicate:droitsModule.canEditAppPP},{code:"VS",libelle:"Appréciations <strong>vie scolaire</strong>",canDuplicate:droitsModule.canEditAppVS},{code:"CE",libelle:"Appréciations <strong>chef établissement</strong>",canDuplicate:droitsModule.canEditAppCE},{code:"CN",libelle:"<strong>Compétences numériques</strong>",canDuplicate:droitsModule.canEditAppCN},{code:"CLASSEGEN",libelle:"Appréciation générale de la <strong>Classe</strong>",canDuplicate:droitsModule.canEditAppClasse},{code:"MENTIONCONSEIL",libelle:"<strong>Mentions du conseil</strong>",canDuplicate:droitsModule.canEditMentionDuConseil}],vm.codePeriodeToDuplicate=CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE}]),angular.module("edsiteApp").directive("maxSaisie",["$parse",function($parse){var CONSTANTS={BACKSPACE:8,DELETE:0,Z:90};return{link:function(scope,elm,attrs){function handleKeypress(e){setTimeout(function(){return limitSetter(scope,!1),(e.which===CONSTANTS.BACKSPACE||e.which===CONSTANTS.DELETE||e.ctrlKey&&e.which===CONSTANTS.Z)&&elm[0].value.length<=limitLength?(limitSetter(scope,!1),scope.$apply(),!0):elm[0].value.length>limitLength&&(limitSetter(scope,!0),scope.$apply(),stopSaisieActive)?(e.preventDefault(),!1):void 0},5)}var limitGetter=$parse(attrs.limitReached),limitSetter=limitGetter.assign,stopSaisieActive="true"===attrs.stopSaisie,limitLength=300;attrs.validLength&&"undefined"!=typeof attrs.validLength&&"number"!=typeof attrs.validLength&&(limitLength=parseInt(attrs.validLength)),scope.$watch(attrs.validLength,function(newVal,oldVal){angular.isDefined(newVal)&&(limitLength=parseInt(newVal))}),elm.bind("keydown",handleKeypress),elm.on("paste",function(e){setTimeout(function(){if(limitSetter(scope,!1),elm[0].value.length>limitLength){if(stopSaisieActive){var valueModel=elm[0].value.substring(0,limitLength);elm[0].value=valueModel;var modelGetter=$parse(attrs.ngModel),modelSetter=modelGetter.assign;modelSetter(scope,valueModel)}else limitSetter(scope,!0);scope.$apply()}},5)})}}}]),angular.module("edsiteApp").directive("liveSearch",["$compile","$timeout","$window",function($compile,$timeout,$window){return{restrict:"A",replace:!0,scope:{liveSearchCallback:"=",liveSearchSelect:"=?",liveSearchSelectCallback:"=",liveSearchItemTemplate:"@",liveSearchWaitTimeout:"=?",liveSearchMaxResultSize:"=?",liveSearchMaxlength:"=?",liveSearchPositionDom:"@?"},link:function(scope,element,attrs,controller){var timeout;scope.results=[],scope.visible=!1,scope.selectedIndex=-1,scope.select=function(index){scope.selectedIndex=index,scope.visible=!1},scope.isSelected=function(index){return scope.selectedIndex===index},scope.$watch("selectedIndex",function(newValue,oldValue){var item=scope.results[newValue];if(item){if(attrs.liveSearchSelectCallback){var value=scope.liveSearchSelectCallback.call(null,{items:scope.results,item:item});element.val(value)}else attrs.liveSearchSelect?element.val(item[attrs.liveSearchSelect]):element.val(item);"undefined"!==element.controller("ngModel")&&element.controller("ngModel").$setViewValue(element.val())}}),scope.$watch("visible",function(newValue,oldValue){if(newValue!==!1){scope.width=element[0].clientWidth;var offset=getPosition(element[0]);scope.top=offset.y+element[0].clientHeight+1+"px",scope.left=offset.x+"px"}}),element[0].onkeydown=function(e){40===e.keyCode?scope.selectedIndex+1===scope.results.length?scope.selectedIndex=0:scope.selectedIndex++:38===e.keyCode&&(0===scope.selectedIndex?scope.selectedIndex=scope.results.length-1:-1===scope.selectedIndex?scope.selectedIndex=0:scope.selectedIndex--),(13===e.keyCode||27===e.keyCode)&&(scope.visible=!1),scope.$apply()},element[0].onkeypress=function(e){return 13===e.keyCode&&(scope.visible||scope.selectedIndex>=0)?(scope.visible=!1,e.preventDefault(),!1):void 0},element[0].onkeyup=function(e){if(37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode||13===e.keyCode||27===e.keyCode)return!1;var target=element;$timeout.cancel(timeout);var vals=target.val().split(","),searchString=vals[vals.length-1].trim();return searchString.length<2||null!==scope.liveSearchMaxlength&&searchString.length>scope.liveSearchMaxlength?(scope.visible=!1,void scope.$apply()):void(timeout=$timeout(function(){var results=[],promise=scope.liveSearchCallback.call(null,{query:searchString});promise.then(function(dataArray){dataArray&&(results=dataArray.slice(0,(scope.liveSearchMaxResultSize||20)-1)),scope.visible=!0}),promise["finally"](function(){scope.selectedIndex=-1,scope.results=results.filter(function(elem,pos){return results.indexOf(elem)===pos})})},scope.liveSearchWaitTimeout||100))};var getPosition=function(element){for(var xPosition=0,yPosition=0;element;)xPosition+=element.offsetLeft-element.scrollLeft+element.clientLeft,yPosition+=element.offsetTop-element.scrollTop+element.clientTop,element=element.offsetParent;return{x:xPosition,y:yPosition}};angular.element($window).bind("scroll",function(){scope.visible=!1}),element[0].onblur=function(e){setTimeout(function(){scope.visible=!1},100)};var itemTemplate=element.attr("live-search-item-template")||"{{result}} - {{visible}}",template="";if(angular.isUndefined(scope.liveSearchPositionDom)){template="<ul ng-show='visible && results.length > 0'  ng-style=\"{'top':top,'left':left,'width':width}\" class='searchresultspopup'><li ng-class=\"{ 'selected' : isSelected($index) }\" ng-click='select($index)' ng-repeat='result in results track by $index'>"+itemTemplate+"</li></ul>";var searchPopupBody=$compile(template)(scope);document.body.appendChild(searchPopupBody[0])}else{template="<ul ng-show='visible && results.length > 0'  ng-style=\"{'width':width}\" class='searchresultspopup result-in-dom'><li ng-class=\"{ 'selected' : isSelected($index) }\" ng-click='select($index)' ng-repeat='result in results track by $index'>"+itemTemplate+"</li></ul>";var searchPopup=$compile(template)(scope);element[0].parentNode.appendChild(searchPopup[0])}}}}]),angular.module("edsiteApp").directive("noNewLines",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attributes,ngModelController){function transformInput(value){if(!value)return value;var isValid=regex.test(value);ngModelController.$setValidity("Does not match pattern",isValid);var transformedInput=value.replace(/[\n\r]/g,"");return transformedInput!==value&&(ngModelController.$setViewValue(transformedInput),ngModelController.$render()),transformedInput}var regex=new RegExp("^[^\n\r]*$");ngModelController.$parsers.unshift(function(value){return transformInput(value)}),ngModelController.$formatters.unshift(function(value){return transformInput(value)}),element.on("keypress",function(e){var ewhich=e.which;13===ewhich&&event.preventDefault()})}}}),angular.module("edsiteApp").service("ngCopy",["$window","Notification",function($window,Notification){var body=angular.element($window.document.body),textarea=angular.element("<textarea/>");return textarea.css({position:"fixed",opacity:"0"}),function(toCopy){textarea.val(toCopy),body.append(textarea),textarea[0].select();try{var successful=document.execCommand("copy");if(!successful)throw successful;Notification.notify("Copie effectuée","Le contenu a été ajouté dans le presse-papier","success",!0)}catch(err){Notification.notify("Copie impossible","Copie dans le presse-papier impossible","danger")}textarea.remove()}}]).directive("ngClickCopy",["ngCopy",function(ngCopy){return{restrict:"A",scope:{ngClickCopy:"="},link:function(scope,element){element.bind("click",function(e){ngCopy(scope.ngClickCopy)})}}}]),angular.module("edsiteApp.CarnetNotes").controller("DuplicationDevoirCtrl",["$uibModalInstance","$uibModal","onlyPeriodesForNotes","periodeCurrent","user","devoir","CarnetNotesService","Notification","UserService","lodash",function($uibModalInstance,$uibModal,onlyPeriodesForNotes,periodeCurrent,user,devoir,CarnetNotesService,Notification,UserService,lodash){function close(){vm.periodesEntitySelectedToDuplicate=[],$uibModalInstance.close()}function dupliquer(periodeToDuplicate){vm.requestLoading=CarnetNotesService.duplicateDevoirAndNotes(user.type,user.id,user.entity,periodeCurrent.codePeriode,periodeCurrent.codeMatiere,periodeCurrent.codeSSMatiere,devoir,periodeToDuplicate.codePeriode).then(function(){Notification.notify("Saisie des évaluations","Votre devoir a bien été dupliqué sur la période <strong>"+periodeToDuplicate.libelle+"</strong>  !","success","icon-ed_note"),vm.close()},function(error){Notification.notify("Saisie des évaluations","Une erreur s'est produite lors de la duplication de votre devoir ","error","icon-ed_note")})}function dupliquerSurAutresEntities(){var tabEntititesWithPeriodes=[];lodash.forEach(vm.periodesEntitySelectedToDuplicate,function(_entity,indiceEntity){var indexEntityFound=lodash.findIndex(tabEntititesWithPeriodes,{id:_entity.idEntity,type:_entity.type});-1===indexEntityFound?tabEntititesWithPeriodes.push({id:_entity.idEntity,type:_entity.typeEntity,periodes:[{codePeriode:_entity.codePeriode}]}):tabEntititesWithPeriodes[indexEntityFound].periodes.push({codePeriode:_entity.codePeriode})}),vm.requestLoading=CarnetNotesService.duplicateInfosDevoir(user.type,user.id,user.entity,periodeCurrent.codePeriode,periodeCurrent.codeMatiere,periodeCurrent.codeSSMatiere,devoir,tabEntititesWithPeriodes).then(function(){Notification.notify("Saisie des évaluations","Votre devoir a bien été dupliqué  les classes/groupes sélectionné(e)s pour la période  <strong>"+periodeCurrent.libelle+"</strong>  !","success","icon-ed_note"),vm.close()},function(error){Notification.notify("Saisie des évaluations","Une erreur s'est produite lors de la duplication de votre devoir ","error","icon-ed_note")})}function addPeriodeToDuplicate(entitySelected){var periodeFound=lodash.find(vm.periodesEntitySelectedToDuplicate,{idEntity:entitySelected.idEntity,typeEntity:entitySelected.type,codePeriode:periodeCurrent.codePeriode});"undefined"==typeof periodeFound?vm.periodesEntitySelectedToDuplicate.push({idEntity:entitySelected.idEntity,typeEntity:entitySelected.type,codePeriode:periodeCurrent.codePeriode}):vm.periodesEntitySelectedToDuplicate=lodash.reject(vm.periodesEntitySelectedToDuplicate,{idEntity:entitySelected.idEntity,typeEntity:entitySelected.type,codePeriode:periodeCurrent.codePeriode})}function refresh(){vm.requestLoading=UserService.getProfClassesGroupesTree().then(function(classes){var lesClasses=angular.copy(classes),allEntitiesFiltred=lodash.chain(lesClasses).filter({etabId:user.entity.etabId}).filter({idCycleEtab:user.entity.idCycleEtab}).value(),tabEntitiesWithPeriodes={};angular.forEach(allEntitiesFiltred,function(_entity,indiceEntity){var lid=_entity.id+"_"+_entity.type;tabEntitiesWithPeriodes[lid]={idEntity:_entity.id,libelle:_entity.libelle,code:_entity.code,type:_entity.type},tabEntitiesWithPeriodes[lid].periodes=lodash.chain(_entity.periodes).reject({codePeriode:CarnetNotesService.CONSTANTES.PERIODES.CODES.ANNEE}).filter({etat:CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE}).value(),tabEntitiesWithPeriodes[lid].periodes=lodash.uniq(tabEntitiesWithPeriodes[lid].periodes,"codePeriode"),vm.devoir.devoir.elementsProgramme.length>0&&(tabEntitiesWithPeriodes[lid].periodes=lodash.reject(tabEntitiesWithPeriodes[lid].periodes,function(_periode){return _periode.codePeriode.indexOf("X")>0})),(user.entity.id!==_entity.id||user.entity.type!==_entity.type)&&(tabEntitiesWithPeriodes[lid].periodes=lodash.reject(tabEntitiesWithPeriodes[lid].periodes,function(_periode){return!(_periode.dateFin>=vm.devoir.devoir.date&&_periode.dateDebut<=vm.devoir.devoir.date)}));var releveEnCours=lodash.find(_entity.periodes,function(per){return per.dateFin>=vm.devoir.devoir.date&&per.dateDebut<=vm.devoir.devoir.date&&per.codePeriode.indexOf("R")>0?!0:!1});tabEntitiesWithPeriodes[lid].idEntity===user.entity.id&&(vm.periodesEntityCurrent=tabEntitiesWithPeriodes[lid].periodes);var periodeEntityFound=lodash.find(tabEntitiesWithPeriodes[lid].periodes,{codePeriode:periodeCurrent.codePeriode}),matieresPeriode={};"undefined"!=typeof periodeEntityFound&&(matieresPeriode=lodash.find(periodeEntityFound.matieres,{code:periodeCurrent.codeMatiere,codeSSMatiere:periodeCurrent.codeSSMatiere})),1===+vm.devoir.devoir.avecNote&&0===_entity.estNote||"undefined"==typeof matieresPeriode?delete tabEntitiesWithPeriodes[lid]:tabEntitiesWithPeriodes[lid].periodes.length<=0?delete tabEntitiesWithPeriodes[lid]:angular.isDefined(releveEnCours)&&releveEnCours.etat!==CarnetNotesService.CONSTANTES.PERIODES.ETATS.OUVERTE&&delete tabEntitiesWithPeriodes[lid]}),tabEntitiesWithPeriodes=lodash.reject(tabEntitiesWithPeriodes,{idEntity:user.entity.id,type:user.entity.type}),vm.tabOtherEntities=tabEntitiesWithPeriodes})}var vm=this;vm.close=close,vm.dupliquer=dupliquer,vm.addPeriodeToDuplicate=addPeriodeToDuplicate,vm.dupliquerSurAutresEntities=dupliquerSurAutresEntities,vm.devoir=devoir,vm.currentPeriode=periodeCurrent,
vm.periodesEntitySelectedToDuplicate=[],vm.tabSelected="#duplicationMemeClasse",vm.periodesEntityCurrent={},vm.entityCurrent=user.entity,vm.constantesTypeEntity=CarnetNotesService.typeEntity,refresh()}]),angular.module("edsiteApp.Commun").directive("userDetail",["$uibModal",function($uibModal){return{restrict:"A",scope:{userProfile:"@",userId:"@"},link:function(scope,element,attrs){element.css("cursor","pointer"),element.bind("click",function(){var modalInstance=$uibModal.open({templateUrl:"modules/commun/user-detail/user-detail-template.html",controller:"UserDetailCtrl as userDetailCtrl",backdrop:!0,resolve:{options:function(){var options={};return options.title="Informations",options.idUser=scope.userId,options.typeUser=scope.userProfile,options}}});modalInstance.result.then(function(devoir){})})}}}]).controller("UserDetailCtrl",["$uibModalInstance","options","UserDetailService","Auth","MessagerieService",function($uibModalInstance,options,UserDetailService,Auth,MessagerieService){var vm=this;vm.Auth=Auth,vm.idUser=options.idUser,vm.typeUser=options.typeUser,vm.user={},vm.contactUser={},vm.promiseLoading=UserDetailService.getUserDetails(vm.typeUser,vm.idUser).then(function(details){vm.user=details,vm.contactUser=MessagerieService.convertUserToContact(vm.user,vm.typeUser)}),vm.close=function(){$uibModalInstance.dismiss()},vm.canSendMessageUser=function(){return MessagerieService.canSendMessageUser(vm.typeUser)}}]).factory("UserDetailService",["EDHttp","$q","$filter",function(EDHttp,$q,$filter){var service={};return service.getUserDetails=function(typeUser,idUser){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser);"familles"===pTypeUser&&(pTypeUser=typeUser);var baseUrl=pTypeUser+"/"+idUser+"/details";return new EDHttp({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.LSL",["edsiteApp.Commun"]).controller("LSLCtrl",["$scope","Auth","$rootScope","$timeout","lodash","CacheService","LslService","$uibModal","$q","Utils","UtilisateursService","Notification","$filter","moment",function($scope,Auth,$rootScope,$timeout,lodash,CacheService,LslService,$uibModal,$q,Utils,UtilisateursService,Notification,$filter,moment){function setlslForm(theForm){vm.thelslForm=theForm}function langueVivante(matiere){var code=matiere.code;return 0===code.indexOf("03")&&("1"===code.slice(-1)||"2"===code.slice(-1)||"3"===code.slice(-1)||"4"===code.slice(-1))}function openEngagementSaisiLe($event){$event.preventDefault(),$event.stopPropagation(),vm.engagementSaisiLeOpened=!0}function openInvestissementSaisiLe($event){$event.preventDefault(),$event.stopPropagation(),vm.investissementSaisiLeOpened=!0}function openChefEtabSaisiLe($event){$event.preventDefault(),$event.stopPropagation(),vm.chefEtabSaisiLeOpened=!0}function selectClasse(classe){angular.isUndefined(vm.currentClasse)&&(vm.currentClasse=classe),vm.currentClasse.idClasse!==classe.idClasse&&(vm.currentClasse=classe,vm.currentMatiere=void 0,vm.currentEleve=void 0),1===classe.matieres.length&&(vm.currentMatiere=classe.matieres[0])}function selectMatiere(matiere){vm.currentMatiere=matiere,vm.matiereEleve=lodash.find(vm.currentEleve.matieres,{code:vm.currentMatiere.code,modaliteElection:vm.currentMatiere.modaliteElection});var indexMatiere=lodash.findIndex(vm.currentEleve.matieres,{code:matiere.code,modaliteElection:matiere.modaliteElection});vm.competencesElevesOfMatiere=vm.currentEleve.matieres[indexMatiere].competences}function initAvisEleve(tabAvisEleve){var dateJour=moment().format("YYYY-MM-DD");vm.avisEngagement=lodash.find(tabAvisEleve,{type:constantesLSL.AVIS.TYPES.ENGAGEMENT}),angular.isUndefined(vm.avisEngagement)&&(vm.avisEngagement={texte:"",type:constantesLSL.AVIS.TYPES.ENGAGEMENT,date:dateJour}),vm.autreEngagement=lodash.find(tabAvisEleve,{type:constantesLSL.AVIS.TYPES.ENGAGEMENT_AUTRE}),angular.isUndefined(vm.autreEngagement)&&(vm.autreEngagement={texte:"",type:constantesLSL.AVIS.TYPES.ENGAGEMENT_AUTRE}),vm.avisInvestissement=lodash.find(tabAvisEleve,{type:constantesLSL.AVIS.TYPES.INVESTISSEMENT}),angular.isUndefined(vm.avisInvestissement)&&(vm.avisInvestissement={texte:"",type:constantesLSL.AVIS.TYPES.INVESTISSEMENT,date:dateJour}),vm.avisChefEtab=lodash.find(tabAvisEleve,{type:constantesLSL.AVIS.TYPES.CHEFETAB}),angular.isUndefined(vm.avisChefEtab)&&(vm.avisChefEtab={texte:"",type:constantesLSL.AVIS.TYPES.CHEFETAB,date:dateJour}),vm.avisExamen=lodash.find(tabAvisEleve,{type:constantesLSL.AVIS.TYPES.EXAMEN}),angular.isUndefined(vm.avisExamen)&&(vm.avisExamen={texte:"",type:constantesLSL.AVIS.TYPES.EXAMEN})}function selectEleve(eleve){if(vm.watchBlockChange=angular.copy(defaultWatchState),$rootScope.navigationDisabled){var okCallback=function(){$rootScope.navigationDisabled=!1,$timeout(function(){selectEleve(eleve)},500)},cancelCallback=function(notice){notice.remove()};return void Utils.displayWarningEditRunning(okCallback,cancelCallback)}if(vm.allIsSaved=!0,vm.currentEleve=angular.copy(eleve),angular.isDefined(vm.currentMatiere)){vm.matiereEleve=lodash.find(vm.currentEleve.matieres,{code:vm.currentMatiere.code,modaliteElection:vm.currentMatiere.modaliteElection}),angular.isUndefined(vm.matiereEleve)&&(vm.matiereEleve=vm.currentEleve.matieres[0],vm.currentMatiere=vm.matiereEleve);var indexMatiereActu=lodash.findIndex(vm.currentEleve.matieres,{code:vm.currentMatiere.code,modaliteElection:vm.currentMatiere.modaliteElection});vm.competencesElevesOfMatiere=vm.currentEleve.matieres[indexMatiereActu].competences}initAvisEleve(vm.currentEleve.avisEleve),angular.isDefined(vm.avisExamen)?vm.avisExamenSelected=lodash.find(vm.tabAvisExamens,{code:vm.avisExamen.code}):vm.avisExamenSelected="",vm.tabEngagementsEleveAvecPrecision=vm.currentEleve.engagementsEleveAvecPrecision,vm.backupEleve=angular.copy(eleve),vm.backupAvisEngagement=angular.copy(vm.avisEngagement),vm.backupAutreEngagement=angular.copy(vm.autreEngagement),vm.backupAvisInvestissement=angular.copy(vm.avisInvestissement),vm.backupAvisChefEtab=angular.copy(vm.avisChefEtab),vm.backupAvisExamen=angular.copy(vm.avisExamen),vm.backupAvisExamenSelected=angular.copy(vm.avisExamenSelected),vm.backupEngagementsAvecPrecision=angular.copy(vm.tabEngagementsEleveAvecPrecision)}function isEngagementEleve(engagementScolaire){var engagementEleve=lodash.find(vm.currentEleve.engagementsEleve,{code:engagementScolaire.code});return engagementEleve.isActif}function selectEngagement(engagementSelected){var engagementEleve=lodash.find(vm.currentEleve.engagementsEleve,{code:engagementSelected.code});engagementEleve.isActif=!engagementEleve.isActif,vm.watchBlockChange.engagements=!0}function print(){window.print()}function onChange(typeChangement){$rootScope.navigationDisabled=!0,vm.allIsSaved=!1,(!vm.currentClasse.isPP&&!vm.saisieAvisEngagementsOnlyByPP||vm.currentClasse.isPP||Auth.isPersonnel())&&(vm.hasError=("undefined"==typeof vm.avisInvestissement.prenomAuteur||""===vm.avisInvestissement.prenomAuteur)&&""!==vm.avisInvestissement.texte||("undefined"==typeof vm.avisEngagement.prenomAuteur||""===vm.avisEngagement.prenomAuteur)&&""!==vm.avisEngagement.texte),vm.hasError||!vm.currentClasse.isClasseTerminale||(vm.saisieAvisCESOnlyByPersonnel||Auth.isPersonnel())&&!Auth.isPersonnel()||(vm.hasError=("undefined"==typeof vm.avisChefEtab.prenomAuteur||""===vm.avisChefEtab.prenomAuteur)&&""!==vm.avisChefEtab.texte),vm.hasError||(vm.hasError=angular.isDefined(lodash.find(vm.tabEngagementsEleveAvecPrecision,function(engagementAvecPrecis){return engagementAvecPrecis.libelle.length>300}))),vm.hasError||("avisInvestissement"===typeChangement&&""===vm.avisInvestissement.date&&(vm.avisInvestissement.date=moment().format("YYYY-MM-DD")),"avisChefEtab"===typeChangement&&""===vm.avisChefEtab.date&&(vm.avisChefEtab.date=moment().format("YYYY-MM-DD")),"avisEngagement"===typeChangement&&""===vm.avisEngagement.date&&(vm.avisEngagement.date=moment().format("YYYY-MM-DD")),"avisInvestissement"===typeChangement&&""===vm.avisInvestissement.prenomAuteur&&(vm.avisInvestissement.prenomAuteur=Auth.currentUser().prenom),"avisInvestissement"===typeChangement&&""===vm.avisInvestissement.nomAuteur&&(vm.avisInvestissement.nomAuteur=Auth.currentUser().nom),"avisChefEtab"===typeChangement&&""===vm.avisChefEtab.prenomAuteur&&(vm.avisChefEtab.prenomAuteur=Auth.currentUser().prenom),"avisChefEtab"===typeChangement&&""===vm.avisChefEtab.nomAuteur&&(vm.avisChefEtab.nomAuteur=Auth.currentUser().nom),"avisEngagement"===typeChangement&&""===vm.avisEngagement.prenomAuteur&&(vm.avisEngagement.prenomAuteur=Auth.currentUser().prenom),"avisEngagement"===typeChangement&&""===vm.avisEngagement.nomAuteur&&(vm.avisEngagement.nomAuteur=Auth.currentUser().nom),"engagementAvecPrecision"===typeChangement&&(vm.isOneEngagementAvecPrecisionUpdated=!vm.isOneEngagementAvecPrecisionUpdated),vm.nbLimitReached.avisInvestissement=vm.avisInvestissement.texte.length>300,vm.nbLimitReached.avisChefEtab=vm.avisChefEtab.texte.length>300,vm.nbLimitReached.avisEngagement=vm.avisEngagement.texte.length>300,vm.nbLimitReached.autreEngagement=vm.autreEngagement.texte.length>300,vm.hasError=lodash.filter(vm.nbLimitReached,function(entry){return entry}).length>0)}function openDetailsEleve(){$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return vm.currentEleve},periode:function(){return""},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function setTriByClasse(){vm.sortByClasse=!0,vm.currentClasse.eleves=sortEleves(vm.currentClasse.eleves)}function setTriAlpha(){vm.sortByClasse=!1,vm.currentClasse.eleves=sortEleves(vm.currentClasse.eleves)}function sortEleves(eleves){return vm.sortByClasse?lodash.chain(eleves).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.prenom).toUpperCase()}).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.nom).toUpperCase()}).sortBy(function(eleve){return eleve.ordreArrivee}).sortBy(function(eleve){return eleve.codeClasse}).value():lodash.chain(eleves).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.prenom).toUpperCase()}).sortBy(function(eleve){return CarnetNotesService.removeDiacritics(eleve.nom).toUpperCase()}).sortBy(function(eleve){return eleve.ordreArrivee}).value()}function getEvaluationEleve(codeCompetence){var libelleComp="",comp=lodash.find(vm.currentMatiere.competences,{code:codeCompetence});angular.isDefined(comp)&&(libelleComp=comp.libelle);var eleveMatiere=lodash.find(vm.currentEleve.matieres,{code:vm.currentMatiere.code,modaliteElection:vm.currentMatiere.modaliteElection}),competence=lodash.find(eleveMatiere.competences,{code:codeCompetence});if(angular.isDefined(competence))return competence.libelle=libelleComp,competence;var newEval={code:codeCompetence,evaluation:"-1",libelle:libelleComp};return eleveMatiere.competences.push(newEval),newEval}function evalAll(valeur){$rootScope.navigationDisabled=!0,vm.allIsSaved=!1,lodash.forEach(vm.competencesElevesOfMatiere,function(competence){competence.evaluation=valeur})}function cancelSaisie(){$rootScope.navigationDisabled=!1,vm.allIsSaved=!0,vm.currentEleve=angular.copy(vm.backupEleve),vm.avisEngagement=angular.copy(vm.backupAvisEngagement),vm.autreEngagement=angular.copy(vm.backupAutreEngagement),vm.avisInvestissement=angular.copy(vm.backupAvisInvestissement),vm.avisChefEtab=angular.copy(vm.backupAvisChefEtab),vm.avisExamen=angular.copy(vm.backupAvisExamen),vm.avisExamenSelected=angular.copy(vm.backupAvisExamenSelected),vm.tabEngagementsEleveAvecPrecision=angular.copy(vm.backupEngagementsAvecPrecision);var indexEleveToUpdate=lodash.findIndex(vm.currentClasse.eleves,{id:vm.currentEleve.id});vm.currentClasse.eleves[indexEleveToUpdate]=vm.currentEleve,selectEleve(vm.backupEleve)}function openListAuteurs(typeAvis){var modalInstance=$uibModal.open({templateUrl:"modules/LSL/selectionAuteurs.html",controller:"SelectionAuteursCtrl",controllerAs:"auteursCtrl",size:"lg",backdrop:!0,resolve:{auteurs:function(){return vm.tabAuteurs}}});modalInstance.result.then(function(data){angular.isDefined(data.id)&&(vm[typeAvis].prenomAuteur=data.prenom,vm[typeAvis].nomAuteur=data.nom,onChange())})}function saveEleve(form,_eleve){var eleve=angular.copy(_eleve),tabAvisEleve=[];angular.isDefined(vm.avisChefEtab)&&(vm.avisChefEtab.type=constantesLSL.AVIS.TYPES.CHEFETAB,vm.avisChefEtab.code="",angular.isDefined(vm.avisChefEtab.date)&&null!==vm.avisChefEtab.date&&""!==vm.avisChefEtab.date?vm.avisChefEtab.date=moment(vm.avisChefEtab.date).format("YYYY-MM-DD"):vm.avisChefEtab.date="",tabAvisEleve.push(vm.avisChefEtab)),angular.isDefined(vm.autreEngagement)&&(vm.autreEngagement.type=constantesLSL.AVIS.TYPES.ENGAGEMENT_AUTRE,vm.autreEngagement.code="",tabAvisEleve.push(vm.autreEngagement)),angular.isDefined(vm.avisEngagement)&&(vm.avisEngagement.type=constantesLSL.AVIS.TYPES.ENGAGEMENT,vm.avisEngagement.code="",angular.isDefined(vm.avisEngagement.date)&&null!==vm.avisEngagement.date&&""!==vm.avisEngagement.date?vm.avisEngagement.date=moment(vm.avisEngagement.date).format("YYYY-MM-DD"):vm.avisEngagement.date="",tabAvisEleve.push(vm.avisEngagement)),angular.isDefined(vm.avisExamen)&&(vm.avisExamen.type=constantesLSL.AVIS.TYPES.EXAMEN,vm.avisExamen.nomAuteur="",vm.avisExamen.prenomAuteur="",vm.avisExamen.date="",angular.isUndefined(vm.avisExamenSelected)||null===vm.avisExamenSelected||""===vm.avisExamenSelected?vm.avisExamen.code="":vm.avisExamen.code=vm.avisExamenSelected.code,tabAvisEleve.push(vm.avisExamen)),angular.isDefined(vm.avisInvestissement)&&(vm.avisInvestissement.type=constantesLSL.AVIS.TYPES.INVESTISSEMENT,vm.avisInvestissement.code="",angular.isDefined(vm.avisInvestissement.date)&&null!==vm.avisInvestissement.date&&""!==vm.avisInvestissement.date?vm.avisInvestissement.date=moment(vm.avisInvestissement.date).format("YYYY-MM-DD"):vm.avisInvestissement.date="",tabAvisEleve.push(vm.avisInvestissement)),eleve.avisEleve=lodash.merge(eleve.avisEleve,tabAvisEleve),eleve.engagementsEleveAvecPrecision=vm.tabEngagementsEleveAvecPrecision,vm.watchBlockChange.avisChefEtab!==!0&&lodash.remove(eleve.avisEleve,{type:constantesLSL.AVIS.TYPES.CHEFETAB}),vm.watchBlockChange.avisEngagement!==!0&&lodash.remove(eleve.avisEleve,{type:constantesLSL.AVIS.TYPES.ENGAGEMENT}),vm.watchBlockChange.autreEngagement!==!0&&lodash.remove(eleve.avisEleve,{type:constantesLSL.AVIS.TYPES.ENGAGEMENT_AUTRE}),vm.watchBlockChange.avisExamen!==!0&&lodash.remove(eleve.avisEleve,{type:constantesLSL.AVIS.TYPES.EXAMEN}),vm.watchBlockChange.avisInvestissement!==!0&&lodash.remove(eleve.avisEleve,{type:constantesLSL.AVIS.TYPES.INVESTISSEMENT}),vm.watchBlockChange.engagements!==!0&&(delete eleve.engagementsEleve,eleve.engagementsEleve=[]),vm.watchBlockChange.engagementsAvecPrecision!==!0&&(delete eleve.engagementsEleveAvecPrecision,eleve.engagementsEleveAvecPrecision=[]),eleve.matieres=lodash.reduce(eleve.matieres,function(total,matiere){return vm.watchBlockChange.competencesMatiere[matiere.code]===!0&&total.push(matiere),total},[]),vm.promiseLoading=LslService.saveEleve(Auth.role(),Auth.idUser(),eleve).then(function(eleveUpdated){$rootScope.navigationDisabled=!1,vm.allIsSaved=!0;var indexEleveToUpdate=lodash.findIndex(vm.currentClasse.eleves,{id:eleve.id});vm.currentClasse.eleves[indexEleveToUpdate]=_eleve,angular.forEach(eleveUpdated.avisEleve,function(avis){var lindex=lodash.findIndex(vm.currentClasse.eleves[indexEleveToUpdate].avisEleve,function(av){return av.type===avis.type});lindex>=0?vm.currentClasse.eleves[indexEleveToUpdate].avisEleve[lindex]=avis:vm.currentClasse.eleves[indexEleveToUpdate].avisEleve.push(avis)}),vm.watchBlockChange.engagements===!0&&(vm.currentClasse.eleves[indexEleveToUpdate].engagementsEleve=eleveUpdated.engagementsEleve),vm.watchBlockChange.engagementsAvecPrecision===!0&&(vm.currentClasse.eleves[indexEleveToUpdate].engagementsEleveAvecPrecision=eleveUpdated.engagementsEleveAvecPrecision),eleve.matieres=lodash.reduce(_eleve.matieres,function(total,matiere){var lindex=lodash.findIndex(eleveUpdated.matieres,function(mat){return mat.code===matiere.code});return lindex>=0?total.push(eleveUpdated.matieres[lindex]):total.push(matiere),total},[]),vm.backupEleve=angular.copy(_eleve),vm.backupAvisEngagement=angular.copy(vm.avisEngagement),vm.backupAutreEngagement=angular.copy(vm.autreEngagement),vm.backupEngagementsAvecPrecision=angular.copy(vm.tabEngagementsEleveAvecPrecision),vm.backupAvisInvestissement=angular.copy(vm.avisInvestissement),vm.backupAvisChefEtab=angular.copy(vm.avisChefEtab),vm.backupAvisExamen=angular.copy(vm.avisExamen),vm.backupAvisExamenSelected=angular.copy(vm.avisExamenSelected),Notification.notify("Sauvegarde du LSL","Les données ont bien été enregistrées pour l'élève <strong>"+$filter("displayNom")(eleve,!0)+"</strong>!","success","fa fa-certificate"),form.$setPristine(),vm.watchBlockChange=angular.copy(defaultWatchState)},function(error){Notification.notify("Sauvegarde du LSL","Une erreur s'est produite lors de la sauvegarde","error","fa fa-certificate")})}function refresh(){vm.watchBlockChange=angular.copy(defaultWatchState);var lesPromises=[];lesPromises.push(LslService.get(Auth.role(),Auth.idUser()).then(function(data){vm.classes=data.classes,vm.tabAvisExamens=data.avisExamens,vm.tabEngagementsScolaire=data.engagementsScolaire,vm.tabEngagementsScolaireAvecPrecision=data.engagementsScolaireAvecPrecision,vm.saisieAvisEngagementsOnlyByPP=data.saisieAvisEngagementsSeulementPP,vm.saisieAvisCESOnlyByPersonnel=data.saisieAvisCESeulementParPersonnel})),lesPromises.push(UtilisateursService.listAll("professeurs").then(function(dataProfesseurs){vm.professeurs=dataProfesseurs.utilisateurs})),lesPromises.push(UtilisateursService.listAll("personnels").then(function(dataPersonnels){vm.personnels=dataPersonnels.utilisateurs})),vm.promiseLoading=$q.all(lesPromises).then(function(){vm.tabAuteurs=lodash.chain(vm.tabAuteurs).union(vm.professeurs,vm.personnels).sortBy("nom").value()})}var vm=this;vm.Math=window.Math,vm.idUser=Auth.currentUser().id,vm.tabAvisExamens=[],vm.CONSTANTES=LslService.CONSTANTES,vm.allIsSaved=!0,vm.libelleDefautSelect="Sélectionner une matière",vm.isOneEngagementAvecPrecisionUpdated=!1;var constantesLSL=vm.CONSTANTES;vm.nbLimitReached={},vm.hasError=!1;var defaultWatchState={competencesMatiere:{},engagements:!1,engagementsAvecPrecision:!1,avisExamen:!1,avisEngagement:!1,autreEngagement:!1,avisInvestissement:!1,avisChefEtab:!1};vm.thelslForm=void 0,$scope.$watch("controlerLSL.avisExamenSelected",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.avisExamen=!0)})),$scope.$watch("controlerLSL.isOneEngagementAvecPrecisionUpdated",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.engagementsAvecPrecision=!0)})),$scope.$watch("controlerLSL.avisEngagement",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.avisEngagement=!0)}),!0),$scope.$watch("controlerLSL.autreEngagement",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.autreEngagement=!0)}),!0),$scope.$watch("controlerLSL.avisInvestissement",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.avisInvestissement=!0)}),!0),$scope.$watch("controlerLSL.avisChefEtab",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.avisChefEtab=!0)}),!0),$scope.$watch("controlerLSL.currentEleve.matieres",lodash.after(2,function(newValue,oldValue){"undefined"==typeof vm.thelslForm||vm.thelslForm.$touched||vm.hasError||vm.allIsSaved||newValue===oldValue||(vm.watchBlockChange.competencesMatiere[vm.currentMatiere.code]=!0)}),!0),vm.datePicker={dateOptions:{formatYear:"yy",startingDay:1},format:"dd/MM/yyyy"},vm.setlslForm=setlslForm,vm.cancelSaisie=cancelSaisie,vm.selectMatiere=selectMatiere,vm.onChange=onChange,vm.selectEleve=selectEleve,vm.openEngagementSaisiLe=openEngagementSaisiLe,vm.openInvestissementSaisiLe=openInvestissementSaisiLe,vm.openChefEtabSaisiLe=openChefEtabSaisiLe,vm.isEngagementEleve=isEngagementEleve,vm.selectEngagement=selectEngagement,vm.print=print,vm.lodash=lodash,vm.openDetailsEleve=openDetailsEleve,vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.selectClasse=selectClasse,vm.refresh=refresh,vm.getEvaluationEleve=getEvaluationEleve,vm.evalAll=evalAll,vm.openListAuteurs=openListAuteurs,vm.saveEleve=saveEleve,vm.initAvisEleve=initAvisEleve,vm.langueVivante=langueVivante,refresh()}]),angular.module("edsiteApp.LSL").directive("ligneEvalLslCompetence",function(){return{restrict:"A",scope:{eleve:"=",index:"=",nbOfCompToDisplay:"=",currentCompetence:"=",lslCtrl:"="},controller:"ligneEvalLSLDirective",controllerAs:"cCtrl",templateUrl:"modules/LSL/competence-lsl-ligne-template.html",link:function(scope,element,attrs){}}}).controller("ligneEvalLSLDirective",["$scope",function($scope){}]),angular.module("edsiteApp.LSL").factory("LslService",["$http","$q","$filter","lodash","EDHttp",function($http,$q,$filter,lodash,EDHttp){var service={};return service.CONSTANTES={AVIS:{TYPES:{ENGAGEMENT:"AVIS_ENGAGEMENT",INVESTISSEMENT:"AVIS_INVESTISSEMENT",CHEFETAB:"AVIS_CHEFETAB",ENGAGEMENT_AUTRE:"ENGAGEMENT_AUTRE",EXAMEN:"AVIS_EXAMEN"}}},service.get=function(typeUser,idUser){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/LSL";return new EDHttp({method:"GET",url:baseUrl,cache:!0,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.saveEleve=function(typeUser,idUser,eleve){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/LSL/eleves/"+eleve.id;return new EDHttp({method:"POST",url:baseUrl,cache:!1,data:{eleve:eleve}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.LSL").controller("SelectionAuteursCtrl",["$uibModalInstance","auteurs",function($uibModalInstance,auteurs){function close(){$uibModalInstance.dismiss()}function selectAuteur(auteur){$uibModalInstance.close(auteur)}var vm=this;vm.tabAuteurs=auteurs,vm.itemsByPage=15,vm.displayedPages=7,vm.close=close,vm.selectAuteur=selectAuteur}]),angular.module("edsiteApp.Utilisateurs",[]).service("UtilisateursService",["$q","EDHttp",function($q,EDHttp){var mUtilisateursService={};return mUtilisateursService.listAll=function(typeUser){var defer=$q.defer(),data={},baseUrl="utilisateurs/"+typeUser;return new EDHttp({method:"GET",url:baseUrl,cache:!0,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mUtilisateursService}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionEspaceTravailCtrl",["options","destinataires","toCcCci","MessagerieService","Auth","$uibModalInstance","EspacestravailService","lodash",function(options,destinataires,toCcCci,MessagerieService,Auth,$uibModalInstance,EspacestravailService,lodash){function close(){$uibModalInstance.dismiss()}function refresh(){vm.promiseLoading=EspacestravailService.listeEspacesTravail(idUser,typeUser).then(function(lesEspaces){var tabEspacesTravail=lesEspaces;tabEspacesTravail=lodash.reject(tabEspacesTravail,{estMembre:!1}),vm.espacesTravail=tabEspacesTravail},function(error){})}var vm=this;vm.selection=options,vm.destinatairesCache=[],vm.destinataires=destinataires||[],vm.displayedDestinataires=[].concat(vm.destinataires),vm.oneIsSelected=!1,vm.requestLoading=!1,vm.showallPP=!1,vm.constantes=EspacestravailService.CONSTANTES;var typeUser=Auth.role(),idUser=Auth.idUser();this.objDestinataires={};var self=this;vm.btnLibelleAjout="Ajouter les destinataires sélectionnés",vm.close=close,vm.refresh=refresh,vm.search=function(){vm.requestLoading=!0,vm.promiseLoading=MessagerieService.getEspaceTravailContacts(vm.selection).then(function(contacts){vm.destinatairesCache=angular.copy(contacts),vm.destinataires=contacts,angular.forEach(vm.destinataires,function(dest){dest.isSelected=!1}),vm.requestLoading=!1},function(){vm.requestLoading=!1})},vm.addGroupeDestinataire=function(destinataires,selection){self.objDestinataires.destinataires=lodash.filter(destinataires,{isSelected:!0}),self.objDestinataires.selection=selection,self.objDestinataires.selection.type=Auth.TYPE_USER.ESPACE_TRAVAIL,$uibModalInstance.close(self.objDestinataires)},vm.selectDestinataire=function(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter(vm.destinataires,{isSelected:!0});vm.oneIsSelected=selectedDest&&selectedDest.length>0?!0:!1},vm.selectAll=function(isSelectAll){angular.forEach(vm.destinataires,function(dest){dest.isSelected=isSelectAll,vm.selectDestinataire(dest)})},vm.refresh()}]),angular.module("edsiteApp.messagerie").controller("MessageComposeSelectionListeContactsCtrl",["options","destinataires","toCcCci","MessagerieService","Auth","$uibModal","$uibModalInstance","lodash","Notification",function(options,destinataires,toCcCci,MessagerieService,Auth,$uibModal,$uibModalInstance,lodash,Notification){function close(){$uibModalInstance.dismiss()}function addListesContactsToMessage(){var tabGroupesDestinataires=lodash.chain(vm.listesContacts).filter({isSelected:!0}).pluck("contacts").flatten().value();lodash.chain(tabGroupesDestinataires).pluck("destinataires").flatten().value().map(function(dest){dest.to_cc_cci=toCcCci}),$uibModalInstance.close(tabGroupesDestinataires)}function countDestinatairesListe(listeContact){return lodash.chain(listeContact.contacts).pluck("destinataires").flatten().value().length}function onSelectListeContacts(listeContacts,updateListe){void 0===listeContacts.isSelected&&(listeContacts.isSelected=!1),updateListe&&(listeContacts.isSelected=!listeContacts.isSelected),vm.oneIsSelected=lodash.filter(vm.listesContacts,{isSelected:!0}).length>0}function selectAll(isSelectAll){angular.forEach(vm.listesContacts,function(liste){liste.isSelected=isSelectAll,vm.onSelectListeContacts(liste)})}function showConfirmDeleteListeContacts(listeContacts){var modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression de la liste de contacts",config.message="Êtes-vous sûr de vouloir supprimer la liste de contacts <b>"+listeContacts.libelle+"</b> ?",config.confirm="Supprimer",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=MessagerieService.deleteListeContacts(listeContacts.id).then(function(){Notification.notify("Liste de contacts","La liste de contacts a été supprimée avec succès !","success",!0),vm.refresh(!0),modalInstance.close()},function(error){Notification.notify("Erreur","Une erreur est survenue lors de la suppression de la liste de contacts","danger")})})}function refresh(forceReload){vm.promiseLoading=MessagerieService.getListesContacts(forceReload).then(function(listesContacts){vm.listesContacts=angular.copy(listesContacts)},function(error){Notification.notify("Erreur","Une erreur est survenu lors de la récupération des listes de contacts","danger")})}var vm=this;vm.promiseLoading=null,vm.selection=options,vm.listesContacts=[],vm.displayedListesContacts=[].concat(vm.listesContacts),vm.destinataires=destinataires||[],vm.oneIsSelected=!1;Auth.role(),Auth.idUser();vm.close=close,vm.refresh=refresh,vm.onSelectListeContacts=onSelectListeContacts,vm.addListesContactsToMessage=addListesContactsToMessage,vm.selectAll=selectAll,vm.countDestinatairesListe=countDestinatairesListe,vm.showConfirmDeleteListeContacts=showConfirmDeleteListeContacts,vm.refresh()}]),angular.module("edsiteApp.Commun").controller("PortailsesidocCtrl",["Auth","ModuleService","lodash","$routeParams","Settings",function(Auth,ModuleService,lodash,$routeParams,Settings){var vm=this;vm.lesPortails=[];var idUser=$routeParams.idUser;if((angular.isUndefined(idUser)||!idUser)&&(idUser=""),ModuleService.isModuleEnabled(ModuleService.CODES.ESIDOC,idUser)){var paramsEsidoc=ModuleService.getModule(ModuleService.CODES.ESIDOC,idUser).params;if(angular.isDefined(paramsEsidoc.tabParams))for(var nbrePortailsEsidoc=lodash.size(paramsEsidoc.tabParams),i=0;nbrePortailsEsidoc>i;i++)vm.lesPortails.push({id:i,urlEsidoc:paramsEsidoc.tabParams[i].url,labelEsidoc:paramsEsidoc.tabParams[i].libelle||"Portail CDI"})}vm.goToService=function(url){var settings=Settings.allSettings(),action=settings.apiUri+"cas/goToService"+settings.apiExtension+"?service="+url,formElement=angular.element("<form/>");formElement.attr({method:"POST",target:"_blank",action:action});var tokenElement=angular.element("<input />");tokenElement.attr({type:"hidden",value:Auth.token(),name:"token"}),formElement.append(tokenElement),formElement.appendTo("body").submit(),formElement.remove()}}]),angular.module("edsiteApp.EspacesTravail").controller("EspacetravailAgendaCtrl",["$uibModal","$filter","$routeParams","Auth","AgendaService","$scope","ModuleService",function($uibModal,$filter,$routeParams,Auth,AgendaService,$scope,ModuleService){function openCreateDialog(){var modalInstance=$uibModal.open({templateUrl:"modules/agenda/agenda-evenement-form.html",controller:"AgendaEvenementEditCtrl",backdrop:!1,windowClass:"dialog-agenda",resolve:{options:function(){var options={};return options.title="Création d'un événement",options.mode="create",options.idUser=vm.idEspace,options.typeUser=vm.typeUser,options.selectedTargets=vm.targetsAgenda,options.displayTargets="false",options.prolexisEnable="1"===ModuleService.getModule(ModuleService.CODES.CLOUD).params.prolexisEnable,options},event:function(){return{}}}});modalInstance.result.then(function(){$scope.$broadcast("refresh-agenda-events")})}var vm=this;vm.openCreateDialog=openCreateDialog,vm.typeUser=Auth.TYPE_USER.ESPACE_TRAVAIL,vm.idEspace=$routeParams.idEspaceTravail,vm.scheduler=AgendaService.scheduler;var cibleEspace=Auth.TYPE_USER.ESPACE_TRAVAIL+vm.idEspace;vm.targetsAgenda=[cibleEspace]}]),angular.module("edsiteApp.Agenda").directive("selectAgendas",function(){return{templateUrl:"modules/agenda/select-agendas-template.html",restrict:"E",scope:{},controller:"selectAgendasDirective",controllerAs:"cCtrl",link:function($scope){}}}).controller("selectAgendasDirective",["$scope","$uibModal","EmploiDuTempsService",function($scope,$uibModal,EmploiDuTempsService){function openModalIcalLink(agenda){var modalIcalLink=$uibModal.open({templateUrl:"modules/agenda/ical-link-modal.template.html",controller:"IcalLinkModalCtrl",controllerAs:"icalLinkModalCtrl",backdrop:!1,resolve:{agenda:function(){return agenda}}});modalIcalLink.result.then(function(){},function(){})}var vm=this;vm.isOpen=!0,vm.agendasToDisplay=EmploiDuTempsService.agendasToDisplay,
vm.openModalIcalLink=openModalIcalLink}]),angular.module("edsiteApp").service("DhxSchedulerService",["Auth","lodash","$uibModalStack","$uibModal","$filter","Utils","AgendaService","AppelService",function(Auth,lodash,$uibModalStack,$uibModal,$filter,Utils,AgendaService,AppelService){var mDhxSchedulerService={};mDhxSchedulerService.getTextColor=function(event){return Utils.getTextColor(event.color)},mDhxSchedulerService.renderEventHeader=function(start,end,event){var contenu="",picto="";if("AGENDA"===event.typeEvenement){var isAgendaEspaceTravail=lodash.find(event.cibles,function(cible){return-1!==cible.search("W")}),isAgendaReservationSalle=!isAgendaEspaceTravail&&AgendaService.isReservationSalle(event);picto=isAgendaEspaceTravail?'<i class="fa icon-ed_espacedetravail"></i>&nbsp;':isAgendaReservationSalle?'<i class="fa fa-calendar"></i>&nbsp;':'<i class="fa fa-calendar-o"></i>&nbsp;';var textColorAgenda=mDhxSchedulerService.getTextColor(event);if(contenu+='<span class="edt-cours-header" style="color: '+textColorAgenda+'">',contenu+=picto,isAgendaReservationSalle&&angular.isDefined(event.typeEntity))if(event.typeEntity===AppelService.typeEntity.SALLE){var auteur=angular.copy(event.auteur);auteur.civilite="",contenu+=$filter("displayNom")(auteur,!0,!0)}else contenu+=angular.isDefined(event.localisation)?event.localisation.libelle:event.libelle;else contenu+=event.libelle,contenu+=" ",contenu+=scheduler.templates.event_date(start)+" - "+scheduler.templates.event_date(end);contenu+="</span>"}else{var textColor=mDhxSchedulerService.getTextColor(event);contenu+='<span class="edt-cours-header" style="color: '+textColor+'">',event.isAnnule?contenu+="ANNULÉ":(event.isFlexible&&(contenu+='<i class="icon-ed_gestiondesgroupes"></i> '),contenu+=scheduler.templates.event_date(start)+" - "+scheduler.templates.event_date(end),angular.isDefined(event.salle)&&""!==event.salle.trim()&&(contenu+='<span class="pull-right">En '+mDhxSchedulerService.htmlEntities(event.salle)+"</span>")),contenu+="</span>"}return contenu},mDhxSchedulerService.htmlEntities=function(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},mDhxSchedulerService.renderEventText=function(start,end,event){var contenu="";if("AGENDA"===event.typeEvenement){var textColorAgenda=mDhxSchedulerService.getTextColor(event);contenu+='<div style="color: '+textColorAgenda+'">',contenu+=event.libelle?event.libelle:event.description,contenu+="</div>"}else{var textColor=mDhxSchedulerService.getTextColor(event);event.isModifie&&(contenu+='<i class="fa fa-warning pull-right" title="cours modifié" style="color: '+textColor+'"></i>'),contenu+='<span class="edt-cours-text" style="color: '+textColor+'">'+event.text+"</span>",("P"===Auth.role()||"A"===Auth.role())&&(contenu+="<br>",contenu+='<span class="edt-prof" style="color: '+textColor+'">',contenu+=event.classe+event.groupe,contenu+="</span>"),event.prof&&""!==event.prof.trim()&&(contenu+="<br>",contenu+='<span class="edt-prof" style="color: '+textColor+'">',contenu+=event.prof,contenu+="</span>"),event.dispense>0&&(contenu+="<br>",contenu+='<span class="edt-prof" style="color: '+textColor+'">',contenu+="<i>Dispensé</i>",contenu+="</span>"),contenu+='<div class="cahier-text-icon-bar">',event.icone&&(contenu+='<div class="logoCoursEDT">',contenu+='<img class="cahier-text-icon pull-right" src="'+event.icone+'"/>',contenu+="</div>"),contenu+="</div>"}return contenu},mDhxSchedulerService.renderEventBarDate=function(start,end,event){var contenu="• ",ldebut=format(start),lfin=format(end),maintenant=moment();return(ldebut!==maintenant.startOf("day").format("HH:mm")||lfin!==maintenant.endOf("day").format("HH:mm"))&&(contenu+="<b>"+ldebut+"</b> "),contenu},mDhxSchedulerService.renderEventYearTooltip=function(start,end,event){var contenu="";return contenu+='<span class="edt-cours-text">'+event.libelle+"</span>"},mDhxSchedulerService.renderEventBarText=function(start,end,event){var contenu="";if("AGENDA"===event.typeEvenement){var textColorAgenda=mDhxSchedulerService.getTextColor(event);contenu+='<span class="edt-cours-text" style="color: '+textColorAgenda+'">'+event.libelle+"</span>"}else{var textColor=mDhxSchedulerService.getTextColor(event);contenu+='<span class="edt-cours-text" style="color: '+textColor+'">'+event.text+"</span>"}return contenu};var format=scheduler.date.date_to_str("%H:%i");return mDhxSchedulerService.renderTooltip=function(start,end,event){var html="";if("AGENDA"===event.typeEvenement){var ldebut=format(start),lfin=format(end),maintenant=moment();event.libelle&&(html+="<strong>"+event.libelle+"</strong><br/>"),(ldebut!==maintenant.startOf("day").format("HH:mm")||lfin!==maintenant.endOf("day").format("HH:mm"))&&(html+="<b>Début:</b> "+ldebut+"<br/><b>Fin:</b> "+lfin),event.description&&(html+="<br/><b>Description : </b>"+event.description),html+='<br/><b class="fa fa-user"> Par </b> '+$filter("displayNom")(event.auteur,!1,!0),event.readonly||(html+="<br/>",html+="<b>Double-cliquez sur l'événement pour le modifier</b>")}else html+="<b>Cours: </b> "+event.text,("P"===Auth.role()||"A"===Auth.role())&&(html+="<br/><b>Code matière :</b>"+event.codeMatiere,""!==event.classe&&(html+="<br/><b>Classe: </b> "+event.classe,html+="<br/><b>Code classe: </b> "+event.classeCode),""!==event.groupe&&(html+="<br/><b>Groupe: </b> "+event.groupe,html+="<br/><b>Code groupe: </b>"+event.groupeCode,event.isFlexible&&(html+='<br/><i class="icon-ed_gestiondesgroupes"></i> <i>Groupe flexible</i>'))),event.prof&&(html+="<br/><b>Enseignant: </b> "+event.prof),html+="<br/><b>Début: </b> "+format(start)+"<br/><b>Fin: </b> "+format(end),angular.isDefined(event.salle)&&""!==event.salle.trim()&&(html+="<br/><b>Salle: </b>"+mDhxSchedulerService.htmlEntities(event.salle));return html},mDhxSchedulerService.attacheEvenement=function(id,e){var eCal=$(e.target).parents(".dhx_cal_event"),zindex=eCal.css("z-index");"1"!==zindex?($(".dhx_cal_event").each(function(){$(this).css({"z-index":0})}),eCal.css({"z-index":1})):eCal.css({"z-index":0});var event=scheduler.getEvent(id);return event.dispensable?event.dispense?scheduler.config.icons_select=[]:scheduler.config.icons_select=["icon_dispenser"]:scheduler.config.icons_select=[],!0},mDhxSchedulerService}]),angular.module("edsiteApp.CarnetNotes").directive("ligneEvalEnseignementComp",function(){return{restrict:"A",scope:{eleve:"=",noteCtrl:"=",composanteCtrl:"=",enseignementCompSelected:"=",index:"="},controller:"ligneEnseignementCompDirective",controllerAs:"cCtrl",templateUrl:"modules/notes/enseignant/LSUN/enseignement-complementaire-template.html",link:function(scope,element,attrs){}}}).directive("ligneEvalEnseignementCompConsultation",function(){return{restrict:"A",scope:{eleve:"=",index:"=",noteCtrl:"=",composanteCtrl:"="},controller:"ligneEnseignementCompDirective",controllerAs:"cCtrl",templateUrl:"modules/notes/enseignant/LSUN/enseignement-complementaire-consultation-template.html",link:function(scope,element,attrs){}}}).controller("ligneEnseignementCompDirective",["$rootScope","$scope","$uibModal","lodash",function($rootScope,$scope,$uibModal,lodash){function setCurrentEnseignementComp(enseignementCompSelected,eleve){eleve.enseignementDeComplement=lodash.cloneDeep(enseignementCompSelected),"undefined"==typeof eleve.enseignementDeComplement.positionnement&&("AUC"===enseignementCompSelected.code?eleve.enseignementDeComplement.positionnement=0:eleve.enseignementDeComplement.positionnement=1),vm.evaluationDisabled="AUC"===enseignementCompSelected.code}function openDetailsEleve(eleve){$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}var vm=this;vm.openDetailsEleve=openDetailsEleve,vm.setCurrentEnseignementComp=setCurrentEnseignementComp,vm.Math=window.Math;var enseignementCompPreselected=lodash.find($scope.composanteCtrl.tabEnseignementsComplements,{code:"AUC"});vm.evaluationDisabled=!1,""===$scope.eleve.enseignementDeComplement.code&&($scope.eleve.enseignementDeComplement=enseignementCompPreselected,$scope.eleve.enseignementDeComplement.positionnement=0,vm.evaluationDisabled=!0),$scope.$watch("enseignementCompSelected",function(newValue,oldValue){newValue!==oldValue&&setCurrentEnseignementComp(newValue,$scope.eleve)})}]),angular.module("edsiteApp.CarnetNotes").directive("ligneEvalLangueRegionale",function(){return{restrict:"A",scope:{eleve:"=",noteCtrl:"=",composanteCtrl:"=",index:"=",langueSelected:"="},controller:"ligneLangueRegionaleDirective",controllerAs:"cCtrl",templateUrl:"modules/notes/enseignant/LSUN/langue-regionale-template.html",link:function(scope,element,attrs){}}}).directive("ligneEvalLangueRegionaleConsultation",function(){return{restrict:"A",scope:{eleve:"=",index:"=",noteCtrl:"=",composanteCtrl:"="},controller:"ligneLangueRegionaleDirective",controllerAs:"cCtrl",templateUrl:"modules/notes/enseignant/LSUN/langue-regionale-consultation-template.html",link:function(scope,element,attrs){}}}).controller("ligneLangueRegionaleDirective",["$rootScope","$scope","$uibModal","lodash",function($rootScope,$scope,$uibModal,lodash){function setCurrentLangueRegionale(langueRegionaleSelected,eleve){eleve.langueRegionale=lodash.cloneDeep(langueRegionaleSelected),"undefined"==typeof eleve.langueRegionale.positionnement&&("AUC"===langueRegionaleSelected.code?eleve.langueRegionale.positionnement=0:eleve.langueRegionale.positionnement=1),vm.evaluationDisabled="AUC"===langueRegionaleSelected.code}function openDetailsEleve(eleve){$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}var vm=this;vm.openDetailsEleve=openDetailsEleve,vm.setCurrentLangueRegionale=setCurrentLangueRegionale,vm.Math=window.Math;var langueRegionalePreselected=lodash.find($scope.composanteCtrl.tabLanguesRegionales,{code:"AUC"});""===$scope.eleve.langueRegionale.code&&($scope.eleve.langueRegionale=langueRegionalePreselected,$scope.eleve.langueRegionale.positionnement=0,vm.evaluationDisabled=!0),$scope.$watch("langueSelected",function(newValue,oldValue){newValue!==oldValue&&setCurrentLangueRegionale(newValue,$scope.eleve)})}]),angular.module("edsiteApp.CarnetNotes").controller("EvaluationsVersNotesCtrl",["$uibModalInstance","elementsProgramme","paramsLSU","devoir","user","lodash","CompetencesService","Notification",function($uibModalInstance,elementsProgramme,paramsLSU,devoir,user,lodash,CompetencesService,Notification){function close(){$uibModalInstance.dismiss()}function calculer(){vm.promiseLoading=CompetencesService.modifieBaremesElementsProgramme(vm.user.type,vm.user.id,vm.elementsProgramme).then(function(){$uibModalInstance.close(vm.replaceNote)},function(){$uibModalInstance.close(vm.replaceNote)})}function baremeTotal(){var totalBareme=0;return angular.forEach(vm.elementsProgramme,function(EP){angular.isDefined(EP.bareme)&&(totalBareme+=Number(EP.bareme.replace(",",".")))}),totalBareme}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function updateBaremeElemProg(elemProg){vm.messageErreur="";var baremeElemProg=vm.tabElemsProgCurrent[elemProg.id].bareme;if(angular.isDefined(baremeElemProg)&&(baremeElemProg=baremeElemProg.replace(",",".")),!isNumeric(baremeElemProg))return void(vm.tabElemsProgCurrent[elemProg.id].baremeValide=!1);if("."===baremeElemProg.charAt(baremeElemProg.length-1))return void(vm.tabElemsProgCurrent[elemProg.id].baremeValide=!1);var baremeElemProgEnNumerique=Number(baremeElemProg);return 0>baremeElemProgEnNumerique||baremeElemProgEnNumerique>1e4?(vm.tabElemsProgCurrent[elemProg.id].baremeValide=!1,void(vm.messageErreur="Le barème doit être compris entre 0 et 10000")):(elemProg.bareme=baremeElemProg,void(vm.tabElemsProgCurrent[elemProg.id].baremeValide=!0))}function formIsValid(){return!angular.isDefined(lodash.find(vm.tabElemsProgCurrent,{baremeValide:!1}))}function refresh(){angular.forEach(vm.elementsProgramme,function(EP){angular.isUndefined(EP.bareme)&&(EP.bareme=devoir.noteSur.toString()),vm.tabElemsProgCurrent[EP.id]={baremeValide:!0,bareme:EP.bareme},updateBaremeElemProg(EP)})}var vm=this;vm.elementsProgramme=elementsProgramme,vm.user=user,vm.replaceNote=!1,vm.parametrages=paramsLSU,vm.tabElemsProgCurrent=[],vm.messageErreur="",vm.close=close,vm.calculer=calculer,vm.refresh=refresh,vm.baremeTotal=baremeTotal,vm.updateBaremeElemProg=updateBaremeElemProg,vm.formIsValid=formIsValid,refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("NotesVersEvaluationsCtrl",["$uibModalInstance","devoir","paramsLSU","user","Auth","$q","Notification","ParametrageService",function($uibModalInstance,devoir,paramsLSU,user,Auth,$q,Notification,ParametrageService){function ratioBorneFromBdd(fromBDD){var resultat=fromBDD;try{vm.devoir.noteSur>0&&angular.isDefined(fromBDD)&&(resultat=Number(fromBDD)*vm.devoir.noteSur/20,resultat+="")}catch(e){console.log("error ratioBorneFromBdd : ",e)}return resultat}function ratioBorneToBdd(toBDD){var resultat=toBDD;try{vm.devoir.noteSur>0&&angular.isDefined(toBDD)&&(resultat=20*Number(toBDD)/vm.devoir.noteSur,resultat+="")}catch(e){console.log("error ratioBorneToBdd : ",e)}return resultat}function hasChanged(){vm.allDatasSaved=!1}function borneMinFormat(borne){var borneCalculate=Number(borne.replace(",","."))+.01;return borneCalculate.toFixed(2)}function close(){$uibModalInstance.dismiss()}function calculer(){if(vm.allDatasSaved)$uibModalInstance.close(vm.replaceEval);else{var lesPromises=[ParametrageService.updateParametrageIndividuel(vm.user.id,vm.user.type,Auth.CONSTANTS.POIL_DANS_LA_MAIN_BORNE+"1",ratioBorneToBdd(vm.borne1)),ParametrageService.updateParametrageIndividuel(vm.user.id,vm.user.type,Auth.CONSTANTS.POIL_DANS_LA_MAIN_BORNE+"2",ratioBorneToBdd(vm.borne2)),ParametrageService.updateParametrageIndividuel(vm.user.id,vm.user.type,Auth.CONSTANTS.POIL_DANS_LA_MAIN_BORNE+"3",ratioBorneToBdd(vm.borne3))];vm.promiseLoading=$q.all(lesPromises).then(function(){Notification.notify("Compétences","Vos différents intervalles ont bien été sauvegardés","success","icon-ed_note"),$uibModalInstance.close(vm.replaceEval)},function(){Notification.notify("Compétences","Une erreur est survenue lors de l'enregistrement de vos intervalles","error","icon-ed_note")})}}function updateBorne(borne,finalCall){finalCall=angular.isUndefined(finalCall)?!1:finalCall;var valeurBorne=vm["borne"+borne];if(angular.isUndefined(valeurBorne))return void(vm.formIsValid[borne-1]=!1);if(valeurBorne=valeurBorne.replace(",","."),!isNumeric(valeurBorne))return void(vm.formIsValid[borne-1]=!1);if("."===valeurBorne.charAt(valeurBorne.length-1))return void(vm.formIsValid[borne-1]=!1);try{var valeurBorneNum=Number(valeurBorne),valeurBorneMoins1=0;borne>1&&(valeurBorneMoins1=Number(vm["borne"+(borne-1)].replace(",",".")));var valeurBornePlus1=Number(devoir.noteSur);3>borne&&(valeurBornePlus1=Number(vm["borne"+(borne+1)].replace(",","."))),.1>valeurBorneNum||valeurBorneNum>Number(devoir.noteSur)?vm.formIsValid[borne-1]=!1:valeurBorneMoins1>valeurBorneNum?vm.formIsValid[borne-1]=!1:valeurBorneNum>=valeurBornePlus1?vm.formIsValid[borne-1]=!1:(vm.formIsValid[borne-1]=!0,vm["bornePerso"+borne]=valeurBorne,valeurBorne=ratioBorneToBdd(valeurBorne),Auth.setParametresIndividuel("lsuPoilDansLaMainBorne"+borne,valeurBorne))}catch(e){return void(vm.formIsValid[borne-1]=!1)}finalCall||(1!==borne&&updateBorne(1,!0),2!==borne&&updateBorne(2,!0),3!==borne&&updateBorne(3,!0))}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}function refresh(){updateBorne(1),updateBorne(2),updateBorne(3)}var vm=this;vm.devoir=devoir,vm.replaceEval=!1,vm.parametrages=paramsLSU,vm.user=user,vm.formIsValid=[!0,!0,!0],vm.allDatasSaved=!0,vm.ratioBorneFromBdd=ratioBorneFromBdd,vm.ratioBorneToBdd=ratioBorneToBdd,vm.borneMinFormat=borneMinFormat,vm.close=close,vm.calculer=calculer,vm.updateBorne=updateBorne,vm.hasChanged=hasChanged,vm.refresh=refresh,vm.bornePerso1=ratioBorneFromBdd(Auth.listParametresIndividuels("lsuPoilDansLaMainBorne1")),vm.bornePerso2=ratioBorneFromBdd(Auth.listParametresIndividuels("lsuPoilDansLaMainBorne2")),vm.bornePerso3=ratioBorneFromBdd(Auth.listParametresIndividuels("lsuPoilDansLaMainBorne3")),vm.borne1=angular.copy(vm.bornePerso1),vm.borne2=angular.copy(vm.bornePerso2),vm.borne3=angular.copy(vm.bornePerso3),refresh()}]),angular.module("edsiteApp.CarnetNotes").controller("pratiqueEnseignementCtrl",["PratiquesEnseignementService","$scope","$q","Auth","Notification","lodash","$filter","CarnetNotesService","$uibModal","ModuleService","$rootScope","AppreciationsPredefiniesService","base64decodeFilter",function(PratiquesEnseignementService,$scope,$q,Auth,Notification,lodash,$filter,CarnetNotesService,$uibModal,ModuleService,$rootScope,AppreciationsPredefiniesService,base64decodeFilter){function setTriByClasse(){vm.sortByClasse=!0,vm.eleves=sortEleves(vm.eleves)}function setTriAlpha(){vm.sortByClasse=!1,vm.eleves=sortEleves(vm.eleves)}function sortEleves(eleves){return vm.sortByClasse?lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).sortBy(function(eleveNote){return eleveNote.eleve.codeClasse}).value():lodash.chain(eleves).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.prenom).toUpperCase()}).sortBy(function(eleveNote){return CarnetNotesService.removeDiacritics(eleveNote.eleve.nom).toUpperCase()}).sortBy(function(eleveNote){return eleveNote.eleve.ordreArrivee}).value()}function getLibelleConseil(periode){return CarnetNotesService.getLibelleConseil(periode)}function appreciationsPredefiniesCallBack(params){var defer=$q.defer(),resultat=lodash.filter(vm.appreciationsPredefinies,function(app){var trouve=!1;return(-1!==app.libelle.toLowerCase().indexOf(params.query.toLowerCase())||-1!==app.code.toLowerCase().indexOf(params.query.toLowerCase()))&&(trouve=!0),trouve});return defer.resolve(resultat),defer.promise}function duplicateEntry(indexMatiere){var valueToDuplicate="";"AP"===$scope.noteCtrl.matiere.code&&angular.forEach(vm.eleves,function(eleve,key){0===key&&(valueToDuplicate=eleve.accompagnementsPerso[indexMatiere].commentaireDecode),eleve.accompagnementsPerso[indexMatiere].commentaireDecode=valueToDuplicate,vm.onChangeSaisie(eleve.accompagnementsPerso[indexMatiere].commentaireDecode,vm.nbMaxCaracteres,eleve,indexMatiere)}),"EPI"===$scope.noteCtrl.matiere.code&&angular.forEach(vm.eleves,function(eleve,key){0===key&&(valueToDuplicate=eleve.EPIS[indexMatiere].commentaireDecode),eleve.EPIS[indexMatiere].commentaireDecode=valueToDuplicate,vm.onChangeSaisie(eleve.EPIS[indexMatiere].commentaireDecode,vm.nbMaxCaracteres,eleve,indexMatiere)}),"PARCOURS"===$scope.noteCtrl.matiere.code&&angular.forEach(vm.eleves,function(eleve,key){0===key&&(valueToDuplicate=eleve.parcours[indexMatiere].commentaireDecode),eleve.parcours[indexMatiere].commentaireDecode=valueToDuplicate,vm.onChangeSaisie(eleve.parcours[indexMatiere].commentaireDecode,vm.nbMaxCaracteres,eleve,indexMatiere)})}function countEleve(){return lodash.filter(vm.eleves,function(eleve){return""===eleve.eleve.dateSortie||eleve.eleve.dateSortie>$scope.noteCtrl.periode.dateDebut}).length}function openDetailsEleve(eleve){vm.seulPPVoieToutesLesNotes||$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!1,keyboard:!1,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return $scope.noteCtrl.periode},tabActive:function(){return 0},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function displayInput(eleve,pratiqueEnseignement){if($scope.noteCtrl.classe.type===vm.TYPES_ENTITIES.CLASSE)return!0;var tabPratiquesEnseignementClasseEleve=[],existForClasseEleve=!1;return"AP"===$scope.noteCtrl.matiere.code&&(tabPratiquesEnseignementClasseEleve=lodash.filter(vm.tabAccompagnementsPersoAllClasses,{idClasse:eleve.idClasse}),existForClasseEleve=angular.isDefined(lodash.find(tabPratiquesEnseignementClasseEleve,{id:pratiqueEnseignement.id}))),"EPI"===$scope.noteCtrl.matiere.code&&(tabPratiquesEnseignementClasseEleve=lodash.filter(vm.tabEPISAllClasses,{idClasse:eleve.idClasse}),existForClasseEleve=angular.isDefined(lodash.find(tabPratiquesEnseignementClasseEleve,{id:pratiqueEnseignement.id}))),"PARCOURS"===$scope.noteCtrl.matiere.code&&(tabPratiquesEnseignementClasseEleve=lodash.filter(vm.tabParcoursAllClasses,{idClasse:eleve.idClasse}),existForClasseEleve=angular.isDefined(lodash.find(tabPratiquesEnseignementClasseEleve,{code:pratiqueEnseignement.code}))),existForClasseEleve}function onChangeSaisie(commentaire,nbMaxCaract,eleve,idxSaisie){"AP"===$scope.noteCtrl.matiere.code&&(eleve.accompagnementsPerso[idxSaisie].isUpdate=!0),"EPI"===$scope.noteCtrl.matiere.code&&(eleve.EPIS[idxSaisie].isUpdate=!0),"PARCOURS"===$scope.noteCtrl.matiere.code&&(eleve.parcours[idxSaisie].isUpdate=!0),vm.nbLimitReached[eleve.eleve.id+"_"+idxSaisie]=commentaire.length>nbMaxCaract,vm.hasError=lodash.filter(vm.nbLimitReached,function(entry){return entry}).length>0,vm.formGlobalIsUpdated=!0,$rootScope.navigationDisabled=!0}function enregistre(formSaisiePratiquesEnseignement){var tabEleves=[];lodash.forEach(vm.eleves,function(eleve){if("AP"===$scope.noteCtrl.matiere.code){var tabAccompagnementsPerso=[];lodash.forEach(eleve.accompagnementsPerso,function(APEleve){var APEleveFormate=angular.copy(APEleve);APEleveFormate.commentaire=$filter("base64encode")(APEleveFormate.commentaireDecode),tabAccompagnementsPerso.push(APEleveFormate)});var APsEleve={idEleve:eleve.eleve.id,accompagnementsPerso:tabAccompagnementsPerso};tabEleves.push(APsEleve)}if("EPI"===$scope.noteCtrl.matiere.code){var tabEPIS=[];lodash.forEach(eleve.EPIS,function(EPIEleve){var EPIEleveFormate=angular.copy(EPIEleve);EPIEleveFormate.commentaire=$filter("base64encode")(EPIEleveFormate.commentaireDecode),tabEPIS.push(EPIEleveFormate)});var EPISEleve={idEleve:eleve.eleve.id,EPIS:tabEPIS};tabEleves.push(EPISEleve)}if("PARCOURS"===$scope.noteCtrl.matiere.code){var tabParcours=[];lodash.forEach(eleve.parcours,function(parcoursEleve){var ParcoursEleveFormate=angular.copy(parcoursEleve);ParcoursEleveFormate.commentaire=$filter("base64encode")(ParcoursEleveFormate.commentaireDecode),tabParcours.push(ParcoursEleveFormate)});var parcoursEleve={idEleve:eleve.eleve.id,parcours:tabParcours};tabEleves.push(parcoursEleve)}}),vm.promiseLoading=PratiquesEnseignementService.save(vm.typeUser,vm.idUser,$scope.noteCtrl.classe,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code,tabEleves).then(function(){Notification.notify("Notes","Sauvegarde de votre saisie effectuée !","success","icon-ed_note"),vm.formGlobalIsUpdated=!1,formSaisiePratiquesEnseignement.$setPristine(),$rootScope.navigationDisabled=!1},function(error){Notification.notify("Notes","Une erreur s'est produite lors de la sauvegarde de votre saisie","error","icon-ed_note")})}function refresh(){return angular.isUndefined($scope.noteCtrl.periode)?void(vm.periodeSelected=void 0):void(angular.isUndefined($scope.noteCtrl.matiere)||$scope.noteCtrl.periodeNotAvailable||(vm.formGlobalIsUpdated=!1,vm.hasError=!1,vm.nbLimitReached={},vm.promiseLoading=PratiquesEnseignementService.get(vm.typeUser,vm.idUser,$scope.noteCtrl.classe,$scope.noteCtrl.periode.codePeriode,$scope.noteCtrl.matiere.code).then(function(datasPratiqueEnseignement){vm.saisieActive=datasPratiqueEnseignement.saisiePossible,vm.eleves=datasPratiqueEnseignement.eleves,vm.nbMaxCaracteres=datasPratiqueEnseignement.nbCaracteresMax,"AP"===$scope.noteCtrl.matiere.code&&(vm.tabAccompagnementsPerso=datasPratiqueEnseignement.accompagnementsPerso,$scope.noteCtrl.classe.type===vm.TYPES_ENTITIES.GROUPE&&(vm.tabAccompagnementsPersoAllClasses=datasPratiqueEnseignement.accompagnementsPerso,vm.tabAccompagnementsPerso=lodash.uniq(vm.tabAccompagnementsPersoAllClasses,"id")),lodash.forEach(vm.eleves,function(eleve){var tabAPEleveFinal=[];lodash.forEach(vm.tabAccompagnementsPerso,function(APEntity){var APIFoundForEleve=lodash.find(eleve.accompagnementsPerso,{id:APEntity.id});APIFoundForEleve?(angular.isUndefined(APIFoundForEleve.commentaireDecode)&&(APIFoundForEleve.commentaireDecode=$filter("base64decode")(APIFoundForEleve.commentaire)),tabAPEleveFinal.push(APIFoundForEleve)):tabAPEleveFinal.push({id:APEntity.id,idClasseAP:APEntity.idClasseAP,libelle:APEntity.libelle,commentaire:"",commentaireDecode:""})}),eleve.accompagnementsPerso=tabAPEleveFinal})),"EPI"===$scope.noteCtrl.matiere.code&&(vm.tabEPIS=datasPratiqueEnseignement.EPIS,$scope.noteCtrl.classe.type===vm.TYPES_ENTITIES.GROUPE&&(vm.tabEPISAllClasses=datasPratiqueEnseignement.EPIS,vm.tabEPIS=lodash.uniq(vm.tabEPISAllClasses,"id")),lodash.forEach(vm.eleves,function(eleve){var tabEPISEleveFinal=[];lodash.forEach(vm.tabEPIS,function(EPIEntity){var EPIFoundForEleve=lodash.find(eleve.EPIS,{id:EPIEntity.id});EPIFoundForEleve?(angular.isUndefined(EPIFoundForEleve.commentaireDecode)&&(EPIFoundForEleve.commentaireDecode=$filter("base64decode")(EPIFoundForEleve.commentaire)),tabEPISEleveFinal.push(EPIFoundForEleve)):tabEPISEleveFinal.push({id:EPIEntity.id,idClasseEPI:EPIEntity.idClasseEPI,libelle:EPIEntity.libelle,commentaire:"",commentaireDecode:""})}),eleve.EPIS=tabEPISEleveFinal})),"PARCOURS"===$scope.noteCtrl.matiere.code&&(vm.tabParcours=datasPratiqueEnseignement.parcours,$scope.noteCtrl.classe.type===vm.TYPES_ENTITIES.GROUPE&&(vm.tabParcoursAllClasses=datasPratiqueEnseignement.parcours,vm.tabParcours=lodash.uniq(vm.tabParcoursAllClasses,"code")),1===$scope.noteCtrl.classe.degre&&(vm.tabParcours=lodash.reject(vm.tabParcours,{code:"PAR_AVN"})),lodash.forEach(vm.eleves,function(eleve){var tabParcoursEleveFinal=[];lodash.forEach(vm.tabParcours,function(ParcoursEntity){var ParcoursFoundForEleve=lodash.find(eleve.parcours,{code:ParcoursEntity.code});ParcoursFoundForEleve?(angular.isUndefined(ParcoursFoundForEleve.commentaireDecode)&&(ParcoursFoundForEleve.commentaireDecode=$filter("base64decode")(ParcoursFoundForEleve.commentaire)),tabParcoursEleveFinal.push(ParcoursFoundForEleve)):tabParcoursEleveFinal.push({code:ParcoursEntity.code,libelle:ParcoursEntity.libelle,commentaire:"",commentaireDecode:""})}),eleve.parcours=tabParcoursEleveFinal}))},function(error){Notification.notify("Notes",error.data.message||"Une erreur s'est produite lors de la récupèration des données","error","icon-ed_note")}),AppreciationsPredefiniesService.get(vm.idUser,$scope.noteCtrl.classe).then(function(lesAppreciations){vm.appreciationsPredefinies=lesAppreciations.appreciations,vm.parametrageAppreciationsPredefinies=lesAppreciations.parametrage;var appPredef=angular.copy(vm.appreciationsPredefinies);lodash.forEach(appPredef,function(appreciation,key){appreciation.libelle=base64decodeFilter(appreciation.libelle)}),vm.appreciationsPredefinies=appPredef})))}var vm=this;vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.TYPES_ENTITIES=CarnetNotesService.typeEntity,vm.CONSTANTES=CarnetNotesService.CONSTANTES,vm.saisieActive=!1;var paramNotes=ModuleService.getModule(ModuleService.CODES.CARNET_NOTES);vm.seulPPVoieToutesLesNotes="1"===paramNotes.params.seulPPVoieToutesLesNotes,vm.searchAppPredefinieAP="",vm.searchAppPredefinieEPI="",vm.searchAppPredefinieParcours="",vm.setTriByClasse=setTriByClasse,vm.setTriAlpha=setTriAlpha,vm.countEleve=countEleve,vm.openDetailsEleve=openDetailsEleve,vm.displayInput=displayInput,vm.onChangeSaisie=onChangeSaisie,vm.enregistre=enregistre,vm.duplicateEntry=duplicateEntry,vm.appreciationsPredefiniesCallBack=appreciationsPredefiniesCallBack,vm.getLibelleConseil=getLibelleConseil,$scope.$watch("noteCtrl.matiere",function(newVal,oldVal){refresh()})}]),angular.module("edsiteApp.CarnetNotes").factory("PratiquesEnseignementService",["$http","$q","EDHttp",function($http,$q,EDHttp){var service={};return service.get=function(typeUser,idUser,entity,codePeriode,codeModuleEnseignement){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/pratiquesEnseignement/"+codeModuleEnseignement;return new EDHttp({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service.save=function(typeUser,idUser,entity,codePeriode,codeModuleEnseignement,eleves){var defer=$q.defer();if(angular.isUndefined(idUser)||angular.isUndefined(typeUser))return defer.reject(),defer.promise;var baseUrl=typeUser+"/"+idUser+"/"+entity.type+"/"+entity.id+"/periodes/"+codePeriode+"/pratiquesEnseignement/"+codeModuleEnseignement,data={};return data.eleves=eleves,new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},service}]),angular.module("edsiteApp.CarnetCorrespondance",["edsiteApp.Commun","ui.bootstrap","edsiteApp.base64filter","g1b.datetime-range"]).controller("ProfCarnetCorrespondanceCtrl",["$scope","$routeParams","$uibModal","$filter","$q","$timeout","$location","$sessionStorage","lodash","Notification","Auth","ModuleService","UserService","ProfCarnetCorrespondanceService","PersonnelconsultationService","Utils","Settings",function($scope,$routeParams,$uibModal,$filter,$q,$timeout,$location,$sessionStorage,lodash,Notification,Auth,ModuleService,UserService,ProfCarnetCorrespondanceService,PersonnelconsultationService,Utils,Settings){function prolexis(){var listToCheck=[{src:document.getElementById("contenuCorrespondance"),type:"txt",label:"Correspondance"}];DiagPlWs.analyze(listToCheck)}function openEleve(eleve){$uibModal.open({templateUrl:"modules/notes/enseignant/details-notes-eleve.html",controller:"DetailsNotesEleveCtrl as detailsNotesCtrl",backdrop:!0,size:"lg",resolve:{eleve:function(){return eleve},periode:function(){return{}},tabActive:function(){return 2},params:function(){return{moduleNoteVisible:!0,moduleVSVisible:!0}}}})}function openDetailCorrespondance(correspondance){var modalInstance=$uibModal.open({templateUrl:"modules/carnetCorrespondance/enseignant/correspondances/detail-correspondance.html",controller:"DetailCorrespondanceCtrl as detailCorrespondanceCtrl",backdrop:!0,size:"lg",resolve:{correspondance:function(){return correspondance}}});modalInstance.result.then(function(isOk){isOk===!0&&refresh()})}function openDetailDemandeSanction(demandeSanction){$uibModal.open({templateUrl:"modules/carnetCorrespondance/enseignant/demandesSanction/detail-demande-sanction.html",controller:"DetailDemandeSanctionCtrl as detailDemandeSanctionCtrl",backdrop:!0,size:"lg",resolve:{demandeSanction:function(){return demandeSanction}}})}function openDetailSuivi(suivi){var modalInstance=$uibModal.open({templateUrl:"modules/carnetCorrespondance/enseignant/suivi/detail-suivi.html",controller:"DetailSuiviCtrl as detailSuiviCtrl",backdrop:!0,size:"lg",resolve:{suivi:function(){return suivi},idEntity:function(){return vm.entitySelected.id},typeEntity:function(){return vm.typeEntity},categoriesSuivi:function(){return vm.listeCategoriesSuivi}}});modalInstance.result.then(function(data){if(angular.isDefined(data)&&data!==!0){var indiceSuivi=lodash.findIndex(vm.listeSuivis,function(suivi){return suivi.id===data.id});indiceSuivi>-1&&vm.listeSuivis.splice(indiceSuivi,1);
}else angular.isDefined(data)&&data===!0&&vm.getCarnetCorrespondance(vm.entitySelected.id,vm.typeEntity)})}function isCorrespondanceSignee(correspondance){return angular.isDefined(correspondance.signature)&&""!==correspondance.signature.dateValidation}function onSelectTousEleves(isToutSelectionner){isToutSelectionner?vm.listeElevesSelected=angular.copy(vm.listeEleves):vm.listeElevesSelected.length=0,vm.filtrerListesParEleves()}function onToggleTousEleves(){vm.listeEleves.length===vm.listeElevesSelected.length?vm.listeElevesSelected.length=0:vm.listeElevesSelected=angular.copy(vm.listeEleves),vm.filtrerListesParEleves()}function isEleveSelected(eleve){return lodash.findIndex(vm.listeElevesSelected,{id:eleve.id})>-1}function onSelectEleve(eleve){vm.isEleveSelected(eleve)?lodash.remove(vm.listeElevesSelected,function(el){return el.id===eleve.id}):vm.listeElevesSelected.push(eleve),vm.filtrerListesParEleves()}function filtrerListesParEleves(){vm.listeCorrespondances=[],angular.forEach(vm.listeElevesSelected,function(eleve){angular.forEach(vm.carnetCorrespondance.correspondances,function(correspondance){angular.isDefined(lodash.find(correspondance.eleves,{idEleve:eleve.id}))&&angular.isUndefined(lodash.find(vm.listeCorrespondances,{dateCreation:correspondance.dateCreation}))&&vm.listeCorrespondances.push(correspondance)})}),vm.listeDemandesSanction=[].concat(lodash.filter(vm.carnetCorrespondance.demandesSanction,function(demandeSanction){return lodash.findIndex(vm.listeElevesSelected,{id:demandeSanction.idEleve})>-1})),vm.listeSuivis=[],angular.forEach(vm.listeElevesSelected,function(eleve){angular.forEach(vm.carnetCorrespondance.suivis,function(suivi){angular.isDefined(lodash.find(suivi.eleves,{idEleve:eleve.id}))&&angular.isUndefined(lodash.find(vm.listeSuivis,{dateCreation:suivi.dateCreation}))&&vm.listeSuivis.push(suivi)})}),vm.listeCorrespondances=lodash.sortBy(vm.listeCorrespondances,"dateCreation").reverse(),vm.listeDemandesSanction=lodash.sortBy(vm.listeDemandesSanction,"dateCreation").reverse(),vm.listeSuivis=lodash.sortBy(vm.listeSuivis,"dateCreation").reverse(),vm.listeDemandesSanctionDisplay=vm.listeDemandesSanction,vm.listeCorrespondancesDisplay=vm.listeCorrespondances,vm.listeSuivisDisplay=vm.listeSuivis}function getCarnetCorrespondance(idEntity,typeEntity){vm.typeEntity=typeEntity,vm.promiseContentsEntity=PersonnelconsultationService.listeEleves(idEntity,"C"===typeEntity?"classes":"groupes").then(function(eleves){return angular.isDefined(eleves)?(vm.listeEleves=eleves.eleves,ProfCarnetCorrespondanceService.getCarnetCorrespondance(idEntity,typeEntity)):void 0}).then(function(carnetCorrespondance){angular.isDefined(carnetCorrespondance)&&(vm.carnetCorrespondance=carnetCorrespondance,vm.carnetCorrespondance.correspondances=ProfCarnetCorrespondanceService.groupElevesParSaisie(vm.carnetCorrespondance.correspondances),vm.listeCorrespondances=[].concat(vm.carnetCorrespondance.correspondances),vm.listeDemandesSanction=[].concat(vm.carnetCorrespondance.demandesSanction),vm.listeTypesSanction=[vm.newDemandeSanction.type].concat(vm.carnetCorrespondance.typesSanction),vm.listeMotifsSanction=[vm.newDemandeSanction.motif].concat(vm.carnetCorrespondance.motifsSanction),vm.listeCategoriesSuivi=[vm.newSuivi.categorie].concat(vm.carnetCorrespondance.categoriesSuivi),vm.carnetCorrespondance.suivis=ProfCarnetCorrespondanceService.groupElevesParSaisie(vm.carnetCorrespondance.suivis),vm.listeSuivis=[].concat(vm.carnetCorrespondance.suivis),vm.parametrage=vm.carnetCorrespondance.parametrage,vm.listeCorrespondances=lodash.sortBy(vm.listeCorrespondances,"dateCreation").reverse(),vm.listeDemandesSanction=lodash.sortBy(vm.listeDemandesSanction,"dateCreation").reverse(),vm.listeSuivis=lodash.sortBy(vm.listeSuivis,"dateCreation").reverse(),vm.filtrerListesParEleves())})}function showConfirmAjout(objet,listeEleves,typeAjout){if(vm.prolexisEnable){var lcontent=document.getElementById("contenuCorrespondance");null!==lcontent&&""!==lcontent.value&&(objet.contenu=lcontent.value)}var config={confirm:"Valider",cancel:"Non"},callbackFn=null,texteEleve=" élève";if(listeEleves.length>1&&(texteEleve=" élèves"),"correspondance"===typeAjout?(config.title="Création d'une nouvelle correspondance",config.message="<p>Êtes-vous vraiment sûr de vouloir envoyer cette correspondance <strong>"+objet.type+"</strong> à <strong>"+listeEleves.length+texteEleve+" </strong> ?</p><p><i>"+objet.contenu+'</i></p><p class="text-danger">Attention ! Une fois créée <strong>vous ne pourrez plus modifier ou supprimer la correspondance</strong></p>',callbackFn=function(){vm.ajouterCorrespondance(objet,listeEleves)}):"demandeSanction"===typeAjout&&(config.title="Création d'une nouvelle demande de sanction",config.message="<p>Êtes-vous vraiment sûr de vouloir envoyer cette demande de sanction à <strong>"+listeEleves.length+texteEleve+"</strong> ?</p><p><i>"+objet.contenu+'</i></p><p class="text-danger">Attention ! Une fois créée <strong>vous ne pourrez plus modifier ou supprimer la demande de sanction</strong></p>',callbackFn=function(){vm.ajouterDemandeSanction(objet,listeEleves)}),null!==callbackFn){var modalConfirm=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"lg",resolve:{config:function(){return config}}});modalConfirm.result.then(function(){callbackFn(),modalConfirm.close()})}}function ajouterCorrespondance(correspondance,listeEleves){var tabIdsEleves=lodash.pluck(listeEleves,"id");tabIdsEleves.length>0?(vm.fichiers.length>0&&(correspondance.uncFichier=vm.fichiers[0].unc),vm.promiseContents=ProfCarnetCorrespondanceService.ajouterCorrespondance(vm.entitySelected.id,vm.typeEntity,correspondance,tabIdsEleves).then(function(data){Notification.notify("Carnet de correspondance","Enregistrement de votre correspondance effectué !","success",!0),vm.getCarnetCorrespondance(vm.entitySelected.id,vm.typeEntity),vm.isModeAjout=!1,vm.newCorrespondance={type:"",isSignatureDemandee:!1,contenu:""}},function(data){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)})):Notification.notify("Carnet de correspondance","Veuillez sélectionner au minimum un élève.","error",!0)}function ajouterDemandeSanction(demandeSanction,listeEleves){var tabIdsEleves=lodash.pluck(listeEleves,"id");tabIdsEleves.length>0?vm.promiseContents=ProfCarnetCorrespondanceService.ajouterDemandeSanction(vm.entitySelected.id,vm.typeEntity,demandeSanction,tabIdsEleves).then(function(data){Notification.notify("Carnet de correspondance","Enregistrement de votre demande de sanction effectué !","success",!0),vm.getCarnetCorrespondance(vm.entitySelected.id,vm.typeEntity),vm.isModeAjout=!1,vm.newDemandeSanction={type:angular.copy(vm.typeSanctionDefaut),motif:angular.copy(vm.motifSanctionDefaut),detail:""}},function(data){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)}):Notification.notify("Carnet de correspondance","Veuillez sélectionner au minimum un élève.","error",!0)}function ajouterSuivi(suivi,listeEleves){var tabIdsEleves=lodash.pluck(listeEleves,"id");tabIdsEleves.length>0?(vm.fichiers.length>0&&(suivi.uncFichier=vm.fichiers[0].unc),vm.promiseContents=ProfCarnetCorrespondanceService.ajouterSuivi(vm.entitySelected.id,vm.typeEntity,suivi,tabIdsEleves).then(function(data){Notification.notify("Carnet de correspondance","Enregistrement de votre accompagnement pédagogique effectué !","success",!0),vm.getCarnetCorrespondance(vm.entitySelected.id,vm.typeEntity),vm.isModeAjout=!1,vm.newSuivi={categorie:angular.copy(vm.categorieSuiviDefaut),contenu:""}},function(data){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)})):Notification.notify("Carnet de correspondance","Veuillez sélectionner au minimum un élève.","error",!0)}function setTypeEntitySelected(typeEntity){vm.typeEntitySelected=typeEntity,"#classe"===typeEntity&&($location.search("groupe",null),angular.isDefined(vm.currentClasse)&&""!==vm.currentClasse),"#groupe"===typeEntity&&angular.isDefined(vm.currentGroupe)&&""!==vm.currentGroupe}function onSelectClasse(classe){$location.search().groupe&&$location.search("groupe",null),delete $sessionStorage["carnet-correspondance-groupe"],$sessionStorage["carnet-correspondance-classe"]=classe,vm.entitySelected=classe,$location.path("/Enseignant/CarnetCorrespondance/").search("classe",classe.id)}function onSelectGroupe(groupe){$location.search().classe&&$location.search("classe",null),delete $sessionStorage["carnet-correspondance-classe"],$sessionStorage["carnet-correspondance-groupe"]=groupe,vm.entitySelected=groupe,$location.path("/Enseignant/CarnetCorrespondance/").search("groupe",groupe.id)}function refresh(){var lesPromises=[UserService.getClassesByEtabs().then(function(classes){vm.listeClasses=classes,angular.isDefined(vm.currentClasse)&&""!==vm.currentClasse&&(vm.entitySelected=lodash.find(vm.listeClasses,function(classe){return classe.id===+vm.currentClasse})),UserService.getGroupes().then(function(groupes){vm.listeGroupes=groupes,angular.isDefined(vm.currentGroupe)&&""!==vm.currentGroupe&&(vm.entitySelected=lodash.find(vm.listeGroupes,function(groupe){return groupe.id===+vm.currentGroupe})),null===vm.entitySelected&&(1===vm.listeClasses.length?vm.onSelectClasse(vm.listeClasses[0]):0===vm.listeClasses.length&&1===vm.listeGroupes.length&&vm.onSelectGroupe(vm.listeGroupes[0]))})}),ProfCarnetCorrespondanceService.getBadgesNonLues().then(function(nonLues){vm.badgesNonLues=nonLues})];vm.promiseContents=$q.all(lesPromises)}var vm=this;vm.refresh=refresh,vm.onSelectClasse=onSelectClasse,vm.onSelectGroupe=onSelectGroupe,vm.setTypeEntitySelected=setTypeEntitySelected,vm.getCarnetCorrespondance=getCarnetCorrespondance,vm.isEleveSelected=isEleveSelected,vm.onSelectEleve=onSelectEleve,vm.onSelectTousEleves=onSelectTousEleves,vm.onToggleTousEleves=onToggleTousEleves,vm.isCorrespondanceSignee=isCorrespondanceSignee,vm.openDetailCorrespondance=openDetailCorrespondance,vm.openDetailDemandeSanction=openDetailDemandeSanction,vm.openDetailSuivi=openDetailSuivi,vm.filtrerListesParEleves=filtrerListesParEleves,vm.ajouterCorrespondance=ajouterCorrespondance,vm.ajouterDemandeSanction=ajouterDemandeSanction,vm.ajouterSuivi=ajouterSuivi,vm.openEleve=openEleve,vm.prolexis=prolexis,vm.showConfirmAjout=showConfirmAjout,vm.typeEntitySelected="#classe",vm.typeCarnetCorrespondanceSelected="#correspondances",vm.entitySelected=null,vm.typeEntity="",vm.listeClasses=[],vm.listeGroupes=[],vm.carnetCorrespondance={},vm.badgesNonLues={classes:{},groupes:{},eleves:{}},vm.currentClasse=$routeParams.classe,vm.currentGroupe=$routeParams.groupe,vm.promiseContents=null,vm.promiseContentsEntity=null,vm.listeEleves=[],vm.listeElevesSelected=[],vm.listeCorrespondances=[],vm.listeCorrespondancesDisplay=[],vm.listeDemandesSanction=[],vm.listeDemandesSanctionDisplay=[],vm.listeSuivis=[],vm.listeSuivisDisplay=[],vm.parametrage={},vm.isModeAjout=!1,vm.listeTypesSanction=[],vm.listeMotifsSanction=[],vm.listeCategoriesSuivi=[],vm.isCloudEnable=ModuleService.isModuleEnabled(ModuleService.CODES.CLOUD),vm.fichiers=[],vm.configInputFile={fromCloudEnabled:!1,keepComplete:!0,dropzoneContainer:".dropzone-container",libelleTitre:"Déposez votre fichier ici, ou sélectionnez un fichier à l'aide du bouton."},vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CC",timeout:3e6,maxFilesize:5,maxFiles:1},vm.newCorrespondance={type:"",isSignatureDemandee:!1,contenu:""},vm.typeSanctionDefaut={code:"",id:0,libelle:""},vm.motifSanctionDefaut={code:"",id:0,libelle:""},vm.newDemandeSanction={type:angular.copy(vm.typeSanctionDefaut),motif:angular.copy(vm.motifSanctionDefaut),detail:""},vm.categorieSuiviDefaut={id:0,libelle:"",couleur:"transparent"},vm.newSuivi={categorie:angular.copy(vm.categorieSuiviDefaut),contenu:""},vm.utils=Utils;var paramModules=ModuleService.getModule(ModuleService.CODES.CARNET_CORRESPONDANCE);vm.prolexisEnable="1"===paramModules.params.prolexisEnable,vm.prolexisEnable&&DiagPlWs.init({sUrlProxy:"https://pprolexis.ecoledirecte.com/prolexis",sCorePath:"scripts/ext/prolexis/DiagPlWs",left:10,top:10,width:850,height:400,excludedElement:".ignore, .hidden"}),angular.isDefined(vm.currentClasse)?(vm.typeEntitySelected="#classe",vm.getCarnetCorrespondance(vm.currentClasse,"C")):angular.isDefined(vm.currentGroupe)&&(vm.typeEntitySelected="#groupe",vm.getCarnetCorrespondance(vm.currentGroupe,"G")),refresh(),ModuleService.clearBadges(ModuleService.CODES.CARNET_CORRESPONDANCE)}]),angular.module("edsiteApp.CarnetCorrespondance").service("ProfCarnetCorrespondanceService",["$q","$http","CacheService","lodash","EDHttp",function($q,$http,CacheService,lodash,EDHttp){function groupElevesParSaisie(listeSaisies){var groupedSaisiesList=[],listeSaisiesSorted=lodash.sortBy(listeSaisies,"dateCreation"),currentKey="",nbSignatures=0;angular.forEach(listeSaisiesSorted,function(saisie){if(currentKey!==saisie.dateCreation){currentKey=saisie.dateCreation,nbSignatures=0;var newEleve1={idEleve:saisie.idEleve,nom:saisie.nom,prenom:saisie.prenom,particule:saisie.particule};angular.isDefined(saisie.signature)&&(newEleve1.signature=saisie.signature,nbSignatures++),groupedSaisiesList[currentKey]=angular.copy(saisie),groupedSaisiesList[currentKey].tabIds=[saisie.id],groupedSaisiesList[currentKey].eleves=[newEleve1],groupedSaisiesList[currentKey].nbSignatures=nbSignatures,delete groupedSaisiesList[currentKey].idEleve,delete groupedSaisiesList[currentKey].nom,delete groupedSaisiesList[currentKey].prenom,delete groupedSaisiesList[currentKey].particule}else{var newOtherEleve={idEleve:saisie.idEleve,nom:saisie.nom,prenom:saisie.prenom,particule:saisie.particule};angular.isDefined(saisie.signature)&&(newOtherEleve.signature=saisie.signature,nbSignatures++),groupedSaisiesList[currentKey].eleves.push(newOtherEleve),groupedSaisiesList[currentKey].tabIds.push(saisie.id),groupedSaisiesList[currentKey].nbSignatures=nbSignatures}});var newSaisiesList=[];for(var key in groupedSaisiesList)newSaisiesList.push(groupedSaisiesList[key]);return newSaisiesList}function getCarnetCorrespondance(idEntity,typeEntity){var defer=$q.defer(),data={},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance";return CacheService.removeMatch(/.*\/badgesNonLues/),$http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function ajouterCorrespondance(idEntity,typeEntity,correspondance,tabIdsEleves){var defer=$q.defer(),data={correspondance:correspondance,tabIdsEleves:tabIdsEleves},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance?typeAjout=correspondance";return CacheService.removeMatch(/.*\/carnetCorrespondance/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function ajouterDemandeSanction(idEntity,typeEntity,demandeSanction,tabIdsEleves){var defer=$q.defer(),data={demandeSanction:demandeSanction,tabIdsEleves:tabIdsEleves},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance?typeAjout=demandeSanction";return CacheService.removeMatch(/.*\/carnetCorrespondance/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function ajouterSuivi(idEntity,typeEntity,suivi,tabIdsEleves){var defer=$q.defer(),data={suivi:suivi,tabIdsEleves:tabIdsEleves},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance?typeAjout=suivi";return CacheService.removeMatch(/.*\/carnetCorrespondance/),$http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function updateSuivi(idEntity,typeEntity,suivi){var defer=$q.defer(),data={suivi:suivi},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance?typeAjout=suivi";return CacheService.removeMatch(/.*\/carnetCorrespondance/),$http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function supprimerListeSuivis(idEntity,typeEntity,tabIdsSuivis){var defer=$q.defer(),data={suivis:tabIdsSuivis},baseUrl=("C"===typeEntity?"classes/":"groupes/")+idEntity+"/carnetCorrespondance/suivis";return CacheService.removeMatch(/.*\/carnetCorrespondance/),$http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function getBadgesNonLues(){var defer=$q.defer();return EDHttp({method:"GET",url:"carnetCorrespondance/badgesNonLues",data:{},cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function markCAsRead(correspondance){var defer=$q.defer(),data={id:correspondance.id,idDestinataire:correspondance.destinataire.id,typeDestinataire:correspondance.destinataire.type};return CacheService.removeMatch(/.*\/badgesNonLues/),$http({method:"PUT",url:"carnetCorrespondance/badgesNonLues",data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}var mCarnetCorrespondance={};return mCarnetCorrespondance.getCarnetCorrespondance=getCarnetCorrespondance,mCarnetCorrespondance.ajouterCorrespondance=ajouterCorrespondance,mCarnetCorrespondance.ajouterDemandeSanction=ajouterDemandeSanction,mCarnetCorrespondance.groupElevesParSaisie=groupElevesParSaisie,mCarnetCorrespondance.ajouterSuivi=ajouterSuivi,mCarnetCorrespondance.updateSuivi=updateSuivi,mCarnetCorrespondance.supprimerListeSuivis=supprimerListeSuivis,mCarnetCorrespondance.getBadgesNonLues=getBadgesNonLues,mCarnetCorrespondance.markCAsRead=markCAsRead,mCarnetCorrespondance}]),angular.module("edsiteApp.CarnetCorrespondance").controller("DetailCorrespondanceCtrl",["$uibModalInstance","correspondance","Auth","ProfCarnetCorrespondanceService","moment","Notification",function($uibModalInstance,correspondance,Auth,ProfCarnetCorrespondanceService,moment,Notification){function marquerCommeLue(){vm.correspondance.lu!==!0&&ProfCarnetCorrespondanceService.markCAsRead(vm.correspondance).then(function(data){vm.correspondance.destinataire.lu=!0,data.dateLu&&(vm.correspondance.destinataire.dateLu=data.dateLu),Notification.notify("Carnet de correspondance","La correspondance a été marquée comme lu","success",!0),$uibModalInstance.close(!0)},function(_error){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)})}function close(){$uibModalInstance.close()}var vm=this;vm.close=close,vm.marquerCommeLue=marquerCommeLue,vm.correspondance=correspondance,vm.Auth=Auth}]),angular.module("edsiteApp.CarnetCorrespondance").controller("DetailDemandeSanctionCtrl",["$uibModalInstance","demandeSanction","Auth","$uibModal",function($uibModalInstance,demandeSanction,Auth,$uibModal){function refresh(){}function close(){$uibModalInstance.close()}var vm=this;vm.refresh=refresh,vm.close=close,vm.demandeSanction=demandeSanction,vm.Auth=Auth,refresh()}]),angular.module("edsiteApp.CarnetCorrespondance").controller("DetailSuiviCtrl",["$uibModalInstance","Notification","suivi","idEntity","typeEntity","categoriesSuivi","Auth","$uibModal","ProfCarnetCorrespondanceService","Settings",function($uibModalInstance,Notification,suivi,idEntity,typeEntity,categoriesSuivi,Auth,$uibModal,ProfCarnetCorrespondanceService,Settings){function deleteFile(){vm.editSuivi.urlFichier=""}function submitForm(form){form.$invalid||(vm.fichiers.length>0&&(vm.editSuivi.uncFichier=vm.fichiers[0].unc),vm.promiseContents=ProfCarnetCorrespondanceService.updateSuivi(vm.idEntity,vm.typeEntity,vm.editSuivi).then(function(_data){Notification.notify("Carnet de correspondance","Mise à jour de votre accompagnement pédagogique effectuée !","success",!0),close(!0)},function(_data){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)}))}function close(suivi){$uibModalInstance.close(suivi)}function deleteSuivi(){var callbackFn=function(){ProfCarnetCorrespondanceService.supprimerListeSuivis(vm.idEntity,vm.typeEntity,vm.editSuivi.tabIds).then(function(data){Notification.notify("Carnet de correspondance","Le suivi a bien été supprimé","success",!0),vm.close(vm.editSuivi)},function(error){Notification.notify("Carnet de correspondance",error.data.message||"Une erreur est survenue","error",!0)})},modalInstance=$uibModal.open({templateUrl:"../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'un suivi",config.message="Vous êtes sur le point de supprimer le suivi. Continuer ?",config.confirm="Supprimer",config.cancel="Non",config}}});modalInstance.result.then(callbackFn)}var vm=this;vm.close=close,vm.deleteSuivi=deleteSuivi,vm.deleteFile=deleteFile,vm.submitForm=submitForm,vm.idEntity=idEntity,vm.typeEntity=typeEntity,vm.listeCategoriesSuivi=categoriesSuivi,vm.editSuivi=angular.copy(suivi),vm.fichiers=[],vm.configInputFile={fromCloudEnabled:!1,keepComplete:!0,dropzoneContainer:".dropzone-container",libelleTitre:"Déposez votre fichier ici, ou sélectionnez un fichier à l'aide du bouton."},vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CC",timeout:3e6,maxFilesize:5,maxFiles:1}}]),angular.module("edsiteApp.CarnetCorrespondance").directive("eleveSuivi",function(){return{restrict:"E",scope:{idEleve:"="},controller:"EleveSuiviDirectiveCtrl",controllerAs:"eleveSuiviDirectiveCtrl",templateUrl:"modules/carnetCorrespondance/enseignant/suivi/eleve-suivi-template.html",link:function(scope,element,attrs){}}}).controller("EleveSuiviDirectiveCtrl",["$scope","$q","$sessionStorage","Auth","lodash","UserService","EleveCarnetCorrespondanceService",function($scope,$q,$sessionStorage,Auth,lodash,UserService,EleveCarnetCorrespondanceService){function refresh(){vm.promiseContents=UserService.getEleve(vm.idEleve).then(function(eleve){return vm.eleve=eleve,EleveCarnetCorrespondanceService.getCarnetCorrespondance(eleve.id,"suivi")}).then(function(carnetCorrespondance){vm.listeSuivis=carnetCorrespondance.suivis,angular.forEach(vm.listeSuivis,function(suivi){(""===suivi.categorie.couleur||"transparent"===suivi.categorie.couleur)&&(suivi.categorie.couleur="#d3d3d3")})})}var vm=this;vm.refresh=refresh,vm.idEleve=angular.isDefined($scope.idEleve)?$scope.idEleve:0,vm.eleve={},vm.promiseContents=null,vm.listeSuivis=[],$scope.$watch("idEleve",function(newValue){angular.isDefined(newValue)&&(vm.idEleve=newValue,refresh())})}]),angular.module("edsiteApp.CarnetCorrespondance").controller("EleveCarnetCorrespondanceCtrl",["$scope","$routeParams","Auth","ModuleService",function($scope,$routeParams,Auth,ModuleService){var vm=this;vm.idEleve=$routeParams.ideleve,ModuleService.clearBadges(ModuleService.CODES.CARNET_CORRESPONDANCE,Auth.currentUser().id)}]),angular.module("edsiteApp.CarnetCorrespondance").service("EleveCarnetCorrespondanceService",["$q","$http","Auth",function($q,$http,Auth){function getProfsContacts(selection,eleve){var defer=$q.defer(),nom=selection.nom||"",baseUrl="eleves/"+eleve.id+"/eleveCarnetCorrespondance/contacts/professeurs?idClasse="+eleve.classe.id+"&nom="+nom;return $http({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(error){defer.reject(error)}),defer.promise}function getPersonnelsContacts(eleve){var defer=$q.defer(),baseUrl="eleves/"+eleve.id+"/eleveCarnetCorrespondance/contacts/personnels?idClasse="+eleve.classe.id;return $http({method:"GET",url:baseUrl,data:{},cache:!0}).then(function(response){defer.resolve(response.data.data.contacts)},function(error){defer.reject(error)}),defer.promise}function ajouterCorrespondance(idEleve,correspondance){var defer=$q.defer(),data={correspondance:correspondance},baseUrl="eleves/"+idEleve+"/eleveCarnetCorrespondance";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}function getCarnetCorrespondance(idEleve,type){var defer=$q.defer(),data={type:type},baseUrl="eleves/"+idEleve+"/eleveCarnetCorrespondance";return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function signerCorrespondance(idEleve,correspondance,signature){var defer=$q.defer(),data={correspondance:correspondance,codeSecure:signature.codeSecure},baseUrl="eleves/"+idEleve+"/eleveCarnetCorrespondance";return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}var mCarnetCorrespondance={};return mCarnetCorrespondance.getProfsContacts=getProfsContacts,mCarnetCorrespondance.getPersonnelsContacts=getPersonnelsContacts,mCarnetCorrespondance.ajouterCorrespondance=ajouterCorrespondance,mCarnetCorrespondance.getCarnetCorrespondance=getCarnetCorrespondance,mCarnetCorrespondance.signerCorrespondance=signerCorrespondance,mCarnetCorrespondance}]),angular.module("edsiteApp.CarnetCorrespondance").directive("eleveCarnetCorrespondance",function(){return{restrict:"E",scope:{idEleve:"=",isInModal:"=",typeUser:"="},controller:"EleveCarnetCorrespondanceDirectiveCtrl",controllerAs:"eleveCarnetCorrespondanceDirectiveCtrl",link:function(scope,element,attrs){scope.getTemplateUrl=function(){return scope.Auth.isFamille()?"modules/carnetCorrespondance/famille/gestion-carnet-correspondance.html":"modules/carnetCorrespondance/eleve/carnet-correspondance-template.html"}},template:'<div ng-include="getTemplateUrl()"></div>'}}).controller("EleveCarnetCorrespondanceDirectiveCtrl",["$scope","$rootScope","$uibModal","$filter","$q","$sessionStorage","Auth","lodash","UserService","EleveCarnetCorrespondanceService","Notification","ModuleService","Utils","CacheService",function($scope,$rootScope,$uibModal,$filter,$q,$sessionStorage,Auth,lodash,UserService,EleveCarnetCorrespondanceService,Notification,ModuleService,Utils,CacheService){function closeModalSignature(){vm.d3SecureModal.close()}function updateFilter(){return angular.isUndefined(vm.leFiltre)||""===vm.leFiltre?void(vm.listeCorrespondances=vm.listeCorrespondancesAll):void(vm.listeCorrespondances=lodash.filter(vm.listeCorrespondancesAll,{type:vm.leFiltre}))}function openModalSignature(correspondance){vm.correspondanceASigner=correspondance,vm.d3SecureModal=$uibModal.open({templateUrl:"modules/carnetCorrespondance/eleve/carnet-correspondance-signature.html",scope:$scope,backdrop:!1})}function signerCorrespondance(){vm.promiseContents=EleveCarnetCorrespondanceService.signerCorrespondance(vm.eleve.id,vm.correspondanceASigner,vm.signatureCarnetCorresp).then(function(){Notification.notify("Carnet de correspondance","Vos modifications ont bien été enregistrées !","success"),vm.d3SecureModal.close(),vm.refresh()},function(){Notification.notify("Carnet de correspondance","L'enregistrement de vos modifications a échoué.","error")})}function ajouterCorrespondance(){if(Auth.isFamille()){var modalInstance=$uibModal.open({templateUrl:"modules/carnetCorrespondance/famille/ajout-correspondance.html",controller:"AjoutCCFCtrl as ajoutCCFCtrl",backdrop:!1,size:"lg",resolve:{options:function(){var options={};return options.idEleve=vm.idEleve,options.eleve=vm.eleve,options.parametrages=angular.extend({},vm.parametrages,{destA:"2"===vm.parametrages.destA||"1"===vm.parametrages.destA&&vm.includesA.length>0,destP:"1"===vm.parametrages.destP,destPP:"1"===vm.parametrages.destPP,filtrerCorres:"1"===vm.parametrages.destA}),options.includesA=vm.includesA,options}}});modalInstance.result.then(function(isOk){isOk===!0&&refresh()})}}function peutEcrire(){return Auth.isFamille()===!0&&"1"===vm.parametrages.peutEcrire&&vm.idEleve>0?"1"!==vm.parametrages.destP&&"1"!==vm.parametrages.destPP&&"1"===vm.parametrages.destA?vm.includesA.length>0:"1"!==vm.parametrages.destP&&"1"!==vm.parametrages.destPP&&"1"!==vm.parametrages.destA&&"2"!==vm.parametrages.destA?!1:!0:!1}function changeOngletCarnet(onglet){$scope.$broadcast("EleveCarnetCorrespondanceDirectiveCtrl.ongletSelected",onglet),vm.ongletSelected=onglet}function refresh(){var lesPromises=[UserService.getEleve(vm.idEleve).then(function(eleve){return vm.eleve=eleve,EleveCarnetCorrespondanceService.getCarnetCorrespondance(eleve.id,"correspondance")}).then(function(carnetCorrespondance){vm.listeCorrespondances=carnetCorrespondance.correspondances,vm.listeCorrespondancesAll=angular.copy(carnetCorrespondance.correspondances),vm.listTypeCorresp=[],angular.forEach(vm.listeCorrespondances,function(corres){""!==corres.type&&vm.listTypeCorresp.push(corres.type),corres.auteur.role===Auth.TYPE_USER.PERSONNEL&&vm.includesA.push(corres.auteur.id)}),vm.listTypeCorresp=lodash.uniq(vm.listTypeCorresp),vm.updateFilter()})];vm.promiseContents=$q.all(lesPromises)}var vm=this;vm.refresh=refresh,vm.openModalSignature=openModalSignature,vm.closeModalSignature=closeModalSignature,vm.signerCorrespondance=signerCorrespondance,vm.updateFilter=updateFilter,vm.ajouterCorrespondance=ajouterCorrespondance,vm.peutEcrire=peutEcrire,vm.changeOngletCarnet=changeOngletCarnet,vm.isInModal=angular.isDefined($scope.isInModal)?$scope.isInModal:!1,vm.idEleve=angular.isDefined($scope.idEleve)?$scope.idEleve:0,vm.eleve={},vm.promiseContents=null,vm.listeCorrespondances=[],vm.includesA=[],vm.parametrages=ModuleService.getModule(ModuleService.CODES.CARNET_CORRESPONDANCE,vm.idEleve).params,vm.d3SecureModal={},vm.signatureCarnetCorresp={codeModule:"carnetCorrespondance",codeSecure:""},vm.tabContacts=[{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortable},{idSignataire:Auth.currentUser().id,typeSignataire:Auth.currentUser().typeCompte,telephone:Auth.currentUser().profile.telPortableConjoint}],vm.correspondanceASigner={},vm.ongletSelected="#correspondance",$scope.Auth=Auth,$scope.Utils=Utils,$scope.$watch("idEleve",function(newValue){angular.isDefined(newValue)&&(vm.idEleve=newValue,refresh())})}]),angular.module("edsiteApp.CarnetCorrespondance").controller("AjoutCCFCtrl",["$scope","$uibModalInstance","options","EleveCarnetCorrespondanceService","Auth","Notification","$uibModal","moment","Settings","$filter",function($scope,$uibModalInstance,options,EleveCarnetCorrespondanceService,Auth,Notification,$uibModal,moment,Settings,$filter){function close(){$uibModalInstance.close(!1)}function getListeTypes(){return vm.options.parametrages.typesCorrespondance?vm.options.parametrages.typesCorrespondance.split(SEPARATEUR):[]}function showConfirmAjout(form){vm.hasBeenSend=!0;var config={confirm:"Valider",cancel:"Non"};config.title="Création d'une nouvelle correspondance",config.message="<p>Êtes-vous vraiment sûr de vouloir envoyer cette correspondance <strong>"+vm.newCorrespondance.type+"</strong>?</p><p><i>"+vm.newCorrespondance.contenu+"</i></p><p>à <strong>"+$filter("displayNom")(vm.newCorrespondance.destinataire,!1,!0)+'</strong></p><p class="text-danger">Attention ! Une fois créée <strong>vous ne pourrez plus modifier ou supprimer la correspondance</strong></p>';var callbackFn=function(){vm.ajouterCorrespondance(form)},modalConfirm=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",backdrop:!1,size:"sm",resolve:{config:function(){return config}}});modalConfirm.result.then(function(){modalConfirm.close(),callbackFn()},function(){vm.hasBeenSend=!1})}function ajouterCorrespondance(form){angular.isDefined(vm.newCorrespondance.destinataire)?(vm.fichiers.length>0&&(vm.newCorrespondance.uncFichier=vm.fichiers[0].unc),
vm.newCorrespondance.dateCreation=moment().format("YYYY-MM-DD HH:mm:ss"),vm.requestLoading=EleveCarnetCorrespondanceService.ajouterCorrespondance(vm.options.idEleve,vm.newCorrespondance).then(function(_data){Notification.notify("Carnet de correspondance","Enregistrement de votre correspondance effectué !","success",!0),$uibModalInstance.close(!0)},function(_error){Notification.notify("Carnet de correspondance","Une erreur est survenue","error",!0)})):Notification.notify("Carnet de correspondance","Veuillez sélectionner un destinataire.","error",!0)}function composeSelectionEnseignant(){if(vm.options.parametrages.destP||vm.options.parametrages.destPP){var modalInstance=$uibModal.open({templateUrl:"modules/carnetCorrespondance/famille/correspondance.ajout.selection.enseignant.template.html",controller:"CorrespondanceAjoutSelectionEnseignantCtrl as correspondanceAjoutSelectionEnseignantCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-enseignant",resolve:{options:function(){var options={};return options.destPP=vm.options.parametrages.destPP,options.destP=vm.options.parametrages.destP,options.eleve=vm.options.eleve,options}}});modalInstance.result.then(addDestinataire)}}function composeSelectionPersonnel(){if(vm.options.parametrages.destA){var modalInstance=$uibModal.open({templateUrl:"modules/carnetCorrespondance/famille/correspondance.ajout.selection.personnel.template.html",controller:"CorrespondanceAjoutSelectionPersonnelCtrl as correspondanceAjoutSelectionPersonnelCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-personnel",resolve:{options:function(){var options={};return options.eleve=vm.options.eleve,options.includesA=vm.options.includesA,options.filtrerCorres=vm.options.parametrages.filtrerCorres,options}}});modalInstance.result.then(addDestinataire)}}function addDestinataire(dest){angular.isDefined(dest)&&(vm.newCorrespondance.destinataire=dest)}var SEPARATEUR="¤",vm=this;vm.getListeTypes=getListeTypes,vm.close=close,vm.showConfirmAjout=showConfirmAjout,vm.ajouterCorrespondance=ajouterCorrespondance,vm.composeSelectionEnseignant=composeSelectionEnseignant,vm.composeSelectionPersonnel=composeSelectionPersonnel,vm.addDestinataire=addDestinataire,vm.options=options,vm.hasBeenSend=!1,vm.fichiers=[],vm.configInputFile={fromCloudEnabled:!1,keepComplete:!0,dropzoneContainer:"#dropzone-container-doc-correspondance",libelleTitre:"Déposez votre fichier ici, ou sélectionnez un fichier à l'aide du bouton."},vm.dropzoneConfig={url:Settings.apiUri+"televersement.awp?verbe=post&mode=CC",timeout:3e6,maxFilesize:5,maxFiles:1},vm.newCorrespondance={type:"",contenu:"",isSignatureDemandee:!1,destinataire:void 0,eleve:{id:options.eleve.id,nom:options.eleve.nom,prenom:options.eleve.prenom,particule:options.eleve.particule},auteur:{id:Auth.idUser,role:Auth.role,nom:Auth.currentUser().nom,prenom:Auth.currentUser().prenom,particule:Auth.currentUser().particule}}}]),angular.module("edsiteApp.CarnetCorrespondance").controller("CorrespondanceAjoutSelectionEnseignantCtrl",["$scope","$uibModalInstance","options","MessagerieService","EleveCarnetCorrespondanceService","lodash","Auth",function($scope,$uibModalInstance,options,MessagerieService,EleveCarnetCorrespondanceService,lodash,Auth){function close(){$uibModalInstance.dismiss()}function search(){vm.requestLoading=!0,vm.promiseLoading=EleveCarnetCorrespondanceService.getProfsContacts(vm.selection,vm.eleve).then(function(contacts){vm.destinatairesCache=contacts,angular.forEach(vm.destinatairesCache,function(dest){dest.type=Auth.TYPE_USER.ENSEIGNANT}),vm.destinataires=angular.copy(vm.destinatairesCache),filterPP(),vm.requestLoading=!1},function(){vm.requestLoading=!1})}function filterPP(){vm.selection.isPP?vm.destinataires=lodash.filter(vm.destinataires,{classes:[{isPP:!0}]}):vm.destinataires=angular.copy(vm.destinatairesCache)}function selectDestinataire(destinataire){vm.newDestinataire=destinataire}function addDestinataire(){$uibModalInstance.close(angular.copy(vm.newDestinataire))}var vm=this;vm.close=close,vm.search=search,vm.filterPP=filterPP,vm.selectDestinataire=selectDestinataire,vm.addDestinataire=addDestinataire,vm.destPP=options.destPP,vm.destP=options.destP,vm.eleve=options.eleve,vm.destinataires=[],vm.destinatairesCache=[],vm.requestLoading=!1,vm.displayedDestinataires=[],vm.isPP=MessagerieService.isPP,vm.selection={isP:options.destP,isPP:!options.destP,nom:""},vm.newDestinataire={},search()}]),angular.module("edsiteApp.CarnetCorrespondance").controller("CorrespondanceAjoutSelectionPersonnelCtrl",["$scope","$uibModalInstance","options","EleveCarnetCorrespondanceService","lodash","Auth",function($scope,$uibModalInstance,options,EleveCarnetCorrespondanceService,lodash,Auth){function close(){$uibModalInstance.dismiss()}function initFonction(destinataires){vm.fonctions=[];var tabFonctions={};angular.forEach(destinataires,function(destinataire){tabFonctions[destinataire.fonction.id]=destinataire.fonction}),angular.forEach(tabFonctions,function(laFonction){""!==laFonction.libelle&&vm.fonctions.push(laFonction)})}function search(){vm.requestLoading=!0,vm.promiseLoading=EleveCarnetCorrespondanceService.getPersonnelsContacts(vm.eleve).then(function(contacts){options.filtrerCorres&&options.includesA.length>0?vm.destinatairesCache=lodash.filter(contacts,function(dest){return lodash.includes(options.includesA,dest.id)}):options.filtrerCorres?vm.destinatairesCache=[]:vm.destinatairesCache=contacts,angular.forEach(vm.destinatairesCache,function(dest){dest.type=Auth.TYPE_USER.PERSONNEL}),vm.destinataires=angular.copy(vm.destinatairesCache),vm.selection.fonction?vm.destinataires=lodash.filter(vm.destinataires,{fonction:{id:vm.selection.fonction.id}}):initFonction(vm.destinatairesCache),vm.requestLoading=!1},function(){vm.requestLoading=!1})}function selectDestinataire(destinataire){vm.newDestinataire=destinataire}function addDestinataire(){$uibModalInstance.close(angular.copy(vm.newDestinataire))}var vm=this;vm.close=close,vm.initFonction=initFonction,vm.search=search,vm.selectDestinataire=selectDestinataire,vm.addDestinataire=addDestinataire,vm.eleve=options.eleve,vm.destinataires=[],vm.destinatairesCache=[],vm.requestLoading=!1,vm.displayedDestinataires=[],vm.selection={},vm.newDestinataire={},search()}]),angular.module("edsiteApp.CarnetNotes").controller("GestionCatalogueLSUCtrl",["$scope","$uibModalInstance","options",function($scope,$uibModalInstance,options){function close(){$uibModalInstance.close()}function refresh(){}var vm=this;vm.prof=options.prof,vm.paramsLSU=options.entity.paramsLSU,vm.idCycleEtab=options.entity.idCycleEtab,vm.libelleCycle=vm.paramsLSU.libelleCycle,vm.listeClasses=options.listeClasses,vm.entity=options.entity,vm.selectedDevoir=null,vm.actuelPeriode=options.actuelPeriode,vm.close=close,vm.refresh=refresh,refresh()}]),angular.module("customColorPicker",[]).directive("colorPicker",function(){return{restrict:"E",templateUrl:"/scripts/directives/colorPicker/color-picker.html",scope:{color:"=",options:"=",onColorChanged:"&"},controller:"colorPickerDirectiveController"}}).controller("colorPickerDirectiveController",["$scope",function($scope){$scope.changeColor=function(option){if($scope.color!=option){$scope.color;$scope.color=option,$scope.onColorChanged({newColor:option})}}}]),function(fc){if("undefined"==typeof gc&&"undefined"==typeof top.DiagPlWs){!function(f,T){"object"==typeof module&&"object"==typeof module.exports?module.exports=f.document?T(f,!0):function(G){if(!G.document)throw Error("jQuery requires a window with a document");return T(G)}:T(f)}("undefined"!=typeof window?window:this,function(f,T){function G(a){var e="length"in a&&a.length,g=h.type(a);return"function"===g||h.isWindow(a)?!1:1===a.nodeType&&e?!0:"array"===g||0===e||"number"==typeof e&&e>0&&e-1 in a}function $(a,e,g){if(h.isFunction(e))return h.grep(a,function(k,l){return!!e.call(k,l,k)!==g});if(e.nodeType)return h.grep(a,function(k){return k===e!==g});if("string"==typeof e){if(Oc.test(e))return h.filter(e,a,g);e=h.filter(e,a)}return h.grep(a,function(k){return h.inArray(k,e)>=0!==g})}function W(a,e){do a=a[e];while(a&&1!==a.nodeType);return a}function U(a){var e=hc[a]={};return h.each(a.match(cb)||[],function(g,k){e[k]=!0}),e}function ma(){da.addEventListener?(da.removeEventListener("DOMContentLoaded",ia,!1),f.removeEventListener("load",ia,!1)):(da.detachEvent("onreadystatechange",ia),f.detachEvent("onload",ia))}function ia(){(da.addEventListener||"load"===event.type||"complete"===da.readyState)&&(ma(),h.ready())}function J(a,e,g){if(void 0===g&&1===a.nodeType)if(g="data-"+e.replace(Pc,"-$1").toLowerCase(),g=a.getAttribute(g),"string"==typeof g){try{g="true"===g?!0:"false"===g?!1:"null"===g?null:+g+""===g?+g:Qc.test(g)?h.parseJSON(g):g}catch(k){}h.data(a,e,g)}else g=void 0;return g}function ga(a){for(var e in a)if(("data"!==e||!h.isEmptyObject(a[e]))&&"toJSON"!==e)return!1;return!0}function b(a,e,g,k){if(h.acceptData(a)){var l=h.expando,n=a.nodeType,p=n?h.cache:a,x=n?a[l]:a[l]&&l;if(x&&p[x]&&(k||p[x].data)||void 0!==g||"string"!=typeof e)return x||(x=n?a[l]=Aa.pop()||h.guid++:l),p[x]||(p[x]=n?{}:{toJSON:h.noop}),("object"==typeof e||"function"==typeof e)&&(k?p[x]=h.extend(p[x],e):p[x].data=h.extend(p[x].data,e)),a=p[x],k||(a.data||(a.data={}),a=a.data),void 0!==g&&(a[h.camelCase(e)]=g),"string"==typeof e?(g=a[e],null==g&&(g=a[h.camelCase(e)])):g=a,g}}function c(a,e,g){if(h.acceptData(a)){var k,l,n=a.nodeType,p=n?h.cache:a,x=n?a[h.expando]:h.expando;if(p[x]){if(e&&(k=g?p[x]:p[x].data)){h.isArray(e)?e=e.concat(h.map(e,h.camelCase)):e in k?e=[e]:(e=h.camelCase(e),e=e in k?[e]:e.split(" "));for(l=e.length;l--;)delete k[e[l]];if(g?!ga(k):!h.isEmptyObject(k))return}if(!g&&(delete p[x].data,!ga(p[x])))return;n?h.cleanData([a],!0):R.deleteExpando||p!=p.window?delete p[x]:p[x]=null}}}function d(){return!0}function j(){return!1}function i(){try{return da.activeElement}catch(a){}}function m(a){var e=ic.split("|");if(a=a.createDocumentFragment(),a.createElement)for(;e.length;)a.createElement(e.pop());return a}function q(a,e){var g,k,l=0,n=typeof a.getElementsByTagName!==Za?a.getElementsByTagName(e||"*"):typeof a.querySelectorAll!==Za?a.querySelectorAll(e||"*"):void 0;if(!n)for(n=[],g=a.childNodes||a;null!=(k=g[l]);l++)!e||h.nodeName(k,e)?n.push(k):h.merge(n,q(k,e));return void 0===e||e&&h.nodeName(a,e)?h.merge([a],n):n}function t(a){Rb.test(a.type)&&(a.defaultChecked=a.checked)}function u(a,e){return h.nodeName(a,"table")&&h.nodeName(11!==e.nodeType?e:e.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function A(a){return a.type=(null!==h.find.attr(a,"type"))+"/"+a.type,a}function F(a){var e=Rc.exec(a.type);return e?a.type=e[1]:a.removeAttribute("type"),a}function B(a,e){for(var g,k=0;null!=(g=a[k]);k++)h._data(g,"globalEval",!e||h._data(e[k],"globalEval"))}function K(a,e){if(1===e.nodeType&&h.hasData(a)){var g,k,l;k=h._data(a);var n=h._data(e,k),p=k.events;if(p){delete n.handle,n.events={};for(g in p)for(k=0,l=p[g].length;l>k;k++)h.event.add(e,g,p[g][k])}n.data&&(n.data=h.extend({},n.data))}}function H(a,e){var g,k=h(e.createElement(a)).appendTo(e.body),l=f.getDefaultComputedStyle&&(g=f.getDefaultComputedStyle(k[0]))?g.display:h.css(k[0],"display");return k.detach(),l}function r(a){var e=da,g=jc[a];return g||(g=H(a,e),"none"!==g&&g||(Bb=(Bb||h("<iframe frameborder='0' width='0' height='0'/>")).appendTo(e.documentElement),e=(Bb[0].contentWindow||Bb[0].contentDocument).document,e.write(),e.close(),g=H(a,e),Bb.detach()),jc[a]=g),g}function w(a,e){return{get:function(){var g=a();if(null!=g){if(!g)return(this.get=e).apply(this,arguments);delete this.get}}}}function y(a,e){if(e in a)return e;for(var g=e.charAt(0).toUpperCase()+e.slice(1),k=e,l=kc.length;l--;)if(e=kc[l]+g,e in a)return e;return k}function z(a,e){for(var g,k,l,n=[],p=0,x=a.length;x>p;p++)k=a[p],k.style&&(n[p]=h._data(k,"olddisplay"),g=k.style.display,e?(n[p]||"none"!==g||(k.style.display=""),""===k.style.display&&Cb(k)&&(n[p]=h._data(k,"olddisplay",r(k.nodeName)))):(l=Cb(k),(g&&"none"!==g||!l)&&h._data(k,"olddisplay",l?g:h.css(k,"display"))));for(p=0;x>p;p++)k=a[p],k.style&&(e&&"none"!==k.style.display&&""!==k.style.display||(k.style.display=e?n[p]||"":"none"));return a}function N(a,e,g){return(a=Sc.exec(e))?Math.max(0,a[1]-(g||0))+(a[2]||"px"):e}function V(a,e,g,k,l){e=g===(k?"border":"content")?4:"width"===e?1:0;for(var n=0;4>e;e+=2)"margin"===g&&(n+=h.css(a,g+mb[e],!0,l)),k?("content"===g&&(n-=h.css(a,"padding"+mb[e],!0,l)),"margin"!==g&&(n-=h.css(a,"border"+mb[e]+"Width",!0,l))):(n+=h.css(a,"padding"+mb[e],!0,l),"padding"!==g&&(n+=h.css(a,"border"+mb[e]+"Width",!0,l)));return n}function P(a,e,g){var k=!0,l="width"===e?a.offsetWidth:a.offsetHeight,n=nb(a),p=R.boxSizing&&"border-box"===h.css(a,"boxSizing",!1,n);if(0>=l||null==l){if(l=ob(a,e,n),(0>l||null==l)&&(l=a.style[e]),Hb.test(l))return l;k=p&&(R.boxSizingReliable()||l===a.style[e]),l=parseFloat(l)||0}return l+V(a,e,g||(p?"border":"content"),k,n)+"px"}function ea(a,e,g,k,l){return new ea.prototype.init(a,e,g,k,l)}function ca(){return setTimeout(function(){vb=void 0}),vb=h.now()}function ha(a,e){var g,k={height:a},l=0;for(e=e?1:0;4>l;l+=2-e)g=mb[l],k["margin"+g]=k["padding"+g]=a;return e&&(k.opacity=k.width=a),k}function oa(a,e,g){for(var k,l=(Db[e]||[]).concat(Db["*"]),n=0,p=l.length;p>n;n++)if(k=l[n].call(g,e,a))return k}function ua(a,e){var g,k,l,n,p;for(g in a)if(k=h.camelCase(g),l=e[k],n=a[g],h.isArray(n)&&(l=n[1],n=a[g]=n[0]),g!==k&&(a[k]=n,delete a[g]),(p=h.cssHooks[k])&&"expand"in p){n=p.expand(n),delete a[k];for(g in n)g in a||(a[g]=n[g],e[g]=l)}else e[k]=l}function ja(a,e,g){var k,l=0,n=Ib.length,p=h.Deferred().always(function(){delete x.elem}),x=function(){if(k)return!1;var I=vb||ca();I=Math.max(0,D.startTime+D.duration-I);for(var O=1-(I/D.duration||0),C=0,S=D.tweens.length;S>C;C++)D.tweens[C].run(O);return p.notifyWith(a,[D,O,I]),1>O&&S?I:(p.resolveWith(a,[D]),!1)},D=p.promise({elem:a,props:h.extend({},e),opts:h.extend(!0,{specialEasing:{}},g),originalProperties:e,originalOptions:g,startTime:vb||ca(),duration:g.duration,tweens:[],createTween:function(I,O){var C=h.Tween(a,D.opts,I,O,D.opts.specialEasing[I]||D.opts.easing);return D.tweens.push(C),C},stop:function(I){var O=0,C=I?D.tweens.length:0;if(k)return this;for(k=!0;C>O;O++)D.tweens[O].run(1);return I?p.resolveWith(a,[D,I]):p.rejectWith(a,[D,I]),this}});for(g=D.props,ua(g,D.opts.specialEasing);n>l;l++)if(e=Ib[l].call(D,a,g,D.opts))return e;return h.map(g,oa,D),h.isFunction(D.opts.start)&&D.opts.start.call(a,D),h.fx.timer(h.extend(x,{elem:a,anim:D,queue:D.opts.queue})),D.progress(D.opts.progress).done(D.opts.done,D.opts.complete).fail(D.opts.fail).always(D.opts.always)}function Ea(a){return function(e,g){"string"!=typeof e&&(g=e,e="*");var k,l=0,n=e.toLowerCase().match(cb)||[];if(h.isFunction(g))for(;k=n[l++];)"+"===k.charAt(0)?(k=k.slice(1)||"*",(a[k]=a[k]||[]).unshift(g)):(a[k]=a[k]||[]).push(g)}}function Pa(a,e,g,k){function l(x){var D;return n[x]=!0,h.each(a[x]||[],function(I,O){var C=O(e,g,k);return"string"!=typeof C||p||n[C]?p?!(D=C):void 0:(e.dataTypes.unshift(C),l(C),!1)}),D}var n={},p=a===Sb;return l(e.dataTypes[0])||!n["*"]&&l("*")}function X(a,e){var g,k,l=h.ajaxSettings.flatOptions||{};for(k in e)void 0!==e[k]&&((l[k]?a:g||(g={}))[k]=e[k]);return g&&h.extend(!0,a,g),a}function aa(a,e,g,k){var l;if(h.isArray(e))h.each(e,function(n,p){g||Tc.test(a)?k(a,p):aa(a+"["+("object"==typeof p?n:"")+"]",p,g,k)});else if(g||"object"!==h.type(e))k(a,e);else for(l in e)aa(a+"["+l+"]",e[l],g,k)}function La(){try{return new f.XMLHttpRequest}catch(a){}}function Ma(a){return h.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}var Aa=[],Ua=Aa.slice,va=Aa.concat,gb=Aa.push,pb=Aa.indexOf,$a={},Eb=$a.toString,ab=$a.hasOwnProperty,R={},h=function(a,e){return new h.fn.init(a,e)},Uc=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,Vc=/^-ms-/,Wc=/-([\da-z])/gi,Xc=function(a,e){return e.toUpperCase()};h.fn=h.prototype={jquery:"1.11.3",constructor:h,selector:"",length:0,toArray:function(){return Ua.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:Ua.call(this)},pushStack:function(a){return a=h.merge(this.constructor(),a),a.prevObject=this,a.context=this.context,a},each:function(a,e){return h.each(this,a,e)},map:function(a){return this.pushStack(h.map(this,function(e,g){return a.call(e,g,e)}))},slice:function(){return this.pushStack(Ua.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var e=this.length;return a=+a+(0>a?e:0),this.pushStack(a>=0&&e>a?[this[a]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:gb,sort:Aa.sort,splice:Aa.splice},h.extend=h.fn.extend=function(){var a,e,g,k,l,n=arguments[0]||{},p=1,x=arguments.length,D=!1;for("boolean"==typeof n&&(D=n,n=arguments[p]||{},p++),"object"==typeof n||h.isFunction(n)||(n={}),p===x&&(n=this,p--);x>p;p++)if(null!=(l=arguments[p]))for(k in l)a=n[k],g=l[k],n!==g&&(D&&g&&(h.isPlainObject(g)||(e=h.isArray(g)))?(e?(e=!1,a=a&&h.isArray(a)?a:[]):a=a&&h.isPlainObject(a)?a:{},n[k]=h.extend(D,a,g)):void 0!==g&&(n[k]=g));return n},h.extend({expando:"jQuery"+("1.11.3"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw Error(a)},noop:function(){},isFunction:function(a){return"function"===h.type(a)},isArray:Array.isArray||function(a){return"array"===h.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){return!h.isArray(a)&&a-parseFloat(a)+1>=0},isEmptyObject:function(a){for(var e in a)return!1;return!0},isPlainObject:function(a){var e;if(!a||"object"!==h.type(a)||a.nodeType||h.isWindow(a))return!1;try{if(a.constructor&&!ab.call(a,"constructor")&&!ab.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(g){return!1}if(R.ownLast)for(e in a)return ab.call(a,e);for(e in a);return void 0===e||ab.call(a,e)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?$a[Eb.call(a)]||"object":typeof a},globalEval:function(a){a&&h.trim(a)&&(f.execScript||function(e){f.eval.call(f,e)})(a)},camelCase:function(a){return a.replace(Vc,"ms-").replace(Wc,Xc)},nodeName:function(a,e){return a.nodeName&&a.nodeName.toLowerCase()===e.toLowerCase()},each:function(a,e,g){var k,l=0,n=a.length;if(k=G(a),g){if(k)for(;n>l&&(k=e.apply(a[l],g),k!==!1);l++);else for(l in a)if(k=e.apply(a[l],g),k===!1)break}else if(k)for(;n>l&&(k=e.call(a[l],l,a[l]),k!==!1);l++);else for(l in a)if(k=e.call(a[l],l,a[l]),k===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(Uc,"")},makeArray:function(a,e){var g=e||[];return null!=a&&(G(Object(a))?h.merge(g,"string"==typeof a?[a]:a):gb.call(g,a)),g},inArray:function(a,e,g){var k;if(e){if(pb)return pb.call(e,a,g);for(k=e.length,g=g?0>g?Math.max(0,k+g):g:0;k>g;g++)if(g in e&&e[g]===a)return g}return-1},merge:function(a,e){for(var g=+e.length,k=0,l=a.length;g>k;)a[l++]=e[k++];if(g!==g)for(;void 0!==e[k];)a[l++]=e[k++];return a.length=l,a},grep:function(a,e,g){for(var k=[],l=0,n=a.length,p=!g;n>l;l++)g=!e(a[l],l),g!==p&&k.push(a[l]);return k},map:function(a,e,g){var k,l=0,n=a.length,p=[];if(G(a))for(;n>l;l++)k=e(a[l],l,g),null!=k&&p.push(k);else for(l in a)k=e(a[l],l,g),null!=k&&p.push(k);return va.apply([],p)},guid:1,proxy:function(a,e){var g,k;return"string"==typeof e&&(k=a[e],e=a,a=k),h.isFunction(a)?(g=Ua.call(arguments,2),k=function(){return a.apply(e||this,g.concat(Ua.call(arguments)))},k.guid=a.guid=a.guid||h.guid++,k):void 0},now:function(){return+new Date},support:R}),h.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,e){$a["[object "+e+"]"]=e.toLowerCase()});var Da=function(a){function e(o,v,s,E){var L,Q,M,ba,Y;if((v?v.ownerDocument||v:Ba)!==ya&&Fa(v),v=v||ya,s=s||[],ba=v.nodeType,"string"!=typeof o||!o||1!==ba&&9!==ba&&11!==ba)return s;if(!E&&Ra){if(11!==ba&&(L=Yc.exec(o)))if(M=L[1]){if(9===ba){if(!(Q=v.getElementById(M))||!Q.parentNode)return s;if(Q.id===M)return s.push(Q),s}else if(v.ownerDocument&&(Q=v.ownerDocument.getElementById(M))&&Va(v,Q)&&Q.id===M)return s.push(Q),s}else{if(L[2])return hb.apply(s,v.getElementsByTagName(o)),s;if((M=L[3])&&wa.getElementsByClassName)return hb.apply(s,v.getElementsByClassName(M)),s}if(wa.qsa&&(!xa||!xa.test(o))){if(Q=L=ta,M=v,Y=1!==ba&&o,1===ba&&"object"!==v.nodeName.toLowerCase()){for(ba=Ga(o),(L=v.getAttribute("id"))?Q=L.replace(Zc,"\\$&"):v.setAttribute("id",Q),Q="[id='"+Q+"'] ",M=ba.length;M--;)ba[M]=Q+S(ba[M]);M=Tb.test(o)&&O(v.parentNode)||v,Y=ba.join(",")}if(Y)try{return hb.apply(s,M.querySelectorAll(Y)),s}catch(la){}finally{L||v.removeAttribute("id")}}}return bb(o.replace(Jb,"$1"),v,s,E)}function g(){function o(s,E){return v.push(s+" ")>Z.cacheLength&&delete o[v.shift()],o[s+" "]=E}var v=[];return o}function k(o){return o[ta]=!0,o}function l(o){var v=ya.createElement("div");try{return!!o(v)}catch(s){return!1}finally{v.parentNode&&v.parentNode.removeChild(v)}}function n(o,v){for(var s=o.split("|"),E=o.length;E--;)Z.attrHandle[s[E]]=v}function p(o,v){var s=v&&o,E=s&&1===o.nodeType&&1===v.nodeType&&(~v.sourceIndex||lc)-(~o.sourceIndex||lc);if(E)return E;if(s)for(;s=s.nextSibling;)if(s===v)return-1;return o?1:-1}function x(o){return function(v){return"input"===v.nodeName.toLowerCase()&&v.type===o}}function D(o){return function(v){var s=v.nodeName.toLowerCase();return("input"===s||"button"===s)&&v.type===o}}function I(o){return k(function(v){return v=+v,k(function(s,E){for(var L,Q=o([],s.length,v),M=Q.length;M--;)s[L=Q[M]]&&(s[L]=!(E[L]=s[L]))})})}function O(o){return o&&"undefined"!=typeof o.getElementsByTagName&&o}function C(){}function S(o){for(var v=0,s=o.length,E="";s>v;v++)E+=o[v].value;return E}function fa(o,v,s){var E=v.dir,L=s&&"parentNode"===E,Q=Ub++;return v.first?function(M,ba,Y){for(;M=M[E];)if(1===M.nodeType||L)return o(M,ba,Y)}:function(M,ba,Y){var la,ka,ra=[Na,Q];if(Y){for(;M=M[E];)if((1===M.nodeType||L)&&o(M,ba,Y))return!0}else for(;M=M[E];)if(1===M.nodeType||L){if(ka=M[ta]||(M[ta]={}),(la=ka[E])&&la[0]===Na&&la[1]===Q)return ra[2]=la[2];if(ka[E]=ra,ra[2]=o(M,ba,Y))return!0}}}function Oa(o){return o.length>1?function(v,s,E){for(var L=o.length;L--;)if(!o[L](v,s,E))return!1;return!0}:o[0]}function Sa(o,v,s,E,L){for(var Q,M=[],ba=0,Y=o.length,la=null!=v;Y>ba;ba++)(Q=o[ba])&&(!s||s(Q,E,L))&&(M.push(Q),la&&v.push(ba));return M}function Ta(o,v,s,E,L,Q){return E&&!E[ta]&&(E=Ta(E)),L&&!L[ta]&&(L=Ta(L,Q)),k(function(M,ba,Y,la){var ka,ra,Ia,pa=[],Ha=[],Ja=ba.length;if(!(Ia=M)){Ia=v||"*";for(var na=Y.nodeType?[Y]:Y,ib=[],wb=0,Kb=na.length;Kb>wb;wb++)e(Ia,na[wb],ib);Ia=ib}if(Ia=!o||!M&&v?Ia:Sa(Ia,pa,o,Y,la),na=s?L||(M?o:Ja||E)?[]:ba:Ia,s&&s(Ia,na,Y,la),E)for(ka=Sa(na,Ha),E(ka,[],Y,la),Y=ka.length;Y--;)(ra=ka[Y])&&(na[Ha[Y]]=!(Ia[Ha[Y]]=ra));if(M){if(L||o){if(L){for(ka=[],Y=na.length;Y--;)(ra=na[Y])&&ka.push(Ia[Y]=ra);L(null,na=[],ka,la)}for(Y=na.length;Y--;)(ra=na[Y])&&(ka=L?qb(M,ra):pa[Y])>-1&&(M[ka]=!(ba[ka]=ra))}}else na=Sa(na===ba?na.splice(Ja,na.length):na),L?L(null,ba,na,la):hb.apply(ba,na)})}function xb(o){var v,s,E,L=o.length,Q=Z.relative[o[0].type];s=Q||Z.relative[" "];for(var M=Q?1:0,ba=fa(function(ka){return ka===v},s,!0),Y=fa(function(ka){return qb(v,ka)>-1},s,!0),la=[function(ka,ra,pa){return ka=!Q&&(pa||ra!==jb)||((v=ra).nodeType?ba(ka,ra,pa):Y(ka,ra,pa)),v=null,ka}];L>M;M++)if(s=Z.relative[o[M].type])la=[fa(Oa(la),s)];else{if(s=Z.filter[o[M].type].apply(null,o[M].matches),s[ta]){for(E=++M;L>E&&!Z.relative[o[E].type];E++);return Ta(M>1&&Oa(la),M>1&&S(o.slice(0,M-1).concat({value:" "===o[M-2].type?"*":""})).replace(Jb,"$1"),s,E>M&&xb(o.slice(M,E)),L>E&&xb(o=o.slice(E)),L>E&&S(o))}la.push(s)}return Oa(la)}function Lb(o,v){var s=v.length>0,E=o.length>0,L=function(Q,M,ba,Y,la){var ka,ra,pa,Ha=0,Ja="0",Ia=Q&&[],na=[],ib=jb,wb=Q||E&&Z.find.TAG("*",la),Kb=Na+=null==ib?1:Math.random()||.1,$c=wb.length;for(la&&(jb=M!==ya&&M);Ja!==$c&&null!=(ka=wb[Ja]);Ja++){if(E&&ka){for(ra=0;pa=o[ra++];)if(pa(ka,M,ba)){Y.push(ka);break}la&&(Na=Kb)}s&&((ka=!pa&&ka)&&Ha--,Q&&Ia.push(ka))}if(Ha+=Ja,s&&Ja!==Ha){for(ra=0;pa=v[ra++];)pa(Ia,na,M,ba);if(Q){if(Ha>0)for(;Ja--;)Ia[Ja]||na[Ja]||(na[Ja]=ad.call(Y));na=Sa(na)}hb.apply(Y,na),la&&!Q&&na.length>0&&Ha+v.length>1&&e.uniqueSort(Y)}return la&&(Na=Kb,jb=ib),Ia};return s?k(L):L}var Qa,wa,Z,rb,qa,Ga,Ka,bb,jb,Wa,za,Fa,ya,Ca,Ra,xa,sa,Xa,Va,ta="sizzle"+1*new Date,Ba=a.document,Na=0,Ub=0,mc=g(),nc=g(),oc=g(),Vb=function(o,v){return o===v&&(za=!0),0},lc=-2147483648,bd={}.hasOwnProperty,yb=[],ad=yb.pop,cd=yb.push,hb=yb.push,pc=yb.slice,qb=function(o,v){for(var s=0,E=o.length;E>s;s++)if(o[s]===v)return s;return-1},qc="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w#"),rc="\\[[\\x20\\t\\r\\n\\f]*((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)(?:[\\x20\\t\\r\\n\\f]*([*^$|!~]?=)[\\x20\\t\\r\\n\\f]*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+qc+"))|)[\\x20\\t\\r\\n\\f]*\\]",Wb=":((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+rc+")*)|.*)\\)|)",dd=RegExp("[\\x20\\t\\r\\n\\f]+","g"),Jb=RegExp("^[\\x20\\t\\r\\n\\f]+|((?:^|[^\\\\])(?:\\\\.)*)[\\x20\\t\\r\\n\\f]+$","g"),ed=/^[\x20\t\r\n\f]*,[\x20\t\r\n\f]*/,fd=/^[\x20\t\r\n\f]*([>+~]|[\x20\t\r\n\f])[\x20\t\r\n\f]*/,gd=RegExp("=[\\x20\\t\\r\\n\\f]*([^\\]'\"]*?)[\\x20\\t\\r\\n\\f]*\\]","g"),hd=RegExp(Wb),id=RegExp("^"+qc+"$"),Mb={ID:/^#((?:\\.|[\w-]|[^\x00-\xa0])+)/,CLASS:/^\.((?:\\.|[\w-]|[^\x00-\xa0])+)/,TAG:RegExp("^("+"(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w*")+")"),ATTR:RegExp("^"+rc),PSEUDO:RegExp("^"+Wb),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\([\\x20\\t\\r\\n\\f]*(even|odd|(([+-]|)(\\d*)n|)[\\x20\\t\\r\\n\\f]*(?:([+-]|)[\\x20\\t\\r\\n\\f]*(\\d+)|))[\\x20\\t\\r\\n\\f]*\\)|)","i"),bool:RegExp("^(?:checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)$","i"),needsContext:RegExp("^[\\x20\\t\\r\\n\\f]*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\([\\x20\\t\\r\\n\\f]*((?:-\\d)?\\d*)[\\x20\\t\\r\\n\\f]*\\)|)(?=[^-]|$)","i")},jd=/^(?:input|select|textarea|button)$/i,kd=/^h\d$/i,Fb=/^[^{]+\{\s*\[native \w/,Yc=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,Tb=/[+~]/,Zc=/'|\\/g,db=RegExp("\\\\([\\da-f]{1,6}[\\x20\\t\\r\\n\\f]?|([\\x20\\t\\r\\n\\f])|.)","ig"),eb=function(o,v,s){return o="0x"+v-65536,o!==o||s?v:0>o?String.fromCharCode(o+65536):String.fromCharCode(o>>10|55296,1023&o|56320)},sc=function(){Fa()};try{hb.apply(yb=pc.call(Ba.childNodes),Ba.childNodes)}catch(Td){hb={apply:yb.length?function(o,v){cd.apply(o,pc.call(v))}:function(o,v){for(var s=o.length,E=0;o[s++]=v[E++];);o.length=s-1}}}wa=e.support={},qa=e.isXML=function(o){return(o=o&&(o.ownerDocument||o).documentElement)?"HTML"!==o.nodeName:!1},Fa=e.setDocument=function(o){var v=o?o.ownerDocument||o:Ba;return v!==ya&&9===v.nodeType&&v.documentElement?(ya=v,Ca=v.documentElement,(o=v.defaultView)&&o!==o.top&&(o.addEventListener?o.addEventListener("unload",sc,!1):o.attachEvent&&o.attachEvent("onunload",sc)),Ra=!qa(v),wa.attributes=l(function(s){return s.className="i",!s.getAttribute("className")}),wa.getElementsByTagName=l(function(s){return s.appendChild(v.createComment("")),!s.getElementsByTagName("*").length}),wa.getElementsByClassName=Fb.test(v.getElementsByClassName),wa.getById=l(function(s){return Ca.appendChild(s).id=ta,!v.getElementsByName||!v.getElementsByName(ta).length}),wa.getById?(Z.find.ID=function(s,E){if("undefined"!=typeof E.getElementById&&Ra){var L=E.getElementById(s);return L&&L.parentNode?[L]:[]}},Z.filter.ID=function(s){var E=s.replace(db,eb);return function(L){return L.getAttribute("id")===E}}):(delete Z.find.ID,Z.filter.ID=function(s){var E=s.replace(db,eb);return function(L){return(L="undefined"!=typeof L.getAttributeNode&&L.getAttributeNode("id"))&&L.value===E}}),Z.find.TAG=wa.getElementsByTagName?function(s,E){return"undefined"!=typeof E.getElementsByTagName?E.getElementsByTagName(s):wa.qsa?E.querySelectorAll(s):void 0}:function(s,E){var L,Q=[],M=0,ba=E.getElementsByTagName(s);if("*"===s){for(;L=ba[M++];)1===L.nodeType&&Q.push(L);return Q}return ba},Z.find.CLASS=wa.getElementsByClassName&&function(s,E){return Ra?E.getElementsByClassName(s):void 0},sa=[],xa=[],(wa.qsa=Fb.test(v.querySelectorAll))&&(l(function(s){Ca.appendChild(s).innerHTML="<a id='"+ta+"'></a><select id='"+ta+"-\f]' msallowcapture=''><option selected=''></option></select>",s.querySelectorAll("[msallowcapture^='']").length&&xa.push("[*^$]=[\\x20\\t\\r\\n\\f]*(?:''|\"\")"),s.querySelectorAll("[selected]").length||xa.push("\\[[\\x20\\t\\r\\n\\f]*(?:value|checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)"),s.querySelectorAll("[id~="+ta+"-]").length||xa.push("~="),s.querySelectorAll(":checked").length||xa.push(":checked"),s.querySelectorAll("a#"+ta+"+*").length||xa.push(".#.+[+~]")}),l(function(s){var E=v.createElement("input");E.setAttribute("type","hidden"),s.appendChild(E).setAttribute("name","D"),s.querySelectorAll("[name=d]").length&&xa.push("name[\\x20\\t\\r\\n\\f]*[*^$|!~]?="),s.querySelectorAll(":enabled").length||xa.push(":enabled",":disabled"),s.querySelectorAll("*,:x"),xa.push(",.*:")})),(wa.matchesSelector=Fb.test(Xa=Ca.matches||Ca.webkitMatchesSelector||Ca.mozMatchesSelector||Ca.oMatchesSelector||Ca.msMatchesSelector))&&l(function(s){wa.disconnectedMatch=Xa.call(s,"div"),Xa.call(s,"[s!='']:x"),sa.push("!=",Wb)}),xa=xa.length&&RegExp(xa.join("|")),sa=sa.length&&RegExp(sa.join("|")),Va=(o=Fb.test(Ca.compareDocumentPosition))||Fb.test(Ca.contains)?function(s,E){var L=9===s.nodeType?s.documentElement:s,Q=E&&E.parentNode;return s===Q||!(!Q||1!==Q.nodeType||!(L.contains?L.contains(Q):s.compareDocumentPosition&&16&s.compareDocumentPosition(Q)))}:function(s,E){if(E)for(;E=E.parentNode;)if(E===s)return!0;return!1},Vb=o?function(s,E){if(s===E)return za=!0,0;var L=!s.compareDocumentPosition-!E.compareDocumentPosition;return L?L:(L=(s.ownerDocument||s)===(E.ownerDocument||E)?s.compareDocumentPosition(E):1,1&L||!wa.sortDetached&&E.compareDocumentPosition(s)===L?s===v||s.ownerDocument===Ba&&Va(Ba,s)?-1:E===v||E.ownerDocument===Ba&&Va(Ba,E)?1:Wa?qb(Wa,s)-qb(Wa,E):0:4&L?-1:1)}:function(s,E){if(s===E)return za=!0,0;var L,Q=0;L=s.parentNode;var M=E.parentNode,ba=[s],Y=[E];if(!L||!M)return s===v?-1:E===v?1:L?-1:M?1:Wa?qb(Wa,s)-qb(Wa,E):0;if(L===M)return p(s,E);for(L=s;L=L.parentNode;)ba.unshift(L);for(L=E;L=L.parentNode;)Y.unshift(L);for(;ba[Q]===Y[Q];)Q++;return Q?p(ba[Q],Y[Q]):ba[Q]===Ba?-1:Y[Q]===Ba?1:0},v):ya},e.matches=function(o,v){return e(o,null,null,v)},e.matchesSelector=function(o,v){if((o.ownerDocument||o)!==ya&&Fa(o),v=v.replace(gd,"='$1']"),!(!wa.matchesSelector||!Ra||sa&&sa.test(v)||xa&&xa.test(v)))try{var s=Xa.call(o,v);if(s||wa.disconnectedMatch||o.document&&11!==o.document.nodeType)return s}catch(E){}return e(v,ya,null,[o]).length>0},e.contains=function(o,v){return(o.ownerDocument||o)!==ya&&Fa(o),Va(o,v)},e.attr=function(o,v){(o.ownerDocument||o)!==ya&&Fa(o);var s=Z.attrHandle[v.toLowerCase()];return s=s&&bd.call(Z.attrHandle,v.toLowerCase())?s(o,v,!Ra):void 0,void 0!==s?s:wa.attributes||!Ra?o.getAttribute(v):(s=o.getAttributeNode(v))&&s.specified?s.value:null},e.error=function(o){throw Error("Syntax error, unrecognized expression: "+o)},e.uniqueSort=function(o){var v,s=[],E=0,L=0;if(za=!wa.detectDuplicates,Wa=!wa.sortStable&&o.slice(0),o.sort(Vb),za){for(;v=o[L++];)v===o[L]&&(E=s.push(L));for(;E--;)o.splice(s[E],1)}return Wa=null,o},rb=e.getText=function(o){var v,s="",E=0;if(v=o.nodeType){if(1===v||9===v||11===v){if("string"==typeof o.textContent)return o.textContent;for(o=o.firstChild;o;o=o.nextSibling)s+=rb(o)}else if(3===v||4===v)return o.nodeValue}else for(;v=o[E++];)s+=rb(v);return s},Z=e.selectors={cacheLength:50,createPseudo:k,match:Mb,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(o){return o[1]=o[1].replace(db,eb),o[3]=(o[3]||o[4]||o[5]||"").replace(db,eb),
"~="===o[2]&&(o[3]=" "+o[3]+" "),o.slice(0,4)},CHILD:function(o){return o[1]=o[1].toLowerCase(),"nth"===o[1].slice(0,3)?(o[3]||e.error(o[0]),o[4]=+(o[4]?o[5]+(o[6]||1):2*("even"===o[3]||"odd"===o[3])),o[5]=+(o[7]+o[8]||"odd"===o[3])):o[3]&&e.error(o[0]),o},PSEUDO:function(o){var v,s=!o[6]&&o[2];return Mb.CHILD.test(o[0])?null:(o[3]?o[2]=o[4]||o[5]||"":s&&hd.test(s)&&(v=Ga(s,!0))&&(v=s.indexOf(")",s.length-v)-s.length)&&(o[0]=o[0].slice(0,v),o[2]=s.slice(0,v)),o.slice(0,3))}},filter:{TAG:function(o){var v=o.replace(db,eb).toLowerCase();return"*"===o?function(){return!0}:function(s){return s.nodeName&&s.nodeName.toLowerCase()===v}},CLASS:function(o){var v=mc[o+" "];return v||(v=RegExp("(^|[\\x20\\t\\r\\n\\f])"+o+"([\\x20\\t\\r\\n\\f]|$)"))&&mc(o,function(s){return v.test("string"==typeof s.className&&s.className||"undefined"!=typeof s.getAttribute&&s.getAttribute("class")||"")})},ATTR:function(o,v,s){return function(E){return E=e.attr(E,o),null==E?"!="===v:v?(E+="","="===v?E===s:"!="===v?E!==s:"^="===v?s&&0===E.indexOf(s):"*="===v?s&&E.indexOf(s)>-1:"$="===v?s&&E.slice(-s.length)===s:"~="===v?(" "+E.replace(dd," ")+" ").indexOf(s)>-1:"|="===v?E===s||E.slice(0,s.length+1)===s+"-":!1):!0}},CHILD:function(o,v,s,E,L){var Q="nth"!==o.slice(0,3),M="last"!==o.slice(-4),ba="of-type"===v;return 1===E&&0===L?function(Y){return!!Y.parentNode}:function(Y,la,ka){var ra,pa,Ha,Ja,Ia;la=Q!==M?"nextSibling":"previousSibling";var na=Y.parentNode,ib=ba&&Y.nodeName.toLowerCase();if(ka=!ka&&!ba,na){if(Q){for(;la;){for(pa=Y;pa=pa[la];)if(ba?pa.nodeName.toLowerCase()===ib:1===pa.nodeType)return!1;Ia=la="only"===o&&!Ia&&"nextSibling"}return!0}if(Ia=[M?na.firstChild:na.lastChild],M&&ka){for(ka=na[ta]||(na[ta]={}),ra=ka[o]||[],Ja=ra[0]===Na&&ra[1],Ha=ra[0]===Na&&ra[2],pa=Ja&&na.childNodes[Ja];pa=++Ja&&pa&&pa[la]||(Ha=Ja=0)||Ia.pop();)if(1===pa.nodeType&&++Ha&&pa===Y){ka[o]=[Na,Ja,Ha];break}}else if(ka&&(ra=(Y[ta]||(Y[ta]={}))[o])&&ra[0]===Na)Ha=ra[1];else for(;(pa=++Ja&&pa&&pa[la]||(Ha=Ja=0)||Ia.pop())&&((ba?pa.nodeName.toLowerCase()!==ib:1!==pa.nodeType)||!++Ha||(ka&&((pa[ta]||(pa[ta]={}))[o]=[Na,Ha]),pa!==Y)););return Ha-=L,Ha===E||Ha%E===0&&Ha/E>=0}}},PSEUDO:function(o,v){var s,E=Z.pseudos[o]||Z.setFilters[o.toLowerCase()]||e.error("unsupported pseudo: "+o);return E[ta]?E(v):E.length>1?(s=[o,o,"",v],Z.setFilters.hasOwnProperty(o.toLowerCase())?k(function(L,Q){for(var M,ba=E(L,v),Y=ba.length;Y--;)M=qb(L,ba[Y]),L[M]=!(Q[M]=ba[Y])}):function(L){return E(L,0,s)}):E}},pseudos:{not:k(function(o){var v=[],s=[],E=Ka(o.replace(Jb,"$1"));return E[ta]?k(function(L,Q,M,ba){ba=E(L,null,ba,[]);for(var Y=L.length;Y--;)(M=ba[Y])&&(L[Y]=!(Q[Y]=M))}):function(L,Q,M){return v[0]=L,E(v,null,M,s),v[0]=null,!s.pop()}}),has:k(function(o){return function(v){return e(o,v).length>0}}),contains:k(function(o){return o=o.replace(db,eb),function(v){return(v.textContent||v.innerText||rb(v)).indexOf(o)>-1}}),lang:k(function(o){return id.test(o||"")||e.error("unsupported lang: "+o),o=o.replace(db,eb).toLowerCase(),function(v){var s;do if(s=Ra?v.lang:v.getAttribute("xml:lang")||v.getAttribute("lang"))return s=s.toLowerCase(),s===o||0===s.indexOf(o+"-");while((v=v.parentNode)&&1===v.nodeType);return!1}}),target:function(o){var v=a.location&&a.location.hash;return v&&v.slice(1)===o.id},root:function(o){return o===Ca},focus:function(o){return o===ya.activeElement&&(!ya.hasFocus||ya.hasFocus())&&!!(o.type||o.href||~o.tabIndex)},enabled:function(o){return o.disabled===!1},disabled:function(o){return o.disabled===!0},checked:function(o){var v=o.nodeName.toLowerCase();return"input"===v&&!!o.checked||"option"===v&&!!o.selected},selected:function(o){return o.selected===!0},empty:function(o){for(o=o.firstChild;o;o=o.nextSibling)if(o.nodeType<6)return!1;return!0},parent:function(o){return!Z.pseudos.empty(o)},header:function(o){return kd.test(o.nodeName)},input:function(o){return jd.test(o.nodeName)},button:function(o){var v=o.nodeName.toLowerCase();return"input"===v&&"button"===o.type||"button"===v},text:function(o){var v;return"input"===o.nodeName.toLowerCase()&&"text"===o.type&&(null==(v=o.getAttribute("type"))||"text"===v.toLowerCase())},first:I(function(){return[0]}),last:I(function(o,v){return[v-1]}),eq:I(function(o,v,s){return[0>s?s+v:s]}),even:I(function(o,v){for(var s=0;v>s;s+=2)o.push(s);return o}),odd:I(function(o,v){for(var s=1;v>s;s+=2)o.push(s);return o}),lt:I(function(o,v,s){for(v=0>s?s+v:s;--v>=0;)o.push(v);return o}),gt:I(function(o,v,s){for(s=0>s?s+v:s;++s<v;)o.push(s);return o})}},Z.pseudos.nth=Z.pseudos.eq;for(Qa in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})Z.pseudos[Qa]=x(Qa);for(Qa in{submit:!0,reset:!0})Z.pseudos[Qa]=D(Qa);return C.prototype=Z.filters=Z.pseudos,Z.setFilters=new C,Ga=e.tokenize=function(o,v){var s,E,L,Q,M,ba,Y;if(M=nc[o+" "])return v?0:M.slice(0);for(M=o,ba=[],Y=Z.preFilter;M;){(!s||(E=ed.exec(M)))&&(E&&(M=M.slice(E[0].length)||M),ba.push(L=[])),s=!1,(E=fd.exec(M))&&(s=E.shift(),L.push({value:s,type:E[0].replace(Jb," ")}),M=M.slice(s.length));for(Q in Z.filter)!(E=Mb[Q].exec(M))||Y[Q]&&!(E=Y[Q](E))||(s=E.shift(),L.push({value:s,type:Q,matches:E}),M=M.slice(s.length));if(!s)break}return v?M.length:M?e.error(o):nc(o,ba).slice(0)},Ka=e.compile=function(o,v){var s,E=[],L=[],Q=oc[o+" "];if(!Q){for(v||(v=Ga(o)),s=v.length;s--;)Q=xb(v[s]),Q[ta]?E.push(Q):L.push(Q);Q=oc(o,Lb(L,E)),Q.selector=o}return Q},bb=e.select=function(o,v,s,E){var L,Q,M,ba,Y="function"==typeof o&&o,la=!E&&Ga(o=Y.selector||o);if(s=s||[],1===la.length){if(Q=la[0]=la[0].slice(0),Q.length>2&&"ID"===(M=Q[0]).type&&wa.getById&&9===v.nodeType&&Ra&&Z.relative[Q[1].type]){if(!(v=(Z.find.ID(M.matches[0].replace(db,eb),v)||[])[0]))return s;Y&&(v=v.parentNode),o=o.slice(Q.shift().value.length)}for(L=Mb.needsContext.test(o)?0:Q.length;L--&&(M=Q[L],!Z.relative[ba=M.type]);)if((ba=Z.find[ba])&&(E=ba(M.matches[0].replace(db,eb),Tb.test(Q[0].type)&&O(v.parentNode)||v))){if(Q.splice(L,1),o=E.length&&S(Q),!o)return hb.apply(s,E),s;break}}return(Y||Ka(o,la))(E,v,!Ra,s,Tb.test(o)&&O(v.parentNode)||v),s},wa.sortStable=ta.split("").sort(Vb).join("")===ta,wa.detectDuplicates=!!za,Fa(),wa.sortDetached=l(function(o){return 1&o.compareDocumentPosition(ya.createElement("div"))}),l(function(o){return o.innerHTML="<a href='#'></a>","#"===o.firstChild.getAttribute("href")})||n("type|href|height|width",function(o,v,s){return s?void 0:o.getAttribute(v,"type"===v.toLowerCase()?1:2)}),wa.attributes&&l(function(o){return o.innerHTML="<input/>",o.firstChild.setAttribute("value",""),""===o.firstChild.getAttribute("value")})||n("value",function(o,v,s){return s||"input"!==o.nodeName.toLowerCase()?void 0:o.defaultValue}),l(function(o){return null==o.getAttribute("disabled")})||n("checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",function(o,v,s){var E;return s?void 0:o[v]===!0?v.toLowerCase():(E=o.getAttributeNode(v))&&E.specified?E.value:null}),e}(f);h.find=Da,h.expr=Da.selectors,h.expr[":"]=h.expr.pseudos,h.unique=Da.uniqueSort,h.text=Da.getText,h.isXMLDoc=Da.isXML,h.contains=Da.contains;var tc=h.expr.match.needsContext,uc=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,Oc=/^.[^:#\[\.,]*$/;h.filter=function(a,e,g){var k=e[0];return g&&(a=":not("+a+")"),1===e.length&&1===k.nodeType?h.find.matchesSelector(k,a)?[k]:[]:h.find.matches(a,h.grep(e,function(l){return 1===l.nodeType}))},h.fn.extend({find:function(a){var e,g=[],k=this,l=k.length;if("string"!=typeof a)return this.pushStack(h(a).filter(function(){for(e=0;l>e;e++)if(h.contains(k[e],this))return!0}));for(e=0;l>e;e++)h.find(a,k[e],g);return g=this.pushStack(l>1?h.unique(g):g),g.selector=this.selector?this.selector+" "+a:a,g},filter:function(a){return this.pushStack($(this,a||[],!1))},not:function(a){return this.pushStack($(this,a||[],!0))},is:function(a){return!!$(this,"string"==typeof a&&tc.test(a)?h(a):a||[],!1).length}});var Gb,da=f.document,ld=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;(h.fn.init=function(a,e){var g,k;if(!a)return this;if("string"==typeof a){if(!(g="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:ld.exec(a))||!g[1]&&e)return!e||e.jquery?(e||Gb).find(a):this.constructor(e).find(a);if(g[1]){if(e=e instanceof h?e[0]:e,h.merge(this,h.parseHTML(g[1],e&&e.nodeType?e.ownerDocument||e:da,!0)),uc.test(g[1])&&h.isPlainObject(e))for(g in e)h.isFunction(this[g])?this[g](e[g]):this.attr(g,e[g])}else{if((k=da.getElementById(g[2]))&&k.parentNode){if(k.id!==g[2])return Gb.find(a);this.length=1,this[0]=k}this.context=da,this.selector=a}return this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):h.isFunction(a)?"undefined"!=typeof Gb.ready?Gb.ready(a):a(h):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),h.makeArray(a,this))}).prototype=h.fn,Gb=h(da);var md=/^(?:parents|prev(?:Until|All))/,nd={children:!0,contents:!0,next:!0,prev:!0};h.extend({dir:function(a,e,g){var k=[];for(a=a[e];a&&9!==a.nodeType&&(void 0===g||1!==a.nodeType||!h(a).is(g));)1===a.nodeType&&k.push(a),a=a[e];return k},sibling:function(a,e){for(var g=[];a;a=a.nextSibling)1===a.nodeType&&a!==e&&g.push(a);return g}}),h.fn.extend({has:function(a){var e,g=h(a,this),k=g.length;return this.filter(function(){for(e=0;k>e;e++)if(h.contains(this,g[e]))return!0})},closest:function(a,e){for(var g,k=0,l=this.length,n=[],p=tc.test(a)||"string"!=typeof a?h(a,e||this.context):0;l>k;k++)for(g=this[k];g&&g!==e;g=g.parentNode)if(g.nodeType<11&&(p?p.index(g)>-1:1===g.nodeType&&h.find.matchesSelector(g,a))){n.push(g);break}return this.pushStack(n.length>1?h.unique(n):n)},index:function(a){return a?"string"==typeof a?h.inArray(this[0],h(a)):h.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,e){return this.pushStack(h.unique(h.merge(this.get(),h(a,e))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}}),h.each({parent:function(a){return(a=a.parentNode)&&11!==a.nodeType?a:null},parents:function(a){return h.dir(a,"parentNode")},parentsUntil:function(a,e,g){return h.dir(a,"parentNode",g)},next:function(a){return W(a,"nextSibling")},prev:function(a){return W(a,"previousSibling")},nextAll:function(a){return h.dir(a,"nextSibling")},prevAll:function(a){return h.dir(a,"previousSibling")},nextUntil:function(a,e,g){return h.dir(a,"nextSibling",g)},prevUntil:function(a,e,g){return h.dir(a,"previousSibling",g)},siblings:function(a){return h.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return h.sibling(a.firstChild)},contents:function(a){return h.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:h.merge([],a.childNodes)}},function(a,e){h.fn[a]=function(g,k){var l=h.map(this,e,g);return"Until"!==a.slice(-5)&&(k=g),k&&"string"==typeof k&&(l=h.filter(k,l)),this.length>1&&(nd[a]||(l=h.unique(l)),md.test(a)&&(l=l.reverse())),this.pushStack(l)}});var cb=/\S+/g,hc={};h.Callbacks=function(a){a="string"==typeof a?hc[a]||U(a):h.extend({},a);var e,g,k,l,n,p,x=[],D=!a.once&&[],I=function(C){for(g=a.memory&&C,k=!0,n=p||0,p=0,l=x.length,e=!0;x&&l>n;n++)if(x[n].apply(C[0],C[1])===!1&&a.stopOnFalse){g=!1;break}e=!1,x&&(D?D.length&&I(D.shift()):g?x=[]:O.disable())},O={add:function(){if(x){var C=x.length;!function S(fa){h.each(fa,function(Oa,Sa){var Ta=h.type(Sa);"function"===Ta?a.unique&&O.has(Sa)||x.push(Sa):Sa&&Sa.length&&"string"!==Ta&&S(Sa)})}(arguments),e?l=x.length:g&&(p=C,I(g))}return this},remove:function(){return x&&h.each(arguments,function(C,S){for(var fa;(fa=h.inArray(S,x,fa))>-1;)x.splice(fa,1),e&&(l>=fa&&l--,n>=fa&&n--)}),this},has:function(C){return C?h.inArray(C,x)>-1:!(!x||!x.length)},empty:function(){return x=[],l=0,this},disable:function(){return x=D=g=void 0,this},disabled:function(){return!x},lock:function(){return D=void 0,g||O.disable(),this},locked:function(){return!D},fireWith:function(C,S){return!x||k&&!D||(S=S||[],S=[C,S.slice?S.slice():S],e?D.push(S):I(S)),this},fire:function(){return O.fireWith(this,arguments),this},fired:function(){return!!k}};return O},h.extend({Deferred:function(a){var e=[["resolve","done",h.Callbacks("once memory"),"resolved"],["reject","fail",h.Callbacks("once memory"),"rejected"],["notify","progress",h.Callbacks("memory")]],g="pending",k={state:function(){return g},always:function(){return l.done(arguments).fail(arguments),this},then:function(){var n=arguments;return h.Deferred(function(p){h.each(e,function(x,D){var I=h.isFunction(n[x])&&n[x];l[D[1]](function(){var O=I&&I.apply(this,arguments);O&&h.isFunction(O.promise)?O.promise().done(p.resolve).fail(p.reject).progress(p.notify):p[D[0]+"With"](this===k?p.promise():this,I?[O]:arguments)})}),n=null}).promise()},promise:function(n){return null!=n?h.extend(n,k):k}},l={};return k.pipe=k.then,h.each(e,function(n,p){var x=p[2],D=p[3];k[p[1]]=x.add,D&&x.add(function(){g=D},e[1^n][2].disable,e[2][2].lock),l[p[0]]=function(){return l[p[0]+"With"](this===l?k:this,arguments),this},l[p[0]+"With"]=x.fireWith}),k.promise(l),a&&a.call(l,l),l},when:function(a){var x,D,I,e=0,g=Ua.call(arguments),k=g.length,l=1!==k||a&&h.isFunction(a.promise)?k:0,n=1===l?a:h.Deferred(),p=function(O,C,S){return function(fa){C[O]=this,S[O]=arguments.length>1?Ua.call(arguments):fa,S===x?n.notifyWith(C,S):--l||n.resolveWith(C,S)}};if(k>1)for(x=Array(k),D=Array(k),I=Array(k);k>e;e++)g[e]&&h.isFunction(g[e].promise)?g[e].promise().done(p(e,I,g)).fail(n.reject).progress(p(e,D,x)):--l;return l||n.resolveWith(I,g),n.promise()}});var Nb;h.fn.ready=function(a){return h.ready.promise().done(a),this},h.extend({isReady:!1,readyWait:1,holdReady:function(a){a?h.readyWait++:h.ready(!0)},ready:function(a){if(!(a===!0?--h.readyWait:h.isReady)){if(!da.body)return setTimeout(h.ready);h.isReady=!0,a!==!0&&--h.readyWait>0||(Nb.resolveWith(da,[h]),h.fn.triggerHandler&&(h(da).triggerHandler("ready"),h(da).off("ready")))}}}),h.ready.promise=function(a){if(!Nb)if(Nb=h.Deferred(),"complete"===da.readyState)setTimeout(h.ready);else if(da.addEventListener)da.addEventListener("DOMContentLoaded",ia,!1),f.addEventListener("load",ia,!1);else{da.attachEvent("onreadystatechange",ia),f.attachEvent("onload",ia);var e=!1;try{e=null==f.frameElement&&da.documentElement}catch(g){}e&&e.doScroll&&function k(){if(!h.isReady){try{e.doScroll("left")}catch(l){return setTimeout(k,50)}ma(),h.ready()}}()}return Nb.promise(a)};var zb,Za="undefined";for(zb in h(R))break;R.ownLast="0"!==zb,R.inlineBlockNeedsLayout=!1,h(function(){var a,e,g;(e=da.getElementsByTagName("body")[0])&&e.style&&(a=da.createElement("div"),g=da.createElement("div"),g.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",e.appendChild(g).appendChild(a),typeof a.style.zoom!==Za&&(a.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",(R.inlineBlockNeedsLayout=a=3===a.offsetWidth)&&(e.style.zoom=1)),e.removeChild(g))}),function(){var a=da.createElement("div");if(null==R.deleteExpando){R.deleteExpando=!0;try{delete a.test}catch(e){R.deleteExpando=!1}}}(),h.acceptData=function(a){var e=h.noData[(a.nodeName+" ").toLowerCase()],g=+a.nodeType||1;return 1!==g&&9!==g?!1:!e||e!==!0&&a.getAttribute("classid")===e};var Qc=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Pc=/([A-Z])/g;h.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?h.cache[a[h.expando]]:a[h.expando],!!a&&!ga(a)},data:function(a,e,g){return b(a,e,g)},removeData:function(a,e){return c(a,e)},_data:function(a,e,g){return b(a,e,g,!0)},_removeData:function(a,e){return c(a,e,!0)}}),h.fn.extend({data:function(a,e){var g,k,l,n=this[0],p=n&&n.attributes;if(void 0===a){if(this.length&&(l=h.data(n),1===n.nodeType&&!h._data(n,"parsedAttrs"))){for(g=p.length;g--;)p[g]&&(k=p[g].name,0===k.indexOf("data-")&&(k=h.camelCase(k.slice(5)),J(n,k,l[k])));h._data(n,"parsedAttrs",!0)}return l}return"object"==typeof a?this.each(function(){h.data(this,a)}):arguments.length>1?this.each(function(){h.data(this,a,e)}):n?J(n,a,h.data(n,a)):void 0},removeData:function(a){return this.each(function(){h.removeData(this,a)})}}),h.extend({queue:function(a,e,g){var k;return a?(e=(e||"fx")+"queue",k=h._data(a,e),g&&(!k||h.isArray(g)?k=h._data(a,e,h.makeArray(g)):k.push(g)),k||[]):void 0},dequeue:function(a,e){e=e||"fx";var g=h.queue(a,e),k=g.length,l=g.shift(),n=h._queueHooks(a,e),p=function(){h.dequeue(a,e)};"inprogress"===l&&(l=g.shift(),k--),l&&("fx"===e&&g.unshift("inprogress"),delete n.stop,l.call(a,p,n)),!k&&n&&n.empty.fire()},_queueHooks:function(a,e){var g=e+"queueHooks";return h._data(a,g)||h._data(a,g,{empty:h.Callbacks("once memory").add(function(){h._removeData(a,e+"queue"),h._removeData(a,g)})})}}),h.fn.extend({queue:function(a,e){var g=2;return"string"!=typeof a&&(e=a,a="fx",g--),arguments.length<g?h.queue(this[0],a):void 0===e?this:this.each(function(){var k=h.queue(this,a,e);h._queueHooks(this,a),"fx"===a&&"inprogress"!==k[0]&&h.dequeue(this,a)})},dequeue:function(a){return this.each(function(){h.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,e){var g,k=1,l=h.Deferred(),n=this,p=this.length,x=function(){--k||l.resolveWith(n,[n])};for("string"!=typeof a&&(e=a,a=void 0),a=a||"fx";p--;)(g=h._data(n[p],a+"queueHooks"))&&g.empty&&(k++,g.empty.add(x));return x(),l.promise(e)}}),Da=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source;var mb=["Top","Right","Bottom","Left"],Cb=function(a,e){return a=e||a,"none"===h.css(a,"display")||!h.contains(a.ownerDocument,a)},sb=h.access=function(a,e,g,k,l,n,p){var x=0,D=a.length,I=null==g;if("object"===h.type(g)){l=!0;for(x in g)h.access(a,e,x,g[x],!0,n,p)}else if(void 0!==k&&(l=!0,h.isFunction(k)||(p=!0),I&&(p?(e.call(a,k),e=null):(I=e,e=function(O,C,S){return I.call(h(O),S)})),e))for(;D>x;x++)e(a[x],g,p?k:k.call(a[x],x,e(a[x],g)));return l?a:I?e.call(a):D?e(a[0],g):n},Rb=/^(?:checkbox|radio)$/i;!function(){var a=da.createElement("input"),e=da.createElement("div"),g=da.createDocumentFragment();if(e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",R.leadingWhitespace=3===e.firstChild.nodeType,R.tbody=!e.getElementsByTagName("tbody").length,R.htmlSerialize=!!e.getElementsByTagName("link").length,R.html5Clone="<:nav></:nav>"!==da.createElement("nav").cloneNode(!0).outerHTML,a.type="checkbox",a.checked=!0,g.appendChild(a),R.appendChecked=a.checked,e.innerHTML="<textarea>x</textarea>",R.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue,g.appendChild(e),e.innerHTML="<input type='radio' checked='checked' name='t'/>",R.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,R.noCloneEvent=!0,e.attachEvent&&(e.attachEvent("onclick",function(){R.noCloneEvent=!1}),e.cloneNode(!0).click()),null==R.deleteExpando){R.deleteExpando=!0;try{delete e.test}catch(k){R.deleteExpando=!1}}}(),function(){var a,e,g=da.createElement("div");for(a in{submit:!0,change:!0,focusin:!0})e="on"+a,(R[a+"Bubbles"]=e in f)||(g.setAttribute(e,"t"),R[a+"Bubbles"]=g.attributes[e].expando===!1)}();var Xb=/^(?:input|select|textarea)$/i,od=/^key/,pd=/^(?:mouse|pointer|contextmenu)|click/,vc=/^(?:focusinfocus|focusoutblur)$/,wc=/^([^.]*)(?:\.(.+)|)$/;h.event={global:{},add:function(a,e,g,k,l){var n,p,x,D,I,O,C,S,fa;if(x=h._data(a)){for(g.handler&&(D=g,g=D.handler,l=D.selector),g.guid||(g.guid=h.guid++),(p=x.events)||(p=x.events={}),(I=x.handle)||(I=x.handle=function(Oa){return typeof h===Za||Oa&&h.event.triggered===Oa.type?void 0:h.event.dispatch.apply(I.elem,arguments)},I.elem=a),e=(e||"").match(cb)||[""],x=e.length;x--;)n=wc.exec(e[x])||[],S=O=n[1],fa=(n[2]||"").split(".").sort(),S&&(n=h.event.special[S]||{},S=(l?n.delegateType:n.bindType)||S,n=h.event.special[S]||{},O=h.extend({type:S,origType:O,data:k,handler:g,guid:g.guid,selector:l,needsContext:l&&h.expr.match.needsContext.test(l),namespace:fa.join(".")},D),(C=p[S])||(C=p[S]=[],C.delegateCount=0,n.setup&&n.setup.call(a,k,fa,I)!==!1||(a.addEventListener?a.addEventListener(S,I,!1):a.attachEvent&&a.attachEvent("on"+S,I))),n.add&&(n.add.call(a,O),O.handler.guid||(O.handler.guid=g.guid)),l?C.splice(C.delegateCount++,0,O):C.push(O),h.event.global[S]=!0);a=null}},remove:function(a,e,g,k,l){var n,p,x,D,I,O,C,S,fa,Oa,Sa,Ta=h.hasData(a)&&h._data(a);if(Ta&&(O=Ta.events)){for(e=(e||"").match(cb)||[""],I=e.length;I--;)if(x=wc.exec(e[I])||[],fa=Sa=x[1],Oa=(x[2]||"").split(".").sort(),fa){for(C=h.event.special[fa]||{},fa=(k?C.delegateType:C.bindType)||fa,S=O[fa]||[],x=x[2]&&RegExp("(^|\\.)"+Oa.join("\\.(?:.*\\.|)")+"(\\.|$)"),D=n=S.length;n--;)p=S[n],!l&&Sa!==p.origType||g&&g.guid!==p.guid||x&&!x.test(p.namespace)||k&&k!==p.selector&&("**"!==k||!p.selector)||(S.splice(n,1),p.selector&&S.delegateCount--,C.remove&&C.remove.call(a,p));D&&!S.length&&(C.teardown&&C.teardown.call(a,Oa,Ta.handle)!==!1||h.removeEvent(a,fa,Ta.handle),delete O[fa])}else for(fa in O)h.event.remove(a,fa+e[I],g,k,!0);h.isEmptyObject(O)&&(delete Ta.handle,h._removeData(a,"events"))}},trigger:function(a,e,g,k){var l,n,p,x,D,I,O=[g||da],C=ab.call(a,"type")?a.type:a;if(D=ab.call(a,"namespace")?a.namespace.split("."):[],p=l=g=g||da,3!==g.nodeType&&8!==g.nodeType&&!vc.test(C+h.event.triggered)&&(C.indexOf(".")>=0&&(D=C.split("."),C=D.shift(),D.sort()),n=C.indexOf(":")<0&&"on"+C,a=a[h.expando]?a:new h.Event(C,"object"==typeof a&&a),a.isTrigger=k?2:3,a.namespace=D.join("."),a.namespace_re=a.namespace?RegExp("(^|\\.)"+D.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,a.result=void 0,a.target||(a.target=g),e=null==e?[a]:h.makeArray(e,[a]),D=h.event.special[C]||{},k||!D.trigger||D.trigger.apply(g,e)!==!1)){if(!k&&!D.noBubble&&!h.isWindow(g)){for(x=D.delegateType||C,vc.test(x+C)||(p=p.parentNode);p;p=p.parentNode)O.push(p),l=p;l===(g.ownerDocument||da)&&O.push(l.defaultView||l.parentWindow||f)}for(I=0;(p=O[I++])&&!a.isPropagationStopped();)a.type=I>1?x:D.bindType||C,(l=(h._data(p,"events")||{})[a.type]&&h._data(p,"handle"))&&l.apply(p,e),(l=n&&p[n])&&l.apply&&h.acceptData(p)&&(a.result=l.apply(p,e),a.result===!1&&a.preventDefault());if(a.type=C,!k&&!a.isDefaultPrevented()&&(!D._default||D._default.apply(O.pop(),e)===!1)&&h.acceptData(g)&&n&&g[C]&&!h.isWindow(g)){(l=g[n])&&(g[n]=null),h.event.triggered=C;try{g[C]()}catch(S){}h.event.triggered=void 0,l&&(g[n]=l)}return a.result}},dispatch:function(a){a=h.event.fix(a);var e,g,k,l,n=[],p=Ua.call(arguments);e=(h._data(this,"events")||{})[a.type]||[];var x=h.event.special[a.type]||{};if(p[0]=a,a.delegateTarget=this,!x.preDispatch||x.preDispatch.call(this,a)!==!1){for(n=h.event.handlers.call(this,a,e),e=0;(k=n[e++])&&!a.isPropagationStopped();)for(a.currentTarget=k.elem,l=0;(g=k.handlers[l++])&&!a.isImmediatePropagationStopped();)(!a.namespace_re||a.namespace_re.test(g.namespace))&&(a.handleObj=g,a.data=g.data,g=((h.event.special[g.origType]||{}).handle||g.handler).apply(k.elem,p),void 0!==g&&(a.result=g)===!1&&(a.preventDefault(),a.stopPropagation()));return x.postDispatch&&x.postDispatch.call(this,a),a.result}},handlers:function(a,e){var g,k,l,n,p=[],x=e.delegateCount,D=a.target;if(x&&D.nodeType&&(!a.button||"click"!==a.type))for(;D!=this;D=D.parentNode||this)if(1===D.nodeType&&(D.disabled!==!0||"click"!==a.type)){for(l=[],n=0;x>n;n++)k=e[n],g=k.selector+" ",void 0===l[g]&&(l[g]=k.needsContext?h(g,this).index(D)>=0:h.find(g,this,null,[D]).length),l[g]&&l.push(k);l.length&&p.push({elem:D,handlers:l})}return x<e.length&&p.push({elem:this,handlers:e.slice(x)}),p},fix:function(a){if(a[h.expando])return a;var e,g,k;e=a.type;var l=a,n=this.fixHooks[e];for(n||(this.fixHooks[e]=n=pd.test(e)?this.mouseHooks:od.test(e)?this.keyHooks:{}),k=n.props?this.props.concat(n.props):this.props,a=new h.Event(l),e=k.length;e--;)g=k[e],a[g]=l[g];return a.target||(a.target=l.srcElement||da),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,n.filter?n.filter(a,l):a},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,e){return null==a.which&&(a.which=null!=e.charCode?e.charCode:e.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,e){var g,k,l=e.button,n=e.fromElement;return null==a.pageX&&null!=e.clientX&&(g=a.target.ownerDocument||da,k=g.documentElement,g=g.body,a.pageX=e.clientX+(k&&k.scrollLeft||g&&g.scrollLeft||0)-(k&&k.clientLeft||g&&g.clientLeft||0),a.pageY=e.clientY+(k&&k.scrollTop||g&&g.scrollTop||0)-(k&&k.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&n&&(a.relatedTarget=n===a.target?e.toElement:n),a.which||void 0===l||(a.which=1&l?1:2&l?3:4&l?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==i()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===i()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return h.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return h.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,e,g,k){a=h.extend(new h.Event,g,{type:a,isSimulated:!0,originalEvent:{}}),k?h.event.trigger(a,null,e):h.event.dispatch.call(e,a),a.isDefaultPrevented()&&g.preventDefault()}},h.removeEvent=da.removeEventListener?function(a,e,g){a.removeEventListener&&a.removeEventListener(e,g,!1)}:function(a,e,g){e="on"+e,a.detachEvent&&(typeof a[e]===Za&&(a[e]=null),a.detachEvent(e,g))},h.Event=function(a,e){return this instanceof h.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?d:j):this.type=a,e&&h.extend(this,e),this.timeStamp=a&&a.timeStamp||h.now(),void(this[h.expando]=!0)):new h.Event(a,e)},h.Event.prototype={isDefaultPrevented:j,isPropagationStopped:j,isImmediatePropagationStopped:j,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=d,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=d,a&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=d,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},h.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,e){h.event.special[a]={delegateType:e,bindType:e,handle:function(g){var k,l=g.relatedTarget,n=g.handleObj;return(!l||l!==this&&!h.contains(this,l))&&(g.type=n.origType,k=n.handler.apply(this,arguments),g.type=e),k}}}),R.submitBubbles||(h.event.special.submit={setup:function(){return h.nodeName(this,"form")?!1:void h.event.add(this,"click._submit keypress._submit",function(a){a=a.target,(a=h.nodeName(a,"input")||h.nodeName(a,"button")?a.form:void 0)&&!h._data(a,"submitBubbles")&&(h.event.add(a,"submit._submit",function(e){e._submit_bubble=!0}),h._data(a,"submitBubbles",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&h.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){return h.nodeName(this,"form")?!1:void h.event.remove(this,"._submit")}}),R.changeBubbles||(h.event.special.change={setup:function(){return Xb.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(h.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._just_changed=!0)}),h.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),h.event.simulate("change",this,a,!0)})),!1):void h.event.add(this,"beforeactivate._change",function(a){a=a.target,Xb.test(a.nodeName)&&!h._data(a,"changeBubbles")&&(h.event.add(a,"change._change",function(e){this.parentNode&&!e.isSimulated&&!e.isTrigger&&h.event.simulate("change",this.parentNode,e,!0)}),h._data(a,"changeBubbles",!0))})},handle:function(a){var e=a.target;return this!==e||a.isSimulated||a.isTrigger||"radio"!==e.type&&"checkbox"!==e.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return h.event.remove(this,"._change"),!Xb.test(this.nodeName)}}),R.focusinBubbles||h.each({focus:"focusin",blur:"focusout"},function(a,e){var g=function(k){h.event.simulate(e,k.target,h.event.fix(k),!0)};h.event.special[e]={setup:function(){var k=this.ownerDocument||this,l=h._data(k,e);l||k.addEventListener(a,g,!0),h._data(k,e,(l||0)+1)},teardown:function(){var k=this.ownerDocument||this,l=h._data(k,e)-1;l?h._data(k,e,l):(k.removeEventListener(a,g,!0),h._removeData(k,e))}}}),h.fn.extend({on:function(a,e,g,k,l){var n,p;if("object"==typeof a){"string"!=typeof e&&(g=g||e,e=void 0);for(n in a)this.on(n,e,g,a[n],l);return this}if(null==g&&null==k?(k=e,g=e=void 0):null==k&&("string"==typeof e?(k=g,g=void 0):(k=g,g=e,e=void 0)),k===!1)k=j;else if(!k)return this;return 1===l&&(p=k,k=function(x){return h().off(x),p.apply(this,arguments)},k.guid=p.guid||(p.guid=h.guid++)),this.each(function(){h.event.add(this,a,k,g,e)})},one:function(a,e,g,k){return this.on(a,e,g,k,1)},off:function(a,e,g){var k;if(a&&a.preventDefault&&a.handleObj)return k=a.handleObj,h(a.delegateTarget).off(k.namespace?k.origType+"."+k.namespace:k.origType,k.selector,k.handler),this;if("object"==typeof a){for(k in a)this.off(k,e,a[k]);return this}return(e===!1||"function"==typeof e)&&(g=e,e=void 0),g===!1&&(g=j),this.each(function(){h.event.remove(this,a,g,e)})},trigger:function(a,e){return this.each(function(){h.event.trigger(a,e,this)})},triggerHandler:function(a,e){var g=this[0];return g?h.event.trigger(a,e,g,!0):void 0}});var ic="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",qd=/ jQuery\d+="(?:null|\d+)"/g,xc=RegExp("<(?:"+ic+")[\\s/>]","i"),Yb=/^\s+/,yc=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,zc=/<([\w:]+)/,Ac=/<tbody/i,rd=/<|&#?\w+;/,sd=/<(?:script|style|link)/i,td=/checked\s*(?:[^=]|=\s*.checked.)/i,Bc=/^$|\/(?:java|ecma)script/i,Rc=/^true\/(.*)/,ud=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Ya={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:R.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},Zb=m(da).appendChild(da.createElement("div"));Ya.optgroup=Ya.option,Ya.tbody=Ya.tfoot=Ya.colgroup=Ya.caption=Ya.thead,Ya.th=Ya.td,h.extend({clone:function(a,e,g){var k,l,n,p,x,D=h.contains(a.ownerDocument,a);if(R.html5Clone||h.isXMLDoc(a)||!xc.test("<"+a.nodeName+">")?n=a.cloneNode(!0):(Zb.innerHTML=a.outerHTML,Zb.removeChild(n=Zb.firstChild)),!(R.noCloneEvent&&R.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||h.isXMLDoc(a)))for(k=q(n),x=q(a),p=0;null!=(l=x[p]);++p)if(k[p]){var I=k[p],O=void 0,C=void 0,S=void 0;if(1===I.nodeType){if(O=I.nodeName.toLowerCase(),!R.noCloneEvent&&I[h.expando]){S=h._data(I);for(C in S.events)h.removeEvent(I,C,S.handle);I.removeAttribute(h.expando)}"script"===O&&I.text!==l.text?(A(I).text=l.text,F(I)):"object"===O?(I.parentNode&&(I.outerHTML=l.outerHTML),R.html5Clone&&l.innerHTML&&!h.trim(I.innerHTML)&&(I.innerHTML=l.innerHTML)):"input"===O&&Rb.test(l.type)?(I.defaultChecked=I.checked=l.checked,I.value!==l.value&&(I.value=l.value)):"option"===O?I.defaultSelected=I.selected=l.defaultSelected:("input"===O||"textarea"===O)&&(I.defaultValue=l.defaultValue)}}if(e)if(g)for(x=x||q(a),k=k||q(n),p=0;null!=(l=x[p]);p++)K(l,k[p]);else K(a,n);return k=q(n,"script"),k.length>0&&B(k,!D&&q(a,"script")),n},buildFragment:function(a,e,g,k){
for(var l,n,p,x,D,I,O=a.length,C=m(e),S=[],fa=0;O>fa;fa++)if((n=a[fa])||0===n)if("object"===h.type(n))h.merge(S,n.nodeType?[n]:n);else if(rd.test(n)){for(p=p||C.appendChild(e.createElement("div")),x=(zc.exec(n)||["",""])[1].toLowerCase(),I=Ya[x]||Ya._default,p.innerHTML=I[1]+n.replace(yc,"<$1></$2>")+I[2],l=I[0];l--;)p=p.lastChild;if(!R.leadingWhitespace&&Yb.test(n)&&S.push(e.createTextNode(Yb.exec(n)[0])),!R.tbody)for(l=(n="table"!==x||Ac.test(n)?"<table>"!==I[1]||Ac.test(n)?0:p:p.firstChild)&&n.childNodes.length;l--;)h.nodeName(D=n.childNodes[l],"tbody")&&!D.childNodes.length&&n.removeChild(D);for(h.merge(S,p.childNodes),p.textContent="";p.firstChild;)p.removeChild(p.firstChild);p=C.lastChild}else S.push(e.createTextNode(n));for(p&&C.removeChild(p),R.appendChecked||h.grep(q(S,"input"),t),fa=0;n=S[fa++];)if((!k||-1===h.inArray(n,k))&&(a=h.contains(n.ownerDocument,n),p=q(C.appendChild(n),"script"),a&&B(p),g))for(l=0;n=p[l++];)Bc.test(n.type||"")&&g.push(n);return C},cleanData:function(a,e){for(var g,k,l,n,p=0,x=h.expando,D=h.cache,I=R.deleteExpando,O=h.event.special;null!=(g=a[p]);p++)if((e||h.acceptData(g))&&(n=(l=g[x])&&D[l])){if(n.events)for(k in n.events)O[k]?h.event.remove(g,k):h.removeEvent(g,k,n.handle);D[l]&&(delete D[l],I?delete g[x]:typeof g.removeAttribute!==Za?g.removeAttribute(x):g[x]=null,Aa.push(l))}}}),h.fn.extend({text:function(a){return sb(this,function(e){return void 0===e?h.text(this):this.empty().append((this[0]&&this[0].ownerDocument||da).createTextNode(e))},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&u(this,a).appendChild(a)})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var e=u(this,a);e.insertBefore(a,e.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,e){for(var g,k=a?h.filter(a,this):this,l=0;null!=(g=k[l]);l++)!e&&1===g.nodeType&&h.cleanData(q(g)),g.parentNode&&(e&&h.contains(g.ownerDocument,g)&&B(q(g,"script")),g.parentNode.removeChild(g));return this},empty:function(){for(var a,e=0;null!=(a=this[e]);e++){for(1===a.nodeType&&h.cleanData(q(a,!1));a.firstChild;)a.removeChild(a.firstChild);a.options&&h.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,e){return a=null==a?!1:a,e=null==e?a:e,this.map(function(){return h.clone(this,a,e)})},html:function(a){return sb(this,function(e){var g=this[0]||{},k=0,l=this.length;if(void 0===e)return 1===g.nodeType?g.innerHTML.replace(qd,""):void 0;if(!("string"!=typeof e||sd.test(e)||!R.htmlSerialize&&xc.test(e)||!R.leadingWhitespace&&Yb.test(e)||Ya[(zc.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(yc,"<$1></$2>");try{for(;l>k;k++)g=this[k]||{},1===g.nodeType&&(h.cleanData(q(g,!1)),g.innerHTML=e);g=0}catch(n){}}g&&this.empty().append(e)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(e){a=this.parentNode,h.cleanData(q(this)),a&&a.replaceChild(e,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,e){a=va.apply([],a);var g,k,l,n,p=0,x=this.length,D=this,I=x-1,O=a[0],C=h.isFunction(O);if(C||x>1&&"string"==typeof O&&!R.checkClone&&td.test(O))return this.each(function(S){var fa=D.eq(S);C&&(a[0]=O.call(this,S,fa.html())),fa.domManip(a,e)});if(x&&(n=h.buildFragment(a,this[0].ownerDocument,!1,this),g=n.firstChild,1===n.childNodes.length&&(n=g),g)){for(l=h.map(q(n,"script"),A),k=l.length;x>p;p++)g=n,p!==I&&(g=h.clone(g,!0,!0),k&&h.merge(l,q(g,"script"))),e.call(this[p],g,p);if(k)for(n=l[l.length-1].ownerDocument,h.map(l,F),p=0;k>p;p++)g=l[p],Bc.test(g.type||"")&&!h._data(g,"globalEval")&&h.contains(n,g)&&(g.src?h._evalUrl&&h._evalUrl(g.src):h.globalEval((g.text||g.textContent||g.innerHTML||"").replace(ud,"")));n=g=null}return this}}),h.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,e){h.fn[a]=function(g){for(var k=0,l=[],n=h(g),p=n.length-1;p>=k;k++)g=k===p?this:this.clone(!0),h(n[k])[e](g),gb.apply(l,g.get());return this.pushStack(l)}});var Bb,jc={};!function(){var a;R.shrinkWrapBlocks=function(){if(null!=a)return a;a=!1;var e,g,k;return(g=da.getElementsByTagName("body")[0])&&g.style?(e=da.createElement("div"),k=da.createElement("div"),k.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",g.appendChild(k).appendChild(e),typeof e.style.zoom!==Za&&(e.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",e.appendChild(da.createElement("div")).style.width="5px",a=3!==e.offsetWidth),g.removeChild(k),a):void 0}}();var nb,ob,Cc=/^margin/,Hb=RegExp("^("+Da+")(?!px)[a-z%]+$","i"),vd=/^(top|right|bottom|left)$/;f.getComputedStyle?(nb=function(a){return a.ownerDocument.defaultView.opener?a.ownerDocument.defaultView.getComputedStyle(a,null):f.getComputedStyle(a,null)},ob=function(a,e,g){var k,l,n=a.style;return l=(g=g||nb(a))?g.getPropertyValue(e)||g[e]:void 0,g&&(""!==l||h.contains(a.ownerDocument,a)||(l=h.style(a,e)),Hb.test(l)&&Cc.test(e)&&(a=n.width,e=n.minWidth,k=n.maxWidth,n.minWidth=n.maxWidth=n.width=l,l=g.width,n.width=a,n.minWidth=e,n.maxWidth=k)),void 0===l?l:l+""}):da.documentElement.currentStyle&&(nb=function(a){return a.currentStyle},ob=function(a,e,g){var k,l,n,p=a.style;return n=(g=g||nb(a))?g[e]:void 0,null==n&&p&&p[e]&&(n=p[e]),Hb.test(n)&&!vd.test(e)&&(g=p.left,(l=(k=a.runtimeStyle)&&k.left)&&(k.left=a.currentStyle.left),p.left="fontSize"===e?"1em":n,n=p.pixelLeft+"px",p.left=g,l&&(k.left=l)),void 0===n?n:n+""||"auto"}),function(){function a(){var x,D,I,O;(D=da.getElementsByTagName("body")[0])&&D.style&&(x=da.createElement("div"),I=da.createElement("div"),I.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",D.appendChild(I).appendChild(x),x.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",k=l=!1,p=!0,f.getComputedStyle&&(k="1%"!==(f.getComputedStyle(x,null)||{}).top,l="4px"===(f.getComputedStyle(x,null)||{width:"4px"}).width,O=x.appendChild(da.createElement("div")),O.style.cssText=x.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",O.style.marginRight=O.style.width="0",x.style.width="1px",p=!parseFloat((f.getComputedStyle(O,null)||{}).marginRight),x.removeChild(O)),x.innerHTML="<table><tr><td></td><td>t</td></tr></table>",O=x.getElementsByTagName("td"),O[0].style.cssText="margin:0;border:0;padding:0;display:none",(n=0===O[0].offsetHeight)&&(O[0].style.display="",O[1].style.display="none",n=0===O[0].offsetHeight),D.removeChild(I))}var e,g,k,l,n,p;e=da.createElement("div"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",(g=(g=e.getElementsByTagName("a")[0])&&g.style)&&(g.cssText="float:left;opacity:.5",R.opacity="0.5"===g.opacity,R.cssFloat=!!g.cssFloat,e.style.backgroundClip="content-box",e.cloneNode(!0).style.backgroundClip="",R.clearCloneStyle="content-box"===e.style.backgroundClip,R.boxSizing=""===g.boxSizing||""===g.MozBoxSizing||""===g.WebkitBoxSizing,h.extend(R,{reliableHiddenOffsets:function(){return null==n&&a(),n},boxSizingReliable:function(){return null==l&&a(),l},pixelPosition:function(){return null==k&&a(),k},reliableMarginRight:function(){return null==p&&a(),p}}))}(),h.swap=function(a,e,g,k){var l,n={};for(l in e)n[l]=a.style[l],a.style[l]=e[l];g=g.apply(a,k||[]);for(l in e)a.style[l]=n[l];return g};var $b=/alpha\([^)]*\)/i,wd=/opacity\s*=\s*([^)]*)/,xd=/^(none|table(?!-c[ea]).+)/,Sc=RegExp("^("+Da+")(.*)$","i"),yd=RegExp("^([+-])=("+Da+")","i"),zd={position:"absolute",visibility:"hidden",display:"block"},Dc={letterSpacing:"0",fontWeight:"400"},kc=["Webkit","O","Moz","ms"];h.extend({cssHooks:{opacity:{get:function(a,e){if(e){var g=ob(a,"opacity");return""===g?"1":g}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":R.cssFloat?"cssFloat":"styleFloat"},style:function(a,e,g,k){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var l,n,p,x=h.camelCase(e),D=a.style;if(e=h.cssProps[x]||(h.cssProps[x]=y(D,x)),p=h.cssHooks[e]||h.cssHooks[x],void 0===g)return p&&"get"in p&&void 0!==(l=p.get(a,!1,k))?l:D[e];if(n=typeof g,"string"===n&&(l=yd.exec(g))&&(g=(l[1]+1)*l[2]+parseFloat(h.css(a,e)),n="number"),null!=g&&g===g&&("number"!==n||h.cssNumber[x]||(g+="px"),R.clearCloneStyle||""!==g||0!==e.indexOf("background")||(D[e]="inherit"),!(p&&"set"in p&&void 0===(g=p.set(a,g,k)))))try{D[e]=g}catch(I){}}},css:function(a,e,g,k){var l,n;return n=h.camelCase(e),e=h.cssProps[n]||(h.cssProps[n]=y(a.style,n)),(n=h.cssHooks[e]||h.cssHooks[n])&&"get"in n&&(l=n.get(a,!0,g)),void 0===l&&(l=ob(a,e,k)),"normal"===l&&e in Dc&&(l=Dc[e]),""===g||g?(a=parseFloat(l),g===!0||h.isNumeric(a)?a||0:l):l}}),h.each(["height","width"],function(a,e){h.cssHooks[e]={get:function(g,k,l){return k?xd.test(h.css(g,"display"))&&0===g.offsetWidth?h.swap(g,zd,function(){return P(g,e,l)}):P(g,e,l):void 0},set:function(g,k,l){var n=l&&nb(g);return N(g,k,l?V(g,e,l,R.boxSizing&&"border-box"===h.css(g,"boxSizing",!1,n),n):0)}}}),R.opacity||(h.cssHooks.opacity={get:function(a,e){return wd.test((e&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":e?"1":""},set:function(a,e){var g=a.style,k=a.currentStyle,l=h.isNumeric(e)?"alpha(opacity="+100*e+")":"",n=k&&k.filter||g.filter||"";g.zoom=1,(e>=1||""===e)&&""===h.trim(n.replace($b,""))&&g.removeAttribute&&(g.removeAttribute("filter"),""===e||k&&!k.filter)||(g.filter=$b.test(n)?n.replace($b,l):n+" "+l)}}),h.cssHooks.marginRight=w(R.reliableMarginRight,function(a,e){return e?h.swap(a,{display:"inline-block"},ob,[a,"marginRight"]):void 0}),h.each({margin:"",padding:"",border:"Width"},function(a,e){h.cssHooks[a+e]={expand:function(g){var k=0,l={};for(g="string"==typeof g?g.split(" "):[g];4>k;k++)l[a+mb[k]+e]=g[k]||g[k-2]||g[0];return l}},Cc.test(a)||(h.cssHooks[a+e].set=N)}),h.fn.extend({css:function(a,e){return sb(this,function(g,k,l){var n,p={},x=0;if(h.isArray(k)){for(l=nb(g),n=k.length;n>x;x++)p[k[x]]=h.css(g,k[x],!1,l);return p}return void 0!==l?h.style(g,k,l):h.css(g,k)},a,e,arguments.length>1)},show:function(){return z(this,!0)},hide:function(){return z(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){Cb(this)?h(this).show():h(this).hide()})}}),h.Tween=ea,ea.prototype={constructor:ea,init:function(a,e,g,k,l,n){this.elem=a,this.prop=g,this.easing=l||"swing",this.options=e,this.start=this.now=this.cur(),this.end=k,this.unit=n||(h.cssNumber[g]?"":"px")},cur:function(){var a=ea.propHooks[this.prop];return a&&a.get?a.get(this):ea.propHooks._default.get(this)},run:function(a){var e,g=ea.propHooks[this.prop];return this.pos=e=this.options.duration?h.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*e+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),g&&g.set?g.set(this):ea.propHooks._default.set(this),this}},ea.prototype.init.prototype=ea.prototype,ea.propHooks={_default:{get:function(a){return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(a=h.css(a.elem,a.prop,""),a&&"auto"!==a?a:0):a.elem[a.prop]},set:function(a){h.fx.step[a.prop]?h.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[h.cssProps[a.prop]]||h.cssHooks[a.prop])?h.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},ea.propHooks.scrollTop=ea.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},h.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},h.fx=ea.prototype.init,h.fx.step={};var vb,Ob,Ad=/^(?:toggle|show|hide)$/,Ec=RegExp("^(?:([+-])=|)("+Da+")([a-z%]*)$","i"),Bd=/queueHooks$/,Ib=[function(a,e,g){var k,l,n,p,x,D,I=this,O={},C=a.style,S=a.nodeType&&Cb(a),fa=h._data(a,"fxshow");g.queue||(p=h._queueHooks(a,"fx"),null==p.unqueued&&(p.unqueued=0,x=p.empty.fire,p.empty.fire=function(){p.unqueued||x()}),p.unqueued++,I.always(function(){I.always(function(){p.unqueued--,h.queue(a,"fx").length||p.empty.fire()})})),1===a.nodeType&&("height"in e||"width"in e)&&(g.overflow=[C.overflow,C.overflowX,C.overflowY],D=h.css(a,"display"),l="none"===D?h._data(a,"olddisplay")||r(a.nodeName):D,"inline"===l&&"none"===h.css(a,"float")&&(R.inlineBlockNeedsLayout&&"inline"!==r(a.nodeName)?C.zoom=1:C.display="inline-block")),g.overflow&&(C.overflow="hidden",R.shrinkWrapBlocks()||I.always(function(){C.overflow=g.overflow[0],C.overflowX=g.overflow[1],C.overflowY=g.overflow[2]}));for(k in e)if(l=e[k],Ad.exec(l)){if(delete e[k],n=n||"toggle"===l,l===(S?"hide":"show")){if("show"!==l||!fa||void 0===fa[k])continue;S=!0}O[k]=fa&&fa[k]||h.style(a,k)}else D=void 0;if(h.isEmptyObject(O))"inline"===("none"===D?r(a.nodeName):D)&&(C.display=D);else{fa?"hidden"in fa&&(S=fa.hidden):fa=h._data(a,"fxshow",{}),n&&(fa.hidden=!S),S?h(a).show():I.done(function(){h(a).hide()}),I.done(function(){var Oa;h._removeData(a,"fxshow");for(Oa in O)h.style(a,Oa,O[Oa])});for(k in O)e=oa(S?fa[k]:0,k,I),k in fa||(fa[k]=e.start,S&&(e.end=e.start,e.start="width"===k||"height"===k?1:0))}}],Db={"*":[function(a,e){var g=this.createTween(a,e),k=g.cur(),l=Ec.exec(e),n=l&&l[3]||(h.cssNumber[a]?"":"px"),p=(h.cssNumber[a]||"px"!==n&&+k)&&Ec.exec(h.css(g.elem,a)),x=1,D=20;if(p&&p[3]!==n){n=n||p[3],l=l||[],p=+k||1;do x=x||".5",p/=x,h.style(g.elem,a,p+n);while(x!==(x=g.cur()/k)&&1!==x&&--D)}return l&&(p=g.start=+p||+k||0,g.unit=n,g.end=l[1]?p+(l[1]+1)*l[2]:+l[2]),g}]};h.Animation=h.extend(ja,{tweener:function(a,e){h.isFunction(a)?(e=a,a=["*"]):a=a.split(" ");for(var g,k=0,l=a.length;l>k;k++)g=a[k],Db[g]=Db[g]||[],Db[g].unshift(e)},prefilter:function(a,e){e?Ib.unshift(a):Ib.push(a)}}),h.speed=function(a,e,g){var k=a&&"object"==typeof a?h.extend({},a):{complete:g||!g&&e||h.isFunction(a)&&a,duration:a,easing:g&&e||e&&!h.isFunction(e)&&e};return k.duration=h.fx.off?0:"number"==typeof k.duration?k.duration:k.duration in h.fx.speeds?h.fx.speeds[k.duration]:h.fx.speeds._default,(null==k.queue||k.queue===!0)&&(k.queue="fx"),k.old=k.complete,k.complete=function(){h.isFunction(k.old)&&k.old.call(this),k.queue&&h.dequeue(this,k.queue)},k},h.fn.extend({fadeTo:function(a,e,g,k){return this.filter(Cb).css("opacity",0).show().end().animate({opacity:e},a,g,k)},animate:function(a,e,g,k){var l=h.isEmptyObject(a),n=h.speed(e,g,k);return e=function(){var p=ja(this,h.extend({},a),n);(l||h._data(this,"finish"))&&p.stop(!0)},e.finish=e,l||n.queue===!1?this.each(e):this.queue(n.queue,e)},stop:function(a,e,g){var k=function(l){var n=l.stop;delete l.stop,n(g)};return"string"!=typeof a&&(g=e,e=a,a=void 0),e&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var l=!0,n=null!=a&&a+"queueHooks",p=h.timers,x=h._data(this);if(n)x[n]&&x[n].stop&&k(x[n]);else for(n in x)x[n]&&x[n].stop&&Bd.test(n)&&k(x[n]);for(n=p.length;n--;)p[n].elem!==this||null!=a&&p[n].queue!==a||(p[n].anim.stop(g),l=!1,p.splice(n,1));(l||!g)&&h.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var e,g=h._data(this),k=g[a+"queue"];e=g[a+"queueHooks"];var l=h.timers,n=k?k.length:0;for(g.finish=!0,h.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),e=l.length;e--;)l[e].elem===this&&l[e].queue===a&&(l[e].anim.stop(!0),l.splice(e,1));for(e=0;n>e;e++)k[e]&&k[e].finish&&k[e].finish.call(this);delete g.finish})}}),h.each(["toggle","show","hide"],function(a,e){var g=h.fn[e];h.fn[e]=function(k,l,n){return null==k||"boolean"==typeof k?g.apply(this,arguments):this.animate(ha(e,!0),k,l,n)}}),h.each({slideDown:ha("show"),slideUp:ha("hide"),slideToggle:ha("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,e){h.fn[a]=function(g,k,l){return this.animate(e,g,k,l)}}),h.timers=[],h.fx.tick=function(){var a,e=h.timers,g=0;for(vb=h.now();g<e.length;g++)a=e[g],!a()&&e[g]===a&&e.splice(g--,1);e.length||h.fx.stop(),vb=void 0},h.fx.timer=function(a){h.timers.push(a),a()?h.fx.start():h.timers.pop()},h.fx.interval=13,h.fx.start=function(){Ob||(Ob=setInterval(h.fx.tick,h.fx.interval))},h.fx.stop=function(){clearInterval(Ob),Ob=null},h.fx.speeds={slow:600,fast:200,_default:400},h.fn.delay=function(a,e){return a=h.fx?h.fx.speeds[a]||a:a,this.queue(e||"fx",function(g,k){var l=setTimeout(g,a);k.stop=function(){clearTimeout(l)}})},function(){var a,e,g,k,l;e=da.createElement("div"),e.setAttribute("className","t"),e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",k=e.getElementsByTagName("a")[0],g=da.createElement("select"),l=g.appendChild(da.createElement("option")),a=e.getElementsByTagName("input")[0],k.style.cssText="top:1px",R.getSetAttribute="t"!==e.className,R.style=/top/.test(k.getAttribute("style")),R.hrefNormalized="/a"===k.getAttribute("href"),R.checkOn=!!a.value,R.optSelected=l.selected,R.enctype=!!da.createElement("form").enctype,g.disabled=!0,R.optDisabled=!l.disabled,a=da.createElement("input"),a.setAttribute("value",""),R.input=""===a.getAttribute("value"),a.value="t",a.setAttribute("type","radio"),R.radioValue="t"===a.value}();var Cd=/\r/g;h.fn.extend({val:function(a){var e,g,k,l=this[0];return arguments.length?(k=h.isFunction(a),this.each(function(n){1===this.nodeType&&(n=k?a.call(this,n,h(this).val()):a,null==n?n="":"number"==typeof n?n+="":h.isArray(n)&&(n=h.map(n,function(p){return null==p?"":p+""})),e=h.valHooks[this.type]||h.valHooks[this.nodeName.toLowerCase()],e&&"set"in e&&void 0!==e.set(this,n,"value")||(this.value=n))})):l?(e=h.valHooks[l.type]||h.valHooks[l.nodeName.toLowerCase()])&&"get"in e&&void 0!==(g=e.get(l,"value"))?g:(g=l.value,"string"==typeof g?g.replace(Cd,""):null==g?"":g):void 0}}),h.extend({valHooks:{option:{get:function(a){var e=h.find.attr(a,"value");return null!=e?e:h.trim(h.text(a))}},select:{get:function(a){for(var e,g=a.options,k=a.selectedIndex,l=(a="select-one"===a.type||0>k)?null:[],n=a?k+1:g.length,p=0>k?n:a?k:0;n>p;p++)if(e=g[p],!(!e.selected&&p!==k||(R.optDisabled?e.disabled:null!==e.getAttribute("disabled"))||e.parentNode.disabled&&h.nodeName(e.parentNode,"optgroup"))){if(e=h(e).val(),a)return e;l.push(e)}return l},set:function(a,e){for(var g,k,l=a.options,n=h.makeArray(e),p=l.length;p--;)if(k=l[p],h.inArray(h.valHooks.option.get(k),n)>=0)try{k.selected=g=!0}catch(x){}else k.selected=!1;return g||(a.selectedIndex=-1),l}}}}),h.each(["radio","checkbox"],function(){h.valHooks[this]={set:function(a,e){return h.isArray(e)?a.checked=h.inArray(h(a).val(),e)>=0:void 0}},R.checkOn||(h.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var Ab,Fc,kb=h.expr.attrHandle,ac=/^(?:checked|selected)$/i,tb=R.getSetAttribute,Pb=R.input;h.fn.extend({attr:function(a,e){return sb(this,h.attr,a,e,arguments.length>1)},removeAttr:function(a){return this.each(function(){h.removeAttr(this,a)})}}),h.extend({attr:function(a,e,g){var k,l,n=a.nodeType;if(a&&3!==n&&8!==n&&2!==n){if(typeof a.getAttribute===Za)return h.prop(a,e,g);if(1===n&&h.isXMLDoc(a)||(e=e.toLowerCase(),k=h.attrHooks[e]||(h.expr.match.bool.test(e)?Fc:Ab)),void 0===g)return k&&"get"in k&&null!==(l=k.get(a,e))?l:(l=h.find.attr(a,e),null==l?void 0:l);if(null!==g)return k&&"set"in k&&void 0!==(l=k.set(a,g,e))?l:(a.setAttribute(e,g+""),g);h.removeAttr(a,e)}},removeAttr:function(a,e){var g,k,l=0,n=e&&e.match(cb);if(n&&1===a.nodeType)for(;g=n[l++];)k=h.propFix[g]||g,h.expr.match.bool.test(g)?Pb&&tb||!ac.test(g)?a[k]=!1:a[h.camelCase("default-"+g)]=a[k]=!1:h.attr(a,g,""),a.removeAttribute(tb?g:k)},attrHooks:{type:{set:function(a,e){if(!R.radioValue&&"radio"===e&&h.nodeName(a,"input")){var g=a.value;return a.setAttribute("type",e),g&&(a.value=g),e}}}}}),Fc={set:function(a,e,g){return e===!1?h.removeAttr(a,g):Pb&&tb||!ac.test(g)?a.setAttribute(!tb&&h.propFix[g]||g,g):a[h.camelCase("default-"+g)]=a[g]=!0,g}},h.each(h.expr.match.bool.source.match(/\w+/g),function(a,e){var g=kb[e]||h.find.attr;kb[e]=Pb&&tb||!ac.test(e)?function(k,l,n){var p,x;return n||(x=kb[l],kb[l]=p,p=null!=g(k,l,n)?l.toLowerCase():null,kb[l]=x),p}:function(k,l,n){return n?void 0:k[h.camelCase("default-"+l)]?l.toLowerCase():null}}),Pb&&tb||(h.attrHooks.value={set:function(a,e,g){return h.nodeName(a,"input")?void(a.defaultValue=e):Ab&&Ab.set(a,e,g)}}),tb||(Ab={set:function(a,e,g){var k=a.getAttributeNode(g);return k||a.setAttributeNode(k=a.ownerDocument.createAttribute(g)),k.value=e+="","value"===g||e===a.getAttribute(g)?e:void 0}},kb.id=kb.name=kb.coords=function(a,e,g){var k;return g?void 0:(k=a.getAttributeNode(e))&&""!==k.value?k.value:null},h.valHooks.button={get:function(a,e){var g=a.getAttributeNode(e);return g&&g.specified?g.value:void 0},set:Ab.set},h.attrHooks.contenteditable={set:function(a,e,g){Ab.set(a,""===e?!1:e,g)}},h.each(["width","height"],function(a,e){h.attrHooks[e]={set:function(g,k){return""===k?(g.setAttribute(e,"auto"),k):void 0}}})),R.style||(h.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,e){return a.style.cssText=e+""}});var Dd=/^(?:input|select|textarea|button|object)$/i,Ed=/^(?:a|area)$/i;h.fn.extend({prop:function(a,e){return sb(this,h.prop,a,e,arguments.length>1)},removeProp:function(a){return a=h.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(e){}})}}),h.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,e,g){var k,l,n=a.nodeType;return a&&3!==n&&8!==n&&2!==n?(1===n&&h.isXMLDoc(a)||(e=h.propFix[e]||e,l=h.propHooks[e]),void 0!==g?l&&"set"in l&&void 0!==(k=l.set(a,g,e))?k:a[e]=g:l&&"get"in l&&null!==(k=l.get(a,e))?k:a[e]):void 0},propHooks:{tabIndex:{get:function(a){var e=h.find.attr(a,"tabindex");return e?parseInt(e,10):Dd.test(a.nodeName)||Ed.test(a.nodeName)&&a.href?0:-1}}}}),R.hrefNormalized||h.each(["href","src"],function(a,e){h.propHooks[e]={get:function(g){return g.getAttribute(e,4)}}}),R.optSelected||(h.propHooks.selected={get:function(){return null}}),h.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){h.propFix[this.toLowerCase()]=this}),R.enctype||(h.propFix.enctype="encoding");var bc=/[\t\r\n\f]/g;h.fn.extend({addClass:function(a){var e,g,k,l,n,p=0,x=this.length;if(e="string"==typeof a&&a,h.isFunction(a))return this.each(function(D){h(this).addClass(a.call(this,D,this.className))});if(e)for(e=(a||"").match(cb)||[];x>p;p++)if(g=this[p],k=1===g.nodeType&&(g.className?(" "+g.className+" ").replace(bc," "):" ")){for(n=0;l=e[n++];)k.indexOf(" "+l+" ")<0&&(k+=l+" ");k=h.trim(k),g.className!==k&&(g.className=k)}return this},removeClass:function(a){var e,g,k,l,n,p=0,x=this.length;if(e=0===arguments.length||"string"==typeof a&&a,h.isFunction(a))return this.each(function(D){h(this).removeClass(a.call(this,D,this.className))});if(e)for(e=(a||"").match(cb)||[];x>p;p++)if(g=this[p],k=1===g.nodeType&&(g.className?(" "+g.className+" ").replace(bc," "):"")){for(n=0;l=e[n++];)for(;k.indexOf(" "+l+" ")>=0;)k=k.replace(" "+l+" "," ");k=a?h.trim(k):"",g.className!==k&&(g.className=k)}return this},toggleClass:function(a,e){var g=typeof a;return"boolean"==typeof e&&"string"===g?e?this.addClass(a):this.removeClass(a):h.isFunction(a)?this.each(function(k){h(this).toggleClass(a.call(this,k,this.className,e),e)}):this.each(function(){if("string"===g)for(var k,l=0,n=h(this),p=a.match(cb)||[];k=p[l++];)n.hasClass(k)?n.removeClass(k):n.addClass(k);else(g===Za||"boolean"===g)&&(this.className&&h._data(this,"__className__",this.className),this.className=this.className||a===!1?"":h._data(this,"__className__")||"")})},hasClass:function(a){a=" "+a+" ";for(var e=0,g=this.length;g>e;e++)if(1===this[e].nodeType&&(" "+this[e].className+" ").replace(bc," ").indexOf(a)>=0)return!0;return!1}}),h.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,e){h.fn[e]=function(g,k){return arguments.length>0?this.on(e,null,g,k):this.trigger(e)}}),h.fn.extend({hover:function(a,e){return this.mouseenter(a).mouseleave(e||a)},bind:function(a,e,g){return this.on(a,null,e,g)},unbind:function(a,e){return this.off(a,null,e)},delegate:function(a,e,g,k){return this.on(e,a,g,k)},undelegate:function(a,e,g){return 1===arguments.length?this.off(a,"**"):this.off(e,a||"**",g)}});var cc=h.now(),dc=/\?/,Fd=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;h.parseJSON=function(a){if(f.JSON&&f.JSON.parse)return f.JSON.parse(a+"");var e,g=null,k=h.trim(a+"");return k&&!h.trim(k.replace(Fd,function(l,n,p,x){return e&&n&&(g=0),0===g?l:(e=p||n,g+=!x-!p,"")}))?Function("return "+k)():h.error("Invalid JSON: "+a)},h.parseXML=function(a){var e,g;if(!a||"string"!=typeof a)return null;try{f.DOMParser?(g=new DOMParser,e=g.parseFromString(a,"text/xml")):(e=new ActiveXObject("Microsoft.XMLDOM"),e.async="false",e.loadXML(a))}catch(k){e=void 0}return e&&e.documentElement&&!e.getElementsByTagName("parsererror").length||h.error("Invalid XML: "+a),e};var ub,lb,Gd=/#.*$/,Gc=/([?&])_=[^&]*/,Hd=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Id=/^(?:GET|HEAD)$/,Jd=/^\/\//,Hc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Ic={},Sb={},Jc="*/".concat("*");try{lb=location.href}catch(Ud){lb=da.createElement("a"),lb.href="",lb=lb.href}ub=Hc.exec(lb.toLowerCase())||[],h.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:lb,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(ub[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Jc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":h.parseJSON,"text xml":h.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,e){return e?X(X(a,h.ajaxSettings),e):X(h.ajaxSettings,a)},ajaxPrefilter:Ea(Ic),ajaxTransport:Ea(Sb),ajax:function(a,e){function g(qa,Ga,Ka,bb){var jb,Wa,za,Fa;if(Fa=Ga,2!==Qa){if(Qa=2,x&&clearTimeout(x),I=void 0,p=bb||"",Z.readyState=qa>0?4:0,bb=qa>=200&&300>qa||304===qa,Ka){za=C;for(var Ca,Ra,xa,sa,ya=Z,Xa=za.contents,Va=za.dataTypes;"*"===Va[0];)Va.shift(),void 0===Ra&&(Ra=za.mimeType||ya.getResponseHeader("Content-Type"));if(Ra)for(sa in Xa)if(Xa[sa]&&Xa[sa].test(Ra)){Va.unshift(sa);break}if(Va[0]in Ka)xa=Va[0];else{for(sa in Ka){if(!Va[0]||za.converters[sa+" "+Va[0]]){xa=sa;break}Ca||(Ca=sa)}xa=xa||Ca}xa?(xa!==Va[0]&&Va.unshift(xa),za=Ka[xa]):za=void 0}a:{Ka=C,Ca=za,Ra=Z,xa=bb;var ta,Ba,Na;if(ya={},Xa=Ka.dataTypes.slice(),Xa[1])for(Ba in Ka.converters)ya[Ba.toLowerCase()]=Ka.converters[Ba];for(sa=Xa.shift();sa;)if(Ka.responseFields[sa]&&(Ra[Ka.responseFields[sa]]=Ca),!Na&&xa&&Ka.dataFilter&&(Ca=Ka.dataFilter(Ca,Ka.dataType)),Na=sa,sa=Xa.shift())if("*"===sa)sa=Na;else if("*"!==Na&&Na!==sa){if(Ba=ya[Na+" "+sa]||ya["* "+sa],!Ba)for(ta in ya)if(za=ta.split(" "),za[1]===sa&&(Ba=ya[Na+" "+za[0]]||ya["* "+za[0]])){Ba===!0?Ba=ya[ta]:ya[ta]!==!0&&(sa=za[0],Xa.unshift(za[1]));break}if(Ba!==!0)if(Ba&&Ka["throws"])Ca=Ba(Ca);else try{Ca=Ba(Ca)}catch(Ub){za={state:"parsererror",error:Ba?Ub:"No conversion from "+Na+" to "+sa};break a}}za={state:"success",data:Ca}}bb?(C.ifModified&&((Fa=Z.getResponseHeader("Last-Modified"))&&(h.lastModified[n]=Fa),(Fa=Z.getResponseHeader("etag"))&&(h.etag[n]=Fa)),204===qa||"HEAD"===C.type?Fa="nocontent":304===qa?Fa="notmodified":(Fa=za.state,jb=za.data,Wa=za.error,bb=!Wa)):(Wa=Fa,(qa||!Fa)&&(Fa="error",0>qa&&(qa=0))),Z.status=qa,Z.statusText=(Ga||Fa)+"",bb?Oa.resolveWith(S,[jb,Fa,Z]):Oa.rejectWith(S,[Z,Fa,Wa]),Z.statusCode(Ta),Ta=void 0,D&&fa.trigger(bb?"ajaxSuccess":"ajaxError",[Z,C,bb?jb:Wa]),Sa.fireWith(S,[Z,Fa]),D&&(fa.trigger("ajaxComplete",[Z,C]),--h.active||h.event.trigger("ajaxStop"))}}"object"==typeof a&&(e=a,a=void 0),e=e||{};var k,l,n,p,x,D,I,O,C=h.ajaxSetup({},e),S=C.context||C,fa=C.context&&(S.nodeType||S.jquery)?h(S):h.event,Oa=h.Deferred(),Sa=h.Callbacks("once memory"),Ta=C.statusCode||{},xb={},Lb={},Qa=0,wa="canceled",Z={readyState:0,getResponseHeader:function(qa){var Ga;if(2===Qa){if(!O)for(O={};Ga=Hd.exec(p);)O[Ga[1].toLowerCase()]=Ga[2];Ga=O[qa.toLowerCase()]}return null==Ga?null:Ga},getAllResponseHeaders:function(){return 2===Qa?p:null},setRequestHeader:function(qa,Ga){var Ka=qa.toLowerCase();return Qa||(qa=Lb[Ka]=Lb[Ka]||qa,xb[qa]=Ga),this},overrideMimeType:function(qa){return Qa||(C.mimeType=qa),this},statusCode:function(qa){var Ga;if(qa)if(2>Qa)for(Ga in qa)Ta[Ga]=[Ta[Ga],qa[Ga]];else Z.always(qa[Z.status]);return this},abort:function(qa){return qa=qa||wa,I&&I.abort(qa),g(0,qa),this}};if(Oa.promise(Z).complete=Sa.add,Z.success=Z.done,Z.error=Z.fail,C.url=((a||C.url||lb)+"").replace(Gd,"").replace(Jd,ub[1]+"//"),C.type=e.method||e.type||C.method||C.type,C.dataTypes=h.trim(C.dataType||"*").toLowerCase().match(cb)||[""],null==C.crossDomain&&(k=Hc.exec(C.url.toLowerCase()),C.crossDomain=!(!k||k[1]===ub[1]&&k[2]===ub[2]&&(k[3]||("http:"===k[1]?"80":"443"))===(ub[3]||("http:"===ub[1]?"80":"443")))),C.data&&C.processData&&"string"!=typeof C.data&&(C.data=h.param(C.data,C.traditional)),Pa(Ic,C,e,Z),2===Qa)return Z;(D=h.event&&C.global)&&0===h.active++&&h.event.trigger("ajaxStart"),C.type=C.type.toUpperCase(),C.hasContent=!Id.test(C.type),n=C.url,C.hasContent||(C.data&&(n=C.url+=(dc.test(n)?"&":"?")+C.data,delete C.data),C.cache===!1&&(C.url=Gc.test(n)?n.replace(Gc,"$1_="+cc++):n+(dc.test(n)?"&":"?")+"_="+cc++)),C.ifModified&&(h.lastModified[n]&&Z.setRequestHeader("If-Modified-Since",h.lastModified[n]),h.etag[n]&&Z.setRequestHeader("If-None-Match",h.etag[n])),(C.data&&C.hasContent&&C.contentType!==!1||e.contentType)&&Z.setRequestHeader("Content-Type",C.contentType),Z.setRequestHeader("Accept",C.dataTypes[0]&&C.accepts[C.dataTypes[0]]?C.accepts[C.dataTypes[0]]+("*"!==C.dataTypes[0]?", "+Jc+"; q=0.01":""):C.accepts["*"]);for(l in C.headers)Z.setRequestHeader(l,C.headers[l]);if(C.beforeSend&&(C.beforeSend.call(S,Z,C)===!1||2===Qa))return Z.abort();wa="abort";for(l in{success:1,error:1,complete:1})Z[l](C[l]);if(I=Pa(Sb,C,e,Z)){Z.readyState=1,D&&fa.trigger("ajaxSend",[Z,C]),C.async&&C.timeout>0&&(x=setTimeout(function(){Z.abort("timeout")},C.timeout));try{Qa=1,I.send(xb,g)}catch(rb){if(!(2>Qa))throw rb;g(-1,rb)}}else g(-1,"No Transport");return Z},getJSON:function(a,e,g){return h.get(a,e,g,"json")},getScript:function(a,e){return h.get(a,void 0,e,"script")}}),h.each(["get","post"],function(a,e){h[e]=function(g,k,l,n){return h.isFunction(k)&&(n=n||l,l=k,k=void 0),h.ajax({url:g,type:e,dataType:n,data:k,success:l})}}),h._evalUrl=function(a){return h.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},h.fn.extend({wrapAll:function(a){if(h.isFunction(a))return this.each(function(g){h(this).wrapAll(a.call(this,g))});if(this[0]){var e=h(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&e.insertBefore(this[0]),e.map(function(){for(var g=this;g.firstChild&&1===g.firstChild.nodeType;)g=g.firstChild;return g}).append(this)}return this},wrapInner:function(a){return h.isFunction(a)?this.each(function(e){h(this).wrapInner(a.call(this,e))}):this.each(function(){var e=h(this),g=e.contents();g.length?g.wrapAll(a):e.append(a);
})},wrap:function(a){var e=h.isFunction(a);return this.each(function(g){h(this).wrapAll(e?a.call(this,g):a)})},unwrap:function(){return this.parent().each(function(){h.nodeName(this,"body")||h(this).replaceWith(this.childNodes)}).end()}}),h.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0||!R.reliableHiddenOffsets()&&"none"===(a.style&&a.style.display||h.css(a,"display"))},h.expr.filters.visible=function(a){return!h.expr.filters.hidden(a)};var Kd=/%20/g,Tc=/\[\]$/,Kc=/\r?\n/g,Ld=/^(?:submit|button|image|reset|file)$/i,Md=/^(?:input|select|textarea|keygen)/i;h.param=function(a,e){var g,k=[],l=function(n,p){p=h.isFunction(p)?p():null==p?"":p,k[k.length]=encodeURIComponent(n)+"="+encodeURIComponent(p)};if(void 0===e&&(e=h.ajaxSettings&&h.ajaxSettings.traditional),h.isArray(a)||a.jquery&&!h.isPlainObject(a))h.each(a,function(){l(this.name,this.value)});else for(g in a)aa(g,a[g],e,l);return k.join("&").replace(Kd,"+")},h.fn.extend({serialize:function(){return h.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=h.prop(this,"elements");return a?h.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!h(this).is(":disabled")&&Md.test(this.nodeName)&&!Ld.test(a)&&(this.checked||!Rb.test(a))}).map(function(a,e){var g=h(this).val();return null==g?null:h.isArray(g)?h.map(g,function(k){return{name:e.name,value:k.replace(Kc,"\r\n")}}):{name:e.name,value:g.replace(Kc,"\r\n")}}).get()}}),h.ajaxSettings.xhr=void 0!==f.ActiveXObject?function(){var a;if(!(a=!this.isLocal&&/^(get|post|head|put|delete|options)$/i.test(this.type)&&La()))a:{try{a=new f.ActiveXObject("Microsoft.XMLHTTP");break a}catch(e){}a=void 0}return a}:La;var Nd=0,Qb={};Da=h.ajaxSettings.xhr(),f.attachEvent&&f.attachEvent("onunload",function(){for(var a in Qb)Qb[a](void 0,!0)}),R.cors=!!Da&&"withCredentials"in Da,(Da=R.ajax=!!Da)&&h.ajaxTransport(function(a){if(!a.crossDomain||R.cors){var e;return{send:function(g,k){var l,n=a.xhr(),p=++Nd;if(n.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(l in a.xhrFields)n[l]=a.xhrFields[l];a.mimeType&&n.overrideMimeType&&n.overrideMimeType(a.mimeType),a.crossDomain||g["X-Requested-With"]||(g["X-Requested-With"]="XMLHttpRequest");for(l in g)void 0!==g[l]&&n.setRequestHeader(l,g[l]+"");n.send(a.hasContent&&a.data||null),e=function(x,D){var I,O,C;if(e&&(D||4===n.readyState))if(delete Qb[p],e=void 0,n.onreadystatechange=h.noop,D)4!==n.readyState&&n.abort();else{C={},I=n.status,"string"==typeof n.responseText&&(C.text=n.responseText);try{O=n.statusText}catch(S){O=""}I||!a.isLocal||a.crossDomain?1223===I&&(I=204):I=C.text?200:404}C&&k(I,O,C,n.getAllResponseHeaders())},a.async?4===n.readyState?setTimeout(e):n.onreadystatechange=Qb[p]=e:e()},abort:function(){e&&e(void 0,!0)}}}}),h.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return h.globalEval(a),a}}}),h.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),h.ajaxTransport("script",function(a){if(a.crossDomain){var e,g=da.head||h("head")[0]||da.documentElement;return{send:function(k,l){e=da.createElement("script"),e.async=!0,a.scriptCharset&&(e.charset=a.scriptCharset),e.src=a.url,e.onload=e.onreadystatechange=function(n,p){(p||!e.readyState||/loaded|complete/.test(e.readyState))&&(e.onload=e.onreadystatechange=null,e.parentNode&&e.parentNode.removeChild(e),e=null,p||l(200,"success"))},g.insertBefore(e,g.firstChild)},abort:function(){e&&e.onload(void 0,!0)}}}});var Lc=[],ec=/(=)\?(?=&|$)|\?\?/;h.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Lc.pop()||h.expando+"_"+cc++;return this[a]=!0,a}}),h.ajaxPrefilter("json jsonp",function(a,e,g){var k,l,n,p=a.jsonp!==!1&&(ec.test(a.url)?"url":"string"==typeof a.data&&!(a.contentType||"").indexOf("application/x-www-form-urlencoded")&&ec.test(a.data)&&"data");return p||"jsonp"===a.dataTypes[0]?(k=a.jsonpCallback=h.isFunction(a.jsonpCallback)?a.jsonpCallback():a.jsonpCallback,p?a[p]=a[p].replace(ec,"$1"+k):a.jsonp!==!1&&(a.url+=(dc.test(a.url)?"&":"?")+a.jsonp+"="+k),a.converters["script json"]=function(){return n||h.error(k+" was not called"),n[0]},a.dataTypes[0]="json",l=f[k],f[k]=function(){n=arguments},g.always(function(){f[k]=l,a[k]&&(a.jsonpCallback=e.jsonpCallback,Lc.push(k)),n&&h.isFunction(l)&&l(n[0]),n=l=void 0}),"script"):void 0}),h.parseHTML=function(a,e,g){if(!a||"string"!=typeof a)return null;"boolean"==typeof e&&(g=e,e=!1),e=e||da;var k=uc.exec(a);return g=!g&&[],k?[e.createElement(k[1])]:(k=h.buildFragment([a],e,g),g&&g.length&&h(g).remove(),h.merge([],k.childNodes))};var Mc=h.fn.load;h.fn.load=function(a,e,g){if("string"!=typeof a&&Mc)return Mc.apply(this,arguments);var k,l,n,p=this,x=a.indexOf(" ");return x>=0&&(k=h.trim(a.slice(x,a.length)),a=a.slice(0,x)),h.isFunction(e)?(g=e,e=void 0):e&&"object"==typeof e&&(n="POST"),p.length>0&&h.ajax({url:a,type:n,dataType:"html",data:e}).done(function(D){l=arguments,p.html(k?h("<div>").append(h.parseHTML(D)).find(k):D)}).complete(g&&function(D,I){p.each(g,l||[D.responseText,I,D])}),this},h.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,e){h.fn[e]=function(g){return this.on(e,g)}}),h.expr.filters.animated=function(a){return h.grep(h.timers,function(e){return a===e.elem}).length};var Nc=f.document.documentElement;h.offset={setOffset:function(a,e,g){var k,l,n,p=h.css(a,"position"),x=h(a),D={};"static"===p&&(a.style.position="relative"),n=x.offset(),l=h.css(a,"top"),k=h.css(a,"left"),("absolute"===p||"fixed"===p)&&h.inArray("auto",[l,k])>-1?(k=x.position(),l=k.top,k=k.left):(l=parseFloat(l)||0,k=parseFloat(k)||0),h.isFunction(e)&&(e=e.call(a,g,n)),null!=e.top&&(D.top=e.top-n.top+l),null!=e.left&&(D.left=e.left-n.left+k),"using"in e?e.using.call(a,D):x.css(D)}},h.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(n){h.offset.setOffset(this,a,n)});var e,g,k={top:0,left:0},l=(g=this[0])&&g.ownerDocument;return l?(e=l.documentElement,h.contains(e,g)?(typeof g.getBoundingClientRect!==Za&&(k=g.getBoundingClientRect()),g=Ma(l),{top:k.top+(g.pageYOffset||e.scrollTop)-(e.clientTop||0),left:k.left+(g.pageXOffset||e.scrollLeft)-(e.clientLeft||0)}):k):void 0},position:function(){if(this[0]){var a,e,g={top:0,left:0},k=this[0];return"fixed"===h.css(k,"position")?e=k.getBoundingClientRect():(a=this.offsetParent(),e=this.offset(),h.nodeName(a[0],"html")||(g=a.offset()),g.top+=h.css(a[0],"borderTopWidth",!0),g.left+=h.css(a[0],"borderLeftWidth",!0)),{top:e.top-g.top-h.css(k,"marginTop",!0),left:e.left-g.left-h.css(k,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||Nc;a&&!h.nodeName(a,"html")&&"static"===h.css(a,"position");)a=a.offsetParent;return a||Nc})}}),h.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,e){var g=/Y/.test(e);h.fn[a]=function(k){return sb(this,function(l,n,p){var x=Ma(l);return void 0===p?x?e in x?x[e]:x.document.documentElement[n]:l[n]:void(x?x.scrollTo(g?h(x).scrollLeft():p,g?p:h(x).scrollTop()):l[n]=p)},a,k,arguments.length,null)}}),h.each(["top","left"],function(a,e){h.cssHooks[e]=w(R.pixelPosition,function(g,k){return k?(k=ob(g,e),Hb.test(k)?h(g).position()[e]+"px":k):void 0})}),h.each({Height:"height",Width:"width"},function(a,e){h.each({padding:"inner"+a,content:e,"":"outer"+a},function(g,k){h.fn[k]=function(l,n){var p=arguments.length&&(g||"boolean"!=typeof l),x=g||(l===!0||n===!0?"margin":"border");return sb(this,function(D,I,O){return h.isWindow(D)?D.document.documentElement["client"+a]:9===D.nodeType?(I=D.documentElement,Math.max(D.body["scroll"+a],I["scroll"+a],D.body["offset"+a],I["offset"+a],I["client"+a])):void 0===O?h.css(D,I,x):h.style(D,I,O,x)},e,p?l:void 0,p,null)}})}),h.fn.size=function(){return this.length},h.fn.andSelf=h.fn.addBack,Da={},zb=function(a){return a=a.toLowerCase(),a=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[],{browser:a[1]||"",version:a[2]||"0"}}(navigator.userAgent),zb.browser&&(Da[zb.browser]=!0,Da.version=zb.version),Da.chrome?Da.webkit=!0:Da.webkit&&(Da.safari=!0),h.browser=Da,"function"==typeof define&&define.amd&&define("jquery",[],function(){return h});var Od=f.jQuery,Pd=f.$;return h.noConflict=function(a){return f.$===h&&(f.$=Pd),a&&f.jQuery===h&&(f.jQuery=Od),h},typeof T===Za&&(f.jQuery=f.$=h),h});var fb=jQuery.noConflict(!0);!function(f){"function"==typeof define&&define.amd?define(["jquery"],f):f(fb)}(function(f){function T(b,c){var d,j;return d=b.nodeName.toLowerCase(),"area"===d?(d=b.parentNode,j=d.name,b.href&&j&&"map"===d.nodeName.toLowerCase()?(d=f("img[usemap='#"+j+"']")[0],!!d&&G(d)):!1):(/^(input|select|textarea|button|object)$/.test(d)?!b.disabled:"a"===d?b.href||c:c)&&G(b)}function G(b){return f.expr.filters.visible(b)&&!f(b).parents().addBack().filter(function(){return"hidden"===f.css(this,"visibility")}).length}f.ui=f.ui||{},f.extend(f.ui,{version:"1.11.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),f.fn.extend({scrollParent:function(b){var c=this.css("position"),d="absolute"===c,j=b?/(auto|scroll|hidden)/:/(auto|scroll)/;return b=this.parents().filter(function(){var i=f(this);return d&&"static"===i.css("position")?!1:j.test(i.css("overflow")+i.css("overflow-y")+i.css("overflow-x"))}).eq(0),"fixed"!==c&&b.length?b:f(this[0].ownerDocument||document)},uniqueId:function(){var b=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++b)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&f(this).removeAttr("id")})}}),f.extend(f.expr[":"],{data:f.expr.createPseudo?f.expr.createPseudo(function(b){return function(c){return!!f.data(c,b)}}):function(b,c,d){return!!f.data(b,d[3])},focusable:function(b){return T(b,!isNaN(f.attr(b,"tabindex")))},tabbable:function(b){var c=f.attr(b,"tabindex"),d=isNaN(c);return(d||c>=0)&&T(b,!d)}}),f("<a>").outerWidth(1).jquery||f.each(["Width","Height"],function(b,c){function d(q,t,u,A){return f.each(j,function(){t-=parseFloat(f.css(q,"padding"+this))||0,u&&(t-=parseFloat(f.css(q,"border"+this+"Width"))||0),A&&(t-=parseFloat(f.css(q,"margin"+this))||0)}),t}var j="Width"===c?["Left","Right"]:["Top","Bottom"],i=c.toLowerCase(),m={innerWidth:f.fn.innerWidth,innerHeight:f.fn.innerHeight,outerWidth:f.fn.outerWidth,outerHeight:f.fn.outerHeight};f.fn["inner"+c]=function(q){return void 0===q?m["inner"+c].call(this):this.each(function(){f(this).css(i,d(this,q)+"px")})},f.fn["outer"+c]=function(q,t){return"number"!=typeof q?m["outer"+c].call(this,q):this.each(function(){f(this).css(i,d(this,q,!0,t)+"px")})}}),f.fn.addBack||(f.fn.addBack=function(b){return this.add(null==b?this.prevObject:this.prevObject.filter(b))}),f("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(f.fn.removeData=function(b){return function(c){return arguments.length?b.call(this,f.camelCase(c)):b.call(this)}}(f.fn.removeData)),f.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),f.fn.extend({focus:function(b){return function(c,d){return"number"==typeof c?this.each(function(){var j=this;setTimeout(function(){f(j).focus(),d&&d.call(j)},c)}):b.apply(this,arguments)}}(f.fn.focus),disableSelection:function(){var b="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.bind(b+".ui-disableSelection",function(c){c.preventDefault()})}}(),enableSelection:function(){return this.unbind(".ui-disableSelection")},zIndex:function(b){if(void 0!==b)return this.css("zIndex",b);if(this.length){b=f(this[0]);for(var c;b.length&&b[0]!==document;){if(c=b.css("position"),("absolute"===c||"relative"===c||"fixed"===c)&&(c=parseInt(b.css("zIndex"),10),!isNaN(c)&&0!==c))return c;b=b.parent()}}return 0}}),f.ui.plugin={add:function(b,c,d){var j;b=f.ui[b].prototype;for(j in d)b.plugins[j]=b.plugins[j]||[],b.plugins[j].push([c,d[j]])},call:function(b,c,d,j){if((c=b.plugins[c])&&(j||b.element[0].parentNode&&11!==b.element[0].parentNode.nodeType))for(j=0;j<c.length;j++)b.options[c[j][0]]&&c[j][1].apply(b.element,d)}};var $=0,W=Array.prototype.slice;f.cleanData=function(b){return function(c){var d,j,i;for(i=0;null!=(j=c[i]);i++)try{(d=f._data(j,"events"))&&d.remove&&f(j).triggerHandler("remove")}catch(m){}b(c)}}(f.cleanData),f.widget=function(b,c,d){var j,i,m,q,t={},u=b.split(".")[0];return b=b.split(".")[1],j=u+"-"+b,d||(d=c,c=f.Widget),f.expr[":"][j.toLowerCase()]=function(A){return!!f.data(A,j)},f[u]=f[u]||{},i=f[u][b],m=f[u][b]=function(A,F){return this._createWidget?void(arguments.length&&this._createWidget(A,F)):new m(A,F)},f.extend(m,i,{version:d.version,_proto:f.extend({},d),_childConstructors:[]}),q=new c,q.options=f.widget.extend({},q.options),f.each(d,function(A,F){t[A]=f.isFunction(F)?function(){var B=function(){return c.prototype[A].apply(this,arguments)},K=function(H){return c.prototype[A].apply(this,H)};return function(){var w,H=this._super,r=this._superApply;return this._super=B,this._superApply=K,w=F.apply(this,arguments),this._super=H,this._superApply=r,w}}():F}),m.prototype=f.widget.extend(q,{widgetEventPrefix:i?q.widgetEventPrefix||b:b},t,{constructor:m,namespace:u,widgetName:b,widgetFullName:j}),i?(f.each(i._childConstructors,function(A,F){var B=F.prototype;f.widget(B.namespace+"."+B.widgetName,m,F._proto)}),delete i._childConstructors):c._childConstructors.push(m),f.widget.bridge(b,m),m},f.widget.extend=function(b){for(var i,m,c=W.call(arguments,1),d=0,j=c.length;j>d;d++)for(i in c[d])m=c[d][i],c[d].hasOwnProperty(i)&&void 0!==m&&(b[i]=f.isPlainObject(m)?f.isPlainObject(b[i])?f.widget.extend({},b[i],m):f.widget.extend({},m):m);return b},f.widget.bridge=function(b,c){var d=c.prototype.widgetFullName||b;f.fn[b]=function(j){var i="string"==typeof j,m=W.call(arguments,1),q=this;return i?this.each(function(){var t,u=f.data(this,d);return"instance"===j?(q=u,!1):u?f.isFunction(u[j])&&"_"!==j.charAt(0)?(t=u[j].apply(u,m),t!==u&&void 0!==t?(q=t&&t.jquery?q.pushStack(t.get()):t,!1):void 0):f.error("no such method '"+j+"' for "+b+" widget instance"):f.error("cannot call methods on "+b+" prior to initialization; attempted to call method '"+j+"'")}):(m.length&&(j=f.widget.extend.apply(null,[j].concat(m))),this.each(function(){var t=f.data(this,d);t?(t.option(j||{}),t._init&&t._init()):f.data(this,d,new c(j,this))})),q}},f.Widget=function(){},f.Widget._childConstructors=[],f.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(b,c){c=f(c||this.defaultElement||this)[0],this.element=f(c),this.uuid=$++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=f(),this.hoverable=f(),this.focusable=f(),c!==this&&(f.data(c,this.widgetFullName,this),this._on(!0,this.element,{remove:function(d){d.target===c&&this.destroy()}}),this.document=f(c.style?c.ownerDocument:c.document||c),this.window=f(this.document[0].defaultView||this.document[0].parentWindow)),this.options=f.widget.extend({},this.options,this._getCreateOptions(),b),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:f.noop,_getCreateEventData:f.noop,_create:f.noop,_init:f.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData(f.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:f.noop,widget:function(){return this.element},option:function(b,c){var j,i,m,d=b;if(0===arguments.length)return f.widget.extend({},this.options);if("string"==typeof b)if(d={},j=b.split("."),b=j.shift(),j.length){for(i=d[b]=f.widget.extend({},this.options[b]),m=0;m<j.length-1;m++)i[j[m]]=i[j[m]]||{},i=i[j[m]];if(b=j.pop(),1===arguments.length)return void 0===i[b]?null:i[b];i[b]=c}else{if(1===arguments.length)return void 0===this.options[b]?null:this.options[b];d[b]=c}return this._setOptions(d),this},_setOptions:function(b){for(var c in b)this._setOption(c,b[c]);return this},_setOption:function(b,c){return this.options[b]=c,"disabled"===b&&(this.widget().toggleClass(this.widgetFullName+"-disabled",!!c),c&&(this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus"))),this},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_on:function(b,c,d){var j,i=this;"boolean"!=typeof b&&(d=c,c=b,b=!1),d?(c=j=f(c),this.bindings=this.bindings.add(c)):(d=c,c=this.element,j=this.widget()),f.each(d,function(m,q){function t(){return b||i.options.disabled!==!0&&!f(this).hasClass("ui-state-disabled")?("string"==typeof q?i[q]:q).apply(i,arguments):void 0}"string"!=typeof q&&(t.guid=q.guid=q.guid||t.guid||f.guid++);var u=m.match(/^([\w:-]*)\s*(.*)$/),A=u[1]+i.eventNamespace;(u=u[2])?j.delegate(u,A,t):c.bind(A,t)})},_off:function(b,c){c=(c||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,b.unbind(c).undelegate(c),this.bindings=f(this.bindings.not(b).get()),this.focusable=f(this.focusable.not(b).get()),this.hoverable=f(this.hoverable.not(b).get())},_delay:function(b,c){var d=this;return setTimeout(function(){return("string"==typeof b?d[b]:b).apply(d,arguments)},c||0)},_hoverable:function(b){this.hoverable=this.hoverable.add(b),this._on(b,{mouseenter:function(c){f(c.currentTarget).addClass("ui-state-hover")},mouseleave:function(c){f(c.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(b){this.focusable=this.focusable.add(b),this._on(b,{focusin:function(c){f(c.currentTarget).addClass("ui-state-focus")},focusout:function(c){f(c.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(b,c,d){var j,i=this.options[b];if(d=d||{},c=f.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],b=c.originalEvent)for(j in b)j in c||(c[j]=b[j]);return this.element.trigger(c,d),!(f.isFunction(i)&&i.apply(this.element[0],[c].concat(d))===!1||c.isDefaultPrevented())}},f.each({show:"fadeIn",hide:"fadeOut"},function(b,c){f.Widget.prototype["_"+b]=function(d,j,i){"string"==typeof j&&(j={effect:j});var m,q=j?j===!0||"number"==typeof j?c:j.effect||c:b;j=j||{},"number"==typeof j&&(j={duration:j}),m=!f.isEmptyObject(j),j.complete=i,j.delay&&d.delay(j.delay),m&&f.effects&&f.effects.effect[q]?d[b](j):q!==b&&d[q]?d[q](j.duration,j.easing,i):d.queue(function(t){f(this)[b](),i&&i.call(d[0]),t()})}});var U=!1;f(document).mouseup(function(){U=!1}),f.widget("ui.mouse",{version:"1.11.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(c){return b._mouseDown(c)}).bind("click."+this.widgetName,function(c){return!0===f.data(c.target,b.widgetName+".preventClickEvent")?(f.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(b){if(!U){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(b),this._mouseDownEvent=b;var c=this,d=1===b.which,j="string"==typeof this.options.cancel&&b.target.nodeName?f(b.target).closest(this.options.cancel).length:!1;return d&&!j&&this._mouseCapture(b)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){c.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(b)!==!1,!this._mouseStarted)?(b.preventDefault(),!0):(!0===f.data(b.target,this.widgetName+".preventClickEvent")&&f.removeData(b.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(i){return c._mouseMove(i)},this._mouseUpDelegate=function(i){return c._mouseUp(i)},this.document.bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),b.preventDefault(),U=!0)):!0}},_mouseMove:function(b){if(this._mouseMoved){if(f.ui.ie&&(!document.documentMode||document.documentMode<9)&&!b.button)return this._mouseUp(b);if(!b.which)return this._mouseUp(b)}return(b.which||b.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&((this._mouseStarted=this._mouseStart(this._mouseDownEvent,b)!==!1)?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted)},_mouseUp:function(b){return this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target===this._mouseDownEvent.target&&f.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),U=!1},_mouseDistanceMet:function(b){return Math.max(Math.abs(this._mouseDownEvent.pageX-b.pageX),Math.abs(this._mouseDownEvent.pageY-b.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),function(){function b(r,w,y){return[parseFloat(r[0])*(K.test(r[0])?w/100:1),parseFloat(r[1])*(K.test(r[1])?y/100:1)]}function c(r,w){return parseInt(f.css(r,w),10)||0}function d(r){var w=r[0];return 9===w.nodeType?{width:r.width(),height:r.height(),offset:{top:0,left:0}}:f.isWindow(w)?{width:r.width(),height:r.height(),offset:{top:r.scrollTop(),left:r.scrollLeft()}}:w.preventDefault?{width:0,height:0,offset:{top:w.pageY,left:w.pageX}}:{width:r.outerWidth(),height:r.outerHeight(),offset:r.offset()}}f.ui=f.ui||{};var j,i,m=Math.max,q=Math.abs,t=Math.round,u=/left|center|right/,A=/top|center|bottom/,F=/[\+\-]\d+(\.[\d]+)?%?/,B=/^\w+/,K=/%$/,H=f.fn.position;f.position={scrollbarWidth:function(){if(void 0!==j)return j;var r,w,y=f("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>");return w=y.children()[0],f("body").append(y),r=w.offsetWidth,y.css("overflow","scroll"),w=w.offsetWidth,r===w&&(w=y[0].clientWidth),y.remove(),j=r-w},getScrollInfo:function(r){var w=r.isWindow||r.isDocument?"":r.element.css("overflow-x"),y=r.isWindow||r.isDocument?"":r.element.css("overflow-y");return w="scroll"===w||"auto"===w&&r.width<r.element[0].scrollWidth,{width:"scroll"===y||"auto"===y&&r.height<r.element[0].scrollHeight?f.position.scrollbarWidth():0,height:w?f.position.scrollbarWidth():0}},getWithinInfo:function(r){r=f(r||window);var w=f.isWindow(r[0]),y=!!r[0]&&9===r[0].nodeType;return{element:r,isWindow:w,isDocument:y,offset:r.offset()||{left:0,top:0},scrollLeft:r.scrollLeft(),scrollTop:r.scrollTop(),width:w||y?r.width():r.outerWidth(),height:w||y?r.height():r.outerHeight()}}},f.fn.position=function(r){if(!r||!r.of)return H.apply(this,arguments);r=f.extend({},r);var w,y,z,N,V,P,ea=f(r.of),ca=f.position.getWithinInfo(r.within),ha=f.position.getScrollInfo(ca),oa=(r.collision||"flip").split(" "),ua={};return P=d(ea),ea[0].preventDefault&&(r.at="left top"),y=P.width,z=P.height,N=P.offset,V=f.extend({},N),f.each(["my","at"],function(){var Ea,Pa,ja=(r[this]||"").split(" ");1===ja.length&&(ja=u.test(ja[0])?ja.concat(["center"]):A.test(ja[0])?["center"].concat(ja):["center","center"]),ja[0]=u.test(ja[0])?ja[0]:"center",ja[1]=A.test(ja[1])?ja[1]:"center",Ea=F.exec(ja[0]),Pa=F.exec(ja[1]),ua[this]=[Ea?Ea[0]:0,Pa?Pa[0]:0],r[this]=[B.exec(ja[0])[0],B.exec(ja[1])[0]]}),1===oa.length&&(oa[1]=oa[0]),"right"===r.at[0]?V.left+=y:"center"===r.at[0]&&(V.left+=y/2),"bottom"===r.at[1]?V.top+=z:"center"===r.at[1]&&(V.top+=z/2),w=b(ua.at,y,z),V.left+=w[0],V.top+=w[1],this.each(function(){var ja,Ea,Pa=f(this),X=Pa.outerWidth(),aa=Pa.outerHeight(),La=c(this,"marginLeft"),Ma=c(this,"marginTop"),Aa=X+La+c(this,"marginRight")+ha.width,Ua=aa+Ma+c(this,"marginBottom")+ha.height,va=f.extend({},V),gb=b(ua.my,Pa.outerWidth(),Pa.outerHeight());"right"===r.my[0]?va.left-=X:"center"===r.my[0]&&(va.left-=X/2),"bottom"===r.my[1]?va.top-=aa:"center"===r.my[1]&&(va.top-=aa/2),va.left+=gb[0],va.top+=gb[1],i||(va.left=t(va.left),va.top=t(va.top)),ja={marginLeft:La,marginTop:Ma},f.each(["left","top"],function(pb,$a){f.ui.position[oa[pb]]&&f.ui.position[oa[pb]][$a](va,{targetWidth:y,targetHeight:z,elemWidth:X,elemHeight:aa,collisionPosition:ja,collisionWidth:Aa,collisionHeight:Ua,offset:[w[0]+gb[0],w[1]+gb[1]],my:r.my,at:r.at,within:ca,elem:Pa})}),r.using&&(Ea=function(pb){var $a=N.left-va.left,Eb=$a+y-X,ab=N.top-va.top,R=ab+z-aa,h={target:{element:ea,left:N.left,top:N.top,width:y,height:z},element:{element:Pa,left:va.left,top:va.top,width:X,height:aa},horizontal:0>Eb?"left":$a>0?"right":"center",vertical:0>R?"top":ab>0?"bottom":"middle"};X>y&&q($a+Eb)<y&&(h.horizontal="center"),aa>z&&q(ab+R)<z&&(h.vertical="middle"),h.important=m(q($a),q(Eb))>m(q(ab),q(R))?"horizontal":"vertical",r.using.call(this,pb,h)}),Pa.offset(f.extend(va,{using:Ea}))})},f.ui.position={fit:{left:function(r,w){var y=w.within,z=y.isWindow?y.scrollLeft:y.offset.left,N=y.width,V=r.left-w.collisionPosition.marginLeft;y=z-V;var P=V+w.collisionWidth-N-z;w.collisionWidth>N?y>0&&0>=P?(z=r.left+y+w.collisionWidth-N-z,r.left+=y-z):r.left=P>0&&0>=y?z:y>P?z+N-w.collisionWidth:z:y>0?r.left+=y:P>0?r.left-=P:r.left=m(r.left-V,r.left)},top:function(r,w){var y=w.within,z=y.isWindow?y.scrollTop:y.offset.top,N=w.within.height,V=r.top-w.collisionPosition.marginTop;y=z-V;var P=V+w.collisionHeight-N-z;w.collisionHeight>N?y>0&&0>=P?(z=r.top+y+w.collisionHeight-N-z,r.top+=y-z):r.top=P>0&&0>=y?z:y>P?z+N-w.collisionHeight:z:y>0?r.top+=y:P>0?r.top-=P:r.top=m(r.top-V,r.top)}},flip:{left:function(r,w){var y=w.within,z=y.offset.left+y.scrollLeft,N=y.width,V=y.isWindow?y.scrollLeft:y.offset.left,P=r.left-w.collisionPosition.marginLeft;y=P-V;var ea=P+w.collisionWidth-N-V;P="left"===w.my[0]?-w.elemWidth:"right"===w.my[0]?w.elemWidth:0;var ca="left"===w.at[0]?w.targetWidth:"right"===w.at[0]?-w.targetWidth:0,ha=-2*w.offset[0];0>y?(z=r.left+P+ca+ha+w.collisionWidth-N-z,(0>z||z<q(y))&&(r.left+=P+ca+ha)):ea>0&&(z=r.left-w.collisionPosition.marginLeft+P+ca+ha-V,(z>0||q(z)<ea)&&(r.left+=P+ca+ha))},top:function(r,w){var y=w.within,z=y.offset.top+y.scrollTop,N=y.height,V=y.isWindow?y.scrollTop:y.offset.top,P=r.top-w.collisionPosition.marginTop;y=P-V;var ea=P+w.collisionHeight-N-V;P="top"===w.my[1]?-w.elemHeight:"bottom"===w.my[1]?w.elemHeight:0;var ca="top"===w.at[1]?w.targetHeight:"bottom"===w.at[1]?-w.targetHeight:0,ha=-2*w.offset[1];0>y?(z=r.top+P+ca+ha+w.collisionHeight-N-z,(0>z||z<q(y))&&(r.top+=P+ca+ha)):ea>0&&(z=r.top-w.collisionPosition.marginTop+P+ca+ha-V,(z>0||q(z)<ea)&&(r.top+=P+ca+ha))}},flipfit:{left:function(){f.ui.position.flip.left.apply(this,arguments),f.ui.position.fit.left.apply(this,arguments)},top:function(){f.ui.position.flip.top.apply(this,arguments),f.ui.position.fit.top.apply(this,arguments)}}},function(){var r,w,y,z,N=document.getElementsByTagName("body")[0];y=document.createElement("div"),r=document.createElement(N?"div":"body"),w={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},N&&f.extend(w,{position:"absolute",left:"-1000px",top:"-1000px"});for(z in w)r.style[z]=w[z];r.appendChild(y),w=N||document.documentElement,w.insertBefore(r,w.firstChild),y.style.cssText="position: absolute; left: 10.7432222px;",y=f(y).offset().left,i=y>10&&11>y,r.innerHTML="",w.removeChild(r)}()}(),f.widget("ui.draggable",f.ui.mouse,{version:"1.11.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._setHandleClassName(),this._mouseInit()},_setOption:function(b,c){this._super(b,c),"handle"===b&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){(this.helper||this.element).is(".ui-draggable-dragging")?this.destroyOnClear=!0:(this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._removeHandleClassName(),this._mouseDestroy())},_mouseCapture:function(b){var c=this.options;return this._blurActiveElement(b),this.helper||c.disabled||f(b.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(b),this.handle?(this._blockFrames(c.iframeFix===!0?"iframe":c.iframeFix),!0):!1)},_blockFrames:function(b){this.iframeBlocks=this.document.find(b).map(function(){var c=f(this);return f("<div>").css("position","absolute").appendTo(c.parent()).outerWidth(c.outerWidth()).outerHeight(c.outerHeight()).offset(c.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(b){var c=this.document[0];if(this.handleElement.is(b.target))try{c.activeElement&&"body"!==c.activeElement.nodeName.toLowerCase()&&f(c.activeElement).blur()}catch(d){}},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),f.ui.ddmanager&&(f.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===f(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(b),this.originalPosition=this.position=this._generatePosition(b,!1),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),this._setContainment(),this._trigger("start",b)===!1?(this._clear(),!1):(this._cacheHelperProportions(),f.ui.ddmanager&&!c.dropBehaviour&&f.ui.ddmanager.prepareOffsets(this,b),this._normalizeRightBottom(),this._mouseDrag(b,!0),f.ui.ddmanager&&f.ui.ddmanager.dragStart(this,b),!0)},_refreshOffsets:function(b){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:b.pageX-this.offset.left,top:b.pageY-this.offset.top}},_mouseDrag:function(b,c){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(b,!0),this.positionAbs=this._convertPositionTo("absolute"),!c){var d=this._uiHash();if(this._trigger("drag",b,d)===!1)return this._mouseUp({}),!1;this.position=d.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",f.ui.ddmanager&&f.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=this,d=!1;return f.ui.ddmanager&&!this.options.dropBehaviour&&(d=f.ui.ddmanager.drop(this,b)),this.dropped&&(d=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!d||"valid"===this.options.revert&&d||this.options.revert===!0||f.isFunction(this.options.revert)&&this.options.revert.call(this.element,d)?f(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){
c._trigger("stop",b)!==!1&&c._clear()}):this._trigger("stop",b)!==!1&&this._clear(),!1},_mouseUp:function(b){return this._unblockFrames(),f.ui.ddmanager&&f.ui.ddmanager.dragStop(this,b),this.handleElement.is(b.target)&&this.element.focus(),f.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(b){return this.options.handle?!!f(b.target).closest(this.element.find(this.options.handle)).length:!0},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this.handleElement.addClass("ui-draggable-handle")},_removeHandleClassName:function(){this.handleElement.removeClass("ui-draggable-handle")},_createHelper:function(b){var c=this.options,d=f.isFunction(c.helper);return b=d?f(c.helper.apply(this.element[0],[b])):"clone"===c.helper?this.element.clone().removeAttr("id"):this.element,b.parents("body").length||b.appendTo("parent"===c.appendTo?this.element[0].parentNode:c.appendTo),d&&b[0]===this.element[0]&&this._setPositionRelative(),b[0]!==this.element[0]&&!/(fixed|absolute)/.test(b.css("position"))&&b.css("position","absolute"),b},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),f.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_isRootNode:function(b){return/(html|body)/i.test(b.tagName)||b===this.document[0]},_getParentOffset:function(){var b=this.offsetParent.offset(),c=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==c&&f.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var b=this.element.position(),c=this._isRootNode(this.scrollParent[0]);return{top:b.top-(parseInt(this.helper.css("top"),10)||0)+(c?0:this.scrollParent.scrollTop()),left:b.left-(parseInt(this.helper.css("left"),10)||0)+(c?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b,c,d;b=this.options,c=this.document[0],this.relativeContainer=null,b.containment?"window"===b.containment?this.containment=[f(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,f(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,f(window).scrollLeft()+f(window).width()-this.helperProportions.width-this.margins.left,f(window).scrollTop()+(f(window).height()||c.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]:"document"===b.containment?this.containment=[0,0,f(c).width()-this.helperProportions.width-this.margins.left,(f(c).height()||c.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]:b.containment.constructor===Array?this.containment=b.containment:("parent"===b.containment&&(b.containment=this.helper[0].parentNode),c=f(b.containment),(d=c[0])&&(b=/(scroll|auto)/.test(c.css("overflow")),this.containment=[(parseInt(c.css("borderLeftWidth"),10)||0)+(parseInt(c.css("paddingLeft"),10)||0),(parseInt(c.css("borderTopWidth"),10)||0)+(parseInt(c.css("paddingTop"),10)||0),(b?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt(c.css("borderRightWidth"),10)||0)-(parseInt(c.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(b?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt(c.css("borderBottomWidth"),10)||0)-(parseInt(c.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=c)):this.containment=null},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"===b?1:-1,j=this._isRootNode(this.scrollParent[0]);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-("fixed"===this.cssPosition?-this.offset.scroll.top:j?0:this.offset.scroll.top)*d,left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-("fixed"===this.cssPosition?-this.offset.scroll.left:j?0:this.offset.scroll.left)*d}},_generatePosition:function(b,c){var d,j,i,m=this.options,q=this._isRootNode(this.scrollParent[0]);return i=b.pageX,j=b.pageY,q&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),c&&(this.containment&&(this.relativeContainer?(d=this.relativeContainer.offset(),d=[this.containment[0]+d.left,this.containment[1]+d.top,this.containment[2]+d.left,this.containment[3]+d.top]):d=this.containment,b.pageX-this.offset.click.left<d[0]&&(i=d[0]+this.offset.click.left),b.pageY-this.offset.click.top<d[1]&&(j=d[1]+this.offset.click.top),b.pageX-this.offset.click.left>d[2]&&(i=d[2]+this.offset.click.left),b.pageY-this.offset.click.top>d[3]&&(j=d[3]+this.offset.click.top)),m.grid&&(j=m.grid[1]?this.originalPageY+Math.round((j-this.originalPageY)/m.grid[1])*m.grid[1]:this.originalPageY,j=d?j-this.offset.click.top>=d[1]||j-this.offset.click.top>d[3]?j:j-this.offset.click.top>=d[1]?j-m.grid[1]:j+m.grid[1]:j,i=m.grid[0]?this.originalPageX+Math.round((i-this.originalPageX)/m.grid[0])*m.grid[0]:this.originalPageX,i=d?i-this.offset.click.left>=d[0]||i-this.offset.click.left>d[2]?i:i-this.offset.click.left>=d[0]?i-m.grid[0]:i+m.grid[0]:i),"y"===m.axis&&(i=this.originalPageX),"x"===m.axis&&(j=this.originalPageY)),{top:j-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:q?0:this.offset.scroll.top),left:i-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:q?0:this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!==this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_normalizeRightBottom:function(){"y"!==this.options.axis&&"auto"!==this.helper.css("right")&&(this.helper.width(this.helper.width()),this.helper.css("right","auto")),"x"!==this.options.axis&&"auto"!==this.helper.css("bottom")&&(this.helper.height(this.helper.height()),this.helper.css("bottom","auto"))},_trigger:function(b,c,d){return d=d||this._uiHash(),f.ui.plugin.call(this,b,[c,d,this],!0),/^(drag|start|stop)/.test(b)&&(this.positionAbs=this._convertPositionTo("absolute"),d.offset=this.positionAbs),f.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),f.ui.plugin.add("draggable","connectToSortable",{start:function(b,c,d){var j=f.extend({},c,{item:d.element});d.sortables=[],f(d.options.connectToSortable).each(function(){var i=f(this).sortable("instance");i&&!i.options.disabled&&(d.sortables.push(i),i.refreshPositions(),i._trigger("activate",b,j))})},stop:function(b,c,d){var j=f.extend({},c,{item:d.element});d.cancelHelperRemoval=!1,f.each(d.sortables,function(){this.isOver?(this.isOver=0,d.cancelHelperRemoval=!0,this.cancelHelperRemoval=!1,this._storedCSS={position:this.placeholder.css("position"),top:this.placeholder.css("top"),left:this.placeholder.css("left")},this._mouseStop(b),this.options.helper=this.options._helper):(this.cancelHelperRemoval=!0,this._trigger("deactivate",b,j))})},drag:function(b,c,d){f.each(d.sortables,function(){var j=!1,i=this;i.positionAbs=d.positionAbs,i.helperProportions=d.helperProportions,i.offset.click=d.offset.click,i._intersectsWith(i.containerCache)&&(j=!0,f.each(d.sortables,function(){return this.positionAbs=d.positionAbs,this.helperProportions=d.helperProportions,this.offset.click=d.offset.click,this!==i&&this._intersectsWith(this.containerCache)&&f.contains(i.element[0],this.element[0])&&(j=!1),j})),j?(i.isOver||(i.isOver=1,d._parent=c.helper.parent(),i.currentItem=c.helper.appendTo(i.element).data("ui-sortable-item",!0),i.options._helper=i.options.helper,i.options.helper=function(){return c.helper[0]},b.target=i.currentItem[0],i._mouseCapture(b,!0),i._mouseStart(b,!0,!0),i.offset.click.top=d.offset.click.top,i.offset.click.left=d.offset.click.left,i.offset.parent.left-=d.offset.parent.left-i.offset.parent.left,i.offset.parent.top-=d.offset.parent.top-i.offset.parent.top,d._trigger("toSortable",b),d.dropped=i.element,f.each(d.sortables,function(){this.refreshPositions()}),d.currentItem=d.element,i.fromOutside=d),i.currentItem&&(i._mouseDrag(b),c.position=i.position)):i.isOver&&(i.isOver=0,i.cancelHelperRemoval=!0,i.options._revert=i.options.revert,i.options.revert=!1,i._trigger("out",b,i._uiHash(i)),i._mouseStop(b,!0),i.options.revert=i.options._revert,i.options.helper=i.options._helper,i.placeholder&&i.placeholder.remove(),c.helper.appendTo(d._parent),d._refreshOffsets(b),c.position=d._generatePosition(b,!0),d._trigger("fromSortable",b),d.dropped=!1,f.each(d.sortables,function(){this.refreshPositions()}))})}}),f.ui.plugin.add("draggable","cursor",{start:function(b,c,d){b=f("body"),d=d.options,b.css("cursor")&&(d._cursor=b.css("cursor")),b.css("cursor",d.cursor)},stop:function(b,c,d){b=d.options,b._cursor&&f("body").css("cursor",b._cursor)}}),f.ui.plugin.add("draggable","opacity",{start:function(b,c,d){b=f(c.helper),d=d.options,b.css("opacity")&&(d._opacity=b.css("opacity")),b.css("opacity",d.opacity)},stop:function(b,c,d){b=d.options,b._opacity&&f(c.helper).css("opacity",b._opacity)}}),f.ui.plugin.add("draggable","scroll",{start:function(b,c,d){d.scrollParentNotHidden||(d.scrollParentNotHidden=d.helper.scrollParent(!1)),d.scrollParentNotHidden[0]!==d.document[0]&&"HTML"!==d.scrollParentNotHidden[0].tagName&&(d.overflowOffset=d.scrollParentNotHidden.offset())},drag:function(b,c,d){c=d.options;var j=!1,i=d.scrollParentNotHidden[0],m=d.document[0];i!==m&&"HTML"!==i.tagName?(c.axis&&"x"===c.axis||(d.overflowOffset.top+i.offsetHeight-b.pageY<c.scrollSensitivity?i.scrollTop=j=i.scrollTop+c.scrollSpeed:b.pageY-d.overflowOffset.top<c.scrollSensitivity&&(i.scrollTop=j=i.scrollTop-c.scrollSpeed)),c.axis&&"y"===c.axis||(d.overflowOffset.left+i.offsetWidth-b.pageX<c.scrollSensitivity?i.scrollLeft=j=i.scrollLeft+c.scrollSpeed:b.pageX-d.overflowOffset.left<c.scrollSensitivity&&(i.scrollLeft=j=i.scrollLeft-c.scrollSpeed))):(c.axis&&"x"===c.axis||(b.pageY-f(m).scrollTop()<c.scrollSensitivity?j=f(m).scrollTop(f(m).scrollTop()-c.scrollSpeed):f(window).height()-(b.pageY-f(m).scrollTop())<c.scrollSensitivity&&(j=f(m).scrollTop(f(m).scrollTop()+c.scrollSpeed))),c.axis&&"y"===c.axis||(b.pageX-f(m).scrollLeft()<c.scrollSensitivity?j=f(m).scrollLeft(f(m).scrollLeft()-c.scrollSpeed):f(window).width()-(b.pageX-f(m).scrollLeft())<c.scrollSensitivity&&(j=f(m).scrollLeft(f(m).scrollLeft()+c.scrollSpeed)))),j!==!1&&f.ui.ddmanager&&!c.dropBehaviour&&f.ui.ddmanager.prepareOffsets(d,b)}}),f.ui.plugin.add("draggable","snap",{start:function(b,c,d){b=d.options,d.snapElements=[],f(b.snap.constructor!==String?b.snap.items||":data(ui-draggable)":b.snap).each(function(){var j=f(this),i=j.offset();this!==d.element[0]&&d.snapElements.push({item:this,width:j.outerWidth(),height:j.outerHeight(),top:i.top,left:i.left})})},drag:function(b,c,d){var j,i,m,q,t,u,A,F,B,K,H=d.options,r=H.snapTolerance,w=c.offset.left,y=w+d.helperProportions.width,z=c.offset.top,N=z+d.helperProportions.height;for(B=d.snapElements.length-1;B>=0;B--)t=d.snapElements[B].left-d.margins.left,u=t+d.snapElements[B].width,A=d.snapElements[B].top-d.margins.top,F=A+d.snapElements[B].height,t-r>y||w>u+r||A-r>N||z>F+r||!f.contains(d.snapElements[B].item.ownerDocument,d.snapElements[B].item)?(d.snapElements[B].snapping&&d.options.snap.release&&d.options.snap.release.call(d.element,b,f.extend(d._uiHash(),{snapItem:d.snapElements[B].item})),d.snapElements[B].snapping=!1):("inner"!==H.snapMode&&(j=Math.abs(A-N)<=r,i=Math.abs(F-z)<=r,m=Math.abs(t-y)<=r,q=Math.abs(u-w)<=r,j&&(c.position.top=d._convertPositionTo("relative",{top:A-d.helperProportions.height,left:0}).top),i&&(c.position.top=d._convertPositionTo("relative",{top:F,left:0}).top),m&&(c.position.left=d._convertPositionTo("relative",{top:0,left:t-d.helperProportions.width}).left),q&&(c.position.left=d._convertPositionTo("relative",{top:0,left:u}).left)),K=j||i||m||q,"outer"!==H.snapMode&&(j=Math.abs(A-z)<=r,i=Math.abs(F-N)<=r,m=Math.abs(t-w)<=r,q=Math.abs(u-y)<=r,j&&(c.position.top=d._convertPositionTo("relative",{top:A,left:0}).top),i&&(c.position.top=d._convertPositionTo("relative",{top:F-d.helperProportions.height,left:0}).top),m&&(c.position.left=d._convertPositionTo("relative",{top:0,left:t}).left),q&&(c.position.left=d._convertPositionTo("relative",{top:0,left:u-d.helperProportions.width}).left)),!d.snapElements[B].snapping&&(j||i||m||q||K)&&d.options.snap.snap&&d.options.snap.snap.call(d.element,b,f.extend(d._uiHash(),{snapItem:d.snapElements[B].item})),d.snapElements[B].snapping=j||i||m||q||K)}}),f.ui.plugin.add("draggable","stack",{start:function(b,c,d){var j;b=f.makeArray(f(d.options.stack)).sort(function(i,m){return(parseInt(f(i).css("zIndex"),10)||0)-(parseInt(f(m).css("zIndex"),10)||0)}),b.length&&(j=parseInt(f(b[0]).css("zIndex"),10)||0,f(b).each(function(i){f(this).css("zIndex",j+i)}),this.css("zIndex",j+b.length))}}),f.ui.plugin.add("draggable","zIndex",{start:function(b,c,d){b=f(c.helper),d=d.options,b.css("zIndex")&&(d._zIndex=b.css("zIndex")),b.css("zIndex",d.zIndex)},stop:function(b,c,d){b=d.options,b._zIndex&&f(c.helper).css("zIndex",b._zIndex)}}),f.widget("ui.droppable",{version:"1.11.4",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var b,c=this.options,d=c.accept;this.isover=!1,this.isout=!0,this.accept=f.isFunction(d)?d:function(j){return j.is(d)},this.proportions=function(){return arguments.length?void(b=arguments[0]):b?b:b={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight}},this._addToManager(c.scope),c.addClasses&&this.element.addClass("ui-droppable")},_addToManager:function(b){f.ui.ddmanager.droppables[b]=f.ui.ddmanager.droppables[b]||[],f.ui.ddmanager.droppables[b].push(this)},_splice:function(b){for(var c=0;c<b.length;c++)b[c]===this&&b.splice(c,1)},_destroy:function(){this._splice(f.ui.ddmanager.droppables[this.options.scope]),this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(b,c){"accept"===b?this.accept=f.isFunction(c)?c:function(d){return d.is(c)}:"scope"===b&&(this._splice(f.ui.ddmanager.droppables[this.options.scope]),this._addToManager(c)),this._super(b,c)},_activate:function(b){var c=f.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),c&&this._trigger("activate",b,this.ui(c))},_deactivate:function(b){var c=f.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),c&&this._trigger("deactivate",b,this.ui(c))},_over:function(b){var c=f.ui.ddmanager.current;c&&(c.currentItem||c.element)[0]!==this.element[0]&&this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",b,this.ui(c)))},_out:function(b){var c=f.ui.ddmanager.current;c&&(c.currentItem||c.element)[0]!==this.element[0]&&this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",b,this.ui(c)))},_drop:function(b,c){var d=c||f.ui.ddmanager.current,j=!1;return d&&(d.currentItem||d.element)[0]!==this.element[0]?(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var i=f(this).droppable("instance");return i.options.greedy&&!i.options.disabled&&i.options.scope===d.options.scope&&i.accept.call(i.element[0],d.currentItem||d.element)&&f.ui.intersect(d,f.extend(i,{offset:i.element.offset()}),i.options.tolerance,b)?(j=!0,!1):void 0}),j?!1:this.accept.call(this.element[0],d.currentItem||d.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",b,this.ui(d)),this.element):!1):!1},ui:function(b){return{draggable:b.currentItem||b.element,helper:b.helper,position:b.position,offset:b.positionAbs}}}),f.ui.intersect=function(){return function(b,c,d,j){if(!c.offset)return!1;var i=(b.positionAbs||b.position.absolute).left+b.margins.left,m=(b.positionAbs||b.position.absolute).top+b.margins.top,q=i+b.helperProportions.width,t=m+b.helperProportions.height,u=c.offset.left,A=c.offset.top,F=u+c.proportions().width,B=A+c.proportions().height;switch(d){case"fit":return i>=u&&F>=q&&m>=A&&B>=t;case"intersect":return u<i+b.helperProportions.width/2&&q-b.helperProportions.width/2<F&&A<m+b.helperProportions.height/2&&t-b.helperProportions.height/2<B;case"pointer":return b=j.pageY,d=c.proportions().height,(A=b>=A&&A+d>b)&&(j=j.pageX,c=c.proportions().width,A=j>=u&&u+c>j),A;case"touch":return(m>=A&&B>=m||t>=A&&B>=t||A>m&&t>B)&&(i>=u&&F>=i||q>=u&&F>=q||u>i&&q>F);default:return!1}}}(),f.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(b,c){var d,j,i=f.ui.ddmanager.droppables[b.options.scope]||[],m=c?c.type:null,q=(b.currentItem||b.element).find(":data(ui-droppable)").addBack();d=0;a:for(;d<i.length;d++)if(!(i[d].options.disabled||b&&!i[d].accept.call(i[d].element[0],b.currentItem||b.element))){for(j=0;j<q.length;j++)if(q[j]===i[d].element[0]){i[d].proportions().height=0;continue a}i[d].visible="none"!==i[d].element.css("display"),i[d].visible&&("mousedown"===m&&i[d]._activate.call(i[d],c),i[d].offset=i[d].element.offset(),i[d].proportions({width:i[d].element[0].offsetWidth,height:i[d].element[0].offsetHeight}))}},drop:function(b,c){var d=!1;return f.each((f.ui.ddmanager.droppables[b.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&f.ui.intersect(b,this,this.options.tolerance,c)&&(d=this._drop.call(this,c)||d),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],b.currentItem||b.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,c)))}),d},dragStart:function(b,c){b.element.parentsUntil("body").bind("scroll.droppable",function(){b.options.refreshPositions||f.ui.ddmanager.prepareOffsets(b,c)})},drag:function(b,c){b.options.refreshPositions&&f.ui.ddmanager.prepareOffsets(b,c),f.each(f.ui.ddmanager.droppables[b.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var d,j,i;i=f.ui.intersect(b,this,this.options.tolerance,c);var m=!i&&this.isover?"isout":i&&!this.isover?"isover":null;m&&(this.options.greedy&&(j=this.options.scope,i=this.element.parents(":data(ui-droppable)").filter(function(){return f(this).droppable("instance").options.scope===j}),i.length&&(d=f(i[0]).droppable("instance"),d.greedyChild="isover"===m)),d&&"isover"===m&&(d.isover=!1,d.isout=!0,d._out.call(d,c)),this[m]=!0,this["isout"===m?"isover":"isout"]=!1,this["isover"===m?"_over":"_out"].call(this,c),d&&"isout"===m&&(d.isout=!1,d.isover=!0,d._over.call(d,c)))}})},dragStop:function(b,c){b.element.parentsUntil("body").unbind("scroll.droppable"),b.options.refreshPositions||f.ui.ddmanager.prepareOffsets(b,c)}},f.widget("ui.resizable",f.ui.mouse,{version:"1.11.4",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(b){return parseInt(b,10)||0},_isNumber:function(b){return!isNaN(parseInt(b,10))},_hasScroll:function(b,c){if("hidden"===f(b).css("overflow"))return!1;var d=c&&"left"===c?"scrollLeft":"scrollTop",j=!1;return b[d]>0?!0:(b[d]=1,j=b[d]>0,b[d]=0,j)},_create:function(){var b,c,d,j,i,m=this,q=this.options;if(this.element.addClass("ui-resizable"),f.extend(this,{_aspectRatio:!!q.aspectRatio,aspectRatio:q.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:q.helper||q.ghost||q.animate?q.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap(f("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=q.handles||(f(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=f(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),b=this.handles.split(","),this.handles={},c=0;c<b.length;c++)d=f.trim(b[c]),i="ui-resizable-"+d,j=f("<div class='ui-resizable-handle "+i+"'></div>"),j.css({zIndex:q.zIndex}),"se"===d&&j.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[d]=".ui-resizable-"+d,this.element.append(j);this._renderAxis=function(t){var u,A,F;t=t||this.element;for(u in this.handles)this.handles[u].constructor===String?this.handles[u]=this.element.children(this.handles[u]).first().show():(this.handles[u].jquery||this.handles[u].nodeType)&&(this.handles[u]=f(this.handles[u]),this._on(this.handles[u],{mousedown:m._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(A=f(this.handles[u],this.element),F=/sw|ne|nw|se|n|s/.test(u)?A.outerHeight():A.outerWidth(),A=["padding",/ne|nw|n/.test(u)?"Top":/se|sw|s/.test(u)?"Bottom":/^e$/.test(u)?"Right":"Left"].join(""),t.css(A,F),this._proportionallyResize()),this._handles=this._handles.add(this.handles[u])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.mouseover(function(){m.resizing||(this.className&&(j=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),m.axis=j&&j[1]?j[1]:"se")}),q.autoHide&&(this._handles.hide(),f(this.element).addClass("ui-resizable-autohide").mouseenter(function(){q.disabled||(f(this).removeClass("ui-resizable-autohide"),m._handles.show())}).mouseleave(function(){q.disabled||m.resizing||(f(this).addClass("ui-resizable-autohide"),m._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var b,c=function(d){f(d).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(c(this.element),b=this.element,this.originalElement.css({position:b.css("position"),width:b.outerWidth(),height:b.outerHeight(),top:b.css("top"),left:b.css("left")}).insertAfter(b),b.remove()),this.originalElement.css("resize",this.originalResizeStyle),c(this.originalElement),this},_mouseCapture:function(b){var c,d,j=!1;for(c in this.handles)d=f(this.handles[c])[0],(d===b.target||f.contains(d,b.target))&&(j=!0);return!this.options.disabled&&j},_mouseStart:function(b){var c,d,j=this.options,i=this.element;return this.resizing=!0,this._renderProxy(),c=this._num(this.helper.css("left")),d=this._num(this.helper.css("top")),j.containment&&(c+=f(j.containment).scrollLeft()||0,d+=f(j.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:c,top:d},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:i.width(),height:i.height()},this.originalSize=this._helper?{width:i.outerWidth(),height:i.outerHeight()}:{width:i.width(),height:i.height()},this.sizeDiff={width:i.outerWidth()-i.width(),height:i.outerHeight()-i.height()},this.originalPosition={left:c,top:d},this.originalMousePosition={left:b.pageX,top:b.pageY},this.aspectRatio="number"==typeof j.aspectRatio?j.aspectRatio:this.originalSize.width/this.originalSize.height||1,c=f(".ui-resizable-"+this.axis).css("cursor"),f("body").css("cursor","auto"===c?this.axis+"-resize":c),i.addClass("ui-resizable-resizing"),this._propagate("start",b),!0},_mouseDrag:function(b){var c,d=this.originalMousePosition;c=b.pageX-d.left||0,d=b.pageY-d.top||0;var j=this._change[this.axis];return this._updatePrevProperties(),j?(c=j.apply(this,[b,c,d]),this._updateVirtualBoundaries(b.shiftKey),(this._aspectRatio||b.shiftKey)&&(c=this._updateRatio(c,b)),c=this._respectSize(c,b),this._updateCache(c),this._propagate("resize",b),c=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),f.isEmptyObject(c)||(this._updatePrevProperties(),this._trigger("resize",b,this.ui()),this._applyChanges()),!1):!1},_mouseStop:function(b){this.resizing=!1;var c,d,j,i=this.options;return this._helper&&(c=this._proportionallyResizeElements,c=(d=c.length&&/textarea/i.test(c[0].nodeName))&&this._hasScroll(c[0],"left")?0:this.sizeDiff.height,d=d?0:this.sizeDiff.width,d={width:this.helper.width()-d,height:this.helper.height()-c},c=parseInt(this.element.css("left"),10)+(this.position.left-this.originalPosition.left)||null,j=parseInt(this.element.css("top"),10)+(this.position.top-this.originalPosition.top)||null,i.animate||this.element.css(f.extend(d,{top:j,left:c})),this.helper.height(this.size.height),this.helper.width(this.size.width),this._helper&&!i.animate&&this._proportionallyResize()),f("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",b),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var b={};return this.position.top!==this.prevPosition.top&&(b.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(b.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(b.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(b.height=this.size.height+"px"),this.helper.css(b),b},_updateVirtualBoundaries:function(b){var c,d,j,i;i=this.options,i={minWidth:this._isNumber(i.minWidth)?i.minWidth:0,maxWidth:this._isNumber(i.maxWidth)?i.maxWidth:1/0,minHeight:this._isNumber(i.minHeight)?i.minHeight:0,maxHeight:this._isNumber(i.maxHeight)?i.maxHeight:1/0},(this._aspectRatio||b)&&(b=i.minHeight*this.aspectRatio,d=i.minWidth/this.aspectRatio,c=i.maxHeight*this.aspectRatio,j=i.maxWidth/this.aspectRatio,b>i.minWidth&&(i.minWidth=b),d>i.minHeight&&(i.minHeight=d),c<i.maxWidth&&(i.maxWidth=c),j<i.maxHeight&&(i.maxHeight=j)),this._vBoundaries=i},_updateCache:function(b){this.offset=this.helper.offset(),this._isNumber(b.left)&&(this.position.left=b.left),this._isNumber(b.top)&&(this.position.top=b.top),this._isNumber(b.height)&&(this.size.height=b.height),this._isNumber(b.width)&&(this.size.width=b.width)},_updateRatio:function(b){var c=this.position,d=this.size,j=this.axis;return this._isNumber(b.height)?b.width=b.height*this.aspectRatio:this._isNumber(b.width)&&(b.height=b.width/this.aspectRatio),"sw"===j&&(b.left=c.left+(d.width-b.width),b.top=null),"nw"===j&&(b.top=c.top+(d.height-b.height),b.left=c.left+(d.width-b.width)),b},_respectSize:function(b){var c=this._vBoundaries,d=this.axis,j=this._isNumber(b.width)&&c.maxWidth&&c.maxWidth<b.width,i=this._isNumber(b.height)&&c.maxHeight&&c.maxHeight<b.height,m=this._isNumber(b.width)&&c.minWidth&&c.minWidth>b.width,q=this._isNumber(b.height)&&c.minHeight&&c.minHeight>b.height,t=this.originalPosition.left+this.originalSize.width,u=this.position.top+this.size.height,A=/sw|nw|w/.test(d);return d=/nw|ne|n/.test(d),m&&(b.width=c.minWidth),q&&(b.height=c.minHeight),j&&(b.width=c.maxWidth),i&&(b.height=c.maxHeight),m&&A&&(b.left=t-c.minWidth),j&&A&&(b.left=t-c.maxWidth),q&&d&&(b.top=u-c.minHeight),i&&d&&(b.top=u-c.maxHeight),b.width||b.height||b.left||!b.top?b.width||b.height||b.top||!b.left||(b.left=null):b.top=null,b},_getPaddingPlusBorderDimensions:function(b){var c=0,d=[],j=[b.css("borderTopWidth"),b.css("borderRightWidth"),b.css("borderBottomWidth"),b.css("borderLeftWidth")];for(b=[b.css("paddingTop"),b.css("paddingRight"),b.css("paddingBottom"),b.css("paddingLeft")];4>c;c++)d[c]=parseInt(j[c],10)||0,d[c]+=parseInt(b[c],10)||0;return{height:d[0]+d[2],width:d[1]+d[3]}},_proportionallyResize:function(){if(this._proportionallyResizeElements.length)for(var b,c=0,d=this.helper||this.element;c<this._proportionallyResizeElements.length;c++)b=this._proportionallyResizeElements[c],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(b)),b.css({height:d.height()-this.outerDimensions.height||0,width:d.width()-this.outerDimensions.width||0})},_renderProxy:function(){var b=this.options;this.elementOffset=this.element.offset(),this._helper?(this.helper=this.helper||f("<div style='overflow:hidden;'></div>"),this.helper.addClass(this._helper).css({width:this.element.outerWidth()-1,height:this.element.outerHeight()-1,position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++b.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(b,c){return{width:this.originalSize.width+c}},w:function(b,c){return{left:this.originalPosition.left+c,width:this.originalSize.width-c}},n:function(b,c,d){return{top:this.originalPosition.top+d,height:this.originalSize.height-d}},s:function(b,c,d){return{height:this.originalSize.height+d}},se:function(b,c,d){return f.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[b,c,d]))},sw:function(b,c,d){return f.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[b,c,d]))},ne:function(b,c,d){return f.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[b,c,d]))},nw:function(b,c,d){return f.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[b,c,d]))}},_propagate:function(b,c){f.ui.plugin.call(this,b,[c,this.ui()]),"resize"!==b&&this._trigger(b,c,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,
position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),f.ui.plugin.add("resizable","animate",{stop:function(b){var c=f(this).resizable("instance"),d=c.options,j=c._proportionallyResizeElements,i=j.length&&/textarea/i.test(j[0].nodeName),m=i&&c._hasScroll(j[0],"left")?0:c.sizeDiff.height;i={width:c.size.width-(i?0:c.sizeDiff.width),height:c.size.height-m},m=parseInt(c.element.css("left"),10)+(c.position.left-c.originalPosition.left)||null;var q=parseInt(c.element.css("top"),10)+(c.position.top-c.originalPosition.top)||null;c.element.animate(f.extend(i,q&&m?{top:q,left:m}:{}),{duration:d.animateDuration,easing:d.animateEasing,step:function(){var t={width:parseInt(c.element.css("width"),10),height:parseInt(c.element.css("height"),10),top:parseInt(c.element.css("top"),10),left:parseInt(c.element.css("left"),10)};j&&j.length&&f(j[0]).css({width:t.width,height:t.height}),c._updateCache(t),c._propagate("resize",b)}})}}),f.ui.plugin.add("resizable","containment",{start:function(){var b,c,d,j,i,m=f(this).resizable("instance"),q=m.element;d=m.options.containment,(q=d instanceof f?d.get(0):/parent/.test(d)?q.parent().get(0):d)&&(m.containerElement=f(q),/document/.test(d)||d===document?(m.containerOffset={left:0,top:0},m.containerPosition={left:0,top:0},m.parentData={element:f(document),left:0,top:0,width:f(document).width(),height:f(document).height()||document.body.parentNode.scrollHeight}):(b=f(q),c=[],f(["Top","Right","Left","Bottom"]).each(function(t,u){c[t]=m._num(b.css("padding"+u))}),m.containerOffset=b.offset(),m.containerPosition=b.position(),m.containerSize={height:b.innerHeight()-c[3],width:b.innerWidth()-c[1]},d=m.containerOffset,j=m.containerSize.height,i=m.containerSize.width,i=m._hasScroll(q,"left")?q.scrollWidth:i,j=m._hasScroll(q)?q.scrollHeight:j,m.parentData={element:q,left:d.left,top:d.top,width:i,height:j}))},resize:function(b){var c,d,j,i=f(this).resizable("instance");c=i.options,d=i.containerOffset,j=i.position,b=i._aspectRatio||b.shiftKey;var m={top:0,left:0},q=i.containerElement,t=!0;q[0]!==document&&/static/.test(q.css("position"))&&(m=d),j.left<(i._helper?d.left:0)&&(i.size.width+=i._helper?i.position.left-d.left:i.position.left-m.left,b&&(i.size.height=i.size.width/i.aspectRatio,t=!1),i.position.left=c.helper?d.left:0),j.top<(i._helper?d.top:0)&&(i.size.height+=i._helper?i.position.top-d.top:i.position.top,b&&(i.size.width=i.size.height*i.aspectRatio,t=!1),i.position.top=i._helper?d.top:0),c=i.containerElement.get(0)===i.element.parent().get(0),j=/relative|absolute/.test(i.containerElement.css("position")),c&&j?(i.offset.left=i.parentData.left+i.position.left,i.offset.top=i.parentData.top+i.position.top):(i.offset.left=i.element.offset().left,i.offset.top=i.element.offset().top),c=Math.abs(i.sizeDiff.width+(i._helper?i.offset.left-m.left:i.offset.left-d.left)),d=Math.abs(i.sizeDiff.height+(i._helper?i.offset.top-m.top:i.offset.top-d.top)),c+i.size.width>=i.parentData.width&&(i.size.width=i.parentData.width-c,b&&(i.size.height=i.size.width/i.aspectRatio,t=!1)),d+i.size.height>=i.parentData.height&&(i.size.height=i.parentData.height-d,b&&(i.size.width=i.size.height*i.aspectRatio,t=!1)),t||(i.position.left=i.prevPosition.left,i.position.top=i.prevPosition.top,i.size.width=i.prevSize.width,i.size.height=i.prevSize.height)},stop:function(){var b=f(this).resizable("instance"),c=b.options,d=b.containerOffset,j=b.containerPosition,i=b.containerElement,m=f(b.helper),q=m.offset(),t=m.outerWidth()-b.sizeDiff.width;m=m.outerHeight()-b.sizeDiff.height,b._helper&&!c.animate&&/relative/.test(i.css("position"))&&f(this).css({left:q.left-j.left-d.left,width:t,height:m}),b._helper&&!c.animate&&/static/.test(i.css("position"))&&f(this).css({left:q.left-j.left-d.left,width:t,height:m})}}),f.ui.plugin.add("resizable","alsoResize",{start:function(){var b=f(this).resizable("instance").options;f(b.alsoResize).each(function(){var c=f(this);c.data("ui-resizable-alsoresize",{width:parseInt(c.width(),10),height:parseInt(c.height(),10),left:parseInt(c.css("left"),10),top:parseInt(c.css("top"),10)})})},resize:function(b,c){var d=f(this).resizable("instance"),j=d.originalSize,i=d.originalPosition,m={height:d.size.height-j.height||0,width:d.size.width-j.width||0,top:d.position.top-i.top||0,left:d.position.left-i.left||0};f(d.options.alsoResize).each(function(){var q=f(this),t=f(this).data("ui-resizable-alsoresize"),u={},A=q.parents(c.originalElement[0]).length?["width","height"]:["width","height","top","left"];f.each(A,function(F,B){var K=(t[B]||0)+(m[B]||0);K&&K>=0&&(u[B]=K||null)}),q.css(u)})},stop:function(){f(this).removeData("resizable-alsoresize")}}),f.ui.plugin.add("resizable","ghost",{start:function(){var b=f(this).resizable("instance"),c=b.options,d=b.size;b.ghost=b.originalElement.clone(),b.ghost.css({opacity:.25,display:"block",position:"relative",height:d.height,width:d.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof c.ghost?c.ghost:""),b.ghost.appendTo(b.helper)},resize:function(){var b=f(this).resizable("instance");b.ghost&&b.ghost.css({position:"relative",height:b.size.height,width:b.size.width})},stop:function(){var b=f(this).resizable("instance");b.ghost&&b.helper&&b.helper.get(0).removeChild(b.ghost.get(0))}}),f.ui.plugin.add("resizable","grid",{resize:function(){var b,c=f(this).resizable("instance"),d=c.options,j=c.size,i=c.originalSize,m=c.originalPosition,q=c.axis,t="number"==typeof d.grid?[d.grid,d.grid]:d.grid,u=t[0]||1,A=t[1]||1,F=Math.round((j.width-i.width)/u)*u;j=Math.round((j.height-i.height)/A)*A;var B=i.width+F,K=i.height+j,H=d.maxWidth&&d.maxWidth<B,r=d.maxHeight&&d.maxHeight<K,w=d.minWidth&&d.minWidth>B,y=d.minHeight&&d.minHeight>K;d.grid=t,w&&(B+=u),y&&(K+=A),H&&(B-=u),r&&(K-=A),/^(se|s|e)$/.test(q)?(c.size.width=B,c.size.height=K):/^(ne)$/.test(q)?(c.size.width=B,c.size.height=K,c.position.top=m.top-j):/^(sw)$/.test(q)?(c.size.width=B,c.size.height=K,c.position.left=m.left-F):((0>=K-A||0>=B-u)&&(b=c._getPaddingPlusBorderDimensions(this)),K-A>0?(c.size.height=K,c.position.top=m.top-j):(K=A-b.height,c.size.height=K,c.position.top=m.top+i.height-K),B-u>0?(c.size.width=B,c.position.left=m.left-F):(B=u-b.width,c.size.width=B,c.position.left=m.left+i.width-B))}}),f.widget("ui.selectable",f.ui.mouse,{version:"1.11.4",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var b,c=this;this.element.addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){b=f(c.options.filter,c.element[0]),b.addClass("ui-selectee"),b.each(function(){var d=f(this),j=d.offset();f.data(this,"selectable-item",{element:this,$element:d,left:j.left,top:j.top,right:j.left+d.outerWidth(),bottom:j.top+d.outerHeight(),startselected:!1,selected:d.hasClass("ui-selected"),selecting:d.hasClass("ui-selecting"),unselecting:d.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=b.addClass("ui-selectee"),this._mouseInit(),this.helper=f("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(b){var c=this,d=this.options;this.opos=[b.pageX,b.pageY],this.options.disabled||(this.selectees=f(d.filter,this.element[0]),this._trigger("start",b),f(d.appendTo).append(this.helper),this.helper.css({left:b.pageX,top:b.pageY,width:0,height:0}),d.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var j=f.data(this,"selectable-item");j.startselected=!0,b.metaKey||b.ctrlKey||(j.$element.removeClass("ui-selected"),j.selected=!1,j.$element.addClass("ui-unselecting"),j.unselecting=!0,c._trigger("unselecting",b,{unselecting:j.element}))}),f(b.target).parents().addBack().each(function(){var j,i=f.data(this,"selectable-item");return i?(j=!b.metaKey&&!b.ctrlKey||!i.$element.hasClass("ui-selected"),i.$element.removeClass(j?"ui-unselecting":"ui-selected").addClass(j?"ui-selecting":"ui-unselecting"),i.unselecting=!j,i.selecting=j,(i.selected=j)?c._trigger("selecting",b,{selecting:i.element}):c._trigger("unselecting",b,{unselecting:i.element}),!1):void 0}))},_mouseDrag:function(b){if(this.dragged=!0,!this.options.disabled){var c,d=this,j=this.options,i=this.opos[0],m=this.opos[1],q=b.pageX,t=b.pageY;return i>q&&(c=q,q=i,i=c),m>t&&(c=t,t=m,m=c),this.helper.css({left:i,top:m,width:q-i,height:t-m}),this.selectees.each(function(){var u=f.data(this,"selectable-item"),A=!1;u&&u.element!==d.element[0]&&("touch"===j.tolerance?A=!(u.left>q||u.right<i||u.top>t||u.bottom<m):"fit"===j.tolerance&&(A=u.left>i&&u.right<q&&u.top>m&&u.bottom<t),A?(u.selected&&(u.$element.removeClass("ui-selected"),u.selected=!1),u.unselecting&&(u.$element.removeClass("ui-unselecting"),u.unselecting=!1),u.selecting||(u.$element.addClass("ui-selecting"),u.selecting=!0,d._trigger("selecting",b,{selecting:u.element}))):(u.selecting&&((b.metaKey||b.ctrlKey)&&u.startselected?(u.$element.removeClass("ui-selecting"),u.selecting=!1,u.$element.addClass("ui-selected"),u.selected=!0):(u.$element.removeClass("ui-selecting"),u.selecting=!1,u.startselected&&(u.$element.addClass("ui-unselecting"),u.unselecting=!0),d._trigger("unselecting",b,{unselecting:u.element}))),u.selected&&(b.metaKey||b.ctrlKey||u.startselected||(u.$element.removeClass("ui-selected"),u.selected=!1,u.$element.addClass("ui-unselecting"),u.unselecting=!0,d._trigger("unselecting",b,{unselecting:u.element})))))}),!1}},_mouseStop:function(b){var c=this;return this.dragged=!1,f(".ui-unselecting",this.element[0]).each(function(){var d=f.data(this,"selectable-item");d.$element.removeClass("ui-unselecting"),d.unselecting=!1,d.startselected=!1,c._trigger("unselected",b,{unselected:d.element})}),f(".ui-selecting",this.element[0]).each(function(){var d=f.data(this,"selectable-item");d.$element.removeClass("ui-selecting").addClass("ui-selected"),d.selecting=!1,d.selected=!0,d.startselected=!0,c._trigger("selected",b,{selected:d.element})}),this._trigger("stop",b),this.helper.remove(),!1}}),f.widget("ui.sortable",f.ui.mouse,{version:"1.11.4",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(b,c,d){return b>=c&&c+d>b},_isFloating:function(b){return/left|right/.test(b.css("float"))||/inline|table-cell/.test(b.css("display"))},_create:function(){this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(b,c){this._super(b,c),"handle"===b&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),f.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var b=this.items.length-1;b>=0;b--)this.items[b].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(b,c){var d=null,j=!1,i=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(b),f(b.target).parents().each(function(){return f.data(this,i.widgetName+"-item")===i?(d=f(this),!1):void 0}),f.data(b.target,i.widgetName+"-item")===i&&(d=f(b.target)),d&&(!this.options.handle||c||(f(this.options.handle,d).find("*").addBack().each(function(){this===b.target&&(j=!0)}),j))?(this.currentItem=d,this._removeCurrentsFromItems(),!0):!1)},_mouseStart:function(b,c,d){var j;if(c=this.options,this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(b),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},f.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),c.containment&&this._setContainment(),c.cursor&&"auto"!==c.cursor&&(j=this.document.find("body"),this.storedCursor=j.css("cursor"),j.css("cursor",c.cursor),this.storedStylesheet=f("<style>*{ cursor: "+c.cursor+" !important; }</style>").appendTo(j)),c.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",c.opacity)),c.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",c.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",b,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!d)for(d=this.containers.length-1;d>=0;d--)this.containers[d]._trigger("activate",b,this._uiHash(this));return f.ui.ddmanager&&(f.ui.ddmanager.current=this),f.ui.ddmanager&&!c.dropBehaviour&&f.ui.ddmanager.prepareOffsets(this,b),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(b),!0},_mouseDrag:function(b){var c,d,j,i;for(c=this.options,d=!1,this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<c.scrollSensitivity?this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+c.scrollSpeed:b.pageY-this.overflowOffset.top<c.scrollSensitivity&&(this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-c.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<c.scrollSensitivity?this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+c.scrollSpeed:b.pageX-this.overflowOffset.left<c.scrollSensitivity&&(this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-c.scrollSpeed)):(b.pageY-this.document.scrollTop()<c.scrollSensitivity?d=this.document.scrollTop(this.document.scrollTop()-c.scrollSpeed):this.window.height()-(b.pageY-this.document.scrollTop())<c.scrollSensitivity&&(d=this.document.scrollTop(this.document.scrollTop()+c.scrollSpeed)),b.pageX-this.document.scrollLeft()<c.scrollSensitivity?d=this.document.scrollLeft(this.document.scrollLeft()-c.scrollSpeed):this.window.width()-(b.pageX-this.document.scrollLeft())<c.scrollSensitivity&&(d=this.document.scrollLeft(this.document.scrollLeft()+c.scrollSpeed))),d!==!1&&f.ui.ddmanager&&!c.dropBehaviour&&f.ui.ddmanager.prepareOffsets(this,b)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),c=this.items.length-1;c>=0;c--)if(d=this.items[c],j=d.item[0],(i=this._intersectsWithPointer(d))&&d.instance===this.currentContainer&&j!==this.currentItem[0]&&this.placeholder[1===i?"next":"prev"]()[0]!==j&&!f.contains(this.placeholder[0],j)&&("semi-dynamic"===this.options.type?!f.contains(this.element[0],j):1)){if(this.direction=1===i?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(d))break;this._rearrange(b,d),this._trigger("change",b,this._uiHash());break}return this._contactContainers(b),f.ui.ddmanager&&f.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b,c){if(b){if(f.ui.ddmanager&&!this.options.dropBehaviour&&f.ui.ddmanager.drop(this,b),this.options.revert){var d=this,j=this.placeholder.offset(),i=this.options.axis,m={};i&&"x"!==i||(m.left=j.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),i&&"y"!==i||(m.top=j.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,f(this.helper).animate(m,parseInt(this.options.revert,10)||500,function(){d._clear(b)})}else this._clear(b,c);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var b=this.containers.length-1;b>=0;b--)this.containers[b]._trigger("deactivate",null,this._uiHash(this)),this.containers[b].containerCache.over&&(this.containers[b]._trigger("out",null,this._uiHash(this)),this.containers[b].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),f.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?f(this.domPosition.prev).after(this.currentItem):f(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},f(c).each(function(){var j=(f(b.item||this).attr(b.attribute||"id")||"").match(b.expression||/(.+)[\-=_](.+)/);j&&d.push((b.key||j[1]+"[]")+"="+(b.key&&b.expression?j[1]:j[2]))}),!d.length&&b.key&&d.push(b.key+"="),d.join("&")},toArray:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},c.each(function(){d.push(f(b.item||this).attr(b.attribute||"id")||"")}),d},_intersectsWith:function(b){var c=this.positionAbs.left,d=c+this.helperProportions.width,j=this.positionAbs.top,i=j+this.helperProportions.height,m=b.left,q=m+b.width,t=b.top,u=t+b.height,A=this.offset.click.top,F=this.offset.click.left;return F="y"===this.options.axis||c+F>m&&q>c+F,A=("x"===this.options.axis||j+A>t&&u>j+A)&&F,"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>b[this.floating?"width":"height"]?A:m<c+this.helperProportions.width/2&&d-this.helperProportions.width/2<q&&t<j+this.helperProportions.height/2&&i-this.helperProportions.height/2<u},_intersectsWithPointer:function(b){var c="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,b.top,b.height);b="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,b.left,b.width),c=c&&b,b=this._getDragVerticalDirection();var d=this._getDragHorizontalDirection();return c?this.floating?d&&"right"===d||"down"===b?2:1:b&&("down"===b?2:1):!1},_intersectsWithSides:function(b){var c=this._isOverAxis(this.positionAbs.top+this.offset.click.top,b.top+b.height/2,b.height);b=this._isOverAxis(this.positionAbs.left+this.offset.click.left,b.left+b.width/2,b.width);var d=this._getDragVerticalDirection(),j=this._getDragHorizontalDirection();return this.floating&&j?"right"===j&&b||"left"===j&&!b:d&&("down"===d&&c||"up"===d&&!c)},_getDragVerticalDirection:function(){var b=this.positionAbs.top-this.lastPositionAbs.top;return 0!==b&&(b>0?"down":"up")},_getDragHorizontalDirection:function(){var b=this.positionAbs.left-this.lastPositionAbs.left;return 0!==b&&(b>0?"right":"left")},refresh:function(b){return this._refreshItems(b),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var b=this.options;return b.connectWith.constructor===String?[b.connectWith]:b.connectWith},_getItemsAsjQuery:function(b){function c(){m.push(this)}var d,j,i,m=[],q=[],t=this._connectWith();if(t&&b)for(b=t.length-1;b>=0;b--)for(j=f(t[b],this.document[0]),d=j.length-1;d>=0;d--)(i=f.data(j[d],this.widgetFullName))&&i!==this&&!i.options.disabled&&q.push([f.isFunction(i.options.items)?i.options.items.call(i.element):f(i.options.items,i.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),i]);for(q.push([f.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):f(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),b=q.length-1;b>=0;b--)q[b][0].each(c);return f(m)},_removeCurrentsFromItems:function(){var b=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=f.grep(this.items,function(c){for(var d=0;d<b.length;d++)if(b[d]===c.item[0])return!1;return!0})},_refreshItems:function(b){this.items=[],this.containers=[this];var c,d,j,i,m,q=this.items,t=[[f.isFunction(this.options.items)?this.options.items.call(this.element[0],b,{item:this.currentItem}):f(this.options.items,this.element),this]];if((m=this._connectWith())&&this.ready)for(c=m.length-1;c>=0;c--)for(j=f(m[c],this.document[0]),d=j.length-1;d>=0;d--)(i=f.data(j[d],this.widgetFullName))&&i!==this&&!i.options.disabled&&(t.push([f.isFunction(i.options.items)?i.options.items.call(i.element[0],b,{item:this.currentItem}):f(i.options.items,i.element),i]),this.containers.push(i));for(c=t.length-1;c>=0;c--)for(b=t[c][1],j=t[c][0],d=0,m=j.length;m>d;d++)i=f(j[d]),i.data(this.widgetName+"-item",b),q.push({item:i,instance:b,width:0,height:0,left:0,top:0})},refreshPositions:function(b){this.floating=this.items.length?"x"===this.options.axis||this._isFloating(this.items[0].item):!1,this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var c,d,j;for(c=this.items.length-1;c>=0;c--)d=this.items[c],d.instance!==this.currentContainer&&this.currentContainer&&d.item[0]!==this.currentItem[0]||(j=this.options.toleranceElement?f(this.options.toleranceElement,d.item):d.item,b||(d.width=j.outerWidth(),d.height=j.outerHeight()),j=j.offset(),d.left=j.left,d.top=j.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(c=this.containers.length-1;c>=0;c--)j=this.containers[c].element.offset(),this.containers[c].containerCache.left=j.left,this.containers[c].containerCache.top=j.top,this.containers[c].containerCache.width=this.containers[c].element.outerWidth(),this.containers[c].containerCache.height=this.containers[c].element.outerHeight();return this},_createPlaceholder:function(b){b=b||this;var c,d=b.options;d.placeholder&&d.placeholder.constructor!==String||(c=d.placeholder,d.placeholder={element:function(){var j=b.currentItem[0].nodeName.toLowerCase(),i=f("<"+j+">",b.document[0]).addClass(c||b.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tbody"===j?b._createTrPlaceholder(b.currentItem.find("tr").eq(0),f("<tr>",b.document[0]).appendTo(i)):"tr"===j?b._createTrPlaceholder(b.currentItem,i):"img"===j&&i.attr("src",b.currentItem.attr("src")),c||i.css("visibility","hidden"),i},update:function(j,i){(!c||d.forcePlaceholderSize)&&(i.height()||i.height(b.currentItem.innerHeight()-parseInt(b.currentItem.css("paddingTop")||0,10)-parseInt(b.currentItem.css("paddingBottom")||0,10)),i.width()||i.width(b.currentItem.innerWidth()-parseInt(b.currentItem.css("paddingLeft")||0,10)-parseInt(b.currentItem.css("paddingRight")||0,10)))}}),b.placeholder=f(d.placeholder.element.call(b.element,b.currentItem)),b.currentItem.after(b.placeholder),d.placeholder.update(b,b.placeholder)},_createTrPlaceholder:function(b,c){var d=this;b.children().each(function(){f("<td>&#160;</td>",d.document[0]).attr("colspan",f(this).attr("colspan")||1).appendTo(c)})},_contactContainers:function(b){var c,d,j,i,m,q,t,u,A=i=null;for(c=this.containers.length-1;c>=0;c--)f.contains(this.currentItem[0],this.containers[c].element[0])||(this._intersectsWith(this.containers[c].containerCache)?i&&f.contains(this.containers[c].element[0],i.element[0])||(i=this.containers[c],A=c):this.containers[c].containerCache.over&&(this.containers[c]._trigger("out",b,this._uiHash(this)),this.containers[c].containerCache.over=0));if(i)if(1===this.containers.length)this.containers[A].containerCache.over||(this.containers[A]._trigger("over",b,this._uiHash(this)),this.containers[A].containerCache.over=1);else{for(c=1e4,j=null,i=(d=i.floating||this._isFloating(this.currentItem))?"left":"top",m=d?"width":"height",u=d?"clientX":"clientY",d=this.items.length-1;d>=0;d--)f.contains(this.containers[A].element[0],this.items[d].item[0])&&this.items[d].item[0]!==this.currentItem[0]&&(q=this.items[d].item.offset()[i],t=!1,b[u]-q>this.items[d][m]/2&&(t=!0),Math.abs(b[u]-q)<c&&(c=Math.abs(b[u]-q),j=this.items[d],this.direction=t?"up":"down"));(j||this.options.dropOnEmpty)&&(this.currentContainer===this.containers[A]?this.currentContainer.containerCache.over||(this.containers[A]._trigger("over",b,this._uiHash()),this.currentContainer.containerCache.over=1):(j?this._rearrange(b,j,null,!0):this._rearrange(b,null,this.containers[A].element,!0),this._trigger("change",b,this._uiHash()),this.containers[A]._trigger("change",b,this._uiHash(this)),this.currentContainer=this.containers[A],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[A]._trigger("over",b,this._uiHash(this)),this.containers[A].containerCache.over=1))}},_createHelper:function(b){var c=this.options;return b=f.isFunction(c.helper)?f(c.helper.apply(this.element[0],[b,this.currentItem])):"clone"===c.helper?this.currentItem.clone():this.currentItem,b.parents("body").length||f("parent"!==c.appendTo?c.appendTo:this.currentItem[0].parentNode)[0].appendChild(b[0]),b[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!b[0].style.width||c.forceHelperSize)&&b.width(this.currentItem.width()),(!b[0].style.height||c.forceHelperSize)&&b.height(this.currentItem.height()),b},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),f.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&f.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&f.ui.ie)&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var b=this.currentItem.position();return{top:b.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:b.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b,c,d;c=this.options,"parent"===c.containment&&(c.containment=this.helper[0].parentNode),("document"===c.containment||"window"===c.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===c.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===c.containment?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(c.containment)||(b=f(c.containment)[0],c=f(c.containment).offset(),d="hidden"!==f(b).css("overflow"),this.containment=[c.left+(parseInt(f(b).css("borderLeftWidth"),10)||0)+(parseInt(f(b).css("paddingLeft"),10)||0)-this.margins.left,c.top+(parseInt(f(b).css("borderTopWidth"),10)||0)+(parseInt(f(b).css("paddingTop"),10)||0)-this.margins.top,c.left+(d?Math.max(b.scrollWidth,b.offsetWidth):b.offsetWidth)-(parseInt(f(b).css("borderLeftWidth"),10)||0)-(parseInt(f(b).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,c.top+(d?Math.max(b.scrollHeight,b.offsetHeight):b.offsetHeight)-(parseInt(f(b).css("borderTopWidth"),10)||0)-(parseInt(f(b).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"===b?1:-1,j="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&f.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=/(html|body)/i.test(j[0].tagName);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():i?0:j.scrollTop())*d,left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():i?0:j.scrollLeft())*d}},_generatePosition:function(b){var c,d,j=this.options;d=b.pageX,c=b.pageY;var i="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&f.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,m=/(html|body)/i.test(i[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(b.pageX-this.offset.click.left<this.containment[0]&&(d=this.containment[0]+this.offset.click.left),b.pageY-this.offset.click.top<this.containment[1]&&(c=this.containment[1]+this.offset.click.top),b.pageX-this.offset.click.left>this.containment[2]&&(d=this.containment[2]+this.offset.click.left),b.pageY-this.offset.click.top>this.containment[3]&&(c=this.containment[3]+this.offset.click.top)),j.grid&&(c=this.originalPageY+Math.round((c-this.originalPageY)/j.grid[1])*j.grid[1],c=this.containment?c-this.offset.click.top>=this.containment[1]&&c-this.offset.click.top<=this.containment[3]?c:c-this.offset.click.top>=this.containment[1]?c-j.grid[1]:c+j.grid[1]:c,d=this.originalPageX+Math.round((d-this.originalPageX)/j.grid[0])*j.grid[0],d=this.containment?d-this.offset.click.left>=this.containment[0]&&d-this.offset.click.left<=this.containment[2]?d:d-this.offset.click.left>=this.containment[0]?d-j.grid[0]:d+j.grid[0]:d)),{top:c-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():m?0:i.scrollTop()),left:d-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():m?0:i.scrollLeft())
}},_rearrange:function(b,c,d,j){d?d[0].appendChild(this.placeholder[0]):c.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?c.item[0]:c.item[0].nextSibling);var i=this.counter=this.counter?++this.counter:1;this._delay(function(){i===this.counter&&this.refreshPositions(!j)})},_clear:function(b,c){function d(m,q,t){return function(u){t._trigger(m,u,q._uiHash(q))}}this.reverting=!1;var j,i=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(j in this._storedCSS)("auto"===this._storedCSS[j]||"static"===this._storedCSS[j])&&(this._storedCSS[j]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!c&&i.push(function(m){this._trigger("receive",m,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||c||i.push(function(m){this._trigger("update",m,this._uiHash())}),this!==this.currentContainer&&(c||(i.push(function(m){this._trigger("remove",m,this._uiHash())}),i.push(function(m){return function(q){m._trigger("receive",q,this._uiHash(this))}}.call(this,this.currentContainer)),i.push(function(m){return function(q){m._trigger("update",q,this._uiHash(this))}}.call(this,this.currentContainer)))),j=this.containers.length-1;j>=0;j--)c||i.push(d("deactivate",this,this.containers[j])),this.containers[j].containerCache.over&&(i.push(d("out",this,this.containers[j])),this.containers[j].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,c||this._trigger("beforeStop",b,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!c){for(j=0;j<i.length;j++)i[j].call(this,b);this._trigger("stop",b,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){f.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(b){var c=b||this;return{helper:c.helper,placeholder:c.placeholder||f([]),position:c.position,originalPosition:c.originalPosition,offset:c.positionAbs,item:c.currentItem,sender:b?b.element:null}}}),f.widget("ui.accordion",{version:"1.11.4",options:{active:0,animate:{},collapsible:!1,event:"click",header:"> li > :first-child,> :not(li):even",heightStyle:"auto",icons:{activeHeader:"ui-icon-triangle-1-s",header:"ui-icon-triangle-1-e"},activate:null,beforeActivate:null},hideProps:{borderTopWidth:"hide",borderBottomWidth:"hide",paddingTop:"hide",paddingBottom:"hide",height:"hide"},showProps:{borderTopWidth:"show",borderBottomWidth:"show",paddingTop:"show",paddingBottom:"show",height:"show"},_create:function(){var b=this.options;this.prevShow=this.prevHide=f(),this.element.addClass("ui-accordion ui-widget ui-helper-reset").attr("role","tablist"),b.collapsible||b.active!==!1&&null!=b.active||(b.active=0),this._processPanels(),b.active<0&&(b.active+=this.headers.length),this._refresh()},_getCreateEventData:function(){return{header:this.active,panel:this.active.length?this.active.next():f()}},_createIcons:function(){var b=this.options.icons;b&&(f("<span>").addClass("ui-accordion-header-icon ui-icon "+b.header).prependTo(this.headers),this.active.children(".ui-accordion-header-icon").removeClass(b.header).addClass(b.activeHeader),this.headers.addClass("ui-accordion-icons"))},_destroyIcons:function(){this.headers.removeClass("ui-accordion-icons").children(".ui-accordion-header-icon").remove()},_destroy:function(){var b;this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role"),this.headers.removeClass("ui-accordion-header ui-accordion-header-active ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("aria-controls").removeAttr("tabIndex").removeUniqueId(),this._destroyIcons(),b=this.headers.next().removeClass("ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-state-disabled").css("display","").removeAttr("role").removeAttr("aria-hidden").removeAttr("aria-labelledby").removeUniqueId(),"content"!==this.options.heightStyle&&b.css("height","")},_setOption:function(b,c){"active"===b?this._activate(c):("event"===b&&(this.options.event&&this._off(this.headers,this.options.event),this._setupEvents(c)),this._super(b,c),"collapsible"===b&&!c&&this.options.active===!1&&this._activate(0),"icons"===b&&(this._destroyIcons(),c&&this._createIcons()),"disabled"===b&&(this.element.toggleClass("ui-state-disabled",!!c).attr("aria-disabled",c),this.headers.add(this.headers.next()).toggleClass("ui-state-disabled",!!c)))},_keydown:function(b){if(!b.altKey&&!b.ctrlKey){var c=f.ui.keyCode,d=this.headers.length,j=this.headers.index(b.target),i=!1;switch(b.keyCode){case c.RIGHT:case c.DOWN:i=this.headers[(j+1)%d];break;case c.LEFT:case c.UP:i=this.headers[(j-1+d)%d];break;case c.SPACE:case c.ENTER:this._eventHandler(b);break;case c.HOME:i=this.headers[0];break;case c.END:i=this.headers[d-1]}i&&(f(b.target).attr("tabIndex",-1),f(i).attr("tabIndex",0),i.focus(),b.preventDefault())}},_panelKeyDown:function(b){b.keyCode===f.ui.keyCode.UP&&b.ctrlKey&&f(b.currentTarget).prev().focus()},refresh:function(){var b=this.options;this._processPanels(),b.active===!1&&b.collapsible===!0||!this.headers.length?(b.active=!1,this.active=f()):b.active===!1?this._activate(0):this.active.length&&!f.contains(this.element[0],this.active[0])?this.headers.length===this.headers.find(".ui-state-disabled").length?(b.active=!1,this.active=f()):this._activate(Math.max(0,b.active-1)):b.active=this.headers.index(this.active),this._destroyIcons(),this._refresh()},_processPanels:function(){var b=this.headers,c=this.panels;this.headers=this.element.find(this.options.header).addClass("ui-accordion-header ui-state-default ui-corner-all"),this.panels=this.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom").filter(":not(.ui-accordion-content-active)").hide(),c&&(this._off(b.not(this.headers)),this._off(c.not(this.panels)))},_refresh:function(){var b,c=this.options,d=c.heightStyle,j=this.element.parent();this.active=this._findActive(c.active).addClass("ui-accordion-header-active ui-state-active ui-corner-top").removeClass("ui-corner-all"),this.active.next().addClass("ui-accordion-content-active").show(),this.headers.attr("role","tab").each(function(){var i=f(this),m=i.uniqueId().attr("id"),q=i.next(),t=q.uniqueId().attr("id");i.attr("aria-controls",t),q.attr("aria-labelledby",m)}).next().attr("role","tabpanel"),this.headers.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}).next().attr({"aria-hidden":"true"}).hide(),this.active.length?this.active.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}).next().attr({"aria-hidden":"false"}):this.headers.eq(0).attr("tabIndex",0),this._createIcons(),this._setupEvents(c.event),"fill"===d?(b=j.height(),this.element.siblings(":visible").each(function(){var i=f(this),m=i.css("position");"absolute"===m||"fixed"===m||(b-=i.outerHeight(!0))}),this.headers.each(function(){b-=f(this).outerHeight(!0)}),this.headers.next().each(function(){f(this).height(Math.max(0,b-f(this).innerHeight()+f(this).height()))}).css("overflow","auto")):"auto"===d&&(b=0,this.headers.next().each(function(){b=Math.max(b,f(this).css("height","").height())}).height(b))},_activate:function(b){b=this._findActive(b)[0],b!==this.active[0]&&(b=b||this.active[0],this._eventHandler({target:b,currentTarget:b,preventDefault:f.noop}))},_findActive:function(b){return"number"==typeof b?this.headers.eq(b):f()},_setupEvents:function(b){var c={keydown:"_keydown"};b&&f.each(b.split(" "),function(d,j){c[j]="_eventHandler"}),this._off(this.headers.add(this.headers.next())),this._on(this.headers,c),this._on(this.headers.next(),{keydown:"_panelKeyDown"}),this._hoverable(this.headers),this._focusable(this.headers)},_eventHandler:function(b){var c=this.options,d=this.active,j=f(b.currentTarget),i=j[0]===d[0],m=i&&c.collapsible,q=m?f():j.next(),t=d.next();q={oldHeader:d,oldPanel:t,newHeader:m?f():j,newPanel:q},b.preventDefault(),i&&!c.collapsible||this._trigger("beforeActivate",b,q)===!1||(c.active=m?!1:this.headers.index(j),this.active=i?f():j,this._toggle(q),d.removeClass("ui-accordion-header-active ui-state-active"),c.icons&&d.children(".ui-accordion-header-icon").removeClass(c.icons.activeHeader).addClass(c.icons.header),i||(j.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top"),c.icons&&j.children(".ui-accordion-header-icon").removeClass(c.icons.header).addClass(c.icons.activeHeader),j.next().addClass("ui-accordion-content-active")))},_toggle:function(b){var c=b.newPanel,d=this.prevShow.length?this.prevShow:b.oldPanel;this.prevShow.add(this.prevHide).stop(!0,!0),this.prevShow=c,this.prevHide=d,this.options.animate?this._animate(c,d,b):(d.hide(),c.show(),this._toggleComplete(b)),d.attr({"aria-hidden":"true"}),d.prev().attr({"aria-selected":"false","aria-expanded":"false"}),c.length&&d.length?d.prev().attr({tabIndex:-1,"aria-expanded":"false"}):c.length&&this.headers.filter(function(){return 0===parseInt(f(this).attr("tabIndex"),10)}).attr("tabIndex",-1),c.attr("aria-hidden","false").prev().attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_animate:function(b,c,d){var j,i,m,q=this,t=0,u=b.css("box-sizing"),A=this.options.animate||{},F=b.length&&(!c.length||b.index()<c.index())&&A.down||A,B=function(){q._toggleComplete(d)};return"number"==typeof F&&(m=F),"string"==typeof F&&(i=F),i=i||F.easing||A.easing,m=m||F.duration||A.duration,c.length?b.length?(j=b.show().outerHeight(),c.animate(this.hideProps,{duration:m,easing:i,step:function(K,H){H.now=Math.round(K)}}),void b.hide().animate(this.showProps,{duration:m,easing:i,complete:B,step:function(K,H){H.now=Math.round(K),"height"!==H.prop?"content-box"===u&&(t+=H.now):"content"!==q.options.heightStyle&&(H.now=Math.round(j-c.outerHeight()-t),t=0)}})):c.animate(this.hideProps,m,i,B):b.animate(this.showProps,m,i,B)},_toggleComplete:function(b){var c=b.oldPanel;c.removeClass("ui-accordion-content-active").prev().removeClass("ui-corner-top").addClass("ui-corner-all"),c.length&&(c.parent()[0].className=c.parent()[0].className),this._trigger("activate",null,b)}});var ma,ia=function(){var b=f(this);setTimeout(function(){b.find(":ui-button").button("refresh")},1)},J=function(b){var c=b.name,d=b.form,j=f([]);return c&&(c=c.replace(/'/g,"\\'"),j=d?f(d).find("[name='"+c+"'][type=radio]"):f("[name='"+c+"'][type=radio]",b.ownerDocument).filter(function(){return!this.form})),j};f.widget("ui.button",{version:"1.11.4",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,ia),"boolean"!=typeof this.options.disabled?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var b=this,c=this.options,d="checkbox"===this.type||"radio"===this.type,j=d?"":"ui-state-active";null===c.label&&(c.label="input"===this.type?this.buttonElement.val():this.buttonElement.html()),this._hoverable(this.buttonElement),this.buttonElement.addClass("ui-button ui-widget ui-state-default ui-corner-all").attr("role","button").bind("mouseenter"+this.eventNamespace,function(){c.disabled||this===ma&&f(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){c.disabled||f(this).removeClass(j)}).bind("click"+this.eventNamespace,function(i){c.disabled&&(i.preventDefault(),i.stopImmediatePropagation())}),this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}}),d&&this.element.bind("change"+this.eventNamespace,function(){b.refresh()}),"checkbox"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){return c.disabled?!1:void 0}):"radio"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(c.disabled)return!1;f(this).addClass("ui-state-active"),b.buttonElement.attr("aria-pressed","true");var i=b.element[0];J(i).not(i).map(function(){return f(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown"+this.eventNamespace,function(){return c.disabled?!1:(f(this).addClass("ui-state-active"),ma=this,void b.document.one("mouseup",function(){ma=null}))}).bind("mouseup"+this.eventNamespace,function(){return c.disabled?!1:void f(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(i){return c.disabled?!1:void((i.keyCode===f.ui.keyCode.SPACE||i.keyCode===f.ui.keyCode.ENTER)&&f(this).addClass("ui-state-active"))}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){f(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(i){i.keyCode===f.ui.keyCode.SPACE&&f(this).click()})),this._setOption("disabled",c.disabled),this._resetButton()},_determineButtonType:function(){var b,c;this.type=this.element.is("[type=checkbox]")?"checkbox":this.element.is("[type=radio]")?"radio":this.element.is("input")?"input":"button","checkbox"===this.type||"radio"===this.type?(b=this.element.parents().last(),c="label[for='"+this.element.attr("id")+"']",this.buttonElement=b.find(c),this.buttonElement.length||(b=b.length?b.siblings():this.element.siblings(),this.buttonElement=b.filter(c),this.buttonElement.length||(this.buttonElement=b.find(c))),this.element.addClass("ui-helper-hidden-accessible"),(b=this.element.is(":checked"))&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.prop("aria-pressed",b)):this.buttonElement=this.element},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-state-active ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only").removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title")},_setOption:function(b,c){this._super(b,c),"disabled"===b?(this.widget().toggleClass("ui-state-disabled",!!c),this.element.prop("disabled",!!c),c&&("checkbox"===this.type||"radio"===this.type?this.buttonElement.removeClass("ui-state-focus"):this.buttonElement.removeClass("ui-state-focus ui-state-active"))):this._resetButton()},refresh:function(){var b=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");b!==this.options.disabled&&this._setOption("disabled",b),"radio"===this.type?J(this.element[0]).each(function(){f(this).is(":checked")?f(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):f(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):"checkbox"===this.type&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if("input"===this.type)this.options.label&&this.element.val(this.options.label);else{var b=this.buttonElement.removeClass("ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only"),c=f("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(b.empty()).text(),d=this.options.icons,j=d.primary&&d.secondary,i=[];d.primary||d.secondary?(this.options.text&&i.push("ui-button-text-icon"+(j?"s":d.primary?"-primary":"-secondary")),d.primary&&b.prepend("<span class='ui-button-icon-primary ui-icon "+d.primary+"'></span>"),d.secondary&&b.append("<span class='ui-button-icon-secondary ui-icon "+d.secondary+"'></span>"),this.options.text||(i.push(j?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||b.attr("title",f.trim(c)))):i.push("ui-button-text-only"),b.addClass(i.join(" "))}}}),f.widget("ui.buttonset",{version:"1.11.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(b,c){"disabled"===b&&this.buttons.button("option",b,c),this._super(b,c)},refresh:function(){var b="rtl"===this.element.css("direction"),c=this.element.find(this.options.items),d=c.filter(":ui-button");c.not(":ui-button").button(),d.button("refresh"),this.buttons=c.map(function(){return f(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(b?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(b?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return f(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}}),f.widget("ui.dialog",{version:"1.11.4",options:{appendTo:"body",autoOpen:!0,buttons:[],closeOnEscape:!0,closeText:"Close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:null,maxWidth:null,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",of:window,collision:"fit",using:function(b){var c=f(this).css(b).offset().top;0>c&&f(this).css("top",b.top-c)}},resizable:!0,show:null,title:null,width:300,beforeClose:null,close:null,drag:null,dragStart:null,dragStop:null,focus:null,open:null,resize:null,resizeStart:null,resizeStop:null},sizeRelatedOptions:{buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},resizableRelatedOptions:{maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},_create:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height},this.originalPosition={parent:this.element.parent(),index:this.element.parent().children().index(this.element)},this.originalTitle=this.element.attr("title"),this.options.title=this.options.title||this.originalTitle,this._createWrapper(),this.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(this.uiDialog),this._createTitlebar(),this._createButtonPane(),this.options.draggable&&f.fn.draggable&&this._makeDraggable(),this.options.resizable&&f.fn.resizable&&this._makeResizable(),this._isOpen=!1,this._trackFocus()},_init:function(){this.options.autoOpen&&this.open()},_appendTo:function(){var b=this.options.appendTo;return b&&(b.jquery||b.nodeType)?f(b):this.document.find(b||"body").eq(0)},_destroy:function(){var b,c=this.originalPosition;this._untrackInstance(),this._destroyOverlay(),this.element.removeUniqueId().removeClass("ui-dialog-content ui-widget-content").css(this.originalCss).detach(),this.uiDialog.stop(!0,!0).remove(),this.originalTitle&&this.element.attr("title",this.originalTitle),b=c.parent.children().eq(c.index),b.length&&b[0]!==this.element[0]?b.before(this.element):c.parent.append(this.element)},widget:function(){return this.uiDialog},disable:f.noop,enable:f.noop,close:function(b){var c,d=this;if(this._isOpen&&this._trigger("beforeClose",b)!==!1){if(this._isOpen=!1,this._focusedElement=null,this._destroyOverlay(),this._untrackInstance(),!this.opener.filter(":focusable").focus().length)try{(c=this.document[0].activeElement)&&"body"!==c.nodeName.toLowerCase()&&f(c).blur()}catch(j){}this._hide(this.uiDialog,this.options.hide,function(){d._trigger("close",b)})}},isOpen:function(){return this._isOpen},moveToTop:function(){this._moveToTop()},_moveToTop:function(b,c){var d=!1,j=this.uiDialog.siblings(".ui-front:visible").map(function(){return+f(this).css("z-index")}).get();return j=Math.max.apply(null,j),j>=+this.uiDialog.css("z-index")&&(this.uiDialog.css("z-index",j+1),d=!0),d&&!c&&this._trigger("focus",b),d},open:function(){var b=this;this._isOpen?this._moveToTop()&&this._focusTabbable():(this._isOpen=!0,this.opener=f(this.document[0].activeElement),this._size(),this._position(),this._createOverlay(),this._moveToTop(null,!0),this.overlay&&this.overlay.css("z-index",this.uiDialog.css("z-index")-1),this._show(this.uiDialog,this.options.show,function(){b._focusTabbable(),b._trigger("focus")}),this._makeFocusTarget(),this._trigger("open"))},_focusTabbable:function(){var b=this._focusedElement;b||(b=this.element.find("[autofocus]")),b.length||(b=this.element.find(":tabbable")),b.length||(b=this.uiDialogButtonPane.find(":tabbable")),b.length||(b=this.uiDialogTitlebarClose.filter(":tabbable")),b.length||(b=this.uiDialog),b.eq(0).focus()},_keepFocus:function(b){function c(){var d=this.document[0].activeElement;this.uiDialog[0]===d||f.contains(this.uiDialog[0],d)||this._focusTabbable()}b.preventDefault(),c.call(this),this._delay(c)},_createWrapper:function(){this.uiDialog=f("<div>").addClass("ui-dialog ui-widget ui-widget-content ui-corner-all ui-front "+this.options.dialogClass).hide().attr({tabIndex:-1,role:"dialog"}).appendTo(this._appendTo()),this._on(this.uiDialog,{keydown:function(b){if(this.options.closeOnEscape&&!b.isDefaultPrevented()&&b.keyCode&&b.keyCode===f.ui.keyCode.ESCAPE)b.preventDefault(),this.close(b);else if(b.keyCode===f.ui.keyCode.TAB&&!b.isDefaultPrevented()){var c=this.uiDialog.find(":tabbable"),d=c.filter(":first"),j=c.filter(":last");b.target!==j[0]&&b.target!==this.uiDialog[0]||b.shiftKey?b.target!==d[0]&&b.target!==this.uiDialog[0]||!b.shiftKey||(this._delay(function(){j.focus()}),b.preventDefault()):(this._delay(function(){d.focus()}),b.preventDefault())}},mousedown:function(b){this._moveToTop(b)&&this._focusTabbable()}}),this.element.find("[aria-describedby]").length||this.uiDialog.attr({"aria-describedby":this.element.uniqueId().attr("id")})},_createTitlebar:function(){var b;this.uiDialogTitlebar=f("<div>").addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(this.uiDialog),this._on(this.uiDialogTitlebar,{mousedown:function(c){f(c.target).closest(".ui-dialog-titlebar-close")||this.uiDialog.focus()}}),this.uiDialogTitlebarClose=f("<button type='button'></button>").button({label:this.options.closeText,icons:{primary:"ui-icon-closethick"},text:!1}).addClass("ui-dialog-titlebar-close").appendTo(this.uiDialogTitlebar),this._on(this.uiDialogTitlebarClose,{click:function(c){c.preventDefault(),this.close(c)}}),b=f("<span>").uniqueId().addClass("ui-dialog-title").prependTo(this.uiDialogTitlebar),this._title(b),this.uiDialog.attr({"aria-labelledby":b.attr("id")})},_title:function(b){this.options.title||b.html("&#160;"),b.text(this.options.title)},_createButtonPane:function(){this.uiDialogButtonPane=f("<div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),this.uiButtonSet=f("<div>").addClass("ui-dialog-buttonset").appendTo(this.uiDialogButtonPane),this._createButtons()},_createButtons:function(){var b=this,c=this.options.buttons;this.uiDialogButtonPane.remove(),this.uiButtonSet.empty(),f.isEmptyObject(c)||f.isArray(c)&&!c.length?this.uiDialog.removeClass("ui-dialog-buttons"):(f.each(c,function(d,j){var i,m;j=f.isFunction(j)?{click:j,text:d}:j,j=f.extend({type:"button"},j),i=j.click,j.click=function(){i.apply(b.element[0],arguments)},m={icons:j.icons,text:j.showText},delete j.icons,delete j.showText,f("<button></button>",j).button(m).appendTo(b.uiButtonSet)}),this.uiDialog.addClass("ui-dialog-buttons"),this.uiDialogButtonPane.appendTo(this.uiDialog))},_makeDraggable:function(){function b(j){return{position:j.position,offset:j.offset}}var c=this,d=this.options;this.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(j,i){f(this).addClass("ui-dialog-dragging"),c._blockFrames(),c._trigger("dragStart",j,b(i))},drag:function(j,i){c._trigger("drag",j,b(i))},stop:function(j,i){var m=i.offset.left-c.document.scrollLeft(),q=i.offset.top-c.document.scrollTop();d.position={my:"left top",at:"left"+(m>=0?"+":"")+m+" top"+(q>=0?"+":"")+q,of:c.window},f(this).removeClass("ui-dialog-dragging"),c._unblockFrames(),c._trigger("dragStop",j,b(i))}})},_makeResizable:function(){function b(m){return{originalPosition:m.originalPosition,originalSize:m.originalSize,position:m.position,size:m.size}}var c=this,d=this.options,j=d.resizable,i=this.uiDialog.css("position");j="string"==typeof j?j:"n,e,s,w,se,sw,ne,nw",this.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:this.element,maxWidth:d.maxWidth,maxHeight:d.maxHeight,minWidth:d.minWidth,minHeight:this._minHeight(),handles:j,start:function(m,q){f(this).addClass("ui-dialog-resizing"),c._blockFrames(),c._trigger("resizeStart",m,b(q))},resize:function(m,q){c._trigger("resize",m,b(q))},stop:function(m,q){var t=c.uiDialog.offset(),u=t.left-c.document.scrollLeft();t=t.top-c.document.scrollTop(),d.height=c.uiDialog.height(),d.width=c.uiDialog.width(),d.position={my:"left top",at:"left"+(u>=0?"+":"")+u+" top"+(t>=0?"+":"")+t,of:c.window},f(this).removeClass("ui-dialog-resizing"),c._unblockFrames(),c._trigger("resizeStop",m,b(q))}}).css("position",i)},_trackFocus:function(){this._on(this.widget(),{focusin:function(b){this._makeFocusTarget(),this._focusedElement=f(b.target)}})},_makeFocusTarget:function(){this._untrackInstance(),this._trackingInstances().unshift(this)},_untrackInstance:function(){var b=this._trackingInstances(),c=f.inArray(this,b);-1!==c&&b.splice(c,1)},_trackingInstances:function(){var b=this.document.data("ui-dialog-instances");return b||(b=[],this.document.data("ui-dialog-instances",b)),b},_minHeight:function(){var b=this.options;return"auto"===b.height?b.minHeight:Math.min(b.minHeight,b.height)},_position:function(){var b=this.uiDialog.is(":visible");b||this.uiDialog.show(),this.uiDialog.position(this.options.position),b||this.uiDialog.hide()},_setOptions:function(b){var c=this,d=!1,j={};f.each(b,function(i,m){c._setOption(i,m),i in c.sizeRelatedOptions&&(d=!0),i in c.resizableRelatedOptions&&(j[i]=m)}),d&&(this._size(),this._position()),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option",j)},_setOption:function(b,c){var d,j=this.uiDialog;"dialogClass"===b&&j.removeClass(this.options.dialogClass).addClass(c),"disabled"!==b&&(this._super(b,c),"appendTo"===b&&this.uiDialog.appendTo(this._appendTo()),"buttons"===b&&this._createButtons(),"closeText"===b&&this.uiDialogTitlebarClose.button({label:""+c}),"draggable"===b&&((d=j.is(":data(ui-draggable)"))&&!c&&j.draggable("destroy"),!d&&c&&this._makeDraggable()),"position"===b&&this._position(),"resizable"===b&&((d=j.is(":data(ui-resizable)"))&&!c&&j.resizable("destroy"),d&&"string"==typeof c&&j.resizable("option","handles",c),!d&&c!==!1&&this._makeResizable()),"title"===b&&this._title(this.uiDialogTitlebar.find(".ui-dialog-title")))},_size:function(){var b,c,d,j=this.options;this.element.show().css({width:"auto",minHeight:0,maxHeight:"none",height:0}),j.minWidth>j.width&&(j.width=j.minWidth),b=this.uiDialog.css({height:"auto",width:j.width}).outerHeight(),c=Math.max(0,j.minHeight-b),d="number"==typeof j.maxHeight?Math.max(0,j.maxHeight-b):"none","auto"===j.height?this.element.css({minHeight:c,maxHeight:d,height:"auto"}):this.element.height(Math.max(0,j.height-b)),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())},_blockFrames:function(){this.iframeBlocks=this.document.find("iframe").map(function(){var b=f(this);return f("<div>").css({position:"absolute",width:b.outerWidth(),height:b.outerHeight()}).appendTo(b.parent()).offset(b.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_allowInteraction:function(b){return f(b.target).closest(".ui-dialog").length?!0:!!f(b.target).closest(".ui-datepicker").length},_createOverlay:function(){if(this.options.modal){var b=!0;this._delay(function(){b=!1}),this.document.data("ui-dialog-overlays")||this._on(this.document,{focusin:function(c){b||this._allowInteraction(c)||(c.preventDefault(),this._trackingInstances()[0]._focusTabbable())}}),this.overlay=f("<div>").addClass("ui-widget-overlay ui-front").appendTo(this._appendTo()),this._on(this.overlay,{mousedown:"_keepFocus"}),this.document.data("ui-dialog-overlays",(this.document.data("ui-dialog-overlays")||0)+1)}},_destroyOverlay:function(){if(this.options.modal&&this.overlay){var b=this.document.data("ui-dialog-overlays")-1;b?this.document.data("ui-dialog-overlays",b):this.document.unbind("focusin").removeData("ui-dialog-overlays"),this.overlay.remove(),this.overlay=null}}});var ga=f;f.effects={effect:{}},function(b,c){function d(r,w,y){var z=A[w.type]||{};return null==r?y||!w.def?null:w.def:(r=z.floor?~~r:parseFloat(r),isNaN(r)?w.def:z.mod?(r+z.mod)%z.mod:0>r?0:z.max<r?z.max:r)}function j(r){var w=t(),y=w._rgba=[];return r=r.toLowerCase(),H(q,function(z,N){var V,P=N.re.exec(r);return V=P&&N.parse(P),P=N.space||"rgba",V?(V=w[P](V),w[u[P].cache]=V[u[P].cache],y=w._rgba=V._rgba,!1):void 0}),y.length?("0,0,0,0"===y.join()&&b.extend(y,K.transparent),w):K[r]}function i(r,w,y){return y=(y+1)%1,1>6*y?r+(w-r)*y*6:1>2*y?w:2>3*y?r+(w-r)*(2/3-y)*6:r}var K,m=/^([\-+])=\s*(\d+\.?\d*)/,q=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(r){return[r[1],r[2],r[3],r[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(r){return[2.55*r[1],2.55*r[2],2.55*r[3],r[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(r){return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(r){return[parseInt(r[1]+r[1],16),parseInt(r[2]+r[2],16),parseInt(r[3]+r[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(r){return[r[1],r[2]/100,r[3]/100,r[4]]}}],t=b.Color=function(r,w,y,z){return new b.Color.fn.parse(r,w,y,z)},u={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},A={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},F=t.support={},B=b("<p>")[0],H=b.each;B.style.cssText="background-color:rgba(1,1,1,.5)",F.rgba=B.style.backgroundColor.indexOf("rgba")>-1,H(u,function(r,w){w.cache="_"+r,w.props.alpha={idx:3,type:"percent",def:1}}),t.fn=b.extend(t.prototype,{parse:function(r,w,y,z){if(r===c)return this._rgba=[null,null,null,null],this;(r.jquery||r.nodeType)&&(r=b(r).css(w),w=c);var N=this,V=b.type(r),P=this._rgba=[];return w!==c&&(r=[r,w,y,z],V="array"),"string"===V?this.parse(j(r)||K._default):"array"===V?(H(u.rgba.props,function(ea,ca){P[ca.idx]=d(r[ca.idx],ca)}),this):"object"===V?(r instanceof t?H(u,function(ea,ca){r[ca.cache]&&(N[ca.cache]=r[ca.cache].slice())}):H(u,function(ea,ca){var ha=ca.cache;H(ca.props,function(oa,ua){if(!N[ha]&&ca.to){if("alpha"===oa||null==r[oa])return;
N[ha]=ca.to(N._rgba)}N[ha][ua.idx]=d(r[oa],ua,!0)}),N[ha]&&b.inArray(null,N[ha].slice(0,3))<0&&(N[ha][3]=1,ca.from&&(N._rgba=ca.from(N[ha])))}),this):void 0},is:function(r){var w=t(r),y=!0,z=this;return H(u,function(N,V){var P,ea=w[V.cache];return ea&&(P=z[V.cache]||V.to&&V.to(z._rgba)||[],H(V.props,function(ca,ha){return null!=ea[ha.idx]?y=ea[ha.idx]===P[ha.idx]:void 0})),y}),y},_space:function(){var r=[],w=this;return H(u,function(y,z){w[z.cache]&&r.push(y)}),r.pop()},transition:function(r,w){var y=t(r),z=y._space(),N=u[z],V=0===this.alpha()?t("transparent"):this,P=V[N.cache]||N.to(V._rgba),ea=P.slice();return y=y[N.cache],H(N.props,function(ca,ha){var oa=ha.idx,ua=P[oa],ja=y[oa],Ea=A[ha.type]||{};null!==ja&&(null===ua?ea[oa]=ja:(Ea.mod&&(ja-ua>Ea.mod/2?ua+=Ea.mod:ua-ja>Ea.mod/2&&(ua-=Ea.mod)),ea[oa]=d((ja-ua)*w+ua,ha)))}),this[z](ea)},blend:function(r){if(1===this._rgba[3])return this;var w=this._rgba.slice(),y=w.pop(),z=t(r)._rgba;return t(b.map(w,function(N,V){return(1-y)*z[V]+y*N}))},toRgbaString:function(){var r="rgba(",w=b.map(this._rgba,function(y,z){return null==y?z>2?1:0:y});return 1===w[3]&&(w.pop(),r="rgb("),r+w.join()+")"},toHslaString:function(){var r="hsla(",w=b.map(this.hsla(),function(y,z){return null==y&&(y=z>2?1:0),z&&3>z&&(y=Math.round(100*y)+"%"),y});return 1===w[3]&&(w.pop(),r="hsl("),r+w.join()+")"},toHexString:function(r){var w=this._rgba.slice(),y=w.pop();return r&&w.push(~~(255*y)),"#"+b.map(w,function(z){return z=(z||0).toString(16),1===z.length?"0"+z:z}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),t.fn.parse.prototype=t.fn,u.hsla.to=function(r){if(null==r[0]||null==r[1]||null==r[2])return[null,null,null,r[3]];var w=r[0]/255,y=r[1]/255,z=r[2]/255;r=r[3];var N=Math.max(w,y,z),V=Math.min(w,y,z),P=N-V,ea=N+V,ca=.5*ea;return[Math.round(V===N?0:w===N?60*(y-z)/P+360:y===N?60*(z-w)/P+120:60*(w-y)/P+240)%360,0===P?0:.5>=ca?P/ea:P/(2-ea),ca,null==r?1:r]},u.hsla.from=function(r){if(null==r[0]||null==r[1]||null==r[2])return[null,null,null,r[3]];var w=r[0]/360,y=r[1],z=r[2];return r=r[3],y=.5>=z?z*(1+y):z+y-z*y,z=2*z-y,[Math.round(255*i(z,y,w+1/3)),Math.round(255*i(z,y,w)),Math.round(255*i(z,y,w-1/3)),r]},H(u,function(r,w){var y=w.props,z=w.cache,N=w.to,V=w.from;t.fn[r]=function(P){if(N&&!this[z]&&(this[z]=N(this._rgba)),P===c)return this[z].slice();var ea,ca=b.type(P),ha="array"===ca||"object"===ca?P:arguments,oa=this[z].slice();return H(y,function(ua,ja){var Ea=ha["object"===ca?ua:ja.idx];null==Ea&&(Ea=oa[ja.idx]),oa[ja.idx]=d(Ea,ja)}),V?(ea=t(V(oa)),ea[z]=oa,ea):t(oa)},H(y,function(P,ea){t.fn[P]||(t.fn[P]=function(ca){var ha=b.type(ca),oa="alpha"===P?this._hsla?"hsla":"rgba":r,ua=this[oa](),ja=ua[ea.idx];return"undefined"===ha?ja:("function"===ha&&(ca=ca.call(this,ja),ha=b.type(ca)),null==ca&&ea.empty?this:("string"===ha&&(ha=m.exec(ca))&&(ca=ja+parseFloat(ha[2])*("+"===ha[1]?1:-1)),ua[ea.idx]=ca,this[oa](ua)))})})}),t.hook=function(r){r=r.split(" "),H(r,function(w,y){b.cssHooks[y]={set:function(z,N){var V,P="";if("transparent"!==N&&("string"!==b.type(N)||(V=j(N)))){if(N=t(V||N),!F.rgba&&1!==N._rgba[3]){for(V="backgroundColor"===y?z.parentNode:z;(""===P||"transparent"===P)&&V&&V.style;)try{P=b.css(V,"backgroundColor"),V=V.parentNode}catch(ea){}N=N.blend(P&&"transparent"!==P?P:"_default")}N=N.toRgbaString()}try{z.style[y]=N}catch(ca){}}},b.fx.step[y]=function(z){z.colorInit||(z.start=t(z.elem,y),z.end=t(z.end),z.colorInit=!0),b.cssHooks[y].set(z.elem,z.start.transition(z.end,z.pos))}})},t.hook("backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor"),b.cssHooks.borderColor={expand:function(r){var w={};return H(["Top","Right","Bottom","Left"],function(y,z){w["border"+z+"Color"]=r}),w}},K=b.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(ga),function(){function b(j){var i,m=j.ownerDocument.defaultView?j.ownerDocument.defaultView.getComputedStyle(j,null):j.currentStyle,q={};if(m&&m.length&&m[0]&&m[m[0]])for(j=m.length;j--;)i=m[j],"string"==typeof m[i]&&(q[f.camelCase(i)]=m[i]);else for(i in m)"string"==typeof m[i]&&(q[i]=m[i]);return q}var c=["add","remove","toggle"],d={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};f.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(j,i){f.fx.step[i]=function(m){("none"!==m.end&&!m.setAttr||1===m.pos&&!m.setAttr)&&(ga.style(m.elem,i,m.end),m.setAttr=!0)}}),f.fn.addBack||(f.fn.addBack=function(j){return this.add(null==j?this.prevObject:this.prevObject.filter(j))}),f.effects.animateClass=function(j,i,m,q){var t=f.speed(i,m,q);return this.queue(function(){var F,u=f(this),A=u.attr("class")||"",B=t.children?u.find("*").addBack():u;B=B.map(function(){return{el:f(this),start:b(this)}}),F=function(){f.each(c,function(K,H){j[H]&&u[H+"Class"](j[H])})},F(),B=B.map(function(){this.end=b(this.el[0]);var w,y,K=this.start,H=this.end,r={};for(w in H)y=H[w],K[w]!==y&&(d[w]||(f.fx.step[w]||!isNaN(parseFloat(y)))&&(r[w]=y));return this.diff=r,this}),u.attr("class",A),B=B.map(function(){var K=this,H=f.Deferred();return this.el.animate(this.diff,f.extend({},t,{queue:!1,complete:function(){H.resolve(K)}})),H.promise()}),f.when.apply(f,B.get()).done(function(){F(),f.each(arguments,function(){var K=this.el;f.each(this.diff,function(H){K.css(H,"")})}),t.complete.call(u[0])})})},f.fn.extend({addClass:function(j){return function(i,m,q,t){return m?f.effects.animateClass.call(this,{add:i},m,q,t):j.apply(this,arguments)}}(f.fn.addClass),removeClass:function(j){return function(i,m,q,t){return arguments.length>1?f.effects.animateClass.call(this,{remove:i},m,q,t):j.apply(this,arguments)}}(f.fn.removeClass),toggleClass:function(j){return function(i,m,q,t,u){return"boolean"==typeof m||void 0===m?q?f.effects.animateClass.call(this,m?{add:i}:{remove:i},q,t,u):j.apply(this,arguments):f.effects.animateClass.call(this,{toggle:i},m,q,t)}}(f.fn.toggleClass),switchClass:function(j,i,m,q,t){return f.effects.animateClass.call(this,{add:i,remove:j},m,q,t)}})}(),function(){function b(d,j,i,m){return f.isPlainObject(d)&&(j=d,d=d.effect),d={effect:d},null==j&&(j={}),f.isFunction(j)&&(m=j,i=null,j={}),("number"==typeof j||f.fx.speeds[j])&&(m=i,i=j,j={}),f.isFunction(i)&&(m=i,i=null),j&&f.extend(d,j),i=i||j.duration,d.duration=f.fx.off?0:"number"==typeof i?i:i in f.fx.speeds?f.fx.speeds[i]:f.fx.speeds._default,d.complete=m||j.complete,d}function c(d){return!d||"number"==typeof d||f.fx.speeds[d]?!0:"string"!=typeof d||f.effects.effect[d]?f.isFunction(d)?!0:"object"!=typeof d||d.effect?!1:!0:!0}f.extend(f.effects,{version:"1.11.4",save:function(d,j){for(var i=0;i<j.length;i++)null!==j[i]&&d.data("ui-effects-"+j[i],d[0].style[j[i]])},restore:function(d,j){var i,m;for(m=0;m<j.length;m++)null!==j[m]&&(i=d.data("ui-effects-"+j[m]),void 0===i&&(i=""),d.css(j[m],i))},setMode:function(d,j){return"toggle"===j&&(j=d.is(":hidden")?"show":"hide"),j},getBaseline:function(d,j){var i,m;switch(d[0]){case"top":i=0;break;case"middle":i=.5;break;case"bottom":i=1;break;default:i=d[0]/j.height}switch(d[1]){case"left":m=0;break;case"center":m=.5;break;case"right":m=1;break;default:m=d[1]/j.width}return{x:m,y:i}},createWrapper:function(d){if(d.parent().is(".ui-effects-wrapper"))return d.parent();var j={width:d.outerWidth(!0),height:d.outerHeight(!0),"float":d.css("float")},i=f("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),m={width:d.width(),height:d.height()},q=document.activeElement;return d.wrap(i),(d[0]===q||f.contains(d[0],q))&&f(q).focus(),i=d.parent(),"static"===d.css("position")?(i.css({position:"relative"}),d.css({position:"relative"})):(f.extend(j,{position:d.css("position"),zIndex:d.css("z-index")}),f.each(["top","left","bottom","right"],function(t,u){j[u]=d.css(u),isNaN(parseInt(j[u],10))&&(j[u]="auto")}),d.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),d.css(m),i.css(j).show()},removeWrapper:function(d){var j=document.activeElement;return d.parent().is(".ui-effects-wrapper")&&(d.parent().replaceWith(d),(d[0]===j||f.contains(d[0],j))&&f(j).focus()),d},setTransition:function(d,j,i,m){return m=m||{},f.each(j,function(q,t){var u=d.cssUnit(t);u[0]>0&&(m[t]=u[0]*i+u[1])}),m}}),f.fn.extend({effect:function(){function d(t){function u(){f.isFunction(F)&&F.call(A[0]),f.isFunction(t)&&t()}var A=f(this),F=j.complete,B=j.mode;(A.is(":hidden")?"hide"===B:"show"===B)?(A[B](),u()):q.call(A[0],j,u)}var j=b.apply(this,arguments),i=j.mode,m=j.queue,q=f.effects.effect[j.effect];return f.fx.off||!q?i?this[i](j.duration,j.complete):this.each(function(){j.complete&&j.complete.call(this)}):m===!1?this.each(d):this.queue(m||"fx",d)},show:function(d){return function(j){if(c(j))return d.apply(this,arguments);var i=b.apply(this,arguments);return i.mode="show",this.effect.call(this,i)}}(f.fn.show),hide:function(d){return function(j){if(c(j))return d.apply(this,arguments);var i=b.apply(this,arguments);return i.mode="hide",this.effect.call(this,i)}}(f.fn.hide),toggle:function(d){return function(j){if(c(j)||"boolean"==typeof j)return d.apply(this,arguments);var i=b.apply(this,arguments);return i.mode="toggle",this.effect.call(this,i)}}(f.fn.toggle),cssUnit:function(d){var j=this.css(d),i=[];return f.each(["em","px","%","pt"],function(m,q){j.indexOf(q)>0&&(i=[parseFloat(j),q])}),i}})}(),function(){var b={};f.each(["Quad","Cubic","Quart","Quint","Expo"],function(c,d){b[d]=function(j){return Math.pow(j,c+2)}}),f.extend(b,{Sine:function(c){return 1-Math.cos(c*Math.PI/2)},Circ:function(c){return 1-Math.sqrt(1-c*c)},Elastic:function(c){return 0===c||1===c?c:-Math.pow(2,8*(c-1))*Math.sin((80*(c-1)-7.5)*Math.PI/15)},Back:function(c){return c*c*(3*c-2)},Bounce:function(c){for(var d,j=4;c<((d=Math.pow(2,--j))-1)/11;);return 1/Math.pow(4,3-j)-7.5625*Math.pow((3*d-2)/22-c,2)}}),f.each(b,function(c,d){f.easing["easeIn"+c]=d,f.easing["easeOut"+c]=function(j){return 1-d(1-j)},f.easing["easeInOut"+c]=function(j){return.5>j?d(2*j)/2:1-d(-2*j+2)/2}})}(),f.effects.effect.blind=function(b,c){var d=f(this),j=["position","top","bottom","left","right","height","width"],i=f.effects.setMode(d,b.mode||"hide"),m=b.direction||"up",q=/up|down|vertical/.test(m),t=q?"height":"width",u=q?"top":"left";m=/up|left|vertical|horizontal/.test(m);var B,K,H,A={},F="show"===i;d.parent().is(".ui-effects-wrapper")?f.effects.save(d.parent(),j):f.effects.save(d,j),d.show(),B=f.effects.createWrapper(d).css({overflow:"hidden"}),K=B[t](),H=parseFloat(B.css(u))||0,A[t]=F?K:0,m||(d.css(q?"bottom":"right",0).css(q?"top":"left","auto").css({position:"absolute"}),A[u]=F?H:K+H),F&&(B.css(t,0),m||B.css(u,H+K)),B.animate(A,{duration:b.duration,easing:b.easing,queue:!1,complete:function(){"hide"===i&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}})},f.effects.effect.bounce=function(b,c){var d=f(this),j=["position","top","bottom","left","right","height","width"],i=f.effects.setMode(d,b.mode||"effect"),m="hide"===i,q="show"===i,t=b.direction||"up";i=b.distance;var u=b.times||5,A=2*u+(q||m?1:0),F=b.duration/A,B=b.easing,K="up"===t||"down"===t?"top":"left";t="up"===t||"left"===t;var H,r,w=d.queue(),y=w.length;for((q||m)&&j.push("opacity"),f.effects.save(d,j),d.show(),f.effects.createWrapper(d),i||(i=d["top"===K?"outerHeight":"outerWidth"]()/3),q&&(r={opacity:1},r[K]=0,d.css("opacity",0).css(K,t?2*-i:2*i).animate(r,F,B)),m&&(i/=Math.pow(2,u-1)),r={},q=r[K]=0;u>q;q++)H={},H[K]=(t?"-=":"+=")+i,d.animate(H,F,B).animate(r,F,B),i=m?2*i:i/2;m&&(H={opacity:0},H[K]=(t?"-=":"+=")+i,d.animate(H,F,B)),d.queue(function(){m&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}),y>1&&w.splice.apply(w,[1,0].concat(w.splice(y,A+1))),d.dequeue()},f.effects.effect.clip=function(b,c){var d=f(this),j=["position","top","bottom","left","right","height","width"],i="show"===f.effects.setMode(d,b.mode||"hide"),m="vertical"===(b.direction||"vertical"),q=m?"height":"width";m=m?"top":"left";var u,A,t={};f.effects.save(d,j),d.show(),u=f.effects.createWrapper(d).css({overflow:"hidden"}),u="IMG"===d[0].tagName?u:d,A=u[q](),i&&(u.css(q,0),u.css(m,A/2)),t[q]=i?A:0,t[m]=i?0:A/2,u.animate(t,{queue:!1,duration:b.duration,easing:b.easing,complete:function(){i||d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}})},f.effects.effect.drop=function(b,c){var d=f(this),j=["position","top","bottom","left","right","opacity","height","width"],i=f.effects.setMode(d,b.mode||"hide"),m="show"===i,q=b.direction||"left",t="up"===q||"down"===q?"top":"left";q="up"===q||"left"===q?"pos":"neg";var A,u={opacity:m?1:0};f.effects.save(d,j),d.show(),f.effects.createWrapper(d),A=b.distance||d["top"===t?"outerHeight":"outerWidth"](!0)/2,m&&d.css("opacity",0).css(t,"pos"===q?-A:A),u[t]=(m?"pos"===q?"+=":"-=":"pos"===q?"-=":"+=")+A,d.animate(u,{queue:!1,duration:b.duration,easing:b.easing,complete:function(){"hide"===i&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}})},f.effects.effect.explode=function(b,c){function d(){F.push(this),F.length===j*i&&(m.css({visibility:"visible"}),f(F).remove(),q||m.hide(),c())}var B,K,H,r,w,y,j=b.pieces?Math.round(Math.sqrt(b.pieces)):3,i=j,m=f(this),q="show"===f.effects.setMode(m,b.mode||"hide"),t=m.show().css("visibility","hidden").offset(),u=Math.ceil(m.outerWidth()/i),A=Math.ceil(m.outerHeight()/j),F=[];for(B=0;j>B;B++)for(r=t.top+B*A,y=B-(j-1)/2,K=0;i>K;K++)H=t.left+K*u,w=K-(i-1)/2,m.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-K*u,top:-B*A}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:u,height:A,left:H+(q?w*u:0),top:r+(q?y*A:0),opacity:q?0:1}).animate({left:H+(q?0:w*u),top:r+(q?0:y*A),opacity:q?1:0},b.duration||500,b.easing,d)},f.effects.effect.fade=function(b,c){var d=f(this),j=f.effects.setMode(d,b.mode||"toggle");d.animate({opacity:j},{queue:!1,duration:b.duration,easing:b.easing,complete:c})},f.effects.effect.fold=function(b,c){var d=f(this),j=["position","top","bottom","left","right","height","width"],i=f.effects.setMode(d,b.mode||"hide"),m="show"===i,q="hide"===i;i=b.size||15;var K,t=/([0-9]+)%/.exec(i),u=!!b.horizFirst,A=m!==u,F=A?["width","height"]:["height","width"],B=b.duration/2,H={},r={};f.effects.save(d,j),d.show(),K=f.effects.createWrapper(d).css({overflow:"hidden"}),A=A?[K.width(),K.height()]:[K.height(),K.width()],t&&(i=parseInt(t[1],10)/100*A[q?0:1]),m&&K.css(u?{height:0,width:i}:{height:i,width:0}),H[F[0]]=m?A[0]:i,r[F[1]]=m?A[1]:0,K.animate(H,B,b.easing).animate(r,B,b.easing,function(){q&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()})},f.effects.effect.highlight=function(b,c){var d=f(this),j=["backgroundImage","backgroundColor","opacity"],i=f.effects.setMode(d,b.mode||"show"),m={backgroundColor:d.css("backgroundColor")};"hide"===i&&(m.opacity=0),f.effects.save(d,j),d.show().css({backgroundImage:"none",backgroundColor:b.color||"#ffff99"}).animate(m,{queue:!1,duration:b.duration,easing:b.easing,complete:function(){"hide"===i&&d.hide(),f.effects.restore(d,j),c()}})},f.effects.effect.size=function(b,c){var d,j,i,m=f(this),q=["position","top","bottom","left","right","width","height","overflow","opacity"];d=["position","top","bottom","left","right","overflow","opacity"];var t=["width","height","overflow"],u=["fontSize"],A=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],F=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],B=f.effects.setMode(m,b.mode||"effect"),K=b.restore||"effect"!==B,H=b.scale||"both";j=b.origin||["middle","center"];var r=m.css("position"),w=K?q:d,y={height:0,width:0,outerHeight:0,outerWidth:0};"show"===B&&m.show(),d={height:m.height(),width:m.width(),outerHeight:m.outerHeight(),outerWidth:m.outerWidth()},"toggle"===b.mode&&"show"===B?(m.from=b.to||y,m.to=b.from||d):(m.from=b.from||("show"===B?y:d),m.to=b.to||("hide"===B?y:d)),i={from:{y:m.from.height/d.height,x:m.from.width/d.width},to:{y:m.to.height/d.height,x:m.to.width/d.width}},("box"===H||"both"===H)&&(i.from.y!==i.to.y&&(w=w.concat(A),m.from=f.effects.setTransition(m,A,i.from.y,m.from),m.to=f.effects.setTransition(m,A,i.to.y,m.to)),i.from.x!==i.to.x&&(w=w.concat(F),m.from=f.effects.setTransition(m,F,i.from.x,m.from),m.to=f.effects.setTransition(m,F,i.to.x,m.to))),("content"===H||"both"===H)&&i.from.y!==i.to.y&&(w=w.concat(u).concat(t),m.from=f.effects.setTransition(m,u,i.from.y,m.from),m.to=f.effects.setTransition(m,u,i.to.y,m.to)),f.effects.save(m,w),m.show(),f.effects.createWrapper(m),m.css("overflow","hidden").css(m.from),j&&(j=f.effects.getBaseline(j,d),m.from.top=(d.outerHeight-m.outerHeight())*j.y,m.from.left=(d.outerWidth-m.outerWidth())*j.x,m.to.top=(d.outerHeight-m.to.outerHeight)*j.y,m.to.left=(d.outerWidth-m.to.outerWidth)*j.x),m.css(m.from),("content"===H||"both"===H)&&(A=A.concat(["marginTop","marginBottom"]).concat(u),F=F.concat(["marginLeft","marginRight"]),t=q.concat(A).concat(F),m.find("*[width]").each(function(){var z=f(this),N={height:z.height(),width:z.width(),outerHeight:z.outerHeight(),outerWidth:z.outerWidth()};K&&f.effects.save(z,t),z.from={height:N.height*i.from.y,width:N.width*i.from.x,outerHeight:N.outerHeight*i.from.y,outerWidth:N.outerWidth*i.from.x},z.to={height:N.height*i.to.y,width:N.width*i.to.x,outerHeight:N.height*i.to.y,outerWidth:N.width*i.to.x},i.from.y!==i.to.y&&(z.from=f.effects.setTransition(z,A,i.from.y,z.from),z.to=f.effects.setTransition(z,A,i.to.y,z.to)),i.from.x!==i.to.x&&(z.from=f.effects.setTransition(z,F,i.from.x,z.from),z.to=f.effects.setTransition(z,F,i.to.x,z.to)),z.css(z.from),z.animate(z.to,b.duration,b.easing,function(){K&&f.effects.restore(z,t)})})),m.animate(m.to,{queue:!1,duration:b.duration,easing:b.easing,complete:function(){0===m.to.opacity&&m.css("opacity",m.from.opacity),"hide"===B&&m.hide(),f.effects.restore(m,w),K||("static"===r?m.css({position:"relative",top:m.to.top,left:m.to.left}):f.each(["top","left"],function(z,N){m.css(N,function(V,P){var ea=parseInt(P,10),ca=z?m.to.left:m.to.top;return"auto"===P?ca+"px":ea+ca+"px"})})),f.effects.removeWrapper(m),c()}})},f.effects.effect.scale=function(b,c){var d=f(this),j=f.extend(!0,{},b),i=f.effects.setMode(d,b.mode||"effect"),m=parseInt(b.percent,10)||(0===parseInt(b.percent,10)?0:"hide"===i?0:100),q=b.direction||"both",t=b.origin,u={height:d.height(),width:d.width(),outerHeight:d.outerHeight(),outerWidth:d.outerWidth()};m={y:"horizontal"!==q?m/100:1,x:"vertical"!==q?m/100:1},j.effect="size",j.queue=!1,j.complete=c,"effect"!==i&&(j.origin=t||["middle","center"],j.restore=!0),j.from=b.from||("show"===i?{height:0,width:0,outerHeight:0,outerWidth:0}:u),j.to={height:u.height*m.y,width:u.width*m.x,outerHeight:u.outerHeight*m.y,outerWidth:u.outerWidth*m.x},j.fade&&("show"===i&&(j.from.opacity=0,j.to.opacity=1),"hide"===i&&(j.from.opacity=1,j.to.opacity=0)),d.effect(j)},f.effects.effect.puff=function(b,c){var d=f(this),j=f.effects.setMode(d,b.mode||"hide"),i="hide"===j,m=parseInt(b.percent,10)||150,q=m/100,t={height:d.height(),width:d.width(),outerHeight:d.outerHeight(),outerWidth:d.outerWidth()};f.extend(b,{effect:"scale",queue:!1,fade:!0,mode:j,complete:c,percent:i?m:100,from:i?t:{height:t.height*q,width:t.width*q,outerHeight:t.outerHeight*q,outerWidth:t.outerWidth*q}}),d.effect(b)},f.effects.effect.pulsate=function(b,c){var d=f(this),j=f.effects.setMode(d,b.mode||"show"),i="show"===j,m="hide"===j;j=2*(b.times||5)+(i||"hide"===j?1:0);var q=b.duration/j,t=0,u=d.queue(),A=u.length;for((i||!d.is(":visible"))&&(d.css("opacity",0).show(),t=1),i=1;j>i;i++)d.animate({opacity:t},q,b.easing),t=1-t;d.animate({opacity:t},q,b.easing),d.queue(function(){m&&d.hide(),c()}),A>1&&u.splice.apply(u,[1,0].concat(u.splice(A,j+1))),d.dequeue()},f.effects.effect.shake=function(b,c){var d=f(this),j=["position","top","bottom","left","right","height","width"],i=f.effects.setMode(d,b.mode||"effect"),m=b.direction||"left",q=b.distance||20,t=b.times||3,u=2*t+1,A=Math.round(b.duration/u),F="up"===m||"down"===m?"top":"left",B="up"===m||"left"===m;m={};var K={},H={},r=d.queue(),w=r.length;for(f.effects.save(d,j),d.show(),f.effects.createWrapper(d),m[F]=(B?"-=":"+=")+q,K[F]=(B?"+=":"-=")+2*q,H[F]=(B?"-=":"+=")+2*q,d.animate(m,A,b.easing),q=1;t>q;q++)d.animate(K,A,b.easing).animate(H,A,b.easing);d.animate(K,A,b.easing).animate(m,A/2,b.easing).queue(function(){"hide"===i&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}),w>1&&r.splice.apply(r,[1,0].concat(r.splice(w,u+1))),d.dequeue()},f.effects.effect.slide=function(b,c){var d=f(this),j=["position","top","bottom","left","right","width","height"],i=f.effects.setMode(d,b.mode||"show"),m="show"===i,q=b.direction||"left",t="up"===q||"down"===q?"top":"left";q="up"===q||"left"===q;var u,A={};f.effects.save(d,j),d.show(),u=b.distance||d["top"===t?"outerHeight":"outerWidth"](!0),f.effects.createWrapper(d).css({overflow:"hidden"}),m&&d.css(t,q?isNaN(u)?"-"+u:-u:u),A[t]=(m?q?"+=":"-=":q?"-=":"+=")+u,d.animate(A,{queue:!1,duration:b.duration,easing:b.easing,complete:function(){"hide"===i&&d.hide(),f.effects.restore(d,j),f.effects.removeWrapper(d),c()}})},f.effects.effect.transfer=function(b,c){var d=f(this),j=f(b.to),i="fixed"===j.css("position"),m=f("body"),q=i?m.scrollTop():0;m=i?m.scrollLeft():0;var t=j.offset();j={top:t.top-q,left:t.left-m,height:j.innerHeight(),width:j.innerWidth()},t=d.offset();var u=f("<div class='ui-effects-transfer'></div>").appendTo(document.body).addClass(b.className).css({top:t.top-q,left:t.left-m,height:d.innerHeight(),width:d.innerWidth(),position:i?"fixed":"absolute"}).animate(j,b.duration,b.easing,function(){u.remove(),c()})},f.widget("ui.dialog",f.extend({},f.ui.dialog.prototype,{_title:function(b){this.options.title?b.html(this.options.title):b.html("&#160;")}}))}),function(f){f.transform=function(T){var G=function(J){if(f.browser.msie||"undefined"!=typeof window.ActiveXObject||"ActiveXObject"in window){var ga=f("<xml>")[0];return"undefined"==typeof ga.loadXML&&(ga=new ActiveXObject("Microsoft.XMLDOM"),ga.async=!1),ga.loadXML(J),ga}return(new DOMParser).parseFromString(J,"text/xml")},$=function(J,ga,b,c){if(f.isFunction(J)){var d=b.html();if("JSON"==ga.c.dataType.toUpperCase())try{d=eval("("+b.text()+")")}catch(j){d={error:"An error occurred while converting HTML to JSON"}}"XML"==ga.c.dataType.toUpperCase()&&(d=G(b.html()));try{J.apply(ga.c,[d,ga.c.xslstr,ga.c.xmlstr,ga.c,c])}catch(i){}}};this.c={cache:!1,async:!0,xsl:!1,xml:!1,xslstr:!1,xmlstr:!1,xslobj:!1,xmlobj:!1,xslParams:!1,error:!1,success:!1,complete:!1,island:!1,pass:!1,msg:!1,dataType:"html"},f.extend(this.c,T),T.msg&&f(T.el).html("string"==typeof T.msg?T.msg:f(T.msg).html());var W=function(J){var ga=J+"_"+Math.round(999*Math.random());return 0===f("#"+ga).length?ga:W(J)},U=function(J,ga){ga.c.xsl=ga.c.xsl?ga.c.xsl:"";var b="file:"==location.protocol&&f.browser.msie?"\\":"/",c=location.protocol+b+b+location.host,d=location.pathname.substring(0,location.pathname.lastIndexOf(b)+1)+ga.c.xsl.substring(0,ga.c.xsl.lastIndexOf("/")+1);if(J.substring(0,1)==b)return c+J;if(".."==J.substring(0,2)){for(var j=0;-1!=J.indexOf("..");)J=J.substring(J.indexOf("..")+3),j+=1;for(c+=d.substring(0,d.length-1),d=0;j>d;d++)c=c.substring(0,c.lastIndexOf(b));return c+b+J}return c+d+J},ma=function(J){if((J.c.xslstr||J.c.xslobj)&&(J.c.xmlstr||J.c.xmlobj)){var ga=!1,b=f("<div>");if(!J.c.throwerror){J.c.island&&(J.c.island===!0&&(J.c.island="body"),J.c.xslid=W("xsl"),f(J.c.island).append("<div id='"+J.c.xslid+"' name='"+J.c.xslid+"' style='display:none;'>"+J.c.xslstr+"</div>"),J.c.xmlid=W("xml"),f(J.c.island).append("<div id='"+J.c.xmlid+"' name='"+J.c.xmlid+"' style='display:none;'>"+J.c.xmlstr+"</div>")),J.c.xslobj=J.c.xslobj?J.c.xslobj:G(J.c.xslstr),J.c.xmlobj=J.c.xmlobj?J.c.xmlobj:G(J.c.xmlstr);var c,d;if("undefined"==typeof XSLTProcessor||"undefined"!=typeof window.ActiveXObject||"ActiveXObject"in window)try{if(c=function(K,H){for(var r=H.selectNodes(K),w=0;w<r.length;w++)r[w].setAttribute("href",U(r[w].getAttribute("href"),J))},c("//xsl:include",J.c.xslobj),c("//xsl:import",J.c.xslobj),d=function(K,H){for(var r in K){var w="//xsl:param[@name='"+r+"']";try{var y=K[r];"boolean"==typeof y?y="'"+y+"'":isNaN(parseInt(y))&&y.indexOf("'")<0&&(y="'"+y+"'");var z=H.selectSingleNode(w);if(null==z){var N=H.createElement("xsl:param");N.setAttribute("name",r),H.documentElement.insertBefore(N,H.selectSingleNode("//xsl:template")),z=H.selectSingleNode(w)}z.setAttribute("select",y)}catch(V){}}},J.c.xslParams&&(d(J.c.xslParams,J.c.xslobj),J.c.xslobj=G(J.c.xslobj.xml)),"undefined"!=typeof J.c.xmlobj.transformNode)b.empty().html(J.c.xmlobj.transformNode(J.c.xslobj));else{var j=new ActiveXObject("Msxml2.XSLTemplate"),i=new ActiveXObject("Msxml2.FreeThreadedDOMDocument");i.loadXML(J.c.xslobj.xml),j.stylesheet=i;var m=j.createProcessor();m.input=J.c.xmlobj,m.transform(),b.empty().html(m.output)}}catch(q){ga=!0,$(J.c.error,J,b,q)}else try{var t=new XSLTProcessor,u=function(K,H){for(var r=[],w=K.getElementsByTagName(H),y=0;y<w.length;y++)w[y].parentNode==K&&(r[r.length]=w[y]);return r},A=function(K,H){for(var r=f.merge(f.makeArray(K.getElementsByTagName("import")),f.makeArray(K.getElementsByTagName("include"))),w=0;w<r.length;w++){var y=r[w];f.ajax({passData:{node:y,xObj:K,rootConfig:H},dataType:"xml",async:!1,url:U(y.getAttribute("href"),H),success:function(z){try{var N=this.passData;z=A(z,N.rootConfig);var V=f.merge(u(z.getElementsByTagName("stylesheet")[0],"param"),u(z.getElementsByTagName("stylesheet")[0],"template")),P=f.merge(u(N.xObj.getElementsByTagName("stylesheet")[0],"param"),u(N.xObj.getElementsByTagName("stylesheet")[0],"template"));z=[];for(var ea=[],ca=0;ca<P.length;ca++)P[ca].getAttribute("name")?z[P[ca].getAttribute("name")]=!0:ea[P[ca].getAttribute("match")]=!0;var ha=N.node.parentNode;for(P=0;P<V.length;P++)if(!z[V[P].getAttribute("name")]&&!ea[V[P].getAttribute("match")]){var oa=N.xObj.importNode(V[P],!0);ha.insertBefore(oa,N.xObj.getElementsByTagName("template")[0])}ha.removeChild(N.node)}catch(ua){}}})}return K};c=function(K,H){K=f.browser.mozilla&&"1.9"==f.browser.version.substring(0,3)?"xsl:"+K:K;for(var r=H.getElementsByTagName(K),w=0;w<r.length;w++)r[w].setAttribute("href",U(r[w].getAttribute("href"),J))},f.browser.safari?J.c.xslobj=A(J.c.xslobj,J):(c("import",J.c.xslobj),c("include",J.c.xslobj)),d=function(K){for(var H in K)try{t.setParameter(null,H,K[H])}catch(r){}},d(J.c.xslParams);var F=document.implementation.createDocument("","",null);t.importStylesheet(J.c.xslobj),b.empty().append(t.transformToFragment(J.c.xmlobj,F))}catch(B){ga=!0,$(J.c.error,J,b,B)}return J.c.el&&b.html()&&f(J.c.el).html(b.html()),ga||$(J.c.success,J,b),$(J.c.complete,J,b),b.html()}$(J.c.error,J,b,{message:"Bad XML or XSL call"})}},ia=function(J,ga,b){"string"==typeof ga&&(ga={cache:!1,url:ga,dataType:"xml",async:J.c.async,pass:J.c.pass}),ga.complete=function(c,d){"success"!=d?J.c.threwError||(J.c.threwError=!0,$(J.c.error,J,f("<div>"+c.responseText+"</div>"),{message:"Error requesting file "+this.url}),$(J.c.complete,J,f("<div>"+c.responseText+"</div>"))):("XSL"==b?200==c.status?J.c.xslstr=c.responseText:(J.c.xslstr="error",J.c.throwerror=!0):200==c.status?J.c.xmlstr=c.responseText:(J.c.xmlstr="error",J.c.throwerror=!0),J.c.async&&ma(J))},f.ajax(ga)};return this.c.xsl&&ia(this,T.xsl,"XSL"),this.c.xml&&ia(this,T.xml,"XML"),!this.c.async||this.c.xmlstr||this.c.xmlobj||this.c.xslstr||this.c.xslobj?ma(this):void 0},f.fn.transform=function(T){return this.each(function(){T=T?T:{},T.el=this,new f.transform(T)})}}(fb),fb().ready(function(){fb("[transform]").each(function(f,T){fb(T).transform(eval("("+fb(T).attr("transform")+")"))})});var Qd=function(){return function(f){var T=f.jquery,G=T.extend({},f);"undefined"==typeof G.sEditor&&(G.sEditor="");var ma,ia,J,ga,b,$=".Diagplws_lbl,.Diagplws_ignoreanalysis",W=null,U=null;b=function(c){return null!=c&&-1!="|div|br|hr|td|th|p|pre|blockquote|li|h1|h2|h3|h4|h5|h6|".indexOf("|"+c.toLowerCase()+"|")},ga=function(c){var d=c;return null!=c&&(d=d.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;")),d},J=function(c,d){function j(m){m=m.childNodes;for(var q=0;q<m.length&&!(0>=d&&W.length>0);q++){var t=m[q];if(3==t.nodeType){var u=t.data;if(i&&(u=u.replace(/^\s+/,""),""!=u.replace(/^\s+/,"")&&(i=!1)),u.length>c){var A={};A.node=t,A.offset=c,A.length=d<u.length-c?d:u.length-c,W.push(A),d=d-u.length+c,c=0}else c-=u.length}else 1!=t.nodeType||T(t).is($)||(j(t),!i&&b(t.nodeName)&&c>0&&c--)}}var i=!0;W=[],j(G.sourceId)},ma=function(c,d){var j=null,i=j=null;T.browser.webkit&&(T.browser.chrome=/chrome/.test(navigator.userAgent.toLowerCase()),T.browser.safari=!T.browser.chrome),null!=c&&null!=d&&null!=G.sEditor&&(i=c.offsetTop?c.offsetTop:T(c).offset().top,j=d,T(d).scrollTop(i-j.clientHeight/2))},ia=function(c,d,j,i,m){var q=c.data,t=c.parentNode;if(i=G.sourceId.ownerDocument.createElement(i),i.className=m,i.style.backgroundColor="red",0==d&&q.length==j)i.appendChild(c.cloneNode(!1)),t.insertBefore(i,c);else{var u=q.substr(0,d);m=q.substr(d,j),d=q.substr(d+j),j=G.sourceId.ownerDocument.createTextNode(u),q=G.sourceId.ownerDocument.createTextNode(m),d=G.sourceId.ownerDocument.createTextNode(d),i.appendChild(q),t.insertBefore(j,c),t.insertBefore(i,c),t.insertBefore(d,c),U.textNodeBefore=j,U.textNodeAfter=d}return t.removeChild(c),U.aErrorNodes.push(i),i},this.offsetToDom=J,this.showError=function(c,d){if(J(c,d),null!==W){var j;U={},U.aErrorNodes=[],U.textNodeBefore=null;var i=U.textNodeAfter=null;for(j=0;j<W.length;j++)i=W[j],i=ia(i.node,i.offset,i.length,"span","DiagPlWs_error");ma(i,G.sourceId)}},this.replaceText=function(c){if(null!==U){var d;for(d=0;d<U.aErrorNodes.length;d++){var q,j=U.aErrorNodes[d],i=W[d],m=j.parentNode;d==W.length-1?q=G.sourceId.ownerDocument.createTextNode(c):(q=c.substr(0,i.length),q=G.sourceId.ownerDocument.createTextNode(q),c=c.substr(i.length)),0==q.data.length?m.removeChild(j):m.replaceChild(q,j)}W=U=null}},this.hideError=function(){if(null!=U&&null!=U.aErrorNodes){for(var c=0;c<U.aErrorNodes.length;c++){var d=U.aErrorNodes[c],j=d.parentNode,i=G.sourceId.ownerDocument.createTextNode(d.textContent||d.innerText);j.insertBefore(i,d),j.removeChild(d)}U.aErrorNodes=null}},this.getText=function(){function c(j){j=j.childNodes;for(var i=0;i<j.length;i++){var m=j[i];if(3==m.nodeType)0==d.length&&(m.data=m.data.replace(/^\s+/,"")),d+=m.data;else if(1==m.nodeType&&!T(m).is($)){var q=b(m.nodeName);c(m),q&&d.length>0&&(d+="\n")}}}var d="";return c(G.sourceId),d=ga(d)}}}(),Rd=function(){return function(f){var J,ga,b,c,d,j,i,m,q,t,u,A,T="/imgs/DiagPlWsIcon.png&quot;/&gt;&nbsp;&nbsp;Le Robert Correcteur "+f.version+'" style="display:none;width: 520px;"><div id="Diagplws_containerui"></div><div id="Diagplws_hostdocument" class="Diagplws_content"></div></div>',G=f.jquery,$={hardSpace:" ",thinSpace:" ",halfEm:" ",otherSpace:" "},W=null,U=null,ma=null,ia=null;i=function(){null==W&&(G("#Diagplws_correctionUI").size()>0?U=G("#Diagplws_correctionUI"):(U=G('<div id="Diagplws_correctionUI" title="&lt;img style=&quot;vertical-align:-4px&quot; src=&quot;'+f.sCorePath+T),G("body").append(U)),null!=ma&&G("#Diagplws_hostdocument",U).replaceWith(ma),W=G("#Diagplws_containerui",U)),null==ia&&(ia=G(".Diagplws_messageContainer").size()>0?G(".Diagplws_messageContainer").first():G('<div class="Diagplws_messageContainer"><div class="Diagplws_msg"></div></div>'),G(".Diagplws_msg",ia).html('<img src="'+f.sCorePath+'/imgs/loader.gif" /><p>Communication avec le serveur de correction</p>'),t({modal:!0,resizable:!1,draggable:!1,closeOnEscape:!1,minWidth:100,minHeight:100,autoOpen:!1,open:function(){ia.parent().find(".ui-dialog-titlebar-close").hide();
}},ia))},J=function(F){G(".Diagplws_table td",F).addClass("ui-state-default"),G(".Diagplws_table tr",F).hover(function(){G(this).siblings().children("td").trigger("focusout"),G(this).children("td").addClass("ui-state-hover")},function(){G(this).children("td").removeClass("ui-state-hover")}),G(".Diagplws_table tr",F).click(function(){G("td.ui-state-highlight",W).removeClass("ui-state-highlight"),G(".Diagplws_errorLabel",W).removeClass("Diagplws_LabelHighlight"),G(this).children("td").toggleClass("ui-state-highlight"),G(".Diagplws_errorLabel",this).toggleClass("Diagplws_LabelHighlight")})},j=function(){var F;G(".Diagplws_errorList .Diagplws_errorTypo").each(function(){F=G(this).html(),F=F.replace(RegExp($.hardSpace,"gi"),'<span class="Diagplws_pseudo-nbsp">&#xA0;&#xA0;&#xA0;</span>'),F=F.replace(/˽/gi,'<span class="Diagplws_pseudo-sp">&#xA0;&#xA0;&#xA0;</span>'),F=F.replace(RegExp($.thinSpace,"gi"),'<span class="Diagplws_pseudo-thinsp">&#xA0;&#xA0;&#xA0;</span>'),F=F.replace(RegExp($.halfEm,"gi"),'<span class="Diagplws_pseudo-ensp">&#xA0;&#xA0;&#xA0;</span>'),F=F.replace(RegExp($.otherSpace,"gi"),'<span class="Diagplws_pseudo-othersp">&#xA0;&#xA0;&#xA0;</span>'),G(this).html(F)})},b=function(){var F=A();null==F||""==F?G("#Diagplws_correction_btn",W).button("disable"):G("#Diagplws_correction_btn",W).button("enable")},ga=function(){b()},c=function(){G(".ui-widget-overlay").mousedown(function(){U.dialog("close")}),d()},m=function(F){var B=G(".Diagplws_errorList",W);F=G("td",B).eq(F),(F.get(0).offsetTop<B.scrollTop()||F.get(0).offsetTop+F.height()>B.scrollTop()+B.get(0).clientHeight)&&B.scrollTop(F.get(0).offsetTop),F.click()},u=function(F){G(".Diagplws_correction_input",W).val(F),b()},A=function(){return G(".Diagplws_correction_input",W).val()},q=function(F){G(".Diagplws_waitingmsg",ia).html(F),ia.dialog("isOpen")||ia.dialog("open")},t=function(F,B){var K=null;B=B||U,F.create&&(K=F.create),F.create=function(r,w){K&&K(r,w),B.parents(".ui-dialog").first().wrap('<div class="diagplws" />').css("position","")},B.dialog(F),B==W&&(B.height(B.get(0).scrollHeight),B.get(0).scrollHeight>B.get(0).clientHeight&&G(".diagplws .ui-dialog").height(G(".diagplws .ui-dialog-titlebar").outerHeight(!0)+B.outerHeight(!0)));var H=G(".ui-widget-overlay").detach();return B.parents(".diagplws").append(H),B},d=function(){var F=U.height(),B=W.outerHeight(!0);ma.outerHeight(F-B)},this.init=i,this.loadErrors=function(F,B){var K=0;if(ia.dialog("isOpen")&&ia.dialog("close"),"undefined"==typeof B||0==W.children().length)W.empty().html(F),K=parseInt(G(".Diagplws_errorList",W).data("diagplws_errorcount"));else{var H=G(F);H=G("#Diagplws_errorList_"+B,H),G("#Diagplws_errorList_"+B,W).length>0?G("#Diagplws_errorList_"+B).replaceWith(H):G(".Diagplws_errorList_panel",W).append(H),G(".Diagplws_errorList",W).each(function(){NaN!=parseInt(G(this).data("Diagplws_errorCount"))&&(K+=parseInt(G(this).data("Diagplws_errorCount")))})}return G.browser.msie&&G.browser.version<"8.0"&&(H=G(".Diagplws_correction_button").first(),H.css("margin-top","0px").hide(),G(".Diagplws_correction").append('<div class="'+H.attr("class")+'">'+H.html()+"</div>"),H.removeClass("Diagplws_correction_button")),K},this.showErrors=function(F){var B=G(".Diagplws_errorList",W);J(B),j();var K=this;G(".Diagplws_errorLabel",B).parent().each(function(H){G(this).bind("click",{currentIndex:H},K.onLabelClick)}),G(".Diagplws_correction_input",W).keyup(ga),G("#Diagplws_correction_btn",W).button().click(this.onCorrectionClick),G("#Diagplws_ignorer_btn",W).button().click(this.onIgnoreClick),U.is(":visible")||(B={modal:!0,resizable:!1,minWidth:815,minHeight:500,height:G(window).height()-10,open:c,close:this.onClose},"undefined"!=typeof f.height&&(B.height=f.height>B.minHeight?f.height:B.minHeight),"undefined"!=typeof f.width&&(B.width=f.width>B.minWidth?f.width:B.minWidth),("undefined"!=typeof f.left||"undefined"!=typeof f.top)&&(B.position={of:window},"undefined"!=typeof f.left?(B.position.my="left+"+f.left+" ",B.position.at="left "):(B.position.my="center ",B.position.at="center "),"undefined"!=typeof f.top?(B.position.my+="top+"+f.top,B.position.at+="top"):(B.position.my+="center",B.position.at+="center ")),ma.show(),t(B)),m(F)},this.setDiagnosis=function(F){G(".Diagplws_diagnosis",W).empty().html(F)},this.showProposal=function(F,B,K){var H=G(".Diagplws_props",W);H.css("visibility","hidden"),H.empty().html(F),0==G(".Diagplws_prop_button",H).length?(H.empty().html("<p>Pas de propositions</p>"),K||(u(B),G(".Diagplws_correction_input",W).focus())):(u(""),G(".Diagplws_prop_button",H).button().click(this.onProposalClick).bind("mouseenter.removefocus",function(){G(".Diagplws_prop_button",H).removeClass("ui-state-focus"),G(".Diagplws_prop_button",H).unbind("mouseenter.removefocus")}),H.get(0).offsetHeight<H.get(0).scrollHeight&&(F=H.get(0).clientWidth-(G(".Diagplws_prop_button",H).outerWidth()-G(".Diagplws_prop_button",H).innerWidth()),G(".Diagplws_prop_button",H).width(F)),G(".Diagplws_prop_button",H).first().focus()),H.css("visibility","visible")},this.setCorrection=u,this.getCorrection=A,this.manageCorrectionDisplay=function(F,B){F?(u(""),G(".Diagplws_correction_panel .Diagplws_correction_input:enabled",W).attr("disabled","disabled"),G(".Diagplws_correction_panel .Diagplws_legend",W).addClass("Diagplws_legenddisabled")):(G(".Diagplws_correction_panel .Diagplws_correction_input:disabled",W).removeAttr("disabled"),G(".Diagplws_correction_panel .Diagplws_legend",W).removeClass("Diagplws_legenddisabled")),G("#Diagplws_correction_btn",W).unbind("click"),B>0?G("#Diagplws_correction_btn",W).click(this.onMultipleCorrectionClick):G("#Diagplws_correction_btn",W).click(this.onCorrectionClick)},this.showMessage=function(F){i(),W.empty().html('<div class="Diagplws_messageContainer"><div class="Diagplws_msg"></div></div>'),G(".Diagplws_msg",W).html(F),ma.hide(),ia.dialog("isOpen")&&ia.dialog("close"),t({modal:!0,resizable:!1,minWidth:100,minHeight:100,open:c,close:this.onClose})},this.showErrorMessage=function(F){i(),W.empty().html('<div class="Diagplws_messageContainer"><div class="Diagplws_msg"></div></div>'),G(".Diagplws_msg",W).html(F),ma.hide(),ia.dialog("isOpen")&&ia.dialog("close"),t({modal:!0,resizable:!1,minWidth:100,minHeight:100,height:"auto",width:"auto",open:c,close:this.onErrorClose})},this.showWaitingMessage=q,this.selectError=m,this.beginAnalyze=function(){i(),U.is(":visible")?(G(".Diagplws_correction_button",W).button("disable"),G(".Diagplws_prop_button",W).button("disable"),G(".Diagplws_errorLabel",W).parent().unbind("click")):q("Communication avec le serveur de correction")},this.getError=function(F){var B=G(".Diagplws_errorList",W);return G("td .Diagplws_errorLabel",B).eq(F)},this.close=function(){U.is(":visible")?U.dialog("close"):this.onClose()},this.setSpaces=function(F){$=G.extend($,F)},this.setHostDocElement=function(F){ma=F},this.onClose=this.onErrorClose=this.onIgnoreClick=this.onMultipleCorrectionClick=this.onCorrectionClick=this.onProposalClick=this.onLabelClick=null}}(),Sd=function(){return function(f,T){var G=f.jquery.extend({},f),$=G.jquery,W=null,U=[];"undefined"!=typeof G.sources&&$.isArray(G.sources)?U=G.sources:("undefined"!=typeof G.sourceId&&(U=[{src:G.sourceId,type:"DOM"}]),G.sources=U);var ma={hardSpace:" ",thinSpace:" ",halfEm:" ",otherSpace:" "};"undefined"!=typeof G.spaces&&(ma=$.extend(ma,G.spaces)),T.setSpaces(ma);var ia={},J=$("#Diagplws_hostdocument");0==J.length&&(J=$("<div id='Diagplws_hostdocument' class='Diagplws_content'></div>")),T.setHostDocElement(J);var ga,A,F,B,K,H,r,w,y,z,N,V,P,ea,ca,ha,oa,ua,ja,Ea,Pa,b={OK:0,ERR_WSPROXY:1,ERR_XSLT_LOAD:2,ERR_XSLT_TRANS:3},c=b.OK,d={NO_ANOMALIES:0,NO_MORE_ANOMALIES:1,USER_EXIT:2,ERROR:3},j=d.NO_ANOMALIES,i=0,m=0,q=0,t=0,u=!0;ca=function(){var X;if(J.empty(),U.length>0){for(var aa=0;aa<U.length;aa++)"undefined"!=typeof U[aa].label&&""!=U[aa].label&&(X=$('<div class="Diagplws_lbl">'+U[aa].label+"</div>"),J.append(X)),"txt"==U[aa].type?(X=$('<pre class="Diagplws_stream"></pre>'),X.text($(U[aa].src).val())):(X=$('<div class="Diagplws_stream"></div>'),X.html($(U[aa].src).html()),"undefined"!=typeof U[aa].excludedElement&&"string"==typeof U[aa].excludedElement&&$(U[aa].excludedElement,X).addClass("Diagplws_ignoreanalysis")),J.append(X);"undefined"!=typeof G.excludedElement&&"string"==typeof G.excludedElement&&$(G.excludedElement,J).addClass("Diagplws_ignoreanalysis")}G.sourceId=J.get(0),W=new Qd(G)},oa=function(X,aa){W.hideError(),W.showError(X,aa)},ua=function(X){W.replaceText(X),t++,ha(U,ia)},Pa=function(X){var Ua,aa=0,La=0,Ma=0,Aa=0,va=Ea;aa=parseInt(va.attr("Diagplws_offset"));do W.replaceText(X),t++,La=parseInt(va.attr("Diagplws_length")),Ua=parseInt(va.attr("Diagplws_duplicateNextErrorId")),va=T.getError(Ua),Aa=parseInt(va.attr("Diagplws_offset")),Aa>aa?Ma+=X.length-La:Ma=0,aa=Aa,va.attr("Diagplws_offset",Aa+Ma),W.showError(Aa+Ma,La);while(i!=Ua);ha(U,ia)},H=function(){T.showWaitingMessage("Demande de correction automatique");var X=W.getText(),aa='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:prol="http://www.prolexis.com/ProLexisService" xmlns:obj="http://objects.mtn.mtnj.prolexis.com"><soapenv:Header/><soapenv:Body><prol:autoCorrection><prol:in0><obj:language>%s</obj:language><obj:text>'.replace("%s",ia.language);aa+=X+"</obj:text></prol:in0><prol:in1>?</prol:in1></prol:autoCorrection></soapenv:Body></soapenv:Envelope>",c=b.OK,$.ajax({type:"POST",url:G.sUrlProxy,contentType:"text/xml",dataType:$.browser.msie||"undefined"!=typeof window.ActiveXObject||"ActiveXObject"in window?"text":"xml",data:aa,success:F,error:B})},B=function(X,aa){c=b.ERR_WSPROXY,T.showErrorMessage("Erreur lors de la tentative d'accès au Web Service : "+aa)},K=function(X,aa){c=b.ERR_XSLT_LOAD,T.showErrorMessage("Erreur de chargement de la feuille Xslt : "+aa)},A=function(X){if((null==ga||void 0==ga)&&$.ajax({url:G.sCorePath+"/xslt/correctionUI.xslt?v="+encodeURIComponent(G.version),async:!1,dataType:$.browser.msie||"undefined"!=typeof window.ActiveXObject||"ActiveXObject"in window?"text":"xml",success:function(Ma){"string"==typeof Ma?(ga=new ActiveXObject("Microsoft.XMLDOM"),ga.async=!1,ga.loadXML(Ma)):ga=Ma},error:K}),c==b.OK)try{var aa=$.transform({xmlstr:X,xslobj:ga,async:!1,xslParams:{corePath:G.sCorePath,editor:G.sEditor,hardSpace:ma.hardSpace,thinSpace:ma.thinSpace,halfEm:ma.halfEm}})}catch(La){X="object"==typeof La&&La.message?La.message:La,c=b.ERR_XSLT_TRANS,T.showErrorMessage("Erreur lors de la tranformation Xslt : "+X)}c==b.OK&&(T.onLabelClick=y,T.onCorrectionClick=N,T.onMultipleCorrectionClick=V,X=m,m=T.loadErrors(aa),aa.length>0?0==m?0==i&&0==X?P():ea():(i>m-1&&(i=0),T.showErrors(i)):T.showErrorMessage("La réponse du Web Service ne peut pas être interprétée."))},F=function(X){if(c==b.OK){var aa,La,Ma;if(T.showWaitingMessage("Corrections automatiques en cours"),"string"==typeof X){var Aa=new ActiveXObject("Microsoft.XMLDOM");Aa.async=!1,Aa.preserveWhiteSpace=!0,Aa.loadXML(X),X=$(Aa)}else X=$(X);X.find("AutoCorrection").each(function(){aa=$("correction",$(this)).text(),La=parseInt($("offset",$(this)).text()),Ma=parseInt($("length",$(this)).text()),W.showError(La,Ma),W.replaceText(aa),q++})}r()},y=function(X){if(null!=X&&null!=X.currentTarget&&null!=X.currentTarget.firstChild&&null!=X.data){var aa=$(X.currentTarget.firstChild),La=parseInt(aa.attr("Diagplws_offset")),Ma=parseInt(aa.attr("Diagplws_length")),Aa=aa.attr("Diagplws_props"),Ua=aa.attr("Diagplws_diagnosis"),va=parseInt(aa.data("stream"));i=X.data.currentIndex,Ea=aa,oa(La,Ma,va),T.setDiagnosis(Ua),T.onProposalClick=z,T.manageCorrectionDisplay(aa.hasClass("Diagplws_errorTypo"),parseInt(aa.attr("diagplws_duplicateerrorcount")),Aa.length>0),T.showProposal(Aa,aa.text(),aa.hasClass("Diagplws_errorGram")||aa.hasClass("Diagplws_errorTypo"))}},z=function(X){if(null!=X&&null!=X.currentTarget&&null!=X.currentTarget.children){var aa=$(X.currentTarget.children[0].children[0]);X=parseInt(Ea.attr("diagplws_duplicateerrorcount")),aa=aa.attr("Diagplws_proposal"),X>0?Pa(aa):ua(aa)}},N=function(){ua(T.getCorrection())},V=function(){Pa(T.getCorrection())},P=function(){j=d.NO_ANOMALIES,$.isFunction(G.onNoAnomalies)?(G.onNoAnomalies(),T.close()):T.showMessage("Aucune anomalie n'a été détectée")},ea=function(){j=d.NO_MORE_ANOMALIES,$.isFunction(G.onNoMoreAnomalies)?(G.onNoMoreAnomalies(),T.close()):T.showMessage("Toutes les erreurs ont été traitées")},r=function(){T.showWaitingMessage("Analyse du texte");var X=W.getText(),aa='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:prol="http://www.prolexis.com/ProLexisService" xmlns:obj="http://objects.mtn.mtnj.prolexis.com"><soapenv:Header/><soapenv:Body><prol:analyze><prol:in0><obj:currentOffset>0</obj:currentOffset><obj:language>%s</obj:language><obj:text>'.replace("%s",ia.language);aa+=X+"</obj:text></prol:in0><prol:in1>?</prol:in1></prol:analyze></soapenv:Body></soapenv:Envelope>",c=b.OK,$.ajax({type:"POST",url:G.sUrlProxy,contentType:"text/xml",data:aa,dataType:"text",success:A,error:B})},w=function(){"undefined"!=typeof G.excludedElement&&"string"==typeof G.excludedElement&&$(G.excludedElement,J).removeClass("Diagplws_ignoreanalysis"),$(J).children(".Diagplws_stream").each(function(X){"txt"==U[X].type||"html"==U[X].type?$(U[X].src).val($(this).text()):$(U[X].src).html($(this).html())}),u=!0},ha=function(X,aa){ia={language:"fr"},"undefined"!=typeof aa&&(ia=$.extend(ia,aa),ia.language=ia.language.toLowerCase()),u?(j=d.USER_EXIT,t=q=m=i=0,U="undefined"!=typeof X?X:G.sources,ca(),U.length>0?(T.beginAnalyze(),u=!1,H()):T.showErrorMessage("Aucun élément à analyser.")):(T.beginAnalyze(),r())},ja=function(){W.hideError(),w(),$.isFunction(G.hCallBack)&&G.hCallBack({statut:j,autoCorrectionCount:q,userCorrectionCount:t})},T.onClose=ja,T.onErrorClose=function(){j=d.ERROR,$.isFunction(G.onError)&&G.onError(),ja()},T.onIgnoreClick=function(){m-1>i?T.selectError(i+1):T.close()},this.analyze=ha,this.showError=oa,this.correct=ua,this.termAnalyze=ja,this.setNewSource=function(X){W=X,t=q=m=i=0},this.setCallBack=function(X){G.hCallBack=X}}}(),gc=function(f){function T(ma){var ia=null;"undefined"!=typeof G.document&&(ia=G.document.createElement("link"),ia.setAttribute("rel","stylesheet"),ia.setAttribute("type","text/css"),ia.setAttribute("href",ma),G.document.getElementsByTagName("head")[0].appendChild(ia))}var G=f,$=null,W=!0;if("undefined"==typeof fb)throw Error("Jquery for DiagPlWs not available.");var U={jquery:fb,version:"2.0b12"};return{init:function(ma){if(U=fb.extend(!0,U,ma),"undefined"==typeof U.sCorePath)throw Error("Core path not defined.");W&&(T(U.sCorePath+"/css/jquery-ui.css?v="+encodeURIComponent(U.version)),T(U.sCorePath+"/css/Diagplws.css?v="+encodeURIComponent(U.version)),"undefined"!=typeof U.sCustomCssFile&&T(U.sCustomCssFile),W=!1),ma=new Rd(U),$=new Sd(U,ma)},analyze:function(ma,ia){null!=$&&$.analyze(ma,ia)},version:U.version}}("undefined"!=typeof fc?fc:top);top.DiagPlWs=gc,"undefined"==typeof top.DiagPlWsLoader&&(top.DiagPlWsLoader=function(){return{init:function(f){top.DiagPlWs.init(f)},analyze:function(f){top.DiagPlWs.analyze(f)}}})}}(top),angular.module("edsiteApp.GroupesFlexibles",["edsiteApp.Commun","ui.bootstrap","edsiteApp.base64filter"]).controller("GroupesFlexiblesCtrl",["$scope","$uibModal","$filter","$q","$location","$sessionStorage","$routeParams","lodash","Notification","Auth","UserService","GroupesFlexiblesService",function($scope,$uibModal,$filter,$q,$location,$sessionStorage,$routeParams,lodash,Notification,Auth,UserService,GroupesFlexiblesService){function onSelectGroupe(groupe){$sessionStorage["groupes-flexibles-groupe"]=groupe.id,vm.idGroupeSelected=groupe.id,$location.path("/"+vm.typeUser+"/GroupesFlexibles").search("groupe",groupe.id)}function getDetailGroupeFlexible(idGroupe){vm.promiseContents=GroupesFlexiblesService.getDetailGroupeFlexible(idGroupe).then(function(detailGroupe){vm.groupeSelected=detailGroupe,vm.listePeriodes=[].concat(vm.groupeSelected.periodes)})}function openPeriodeGroupeFlexible(periode){var modalInstance=$uibModal.open({templateUrl:"modules/groupesFlexibles/groupe-flexible-periode.html",controller:"GroupeFlexiblePeriodeCtrl",controllerAs:"periodeGroupeFlexibleCtrl",size:"lg",backdrop:!1,resolve:{groupe:function(){return vm.groupeSelected},periode:function(){return periode}}});modalInstance.result.then(function(tabPeriodesUpdated){angular.isUndefined(tabPeriodesUpdated)||(vm.listePeriodes=[].concat(tabPeriodesUpdated))})}function refresh(){vm.promiseContents=GroupesFlexiblesService.getGroupesFlexibles().then(function(tabGroupes){vm.listeGroupes=tabGroupes,1===vm.listeGroupes.length&&vm.onSelectGroupe(vm.listeGroupes[0])}),angular.isDefined(vm.idGroupeSelected)&&vm.getDetailGroupeFlexible(vm.idGroupeSelected)}var vm=this;vm.typeUser=$routeParams.typeUser,vm.listeGroupes=[],vm.idGroupeSelected=$routeParams.groupe,vm.groupeSelected=null,vm.listePeriodes=[],vm.listePeriodesDisplay=[],vm.refresh=refresh,vm.onSelectGroupe=onSelectGroupe,vm.getDetailGroupeFlexible=getDetailGroupeFlexible,vm.openPeriodeGroupeFlexible=openPeriodeGroupeFlexible,refresh()}]),angular.module("edsiteApp.GroupesFlexibles").controller("GroupeFlexiblePeriodeCtrl",["$scope","$uibModal","$uibModalInstance","$q","$filter","lodash","Notification","Auth","UserService","GroupesFlexiblesService","groupe","periode",function($scope,$uibModal,$uibModalInstance,$q,$filter,lodash,Notification,Auth,UserService,GroupesFlexiblesService,groupe,periode){function savePeriode(){vm.periode.dateDebut instanceof Date&&(vm.periode.dateDebut=moment(vm.periode.dateDebut).format("YYYY-MM-DD")),vm.periode.dateFin instanceof Date&&(vm.periode.dateFin=moment(vm.periode.dateFin).format("YYYY-MM-DD")),vm.periode.dateLimiteInscription instanceof Date&&(vm.periode.dateLimiteInscription=moment(vm.periode.dateLimiteInscription).format("YYYY-MM-DD")),vm.promiseContents=GroupesFlexiblesService.savePeriode(vm.periode,vm.groupe.id).then(function(periodeUpdated){if(Notification.notify("Groupes flexibles","Votre période a bien été prise en compte","success",!0),vm.isModeAjout)vm.groupe.periodes.push(periodeUpdated);else{var indicePeriode=lodash.findIndex(vm.groupe.periodes,function(periode){return periode.id===periodeUpdated.id});vm.groupe.periodes[indicePeriode]=periodeUpdated}vm.close(vm.groupe.periodes)},function(error){Notification.notify("Groupes flexibles",error.data.message||"Une erreur est survenue","error",!0)})}function deletePeriode(){var callbackFn=function(){vm.promiseContents=GroupesFlexiblesService.deletePeriode(vm.periode.id,vm.groupe.id).then(function(data){Notification.notify("Groupes flexibles","La période a bien été supprimée","success",!0);var indicePeriode=lodash.findIndex(vm.groupe.periodes,function(periode){return periode.id===vm.periode.id});indicePeriode>-1&&vm.groupe.periodes.splice(indicePeriode,1),vm.close(vm.groupe.periodes)},function(error){Notification.notify("Groupes flexibles",error.data.message||"Une erreur est survenue","error",!0)})},modalInstance=$uibModal.open({templateUrl:"../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title="Suppression d'une période",config.message="Vous êtes sur le point de supprimer la période. Continuer ?",config.confirm="Supprimer",config.cancel="Non",config}}});modalInstance.result.then(callbackFn)}function isDateDisable(date,mode){return"day"!==mode?!1:(date=moment(date).format("YYYY-MM-DD"),lodash.findIndex(vm.groupe.periodes,function(periode){return periode.id!==vm.periode.id&&date>=periode.dateDebut&&date<=periode.dateFin})>-1)}function getTitle(){var dateDebut=$filter("date")(vm.periode.dateDebut);dateDebut=dateDebut?dateDebut:"?";var dateFin=$filter("date")(vm.periode.dateFin);return dateFin=dateFin?dateFin:"?",vm.isModeAjout?"Nouvelle période":"Période du "+dateDebut+" au "+dateFin}function onIsInscriptionLibreChange(formulaire){vm.onDateDebutChange()}function onDateDebutChange(){angular.isUndefined(vm.periode.dateDebut)||null===vm.periode.dateDebut||(vm.periode.dateDebut=moment(vm.periode.dateDebut).format("YYYY-MM-DD"),vm.periode.isInscriptionLibre&&(angular.isUndefined(vm.periode.dateLimiteInscription)||""===vm.periode.dateLimiteInscription||null===vm.periode.dateLimiteInscription)&&(vm.periode.dateLimiteInscription=moment(vm.periode.dateDebut).add(-1,"day").format("YYYY-MM-DD")))}function onDateFinChange(){angular.isUndefined(vm.periode.dateFin)||null===vm.periode.dateFin||(vm.periode.dateFin=moment(vm.periode.dateFin).format("YYYY-MM-DD"))}function onDateLimiteInscriptionChange(){angular.isUndefined(vm.periode.dateLimiteInscription)||null===vm.periode.dateLimiteInscription||(vm.periode.dateLimiteInscription=moment(vm.periode.dateLimiteInscription).format("YYYY-MM-DD"))}function isFormValid(formulaire){return vm.testDatesOK(formulaire)}function testDatesOK(){vm.isDatesInvalides="";try{if(angular.isUndefined(vm.periode.dateDebut))throw new Error("Vous devez choisir une date de début");if(angular.isUndefined(vm.periode.dateFin))throw new Error("Vous devez choisir une date de fin");if(vm.periode.dateDebut>vm.periode.dateFin)throw new Error("La date de début doit être inférieure ou égale à la date de fin");var isChevauchement=lodash.findIndex(vm.groupe.periodes,function(periodeATester){return vm.periode.id!==periodeATester.id&&moment(vm.periode.dateDebut).format("YYYY-MM-DD")<=periodeATester.dateFin&&moment(vm.periode.dateFin).format("YYYY-MM-DD")>=periodeATester.dateDebut})>-1;if(isChevauchement)throw new Error("La période choisie chevauche une période déjà existante du groupe")}catch(error){return vm.isDatesInvalides=error.message,!1}return!0}function inscrireEleve(eleve){if(lodash.findIndex(vm.periode.eleves,{id:eleve.id})>-1)return!1;var indiceNonInscrit=lodash.findIndex(vm.listeElevesNonInscrits,{id:eleve.id});return-1===indiceNonInscrit?!1:(vm.listeElevesNonInscrits.splice(indiceNonInscrit,1),void vm.periode.eleves.push(eleve))}function desinscrireEleve(eleve){if(lodash.findIndex(vm.listeElevesNonInscrits,{id:eleve.id})>-1)return!1;var indiceInscrit=lodash.findIndex(vm.periode.eleves,{id:eleve.id});return-1===indiceInscrit?!1:(vm.periode.eleves.splice(indiceInscrit,1),void vm.listeElevesNonInscrits.push(eleve))}function close(tabPeriodesUpdated){$uibModalInstance.close(tabPeriodesUpdated)}function openDatePicker(typeDate){switch(typeDate){case"dateDebut":vm.isDateDebutPickerOpen=!0;break;case"dateFin":vm.isDateFinPickerOpen=!0;break;case"dateLimiteInscription":vm.isDateLimiteInscriptionPickerOpen=!0}}function refresh(){vm.promiseContents=GroupesFlexiblesService.getListElevesPossiblesGroupeFlexible(vm.groupe.id).then(function(listeElevesPossibles){vm.listeElevesNonInscrits=lodash.filter(listeElevesPossibles,function(eleve){return-1===lodash.findIndex(vm.periode.eleves,{id:eleve.id})})})}var vm=this;vm.dateJour=moment().format("YYYY-MM-DD"),vm.groupe=groupe,vm.periodeDefault={nbElevesMax:0,dateDebut:vm.dateJour,dateFin:vm.dateJour,eleves:[]},vm.periode=angular.isDefined(periode)?angular.copy(periode):vm.periodeDefault,vm.isModeAjout=angular.isUndefined(periode),vm.datePickerOptions={dateFormat:"dd/MM/yyyy"},vm.isDateDebutPickerOpen=!1,vm.isDateFinPickerOpen=!1,vm.isDateLimiteInscriptionPickerOpen=!1,vm.listeElevesInscritsDisplay=vm.periode.eleves,vm.listeElevesNonInscrits=[],vm.listeElevesNonInscritsDisplay=[],vm.refresh=refresh,vm.getTitle=getTitle,vm.openDatePicker=openDatePicker,vm.close=close,vm.onDateDebutChange=onDateDebutChange,vm.onDateFinChange=onDateFinChange,vm.onDateLimiteInscriptionChange=onDateLimiteInscriptionChange,vm.onIsInscriptionLibreChange=onIsInscriptionLibreChange,vm.inscrireEleve=inscrireEleve,vm.desinscrireEleve=desinscrireEleve,vm.isDateDisable=isDateDisable,vm.testDatesOK=testDatesOK,vm.isFormValid=isFormValid,vm.savePeriode=savePeriode,vm.deletePeriode=deletePeriode,refresh()}]),angular.module("edsiteApp.GroupesFlexibles").service("GroupesFlexiblesService",["$q","$http","Auth","EDHttp",function($q,$http,Auth,EDHttp){function getGroupesFlexibles(dateDebut,dateFin,idEleve){var defer=$q.defer();idEleve=angular.isDefined(idEleve)?idEleve:0;var baseUrl="groupesFlexibles?idEleve="+idEleve,data={};return angular.isDefined(dateDebut)&&(data.dateDebut=dateDebut),angular.isDefined(dateFin)&&(data.dateFin=dateFin),new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function getDetailGroupeFlexible(idGroupe){var defer=$q.defer(),baseUrl="groupesFlexibles/"+idGroupe;return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function getListElevesPossiblesGroupeFlexible(idGroupe){var defer=$q.defer(),baseUrl="groupesFlexibles/"+idGroupe+"/elevesPossibles";return $http({method:"GET",url:baseUrl,data:{}}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function savePeriode(periode,idGroupe){var defer=$q.defer(),data=periode,baseUrl=periode.id>0?"groupesFlexibles/"+idGroupe+"/periode/"+periode.id:"groupesFlexibles/"+idGroupe+"/periodes";return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function deletePeriode(idPeriode,idGroupe){var defer=$q.defer(),data={},baseUrl="groupesFlexibles/"+idGroupe+"/periode/"+idPeriode;return $http({method:"DELETE",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function inscrireEleve(idEleve,idPeriode,idGroupe){var defer=$q.defer(),data={},baseUrl="groupesFlexibles/"+idGroupe+"/periode/"+idPeriode+"/inscription/"+idEleve;return $http({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}var mGroupesFlexibles={};return mGroupesFlexibles.getGroupesFlexibles=getGroupesFlexibles,mGroupesFlexibles.getDetailGroupeFlexible=getDetailGroupeFlexible,mGroupesFlexibles.getListElevesPossiblesGroupeFlexible=getListElevesPossiblesGroupeFlexible,mGroupesFlexibles.savePeriode=savePeriode,mGroupesFlexibles.deletePeriode=deletePeriode,mGroupesFlexibles.inscrireEleve=inscrireEleve,mGroupesFlexibles}]),angular.module("edsiteApp.Stages",["edsiteApp.Commun","ui.bootstrap"]).controller("StagesCtrl",["$scope","$timeout","$uibModal","lodash","StagesService","UserService","Auth","MessagerieService","ModuleService",function($scope,$timeout,$uibModal,lodash,StagesService,UserService,Auth,MessagerieService,ModuleService){function selectView(idView){vm.selected=idView}function onSelectClasse(classe){vm.currentClasse=classe,vm.promiseContents=StagesService.listeStages("Classe",classe.classeId).then(function(stages){vm.listeStageClasse=stages,vm.listeStageClasseDisplay=[].concat(vm.listeStageClasse)})}function isHimself(){return Auth.isHimself(vm.typeUser,vm.idUser)}function canSendMessageUser(){return MessagerieService.canSendMessageUser(Auth.TYPE_USER.ELEVE)}function openDetailEleve(stage,index,isPP){void 0===isPP&&(isPP=!1);var modalInstance=$uibModal.open({templateUrl:"modules/suiviStage/enseignant/detail-stage-eleve.html",controller:"DetailEleveCtrl as DetailEleveCtrl",backdrop:!1,size:"lg",resolve:{stage:function(){return angular.copy(stage)},isPP:function(){return isPP},CanWriteMessage:function(){return vm.canWriteMessage}}});modalInstance.result.then(function(stage){if(!angular.isUndefined(stage))if(isPP===!1){vm.listeStageDisplay[index]=stage;var stagePP=lodash.find(vm.listeStageClasseDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id===stage.eleve.id});angular.isDefined(stagePP)&&angular.extend(stagePP,stage),angular.forEach(lodash.filter(vm.listeStageClasseDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id!==stage.eleve.id}),function(stagePPAutre){angular.isDefined(stagePPAutre)&&angular.extend(stagePPAutre.entreprise.appreciations,stage.entreprise.appreciations)}),angular.forEach(lodash.filter(vm.listeStageDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id!==stage.eleve.id}),function(stageMesEleves){angular.isDefined(stageMesEleves)&&angular.extend(stageMesEleves.entreprise.appreciations,stage.entreprise.appreciations)})}else{vm.listeStageClasseDisplay[index]=stage;var stageTuteur=lodash.find(vm.listeStageDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id===stage.eleve.id});angular.isDefined(stageTuteur)?angular.isDefined(stage.tuteurEtablissement)&&stage.tuteurEtablissement.id===vm.idUser?angular.extend(stageTuteur,stage):refreshTuteur():angular.isDefined(stage.tuteurEtablissement)&&stage.tuteurEtablissement.id===vm.idUser&&refreshTuteur(),angular.forEach(lodash.filter(vm.listeStageDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id!==stage.eleve.id}),function(stageTuteurAutre){angular.isDefined(stageTuteurAutre)&&angular.extend(stageTuteurAutre.entreprise.appreciations,stage.entreprise.appreciations)}),angular.forEach(lodash.filter(vm.listeStageClasseDisplay,function(stg){return stg.id===stage.id&&stg.eleve.id!==stage.eleve.id}),function(stagePPOther){angular.isDefined(stagePPOther)&&angular.extend(stagePPOther.entreprise.appreciations,stage.entreprise.appreciations)})}})}function openDetailEntreprise(entreprise){$uibModal.open({templateUrl:"modules/suiviStage/detail-stage-entreprise.html",controller:"DetailEntrepriseCtrl as CtrlDetailEntreprise",backdrop:!0,size:"lg",resolve:{parametrage:function(){return vm.parametrage},entreprise:function(){return entreprise},context:function(){return"enseignant"}}})}function stopEvent(event){event.stopPropagation()}function refreshAll(){refreshTuteur(),refreshClasse(),refreshEntreprise()}function refreshTuteur(){vm.promiseContents=StagesService.listeStages("Tuteur",vm.idUser).then(function(stages){vm.listeStage=stages,vm.listeStageDisplay=[].concat(vm.listeStage)})}function refreshClasse(){angular.isUndefined(vm.classesPP)?vm.promiseContents=UserService.getClassesPP().then(function(classes){vm.classesPP=classes,vm.classesPP.length>0&&null===vm.currentClasse&&vm.onSelectClasse(vm.classesPP[0])}):null!==vm.currentClasse&&vm.onSelectClasse(vm.currentClasse)}function refreshEntreprise(){vm.entrepriseAll=!1,vm.promiseContents=StagesService.listeEntreprises("T",vm.idUser).then(function(entreprise){vm.listeEntreprise=entreprise,vm.listeEntrepriseDisplay=[].concat(vm.listeEntreprise)})}function refreshEntrepriseAll(){vm.entrepriseAll=!0,vm.promiseContents=StagesService.listeEntreprises("All","0").then(function(entreprise){vm.listeEntreprise=entreprise,vm.listeEntrepriseDisplay=[].concat(vm.listeEntreprise)})}var vm=this;vm.selectView=selectView,vm.onSelectClasse=onSelectClasse,vm.openDetailEleve=openDetailEleve,vm.openDetailEntreprise=openDetailEntreprise,vm.refreshTuteur=refreshTuteur,vm.refreshClasse=refreshClasse,vm.refreshEntreprise=refreshEntreprise,vm.refreshEntrepriseAll=refreshEntrepriseAll,vm.refreshAll=refreshAll,vm.isHimself=isHimself,vm.canSendMessageUser=canSendMessageUser,vm.stopEvent=stopEvent,vm.listeStage=[],vm.listeStageDisplay=[],vm.listeStageClasse=[],vm.listeStageClasseDisplay=[],vm.listeEntreprise=[],vm.listeEntrepriseDisplay=[],vm.currentClasse=null,vm.classesPP=void 0,vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.entrepriseAll=!1,vm.canWriteMessage=isHimself()&&canSendMessageUser(),vm.selected="Tuteur",vm.parametresSuiviStage=ModuleService.getModule(ModuleService.CODES.SUIVI_STAGE).params,vm.parametrage={AfficherLesEvaluations:"1"===vm.parametresSuiviStage.AfficherLesEvaluations,AfficherLeSuivi:"1"===vm.parametresSuiviStage.AfficherLeSuivi},refreshAll()}]),angular.module("edsiteApp.Stages").controller("StagesEleveCtrl",["$scope","$uibModal","$sce","StagesService","Auth","base64encodeFilter","MessagerieService",function($scope,$uibModal,$sce,StagesService,Auth,base64encodeFilter,MessagerieService){
function print(){return{data:base64encodeFilter(JSON.stringify(vm.filtre))}}function refreshResults($select){var search=$select.search,list=angular.copy($select.items);if(search)if(angular.isNumber(Number(search).toString()===search?Number(search):search)&&5===search.length){if(list.length>1){var villeInputItem={cp:search,ville:"Toutes les communes"};$select.items=[villeInputItem].concat(list)}}else list=list.filter(function(item){return"Toutes les communes"!==item.ville}),$select.items=list;else list=list.filter(function(item){return"Toutes les communes"!==item.ville}),$select.items=list}function onSelectSecteurActivite(secteurActivite){vm.filtre.secteurActivite=secteurActivite,reinitSearchFiltre("searchFiltreSecteurActivite")}function onSelectCodeNaf(codeNaf){vm.filtre.codeNaf=codeNaf,reinitSearchFiltre("searchFiltreCodeNaf")}function reinitSearchFiltre(idControl){angular.element(document.getElementById(idControl)).val(""),angular.element(document.getElementById(idControl)).controller("ngModel").$setViewValue("")}function onSelectStage(stage){vm.currentStage=stage,vm.lienGoogleMap=$sce.trustAsResourceUrl("https://www.google.fr/maps?z=12&t=k&f=q&hl=fr&output=embed&q="+vm.currentStage.entreprise.libelle+","+vm.currentStage.entreprise.ville+","+vm.currentStage.entreprise.adresse1)}function openDetailEntreprise(entreprise){$uibModal.open({templateUrl:"modules/suiviStage/detail-stage-entreprise.html",controller:"DetailEntrepriseCtrl as CtrlDetailEntreprise",backdrop:!0,size:"lg",resolve:{parametrage:function(){return vm.parametrage},entreprise:function(){return entreprise},context:function(){return"eleve"}}})}function selectView(idView){vm.selected=idView}function isHimself(){return Auth.isHimself(vm.typeUser,vm.idUser)}function canSendMessageUser(){return MessagerieService.canSendMessageUser(Auth.TYPE_USER.ENSEIGNANT)}function refreshStage(){vm.promiseContents=StagesService.listeStages("Eleve",vm.idUser).then(function(stage){vm.listeStage=stage,vm.listeStage.length>0&&vm.onSelectStage(vm.listeStage[0])})}function refreshEntreprise(){vm.promiseContents=StagesService.listeEntreprisesEleve(vm.filtre,vm.idUser).then(function(entreprise){vm.listeEntreprise=entreprise})}function refreshEntrepriseFiltre(){vm.promiseContents=StagesService.listeEntreprisesFiltre().then(function(entrepriseFiltre){vm.listeSecteurActivite=entrepriseFiltre.secteurActivite,vm.listeCodeNaf=entrepriseFiltre.codeNaf,vm.listeCodePostal=entrepriseFiltre.codePostal})}function refreshAll(){refreshEntrepriseFiltre(),refreshStage()}var vm=this;vm.print=print,vm.onSelectSecteurActivite=onSelectSecteurActivite,vm.onSelectCodeNaf=onSelectCodeNaf,vm.onSelectStage=onSelectStage,vm.refreshEntreprise=refreshEntreprise,vm.refreshResults=refreshResults,vm.refreshStage=refreshStage,vm.openDetailEntreprise=openDetailEntreprise,vm.selectView=selectView,vm.isHimself=isHimself,vm.canSendMessageUser=canSendMessageUser,vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.selected="RechEntreprise",vm.currentStage=null,vm.listeStage=[],vm.listeEntreprise=[],vm.listeEntrepriseDisplay=[],vm.listeCodePostal=[],vm.listeCodeNaf=[],vm.listeSecteurActivite=[],vm.filtre={secteurActivite:{},codeNaf:{},codePostal:[]},vm.canWriteMessage=isHimself()&&canSendMessageUser(),vm.parametrage={AfficherLesEvaluations:!1,AfficherLeSuivi:!1},$(".dropdown-menu").find("input").click(function(e){e.stopPropagation()}),refreshAll()}]),angular.module("edsiteApp.Stages").controller("DetailEleveCtrl",["$scope","Auth","$uibModalInstance","$uibModal","stage","isPP","CanWriteMessage","StagesService","Notification","$sce","MessagerieService",function($scope,Auth,$uibModalInstance,$uibModal,stage,isPP,CanWriteMessage,StagesService,Notification,$sce,MessagerieService){function close(stage){$uibModalInstance.close(stage)}function openDatePicker(typeDate){vm.isDateVisitePickerOpen="dateVisite"===typeDate}function composeSelectionEnseignant(toCcCci,opts,destinataires){var modalInstance=$uibModal.open({templateUrl:"modules/suiviStage/enseignant/selection.enseignant.template.html",controller:"ComposeSelectionEnseignantCtrl",size:"lg",backdrop:!1,windowClass:"dialog-compose-enseignant",resolve:{options:function(){var options={};return options.classes=[],angular.extend(options,opts),options},destinataires:function(){return destinataires},toCcCci:function(){return toCcCci}}});modalInstance.result.then(vm.addTuteurStage)}function addTuteurStage(monTuteur){return angular.isDefined(monTuteur)&&(vm.stage.tuteurEtablissement=monTuteur),vm.stage}function onSelectRanking(rating,index){angular.isDefined(vm.stage.entreprise.appreciations[index])&&(vm.stage.entreprise.appreciations[index].note=rating)}function saveStageEleve(form){vm.setValidationDate(vm.stage.dateVisite,form.dateVisite)&&(form.$invalid||(angular.isDefined(vm.stage.dateVisite)&&(vm.stage.dateVisite=moment(vm.stage.dateVisite).format("YYYY-MM-DD")),vm.promiseContents=StagesService.modifierStage(vm.stage).then(function(stages){Notification.notify("Suivi des stages","Votre modification a bien été prise en compte","success",!0),vm.close(stages)},function(error){Notification.notify("Suivi des stages",error.message||"Une erreur est survenue","error",!0)})))}function setValidationDate(date,dateForm){return angular.isDefined(date)&&null!==date&&!angular.isDate(date)?(dateForm.$setValidity("notValidDate",!1),!1):(null===date&&delete vm.stage.dateVisite,dateForm.$setValidity("notValidDate",!0),!0)}var vm=this;vm.stage=stage,vm.stage.dateVisite=angular.isDefined(vm.stage.dateVisite)?new Date(vm.stage.dateVisite):void 0,vm.isPP=isPP,vm.Auth=Auth,vm.isDateVisitePickerOpen=!1,vm.lienGoogleMap=$sce.trustAsResourceUrl("https://www.google.fr/maps?z=12&t=k&f=q&hl=fr&output=embed&q="+vm.stage.entreprise.libelle+","+vm.stage.entreprise.ville+","+vm.stage.entreprise.adresse1),vm.CanWriteMessage=CanWriteMessage,vm.close=close,vm.composeSelectionEnseignant=composeSelectionEnseignant,vm.addTuteurStage=addTuteurStage,vm.openDatePicker=openDatePicker,vm.onSelectRanking=onSelectRanking,vm.saveStageEleve=saveStageEleve,vm.setValidationDate=setValidationDate}]),angular.module("edsiteApp.Stages").controller("DetailEntrepriseCtrl",["$uibModalInstance","parametrage","entreprise","context","Auth","$sce",function($uibModalInstance,parametrage,entreprise,context,Auth,$sce){function close(){$uibModalInstance.close()}function onSelectAnneeScolaireHisto(anneeScol){vm.anneeScolaireSelected=anneeScol}var vm=this;vm.onSelectAnneeScolaireHisto=onSelectAnneeScolaireHisto,vm.close=close,vm.context=context,vm.entreprise=entreprise,vm.parametrage=parametrage,vm.listeIntervenantDisplay=[],vm.listeIntervenant=entreprise.intervenantEntreprise,vm.listeOffreStageDisplay=[],vm.listeOffreStage=entreprise.offreStage,vm.listeHistoriqueStage=entreprise.historiqueStage,vm.lienGoogleMap=$sce.trustAsResourceUrl("https://www.google.fr/maps?z=12&t=k&f=q&hl=fr&output=embed&q="+vm.entreprise.libelle+","+vm.entreprise.ville+","+vm.entreprise.adresse1)}]),angular.module("edsiteApp.Stages").service("StagesService",["$q","$http","EDHttp",function($q,$http,EDHttp){function listeStages(pType,id){var defer=$q.defer(),baseUrl=pType+"/"+id+"/stages",data={};return $http({method:"GET",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function listeEntreprises(entityType,entityId){var defer=$q.defer(),baseUrl=entityType+"/"+entityId+"/entreprises",data={};return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function listeEntreprisesFiltre(){var defer=$q.defer(),baseUrl="entreprisesFiltres",data={};return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function listeEntreprisesEleve(listeFiltre,entityId){var defer=$q.defer(),baseUrl="eleve/"+entityId+"/entreprises",data=listeFiltre;return new EDHttp({method:"POST",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise}function modifierStage(stage){var defer=$q.defer(),data=stage,baseUrl="stage/"+stage.id;return $http({method:"PUT",url:baseUrl,data:data}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error.data)}),defer.promise}var Helper={};return Helper.listeStages=listeStages,Helper.listeEntreprises=listeEntreprises,Helper.modifierStage=modifierStage,Helper.listeEntreprisesFiltre=listeEntreprisesFiltre,Helper.listeEntreprisesEleve=listeEntreprisesEleve,Helper}]),angular.module("edsiteApp.Commun").directive("edMessageTo",["$uibModal",function($uibModal){return{restrict:"A",scope:{typeContact:"=",listContact:"="},link:function(scope,element){element.css("cursor","pointer"),element.bind("click",function($event){$event.preventDefault();$uibModal.open({templateUrl:"scripts/directives/EDMessageTo/EDMessageTo.html",controller:"EDMessageToCtrl as EDMessageToCtrl",backdrop:!0,size:"md",resolve:{typeContact:function(){return scope.typeContact},listContact:function(){return scope.listContact}}})})}}}]).controller("EDMessageToCtrl",["$uibModalInstance","Auth","MessagerieService","Notification","typeContact","listContact",function($uibModalInstance,Auth,MessagerieService,Notification,typeContact,listContact){function close(){$uibModalInstance.close()}function aucunA(groupes){if(!groupes||0===groupes.length)return!0;for(var resultat=!0,i=0;i<groupes.length;i++){for(var lesDest=groupes[i].destinataires,j=0;j<lesDest.length;j++){var dest=lesDest[j];if("to"===dest.to_cc_cci){resultat=!1;break}}if(!resultat)break}return resultat}function sendMessage(message){vm.promiseLoading=MessagerieService.sendMessage(vm.typeUser,vm.idUser,message).then(function(){Notification.notify("Message","Votre message a bien été envoyé","success","fa icon-ed_messagerie"),vm.close()},function(){Notification.notify("Message","Une erreur s'est produite lors de l'envoi de votre message","error","fa icon-ed_messagerie")})}$("#object").focus();var vm=this;vm.idUser=Auth.currentUser().id,vm.typeUser=Auth.currentUser().typeCompte,vm.typeContact=typeContact,vm.message={},vm.message.groupesDestinataires=[],vm.message.files=[],vm.listContact=listContact||[],vm.close=close;var groupeDestinataire={};groupeDestinataire.destinataires=vm.listContact.map(function(user){return MessagerieService.convertUserToContact(user)}),vm.message.groupesDestinataires.push(groupeDestinataire),vm.editorOptions={height:300,toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image,DiagPlWs",toolbar_full:[{name:"basicstyles",items:["Bold","Italic","Strike","Underline"]},{name:"links",items:["Link","Unlink","base64image"]},{name:"paragraph",items:["BulletedList","NumberedList"]},{name:"editing",items:["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"]},{name:"styles",items:["FontSize","TextColor","PasteText","PasteFromWord"]}],removePlugins:"elementspath",startupFocus:!1},vm.aucunA=aucunA,vm.sendMessage=sendMessage}]),angular.module("edsiteApp.Stages").controller("ComposeSelectionEnseignantCtrl",["$scope","$uibModalInstance","options","destinataires","toCcCci","MessagerieService","lodash","Auth","UserService",function($scope,$uibModalInstance,options,destinataires,toCcCci,MessagerieService,lodash,Auth,UserService){function close(){$uibModalInstance.close()}function getAllPP(){$scope.showallPP=!0,$scope.selection.isPP=!1,$scope.promiseLoading=MessagerieService.getProfsPrincipauxContacts($scope.selection).then(function(contacts){$scope.destinatairesCache=angular.copy(contacts),$scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.ENSEIGNANT})})}function getClasses(){Auth.isPersonnel()||Auth.isProfesseur()?$scope.promiseLoading=UserService.getClassesAllByNiveauxByEtabs().then(function(etabs){etabs=lodash.uniq(etabs,function(etab){return etab.etabId+"_"+etab.niveauId+"_"+etab.classeId}),$scope.etablissements=etabs,$scope.etablissements.unshift({optionLibelle:"Tous les profs des établissements",id:0,optionType:"etab"})}):$scope.selection.classes=Auth.getClasses(),1===$scope.selection.classes.length&&($scope.selection.classe=$scope.selection.classes[0])}$scope.classes=options.classes,$scope.selection=options,$scope.destinatairesCache=[],$scope.destinataires=destinataires||[],$scope.displayedDestinataires=[].concat($scope.destinataires),$scope.oneIsSelected=!1,$scope.requestLoading=!1,$scope.showallPP=!1,this.objDestinataires={},$scope.close=close,$scope.getAllPP=getAllPP,$scope.isPP=MessagerieService.isPP,$scope.displayMatiere=MessagerieService.displayMatiere,$scope.btnLibelleAjout="Ajouter le tuteur sélectionné",$scope.classe&&($scope.selection.classe=lodash.find(options.classes,{libelle:options.classe.libelle})),$scope.search=function(force){$scope.showallPP=!1,$scope.selection.isPP=!1,$scope.requestLoading=!0,$scope.promiseLoading=MessagerieService.getProfsContacts($scope.selection).then(function(contacts){$scope.destinatairesCache=angular.copy(contacts),$scope.destinataires=contacts,angular.forEach($scope.destinataires,function(dest){dest.type=Auth.TYPE_USER.ENSEIGNANT,dest.isSelected=!1}),$scope.requestLoading=!1},function(){$scope.requestLoading=!1}),$scope.selection.classe&&($scope.destinataires=lodash.where($scope.destinataires,{classe:{id:$scope.selection.classe.id}}))},$scope.filterPP=function(){$scope.selection.isPP&&angular.isUndefined($scope.selection.classe.optionType)?$scope.destinataires=lodash.filter($scope.destinataires,{classes:[{isPP:!0}]}):$scope.selection.isPP&&"classe"===$scope.selection.classe.optionType?$scope.destinataires=lodash.filter($scope.destinataires,{classes:[{isPP:!0}]}):!$scope.selection.isPP||"niveau"!==$scope.selection.classe.optionType&&"etab"!==$scope.selection.classe.optionType?$scope.destinataires=angular.copy($scope.destinatairesCache):$scope.destinataires=lodash.filter($scope.destinataires,{isPP:!0})},$scope.selectDestinataire=function(destinataire,updateDest){void 0===destinataire.isSelected&&(destinataire.isSelected=!1),updateDest&&(destinataire.isSelected=!destinataire.isSelected),destinataire.isSelected?destinataire.to_cc_cci=toCcCci:destinataire.to_cc_cci="";var selectedDest=lodash.filter($scope.destinataires,{isSelected:!0});$scope.oneIsSelected=selectedDest&&1===selectedDest.length?!0:!1,$uibModalInstance.close(destinataire)},$scope.selectEtab=function(etab){$scope.selection.classe=etab,$scope.search()},$scope.selectNiveau=function(niveau){$scope.selection.classe=niveau,$scope.search()},$scope.selectClasse=function(classe){$scope.selection.classe=classe,$scope.search()},getClasses(),$scope.search()}]),angular.module("edsiteApp.Commun").directive("starRating",function(){return{restrict:"EA",template:'<ul class="star-rating" ng-class="{readonly: !canRate}">  <li ng-repeat="star in stars" class="star" ng-class="{filled: star.filled}" ng-click="toggle($index, star)">    <i class="fa fa-star"></i>  </li></ul>',scope:{ratingValue:"=ngModel",max:"=?",onRatingSelected:"&?",canRate:"=?"},link:function(scope,element,attributes){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({filled:i<scope.ratingValue})}void 0===scope.max&&(scope.max=5),scope.canRate===!0&&(scope.toggle=function(index,star){var starRate=0;starRate=star.filled&&scope.ratingValue===index+1?index:index+1,scope.ratingValue=starRate,scope.onRatingSelected({rating:starRate})}),scope.$watch("ratingValue",function(oldValue,newValue){(newValue||0===newValue)&&updateStars()})}}}).directive("averageStarRating",function(){return{restrict:"EA",template:'<div class="average-rating-container">  <ul class="star-rating background" class="readonly">    <li ng-repeat="star in stars" class="star">      <i class="fa fa-star"></i>    </li>  </ul>  <ul class="star-rating foreground" class="readonly" style="width:{{filledInStarsContainerWidth}}%">    <li ng-repeat="star in stars" class="star filled">      <i class="fa fa-star"></i>    </li>  </ul></div>',scope:{averageRatingValue:"=ngModel",max:"=?"},link:function(scope,elem,attrs){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({});var starContainerMaxWidth=100;scope.filledInStarsContainerWidth=scope.averageRatingValue/scope.max*starContainerMaxWidth}void 0===scope.max&&(scope.max=5),scope.$watch("averageRatingValue",function(oldVal,newVal){(newVal||0===newVal)&&updateStars()})}}}).controller("RatingController",function(){this.rateFunction=function(rating){console.log("Rating selected: "+rating)}}),angular.module("edsiteApp").directive("edLightbox",["$uibModal",function($uibModal){return{restrict:"A",scope:{file:"=",options:"=",listFiles:"="},link:function(scope,element){element.on("click",function(){$uibModal.open({templateUrl:"scripts/directives/edLightbox/edLightbox.html",controller:"EDLightboxDirectiveController",controllerAs:"edLightboxController",size:"lg",backdrop:!0,resolve:{listFiles:function(){return scope.listFiles},file:function(){return scope.file},options:function(){return scope.options}}})})}}}]).controller("EDLightboxDirectiveController",["$scope","EDHttp","listFiles","file","options","$uibModalInstance","lodash","CloudService","$timeout",function($scope,EDHttp,listFiles,file,options,$uibModalInstance,lodash,CloudService,$timeout){function loadImage(file){var data={leTypeDeFichier:"CLOUD",fichierId:file.id},baseUrl="telechargement";vm.promiseLoading=new EDHttp({method:"POST",url:baseUrl,params:data,data:{forceDownload:0},cache:!0,responseType:"blob"}).then(function(response){var reader=new FileReader;reader.onloadend=function(event){vm.file=file,vm.imgDataSrc=reader.result,$scope.$apply()},reader.readAsDataURL(response.data)},function(error){vm.file=file,console.log("error",error)})}function loadNext(step){1!==this.listFiles.length&&(step=angular.isDefined(step)?step:1,vm.currentIndex+step>=vm.listFiles.length?vm.currentIndex=vm.currentIndex+step-vm.listFiles.length:vm.currentIndex+step<0?vm.currentIndex=vm.listFiles.length-(-step-vm.currentIndex):vm.currentIndex+=step,vm.loadImage(vm.listFiles[vm.currentIndex]))}function close(){$uibModalInstance.dismiss()}function onKeyPress(event){"ArrowLeft"===event.key||"Left"===event.key?this.loadNext(-1):("ArrowRight"===event.key||"Right"===event.key)&&this.loadNext(1)}function refresh(){vm.listFiles=lodash.filter(vm.listFiles,function(file){return CloudService.isImage(file)}),vm.currentIndex=lodash.findIndex(vm.listFiles,function(f){return f.id===file.id}),vm.loadImage(vm.file)}var vm=this;vm.file=file,vm.listFiles=angular.isDefined(listFiles)?listFiles:[],vm.currentIndex=0,vm.options=options,vm.promiseLoading=null,vm.imgDataSrc="",vm.loadImage=loadImage,vm.close=close,vm.loadNext=loadNext,vm.onKeyPress=onKeyPress,vm.refresh=refresh,$timeout(function(){angular.element("div#edLightbox").get(0).focus()},500),refresh()}]),angular.module("edsiteApp.AideEnLigne",["edsiteApp.Commun","ui.bootstrap"]).controller("AideEnLigneCtrl",["AideEnLigneService",function(AideEnLigneService){function refresh(){vm.promiseContents=AideEnLigneService.get().then(function(data){vm.aides=data})}var vm=this;vm.refresh=refresh,refresh()}]),angular.module("edsiteApp.AideEnLigne").service("AideEnLigneService",["$q","$http","Auth","EDHttp",function($q,$http,Auth,EDHttp){var mAidesEnLigne={};return mAidesEnLigne.get=function(){var defer=$q.defer(),data={},contexte="";Auth.isEleve()?contexte="Eleve":Auth.isFamille()?contexte="Famille":Auth.isProfesseur()?contexte="Professeur":Auth.isPersonnel()&&(contexte="Personnel");var baseUrl="aidesenligne/"+contexte;return EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},mAidesEnLigne}]),angular.module("edsiteApp.QCM",["cgBusy","ui.bootstrap","ng-sortable","ckeditor","edsiteApp.Commun","edsiteApp.filterTranslateTypeUser","edsiteApp.modals","edsiteApp.base64filter"]).directive("contenteditable",["$sce",function($sce){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){function read(){var html=element.html();!attrs.stripBr||"<br>"!==html&&"<br/>"!==html&&"<br />"!==html||(html=""),ngModel.$setViewValue(html)}ngModel.$render=function(){element.html($sce.getTrustedHtml(ngModel.$viewValue||"")),read()},element.on("blur keyup change",function(){scope.$evalAsync(read)})}}}]).directive("execCommandButton",[function(){return{link:function(scope,element){element.attr("unselectable","on"),element.on("mousedown",function(e,eventData){return eventData&&angular.extend(e,eventData),e.preventDefault(),!1})}}}]).directive("hasTexthole",function(){return{restrict:"A",require:["^form","ngModel"],link:function(scope,element,attrs,ctrls){ctrls[1].$validators.hasTexthole=function(){var strongTag=angular.element(element.find("strong")),bTag=angular.element(element.find("b")),total=strongTag.length+bTag.length;return total>0?(ctrls[0][attrs.errorChamp].$setValidity("hasTexthole",!0),!0):(ctrls[0][attrs.errorChamp].$setValidity("hasTexthole",!1),!1)}}}}).directive("hasEnoughGoodPropositions",["$parse",function($parse){return{restrict:"A",require:"^form",link:function(scope,element,attrs,leForm){var model=$parse(attrs.hasEnoughGoodPropositions);scope.$watch(model,function(value){var combien=value.filter(function(e){return e.valide}).length;0===combien||combien>attrs.max?leForm[attrs.errorChamp].$setValidity("hasEnoughGoodPropositions",!1):leForm[attrs.errorChamp].$setValidity("hasEnoughGoodPropositions",!0);var combienVide=value.filter(function(e){return angular.isUndefined(e.enonceDecode)||""===e.enonceDecode}).length;combienVide>0?leForm[attrs.errorChamp].$setValidity("hasEnoughGoodPropositionsRequired",!1):leForm[attrs.errorChamp].$setValidity("hasEnoughGoodPropositionsRequired",!0)},!0)}}}]).directive("radioEqual",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){ngModelCtrl&&(ngModelCtrl.$validators.radioEqual=function(modelValue){return ngModelCtrl.$isEmpty(attrs.radioEqual)?!0:ngModelCtrl.$isEmpty(modelValue)?!1:modelValue.toString()===attrs.radioEqual.toString()})}}}).directive("checkboxEquals",["$parse","lodash",function($parse,lodash){return{restrict:"A",require:"^form",link:function(scope,element,attrs,leForm){var model=$parse(attrs.checkboxEquals);scope.$watch(model,function(value){var solutions=$parse(attrs.lesSolutions)(scope),isEqual=lodash.isEqual(lodash.sortBy(solutions),lodash.sortBy(value));leForm.$setValidity("checkboxEquals",isEqual)},!0)}}}]).directive("textholeEqual",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){function getCleanValue(txt){return txt&&txt.toString()||txt}ngModelCtrl&&(ngModelCtrl.$validators.textholeEqual=function(modelValue){return ngModelCtrl.$isEmpty(attrs.textholeEqual)?!0:ngModelCtrl.$isEmpty(modelValue)?!1:getCleanValue(modelValue)===getCleanValue(attrs.textholeEqual)})}}}).directive("compileTemplateWithModels",["$compile","$parse",function($compile,$parse){return{restrict:"A",link:function(scope,element,attr){function getStringValue(){return(parsed(scope)||"").toString()}var parsed=$parse(attr.ngBindHtml);scope.$watch(getStringValue,function(){$compile(element,null,-9999)(scope)})}}}]).filter("replaceFormulaQuestionProp",function(){return function(input){if(!input||""===input)return input;var resultat=input,formules=resultat.match(/#(.*?)#/g);if(!formules||0===formules.length)return input;formules.map(function(val,index){var to=val.replace(/#/g,"");return to='<span class="math-tex">\\('+to+"\\)</span>",resultat=resultat.replace(formules[index],to),to});return resultat}}).directive("mathtexcompile",["$timeout",function($timeout){return function(scope,element,attrs){scope.$watch(function(scope){return scope.$eval(attrs.mathtexcompile)},function(value){angular.isUndefined(value)&&(value=""),element.html(value),$timeout(function(){MathJax.Hub.Typeset(element[0])})})}}]),angular.module("edsiteApp.QCM").factory("QCMService",["$q","$http","$filter","$sessionStorage","lodash","moment","Auth","EDHttp",function($q,$http,$filter,$sessionStorage,lodash,moment,Auth,EDHttp){var orderDefaultPos=16384,Helper={};return Helper.SCHMURTZ="¤",Helper.NEW_QCM={id:0,baremeBR:1,baremeAR:0,baremeMR:-1,guid:"",nbQuestions:0,etiquettes:[],evaluations:[],travauxafaire:[]},Helper.NEW_QUESTION={id:0,propositions:[]},Helper.NEW_TAG={id:0,libelle:"",badge:0},Helper.TYPE_ASSOCIATION={CDT:"CDT",EVALUATION:"EVALUATION"},Helper.TYPE_QUESTIONS={radio:{id:"radio",libelle:"Choix unique"},checkbox:{id:"checkbox",libelle:"Choix multiples"},textholes:{id:"textholes",libelle:"Texte à trous"}},Helper.FORM_STATUS={NOT_SUBMITTED:"NOT_SUBMITTED",DISPLAY_CORRECTIF:"DISPLAY_CORRECTIF"},Helper.TYPE_REPONSES={BR:"BR",MR:"MR",AR:"AR"},Helper.getCleanValue=function(txt){return txt&&txt.toString()||txt},Helper.addNewQuestion=function(tableau){var newAsk=angular.copy(Helper.NEW_QUESTION);return newAsk.ordre=0===tableau.length?orderDefaultPos:tableau[tableau.length-1].ordre+orderDefaultPos,newAsk},Helper.generatePosOrder=function(tableau,index){var pos,tailleTab=tableau.length;return pos=0===index&&1===tailleTab?orderDefaultPos:0===index&&tailleTab>1?tableau[1].ordre/2:index===tailleTab-1?tableau[index-1].ordre+orderDefaultPos:(tableau[index-1].ordre+tableau[index+1].ordre)/2},Helper.setChoosenAnneeQCMs=function(annee){annee&&($sessionStorage.anneeQCMsCourant=annee)},Helper.getChoosenAnneeQCMs=function(){return $sessionStorage.anneeQCMsCourant},Helper.getAnneesQCMsArchive=function(){var anneeScolaireCourante=Auth.anneeScolaireCourante(),resultat=[anneeScolaireCourante],dates=anneeScolaireCourante.split("-"),oldAnnee=parseInt(dates[0])-1+"-"+(parseInt(dates[1])-1);return resultat.unshift(oldAnnee),resultat},Helper.isAnneeCourante=function(){var choosenAnneeQCMs=Helper.getChoosenAnneeQCMs(),anneesQCMsArchive=Helper.getAnneesQCMsArchive();return angular.isUndefined(choosenAnneeQCMs)||choosenAnneeQCMs===anneesQCMsArchive[1]},Helper.getQCMs=function(typeUser,idUser,idsE){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()};angular.isDefined(idsE)&&(data.etiquettes=idsE);var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.saveQCM=function(typeUser,idUser,qcm){return qcm.id>0?Helper.editQCM(typeUser,idUser,qcm):Helper.createQCM(typeUser,idUser,qcm)},Helper.createQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms";return $http({method:"POST",url:baseUrl,data:{qcm:qcm}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.editQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id;return $http({method:"PUT",url:baseUrl,data:{qcm:qcm}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.cloneQCM=function(typeUser,idUser,oldId,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+oldId,data={anneeQCMs:Helper.getChoosenAnneeQCMs(),qcm:qcm};return $http({method:"COPY",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.updateEtiquettes=function(typeUser,idUser,qcm,etiquettes){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id,data={action:"updateEtiquettes",etiquettes:etiquettes};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.startQCM=function(typeUser,idUser,qcm,idAssociation){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id,data={action:"startQCM",idAssociation:idAssociation};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.stopQCM=function(typeUser,idUser,qcm,idAssociation){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id,data={action:"stopQCM",idAssociation:idAssociation};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerQCMs=function(typeUser,idUser,ids){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms",data={anneeQCMs:Helper.getChoosenAnneeQCMs(),ids:ids};return $http({method:"DELETE",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id,data={anneeQCMs:Helper.getChoosenAnneeQCMs()};return $http({method:"DELETE",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getQuestions=function(typeUser,idUser,qcm){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.saveQuestion=function(typeUser,idUser,qcm,question,duplicate){return question.id>0?Helper.editQuestion(typeUser,idUser,qcm,question):Helper.createQuestion(typeUser,idUser,qcm,question,duplicate)},Helper.createQuestion=function(typeUser,idUser,qcm,question,duplicate){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser);angular.isUndefined(duplicate)&&(duplicate=!1);var baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions";return $http({method:"POST",url:baseUrl,data:{question:question,duplicate:duplicate}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.editQuestion=function(typeUser,idUser,qcm,question){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions/"+question.id;return $http({method:"PUT",url:baseUrl,data:{question:question}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerQuestions=function(typeUser,idUser,qcm,ids){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions",data={ids:ids};return $http({method:"DELETE",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerQuestion=function(typeUser,idUser,qcm,question){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions/"+question.id;return $http({method:"DELETE",url:baseUrl,data:{}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.updateQuestionOrdre=function(typeUser,idUser,qcm,question){
var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions/"+question.id,data={action:"updateordre",question:question};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerQuestionSon=function(typeUser,idUser,qcm,question){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions/"+question.id,data={action:"supprimeson",question:question};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.updateQuestionSon=function(typeUser,idUser,qcm,question){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/questions/"+question.id,data={action:"updateson",question:question};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getParticipantQuestionnaire=function(typeUser,idUser,idQCM,idAssociation,isNational){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()};isNational=isNational||!1;var pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/"+(isNational?"national/":"")+"qcms/"+idQCM+"/associations/"+idAssociation;return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getAssociationsPotentielles=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations";return $http({method:"GET",url:baseUrl,data:{}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getQCMSEleveEvalues=function(idUser){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")("E"),baseUrl=pTypeUser+"/"+idUser+"/qcms/0/associations";return $http({method:"GET",url:baseUrl,data:{}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.supprimerAssociation=function(typeUser,idUser,qcm,id){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations/"+id;return $http({method:"DELETE",url:baseUrl,data:{}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.associerDevoir=function(typeUser,idUser,qcm,devoir){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations";return $http({method:"POST",url:baseUrl,data:{idEntite:devoir.idEntite,typeEntite:Helper.TYPE_ASSOCIATION.EVALUATION}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.associerTAF=function(typeUser,idUser,qcm,taf){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations";return $http({method:"POST",url:baseUrl,data:{idEntite:taf.idEntite,typeEntite:Helper.TYPE_ASSOCIATION.CDT}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.saveParticipantReponse=function(typeUser,idUser,qcm,association,participant,reponse){var defer=$q.defer(),data={reponse:reponse},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations/"+association.id+"/participants/"+participant.idParticipant+"/reponse/"+reponse.id;return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.setStartDateQCMEleve=function(typeUser,idUser,qcm,association,participant){var defer=$q.defer(),data={action:"updateStartDate"},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations/"+association.id+"/participants/"+participant.idParticipant;return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.setEndDateQCMEleve=function(typeUser,idUser,qcm,association,participant){var defer=$q.defer(),data={action:"updateEndDate"},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id+"/associations/"+association.id+"/participants/"+participant.idParticipant;return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getTaxonomie=function(typeUser,idUser){var defer=$q.defer(),data={},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/taxonomie";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},Helper.getQCMsNational=function(typeUser,idUser,idTaxonomie,searchTerm){var defer=$q.defer(),data={search:angular.isDefined(searchTerm)?searchTerm:""},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/national/"+idTaxonomie+"/qcms";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.shareQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+qcm.id,data={share:!0,qcm:qcm};return $http({method:"COPY",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.reuseQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/national/qcms/"+qcm.id;return $http({method:"COPY",url:baseUrl,data:{qcm:qcm}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.rateQCM=function(typeUser,idUser,qcm,rating){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/national/qcms/"+qcm.id,data={action:"rateQCM",rating:rating};return $http({method:"PATCH",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.unshareQCM=function(typeUser,idUser,qcm){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/national/qcms/"+qcm.id,data={guid:qcm.guid};return $http({method:"DELETE",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getResultatsQuestionnaire=function(typeUser,idUser,idQCM,idAssociation){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+idQCM+"/associations/"+idAssociation+"/resultats";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getResultatQuestionnaire=function(typeUser,idUser,idQCM,idAssociation){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/"+idQCM+"/associations/"+idAssociation+"/resultat";return $http({method:"GET",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.getEtiquettes=function(typeUser,idUser){var defer=$q.defer(),data={anneeQCMs:Helper.getChoosenAnneeQCMs()},pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/etiquettes";return new EDHttp({method:"GET",url:baseUrl,data:data,cache:!0}).then(function(response){defer.resolve(response.data.data)},function(error){defer.reject(error)}),defer.promise},Helper.supprimerTag=function(typeUser,idUser,tag){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/etiquettes",data={anneeQCMs:Helper.getChoosenAnneeQCMs(),ids:[tag.id]};return $http({method:"DELETE",url:baseUrl,data:data}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper.manageTag=function(typeUser,idUser,tag){var defer=$q.defer(),pTypeUser=$filter("translateTypeUserUrl")(typeUser),baseUrl=pTypeUser+"/"+idUser+"/qcms/etiquettes";return $http({method:"POST",url:baseUrl,data:{etiquette:tag}}).success(function(response){defer.resolve(response.data)}).error(function(error){defer.reject(error)}),defer.promise},Helper}]),angular.module("edsiteApp.QCM").controller("QCMSCtrl",["$q","$routeParams","$filter","$uibModal","lodash","QCMService","ModuleService","UserService","Notification","CacheService",function($q,$routeParams,$filter,$uibModal,lodash,QCMService,ModuleService,UserService,Notification,CacheService){function getQCMs(selectedTags){angular.isUndefined(selectedTags)?vm.sousTitre="":vm.sousTitre=selectedTags.length>0?"Les QCM correspondants":"Les QCM sans étiquette";var lesPromises=[];lesPromises.push(QCMService.getQCMs(vm.typeUser,vm.idUser,selectedTags)),lesPromises.push(QCMService.getEtiquettes(vm.typeUser,vm.idUser)),vm.promiseLoading=$q.all(lesPromises).then(function(data){UserService.getProfClassesGroupesTree().then(function(cg){lodash.forEach(data[0],function(qcm){lodash.forEach(qcm.evaluations,function(evaluation){var entity;if(evaluation.idGroupe>0?entity=lodash.find(cg,{id:parseInt(evaluation.idGroupe),type:"G"}):evaluation.idClasse>0&&(entity=lodash.find(cg,{id:parseInt(evaluation.idClasse),type:"C"})),angular.isDefined(entity)){evaluation.sousTitre=entity.libelle;var periode=lodash.find(entity.periodes,{codePeriode:evaluation.periode});if(angular.isDefined(periode)){evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+periode.libelle:periode.libelle;var matiere=lodash.find(periode.matieres,{code:evaluation.codeMatiere,codeSSMatiere:evaluation.codeSSMatiere});angular.isDefined(matiere)&&(evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+matiere.libelle:matiere.libelle)}}})}),vm.qcms=data[0],vm.etiquettes=lodash.sortBy(data[1],"libelle")})["catch"](function(_err){vm.qcms=data[0],vm.etiquettes=lodash.sortBy(data[1],"libelle")})})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération de vos QCM","error","icon-ed_qcm")})}function manageQCM(qcm){var editQCM=angular.isUndefined(qcm)?angular.extend({},QCMService.NEW_QCM,{idAuteur:vm.idUser}):qcm,modalInstance=$uibModal.open({templateUrl:"modules/qcm/enseignant/qcms/qcm-manage.html",controller:"QCMManageCtrl as ctrl",backdrop:"static",size:"lg",resolve:{qcm:function(){return editQCM},ckConf:function(){return vm.editorOptions},prolexisEnable:function(){return"1"===paramsModule.params.prolexisEnable}}});modalInstance.result.then(function(qcmAdded){if(angular.isDefined(qcmAdded)&&vm.isAnneeCourante()){var elemIndex=lodash.findIndex(vm.qcms,{id:qcmAdded.id});-1===elemIndex?vm.qcms.unshift(qcmAdded):(vm.qcms[elemIndex]=qcmAdded,initPage(vm.currentEtiquettes))}})}function displayAll(){initPage(void 0)}function orphanTag(){initPage([])}function toggleTag(id){angular.isUndefined(vm.currentEtiquettes)&&(vm.currentEtiquettes=[]);var elemIndex=vm.currentEtiquettes.indexOf(id);elemIndex>-1?vm.currentEtiquettes.splice(elemIndex,1):vm.currentEtiquettes.unshift(id),0===vm.currentEtiquettes.length&&(vm.currentEtiquettes=void 0),initPage(vm.currentEtiquettes)}function manageTag(event,tag){event.stopPropagation();var newTag=angular.isUndefined(tag)?angular.extend({},QCMService.NEW_TAG,{idAuteur:vm.idUser}):angular.copy(tag),modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/prompt-modal.template.html",controller:"PromptModalCtrl",size:"sm",resolve:{config:function(){var config={};return config.title=newTag.id>0?"Modifier l'étiquette":"Nouvelle étiquette",config.confirm="Valider",config.cancel="Annuler",config.value=newTag.libelle,config}}});modalInstance.result.then(function(newName){angular.isUndefined(newName)||newName.length<=0||/[\\:\/\*\?"<>|]/.test(newName)?Notification.notify("Erreur",'Libellé invalide <br> caractères interdits    /    \\    "    *   ?   <   >    :   | ',"danger"):(newTag.libelle=newName,vm.promiseLoading=QCMService.manageTag(vm.typeUser,vm.idUser,newTag).then(function(data){if(CacheService.remove($filter("translateTypeUserUrl")(vm.typeUser)+"/"+vm.idUser+"/qcms/etiquettes"),newTag.id>0){var elemIndex=lodash.findIndex(vm.etiquettes,{id:newTag.id});-1===elemIndex?(vm.etiquettes.unshift(data),vm.etiquettes=lodash.sortBy(vm.etiquettes,"libelle")):(vm.etiquettes[elemIndex]=newTag,initPage(vm.currentEtiquettes))}else newTag.id=data.id,vm.etiquettes.unshift(newTag),vm.etiquettes=lodash.sortBy(vm.etiquettes,"libelle")},function(error){var message=angular.isString(error)?error:error.message;Notification.notify("Erreur",message,"danger")}))})}function deleteTag(tag,event){event.stopPropagation();var modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression de l'étiquette",config.message="Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> cette étiquette <strong>"+tag.libelle+"</strong> (les questionnaires associés ne seront pas supprimés) ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=QCMService.supprimerTag(vm.typeUser,vm.idUser,tag).then(function(){var elemIndex=lodash.findIndex(vm.etiquettes,{id:tag.id});elemIndex>-1&&vm.etiquettes.splice(elemIndex,1),lodash.remove(vm.currentEtiquettes,function(e){return e===tag.id}),CacheService.remove($filter("translateTypeUserUrl")(vm.typeUser)+"/"+vm.idUser+"/qcms/etiquettes"),initPage(vm.currentEtiquettes),Notification.notify("Libellé supprimé","Votre libellé a bien été supprimé","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("Etiquette QCM","Une erreur s'est produite lors de la suppression du libellé","error","icon-ed_qcm")})})}function toggleQCMTag(qcm,idTag){if(vm.isAnneeCourante()){var equettes,howmany=0,elemIndex=qcm.etiquettes.indexOf(idTag);elemIndex>-1?(howmany=-1,equettes=angular.copy(qcm.etiquettes),equettes.splice(elemIndex,1)):(howmany=1,equettes=angular.copy(qcm.etiquettes),equettes.unshift(idTag)),vm.promiseLoading=QCMService.updateEtiquettes(vm.typeUser,vm.idUser,qcm,equettes).then(function(_data){qcm.etiquettes=equettes;var elem=lodash.find(vm.etiquettes,{id:idTag});if(angular.isDefined(elem)){var newBadge=elem.badge+howmany;0>newBadge&&(newBadge=0),elem.badge=newBadge}Notification.notify("QCM","Votre questionnaire a bien été mise à jour.","success","icon-ed_qcm")})["catch"](function(){Notification.notify("Erreur","Une erreur s'est produite lors de la mise à jour de votre questionnaire.","error","icon-ed_qcm")})}}function cloneQCM(qcm){var newQCM=angular.extend({},qcm,{id:0,idAuteur:vm.idUser,guid:"",evaluations:[],travauxafaire:[]});vm.promiseLoading=QCMService.cloneQCM(vm.typeUser,vm.idUser,qcm.id,newQCM).then(function(data){newQCM.id=data.id,newQCM.created=data.created,vm.isAnneeCourante()&&(vm.qcms.unshift(newQCM),CacheService.remove($filter("translateTypeUserUrl")(vm.typeUser)+"/"+vm.idUser+"/qcms/etiquettes")),Notification.notify("QCM","Le questionnaire a bien été dupliqué. Vous pouvez maintenant le modifier.","success","icon-ed_qcm"),manageQCM(newQCM)})["catch"](function(_err){Notification.notify("Erreur","Une erreur s'est produite lors de la duplication du questionnaire.","error","icon-ed_qcm")})}function removeQCM(qcm){var modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression du questionnaire",config.message="Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> le questionnaire <strong>"+qcm.titre+"</strong> ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=QCMService.supprimerQCM(vm.typeUser,vm.idUser,qcm).then(function(){var elemIndex=lodash.findIndex(vm.qcms,{id:qcm.id});elemIndex>-1&&(lodash.forEach(vm.qcms[elemIndex].etiquettes,function(e){var elem=lodash.find(vm.etiquettes,{id:e});if(angular.isDefined(elem)){var newBadge=elem.badge-1;0>newBadge&&(newBadge=0),elem.badge=newBadge}}),vm.qcms.splice(elemIndex,1)),Notification.notify("Questionnaire supprimé","Votre questionnaire a bien été supprimé","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la suppression du questionnaire","error","icon-ed_qcm")})})}function lierQCM(qcm){$uibModal.open({templateUrl:"modules/qcm/enseignant/qcms/associations/qcm-choose-association.html",controller:"QCMChooseAssociationCtrl as ctrl",backdrop:!0,keyboard:!0,size:"md",resolve:{qcm:function(){return qcm},hidedTafs:function(){return lodash.reduce(vm.qcms,function(result,unQcm){return result.concat(unQcm.travauxafaire)},[])}}})}function shareQCM(qcm){var modalInstance=$uibModal.open({templateUrl:"modules/qcm/enseignant/qcms/qcm-base-nationale-partage.html",controller:"QCMBaseNationalPartageCtrl as ctrl",backdrop:!0,keyboard:!0,size:"lg",resolve:{qcm:function(){return qcm}}});modalInstance.result.then(function(qcmShared){if(angular.isDefined(qcmShared)){var elemIndex=lodash.findIndex(vm.qcms,{id:qcm.id});elemIndex>-1&&(vm.qcms[elemIndex].guid=qcmShared.guid)}})}function unshareQCM(qcm){var modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression du questionnaire",config.message="Êtes-vous sûr de vouloir supprimer le questionnaire <strong>"+qcm.titre+"</strong> de la base inter-établissements ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=QCMService.unshareQCM(vm.typeUser,vm.idUser,qcm).then(function(){var elemIndex=lodash.findIndex(vm.qcms,{id:qcm.id});elemIndex>-1&&(vm.qcms[elemIndex].guid=""),CacheService.removeMatch(/.*\/qcms\/taxonomie/),Notification.notify("Questionnaire supprimé","Votre questionnaire a bien été supprimé de la base inter-établissements","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la suppression du questionnaire","error","icon-ed_qcm")})})}function openQCM(qcm){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"md",resolve:{qcmAssociation:function(){return{idQCM:qcm.id,idAssociation:0,titre:qcm.titre}},isNational:function(){return!1},idEleve:function(){return void 0}}})}function isAnneeCourante(){return QCMService.isAnneeCourante()}function changeChoosenAnneeQCMs(annee){QCMService.setChoosenAnneeQCMs(annee),vm.choosenAnneeQCMs=annee,initPage(void 0)}function openBaseNationale(){$uibModal.open({templateUrl:"modules/qcm/enseignant/qcms/qcms-base-nationale-picker.html",controller:"QCMSBDDNationaleCtrl as ctrl",backdrop:!0,keyboard:!0,size:"lg",resolve:{onReuseQCM:function(){return function(qcm){vm.qcms.unshift(qcm)}}}})}function initPage(etiquettes){vm.currentEtiquettes=etiquettes,getQCMs(etiquettes)}var vm=this;vm.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),vm.idUser=$routeParams.idUser,vm.choosenAnneeQCMs=QCMService.getChoosenAnneeQCMs(),vm.anneesQCMsArchive=QCMService.getAnneesQCMsArchive(),vm.idCurrent=0,vm.qcms=[],vm.etiquettes=[],vm.currentEtiquettes=void 0,vm.sousTitre="",vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"},{name:"others"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"};var paramsModule=ModuleService.getModule(ModuleService.CODES.QCM);"1"===paramsModule.params.prolexisEnable&&(vm.editorOptions.toolbarGroups.push({name:"DiagPlWs"}),vm.editorOptions.extraPlugins="colorbutton,font,mathjax,base64image,DiagPlWs"),vm.getQCMs=getQCMs,vm.displayAll=displayAll,vm.orphanTag=orphanTag,vm.manageQCM=manageQCM,vm.toggleTag=toggleTag,vm.manageTag=manageTag,vm.deleteTag=deleteTag,vm.toggleQCMTag=toggleQCMTag,vm.cloneQCM=cloneQCM,vm.removeQCM=removeQCM,vm.lierQCM=lierQCM,vm.shareQCM=shareQCM,vm.unshareQCM=unshareQCM,vm.openQCM=openQCM,vm.isAnneeCourante=isAnneeCourante,vm.changeChoosenAnneeQCMs=changeChoosenAnneeQCMs,vm.openBaseNationale=openBaseNationale,initPage(void 0)}]),angular.module("edsiteApp.QCM").controller("QCMQuestionsCtrl",["$scope","$routeParams","$location","$route","$filter","$uibModal","lodash","QCMService","ModuleService","Notification",function($scope,$routeParams,$location,$route,$filter,$uibModal,lodash,QCMService,ModuleService,Notification){function getQuestions(){vm.promiseLoading=QCMService.getQuestions(vm.typeUser,vm.idUser,vm.qcm).then(function(data){vm.qcm=data,sortQuestionsByOrderNo()})["catch"](function(err){var urlToRedirectTo;err&&404===err.code?(Notification.notify("Questions","Le questionnaire demandée est introuvable. Peut-être l'avez vous préalablement supprimé ?","error","icon-ed_qcm"),urlToRedirectTo="/"+$routeParams.typeUser+"/"+$routeParams.idUser+"/qcms",$location.path(urlToRedirectTo)):err&&530===err.code?(Notification.notify("Questions",err.message,"error","icon-ed_qcm"),urlToRedirectTo="/"+$routeParams.typeUser+"/"+$routeParams.idUser+"/qcms",$location.path(urlToRedirectTo)):Notification.notify("Questions","Une erreur s'est produite lors de la récupération de vos questions","error","icon-ed_qcm")})}function manageQuestion(question){var editQuestion=question;angular.isUndefined(question)&&(editQuestion=QCMService.addNewQuestion(vm.qcm.questions));var modalInstance=$uibModal.open({templateUrl:"modules/qcm/enseignant/questions/qcm-question-manage.html",controller:"QCMQuestionManageCtrl as ctrl",backdrop:"static",size:"lg",resolve:{qcm:function(){return{id:vm.qcm.id}},question:function(){return editQuestion},ckConf:function(){return vm.editorOptions},prolexisEnable:function(){return"1"===paramsModule.params.prolexisEnable}}});modalInstance.result.then(function(datas){if(datas&&angular.isDefined(datas.question)){var elemIndex=lodash.findIndex(vm.qcm.questions,{id:datas.question.id});-1===elemIndex?vm.qcm.questions.push(datas.question):(vm.qcm.questions[elemIndex]=datas.question,initPage())}datas&&angular.isUndefined(datas.question)&&datas.sonUpdated===!0&&$route.reload()})}function updateQuestionsOrderNo(newIndex){var oldOrdre=vm.qcm.questions[newIndex].ordre;vm.qcm.questions[newIndex].ordre=QCMService.generatePosOrder(vm.qcm.questions,newIndex),vm.promiseLoading=QCMService.updateQuestionOrdre(vm.typeUser,vm.idUser,vm.qcm,vm.qcm.questions[newIndex]).then(function(){Notification.notify("Question mise à jour","L'ordre a bien été mis à jour","success","icon-ed_qcm")})["catch"](function(){vm.qcm.questions[newIndex].ordre=oldOrdre,sortQuestionsByOrderNo(),Notification.notify("QCM","Une erreur s'est produite lors de la mise à jour de l'ordre","error","icon-ed_qcm")})}function sortQuestionsByOrderNo(){vm.qcm.questions.sort(function(a,b){return a.ordre-b.ordre})}function deleteQuestion(question){var modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression de la question",config.message="Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> la question <strong>"+$filter("base64decode")(question.question)+"</strong> ?",config.confirm="Oui",config.cancel="Non",config}}});modalInstance.result.then(function(){vm.promiseLoading=QCMService.supprimerQuestion(vm.typeUser,vm.idUser,vm.qcm,question).then(function(){var elemIndex=lodash.findIndex(vm.qcm.questions,{id:question.id});elemIndex>-1&&vm.qcm.questions.splice(elemIndex,1),Notification.notify("Question supprimée","Votre question a bien été supprimée","success","icon-ed_qcm")})["catch"](function(){Notification.notify("QCM","Une erreur s'est produite lors de la suppression de la question","error","icon-ed_qcm")})})}function moveDownQuestion(id){var fromIndex=lodash.findIndex(vm.qcm.questions,{id:id}),toIndex=fromIndex+1;toIndex<vm.qcm.questions.length&&(arrayMove(vm.qcm.questions,fromIndex,toIndex),updateQuestionsOrderNo(toIndex))}function moveUpQuestion(id){var fromIndex=lodash.findIndex(vm.qcm.questions,{id:id}),toIndex=fromIndex-1;toIndex>=0&&(arrayMove(vm.qcm.questions,fromIndex,toIndex),updateQuestionsOrderNo(toIndex))}function arrayMove(arr,fromIndex,toIndex){var element=arr[fromIndex];arr.splice(fromIndex,1),arr.splice(toIndex,0,element)}function cloneQuestion(id){if(0!==id){var modalInstance=$uibModal.open({templateUrl:"modules/qcm/enseignant/questions/clone-question.html",controller:"QCMCloneQuestionCtrl as ctrl",backdrop:!0,keyboard:!0,size:"lg",resolve:{qcm:function(){return vm.qcm}}});modalInstance.result.then(function(destQCM){if(angular.isDefined(destQCM)){var cloneIndex=lodash.findIndex(vm.qcm.questions,{id:id});if(cloneIndex>-1){var cloneQ=angular.copy(vm.qcm.questions[cloneIndex]);vm.promiseLoading=QCMService.getQuestions(vm.typeUser,vm.idUser,destQCM).then(function(data){data.questions.sort(function(a,b){return a.ordre-b.ordre});var tempQ=QCMService.addNewQuestion(data.questions);cloneQ.id=tempQ.id,cloneQ.ordre=tempQ.ordre,vm.promiseLoading=QCMService.saveQuestion(vm.typeUser,vm.idUser,destQCM,cloneQ,!0).then(function(_dta){Notification.notify("QCM","La question a bien été dupliquée.","success","icon-ed_qcm")})["catch"](function(){Notification.notify("Erreur","Une erreur s'est produite lors de la copie de la question.","error","icon-ed_qcm")})})["catch"](function(err){Notification.notify("Erreur","Une erreur s'est produite lors de la copie de la question.","error","icon-ed_qcm")})}}})}}function initPage(){if(!QCMService.isAnneeCourante()){var urlToRedirectTo="/"+$routeParams.typeUser+"/"+$routeParams.idUser+"/qcms";return void $location.path(urlToRedirectTo)}getQuestions()}var vm=this;vm.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),vm.idUser=$routeParams.idUser,vm.qcm={id:$routeParams.idQCM,questions:[]},vm.sortableConf={onEnd:function(evt){updateQuestionsOrderNo(evt.newIndex)}},vm.editorOptions={allowedContent:!0,config:{pasteFromWordRemoveFontStyles:!1},height:250,width:"100%",toolbar:"full",extraPlugins:"colorbutton,font,mathjax,base64image",removeButtons:"Anchor",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"links",groups:["link","unlink"]},{name:"insert",groups:["Math","table","specialchar","horizontalrule"]},{name:"tools"},{name:"document",groups:["mode"]},{name:"colors"},{name:"mathjax"},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","align"]},{name:"styles"},{name:"others"}],removePlugins:"stylescombo,elementspath,smiley,image,magicline,showblocks,scayt,pagebreak,div,find,about,preview,templates,save,newpage,print,wsc,liststyle"};var paramsModule=ModuleService.getModule(ModuleService.CODES.QCM);"1"===paramsModule.params.prolexisEnable&&(vm.editorOptions.toolbarGroups.push({name:"DiagPlWs"}),vm.editorOptions.extraPlugins="colorbutton,font,mathjax,base64image,DiagPlWs"),vm.choosenAnneeQCMs=QCMService.getChoosenAnneeQCMs(),vm.anneesQCMsArchive=QCMService.getAnneesQCMsArchive(),vm.getQuestions=getQuestions,vm.manageQuestion=manageQuestion,vm.deleteQuestion=deleteQuestion,vm.moveDownQuestion=moveDownQuestion,vm.moveUpQuestion=moveUpQuestion,vm.cloneQuestion=cloneQuestion,initPage()}]),angular.module("edsiteApp.QCM").controller("QCMResultatsCtrl",["$scope","$uibModal","$filter","lodash","$uibModalInstance","Notification","QCMService","Auth","qcm","association",function($scope,$uibModal,$filter,lodash,$uibModalInstance,Notification,QCMService,Auth,qcm,association){function goToPreviousEleve(){0===vm.idxCurrentEleve?vm.idxCurrentEleve=vm.resultatsQCM.reponsesEleves.length-1:vm.idxCurrentEleve--,vm.currentEleve=vm.resultatsQCM.reponsesEleves[vm.idxCurrentEleve]}function goToNextEleve(){vm.idxCurrentEleve===vm.resultatsQCM.reponsesEleves.length-1?vm.idxCurrentEleve=0:vm.idxCurrentEleve++,vm.currentEleve=vm.resultatsQCM.reponsesEleves[vm.idxCurrentEleve]}function displayStatQuestion(nb){return"pourc"===vm.typeAffichageStatsReponses?Math.round(100*nb/vm.resultatsQCM.reponsesEleves.length)+"%":nb}function getReponseEleveQuestion(idQuestion){return lodash.find(vm.currentEleve.reponses,function(reponse){return reponse.idQuestion===idQuestion})}function close(){$uibModalInstance.close()}function refresh(){initPage()}function initPage(){vm.promiseLoading=QCMService.getResultatsQuestionnaire(Auth.role(),Auth.idUser(),vm.qcm.id,vm.association.id).then(function(data){vm.resultatsQCM=data,vm.currentEleve=data.reponsesEleves[vm.idxCurrentEleve]})["catch"](function(){Notification.notify("QCM","Une erreur s'est produite lors de la récupération du questionnaire","error","icon-ed_qcm")})}var vm=this;vm.Auth=Auth,vm.qcm=qcm,vm.association=association,vm.resultatsQCM={},vm.ongletSelected="#general",vm.TYPE_REPONSES=QCMService.TYPE_REPONSES,vm.currentEleve={},vm.idxCurrentEleve=0,vm.typeAffichageStatsReponses="nb",vm.close=close,vm.initPage=initPage,vm.getReponseEleveQuestion=getReponseEleveQuestion,vm.displayStatQuestion=displayStatQuestion,vm.goToPreviousEleve=goToPreviousEleve,vm.goToNextEleve=goToNextEleve,vm.refresh=refresh,initPage()}]),angular.module("edsiteApp.QCM").directive("qcmsGlobalsActions",function(){return{restrict:"E",scope:{choosenAnnee:"=",anneesArchive:"=",isAnneeCourante:"=",changeChoosenAnnee:"&onChangeChoosenAnnee",openBaseNationale:"=onOpenBaseNationale",manageQuestionnaire:"=onManageQuestionnaire"},templateUrl:"modules/qcm/enseignant/qcms/qcms-globals-actions.template.html"}}),angular.module("edsiteApp.QCM").directive("unQcm",function(){return{restrict:"E",scope:{qcm:"=",etiquettes:"=",idCurrent:"=",isAnneeCourante:"=",manageQuestionnaire:"=onManageQuestionnaire",toggleQCMEtiquette:"=onToggleQcmEtiquette",cloneQuestionnaire:"=onCloneQuestionnaire",removeQuestionnaire:"=onRemoveQuestionnaire",shareQuestionnaire:"=onShareQuestionnaire",unshareQuestionnaire:"=onUnshareQuestionnaire",associerQuestionnaire:"=onAssocierQuestionnaire",openQuestionnaire:"=onOpenQuestionnaire"},templateUrl:"modules/qcm/enseignant/qcms/un-qcm.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$scope","$window","$uibModal","$filter","$routeParams","$location","lodash","Auth","QCMService","Notification",function($scope,$window,$uibModal,$filter,$routeParams,$location,lodash,Auth,QCMService,Notification){
function hasTag(tag){var elemIndex=ctrl.qcm.etiquettes.indexOf(tag.id);return elemIndex>-1}function goTo(){var typeUser=$filter("translateTypeUserUrl")(ctrl.typeUser),urlQcm="/"+typeUser+"/"+ctrl.idUser+"/qcms/"+ctrl.qcm.id+"/questions";$location.path(urlQcm)}function isShared(){return angular.isDefined(ctrl.qcm.guid)&&""!==ctrl.qcm.guid}function associationStart(idAssociation){ctrl.promiseLoading=QCMService.startQCM(ctrl.typeUser,ctrl.idUser,ctrl.qcm,idAssociation).then(function(_data){var index=lodash.findIndex(ctrl.qcm.evaluations,{id:idAssociation});ctrl.qcm.evaluations[index].disponible=!0,Notification.notify("QCM","Le questionnaire a bien été activé.","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("Erreur","Une erreur s'est produite lors de l'activation du questionnaire.","error","icon-ed_qcm")})}function associationStop(idAssociation){ctrl.promiseLoading=QCMService.stopQCM(ctrl.typeUser,ctrl.idUser,ctrl.qcm,idAssociation).then(function(data){var index=lodash.findIndex(ctrl.qcm.evaluations,{id:idAssociation});ctrl.qcm.evaluations[index].disponible=!1,Notification.notify("QCM","Le questionnaire a bien été désactivé.","success","icon-ed_qcm"),data.messageNotes&&$uibModal.open({templateUrl:"../../../../scripts/modals/dialog-modal.template.html",controller:"DialogModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Récapitulatif de la saisie automatique des notes",config.message=data.messageNotes,config.close="OK",config}}})})["catch"](function(_err){Notification.notify("Erreur","Une erreur s'est produite lors de la désactivation du questionnaire.","error","icon-ed_qcm")})}function associationEvaluationDelete(idAssociation){ctrl.promiseLoading=QCMService.supprimerAssociation(ctrl.typeUser,ctrl.idUser,ctrl.qcm,idAssociation).then(function(){var elemIndex=lodash.findIndex(ctrl.qcm.evaluations,{id:idAssociation});elemIndex>-1&&(ctrl.qcm.evaluations.splice(elemIndex,1),$scope.$broadcast("leQCMUpdated")),Notification.notify("Association supprimée","Votre association a bien été supprimée","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la suppression de l'association","error","icon-ed_qcm")})}function associationCDTDelete(idAssociation){ctrl.promiseLoading=QCMService.supprimerAssociation(ctrl.typeUser,ctrl.idUser,ctrl.qcm,idAssociation).then(function(){var elemIndex=lodash.findIndex(ctrl.qcm.travauxafaire,{id:idAssociation});elemIndex>-1&&(ctrl.qcm.travauxafaire.splice(elemIndex,1),$scope.$broadcast("leQCMUpdated")),Notification.notify("Association supprimée","Votre association a bien été supprimée","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la suppression de l'association","error","icon-ed_qcm")})}function customEtiquettes(){var tabs=[];return lodash.forEach(ctrl.qcm.etiquettes,function(e){var elem=lodash.find(ctrl.etiquettes,{id:e}),libelle=angular.isDefined(elem)?elem.libelle:"???";tabs.push({id:e,libelle:libelle})}),lodash.sortBy(tabs,"libelle")}var ctrl=this;ctrl.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),ctrl.idUser=$routeParams.idUser,ctrl.hasAssociations=ctrl.qcm.evaluations.length>0||ctrl.qcm.travauxafaire.length>0,ctrl.listeEtiquettes=customEtiquettes(),ctrl.hasTag=hasTag,ctrl.isShared=isShared,ctrl.associationStart=associationStart,ctrl.associationStop=associationStop,ctrl.associationEvaluationDelete=associationEvaluationDelete,ctrl.associationCDTDelete=associationCDTDelete,ctrl.goTo=goTo,ctrl.customEtiquettes=customEtiquettes}],link:function(scope,elem){var ctrl=scope.ctrl;elem.bind("click",function(){ctrl.qcm.id!==ctrl.idCurrent&&(ctrl.idCurrent=ctrl.qcm.id,scope.$apply())}),scope.$watchGroup(["ctrl.qcm.evaluations","ctrl.qcm.travauxafaire","ctrl.qcm.etiquettes"],function(){scope.$broadcast("leQCMUpdated")}),scope.$on("leQCMUpdated",function(){ctrl.hasAssociations=ctrl.qcm.evaluations&&ctrl.qcm.evaluations.length>0||ctrl.qcm.travauxafaire&&ctrl.qcm.travauxafaire.length>0,ctrl.listeEtiquettes=ctrl.customEtiquettes()})}}}),angular.module("edsiteApp.QCM").directive("unQcmNational",function(){return{restrict:"E",scope:{qcm:"=",reuseQuestionnaire:"=onReuseQuestionnaire",rateQuestionnaire:"=onRateQuestionnaire"},templateUrl:"modules/qcm/enseignant/qcms/un-qcm-national.template.html",controllerAs:"ctrl",bindToController:!0,transclude:!0,controller:["$uibModal","lodash","QCMService","Auth","Notification","$localStorage",function($uibModal,lodash,QCMService,Auth,Notification,$localStorage){function viewQCM(){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"lg",resolve:{qcmAssociation:function(){return{idQCM:ctrl.qcm.id,idAssociation:0,titre:ctrl.qcm.titre}},isNational:function(){return!0},idEleve:function(){return void 0}}})}function isQCMRatable(){return ctrl.qcm&&(!angular.isDefined($localStorage["qcms-rated-list"])||-1===$localStorage["qcms-rated-list"].indexOf(ctrl.qcm.id))&&!ctrl.isMyQCM()}function isMyQCM(){return ctrl.qcm&&ctrl.qcm.idAuteur===Auth.idUser()&&ctrl.qcm.natOgec===Auth.codeOgec()}var ctrl=this;ctrl.isMyQCM=isMyQCM,ctrl.viewQCM=viewQCM,ctrl.isQCMRatable=isQCMRatable}],link:function(scope){var ctrl=scope.ctrl;ctrl.qcmReuse=function(){ctrl.reuseQuestionnaire(ctrl.qcm)},ctrl.qcmRate=function(rating){ctrl.isQCMRatable()&&ctrl.rateQuestionnaire(ctrl.qcm,rating)}}}}),angular.module("edsiteApp.QCM").directive("qcmTaxonomie",function(){return{restrict:"E",scope:{onSelectTaxonomie:"="},templateUrl:"modules/qcm/enseignant/qcms/qcm-taxonomie.template.html",controllerAs:"ctrl",bindToController:!0,controller:["QCMService","Auth","Notification",function(QCMService,Auth,Notification){var ctrl=this;ctrl.taxonomie=[],QCMService.getTaxonomie(Auth.role(),Auth.idUser()).then(function(data){ctrl.taxonomie=angular.copy(data.tabChildren)})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération des catégories","error","icon-ed_qcm")})}]}}),angular.module("edsiteApp.QCM").controller("QCMSBDDNationaleCtrl",["$scope","$uibModalInstance","$localStorage","Auth","QCMService","Notification","lodash","onReuseQCM",function($scope,$uibModalInstance,$localStorage,Auth,QCMService,Notification,lodash,onReuseQCM){function close(){$uibModalInstance.close()}function onTaxonomieSelected(node){node.isLeaf!==!1&&(vm.currentTaxonomie=angular.copy(node),0===node.nbQCM?vm.qcms=[]:vm.loadQcms(node.id))}function loadQcms(idTaxonomie,searchTerm){vm.promiseLoading=QCMService.getQCMsNational(Auth.role(),Auth.idUser(),idTaxonomie,angular.isDefined(searchTerm)?searchTerm:"").then(function(data){vm.qcms=data,vm.sortBy()})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération des catégories","error","icon-ed_qcm")})}function reuseQCM(qcm){vm.promiseLoading=QCMService.reuseQCM(Auth.role(),Auth.idUser(),qcm).then(function(data){if(qcm.natNbTelecharge=angular.isDefined(data.natNbTelecharge)?data.natNbTelecharge:qcm.natNbTelecharge,qcm.nbQuestions=angular.isDefined(data.nbQuestions)?data.nbQuestions:qcm.nbQuestions,data){var newQCM=angular.extend({},QCMService.NEW_QCM,qcm,{idAuteur:Auth.idUser(),id:data.id,created:data.created,guid:""});vm.onReuseQCM(newQCM)}Notification.notify("QCM","Le questionnaire a bien été ajouté dans votre liste","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération du questionnaire","error","icon-ed_qcm")})}function rateQCM(qcm,rating){vm.promiseLoading=QCMService.rateQCM(Auth.role(),Auth.idUser(),qcm,rating).then(function(data){data&&(qcm.natScoring=data.natScoring,qcm.natNbVotants=data.natNbVotants),$localStorage["qcms-rated-list"]||($localStorage["qcms-rated-list"]=[]),$localStorage["qcms-rated-list"].push(qcm.id),Notification.notify("Note mise à jour","Votre note a bien été prise en compte","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la mise à jour du questionnaire","error","icon-ed_qcm")})}function search(){null!==vm.currentTaxonomie&&vm.loadQcms(vm.currentTaxonomie.id,vm.searchTerm)}function sortBy(property){!angular.isUndefined(property)&&""!==property||""===vm.sortCritere||(property=vm.sortCritere),vm.qcms=lodash.sortBy(vm.qcms,property).reverse(),vm.sortCritere=property}function refresh(){$scope.roleList=[{roleName:"User",roleId:"role1",children:[{roleName:"subUser1",roleId:"role11",children:[]},{roleName:"subUser2",roleId:"role12",children:[{roleName:"subUser2-1",roleId:"role121",children:[{roleName:"subUser2-1-1",roleId:"role1211",children:[]},{roleName:"subUser2-1-2",roleId:"role1212",children:[]}]}]}]},{roleName:"Admin",roleId:"role2",children:[]},{roleName:"Guest",roleId:"role3",children:[]}]}var vm=this;vm.Auth=Auth,vm.qcms=[],vm.sortCritere="",vm.currentTaxonomie=null,vm.treeOptions={nodeChildren:"tabChildren",multiSelection:!0,dirSelectable:!1,injectClasses:{}},vm.searchTerm="",vm.onReuseQCM=onReuseQCM,vm.close=close,vm.refresh=refresh,vm.loadQcms=loadQcms,vm.reuseQCM=reuseQCM,vm.rateQCM=rateQCM,vm.search=search,vm.sortBy=sortBy,vm.onTaxonomieSelected=onTaxonomieSelected,vm.refresh()}]),angular.module("edsiteApp.QCM").controller("QCMManageCtrl",["$scope","$uibModalInstance","$filter","Auth","QCMService","Notification","qcm","ckConf","prolexisEnable",function($scope,$uibModalInstance,$filter,Auth,QCMService,Notification,qcm,ckConf,prolexisEnable){function maxPoints(){return 10*vm.qcm.baremeBR}function saveQCM(form){if(!encours&&!form.$invalid){if(encours=!0,vm.qcm.introductionDecode.length>1572864||vm.qcm.conclusionDecode.length>1572864)return Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo).","error"),void(encours=!1);var newQCM=angular.copy(vm.qcm);prolexisEnable&&(angular.isDefined(CKEDITOR.instances.introductionDecode)&&(newQCM.introductionDecode=CKEDITOR.instances.introductionDecode.getData()),angular.isDefined(CKEDITOR.instances.conclusionDecode)&&(newQCM.conclusionDecode=CKEDITOR.instances.conclusionDecode.getData())),newQCM.introduction=$filter("base64encode")(newQCM.introductionDecode),newQCM.conclusion=$filter("base64encode")(newQCM.conclusionDecode),delete newQCM.introductionDecode,delete newQCM.conclusionDecode,vm.promiseLoading=QCMService.saveQCM(Auth.role(),Auth.idUser(),newQCM).then(function(data){newQCM.id=data.id>0?data.id:newQCM.id,newQCM.created=data.created?data.created:newQCM.created,encours=!1,Notification.notify("QCM","Votre questionnaire a bien été enregistré.","success","icon-ed_qcm"),close(newQCM)})["catch"](function(){encours=!1,Notification.notify("Erreur","Une erreur s'est produite lors de l'enregistrement de votre questionnaire.","error","icon-ed_qcm")})}}function close(qcm){$uibModalInstance.close(qcm)}function initEditPage(){vm.pageTitre=vm.qcm.id>0?"Modifier : "+vm.qcm.titre:"Nouveau questionnaire",vm.qcm.introduction&&(vm.qcm.introductionDecode=$filter("base64decode")(vm.qcm.introduction)),vm.qcm.conclusion&&(vm.qcm.conclusionDecode=$filter("base64decode")(vm.qcm.conclusion))}var vm=this;vm.Auth=Auth,vm.qcm=angular.copy(qcm),vm.ckConf=ckConf;var encours=!1;CKEDITOR.on("instanceReady",function(ev){ev.editor.dataProcessor.htmlFilter.addRules({elements:{$:function(element){if("img"===element.name){var style=element.attributes.style,width=element.attributes.width,height=element.attributes.height;if(style){var regex=new RegExp(/(width:|height:).+?(;[\s]?|$)/g),modStyle=element.attributes.style.replace(regex,"");element.attributes.style=modStyle}width&&delete element.attributes.width,height&&delete element.attributes.height}return element}}})}),vm.maxPoints=maxPoints,vm.saveQCM=saveQCM,vm.close=close,initEditPage()}]).directive("integer",function(){return{require:"ngModel",link:function($scope,elm,attrs,ctrl){var INTEGER_REGEXP=/^-?\d+$/;ctrl.$validators.integer=function(modelValue,viewValue){return ctrl.$isEmpty(modelValue)?!0:INTEGER_REGEXP.test(viewValue)?!0:!1}}}}).directive("nozero",function(){return{require:"ngModel",link:function($scope,elm,attrs,ctrl){ctrl.$validators.nozero=function(modelValue,viewValue){return 0!==parseInt(viewValue)}}}}),angular.module("edsiteApp.QCM").controller("QCMBaseNationalPartageCtrl",["$scope","$uibModalInstance","$uibModal","$filter","Auth","QCMService","Notification","qcm","lodash","CacheService",function($scope,$uibModalInstance,$uibModal,$filter,Auth,QCMService,Notification,qcm,lodash,CacheService){function shareQCM(form){form.$invalid||(vm.promiseLoading=QCMService.shareQCM(Auth.role(),Auth.idUser(),vm.qcm).then(function(data){vm.qcm.guid=data.guid?data.guid:vm.qcm.guid,CacheService.removeMatch(/.*\/qcms\/taxonomie/),Notification.notify("QCM","Votre questionnaire a bien été partagé sur la base inter-établissements.","success","icon-ed_qcm"),close(vm.qcm)})["catch"](function(){Notification.notify("Erreur","Une erreur s'est produite lors du partage de votre questionnaire.","error","icon-ed_qcm")}))}function removeTagTaxonomie(taxonomie){vm.qcm.taxonomies&&lodash.remove(vm.qcm.taxonomies,function(taxo){return taxo.id===taxonomie.id})}function onTaxonomieSelected(node){angular.isUndefined(node)||angular.isArray(node.tabChildren)&&node.tabChildren.length>0||(angular.isUndefined(vm.qcm.taxonomies)&&(vm.qcm.taxonomies=[]),lodash.findIndex(vm.qcm.taxonomies,function(taxo){return taxo.id===node.id})>-1||vm.qcm.taxonomies.push(angular.copy(node)))}function backToQCMS(form){if(form.$dirty){var modalInstance=$uibModal.open({templateUrl:"../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Annuler les modifications",config.message="Êtes vous sûr de vouloir annuler les modifications ?",config.confirm="Oui",config.cancel="Non",config.warningButton="OK",config}}});modalInstance.result.then(function(){close()})}else close()}function close(qcm){$uibModalInstance.close(qcm)}function refresh(){vm.promiseLoading=QCMService.getTaxonomie(Auth.role(),Auth.idUser()).then(function(data){vm.taxonomie=data.tabChildren})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération des catégories","error","icon-ed_qcm")})}var vm=this;vm.Auth=Auth,vm.qcm=angular.copy(qcm),vm.qcm.natEtablissement=Auth.currentUser().nomEtablissement,vm.taxonomie=[],vm.shareQCM=shareQCM,vm.backToQCMS=backToQCMS,vm.close=close,vm.onTaxonomieSelected=onTaxonomieSelected,vm.refresh=refresh,vm.removeTagTaxonomie=removeTagTaxonomie,vm.refresh()}]),angular.module("edsiteApp.QCM").directive("qcmAssociationEvaluation",["$uibModal",function($uibModal){return{restrict:"E",scope:{association:"=",qcm:"=",associationStart:"=onAssociationStart",associationStop:"=onAssociationStop","delete":"=onDelete"},templateUrl:"modules/qcm/enseignant/qcms/associations/qcm-association-evaluation.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$filter","$routeParams",function($filter,$routeParams){var ctrl=this;ctrl.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),ctrl.idUser=$routeParams.idUser}],link:function(scope){var ctrl=scope.ctrl;ctrl.confirmDelete=function(){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression de l'association",config.message='<p>Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> cette association ?</p><p class="text-danger">Attention ! Les réponses apportées par les élèves seront aussi définitivement supprimées !</p>',config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){ctrl["delete"](ctrl.association.id)})},ctrl.confirmStart=function(){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Rendre accessible le questionnaire aux élèves ?",config.message="<p>Êtes-vous sûr de vouloir démarrer ce questionnaire ?</p><p>Les élèves pourront y accèder depuis la page <b>QCM</b>.</p>",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){ctrl.associationStart(ctrl.association.id)})},ctrl.confirmStop=function(){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Rendre inaccessible le questionnaire aux élèves ?",config.message="<p>Êtes-vous sûr de vouloir stopper ce questionnaire ?</p><p><b>Les notes seront pré-remplis automatiquement</b> en fonction des points acquis et du barême paramétré sur le QCM.</p>",config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){ctrl.associationStop(ctrl.association.id)})},ctrl.showResultatsAssociation=function(){$uibModal.open({templateUrl:"modules/qcm/enseignant/resultats/qcm-resultats.html",controller:"QCMResultatsCtrl as ctrl",size:"lg",backdrop:"static",resolve:{qcm:function(){return ctrl.qcm},association:function(){return ctrl.association}}})}}}}]),angular.module("edsiteApp.QCM").directive("qcmAssociationCdt",["$uibModal",function($uibModal){return{restrict:"E",scope:{association:"=",qcm:"=","delete":"=onDelete"},templateUrl:"modules/qcm/enseignant/qcms/associations/qcm-association-cdt.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$filter","$routeParams",function($filter,$routeParams){var ctrl=this;ctrl.typeUser=$filter("translateTypeUserToShortcut")($routeParams.typeUser),ctrl.idUser=$routeParams.idUser}],link:function(scope){var ctrl=scope.ctrl;ctrl.confirmDelete=function(){var modalInstanceSuppression=$uibModal.open({templateUrl:"../../../../../scripts/modals/confirm-modal.template.html",controller:"ConfirmModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Suppression de l'association",config.message='<p>Êtes-vous sûr de vouloir supprimer <strong>définitivement</strong> cette association ?</p><p class="text-danger">Attention ! Les réponses apportées par les élèves seront aussi définitivement supprimées !</p>',config.confirm="Oui",config.cancel="Non",config}}});modalInstanceSuppression.result.then(function(){ctrl["delete"](ctrl.association.id)})},ctrl.showResultatsAssociation=function(){$uibModal.open({templateUrl:"modules/qcm/enseignant/resultats/qcm-resultats.html",controller:"QCMResultatsCtrl as ctrl",size:"lg",backdrop:"static",resolve:{qcm:function(){return ctrl.qcm},association:function(){return ctrl.association}}})}}}}]),angular.module("edsiteApp.QCM").controller("QCMChooseAssociationCtrl",["$scope","$uibModalInstance","$uibModal","$timeout","$filter","$q","lodash","moment","Auth","QCMService","CahierDeTexteService","ModuleService","UserService","Notification","qcm","hidedTafs","CahierDeTextePrimaireService","CacheService",function($scope,$uibModalInstance,$uibModal,$timeout,$filter,$q,lodash,moment,Auth,QCMService,CahierDeTexteService,ModuleService,UserService,Notification,qcm,hidedTafs,CahierDeTextePrimaireService,CacheService){function setSelectedTypeAsso(selected){vm.selected=selected}function associerTAF(slot){if(angular.isUndefined(slot.matiereCode))return void Notification.notify("Associations","Il n'y a pas de matière associée. L'association est impossible","danger");if(angular.isUndefined(slot.entityCode))return void Notification.notify("Associations","Il n'y a pas de classe ou de groupe associée. L'association est impossible","danger");var taf={idEntite:slot.idCDT,typeEntite:QCMService.TYPE_ASSOCIATION.CDT,titre:"Travail à faire",sousTitre:slot.entityLibelle+" - "+slot.matiereLibelle,date:slot.date};if(slot.travailAFaire)vm.promiseLoading=QCMService.associerTAF(Auth.role(),Auth.idUser(),vm.qcm,taf).then(function(data){taf.id=data.id,vm.qcm.travauxafaire=[].concat(vm.qcm.travauxafaire,taf);var elemIndex=lodash.findIndex(vm.tafs,{idCDT:taf.idEntite});elemIndex>-1&&vm.tafs.splice(elemIndex,1),CacheService.removeStartWith("cahierdetexte/loadslots/"),Notification.notify("Association effectuée","Le QCM a bien été associé à ce travail.","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("Associations","Une erreur s'est produite lors de l'association.","error","icon-ed_qcm")});else{var currentCDTEdit=angular.copy(slot);angular.isUndefined(currentCDTEdit.aFaire)&&(currentCDTEdit.aFaire={}),angular.isUndefined(currentCDTEdit.seance)&&(currentCDTEdit.seance={}),currentCDTEdit.aFaire.modeEdit=!0,currentCDTEdit.aFaire.contenu=$filter("base64encode")("<p>Merci de répondre au questionnaire.</p>"),angular.isUndefined(currentCDTEdit.aFaire.donneLe)||""===currentCDTEdit.aFaire.donneLe?currentCDTEdit.aFaire.donneLe=new Date:currentCDTEdit.aFaire.donneLe=new Date(currentCDTEdit.aFaire.donneLe),vm.promiseLoading=CahierDeTexteService.save(currentCDTEdit,"aFaire").then(function(data){data&&data.idCDT>0&&(slot.idCDT=data.idCDT,taf.idEntite=data.idCDT,vm.promiseLoading=QCMService.associerTAF(Auth.role(),Auth.idUser(),vm.qcm,taf).then(function(data){taf.id=data.id,vm.qcm.travauxafaire=[].concat(vm.qcm.travauxafaire,taf);var elemIndex=lodash.findIndex(vm.tafs,{idCDT:taf.idEntite});elemIndex>-1&&vm.tafs.splice(elemIndex,1),CacheService.removeStartWith("cahierdetexte/loadslots/"),Notification.notify("Association effectuée","Le QCM a bien été associé à ce travail.","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("Associations","Une erreur s'est produite lors de l'association.","error","icon-ed_qcm")}))})["catch"](function(_err){Notification.notify("Associations","Une erreur s'est produite lors de l'association.","error","icon-ed_qcm")})}}function associerDevoir(devoir){vm.promiseLoading=QCMService.associerDevoir(Auth.role(),Auth.idUser(),vm.qcm,devoir).then(function(data){vm.qcm.evaluations=[].concat(vm.qcm.evaluations,angular.extend({},devoir,{id:data.id}));var elemIndex=lodash.findIndex(vm.evaluations,{idEntite:devoir.idEntite});elemIndex>-1&&vm.evaluations.splice(elemIndex,1),Notification.notify("Association effectuée","Le QCM a bien été associé à ce devoir.","success","icon-ed_qcm")})["catch"](function(_err){Notification.notify("Associations","Une erreur s'est produite lors de l'association.","error","icon-ed_qcm")})}function getAssociations(){vm.promiseLoading=CahierDeTexteService.initProf(vm.parametrage).then(function(){var lesPromises=[];lesPromises.push(CahierDeTexteService.loadSlots(vm.minDate.format("YYYY-MM-DD"),vm.maxDate.format("YYYY-MM-DD"))),lesPromises.push(QCMService.getAssociationsPotentielles(Auth.role(),Auth.idUser(),vm.qcm)),vm.promiseLoading=$q.all(lesPromises).then(function(data){UserService.getProfClassesGroupesTree().then(function(cg){lodash.forEach(data[1],function(evaluation){var entity;if(evaluation.idGroupe>0?entity=lodash.find(cg,{id:parseInt(evaluation.idGroupe),type:"G"}):evaluation.idClasse>0&&(entity=lodash.find(cg,{id:parseInt(evaluation.idClasse),type:"C"})),angular.isDefined(entity)){evaluation.sousTitre=entity.libelle;var periode=lodash.find(entity.periodes,{codePeriode:evaluation.periode});if(angular.isDefined(periode)){evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+periode.libelle:periode.libelle;var matiere=lodash.find(periode.matieres,{code:evaluation.codeMatiere,codeSSMatiere:evaluation.codeSSMatiere});angular.isDefined(matiere)&&(evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+matiere.libelle:matiere.libelle)}}}),vm.evaluations=data[1]})["catch"](function(_err){vm.evaluations=data[1]});var slots=lodash.uniq(data[0],function(slot){return slot.date+"_"+slot.entityCode+"_"+slot.matiereCode+"_"+slot.idCDT});lodash.remove(slots,function(slot){return lodash.findIndex(hidedTafs,function(unTaf){return unTaf.idEntite===slot.idCDT})>-1}),vm.tafs=lodash.sortBy(slots,function(slot){return slot.date+slot.start_date+slot.entityCode})})["catch"](function(_err){vm.evaluations=[],vm.tafs=[],Notification.notify("Associations","Une erreur s'est produite lors de la récupération des associations potentielles.","error","icon-ed_qcm")})})}function getAssociationsPrimaire(){var lesPromises=[];lesPromises.push(CahierDeTextePrimaireService.loadSlots(vm.minDate.format("YYYY-MM-DD"),vm.maxDate.format("YYYY-MM-DD"))),lesPromises.push(QCMService.getAssociationsPotentielles(Auth.role(),Auth.idUser(),vm.qcm)),vm.promiseLoading=$q.all(lesPromises).then(function(data){UserService.getProfClassesGroupesTree().then(function(cg){lodash.forEach(data[1],function(evaluation){var entity;if(evaluation.idGroupe>0?entity=lodash.find(cg,{id:parseInt(evaluation.idGroupe),type:"G"}):evaluation.idClasse>0&&(entity=lodash.find(cg,{id:parseInt(evaluation.idClasse),type:"C"})),angular.isDefined(entity)){evaluation.sousTitre=entity.libelle;var periode=lodash.find(entity.periodes,{codePeriode:evaluation.periode});if(angular.isDefined(periode)){evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+periode.libelle:periode.libelle;var matiere=lodash.find(periode.matieres,{code:evaluation.codeMatiere,codeSSMatiere:evaluation.codeSSMatiere});angular.isDefined(matiere)&&(evaluation.sousTitre=""!==evaluation.sousTitre?evaluation.sousTitre+" - "+matiere.libelle:matiere.libelle)}}}),vm.evaluations=data[1];for(var d=moment();d.toDate()<=vm.maxDate.toDate();)cg.forEach(function(entity){var slot,indexCDT=lodash.findIndex(data[0],function(saisieCDT){return saisieCDT.date===d.format("YYYY-MM-DD")&&saisieCDT.idCDT>0&&saisieCDT.entityType===entity.type&&saisieCDT.entityCode===entity.code});indexCDT>-1?slot=data[0][indexCDT]:(slot=angular.copy(CahierDeTextePrimaireService.defaultSlot),slot.date=d.format("YYYY-MM-DD"),slot.entityCode=entity.code,slot.entityType=entity.type,slot.entityLibelle=entity.libelle),vm.tafs.push(slot)}),d.add(1,"d");lodash.remove(vm.tafs,function(slot){return lodash.findIndex(hidedTafs,function(unTaf){return unTaf.idEntite===slot.idCDT})>-1}),vm.tafs=lodash.sortBy(vm.tafs,function(slot){return slot.date+slot.start_date+slot.entityType+slot.entityCode})})["catch"](function(_err){vm.evaluations=data[1],vm.tafs=[]})})["catch"](function(_err){vm.evaluations=[],vm.tafs=[],Notification.notify("Associations","Une erreur s'est produite lors de la récupération des associations potentielles.","error","icon-ed_qcm")})}function close(association){$uibModalInstance.close(association)}function initPage(){vm.parametrage.isCDTPrimaire?getAssociationsPrimaire():getAssociations()}var vm=this;vm.Auth=Auth,vm.qcm=qcm,vm.evaluations=[],vm.tafs=[],vm.selected=!0,vm.today=moment(),vm.minDate=moment(),vm.maxDate=moment().add({month:1}),vm.parametrage={edt:!1,isCDTPrimaire:!1};var moduleCDT=ModuleService.getModule(ModuleService.CODES.CAHIER_DE_TEXTES);moduleCDT&&moduleCDT.params&&(vm.parametrage={edt:"1"===moduleCDT.params.edt,isCDTPrimaire:"1"===moduleCDT.params.isCDTPrimaire}),vm.setSelectedTypeAsso=setSelectedTypeAsso,vm.associerTAF=associerTAF,vm.associerDevoir=associerDevoir,vm.close=close,initPage()}]),angular.module("edsiteApp.QCM").directive("qcmsEtiquettes",function(){return{restrict:"E",scope:{etiquettes:"=",currentEtiquettes:"=",isAnneeCourante:"=",manageEtiquette:"=onManageEtiquette",deleteEtiquette:"=onDeleteEtiquette",toggleEtiquette:"=onToggleEtiquette",orphanEtiquette:"=onOrphanEtiquette",allQ:"=onAllQ"},templateUrl:"modules/qcm/enseignant/qcms/etiquettes/qcms-etiquettes.template.html",link:function(scope){function isActif(id){return angular.isDefined(scope.currentEtiquettes)&&scope.currentEtiquettes.indexOf(id)>-1}function selectFilter(filterCurrent){scope.filterSelected=filterCurrent}scope.isActif=isActif,scope.selectFilter=selectFilter,scope.filterSelected="all"}}}),angular.module("edsiteApp.QCM").controller("QCMQuestionManageCtrl",["$scope","$uibModal","$uibModalInstance","$filter","lodash","Auth","QCMService","Notification","Settings","qcm","question","ckConf","prolexisEnable",function($scope,$uibModal,$uibModalInstance,$filter,lodash,Auth,QCMService,Notification,Settings,qcm,question,ckConf,prolexisEnable){function openCKFormula(){$uibModal.open({templateUrl:"../../../../scripts/modals/dialog-modal.template.html",controller:"DialogModalCtrl",size:"md",resolve:{config:function(){var config={};return config.title="Aide à la saisie",config.message="<p>Pour un texte à trous, les <b>majuscules / minuscules et accents</b> sont significatives.</p><p>Pour intégrer une formule dans la proposition (choix unique ou multiples uniquement), entourez-là par <b>#</b> de part et d'autre. Exemple : #x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}#</p>",config.close="OK",config}}})}function resetErrors(selectForm){for(var att in selectForm.$error)switch(vm.question.typeQ){case vm.TYPE_QUESTIONS.radio.id:case vm.TYPE_QUESTIONS.checkbox.id:"hasTexthole"===att&&selectForm.$setValidity("hasTexthole",!0);break;case vm.TYPE_QUESTIONS.textholes.id:"hasEnoughGoodPropositions"===att&&selectForm.$setValidity("hasEnoughGoodPropositions",!0),"hasEnoughGoodPropositionsRequired"===att&&selectForm.$setValidity("hasEnoughGoodPropositionsRequired",!0)}}function saveQuestion(form){if(!encours&&!form.$invalid){if(encours=!0,vm.question.questionDecode.length>1572864||vm.question.enonceDecode.length>1572864||vm.question.remediationDecode.length>1572864)return Notification.notify("Erreur","Enregistrement impossible. Votre saisie est trop grande (>1.5Mo).","error","icon-ed_qcm"),void(encours=!1);var newAsk=angular.copy(vm.question);switch(prolexisEnable&&(angular.isDefined(CKEDITOR.instances.questionDecode)&&(newAsk.questionDecode=CKEDITOR.instances.questionDecode.getData()),angular.isDefined(CKEDITOR.instances.enonceDecode)&&(newAsk.enonceDecode=CKEDITOR.instances.enonceDecode.getData()),angular.isDefined(CKEDITOR.instances.remediationDecode)&&(newAsk.remediationDecode=CKEDITOR.instances.remediationDecode.getData())),newAsk.question=$filter("base64encode")(newAsk.questionDecode),newAsk.enonce=$filter("base64encode")(newAsk.enonceDecode),newAsk.remediation=$filter("base64encode")(newAsk.remediationDecode),delete newAsk.questionDecode,delete newAsk.enonceDecode,delete newAsk.remediationDecode,delete newAsk.trustSrcSon,newAsk.typeQ){case vm.TYPE_QUESTIONS.radio.id:case vm.TYPE_QUESTIONS.checkbox.id:lodash.forEach(newAsk.propositions,function(proposition){proposition.enonce=$filter("base64encode")(proposition.enonceDecode),delete proposition.enonceDecode,delete proposition.correctifDecode,proposition.correctif=""});break;case vm.TYPE_QUESTIONS.textholes.id:lodash.forEach(newAsk.propositions,function(proposition){var enonceDecode=proposition.enonceDecode.replace(/<strong[^>]*>(.*?)<\/strong>/gi,"<b>$1</b>").replace(/<b[^>]*>(.*?)<\/b>/gi,"<b>$1</b>").replace(/&nbsp;/gi," "),correctifs=enonceDecode.match(/<b[^>]*>(.*?)<\/b>/g),correctifDecode=correctifs.map(function(val,index){var to=QCMService.SCHMURTZ+index;return enonceDecode=enonceDecode.replace(correctifs[index],to),val.replace(/<\/?b[^>]*>/g,"").trim()});proposition.enonce=$filter("base64encode")(enonceDecode),proposition.correctif=$filter("base64encode")(correctifDecode.join(QCMService.SCHMURTZ)),delete proposition.enonceDecode,delete proposition.correctifDecode,proposition.valide=!0});break;default:encours=!1}return encours?void(vm.promiseLoading=QCMService.saveQuestion(Auth.role(),Auth.idUser(),vm.qcm,newAsk).then(function(data){newAsk.id=data.id>0?data.id:newAsk.id,newAsk.srcSon=data.srcSon,encours=!1,Notification.notify("QCM","La question a bien été enregistrée.","success","icon-ed_qcm"),close(newAsk)})["catch"](function(){encours=!1,Notification.notify("Erreur","Une erreur s'est produite lors de l'enregistrement de la question.","error","icon-ed_qcm")})):void Notification.notify("Erreur","Enregistrement impossible. Vous n'avez pas choisi le type de question.","error","icon-ed_qcm");
}}function processingEvent(){vm.processingFiles++}function completeEvent(){vm.processingFiles--}function onCompleteUpload(form){var laQuestion=angular.copy(vm.question);laQuestion.uncSon=vm.fichiers[0].data.unc,laQuestion.titreSon=vm.fichiers[0].data.titre,laQuestion.srcSon="",vm.fichiers.length=0,vm.promiseLoading=QCMService.updateQuestionSon(Auth.role(),Auth.idUser(),vm.qcm,laQuestion).then(function(data){vm.question.srcSon=data.srcSon,vm.question.uncSon=laQuestion.uncSon,vm.question.titreSon=laQuestion.titreSon,vm.sonUpdated=!0,Notification.notify("QCM","Le son a bien été ajouté. Sauvegardez vos modifications avant de fermer la fenêtre.","success","icon-ed_qcm")})["catch"](function(){encours=!1,Notification.notify("Erreur","Une erreur s'est produite lors de l'ajout du son.","error","icon-ed_qcm")}),form.$setDirty()}function onRemovedFileUploaded(form){vm.fichiers.length=0,vm.processingFiles=0,vm.question.srcSon="",vm.question.uncSon="",vm.question.titreSon="",vm.sonUpdated=!0,form.$setDirty()}function deleteFile(form){vm.promiseLoading=QCMService.supprimerQuestionSon(Auth.role(),Auth.idUser(),vm.qcm,vm.question).then(function(){onRemovedFileUploaded(form),Notification.notify("QCM","Le son a bien été supprimé. Sauvegardez vos modifications avant de fermer la fenêtre.","success","icon-ed_qcm")})["catch"](function(){encours=!1,Notification.notify("Erreur","Une erreur s'est produite lors de la suppression du son.","error","icon-ed_qcm")})}function close(question){$uibModalInstance.close({question:question,sonUpdated:vm.sonUpdated})}function initEditPage(){vm.pageTitre=vm.question.id>0?"Modifier la question":"Nouvelle question",vm.question.question&&(vm.question.questionDecode=$filter("base64decode")(vm.question.question)),vm.question.enonce&&(vm.question.enonceDecode=$filter("base64decode")(vm.question.enonce)),vm.question.remediation&&(vm.question.remediationDecode=$filter("base64decode")(vm.question.remediation)),lodash.forEach(vm.question.propositions,function(proposition){proposition.enonceDecode=proposition.enonce?$filter("base64decode")(proposition.enonce):"",proposition.correctifDecode=proposition.correctif?$filter("base64decode")(proposition.correctif):""})}var vm=this;vm.Auth=Auth,vm.qcm=qcm,vm.question=angular.copy(question),vm.ckConf=ckConf,vm.sonUpdated=!1,vm.fichiers=[],vm.configInputFile={keepComplete:!0,dropzoneContainer:"#container-question-manage",fromCloudEnabled:!1,mode:"QCM"},vm.processingFiles=0,vm.dropzoneConfig={parallelUploads:1,previewsContainer:!1,url:Settings.allSettings().apiUri+"televersement.awp?verbe=post&mode=QCM",timeout:3e6,maxFilesize:10,maxFiles:1,acceptedFiles:"audio/mpeg, audio/aac, audio/ogg, audio/mp3",dictInvalidFileType:"Vous ne pouvez envoyer que des fichiers audios ayant l'extension <strong>.mpeg</strong>, <strong>.aac</strong>, <strong>.ogg</strong> et <strong>.mp3</strong>",processing:processingEvent,complete:completeEvent},vm.TYPE_QUESTIONS=QCMService.TYPE_QUESTIONS;var encours=!1;CKEDITOR.on("instanceReady",function(ev){ev.editor.dataProcessor.htmlFilter.addRules({elements:{$:function(element){if("img"===element.name){var style=element.attributes.style,width=element.attributes.width,height=element.attributes.height;if(style){var regex=new RegExp(/(width:|height:).+?(;[\s]?|$)/g),modStyle=element.attributes.style.replace(regex,"");element.attributes.style=modStyle}width&&delete element.attributes.width,height&&delete element.attributes.height}return element}}})}),vm.openCKFormula=openCKFormula,vm.resetErrors=resetErrors,vm.saveQuestion=saveQuestion,vm.onCompleteUpload=onCompleteUpload,vm.onRemovedFileUploaded=onRemovedFileUploaded,vm.deleteFile=deleteFile,vm.close=close,initEditPage()}]),angular.module("edsiteApp.QCM").directive("qcmQuestionsGlobalsActions",function(){return{restrict:"E",scope:{manageQuestion:"=onManageQuestion"},templateUrl:"modules/qcm/enseignant/questions/qcm-questions-globals-actions.template.html"}}),angular.module("edsiteApp.QCM").directive("uneQuestion",function(){return{restrict:"E",scope:{idQCM:"=idQuestionnaire",question:"=",isFirst:"=",isLast:"=",manageQuestion:"=onManageQuestion",moveUp:"=onMoveUp",moveDown:"=onMoveDown",cloneQuestion:"=onCloneQuestion","delete":"=onDelete"},templateUrl:"modules/qcm/enseignant/questions/une-question.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$filter","$sce","lodash","QCMService",function($filter,$sce,lodash,QCMService){function updateTextHoles(){ctrl.question.typeQ===ctrl.TYPE_QUESTIONS.textholes.id&&lodash.forEach(ctrl.question.propositions,function(proposition){for(var enonceDecode=proposition.enonce?$filter("base64decode")(proposition.enonce):"",correctifDecode=proposition.correctif?$filter("base64decode")(proposition.correctif):"",correctifs=correctifDecode.split(QCMService.SCHMURTZ),i=0;i<correctifs.length;i++){var from=QCMService.SCHMURTZ+i;enonceDecode=enonceDecode.replace(from,'<label><input type="text" class="form-control question-proposition-texthole-input" name=hole-"'+i+'" placeholder="'+correctifs[i]+'" disabled /></label>')}proposition.enonceDecode=$sce.trustAsHtml(enonceDecode)})}function updateSrcSon(){ctrl.question.srcSon&&(ctrl.question.trustSrcSon=$sce.trustAsResourceUrl(ctrl.question.srcSon))}var ctrl=this;ctrl.TYPE_QUESTIONS=QCMService.TYPE_QUESTIONS,ctrl.updateTextHoles=updateTextHoles,ctrl.updateSrcSon=updateSrcSon}],link:function(scope){var ctrl=scope.ctrl;scope.$watch("ctrl.question",function(){ctrl.updateTextHoles(),ctrl.updateSrcSon()})}}}),angular.module("edsiteApp.QCM").directive("questionTypeChoice",["$timeout",function($timeout){return{restrict:"E",replace:!0,require:"^form",scope:{idQCM:"=idQuestionnaire",question:"=",errorChamp:"@"},templateUrl:"modules/qcm/enseignant/questions/question-type-choice.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$uibModal","$filter","lodash","QCMService",function($uibModal,$filter,lodash,QCMService){function checkOrNot(proposition){angular.isUndefined(proposition.valide)?proposition.valide=!0:proposition.valide=!proposition.valide}function removeProposition(proposition){var index=ctrl.question.propositions.indexOf(proposition);-1!==index&&ctrl.question.propositions.splice(index,1)}function createNewProposition(){var answer={id:0,valide:!1};ctrl.question.propositions.push(answer)}var ctrl=this;ctrl.TYPE_QUESTIONS=QCMService.TYPE_QUESTIONS,ctrl.checkOrNot=checkOrNot,ctrl.removeProposition=removeProposition,ctrl.createNewProposition=createNewProposition}],link:function(scope,element,attrs,leForm){var ctrl=scope.ctrl;ctrl.inputFormError=leForm[ctrl.errorChamp],ctrl.addNewProposition=function(){ctrl.createNewProposition(),$timeout(function(){var elementResults=element[0].getElementsByClassName("question-proposition-enonce");elementResults.length>=1&&elementResults[elementResults.length-1].focus()})}}}}]),angular.module("edsiteApp.QCM").directive("questionTypeTextholes",["$document",function($document){return{restrict:"E",replace:!0,require:"^form",scope:{idQCM:"=idQuestionnaire",question:"=",errorChamp:"@"},templateUrl:"modules/qcm/enseignant/questions/question-type-textholes.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$uibModal","$filter","$timeout","lodash","QCMService",function($uibModal,$filter,$timeout,lodash,QCMService){function initEditPage(){if(0===ctrl.question.propositions.length){var answer={id:0,valide:!1};ctrl.question.propositions.push(answer)}else ctrl.question.propositions.length=1;lodash.forEach(ctrl.question.propositions,function(proposition){for(var enonceDecode=proposition.enonceDecode||"",correctifDecode=proposition.correctifDecode||"",correctifs=correctifDecode.split(QCMService.SCHMURTZ),i=0;i<correctifs.length;i++){var from=QCMService.SCHMURTZ+i;enonceDecode=enonceDecode.replace(from,"<b>"+correctifs[i]+"</b>")}proposition.enonceDecode=enonceDecode,proposition.correctifDecode=correctifDecode})}var ctrl=this;ctrl.TYPE_QUESTIONS=QCMService.TYPE_QUESTIONS,initEditPage()}],link:function(scope,element,attrs,leForm){var ctrl=scope.ctrl;ctrl.inputFormError=leForm[ctrl.errorChamp],ctrl.formatDoc=function(id){$document[0].execCommand("bold",!1,null);var divEditable=angular.element(element.find("#textholesBox-"+id));divEditable.length>0&&divEditable[0].focus()}}}}]),angular.module("edsiteApp.QCM").controller("QCMCloneQuestionCtrl",["$scope","$uibModalInstance","Auth","QCMService","Notification","lodash","qcm",function($scope,$uibModalInstance,Auth,QCMService,Notification,lodash,qcm){function choisir(form){if(!form.$invalid){var elem=lodash.find(vm.qcms,{id:+vm.idQCM});close(elem)}}function close(elem){$uibModalInstance.close(elem)}function refresh(){vm.promiseLoading=QCMService.getQCMs(Auth.role(),Auth.idUser()).then(function(data){vm.qcms=lodash.filter(data,function(item){var hasAssociations=item.evaluations.length>0||item.travauxafaire.length>0;return item.id!==qcm.id&&!hasAssociations})})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération des questionnaires","error","icon-ed_qcm")})}var vm=this;vm.Auth=Auth,vm.qcms=[],vm.close=close,vm.choisir=choisir,refresh()}]),angular.module("edsiteApp.QCM").controller("QCMModalViewerCtrl",["$uibModalInstance","Auth","QCMService","Notification","qcmAssociation","isNational","idEleve",function($uibModalInstance,Auth,QCMService,Notification,qcmAssociation,isNational,idEleve){function getQuestionnaire(){var role=Auth.role(),idUser=Auth.idUser();angular.isDefined(idEleve)&&idEleve>0&&(role="E",idUser=idEleve),vm.promiseLoading=QCMService.getParticipantQuestionnaire(role,idUser,qcmAssociation.idQCM,qcmAssociation.idAssociation,isNational||!1).then(function(data){vm.questionnaire=data})["catch"](function(err){err&&530===err.code?vm.errMessage=err.message:(Notification.notify("QCM","Un problème est survenu lors de la récupération du questionnaire","error","icon-ed_qcm"),vm.errMessage="Un problème est survenu lors de la récupération du questionnaire : essayez de nouveau.")})}function close(){$uibModalInstance.close()}function initPage(){getQuestionnaire()}var vm=this;vm.qcmAssociation=qcmAssociation,vm.questionnaire=null,vm.idEleve=idEleve,vm.errMessage="Aucun questionnaire ne correspond !",vm.getQuestionnaire=getQuestionnaire,vm.close=close,initPage()}]),angular.module("edsiteApp.QCM").directive("qcmFormViewer",function(){return{restrict:"E",scope:{questionnaire:"=",idEleve:"=",close:"=onClose"},templateUrl:"modules/qcm/qcm-form-viewer/qcm-form-viewer.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$filter","$sce","$q","lodash","Auth","QCMService","Notification",function($filter,$sce,$q,lodash,Auth,QCMService,Notification){function submitQuestion(){var defer=$q.defer();if(Auth.isProfesseur()||ctrl.formStatus.status===QCMService.FORM_STATUS.DISPLAY_CORRECTIF)return defer.resolve(),defer.promise;if(encours)return defer.reject(),defer.promise;if(encours=!0,Auth.isEleve()||Auth.isFamille()){var reponseToSave=angular.copy(ctrl.currentQuestion.reponse);lodash.forEach(ctrl.currentQuestion.question.propositions,function(proposition){if(ctrl.currentQuestion.question.typeQ===QCMService.TYPE_QUESTIONS.textholes.id){for(var reponsesOrdonnees=Object.keys(reponseToSave.choixDecode[proposition.id]).sort(function(a,b){return a-b}).map(function(key){return reponseToSave.choixDecode[proposition.id][key]}),isVide=!0,i=0;i<reponsesOrdonnees.length;i++)""!==reponsesOrdonnees[i]&&(isVide=!1);isVide?reponseToSave.choix[proposition.id]="":reponseToSave.choix[proposition.id]=$filter("base64encode")(reponsesOrdonnees.join(QCMService.SCHMURTZ)),delete reponseToSave.choixDecode[proposition.id]}}),QCMService.saveParticipantReponse(ctrl.role,ctrl.idUser,ctrl.qcm,ctrl.association,ctrl.participant,reponseToSave).then(function(data){ctrl.reponses[ctrl.currentQuestion.index]=angular.extend({},reponseToSave,{repondu:data.repondu,resultat:data.resultat,points:data.points}),encours=!1,Notification.notify("QCM","Votre réponse a bien été sauvegardée.","success","icon-ed_qcm"),ctrl.currentQuestion.isLast?QCMService.setEndDateQCMEleve(ctrl.role,ctrl.idUser,ctrl.qcm,ctrl.association,ctrl.participant).then(function(data){ctrl.participant.fini=data.fini})["finally"](function(){defer.resolve()}):defer.resolve()})["catch"](function(){encours=!1,Notification.notify("Erreur","Une erreur s'est produite lors de l'enregistrement de votre réponse.","error","icon-ed_qcm"),defer.reject()})}else encours=!1,defer.resolve();return defer.promise}function setCurrentQuestion(index){return ctrl.form.$setPristine(),ctrl.form.$setUntouched(),ctrl.currentQuestion.index=index,ctrl.currentQuestion.question=angular.copy(ctrl.questions[index]),ctrl.currentQuestion.solution=angular.isDefined(ctrl.solutions[index])&&angular.copy(ctrl.solutions[index])||void 0,ctrl.currentQuestion.reponse=angular.copy(ctrl.reponses[index]),-1===index?void(ctrl.buttons.prevQuestion.visible=!1):(ctrl.currentQuestion.isFirst=0===ctrl.currentQuestion.index,ctrl.currentQuestion.isLast=ctrl.currentQuestion.index===ctrl.questions.length-1,ctrl.buttons.prevQuestion.visible=ctrl.participant.peutVoirSolutions&&!ctrl.currentQuestion.isFirst,void(ctrl.participant.peutVoirSolutions?ctrl.buttons.nextQuestion.libelle=ctrl.formStatus.status!==QCMService.FORM_STATUS.DISPLAY_CORRECTIF?"Afficher le correctif":"Question suivante":ctrl.buttons.nextQuestion.libelle=ctrl.currentQuestion.isLast?"Enregistrer ma réponse et terminer le questionnaire":"Question suivante"))}function init(){ctrl.role=Auth.role(),ctrl.idUser=Auth.idUser(),angular.isDefined(ctrl.idEleve)&&ctrl.idEleve>0&&(ctrl.role="E",ctrl.idUser=ctrl.idEleve),ctrl.qcm=ctrl.questionnaire.qcm,ctrl.association=ctrl.questionnaire.association,ctrl.participant=ctrl.questionnaire.participant,ctrl.solutions=ctrl.questionnaire.solutions,ctrl.reponses=ctrl.questionnaire.reponses,ctrl.questions=ctrl.questionnaire.questions.map(function(question){return question.srcSon&&(question.trustSrcSon=$sce.trustAsResourceUrl(question.srcSon)),question}),ctrl.currentQuestion={index:-1,isFirst:!1,isLast:!1,question:void 0,solution:void 0,reponse:void 0},ctrl.buttons={prevQuestion:{visible:!1},nextQuestion:{libelle:"Question suivante"}},ctrl.formStatus={status:QCMService.FORM_STATUS.NOT_SUBMITTED,visible:!1,finished:!1}}var ctrl=this,encours=!1;ctrl.Auth=Auth,ctrl.restartForm=function(){ctrl.formStatus={status:QCMService.FORM_STATUS.NOT_SUBMITTED,visible:!1,finished:!1},setCurrentQuestion(0)},ctrl.goToPrevQuestion=function(){var prevIndex=ctrl.currentQuestion.index-1;setCurrentQuestion(prevIndex)},ctrl.goToNextQuestion=function(){ctrl.promiseLoading=submitQuestion().then(function(){if(ctrl.participant.peutVoirSolutions&&ctrl.formStatus.status!==QCMService.FORM_STATUS.DISPLAY_CORRECTIF)ctrl.formStatus={status:QCMService.FORM_STATUS.DISPLAY_CORRECTIF,visible:!0},ctrl.buttons.nextQuestion.libelle=ctrl.currentQuestion.isLast?"Terminer le questionnaire":"Question suivante";else if(ctrl.formStatus={status:QCMService.FORM_STATUS.NOT_SUBMITTED,visible:!1,finished:ctrl.currentQuestion.isLast},!ctrl.currentQuestion.isLast){var nextIndex=ctrl.currentQuestion.index+1;setCurrentQuestion(nextIndex)}})["catch"](function(){})},ctrl.startQuestionnaire=function(){var index=lodash.findIndex(ctrl.reponses,function(reponse){return!reponse.repondu});-1===index&&(index=0),0===index&&(Auth.isEleve()||Auth.isFamille())&&QCMService.setStartDateQCMEleve(ctrl.role,ctrl.idUser,ctrl.qcm,ctrl.association,ctrl.participant).then(function(data){ctrl.participant.debute=data.debute}),setCurrentQuestion(index)},init()}]}}),angular.module("edsiteApp.QCM").directive("qcmFormViewerQuestion",function(){return{restrict:"E",scope:{question:"=",solution:"=",reponse:"=",form:"=",formStatusVisible:"=",readOnly:"="},templateUrl:"modules/qcm/qcm-form-viewer/qcm-form-viewer-question.template.html",controllerAs:"ctrl",bindToController:!0,controller:["$filter","$sce","lodash","QCMService",function($filter,$sce,lodash,QCMService){function resetErrors(){for(var att in ctrl.form.laQuestion.$error)switch(ctrl.question.typeQ){case ctrl.TYPE_QUESTIONS.radio.id:"textholeEqual"===att&&ctrl.form.laQuestion.$setValidity("textholeEqual",!0),"checkboxEquals"===att&&ctrl.form.laQuestion.$setValidity("checkboxEquals",!0);break;case ctrl.TYPE_QUESTIONS.checkbox.id:"radioEqual"===att&&ctrl.form.laQuestion.$setValidity("radioEqual",!0),"textholeEqual"===att&&ctrl.form.laQuestion.$setValidity("textholeEqual",!0);break;case ctrl.TYPE_QUESTIONS.textholes.id:"radioEqual"===att&&ctrl.form.laQuestion.$setValidity("radioEqual",!0),"checkboxEquals"===att&&ctrl.form.laQuestion.$setValidity("checkboxEquals",!0)}}function updateTextHoles(){ctrl.question.typeQ===ctrl.TYPE_QUESTIONS.textholes.id&&lodash.forEach(ctrl.question.propositions,function(proposition){var correctifs=[],enonceDecode=proposition.enonce?$filter("base64decode")(proposition.enonce):"";if(ctrl.solution&&ctrl.solution.choix&&angular.isDefined(ctrl.solution.choix[proposition.id])){var correctifDecode=$filter("base64decode")(ctrl.solution.choix[proposition.id]);correctifDecode=correctifDecode.split(QCMService.SCHMURTZ).reduce(function(lesCorrectifs,unCorrectif,index){return lesCorrectifs[index]=unCorrectif.replace("&nbsp;",""),lesCorrectifs},{}),ctrl.solution.choix.choixDecode=angular.extend({},ctrl.solution.choix.choixDecode),ctrl.solution.choix.choixDecode[proposition.id]=correctifDecode,correctifs=ctrl.solution.choix.choixDecode[proposition.id]}var trous=enonceDecode.split(QCMService.SCHMURTZ),dataDecode=$filter("base64decode")(ctrl.reponse.choix[proposition.id]);dataDecode=dataDecode.split(QCMService.SCHMURTZ);for(var reponseDecode={},j=0;j<trous.length-1;j++)reponseDecode[j]=angular.isDefined(dataDecode[j])?dataDecode[j]:"";ctrl.reponse.choixDecode=angular.extend({},ctrl.reponse.choixDecode),ctrl.reponse.choixDecode[proposition.id]=reponseDecode;for(var i=0;i<trous.length-1;i++){var from=QCMService.SCHMURTZ+i;enonceDecode=enonceDecode.replace(from,'<span ng-form="laQuestion'+i+"\" ng-class=\"{'reponse-success': ctrl.formStatusVisible && ctrl.displayPropositionSelectedOK("+proposition.id+", "+i+"), 'reponse-error': ctrl.formStatusVisible && ctrl.displayPropositionSelectedKO("+proposition.id+", "+i+')}"><label><input type="text" ng-disabled="'+ctrl.readOnly+'" class="form-control question-proposition-texthole-input" texthole-equal="'+correctifs[i]+'" ng-model="ctrl.reponse.choixDecode['+proposition.id+"]["+i+']" ng-trim="true" name="choix-pour-question-'+proposition.id+"-"+i+'" /></label></span>')}proposition.enonceDecode=$sce.trustAsHtml(enonceDecode)})}var ctrl=this;ctrl.TYPE_QUESTIONS=QCMService.TYPE_QUESTIONS,ctrl.displayPropositionGood=function(id){switch(ctrl.question.typeQ){case ctrl.TYPE_QUESTIONS.radio.id:return id===ctrl.solution.choix;case ctrl.TYPE_QUESTIONS.checkbox.id:return ctrl.solution.choix.indexOf(id)>-1}return!1},ctrl.displayPropositionSelectedOK=function(id,indexHole){switch(ctrl.question.typeQ){case ctrl.TYPE_QUESTIONS.radio.id:return ctrl.reponse.choix!==id?!1:id===ctrl.solution.choix;case ctrl.TYPE_QUESTIONS.checkbox.id:return-1===ctrl.reponse.choix.indexOf(id)?!1:ctrl.solution.choix.indexOf(id)>-1;case ctrl.TYPE_QUESTIONS.textholes.id:var correctif=ctrl.solution.choix.choixDecode[id][indexHole],reponse=ctrl.reponse.choixDecode[id][indexHole];return QCMService.getCleanValue(reponse)===QCMService.getCleanValue(correctif)}return!1},ctrl.displayPropositionSelectedKO=function(id,indexHole){switch(ctrl.question.typeQ){case ctrl.TYPE_QUESTIONS.radio.id:return ctrl.reponse.choix!==id?!1:id!==ctrl.solution.choix;case ctrl.TYPE_QUESTIONS.checkbox.id:return-1===ctrl.reponse.choix.indexOf(id)?!1:-1===ctrl.solution.choix.indexOf(id);case ctrl.TYPE_QUESTIONS.textholes.id:var correctif=ctrl.solution.choix.choixDecode[id][indexHole],reponse=ctrl.reponse.choixDecode[id][indexHole];return QCMService.getCleanValue(reponse)!==QCMService.getCleanValue(correctif)}return!1},ctrl.displayQuestionSuccess=function(laQuestion){return ctrl.solution&&ctrl.solution.choix&&(!laQuestion.$error||0===Object.keys(laQuestion.$error).length)},ctrl.displayQuestionError=function(laQuestion){return ctrl.solution&&ctrl.solution.choix&&(laQuestion.$error.radioEqual||laQuestion.$error.checkboxEquals||laQuestion.$error.textholeEqual)},ctrl.toggleSelectedReponse=function(idProposition){var idx=ctrl.reponse.choix.indexOf(idProposition);idx>-1?ctrl.reponse.choix.splice(idx,1):ctrl.reponse.choix.push(idProposition)},ctrl.onChangeQuestion=function(){resetErrors(),updateTextHoles()}}],link:function(scope){var ctrl=scope.ctrl;scope.$watch("ctrl.question",function(){ctrl.onChangeQuestion()}),scope.$watch("ctrl.reponse.idParticipant",function(newIdParticipant,oldIdParticipant){oldIdParticipant!==newIdParticipant&&ctrl.onChangeQuestion()})}}}),angular.module("edsiteApp.QCM").directive("qcmConfigurationViewer",function(){return{restrict:"E",scope:{qcm:"="},templateUrl:"modules/qcm/qcm-form-viewer/qcm-configuration-viewer.template.html",controllerAs:"ctrl",bindToController:!0,controller:function(){}}}),angular.module("edsiteApp.QCM").controller("QCMResultatViewerCtrl",["$uibModalInstance","lodash","Auth","QCMService","Notification","qcmAssociation","idEleve",function($uibModalInstance,lodash,Auth,QCMService,Notification,qcmAssociation,idEleve){function getQuestionnaire(){vm.promiseLoading=QCMService.getResultatQuestionnaire(Auth.TYPE_USER.ELEVE,idEleve,qcmAssociation.idQCM,qcmAssociation.idAssociation).then(function(data){vm.questionnaire=data})["catch"](function(err){err&&530===err.code?(vm.errMessage=err.message,Notification.notify("QCM",err.message,"error","icon-ed_qcm")):Notification.notify("QCM","Une erreur s'est produite lors de la récupération du questionnaire","error","icon-ed_qcm")})}function close(){$uibModalInstance.close()}function initPage(){getQuestionnaire()}var vm=this;vm.qcmAssociation=qcmAssociation,vm.questionnaire=null,vm.errMessage="Aucun questionnaire ne correspond !",vm.getQuestionnaire=getQuestionnaire,vm.close=close,initPage()}]),angular.module("edsiteApp.QCM").controller("QCMSEvaluesCtrl",["$routeParams","$uibModal","QCMService","ModuleService","Notification",function($routeParams,$uibModal,QCMService,ModuleService,Notification){function getQCMs(){vm.promiseLoading=QCMService.getQCMSEleveEvalues(vm.idEleve).then(function(data){vm.qcms=data})["catch"](function(_err){Notification.notify("QCM","Une erreur s'est produite lors de la récupération des QCM","error","icon-ed_qcm")})}function openQCM(qcm){$uibModal.open({templateUrl:"modules/qcm/qcm-form-viewer/qcm-modal-viewer.html",controller:"QCMModalViewerCtrl as ctrl",backdrop:"static",size:"md",resolve:{qcmAssociation:function(){return qcm},isNational:function(){return!1},idEleve:function(){return void 0}}})}function initPage(){ModuleService.clearBadges(ModuleService.CODES.QCM),rafraichir()}function rafraichir(){getQCMs()}var vm=this;vm.idEleve=$routeParams.ideleve,vm.typeUser="E",vm.qcms=[],vm.openQCM=openQCM,vm.rafraichir=rafraichir,initPage(void 0)}]);